# Tasks: Capability æ€§èƒ½ä¼˜åŒ–å®æ–½è®¡åˆ’

## Phase 1: ç©ºé—´ç´¢å¼•ç³»ç»Ÿ (ä¼˜å…ˆçº§: æœ€é«˜)

### 1.1 åˆ›å»ºç©ºé—´ç´¢å¼•åŸºç¡€è®¾æ–½

- [ ] åˆ›å»º `SpatialIndexSystem.cs`
  - [ ] å®ç°ç½‘æ ¼åˆ’åˆ†é€»è¾‘ï¼ˆCELL_SIZE = 10ï¼‰
  - [ ] å®ç° `Insert(Entity, TSVector)` æ–¹æ³•
  - [ ] å®ç° `Remove(Entity)` æ–¹æ³•
  - [ ] å®ç° `UpdatePosition(Entity, oldPos, newPos)` æ–¹æ³•
  - [ ] å®ç° `QueryNearby(TSVector, FP radius)` æ–¹æ³•
  - [ ] æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯æ­£ç¡®æ€§

### 1.2 é›†æˆåˆ° World

- [ ] åœ¨ `World.cs` ä¸­æ·»åŠ  `SpatialIndex` å±æ€§
- [ ] åœ¨ `World.Initialize()` ä¸­åˆ›å»ºç©ºé—´ç´¢å¼•
- [ ] åœ¨ `World.AddEntity()` ä¸­æ³¨å†Œåˆ°ç©ºé—´ç´¢å¼•
- [ ] åœ¨ `World.RemoveEntity()` ä¸­ä»ç©ºé—´ç´¢å¼•ç§»é™¤
- [ ] éªŒè¯é›†æˆæ­£ç¡®æ€§

### 1.3 æ›´æ–° MovementCapability

- [ ] åœ¨ä½ç½®æ›´æ–°æ—¶è°ƒç”¨ `SpatialIndex.UpdatePosition()`
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ç‚¹ï¼ˆProfileScopeï¼‰
- [ ] éªŒè¯ç´¢å¼•æ­£ç¡®æ›´æ–°

### 1.4 ä¼˜åŒ– BattleStateCapability

- [ ] ä¿®æ”¹ `FindNearestEnemy()` ä½¿ç”¨ç©ºé—´ç´¢å¼•
- [ ] ç§»é™¤ `world.Entities` å…¨é‡éå†
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ç‚¹
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ä» 7.08ms é™è‡³ < 1ms
- [ ] æ­£ç¡®æ€§æµ‹è¯•ï¼šç¡®è®¤è¡Œä¸ºä¸€è‡´

### 1.5 Phase 1 éªŒè¯

- [ ] è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
- [ ] Unity Profiler éªŒè¯æ€§èƒ½æå‡
- [ ] Memory Profiler æ£€æŸ¥å†…å­˜ä½¿ç”¨
- [ ] æ¸¸æˆæµ‹è¯•ï¼š100+ å®ä½“åœºæ™¯ç¨³å®šè¿è¡Œ

---

## Phase 2: å¯¹è±¡æ± ä¼˜åŒ–

### 2.1 åˆ›å»º LSInput å¯¹è±¡æ± 

- [ ] åˆ›å»º `LSInputPool.cs` åœ¨ `CommonBase/ObjectPool/`
  - [ ] å®ç° `Rent()` æ–¹æ³•
  - [ ] å®ç° `Return()` æ–¹æ³•
  - [ ] å®ç° `LSInput.Reset()` æ–¹æ³•
  - [ ] æ·»åŠ æ± å¤§å°é™åˆ¶ï¼ˆMAX_POOL_SIZE = 128ï¼‰
  - [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### 2.2 é›†æˆåˆ° BattleStateCapability

- [ ] ä¿®æ”¹ `CreateInput()` ä½¿ç”¨ `LSInputPool.Rent()`
- [ ] åœ¨ `LSInputComponent.SetInput()` åè°ƒç”¨ `Return()`
- [ ] éªŒè¯å¯¹è±¡æ­£ç¡®å¤ç”¨
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ GC åˆ†é…å‡å°‘

### 2.3 æ‰©å±•åˆ°å…¶ä»– Capability

- [ ] å®¡æŸ¥å…¶ä»–åˆ›å»ºä¸´æ—¶å¯¹è±¡çš„ Capability
- [ ] åº”ç”¨å¯¹è±¡æ± æ¨¡å¼åˆ°é€‚ç”¨åœºæ™¯
- [ ] éªŒè¯æ¯ä¸ªä¿®æ”¹çš„æ­£ç¡®æ€§

### 2.4 Phase 2 éªŒè¯

- [ ] Memory Profiler ç¡®è®¤ GC åˆ†é… < 100KB/å¸§
- [ ] è¿è¡Œ 30 åˆ†é’Ÿæ— å†…å­˜æ³„æ¼
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## Phase 3: æŸ¥è¯¢ç¼“å­˜ç³»ç»Ÿ

### 3.1 æ‰©å±• Capability åŸºç±»

- [ ] åœ¨ `Capability<T>` ä¸­æ·»åŠ  `_componentCache` å­—æ®µ
- [ ] å®ç° `GetComponentCached<TComponent>()` æ–¹æ³•
- [ ] å®ç°ç¼“å­˜å¤±æ•ˆé€»è¾‘
- [ ] åœ¨ `OnEntityDestroyed()` ä¸­æ¸…é™¤ç¼“å­˜
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•

### 3.2 æ›´æ–° BattleStateCapability

- [ ] å°† `GetComponent()` æ›¿æ¢ä¸º `GetComponentCached()`
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤æŸ¥è¯¢å¼€é”€å‡å°‘
- [ ] éªŒè¯ç¼“å­˜æ­£ç¡®æ€§

### 3.3 æ›´æ–° ActionCapability

- [ ] å°†é¢‘ç¹çš„ `GetComponent()` æ›¿æ¢ä¸º `GetComponentCached()`
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] éªŒè¯æ­£ç¡®æ€§

### 3.4 æ‰¹é‡åº”ç”¨åˆ°å…¶ä»– Capability

- [ ] SkillExecutorCapability
- [ ] SkillDisplacementCapability
- [ ] å…¶ä»–é«˜é¢‘æŸ¥è¯¢çš„ Capability

### 3.5 Phase 3 éªŒè¯

- [ ] Unity Profiler ç¡®è®¤æŸ¥è¯¢å¼€é”€å‡å°‘ 30-50%
- [ ] è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
- [ ] æ­£ç¡®æ€§æµ‹è¯•é€šè¿‡

---

## Phase 4: LINQ ä¼˜åŒ–

### 4.1 åˆ†æ LINQ ä½¿ç”¨

- [ ] ä½¿ç”¨ Profiler è¯†åˆ« ActionCapability ä¸­çš„ LINQ çƒ­ç‚¹
- [ ] åˆ—å‡ºæ‰€æœ‰äº§ç”Ÿåˆ†é…çš„ LINQ æ“ä½œ
- [ ] è¯„ä¼°æ¯ä¸ªæ“ä½œçš„æ›¿ä»£æ–¹æ¡ˆ

### 4.2 ä¼˜åŒ– ActionCapability

- [ ] æ·»åŠ é¢„åˆ†é…ç¼“å†²åŒº `_candidateBuffer`
- [ ] å°† `Where().OrderByDescending().ToList()` æ›¿æ¢ä¸ºæ‰‹åŠ¨å¾ªç¯
- [ ] ä¼˜åŒ–åŠ¨ä½œå€™é€‰åˆ—è¡¨ç®¡ç†
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ä» 2.40ms é™è‡³ < 1ms
- [ ] æ­£ç¡®æ€§æµ‹è¯•ï¼šç¡®è®¤è¡Œä¸ºä¸€è‡´

### 4.3 ä¼˜åŒ–å…¶ä»– Capability

- [ ] å®¡æŸ¥æ‰€æœ‰ Capability çš„ LINQ ä½¿ç”¨
- [ ] æ‰¹é‡æ›¿æ¢ä¸ºé«˜æ•ˆå®ç°
- [ ] é€ä¸ªéªŒè¯

### 4.4 Phase 4 éªŒè¯

- [ ] Memory Profiler ç¡®è®¤ LINQ åˆ†é…æ¶ˆé™¤
- [ ] Unity Profiler ç¡®è®¤æ€§èƒ½æå‡
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## æœ€ç»ˆéªŒè¯

### æ€§èƒ½ç›®æ ‡éªŒè¯

- [ ] **æ€»å¸§æ—¶é—´**: LSUpdater.UpdateWorld < 5msï¼ˆç›®æ ‡ < 3msï¼‰
- [ ] **GC åˆ†é…**: < 100KB/å¸§ï¼ˆç›®æ ‡ < 60KBï¼‰
- [ ] **å¸§ç‡**: 60 FPS ç¨³å®šï¼ˆ100+ å®ä½“åœºæ™¯ï¼‰
- [ ] **å†…å­˜ç¨³å®šæ€§**: è¿è¡Œ 30 åˆ†é’Ÿæ— æ³„æ¼

### æ­£ç¡®æ€§éªŒè¯

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›æ”¾æµ‹è¯•ï¼šä¼˜åŒ–å‰åå½•åƒä¸€è‡´
- [ ] AI è¡Œä¸ºæµ‹è¯•ï¼šå¯»è·¯ã€æˆ˜æ–—é€»è¾‘æ­£ç¡®

### æ–‡æ¡£å’Œä»£ç å®¡æŸ¥

- [ ] æ›´æ–°ç›¸å…³ä»£ç æ³¨é‡Š
- [ ] æ›´æ–°æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] OpenSpec è§„èŒƒæ›´æ–°

### éƒ¨ç½²å‡†å¤‡

- [ ] åˆ›å»ºæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] è®°å½•ä¼˜åŒ–å‰åå¯¹æ¯”æ•°æ®
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜

---

## ä¼°ç®—æ—¶é—´

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| Phase 1: ç©ºé—´ç´¢å¼• | 1-2 å¤© | ğŸ”´ æœ€é«˜ |
| Phase 2: å¯¹è±¡æ±  | 0.5-1 å¤© | ğŸŸ¡ é«˜ |
| Phase 3: æŸ¥è¯¢ç¼“å­˜ | 0.5-1 å¤© | ğŸŸ¡ é«˜ |
| Phase 4: LINQ ä¼˜åŒ– | 1-2 å¤© | ğŸŸ¢ ä¸­ |
| æœ€ç»ˆéªŒè¯ | 0.5-1 å¤© | ğŸ”´ æœ€é«˜ |
| **æ€»è®¡** | **4-7 å¤©** | |

## å¹¶è¡ŒåŒ–

å¯ä»¥å¹¶è¡Œè¿›è¡Œçš„ä»»åŠ¡ï¼š
- Phase 2ï¼ˆå¯¹è±¡æ± ï¼‰å’Œ Phase 3ï¼ˆæŸ¥è¯¢ç¼“å­˜ï¼‰å¯ä»¥å¹¶è¡Œ
- ä¸åŒ Capability çš„ä¼˜åŒ–å¯ä»¥å¹¶è¡Œï¼ˆåœ¨åŒä¸€ Phase å†…ï¼‰

å¿…é¡»ä¸²è¡Œçš„ä»»åŠ¡ï¼š
- Phase 1 å¿…é¡»å…ˆå®Œæˆï¼ˆå½±å“æœ€å¤§ï¼Œå…¶ä»–ä¼˜åŒ–ä¾èµ–å®ƒï¼‰
- æ¯ä¸ª Phase å†…çš„éªŒè¯å¿…é¡»åœ¨è¯¥ Phase æ‰€æœ‰ä»»åŠ¡å®Œæˆåè¿›è¡Œ
- æœ€ç»ˆéªŒè¯å¿…é¡»åœ¨æ‰€æœ‰ Phase å®Œæˆåè¿›è¡Œ

## é£é™©å’Œåº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|-------|------|---------|
| ç©ºé—´ç´¢å¼•ç»´æŠ¤æˆæœ¬é«˜ | ä¸­ | é«˜ | ä¼˜å…ˆ Profileï¼Œå¿…è¦æ—¶è°ƒæ•´ CELL_SIZE |
| å¯¹è±¡æ± å¯¼è‡´å†…å­˜æ³„æ¼ | ä½ | é«˜ | ä¸¥æ ¼é™åˆ¶æ± å¤§å°ï¼Œå®šæœŸæ£€æŸ¥ |
| ç¼“å­˜å¤±æ•ˆé€»è¾‘é”™è¯¯ | ä¸­ | é«˜ | å…¨é¢æµ‹è¯•ï¼Œè€ƒè™‘ç¦ç”¨é€‰é¡¹ |
| ä¼˜åŒ–åè¡Œä¸ºä¸ä¸€è‡´ | ä½ | æé«˜ | ä¸¥æ ¼çš„æ­£ç¡®æ€§æµ‹è¯•å’Œå›æ”¾æµ‹è¯• |
| æ—¶é—´ä¼°ç®—ä¸å‡†ç¡® | ä¸­ | ä¸­ | é¢„ç•™ bufferï¼Œåˆ†é˜¶æ®µäº¤ä»˜ |

