# Tasks: Capability æ€§èƒ½ä¼˜åŒ–å®æ–½è®¡åˆ’

## Phase 1: ä¼˜åŒ– BattleStateCapability ç›®æ ‡æŸ¥è¯¢ (ä¼˜å…ˆçº§: æœ€é«˜)

### 1.1 åœ¨ AIStateMachineComponent æ·»åŠ ç›®æ ‡ç¼“å­˜å­—æ®µ

- [ ] åœ¨ `AIStateMachineComponent` æ·»åŠ  `LastTargetValidationFrame` å­—æ®µ
- [ ] ç¡®è®¤ `CurrentTargetId` å­—æ®µå·²å­˜åœ¨ï¼ˆç”¨äºå­˜å‚¨ç›®æ ‡ï¼‰
- [ ] åœ¨ MemoryPack åºåˆ—åŒ–å±æ€§ä¸­åŒ…å«æ–°å­—æ®µ
- [ ] æ·»åŠ å­—æ®µæ³¨é‡Šè¯´æ˜ç”¨é€”
- [ ] éªŒè¯åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£ç¡®

### 1.2 ä¿®æ”¹ BattleStateCapability ä½¿ç”¨ç›®æ ‡ç¼“å­˜

- [ ] æ·»åŠ  `RetargetDistance` å¸¸é‡ï¼ˆå¦‚ 8.0 å•ä½ï¼‰
- [ ] æ·»åŠ  `ValidateTarget()` æ–¹æ³•æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ•ˆ
- [ ] æ·»åŠ  `ShouldRetarget()` æ–¹æ³•åˆ¤æ–­æ˜¯å¦éœ€è¦é‡æ–°æŸ¥æ‰¾
- [ ] ä¿®æ”¹ `Tick()` ä¼˜å…ˆä½¿ç”¨ `fsm.CurrentTargetId` ç¼“å­˜
- [ ] ä»…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶è°ƒç”¨ `FindNearestEnemy()`
- [ ] æ›´æ–° `fsm.CurrentTargetId` å’Œ `LastTargetValidationFrame`
- [ ] æ·»åŠ å•å…ƒæµ‹è¯•éªŒè¯ç¼“å­˜é€»è¾‘

### 1.2 ä¿®æ”¹ Tick é€»è¾‘ä½¿ç”¨ç¼“å­˜

- [ ] å…ˆæ£€æŸ¥ç¼“å­˜ç›®æ ‡æ˜¯å¦å­˜åœ¨ä¸”åœ¨æœ‰æ•ˆèŒƒå›´å†…
- [ ] ç¼“å­˜æœ‰æ•ˆæ—¶ç›´æ¥ä½¿ç”¨ï¼Œè·³è¿‡æŸ¥è¯¢ï¼ˆ90% çš„å¸§ï¼‰
- [ ] ä»…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶æ‰è°ƒç”¨ `FindNearestEnemy()`
- [ ] æ›´æ–°ç¼“å­˜è®°å½•æ–°ç›®æ ‡
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ç‚¹ï¼ˆProfileScopeï¼‰

### 1.3 ä½¿ç”¨ BEPU ç‰©ç†æŸ¥è¯¢æ›¿ä»£éå†ï¼ˆæ¬¡è¦ä¼˜åŒ–ï¼‰

- [ ] æ£€æŸ¥ `BepuPhysicsWorld` æ˜¯å¦å·²æœ‰èŒƒå›´æŸ¥è¯¢æ–¹æ³•
- [ ] å¦‚éœ€è¦ï¼Œæ·»åŠ  `QueryAABB()` æˆ– `QuerySphere()` æ–¹æ³•
- [ ] ä¿®æ”¹ `FindNearestEnemy()` ä½¿ç”¨ç‰©ç†æŸ¥è¯¢
- [ ] ç¡®ä¿æ‰€æœ‰æˆ˜æ–—å®ä½“å·²æ³¨å†Œåˆ°ç‰©ç†ä¸–ç•Œ
- [ ] æ€§èƒ½æµ‹è¯•ï¼šå¯¹æ¯”ç‰©ç†æŸ¥è¯¢ vs å…¨é‡éå†

### 1.4 æ¸…ç†å’Œè¾¹ç•Œæƒ…å†µå¤„ç†

- [ ] å®ä½“é”€æ¯æ—¶ä» `_cachedTargets` ç§»é™¤
- [ ] çŠ¶æ€åˆ‡æ¢æ—¶æ¸…ç†ç›®æ ‡ç¼“å­˜
- [ ] ç›®æ ‡æ­»äº¡æ—¶é‡æ–°æŸ¥æ‰¾ç›®æ ‡
- [ ] æ·»åŠ è¾¹ç•Œæƒ…å†µæµ‹è¯•

### 1.5 Phase 1 éªŒè¯

- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ä» 7.08ms é™è‡³ < 0.5msï¼ˆç›®æ ‡ç¼“å­˜ç”Ÿæ•ˆï¼‰
- [ ] éªŒè¯ç¼“å­˜å‘½ä¸­ç‡ > 85%ï¼ˆé€šè¿‡æ—¥å¿—æˆ–ç›‘æ§ï¼‰
- [ ] Unity Profiler ç¡®è®¤æ€§èƒ½æå‡
- [ ] æ­£ç¡®æ€§æµ‹è¯•ï¼šAI è¡Œä¸ºä¸ä¼˜åŒ–å‰ä¸€è‡´
- [ ] æ¸¸æˆæµ‹è¯•ï¼š100+ å®ä½“åœºæ™¯ç¨³å®šè¿è¡Œ

---

## Phase 2: å¯¹è±¡æ± ä¼˜åŒ–

### 2.1 å¯ç”¨ LSInput çš„å¯¹è±¡æ± æ”¯æŒ

- [ ] ç¡®è®¤ `LSInput` å·²å®ç° `IPool` æ¥å£ï¼ˆæ£€æŸ¥ç”Ÿæˆçš„ä»£ç ï¼‰
- [ ] å¦‚æœªå®ç°ï¼Œåœ¨ LSInput å®šä¹‰ä¸­æ·»åŠ  `IPool` æ¥å£
- [ ] å®ç° `Reset()` æ–¹æ³•æ¸…ç©º LSInput çš„æ‰€æœ‰å­—æ®µ
- [ ] éªŒè¯å¯¹è±¡æ± æœºåˆ¶æ­£å¸¸å·¥ä½œ

### 2.2 ä¿®æ”¹æ‰€æœ‰ LSInput.Create() è°ƒç”¨å¯ç”¨å¯¹è±¡æ± 

- [ ] `BattleStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [ ] `MoveStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [ ] `IdleStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [ ] `ServerLSController.CreateDefaultInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [ ] æœç´¢æ‰€æœ‰å…¶ä»–è°ƒç”¨ç‚¹å¹¶ä¿®æ”¹
- [ ] æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸ºä½•å¯ç”¨å¯¹è±¡æ± 

### 2.3 åœ¨ä½¿ç”¨å®Œ LSInput åå½’è¿˜å¯¹è±¡æ± 

- [ ] ä¿®æ”¹ `LSInputComponent.SetInput()` å½’è¿˜ input å¯¹è±¡
- [ ] ç¡®ä¿æ•°æ®å·²å¤åˆ¶åæ‰å½’è¿˜ï¼ˆé¿å…æ‚¬ç©ºå¼•ç”¨ï¼‰
- [ ] éªŒè¯å½’è¿˜é€»è¾‘æ­£ç¡®
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ GC åˆ†é…å‡å°‘

### 2.3 æ‰©å±•åˆ°å…¶ä»– Capability

- [ ] å®¡æŸ¥å…¶ä»–åˆ›å»ºä¸´æ—¶å¯¹è±¡çš„ Capability
- [ ] åº”ç”¨å¯¹è±¡æ± æ¨¡å¼åˆ°é€‚ç”¨åœºæ™¯
- [ ] éªŒè¯æ¯ä¸ªä¿®æ”¹çš„æ­£ç¡®æ€§

### 2.4 Phase 2 éªŒè¯

- [ ] Memory Profiler ç¡®è®¤ GC åˆ†é… < 100KB/å¸§
- [ ] è¿è¡Œ 30 åˆ†é’Ÿæ— å†…å­˜æ³„æ¼
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## Phase 3: ç›‘æ§ GetComponent æ€§èƒ½

### 3.1 åœ¨ Capability åŸºç±»çš„ GetComponent æ·»åŠ æ€§èƒ½ç›‘æ§

- [ ] ä¿®æ”¹ `CapabilityBase.cs` ä¸­çš„ `GetComponent<TComponent>()` æ–¹æ³•
- [ ] æ·»åŠ æ¡ä»¶ç¼–è¯‘çš„ ProfileScopeï¼š
  ```csharp
  #if ENABLE_PROFILER
  using (new ProfileScope($"GetComponent<{typeof(TComponent).Name}>"))
  #endif
  {
      return entity.GetComponent<TComponent>();
  }
  ```
- [ ] ç¼–è¯‘å¹¶è¿è¡Œæ¸¸æˆ
- [ ] åœ¨ Unity Profiler ä¸­æŸ¥çœ‹ GetComponent è°ƒç”¨è¯¦æƒ…

### 3.2 æ”¶é›†æ€§èƒ½æ•°æ®

- [ ] è¿è¡Œæ¸¸æˆå¹¶ä½¿ç”¨ Unity Profiler æ·±åº¦åˆ†æ
- [ ] è®°å½• GetComponent çš„è¯¦ç»†æ€§èƒ½æ•°æ®
- [ ] ç»Ÿè®¡å„ Capability çš„ GetComponent è°ƒç”¨é¢‘ç‡
- [ ] åˆ†ææ˜¯å¦éœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–

### 3.3 Phase 3 å†³ç­–

- [ ] **å¦‚æœ** GetComponent < 0.01ms/è°ƒç”¨ï¼šâœ… æ— éœ€ä¼˜åŒ–ï¼Œç§»é™¤æ­¤ Phase
- [ ] **å¦‚æœ** GetComponent > 0.05ms/è°ƒç”¨ï¼šâš ï¸ è€ƒè™‘ç¼“å­˜æˆ–å…¶ä»–ä¼˜åŒ–
- [ ] è®°å½•æ€§èƒ½æ•°æ®åˆ°æ–‡æ¡£
- [ ] æ ¹æ®æ•°æ®å†³å®šæ˜¯å¦éœ€è¦å®æ–½ç¼“å­˜æ–¹æ¡ˆ

---

## Phase 4: LINQ ä¼˜åŒ–

### 4.1 åˆ†æ LINQ ä½¿ç”¨

- [ ] ä½¿ç”¨ Profiler è¯†åˆ« ActionCapability ä¸­çš„ LINQ çƒ­ç‚¹
- [ ] åˆ—å‡ºæ‰€æœ‰äº§ç”Ÿåˆ†é…çš„ LINQ æ“ä½œ
- [ ] è¯„ä¼°æ¯ä¸ªæ“ä½œçš„æ›¿ä»£æ–¹æ¡ˆ

### 4.2 ä¼˜åŒ– ActionCapability

- [ ] æ·»åŠ é¢„åˆ†é…ç¼“å†²åŒº `_candidateBuffer`
- [ ] å°† `Where().OrderByDescending().ToList()` æ›¿æ¢ä¸ºæ‰‹åŠ¨å¾ªç¯
- [ ] ä¼˜åŒ–åŠ¨ä½œå€™é€‰åˆ—è¡¨ç®¡ç†
- [ ] æ€§èƒ½æµ‹è¯•ï¼šç¡®è®¤ä» 2.40ms é™è‡³ < 1ms
- [ ] æ­£ç¡®æ€§æµ‹è¯•ï¼šç¡®è®¤è¡Œä¸ºä¸€è‡´

### 4.3 ä¼˜åŒ–å…¶ä»– Capability

- [ ] å®¡æŸ¥æ‰€æœ‰ Capability çš„ LINQ ä½¿ç”¨
- [ ] æ‰¹é‡æ›¿æ¢ä¸ºé«˜æ•ˆå®ç°
- [ ] é€ä¸ªéªŒè¯

### 4.4 Phase 4 éªŒè¯

- [ ] Memory Profiler ç¡®è®¤ LINQ åˆ†é…æ¶ˆé™¤
- [ ] Unity Profiler ç¡®è®¤æ€§èƒ½æå‡
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## æœ€ç»ˆéªŒè¯

### æ€§èƒ½ç›®æ ‡éªŒè¯

- [ ] **æ€»å¸§æ—¶é—´**: LSUpdater.UpdateWorld < 5msï¼ˆç›®æ ‡ < 3msï¼‰
- [ ] **GC åˆ†é…**: < 100KB/å¸§ï¼ˆç›®æ ‡ < 60KBï¼‰
- [ ] **å¸§ç‡**: 60 FPS ç¨³å®šï¼ˆ100+ å®ä½“åœºæ™¯ï¼‰
- [ ] **å†…å­˜ç¨³å®šæ€§**: è¿è¡Œ 30 åˆ†é’Ÿæ— æ³„æ¼

### æ­£ç¡®æ€§éªŒè¯

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›æ”¾æµ‹è¯•ï¼šä¼˜åŒ–å‰åå½•åƒä¸€è‡´
- [ ] AI è¡Œä¸ºæµ‹è¯•ï¼šå¯»è·¯ã€æˆ˜æ–—é€»è¾‘æ­£ç¡®

### æ–‡æ¡£å’Œä»£ç å®¡æŸ¥

- [ ] æ›´æ–°ç›¸å…³ä»£ç æ³¨é‡Š
- [ ] æ›´æ–°æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] OpenSpec è§„èŒƒæ›´æ–°

### éƒ¨ç½²å‡†å¤‡

- [ ] åˆ›å»ºæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] è®°å½•ä¼˜åŒ–å‰åå¯¹æ¯”æ•°æ®
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜

---

## ä¼°ç®—æ—¶é—´

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| Phase 1: BattleState ä¼˜åŒ– | 0.5-1 å¤© | ğŸ”´ æœ€é«˜ |
| Phase 2: å¯¹è±¡æ±  | 0.5-1 å¤© | ğŸŸ¡ é«˜ |
| Phase 3: GetComponent ç›‘æ§ | 0.5 å¤© | ğŸŸ¡ ä¸­ |
| Phase 4: LINQ ä¼˜åŒ– | 1-2 å¤© | ğŸŸ¢ ä¸­ |
| æœ€ç»ˆéªŒè¯ | 0.5-1 å¤© | ğŸ”´ æœ€é«˜ |
| **æ€»è®¡** | **3-5 å¤©** | |

## å¹¶è¡ŒåŒ–

å¯ä»¥å¹¶è¡Œè¿›è¡Œçš„ä»»åŠ¡ï¼š
- Phase 2ï¼ˆå¯¹è±¡æ± ï¼‰å’Œ Phase 3ï¼ˆæŸ¥è¯¢ç¼“å­˜ï¼‰å¯ä»¥å¹¶è¡Œ
- ä¸åŒ Capability çš„ä¼˜åŒ–å¯ä»¥å¹¶è¡Œï¼ˆåœ¨åŒä¸€ Phase å†…ï¼‰

å¿…é¡»ä¸²è¡Œçš„ä»»åŠ¡ï¼š
- Phase 1 å¿…é¡»å…ˆå®Œæˆï¼ˆå½±å“æœ€å¤§ï¼Œå…¶ä»–ä¼˜åŒ–ä¾èµ–å®ƒï¼‰
- æ¯ä¸ª Phase å†…çš„éªŒè¯å¿…é¡»åœ¨è¯¥ Phase æ‰€æœ‰ä»»åŠ¡å®Œæˆåè¿›è¡Œ
- æœ€ç»ˆéªŒè¯å¿…é¡»åœ¨æ‰€æœ‰ Phase å®Œæˆåè¿›è¡Œ

## é£é™©å’Œåº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|-------|------|---------|
| ç©ºé—´ç´¢å¼•ç»´æŠ¤æˆæœ¬é«˜ | ä¸­ | é«˜ | ä¼˜å…ˆ Profileï¼Œå¿…è¦æ—¶è°ƒæ•´ CELL_SIZE |
| å¯¹è±¡æ± å¯¼è‡´å†…å­˜æ³„æ¼ | ä½ | é«˜ | ä¸¥æ ¼é™åˆ¶æ± å¤§å°ï¼Œå®šæœŸæ£€æŸ¥ |
| ç¼“å­˜å¤±æ•ˆé€»è¾‘é”™è¯¯ | ä¸­ | é«˜ | å…¨é¢æµ‹è¯•ï¼Œè€ƒè™‘ç¦ç”¨é€‰é¡¹ |
| ä¼˜åŒ–åè¡Œä¸ºä¸ä¸€è‡´ | ä½ | æé«˜ | ä¸¥æ ¼çš„æ­£ç¡®æ€§æµ‹è¯•å’Œå›æ”¾æµ‹è¯• |
| æ—¶é—´ä¼°ç®—ä¸å‡†ç¡® | ä¸­ | ä¸­ | é¢„ç•™ bufferï¼Œåˆ†é˜¶æ®µäº¤ä»˜ |

