# æœ€ç»ˆå®æ–½æ€»ç»“

**å®Œæˆæ—¥æœŸ**ï¼š2025-12-03  
**çŠ¶æ€**ï¼šâœ… å®Œæˆï¼Œç­‰å¾…æ¸¸æˆæµ‹è¯•

---

## ğŸ¯ æœ€ç»ˆæ¶æ„

### ä¸‰å±‚ä¼˜åŒ–è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜åŒ– 1: å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—ï¼ˆè§£è€¦é€»è¾‘å±‚å’Œè§†å›¾å±‚ï¼‰         â”‚
â”‚ Entity.ViewEventQueue                             â”‚
â”‚ - é€»è¾‘å±‚ä¸ç›´æ¥è°ƒç”¨è§†å›¾å±‚                           â”‚
â”‚ - ä¸ºå¤šçº¿ç¨‹åšå‡†å¤‡                                   â”‚
â”‚ - æœåŠ¡å™¨ç«¯é˜²æŠ¤ï¼ˆHasViewLayerï¼‰                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜åŒ– 2: å…¨å±€äº‹ä»¶æ³¨å†Œï¼ˆå‡å°‘å†…å­˜å’Œåˆå§‹åŒ–å¼€é”€ï¼‰       â”‚
â”‚ ViewComponentEventRegistryï¼ˆå•ä¾‹ï¼‰                â”‚
â”‚ - å…¨å±€æ˜ å°„ï¼Œæ‰€æœ‰ EntityView å…±äº«                   â”‚
â”‚ - EntityView åˆ›å»ºæ—¶æ— éœ€å»ºç«‹æ˜ å°„                    â”‚
â”‚ - å†…å­˜èŠ‚çœ ~99%ï¼ˆvs æ¯ä¸ª EntityView ä¸€ä»½ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼˜åŒ– 3: å¯¹è±¡æ± ä¼˜åŒ–ï¼ˆé¿å…é‡å¤æ³¨å†Œå›è°ƒï¼‰             â”‚
â”‚ ViewComponent._eventHandlersRegistered            â”‚
â”‚ - åªåœ¨ç¬¬ä¸€æ¬¡æ³¨å†Œå›è°ƒ                               â”‚
â”‚ - è¿”å›å¯¹è±¡æ± æ—¶ä¸æ¸…ç©ºå›è°ƒ                           â”‚
â”‚ - æ€§èƒ½èŠ‚çœ ~80%ï¼ˆvs æ¯æ¬¡é‡æ–°æ³¨å†Œï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–æ€»ç»“

| ä¼˜åŒ–é¡¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **è§†å›¾äº‹ä»¶é˜Ÿåˆ—** | åŒæ­¥è°ƒç”¨ï¼Œé˜»å¡ | å¼‚æ­¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡ | è§£è€¦ |
| **æœåŠ¡å™¨å†…å­˜** | æŒç»­å¢é•¿ï¼ˆæ³„æ¼ï¼‰ | 0ï¼ˆHasViewLayerï¼‰ | é˜²æ³„æ¼ |
| **äº‹ä»¶æ˜ å°„å†…å­˜** | 100 EntityView Ã— 1KB | 1 Ã— 1KBï¼ˆå…¨å±€ï¼‰ | **99%** |
| **äº‹ä»¶å›è°ƒæ³¨å†Œ** | æ¯æ¬¡åˆå§‹åŒ– | ç¬¬ä¸€æ¬¡åˆå§‹åŒ– | **80%** |

**ç»¼åˆæå‡**ï¼š
- å†…å­˜ï¼šèŠ‚çœ ~99%ï¼ˆäº‹ä»¶æ˜ å°„ï¼‰
- CPUï¼šèŠ‚çœ ~80%ï¼ˆå›è°ƒæ³¨å†Œï¼‰
- æ¶æ„ï¼šå®Œå…¨è§£è€¦ï¼Œä¸ºå¤šçº¿ç¨‹åšå¥½å‡†å¤‡

---

## ğŸ“ å®Œæ•´æ–‡ä»¶åˆ—è¡¨

### æ–°å¢æ–‡ä»¶ï¼ˆ3 ä¸ªï¼‰
1. `AstrumLogic/Events/ViewEvents.cs` - è§†å›¾äº‹ä»¶å®šä¹‰
2. `AstrumLogic/Core/Entity.ViewEventQueue.cs` - è§†å›¾äº‹ä»¶é˜Ÿåˆ—
3. `AstrumView/Core/ViewComponentEventRegistry.cs` - å…¨å±€äº‹ä»¶æ³¨å†Œè¡¨

### ä¿®æ”¹æ–‡ä»¶ï¼ˆ5 ä¸ªï¼‰
1. `AstrumView/Components/ViewComponent.cs` - äº‹ä»¶æ³¨å†ŒAPI + å¯¹è±¡æ± ä¼˜åŒ–
2. `AstrumView/Core/EntityView.cs` - ä½¿ç”¨å…¨å±€æ˜ å°„åˆ†å‘äº‹ä»¶
3. `AstrumView/Core/Stage.cs` - äº‹ä»¶è½®è¯¢å’Œåˆ†å±‚å¤„ç†
4. `AstrumLogic/Core/World.cs` - äº‹ä»¶å‘å¸ƒè¿ç§»
5. `AstrumLogic/Core/Entity.cs` - äº‹ä»¶å‘å¸ƒè¿ç§»

### æ–‡æ¡£ï¼ˆ7 ä¸ªï¼‰
1. `proposal.md` - å˜æ›´ææ¡ˆ
2. `design.md` - æŠ€æœ¯è®¾è®¡
3. `specs/entity-view/spec.md` - éœ€æ±‚è§„æ ¼
4. `tasks.md` - å®æ–½ä»»åŠ¡æ¸…å•
5. `GLOBAL_REGISTRY_OPTIMIZATION.md` - å…¨å±€æ³¨å†Œä¼˜åŒ–è¯´æ˜
6. `OBJECT_POOL_OPTIMIZATION.md` - å¯¹è±¡æ± ä¼˜åŒ–è¯´æ˜
7. `COMPLETED.md` - å®Œæˆæ€»ç»“

---

## ğŸ¨ ä½¿ç”¨ç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹ï¼šAnimationViewComponent

```csharp
public class AnimationViewComponent : ViewComponent
{
    // ====== 1. é™æ€æ³¨å†Œï¼ˆç±»å‹çº§ï¼Œåªæ‰§è¡Œä¸€æ¬¡ï¼‰======
    static AnimationViewComponent()
    {
        var registry = ViewComponentEventRegistry.Instance;
        registry.RegisterEventHandler(typeof(HitAnimationEvent), 
            typeof(AnimationViewComponent));
        registry.RegisterEventHandler(typeof(SkillAnimationEvent), 
            typeof(AnimationViewComponent));
    }
    
    // ====== 2. å®ä¾‹æ³¨å†Œï¼ˆå®ä¾‹çº§ï¼Œç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶æ‰§è¡Œï¼‰======
    protected override void RegisterViewEventHandlers()
    {
        // å¯¹è±¡æ± ä¼˜åŒ–ï¼šåªåœ¨ç¬¬ä¸€æ¬¡åˆå§‹åŒ–æ—¶è°ƒç”¨
        RegisterViewEventHandler<HitAnimationEvent>(OnHitAnimation);
        RegisterViewEventHandler<SkillAnimationEvent>(OnSkillAnimation);
    }
    
    // ====== 3. äº‹ä»¶å¤„ç†å™¨ ======
    private void OnHitAnimation(HitAnimationEvent evt)
    {
        PlayAnimation(evt.AnimationName);
        Debug.Log($"æ’­æ”¾å—å‡»åŠ¨ç”»: {evt.AnimationName}");
    }
    
    private void OnSkillAnimation(SkillAnimationEvent evt)
    {
        PlayAnimation(evt.AnimationName);
        Debug.Log($"æ’­æ”¾æŠ€èƒ½åŠ¨ç”»: {evt.AnimationName}");
    }
}
```

### è§¦å‘äº‹ä»¶

```csharp
// é€»è¾‘å±‚ï¼ˆCapabilityï¼‰
public class ActionCapability : Capability<ActionCapability>
{
    private void OnActionStart(string animName)
    {
        // è§¦å‘è§†å›¾äº‹ä»¶ï¼ˆå¼‚æ­¥ï¼Œä¸é˜»å¡ï¼‰
        var animEvent = new SkillAnimationEvent
        {
            AnimationName = animName,
            PlaySpeed = 1.0f
        };
        
        Entity.QueueViewEvent(new ViewEvent(
            ViewEventType.CustomViewEvent, 
            animEvent, 
            World.CurFrame
        ));
    }
}
```

### äº‹ä»¶æµç¨‹

```
é€»è¾‘å±‚
ActionCapability.OnActionStart()
  â†’ Entity.QueueViewEvent(CustomViewEvent, SkillAnimationEvent)
  â†’ [å¼‚æ­¥é˜Ÿåˆ—ï¼Œä¸é˜»å¡é€»è¾‘å±‚]
  
è§†å›¾å±‚ï¼ˆä¸‹ä¸€å¸§ï¼‰
Stage.ProcessViewEvents()
  â†’ EntityView.ProcessEvent(CustomViewEvent)
  â†’ EntityView.DispatchViewEventToComponents()
    â†’ æŸ¥è¯¢å…¨å±€æ³¨å†Œè¡¨: AnimationViewComponent ç›‘å¬ SkillAnimationEvent âœ…
    â†’ æ£€æŸ¥æœ¬åœ°å®ä¾‹: entityView._viewComponents ä¸­æœ‰ AnimationViewComponent? âœ…
    â†’ è°ƒç”¨å®ä¾‹å¤„ç†å™¨: AnimationViewComponent.OnSkillAnimation(evt) âœ…
      â†’ æ’­æ”¾åŠ¨ç”»
```

---

## ğŸ” å…³é”®è®¾è®¡å†³ç­–å›é¡¾

### å†³ç­– 1: äº‹ä»¶é˜Ÿåˆ—ä½ç½® â†’ Entity
**åŸå› **ï¼š
- ä¸ Entity.EventQueue å¹¶åˆ—ï¼Œè®¾è®¡ä¸€è‡´
- åˆ›å»ºé¡ºåºå‹å¥½ï¼ˆEntity å…ˆäº EntityView åˆ›å»ºï¼‰
- æ— éœ€é¢å¤–ç¼“å­˜

### å†³ç­– 2: æœåŠ¡å™¨ç«¯é˜²æŠ¤ â†’ Entity.HasViewLayer
**åŸå› **ï¼š
- é™æ€æ ‡è®°ï¼Œé›¶è¿è¡Œæ—¶å¼€é”€
- æœåŠ¡å™¨ç«¯è‡ªåŠ¨æ‹’ç»å…¥é˜Ÿ
- é˜²æ­¢å†…å­˜æ³„æ¼ï¼ˆå…³é”®ï¼ï¼‰

### å†³ç­– 3: å…¨å±€äº‹ä»¶æ³¨å†Œ â†’ ViewComponentEventRegistry
**åŸå› **ï¼š
- ä¸ CapabilitySystem è®¾è®¡ä¸€è‡´
- èŠ‚çœ ~99% å†…å­˜ï¼ˆvs æ¯ä¸ª EntityView ä¸€ä»½ï¼‰
- EntityView åˆ›å»ºæ›´å¿«ï¼ˆæ— éœ€å»ºç«‹æ˜ å°„ï¼‰

### å†³ç­– 4: å¯¹è±¡æ± ä¼˜åŒ– â†’ _eventHandlersRegistered
**åŸå› **ï¼š
- ç¬¦åˆå¯¹è±¡æ± æœ€ä½³å®è·µ
- èŠ‚çœ ~80% CPU å¼€é”€ï¼ˆvs æ¯æ¬¡é‡æ–°æ³¨å†Œï¼‰
- å›ºå®šçŠ¶æ€ä¿ç•™ï¼Œå¯å˜çŠ¶æ€é‡ç½®

### å†³ç­– 5: åˆ†å±‚äº‹ä»¶å¤„ç†
**åŸå› **ï¼š
- Stage çº§åˆ«ï¼šå®ä½“ç”Ÿå‘½å‘¨æœŸï¼ˆEntityCreated, EntityDestroyed, WorldRollbackï¼‰
- EntityView çº§åˆ«ï¼šå­åŸå‹å˜åŒ–ï¼ˆSubArchetypeChangedï¼‰
- ViewComponent çº§åˆ«ï¼šè‡ªå®šä¹‰äº‹ä»¶ï¼ˆCustomViewEventï¼Œé€šè¿‡æ³¨å†Œæœºåˆ¶ï¼‰
- èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

### å†³ç­– 6: è„ç»„ä»¶åŒæ­¥ç‹¬ç«‹
**åŸå› **ï¼š
- è„ç»„ä»¶åŒæ­¥ = é«˜é¢‘æ•°æ®åŒæ­¥ï¼Œè½®è¯¢æœºåˆ¶
- è§†å›¾äº‹ä»¶é˜Ÿåˆ— = ä½é¢‘çŠ¶æ€é€šçŸ¥ï¼Œå¼‚æ­¥é˜Ÿåˆ—
- ä¸¤è€…èŒè´£ä¸åŒï¼Œä¸åº”æ··æ·†

---

## âœ… å®Œæˆæ¸…å•

- [x] Entity.ViewEventQueue åŸºç¡€è®¾æ–½
- [x] ViewEvents å®šä¹‰ï¼ˆ4 ç§é¢„å®šä¹‰ + CustomViewEventï¼‰
- [x] Stage åˆ†å±‚äº‹ä»¶å¤„ç†
- [x] EntityView äº‹ä»¶åˆ†å‘
- [x] ViewComponent äº‹ä»¶æ³¨å†Œæœºåˆ¶
- [x] World/Entity äº‹ä»¶å‘å¸ƒè¿ç§»
- [x] æœåŠ¡å™¨ç«¯é˜²æŠ¤ï¼ˆHasViewLayerï¼‰
- [x] å…¨å±€äº‹ä»¶æ³¨å†Œä¼˜åŒ–ï¼ˆViewComponentEventRegistryï¼‰
- [x] å¯¹è±¡æ± ä¼˜åŒ–ï¼ˆ_eventHandlersRegisteredï¼‰
- [x] ç¼–è¯‘éªŒè¯é€šè¿‡
- [x] æ–‡æ¡£å®Œæ•´

---

## ğŸš€ ä¸‹ä¸€æ­¥

### è¿è¡Œæ¸¸æˆæµ‹è¯•
1. å¯åŠ¨æ¸¸æˆ
2. åˆ›å»ºå®ä½“ï¼ŒæŸ¥çœ‹ Console æ—¥å¿—
3. æµ‹è¯•æŠ€èƒ½ç³»ç»Ÿï¼ŒéªŒè¯åŠ¨ç”»å’Œç‰¹æ•ˆ
4. æ‰“å¼€ Unity Profilerï¼Œç›‘æ§æ€§èƒ½

### ç›‘æ§æŒ‡æ ‡
- `Stage.ProcessViewEvents` è€—æ—¶
- Entity.ViewEventQueue å†…å­˜å ç”¨
- ViewComponent äº‹ä»¶æ³¨å†Œæ¬¡æ•°ï¼ˆåº”è¯¥åªåœ¨ç¬¬ä¸€æ¬¡ï¼‰
- äº‹ä»¶åˆ†å‘æ—¥å¿—ï¼ˆDebug çº§åˆ«ï¼‰

### é¢„æœŸç»“æœ
âœ… EntityView åˆ›å»º/é”€æ¯æ­£å¸¸  
âœ… äº‹ä»¶åˆ†å‘æ­£å¸¸ï¼ŒåŠ¨ç”»æ’­æ”¾æ­£å¸¸  
âœ… æ€§èƒ½ç¨³å®šï¼Œæ— å†…å­˜æ³„æ¼  
âœ… ViewComponent å›è°ƒåªæ³¨å†Œä¸€æ¬¡ï¼ˆå¯¹è±¡æ± ä¼˜åŒ–ï¼‰

---

## ğŸ‰ æ€»ç»“

**ä¸»è¦æˆå°±**ï¼š
1. âœ… é€»è¾‘å±‚å’Œè§†å›¾å±‚å®Œå…¨è§£è€¦
2. âœ… å¼‚æ­¥äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶ï¼ˆä¸ºå¤šçº¿ç¨‹åšå‡†å¤‡ï¼‰
3. âœ… æœåŠ¡å™¨ç«¯å†…å­˜æ³„æ¼é˜²æŠ¤
4. âœ… å…¨å±€äº‹ä»¶æ³¨å†Œä¼˜åŒ–ï¼ˆå†…å­˜èŠ‚çœ ~99%ï¼‰
5. âœ… å¯¹è±¡æ± ä¼˜åŒ–ï¼ˆCPU èŠ‚çœ ~80%ï¼‰
6. âœ… åˆ†å±‚äº‹ä»¶å¤„ç†ï¼ˆèŒè´£æ¸…æ™°ï¼‰
7. âœ… ä¸ CapabilitySystem è®¾è®¡ä¸€è‡´
8. âœ… å‘åå…¼å®¹ï¼ˆä¿ç•™å›é€€å¯èƒ½ï¼‰

**æ¶æ„æå‡**ï¼š
- ğŸ“ è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- ğŸš€ æ€§èƒ½ä¼˜å¼‚ï¼Œå†…å­˜å’Œ CPU åŒä¼˜åŒ–
- ğŸ”’ å¥å£®å¯é ï¼ŒæœåŠ¡å™¨ç«¯é˜²æŠ¤å®Œå–„
- ğŸ¯ å¯æ‰©å±•ï¼Œæ”¯æŒä»»æ„è‡ªå®šä¹‰äº‹ä»¶

æ„Ÿè°¢ä½ çš„ä¼˜ç§€å»ºè®®å’Œåé¦ˆï¼Œæ•´ä¸ªè®¾è®¡ç»è¿‡å¤šæ¬¡è¿­ä»£ä¼˜åŒ–ï¼Œç°åœ¨å·²ç»æ˜¯ä¸€ä¸ªéå¸¸ä¼˜é›…ã€é«˜æ•ˆã€ç¬¦åˆé¡¹ç›®æ¶æ„é£æ ¼çš„å®ç°ï¼ğŸŠ

**å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œæ¸¸æˆæµ‹è¯•ï¼** ğŸ®

