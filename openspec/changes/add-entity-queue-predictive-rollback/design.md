## Context
- 现有回滚基于全局世界，实体间交互紧耦合，回滚成本高。
- 消息交互已抽象为队列，可按实体拆分并携带帧号；本地实体预测需支持被否决/延迟时的快速回滚。
- 两阶段需求：先实现仅本地实体零延迟预测（远端延迟消费），再扩展到影子实体预测交互并与权威对齐。

## Goals / Non-Goals
- Goals: 按实体、按帧管理消息队列；本地预测和单实体回滚重放；影子实体预测与哈希对齐；回滚触发策略与无输入实体处理。
- Non-Goals: 全局物理重放优化、网络协议大规模重构、UI/可视化工具。

## Decisions
- 消息帧戳：所有对战消息携带权威帧号；队列按实体+帧分片，支持备份与重放。
- 阶段一：本地实体预测执行；对外消息标注预测帧，目标实体仅在权威帧追平后消费；出现输入否决/延迟时，回滚到最新权威帧并重放本实体消息与输入片段。
- 阶段二：当存在强交互且需零延迟反馈时，为目标实体创建影子实体运行预测帧；权威实体正常按权威帧推进；当权威帧追平预测帧时比较哈希，若不一致则回滚影子实体至权威帧并用备份队列重放，再通过减速收敛销毁影子。
- 回滚触发：按权威帧批次触发，而非每条第三方输入；无输入/AI 实体保持权威驱动，不进入预测。
- 状态校验：帧级哈希比较限制为必要字段，确保预测/权威一致性检查轻量。

## Risks / Trade-offs
- 风险：影子实体内存/CPU 开销；哈希字段选择不当导致误判或漏判。
- 缓解：仅在需要零延迟交互时创建影子；对哈希字段做最小覆盖列表并提供采样开关；超时或频繁不一致时回退到纯权威模式。

## Migration Plan
- 阶段一先行：只影响本地实体与消息帧戳，保证回滚重放通过后再启用影子实体。
- 阶段二按场景逐步开关：为关键交互开启影子实体，比对稳定后默认关闭影子。
- 验证通过后再推广到更多实体/场景。

## Open Questions
- 影子实体哈希字段的最小集合是否需要含动画/特效同步信息？
- 预测帧队列的最大缓存窗口（帧数）取值与内存上限？
- 是否需要对远端消费延迟的反馈（如 UI 提示）？

