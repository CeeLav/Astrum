## Context
- 现有回滚基于全局世界，实体间交互紧耦合，回滚成本高。
- 消息交互已抽象为队列，可按实体拆分并携带帧号；本地实体预测需支持被否决/延迟时的快速回滚。
- 两阶段需求：先实现仅本地实体零延迟预测（远端延迟消费），再扩展到影子实体预测交互并与权威对齐。

## Goals / Non-Goals
- Goals: 按实体、按帧管理消息队列；阶段一仅预测自己（含自影子），阶段二可预测其他实体（含他人影子）；影子哈希对齐与回滚重放；回滚触发策略与无输入实体处理。
- Non-Goals: 全局物理重放优化、网络协议大规模重构、UI/可视化工具。

## Decisions
- 消息帧戳：所有对战消息携带权威帧号；队列按实体+帧分片，支持备份与重放。服务器下发的消息全部是权威消息。
- 阶段一（仅预测自己）：为本地实体创建影子实体（影子ID = -entityId），影子在预测帧运行，原始实体仅按权威帧运行；影子产生的预测消息不作用于权威实体；权威追平时比对原始 vs 影子哈希，不一致则影子回滚到权威帧并用备份重放。
- 阶段二（预测他人）：在阶段一基础上允许为被作用的其他实体创建影子；影子与对应权威实体比对哈希，不一致回滚重放；一致时收敛后销毁。
- 回滚触发：按权威帧批次触发，而非每条第三方输入；无输入/AI 实体保持权威驱动，不进入预测/影子。
- 状态校验：帧级哈希比较限制为必要字段，确保预测/权威一致性检查轻量。

## Risks / Trade-offs
- 风险：影子实体内存/CPU 开销；哈希字段选择不当导致误判或漏判。
- 缓解：仅在需要零延迟交互时创建影子；对哈希字段做最小覆盖列表并提供采样开关；超时或频繁不一致时回退到纯权威模式。

## Migration Plan
- 阶段一先行：只影响本地实体与消息帧戳，保证回滚重放通过后再启用影子实体。
- 阶段二按场景逐步开关：为关键交互开启影子实体，比对稳定后默认关闭影子。
- 验证通过后再推广到更多实体/场景。

## Open Questions
- 影子实体哈希字段的最小集合是否需要含动画/特效同步信息？
- 预测帧队列的最大缓存窗口（帧数）取值与内存上限？
- 是否需要对远端消费延迟的反馈（如 UI 提示）？

---

# 阶段一设计：本地预测 + 延迟消费 + 单实体回滚

## 目标
- 本地实体零延迟预测执行；所有消息携带帧号并按实体分片。
- 对外消息标记预测帧，目标实体在权威帧追平后再消费，保持顺序一致。
- 输入被否决或帧被推迟时，回滚到最新权威帧，重放本实体消息/输入到预测帧。

## 数据结构与流程
- `EntityMessageQueue`: key = (entityId, frameId)，值为同帧消息列表；同时维护按帧有序索引与备份区。
- 发送路径：构造消息 → 填充预测帧标记（或权威帧号）→ 投递到目标实体队列分片；影子即时消费预测消息，权威实体仅消费权威消息。
- 消费路径：权威实体按 (frameId asc) 消费权威消息；预测标记消息仅供影子消费，不直接作用权威。影子若需要对外效果，需等权威帧下发后由权威实体生效。
- 回滚：触发条件=权威校正导致影子预测无效。步骤：1) 将影子状态回退到最新权威帧快照；2) 从备份区取出该影子在(权威帧, 预测帧]间的输入+消息分片按帧重放；3) 推进预测帧。

## 校验与观测
- 队列一致性：同帧内顺序稳定，帧号不可倒序消费。
- 性能：备份窗口 = 预测超前最大帧差；必要时做滑动窗口回收。
- 观测指标：回滚次数、重放耗时、队列深度、超前帧差。

## 风险与缓解
- 回滚频繁：限制预测超前窗口；对高抖动客户端退回较低预测。
- 备份膨胀：窗口裁剪 + 压缩/池化。
- 延迟消费体验：必要时在 UI 提示“远端校正中”但不影响本地零延迟。

---

# 阶段二设计：影子实体预测交互 + 哈希对齐

## 目标
- 在需要零延迟跨实体交互时，为目标实体创建影子实体在预测帧执行。
- 权威实体正常按权威帧推进；权威追平预测帧时对同帧状态做哈希比对。
- 不一致则回滚影子实体到权威帧并重放备份消息/输入；一致后影子减速收敛并销毁。

## 数据结构与流程
- 影子实体：与权威实体共享只读配置，拥有独立状态/组件快照与消息队列（预测分片）。
- 哈希：选择最小关键字段集（位置/朝向/动作状态/可见公共属性）；每帧对影子与权威进行哈希对比。
- 预测执行：影子实体消费包含预测帧标记的消息，保持与本地发起者时序一致。
- 对齐流程：当权威帧=F
  1) 比对影子帧 F 哈希；若一致，进入“收敛”状态，逐帧将影子速度/状态插值回权威并销毁。
  2) 若不一致：影子回滚到权威帧快照 → 用备份消息/输入重放到帧 F → 重新比对 → 若连续多次不一致，可降级关闭影子，改为延迟消费模式。

## 策略与开关
- 触发策略：仅在强交互、需零延迟反馈的场景创建影子；按场景/技能白名单。
- 回滚批次：仍以权威帧为批次，不因多条第三方输入多次回滚。
- 降级策略：频繁不一致或开销超限 → 关闭影子，退回阶段一。

## 风险与缓解
- CPU/内存开销：影子数量上限 + 生命周期管控（收敛后即销毁）；可按房间并发限制。
- 哈希误判：字段覆盖过少 → 漏检；覆盖过多 → 误报。需调优字段集并可抽样。
- 状态发散：若影子持续不一致，切回延迟消费，避免无限回滚。

