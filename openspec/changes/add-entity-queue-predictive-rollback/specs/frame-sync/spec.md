## ADDED Requirements
### Requirement: 带帧号的按实体消息队列
系统 SHALL 使所有对战消息携带权威帧编号，并按实体+帧分片入队，保持同帧内顺序。

#### Scenario: 发送消息带权威帧戳
- **WHEN** 本地或服务器发送一条与实体相关的对战消息
- **THEN** 消息包含对应的权威帧编号
- **AND** 被路由到该实体的帧分片队列，按帧号、同帧顺序入队

#### Scenario: 接收消息按帧顺序消费
- **WHEN** 实体消费者读取队列
- **THEN** 先按权威帧编号升序、再按同帧顺序出队
- **AND** 可将消费过的帧分片备份以支持回滚重放

### Requirement: 本地预测执行与单实体回滚
本地可控实体 SHALL 在预测帧先于权威帧执行；当输入被否决或延迟导致权威帧落后时，系统 SHALL 回滚到最新权威帧，并基于备份的输入/消息重放至当前预测帧。

#### Scenario: 输入被否决触发回滚重放
- **WHEN** 权威帧确认本地某预测输入无效或帧号被推迟
- **THEN** 本地实体状态回退到最新权威帧
- **AND** 仅重放该实体从权威帧到预测帧期间的备份输入与消息分片
- **AND** 预测帧重新计算后与权威帧保持连续

### Requirement: 阶段一延迟消费外部交互
在阶段一，本地实体发出的面向其他实体的消息 SHALL 标记预测帧号但延迟到权威帧追平后才让目标实体消费，以保证顺序一致且本地零延迟。

#### Scenario: 远端延迟消费保持顺序
- **WHEN** 本地实体在预测帧 F 发出作用于实体 B 的消息
- **THEN** 消息记录预测帧 F 并存入实体 B 的队列
- **AND** 实体 B 仅在权威帧推进到 F 时按帧顺序消费该消息

### Requirement: 阶段二影子实体预测交互
在阶段二，当需要零延迟的跨实体交互时，系统 SHALL 为目标实体创建影子实体在预测帧执行交互，并在权威帧追平时比较状态哈希；不一致时回滚影子实体到权威帧并用备份消息重放，随后减速收敛并销毁影子。

#### Scenario: 影子实体不一致时回滚重放
- **WHEN** 权威实体推进到预测帧 F，影子实体在帧 F 的哈希与权威不一致
- **THEN** 影子实体回滚到权威帧并用备份消息/输入重放到帧 F
- **AND** 重新计算后继续与权威实体比对，直到一致再减速收敛并销毁影子

### Requirement: 回滚触发与无输入实体策略
系统 SHALL 以权威帧批次触发回滚（而非每条第三方输入），并且无玩家输入的实体（如纯 AI）保持权威驱动，不参与预测或影子实体生成。

#### Scenario: 权威帧触发批量回滚
- **WHEN** 新的权威帧到达并包含影响本地预测区间的输入/校正
- **THEN** 系统按权威帧作为批次触发一次回滚重放
- **AND** 不因同一权威帧下的多条第三方输入反复回滚

