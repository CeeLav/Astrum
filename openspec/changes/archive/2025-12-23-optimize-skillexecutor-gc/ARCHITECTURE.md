# SkillExecutorCapability 0 GC ä¼˜åŒ–æ¶æ„å›¾

## ä¼˜åŒ–å‰åå¯¹æ¯”æ¶æ„

### ä¼˜åŒ–å‰ï¼šæ¯å¸§äº§ç”Ÿå¤§é‡ GC

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SkillExecutorCapability.Tick()                             â”‚
â”‚ GC: 125.4 KB/å¸§, 2052 æ¬¡åˆ†é…                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProcessFrame()                                              â”‚
â”‚ âŒ LINQ ToList() - æ¯å¸§åˆ›å»ºæ–° List                          â”‚
â”‚ âŒ foreach æšä¸¾å™¨ - å¯èƒ½äº§ç”Ÿ GC                             â”‚
â”‚ GC: ~90 KB/å¸§                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ProcessVFXâ”‚   â”‚HandleCollisionâ”‚   â”‚HandleDirectâ”‚
    â”‚Trigger   â”‚   â”‚Trigger        â”‚   â”‚Trigger     â”‚
    â”‚          â”‚   â”‚               â”‚   â”‚            â”‚
    â”‚âŒ new    â”‚   â”‚âŒ new         â”‚   â”‚âŒ foreach  â”‚
    â”‚VFXEvent  â”‚   â”‚CollisionFilterâ”‚   â”‚æšä¸¾å™¨      â”‚
    â”‚          â”‚   â”‚âŒ new HashSet â”‚   â”‚            â”‚
    â”‚GC: ~10KB â”‚   â”‚GC: ~25 KB     â”‚   â”‚GC: ~5 KB   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–åï¼šæ¥è¿‘ 0 GC

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SkillExecutorCapability.Tick()                             â”‚
â”‚ GC: < 1 KB/å¸§, < 50 æ¬¡åˆ†é…                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ProcessFrame()                                              â”‚
â”‚ âœ… é¢„åˆ†é…ç¼“å†²åŒº _triggerBuffer                              â”‚
â”‚ âœ… for å¾ªç¯æ›¿ä»£ foreach                                     â”‚
â”‚ GC: 0 B                                                     â”‚
â”‚                                                             â”‚
â”‚ private List<TriggerFrameInfo> _triggerBuffer = new(16);   â”‚
â”‚ _triggerBuffer.Clear();  // å¤ç”¨ï¼Œä¸é‡Šæ”¾å®¹é‡                â”‚
â”‚ for (int i = 0; i < count; i++) { ... }                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ProcessVFXâ”‚   â”‚HandleCollisionâ”‚   â”‚HandleDirectâ”‚
    â”‚Trigger   â”‚   â”‚Trigger        â”‚   â”‚Trigger     â”‚
    â”‚          â”‚   â”‚               â”‚   â”‚            â”‚
    â”‚âœ… å¯¹è±¡æ±  â”‚   â”‚âœ… å¤ç”¨        â”‚   â”‚âœ… for å¾ªç¯ â”‚
    â”‚(å¯é€‰)    â”‚   â”‚_collisionFilterâ”‚   â”‚            â”‚
    â”‚          â”‚   â”‚               â”‚   â”‚            â”‚
    â”‚GC: 0 B   â”‚   â”‚GC: 0 B        â”‚   â”‚GC: 0 B     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµä¼˜åŒ–

### Phase 1: LINQ ToList() â†’ é¢„åˆ†é…ç¼“å†²åŒº

```
ä¼˜åŒ–å‰:
triggerEffects (IReadOnlyList)
    â”‚
    â”œâ”€ Where() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º ä¸´æ—¶æšä¸¾å™¨ (GC)
    â”‚
    â””â”€ ToList() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º æ–° List<T> (GC ~80 KB)
         â”‚
         â””â”€ triggersAtFrame

ä¼˜åŒ–å:
triggerEffects (IReadOnlyList)
    â”‚
    â””â”€ for å¾ªç¯è¿‡æ»¤ â”€â”€â”€â”€â”€â”€â”€â–º _triggerBuffer (é¢„åˆ†é…ï¼Œå¤ç”¨)
         â”‚                    â†“ Clear() (ä¸é‡Šæ”¾å®¹é‡)
         â”‚                    â†“ Add() (æ—  GC)
         â”‚
         â””â”€ _triggerBuffer (0 GC)
```

### Phase 2: foreach â†’ for å¾ªç¯

```
ä¼˜åŒ–å‰:
foreach (var trigger in triggersAtFrame)  // æšä¸¾å™¨ GC
{
    ProcessTrigger(...);
}

ä¼˜åŒ–å:
for (int i = 0; i < _triggerBuffer.Count; i++)  // ç›´æ¥ç´¢å¼•ï¼Œ0 GC
{
    ProcessTrigger(..., _triggerBuffer[i]);
}
```

### Phase 3: CollisionFilter å¤ç”¨

```
ä¼˜åŒ–å‰:
æ¯æ¬¡è°ƒç”¨ HandleCollisionTrigger()
    â”‚
    â””â”€ new CollisionFilter { ... }  â”€â”€â–º GC ~20 KB
         â”‚
         â””â”€ new HashSet<long> { ... } â”€â”€â–º GC ~5 KB

ä¼˜åŒ–å:
åˆå§‹åŒ–ä¸€æ¬¡:
    private CollisionFilter _collisionFilter = new() { ... };

æ¯æ¬¡è°ƒç”¨ HandleCollisionTrigger()
    â”‚
    â””â”€ _collisionFilter.ExcludedEntityIds.Clear()  â”€â”€â–º 0 GC
         â”‚
         â””â”€ _collisionFilter.ExcludedEntityIds.Add(...)  â”€â”€â–º 0 GC
```

### Phase 4: VFX äº‹ä»¶å¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰

```
ä¼˜åŒ–å‰:
æ¯æ¬¡ VFX è§¦å‘
    â”‚
    â”œâ”€ new VFXTriggerEventData { ... }  â”€â”€â–º GC ~5 KB
    â”‚
    â””â”€ new VFXTriggerEvent { ... }  â”€â”€â–º GC ~5 KB

ä¼˜åŒ–å:
æ¯æ¬¡ VFX è§¦å‘
    â”‚
    â”œâ”€ ObjectPool.Fetch<VFXTriggerEventData>()  â”€â”€â–º 0 GC
    â”‚   â”‚
    â”‚   â””â”€ ä½¿ç”¨å®Œå ObjectPool.Recycle(...)
    â”‚
    â””â”€ ObjectPool.Fetch<VFXTriggerEvent>()  â”€â”€â–º 0 GC
        â”‚
        â””â”€ ç”± ViewEvent ç³»ç»Ÿè´Ÿè´£å›æ”¶
```

## å†…å­˜å¸ƒå±€ä¼˜åŒ–

### ä¼˜åŒ–å‰ï¼šå †åˆ†é…

```
Heap (æ‰˜ç®¡å †)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame 1:                                â”‚
â”‚   List<TriggerFrameInfo> (80 KB)       â”‚
â”‚   CollisionFilter (20 KB)              â”‚
â”‚   HashSet<long> (5 KB)                 â”‚
â”‚   VFXTriggerEventData (5 KB)           â”‚
â”‚   VFXTriggerEvent (5 KB)               â”‚
â”‚   æšä¸¾å™¨ (10 KB)                        â”‚
â”‚   Total: 125 KB                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frame 2:                                â”‚
â”‚   List<TriggerFrameInfo> (80 KB)       â”‚
â”‚   CollisionFilter (20 KB)              â”‚
â”‚   ... (é‡å¤)                            â”‚
â”‚   Total: 125 KB                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ... (æ¯å¸§ç´¯ç§¯)                          â”‚
â”‚                                         â”‚
â”‚ GC è§¦å‘ â†’ æš‚åœæ¸¸æˆ â†’ æ€§èƒ½æŠ–åŠ¨           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¼˜åŒ–åï¼šæ ˆ + å®ä¾‹å­—æ®µå¤ç”¨

```
Stack (æ ˆ)                  Heap (æ‰˜ç®¡å † - å®ä¾‹å­—æ®µ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frame 1:         â”‚       â”‚ åˆå§‹åŒ–ä¸€æ¬¡:              â”‚
â”‚   int i          â”‚       â”‚   _triggerBuffer (16)    â”‚
â”‚   int count      â”‚       â”‚   _collisionFilter       â”‚
â”‚   (å±€éƒ¨å˜é‡)     â”‚       â”‚   Total: ~1 KB           â”‚
â”‚   Total: ~100 B  â”‚       â”‚                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚ æ¯å¸§å¤ç”¨:                â”‚
â”‚ Frame 2:         â”‚       â”‚   _triggerBuffer.Clear() â”‚
â”‚   int i          â”‚       â”‚   (ä¸é‡Šæ”¾å®¹é‡)           â”‚
â”‚   int count      â”‚       â”‚   Total: 0 GC            â”‚
â”‚   Total: ~100 B  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ... (æ ˆè‡ªåŠ¨å›æ”¶) â”‚       ObjectPool (å¯¹è±¡æ± )
â”‚                  â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ—  GC å‹åŠ›       â”‚       â”‚ VFXTriggerEventData Ã— 10 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ VFXTriggerEvent Ã— 10     â”‚
                           â”‚ (é¢„åˆ†é…ï¼Œå¾ªç¯å¤ç”¨)       â”‚
                           â”‚ Total: ~10 KB (å›ºå®š)     â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

### GC åˆ†é…æ¥æºåˆ†å¸ƒ

```
ä¼˜åŒ–å‰ (125.4 KB/å¸§):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LINQ ToList()         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 64%     â”‚
â”‚ CollisionFilter       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 20%                     â”‚
â”‚ VFX äº‹ä»¶              â–ˆâ–ˆâ–ˆâ–ˆ 8%                              â”‚
â”‚ foreach æšä¸¾å™¨        â–ˆâ–ˆ 4%                                â”‚
â”‚ å…¶ä»–                  â–ˆâ–ˆ 4%                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜åŒ–å (< 1 KB/å¸§):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å…¶ä»–ï¼ˆä¸å¯é¿å…ï¼‰      â–ˆ 100%                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ€§èƒ½æå‡è·¯çº¿å›¾

```
é˜¶æ®µ          GC åˆ†é…        GC.Alloc æ¬¡æ•°    è€—æ—¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
åˆå§‹çŠ¶æ€      125.4 KB       2052 æ¬¡          3.09ms
   â”‚
   â”œâ”€ Phase 1 å®æ–½ (ToList ä¼˜åŒ–)
   â†“
Phase 1 å    ~40 KB         ~500 æ¬¡          2.8ms
   â”‚          (-68%)         (-76%)           (-9%)
   â”‚
   â”œâ”€ Phase 2 å®æ–½ (å¾ªç¯ä¼˜åŒ–)
   â†“
Phase 2 å    ~30 KB         ~300 æ¬¡          2.5ms
   â”‚          (-76%)         (-85%)           (-19%)
   â”‚
   â”œâ”€ Phase 3 å®æ–½ (Filter å¤ç”¨)
   â†“
Phase 3 å    ~5 KB          ~100 æ¬¡          2.2ms
   â”‚          (-96%)         (-95%)           (-29%)
   â”‚
   â”œâ”€ Phase 4 å®æ–½ (VFX å¯¹è±¡æ± ï¼Œå¯é€‰)
   â†“
æœ€ç»ˆçŠ¶æ€      < 1 KB         < 50 æ¬¡          < 2ms
              (-99%)         (-98%)           (-35%)
```

## å®æ–½ä¼˜å…ˆçº§

```
ä¼˜å…ˆçº§    é˜¶æ®µ        é¢„æœŸ GC å‡å°‘    å®æ–½éš¾åº¦    å®æ–½æ—¶é—´
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”´ é«˜     Phase 1     ~80 KB         ä½          0.5 å¤©
ğŸ”´ é«˜     Phase 2     ~5 KB          ä½          0.5 å¤©
ğŸŸ¡ ä¸­     Phase 3     ~25 KB         ä¸­          0.5 å¤©
ğŸŸ¢ ä½     Phase 4     ~10 KB         ä¸­          1 å¤©
                      (å¯é€‰)
```

## é£é™©ç¼“è§£ç­–ç•¥

```
é£é™©                    ç¼“è§£æªæ–½                    éªŒè¯æ–¹æ³•
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç¼“å†²åŒºå®¹é‡ä¸è¶³          åˆå§‹å®¹é‡ 16ï¼Œè‡ªåŠ¨æ‰©å®¹       ç›‘æ§æœ€å¤§ä½¿ç”¨é‡
CollisionFilter æ±¡æŸ“    æ¯æ¬¡ä½¿ç”¨å‰å¼ºåˆ¶ Clear()      å•å…ƒæµ‹è¯•
å¯¹è±¡æ± å›æ”¶é”™è¯¯          ä¸¥æ ¼æ£€æŸ¥ IsFromPool         æ³„æ¼æ£€æµ‹
æ€§èƒ½é€€åŒ–                æ·»åŠ  ProfileScope           Profiler éªŒè¯
é€»è¾‘é”™è¯¯                å…¨é¢å•å…ƒæµ‹è¯•                å›å½’æµ‹è¯•
```

## å…³é”®ä»£ç ç‰‡æ®µ

### é¢„åˆ†é…ç¼“å†²åŒºæ¨¡å¼

```csharp
public class SkillExecutorCapability : Capability<SkillExecutorCapability>
{
    // å®ä¾‹å­—æ®µï¼šé¢„åˆ†é…ï¼Œæ¯ä¸ªå®ä¾‹ç‹¬ç«‹
    private List<TriggerFrameInfo> _triggerBuffer = new List<TriggerFrameInfo>(16);
    
    private void ProcessFrame(Entity caster, ActionInfo actionInfo, int currentFrame)
    {
        // æ¸…ç©ºç¼“å†²åŒºï¼ˆä¸é‡Šæ”¾å®¹é‡ï¼‰
        _triggerBuffer.Clear();
        
        // æ‰‹åŠ¨è¿‡æ»¤ï¼ˆé¿å… LINQï¼‰
        var triggerEffects = actionInfo.GetTriggerEffects();
        int count = triggerEffects.Count;
        for (int i = 0; i < count; i++)
        {
            var trigger = triggerEffects[i];
            if (trigger.IsFrameInRange(currentFrame))
            {
                _triggerBuffer.Add(trigger);  // å¤ç”¨å®¹é‡ï¼Œæ—  GC
            }
        }
        
        // ä½¿ç”¨ for å¾ªç¯éå†ï¼ˆé¿å…æšä¸¾å™¨ GCï¼‰
        int triggerCount = _triggerBuffer.Count;
        for (int i = 0; i < triggerCount; i++)
        {
            ProcessTrigger(caster, actionInfo, _triggerBuffer[i]);
        }
    }
}
```

### å¯¹è±¡å¤ç”¨æ¨¡å¼

```csharp
public class SkillExecutorCapability : Capability<SkillExecutorCapability>
{
    // å®ä¾‹å­—æ®µï¼šå¤ç”¨ï¼Œæ¯æ¬¡ä½¿ç”¨å‰é‡ç½®
    private CollisionFilter _collisionFilter = new CollisionFilter
    {
        ExcludedEntityIds = new HashSet<long>(),
        OnlyEnemies = false
    };
    
    private void HandleCollisionTrigger(Entity caster, ActionInfo actionInfo, TriggerFrameInfo trigger)
    {
        // é‡ç½®çŠ¶æ€ï¼ˆä¸åˆ›å»ºæ–°å¯¹è±¡ï¼‰
        _collisionFilter.ExcludedEntityIds.Clear();
        _collisionFilter.ExcludedEntityIds.Add(caster.UniqueId);
        _collisionFilter.OnlyEnemies = false;
        
        // ä½¿ç”¨å¤ç”¨çš„å¯¹è±¡
        var hits = hitSystem.QueryHits(caster, shape, _collisionFilter);
        
        // ... å¤„ç†å‘½ä¸­é€»è¾‘ ...
    }
}
```

## æ€»ç»“

æœ¬ä¼˜åŒ–æ–¹æ¡ˆé€šè¿‡ä»¥ä¸‹æŠ€æœ¯æ‰‹æ®µå®ç° 0 GC ç›®æ ‡ï¼š

1. **é¢„åˆ†é…ç¼“å†²åŒº** - å¤ç”¨ List å®¹é‡ï¼Œé¿å…é‡å¤åˆ†é…
2. **å¯¹è±¡å¤ç”¨** - å®ä¾‹å­—æ®µå¤ç”¨ï¼Œé¿å…æ¯æ¬¡åˆ›å»º
3. **é¿å… LINQ** - ä½¿ç”¨ for å¾ªç¯ï¼Œé¿å…ä¸´æ—¶é›†åˆ
4. **å¯¹è±¡æ± ** - é«˜é¢‘å¯¹è±¡ä½¿ç”¨å¯¹è±¡æ± ç®¡ç†

é¢„æœŸæ•ˆæœï¼š
- **GC å‡å°‘ ~99%**: 125.4 KB â†’ < 1 KB
- **æ€§èƒ½æå‡ ~35%**: 3.09ms â†’ < 2ms
- **ä»£ç è´¨é‡æå‡**: éµå¾ªæœ€ä½³å®è·µ

å‚è€ƒå·²å®Œæˆçš„ ActionCapability ä¼˜åŒ–æ¡ˆä¾‹ï¼Œæœ¬æ–¹æ¡ˆå…·æœ‰é«˜åº¦å¯è¡Œæ€§å’Œå¯éªŒè¯æ€§ã€‚

