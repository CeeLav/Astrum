# Tasks: Capability æ€§èƒ½ä¼˜åŒ–å®æ–½è®¡åˆ’

## Phase 1: ä¼˜åŒ– BattleStateCapability ç›®æ ‡æŸ¥è¯¢ (ä¼˜å…ˆçº§: æœ€é«˜)

### 1.1 åœ¨ AIStateMachineComponent æ·»åŠ ç›®æ ‡ç¼“å­˜å­—æ®µ

- [x] åœ¨ `AIStateMachineComponent` æ·»åŠ  `LastTargetValidationFrame` å­—æ®µ
- [x] ç¡®è®¤ `CurrentTargetId` å­—æ®µå·²å­˜åœ¨ï¼ˆç”¨äºå­˜å‚¨ç›®æ ‡ï¼‰
- [x] åœ¨ MemoryPack åºåˆ—åŒ–å±æ€§ä¸­åŒ…å«æ–°å­—æ®µ
- [x] æ·»åŠ å­—æ®µæ³¨é‡Šè¯´æ˜ç”¨é€”
- [x] éªŒè¯åºåˆ—åŒ–/ååºåˆ—åŒ–æ­£ç¡®

### 1.2 ä¿®æ”¹ BattleStateCapability ä½¿ç”¨ç›®æ ‡ç¼“å­˜

- [x] æ·»åŠ  `RetargetDistance` å¸¸é‡ï¼ˆå¦‚ 8.0 å•ä½ï¼‰
- [x] æ·»åŠ  `IsEntityDead()` æ–¹æ³•æ£€æŸ¥ç›®æ ‡æ˜¯å¦æœ‰æ•ˆ
- [x] ä¿®æ”¹ `Tick()` ä¼˜å…ˆä½¿ç”¨ `fsm.CurrentTargetId` ç¼“å­˜
- [x] ä»…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶è°ƒç”¨ `FindNearestEnemy()`
- [x] æ›´æ–° `fsm.CurrentTargetId` å’Œ `LastTargetValidationFrame`
- [x] æ·»åŠ  ProfileScope ç›‘æ§å„é˜¶æ®µæ€§èƒ½

### 1.2 ä¿®æ”¹ Tick é€»è¾‘ä½¿ç”¨ç¼“å­˜

- [ ] å…ˆæ£€æŸ¥ç¼“å­˜ç›®æ ‡æ˜¯å¦å­˜åœ¨ä¸”åœ¨æœ‰æ•ˆèŒƒå›´å†…
- [ ] ç¼“å­˜æœ‰æ•ˆæ—¶ç›´æ¥ä½¿ç”¨ï¼Œè·³è¿‡æŸ¥è¯¢ï¼ˆ90% çš„å¸§ï¼‰
- [ ] ä»…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶æ‰è°ƒç”¨ `FindNearestEnemy()`
- [ ] æ›´æ–°ç¼“å­˜è®°å½•æ–°ç›®æ ‡
- [ ] æ·»åŠ æ€§èƒ½ç›‘æ§ç‚¹ï¼ˆProfileScopeï¼‰

### 1.3 ä½¿ç”¨ BEPU ç‰©ç†æŸ¥è¯¢æ›¿ä»£éå†ï¼ˆæ¬¡è¦ä¼˜åŒ–ï¼‰

- [x] æ£€æŸ¥ `BepuPhysicsWorld` æ˜¯å¦å·²æœ‰èŒƒå›´æŸ¥è¯¢æ–¹æ³•ï¼ˆå·²æœ‰ QuerySphereOverlapï¼‰
- [x] ä¿®æ”¹ `FindNearestEnemy()` ä½¿ç”¨ç‰©ç†æŸ¥è¯¢
- [x] æ·»åŠ å›é€€é€»è¾‘ï¼šç‰©ç†ä¸–ç•Œä¸å¯ç”¨æ—¶ä½¿ç”¨å…¨é‡éå†
- [x] ç¡®ä¿æ‰€æœ‰æˆ˜æ–—å®ä½“å·²æ³¨å†Œåˆ°ç‰©ç†ä¸–ç•Œ

### 1.4 æ¸…ç†å’Œè¾¹ç•Œæƒ…å†µå¤„ç†

- [x] çŠ¶æ€åˆ‡æ¢æ—¶æ¸…ç†ç›®æ ‡ç¼“å­˜ï¼ˆOnDeactivateï¼‰
- [x] ç›®æ ‡æ­»äº¡æ—¶é‡æ–°æŸ¥æ‰¾ç›®æ ‡ï¼ˆIsEntityDead æ£€æŸ¥ï¼‰
- [x] ç›®æ ‡è¶…å‡ºèŒƒå›´æ—¶é‡æ–°æŸ¥æ‰¾

### 1.5 Phase 1 éªŒè¯

- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: Unity Profiler ç¡®è®¤æ€§èƒ½æå‡ï¼ˆç›®æ ‡ï¼š7.08ms â†’ <0.5msï¼‰
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: éªŒè¯ç¼“å­˜å‘½ä¸­ç‡ > 85%
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: AI è¡Œä¸ºä¸ä¼˜åŒ–å‰ä¸€è‡´

---

## Phase 2: å¯¹è±¡æ± ä¼˜åŒ–

### 2.1 ä¿®æ”¹æ‰€æœ‰ LSInput.Create() è°ƒç”¨å¯ç”¨å¯¹è±¡æ± 

- [x] `BattleStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [x] `MoveStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [x] `IdleStateCapability.CreateInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [x] `ServerLSController.CreateDefaultInput()` - æ”¹ä¸º `Create(isFromPool: true)`
- [x] æ·»åŠ æ³¨é‡Šè¯´æ˜ä¸ºä½•å¯ç”¨å¯¹è±¡æ± 

### 2.2 éªŒè¯

- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: Memory Profiler ç¡®è®¤ GC åˆ†é…å‡å°‘ï¼ˆç›®æ ‡ï¼šå‡å°‘ ~600KB/sï¼‰

### 2.3 æ‰©å±•åˆ°å…¶ä»– Capability

- [ ] å®¡æŸ¥å…¶ä»–åˆ›å»ºä¸´æ—¶å¯¹è±¡çš„ Capability
- [ ] åº”ç”¨å¯¹è±¡æ± æ¨¡å¼åˆ°é€‚ç”¨åœºæ™¯
- [ ] éªŒè¯æ¯ä¸ªä¿®æ”¹çš„æ­£ç¡®æ€§

### 2.4 Phase 2 éªŒè¯

- [ ] Memory Profiler ç¡®è®¤ GC åˆ†é… < 100KB/å¸§
- [ ] è¿è¡Œ 30 åˆ†é’Ÿæ— å†…å­˜æ³„æ¼
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

---

## Phase 3: ç›‘æ§ GetComponent æ€§èƒ½

### 3.1 åœ¨ Capability åŸºç±»çš„ GetComponent æ·»åŠ æ€§èƒ½ç›‘æ§

- [x] ä¿®æ”¹ `CapabilityBase.cs` ä¸­çš„ `GetComponent<TComponent>()` æ–¹æ³•
- [x] æ·»åŠ æ¡ä»¶ç¼–è¯‘çš„ ProfileScopeï¼ˆENABLE_PROFILERï¼‰
- [x] ç¼–è¯‘é€šè¿‡

### 3.2 æ”¶é›†æ€§èƒ½æ•°æ®

- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: è¿è¡Œæ¸¸æˆå¹¶ä½¿ç”¨ Unity Profiler æ·±åº¦åˆ†æ
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: è®°å½• GetComponent çš„è¯¦ç»†æ€§èƒ½æ•°æ®
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: ç»Ÿè®¡å„ Capability çš„ GetComponent è°ƒç”¨é¢‘ç‡

### 3.3 Phase 3 å†³ç­–

- [ ] **å¾…æ•°æ®**: å¦‚æœ GetComponent < 0.5ms/å¸§ â†’ æ— éœ€ä¼˜åŒ–
- [ ] **å¾…æ•°æ®**: å¦‚æœ GetComponent > 1ms/å¸§ â†’ è€ƒè™‘ç¼“å­˜æ–¹æ¡ˆ

---

## Phase 4: ActionCapability ä¼˜åŒ–

### 4.1 åˆ†ææ€§èƒ½ç“¶é¢ˆ âœ…

- [x] åˆ†æ ActionCapability çš„æ€§èƒ½ç“¶é¢ˆ
- [x] å‘ç°ä¸»è¦é—®é¢˜ï¼š`GetAvailableActions()` åˆ›å»ºä¸´æ—¶ List
- [x] è¯„ä¼°ä¼˜åŒ–æ–¹æ¡ˆ

### 4.2 æ·»åŠ é¢„åˆ†é…ç¼“å†²åŒº âœ…

- [x] æ·»åŠ  `_availableActionsBuffer` é¢„åˆ†é…ç¼“å†²åŒº
- [x] ä¼˜åŒ– `GetAvailableActions()` ä½¿ç”¨ç¼“å†²åŒºé¿å…ä¸´æ—¶åˆ†é…
- [x] æ·»åŠ  ProfileScope ç›‘æ§å„é˜¶æ®µæ€§èƒ½

### 4.3 æ·»åŠ æ€§èƒ½ç›‘æ§ âœ…

- [x] åœ¨ `ActionCapability.Tick()` æ·»åŠ  ProfileScope
- [x] åœ¨ `CheckCancellation` æ·»åŠ ç›‘æ§ç‚¹
- [x] åœ¨ `SelectAction` æ·»åŠ ç›‘æ§ç‚¹

### 4.4 Phase 4 éªŒè¯

- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: Unity Profiler ç¡®è®¤æ€§èƒ½æå‡ï¼ˆç›®æ ‡ï¼š3.57ms â†’ <2msï¼‰
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: Memory Profiler ç¡®è®¤ GC åˆ†é…å‡å°‘ï¼ˆç›®æ ‡ï¼š247KB â†’ <150KBï¼‰
- [ ] **å¾…ç”¨æˆ·æµ‹è¯•**: åŠ¨ä½œç³»ç»Ÿè¡Œä¸ºæ­£ç¡®

---

## æœ€ç»ˆéªŒè¯

### æ€§èƒ½ç›®æ ‡éªŒè¯

- [ ] **æ€»å¸§æ—¶é—´**: LSUpdater.UpdateWorld < 5msï¼ˆç›®æ ‡ < 3msï¼‰
- [ ] **GC åˆ†é…**: < 100KB/å¸§ï¼ˆç›®æ ‡ < 60KBï¼‰
- [ ] **å¸§ç‡**: 60 FPS ç¨³å®šï¼ˆ100+ å®ä½“åœºæ™¯ï¼‰
- [ ] **å†…å­˜ç¨³å®šæ€§**: è¿è¡Œ 30 åˆ†é’Ÿæ— æ³„æ¼

### æ­£ç¡®æ€§éªŒè¯

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] å›æ”¾æµ‹è¯•ï¼šä¼˜åŒ–å‰åå½•åƒä¸€è‡´
- [ ] AI è¡Œä¸ºæµ‹è¯•ï¼šå¯»è·¯ã€æˆ˜æ–—é€»è¾‘æ­£ç¡®

### æ–‡æ¡£å’Œä»£ç å®¡æŸ¥

- [ ] æ›´æ–°ç›¸å…³ä»£ç æ³¨é‡Š
- [ ] æ›´æ–°æ€§èƒ½ä¼˜åŒ–æ–‡æ¡£
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] OpenSpec è§„èŒƒæ›´æ–°

### éƒ¨ç½²å‡†å¤‡

- [ ] åˆ›å»ºæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] è®°å½•ä¼˜åŒ–å‰åå¯¹æ¯”æ•°æ®
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
- [ ] é€šçŸ¥ç›¸å…³å›¢é˜Ÿæˆå‘˜

---

## ä¼°ç®—æ—¶é—´

| é˜¶æ®µ | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
|------|---------|--------|
| Phase 1: BattleState ä¼˜åŒ– | 0.5-1 å¤© | ğŸ”´ æœ€é«˜ |
| Phase 2: å¯¹è±¡æ±  | 0.5-1 å¤© | ğŸŸ¡ é«˜ |
| Phase 3: GetComponent ç›‘æ§ | 0.5 å¤© | ğŸŸ¡ ä¸­ |
| Phase 4: LINQ ä¼˜åŒ– | 1-2 å¤© | ğŸŸ¢ ä¸­ |
| æœ€ç»ˆéªŒè¯ | 0.5-1 å¤© | ğŸ”´ æœ€é«˜ |
| **æ€»è®¡** | **3-5 å¤©** | |

## å¹¶è¡ŒåŒ–

å¯ä»¥å¹¶è¡Œè¿›è¡Œçš„ä»»åŠ¡ï¼š
- Phase 2ï¼ˆå¯¹è±¡æ± ï¼‰å’Œ Phase 3ï¼ˆæŸ¥è¯¢ç¼“å­˜ï¼‰å¯ä»¥å¹¶è¡Œ
- ä¸åŒ Capability çš„ä¼˜åŒ–å¯ä»¥å¹¶è¡Œï¼ˆåœ¨åŒä¸€ Phase å†…ï¼‰

å¿…é¡»ä¸²è¡Œçš„ä»»åŠ¡ï¼š
- Phase 1 å¿…é¡»å…ˆå®Œæˆï¼ˆå½±å“æœ€å¤§ï¼Œå…¶ä»–ä¼˜åŒ–ä¾èµ–å®ƒï¼‰
- æ¯ä¸ª Phase å†…çš„éªŒè¯å¿…é¡»åœ¨è¯¥ Phase æ‰€æœ‰ä»»åŠ¡å®Œæˆåè¿›è¡Œ
- æœ€ç»ˆéªŒè¯å¿…é¡»åœ¨æ‰€æœ‰ Phase å®Œæˆåè¿›è¡Œ

## é£é™©å’Œåº”å¯¹

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|-------|------|---------|
| ç©ºé—´ç´¢å¼•ç»´æŠ¤æˆæœ¬é«˜ | ä¸­ | é«˜ | ä¼˜å…ˆ Profileï¼Œå¿…è¦æ—¶è°ƒæ•´ CELL_SIZE |
| å¯¹è±¡æ± å¯¼è‡´å†…å­˜æ³„æ¼ | ä½ | é«˜ | ä¸¥æ ¼é™åˆ¶æ± å¤§å°ï¼Œå®šæœŸæ£€æŸ¥ |
| ç¼“å­˜å¤±æ•ˆé€»è¾‘é”™è¯¯ | ä¸­ | é«˜ | å…¨é¢æµ‹è¯•ï¼Œè€ƒè™‘ç¦ç”¨é€‰é¡¹ |
| ä¼˜åŒ–åè¡Œä¸ºä¸ä¸€è‡´ | ä½ | æé«˜ | ä¸¥æ ¼çš„æ­£ç¡®æ€§æµ‹è¯•å’Œå›æ”¾æµ‹è¯• |
| æ—¶é—´ä¼°ç®—ä¸å‡†ç¡® | ä¸­ | ä¸­ | é¢„ç•™ bufferï¼Œåˆ†é˜¶æ®µäº¤ä»˜ |

