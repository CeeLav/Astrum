# 常见问题快速修复指南

> 📋 **用途**: 快速查找和解决角色编辑器常见问题  
> 📅 **更新**: 2025-10-08  
> 🔧 **版本**: v0.2.1

---

## 目录

1. [UI交互问题](#ui交互问题)
2. [CSV数据问题](#csv数据问题)
3. [动画播放问题](#动画播放问题)
4. [预览渲染问题](#预览渲染问题)
5. [编译错误](#编译错误)

---

## UI交互问题

### ❌ 所有按钮和字段无法点击/编辑

**症状**：
- 按钮点击无反应
- 文本字段无法输入
- 数字字段无法修改
- 控制台报错：`Automatic inspector undo only works when you're inspecting a type derived from UnityEngine.Object`

**原因**：
数据类未继承 `UnityEngine.Object`，导致Odin Inspector的Undo功能失效。

**解决方案**：

```csharp
// 1. 修改数据类继承
public class RoleEditorData : ScriptableObject  // 必须继承ScriptableObject
{
    // ...
}

// 2. 修改创建方法
public static RoleEditorData CreateDefault(int id)
{
    var data = CreateInstance<RoleEditorData>();  // 使用CreateInstance
    // ...
    return data;
}

// 3. 修改Clone方法
public RoleEditorData Clone()
{
    var clone = CreateInstance<RoleEditorData>();
    // 手动复制所有字段（不能用MemberwiseClone）
    clone.EntityId = this.EntityId;
    // ...
    return clone;
}

// 4. 窗口中使用PropertyTree
public class RoleEditorWindow : EditorWindow  // 继承EditorWindow，不是OdinEditorWindow
{
    private PropertyTree _propertyTree;
    
    void DrawDetailPanel()
    {
        _propertyTree = PropertyTree.Create(_selectedRole);
        _propertyTree.UpdateTree();
        
        InspectorUtilities.BeginDrawPropertyTree(_propertyTree, true);
        foreach (var property in _propertyTree.EnumerateTree(false))
        {
            property.Draw();
        }
        InspectorUtilities.EndDrawPropertyTree(_propertyTree);
        
        if (_propertyTree.ApplyChanges())
        {
            EditorUtility.SetDirty(_selectedRole);  // 必须调用SetDirty
        }
    }
}
```

**相关文件**：
- `RoleEditorData.cs`
- `RoleEditorWindow.cs`

---

## CSV数据问题

### ❌ CSV读取失败：类型转换错误

**症状**：
```
CsvHelper.TypeConversion.TypeConverterException: The conversion cannot be performed.
Text: 'some_string'
MemberType: System.Int32
```

**原因**：
`TableField` 字段映射与实际CSV列不匹配。

**诊断步骤**：

1. **检查CSV列结构**：
   ```bash
   # 查看CSV前几行
   head -n 5 "#ActionTable.csv"
   ```

2. **检查字段映射**：
   ```csharp
   public class ActionTableData
   {
       // TableField索引 = CSV实际列索引 - 1（因为HasEmptyFirstColumn = true）
       [TableField(0, "actionId")]    // CSV第1列
       [TableField(1, "actionName")]  // CSV第2列
       // ...必须映射所有会读取的列
   }
   ```

3. **验证索引计算**：
   ```
   CSV列:        0(空) | 1      | 2      | 3
   TableField:         | [0]    | [1]    | [2]
   自动+1:             | 1      | 2      | 3
   ```

**解决方案**：
- 确保所有CSV列都有对应的字段映射
- 索引从0开始，不要跳过列
- 字段类型必须与CSV数据类型匹配

---

### ❌ 动画路径为空警告

**症状**：
```
[ConfigTableHelper] Animation path is empty for actionId 1001
```

**诊断步骤**：

1. **检查CSV文件**：
   ```bash
   # 搜索actionId
   grep "1001" "#ActionTable.csv"
   ```

2. **启用调试日志**：
   ```csharp
   // ConfigTableHelper.cs
   Debug.Log($"Loaded {_actionTableCache.Count} action records from CSV");
   for (int i = 0; i < Mathf.Min(3, _actionTableCache.Count); i++)
   {
       var record = _actionTableCache[i];
       Debug.Log($"Record {i}: Id={record.Id}, AnimationPath={record.AnimationPath}");
   }
   ```

3. **验证字段映射**：
   - 确认 `AnimationPath` 字段映射到正确的CSV列
   - 确认该列不是空值

**解决方案**：
- 修正字段映射索引
- 添加缺失的字段映射
- 检查CSV数据完整性

---

## 动画播放问题

### ❌ 动画切换失效

**症状**：
- 下拉菜单选择其他动画后没反应
- 下拉菜单总是显示第一项

**原因**：
`EditorGUILayout.Popup` 的 `selectedIndex` 参数固定为0，无法记住用户选择。

**解决方案**：

```csharp
// 1. 添加状态字段
private int _selectedAnimationIndex = 0;

// 2. 修复下拉菜单逻辑
var actions = ConfigTableHelper.GetAvailableActions(_selectedRole);
string[] actionNames = actions.Select(a => $"{a.ActionName} (ID:{a.ActionId})").ToArray();

// 使用状态字段，而不是固定值0
int newIndex = EditorGUILayout.Popup(_selectedAnimationIndex, actionNames);

// 检测改变，自动播放
if (newIndex != _selectedAnimationIndex)
{
    _selectedAnimationIndex = newIndex;
    _previewModule?.PlayAction(actions[_selectedAnimationIndex].ActionId);
}

// 3. 角色切换时重置索引
private void OnRoleSelected(RoleEditorData role)
{
    _selectedAnimationIndex = 0;  // 重置
    _previewModule?.SetRole(role);
}
```

**规则**：
所有 `EditorGUILayout` 控件的状态都需要用字段保存，包括：
- `Popup` 的 `selectedIndex`
- `Slider` 的 `value`
- `Toggle` 的 `value`
- `Foldout` 的 `foldout`

---

### ❌ 动画播放时角色产生位移

**症状**：
- 播放行走/跑步动画时，角色在预览窗口中移动
- 多次播放后角色移出视野

**原因**：
Animator 的 `applyRootMotion` 默认为 `true`，动画中的根运动被应用到Transform。

**解决方案**：

```csharp
// 1. 关闭Root Motion
private void ReloadModel()
{
    _animancer = AnimationHelper.GetOrAddAnimancer(_previewInstance);
    
    // 关闭Root Motion
    if (_animancer != null && _animancer.Animator != null)
    {
        _animancer.Animator.applyRootMotion = false;
    }
}

// 2. 播放时重置位置
public void PlayAction(int actionId)
{
    // 重置位置和旋转
    if (_previewInstance != null)
    {
        _previewInstance.transform.position = -_modelCenter;
        _previewInstance.transform.rotation = Quaternion.identity;
    }
    
    _currentAnimState = AnimationHelper.PlayAnimationByActionId(_animancer, actionId);
}
```

**相关设置**：
- `applyRootMotion = false` - 忽略动画的根运动
- 每次播放前重置Transform - 防止累积位移

---

## 预览渲染问题

### ❌ RenderTexture创建失败

**症状**：
```
RenderTexture.Create failed: Texture must have height greater than 0
```

**原因**：
预览区域高度计算错误，导致RenderTexture高度为0或负数。

**解决方案**：

```csharp
private void RenderPreview(Rect rect)
{
    // 确保最小高度
    float previewHeight = Mathf.Max(rect.height - 120, 100f);  // 减去控制面板高度
    Rect previewRect = new Rect(rect.x, rect.y, rect.width, previewHeight);
    
    _previewRenderUtility.BeginPreview(previewRect, GUIStyle.none);
    // ...
}
```

**注意事项**：
- 预览区域高度必须 > 0
- 考虑UI布局中其他元素的高度
- 使用 `Mathf.Max` 确保最小值

---

### ❌ 模型显示不全/相机视角问题

**症状**：
- 模型被裁剪
- 模型位置偏上/偏下
- 旋转时模型偏移中心

**解决方案**：

```csharp
// 1. 计算模型边界框
private void CalculateModelBounds()
{
    var renderers = _previewInstance.GetComponentsInChildren<Renderer>();
    Bounds bounds = renderers[0].bounds;
    foreach (var renderer in renderers)
    {
        bounds.Encapsulate(renderer.bounds);
    }
    
    _modelCenter = bounds.center;
    _orbitRadius = Mathf.Max(bounds.size.x, bounds.size.y, bounds.size.z) * 1.5f;
    
    // 将模型移到原点
    _previewInstance.transform.position = -_modelCenter;
    _modelCenter = Vector3.zero;
}

// 2. 球面坐标相机控制
private void RenderPreview(Rect rect)
{
    float theta = _dragRotation.x * Mathf.Deg2Rad;
    float phi = _dragRotation.y * Mathf.Deg2Rad;
    float radius = _orbitRadius * _zoomLevel;
    
    Vector3 cameraPos = _modelCenter + new Vector3(
        radius * Mathf.Sin(phi) * Mathf.Cos(theta),
        radius * Mathf.Cos(phi),
        radius * Mathf.Sin(phi) * Mathf.Sin(theta)
    );
    
    camera.transform.position = cameraPos;
    camera.transform.LookAt(_modelCenter);
    
    // 动态调整裁剪平面
    float distance = Vector3.Distance(cameraPos, _modelCenter);
    camera.nearClipPlane = Mathf.Max(0.01f, distance * 0.01f);
    camera.farClipPlane = distance * 10f;
}
```

**关键点**：
- 计算准确的模型边界框
- 相机围绕模型中心旋转（球面坐标）
- 动态调整裁剪平面

---

## 编译错误

### ❌ 命名空间/类型找不到

**常见错误**：
```
The type or namespace name 'XXX' could not be found
```

**检查清单**：

1. **检查using语句**：
   ```csharp
   using UnityEngine;
   using UnityEditor;
   using Sirenix.OdinInspector.Editor;
   using Animancer;
   using CsvHelper;
   ```

2. **检查程序集引用**（如果使用asmdef）：
   ```json
   {
     "references": [
       "Sirenix.OdinInspector.Editor",
       "Animancer",
       "CsvHelper"
     ]
   }
   ```

3. **检查插件导入**：
   - Odin Inspector 已导入？
   - Animancer 已导入？
   - CsvHelper DLL 已复制到Plugins？

---

### ❌ 方法/属性不存在

**常见错误**：
```
'XXX' does not contain a definition for 'YYY'
```

**诊断步骤**：

1. **检查类/方法名拼写**
2. **检查方法签名**（参数类型、数量）
3. **检查访问修饰符**（public/private）
4. **检查是否使用了正确的实例**

**示例**：
```csharp
// ❌ 错误
ConfigTableHelper.GetRoleActions(role);  // 方法不存在

// ✅ 正确
ConfigTableHelper.GetAvailableActions(role);
```

---

## 快速诊断流程

### 问题排查顺序

1. **检查Console错误日志**
   - 完整阅读错误堆栈
   - 定位具体文件和行号

2. **启用调试日志**
   ```csharp
   Debug.Log($"[DEBUG] Variable value: {value}");
   ```

3. **检查Unity MCP控制台**
   ```
   Tools > Unity MCP > Read Console
   ```

4. **编译测试**
   ```bash
   dotnet build AstrumProj.sln
   ```

5. **查看相关文档**
   - [阶段2 Bug修复记录](./阶段2-Bug修复记录.md)
   - [CHANGELOG](./CHANGELOG.md)

---

## 预防性检查

### 开发新功能时

- [ ] 数据类继承 `ScriptableObject`（如果需要Odin UI）
- [ ] EditorGUI控件状态用字段保存
- [ ] CSV字段映射完整且索引正确
- [ ] 预览渲染区域高度 > 0
- [ ] Animator applyRootMotion 设置正确
- [ ] 添加必要的调试日志
- [ ] 编写代码注释说明

### 提交前检查

- [ ] 编译无错误
- [ ] Console无错误日志
- [ ] 基本功能测试通过
- [ ] 更新相关文档
- [ ] 添加CHANGELOG条目

---

## 联系与反馈

如果遇到本文档未覆盖的问题：

1. 查看 [阶段2 Bug修复记录](./阶段2-Bug修复记录.md) 获取详细技术背景
2. 查看 [CHANGELOG](./CHANGELOG.md) 了解历史修复
3. 检查Unity Console和MCP Console的完整日志
4. 记录问题现象、复现步骤和错误信息

---

**最后更新**: 2025-10-08  
**版本**: v0.2.1  
**维护**: Astrum Team

