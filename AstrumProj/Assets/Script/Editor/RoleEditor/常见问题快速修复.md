# å¸¸è§é—®é¢˜å¿«é€Ÿä¿®å¤æŒ‡å—

> ğŸ“‹ **ç”¨é€”**: å¿«é€ŸæŸ¥æ‰¾å’Œè§£å†³è§’è‰²ç¼–è¾‘å™¨å¸¸è§é—®é¢˜  
> ğŸ“… **æ›´æ–°**: 2025-10-08  
> ğŸ”§ **ç‰ˆæœ¬**: v0.2.1

---

## ç›®å½•

1. [UIäº¤äº’é—®é¢˜](#uiäº¤äº’é—®é¢˜)
2. [CSVæ•°æ®é—®é¢˜](#csvæ•°æ®é—®é¢˜)
3. [åŠ¨ç”»æ’­æ”¾é—®é¢˜](#åŠ¨ç”»æ’­æ”¾é—®é¢˜)
4. [é¢„è§ˆæ¸²æŸ“é—®é¢˜](#é¢„è§ˆæ¸²æŸ“é—®é¢˜)
5. [ç¼–è¯‘é”™è¯¯](#ç¼–è¯‘é”™è¯¯)

---

## UIäº¤äº’é—®é¢˜

### âŒ æ‰€æœ‰æŒ‰é’®å’Œå­—æ®µæ— æ³•ç‚¹å‡»/ç¼–è¾‘

**ç—‡çŠ¶**ï¼š
- æŒ‰é’®ç‚¹å‡»æ— ååº”
- æ–‡æœ¬å­—æ®µæ— æ³•è¾“å…¥
- æ•°å­—å­—æ®µæ— æ³•ä¿®æ”¹
- æ§åˆ¶å°æŠ¥é”™ï¼š`Automatic inspector undo only works when you're inspecting a type derived from UnityEngine.Object`

**åŸå› **ï¼š
æ•°æ®ç±»æœªç»§æ‰¿ `UnityEngine.Object`ï¼Œå¯¼è‡´Odin Inspectorçš„UndoåŠŸèƒ½å¤±æ•ˆã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```csharp
// 1. ä¿®æ”¹æ•°æ®ç±»ç»§æ‰¿
public class RoleEditorData : ScriptableObject  // å¿…é¡»ç»§æ‰¿ScriptableObject
{
    // ...
}

// 2. ä¿®æ”¹åˆ›å»ºæ–¹æ³•
public static RoleEditorData CreateDefault(int id)
{
    var data = CreateInstance<RoleEditorData>();  // ä½¿ç”¨CreateInstance
    // ...
    return data;
}

// 3. ä¿®æ”¹Cloneæ–¹æ³•
public RoleEditorData Clone()
{
    var clone = CreateInstance<RoleEditorData>();
    // æ‰‹åŠ¨å¤åˆ¶æ‰€æœ‰å­—æ®µï¼ˆä¸èƒ½ç”¨MemberwiseCloneï¼‰
    clone.EntityId = this.EntityId;
    // ...
    return clone;
}

// 4. çª—å£ä¸­ä½¿ç”¨PropertyTree
public class RoleEditorWindow : EditorWindow  // ç»§æ‰¿EditorWindowï¼Œä¸æ˜¯OdinEditorWindow
{
    private PropertyTree _propertyTree;
    
    void DrawDetailPanel()
    {
        _propertyTree = PropertyTree.Create(_selectedRole);
        _propertyTree.UpdateTree();
        
        InspectorUtilities.BeginDrawPropertyTree(_propertyTree, true);
        foreach (var property in _propertyTree.EnumerateTree(false))
        {
            property.Draw();
        }
        InspectorUtilities.EndDrawPropertyTree(_propertyTree);
        
        if (_propertyTree.ApplyChanges())
        {
            EditorUtility.SetDirty(_selectedRole);  // å¿…é¡»è°ƒç”¨SetDirty
        }
    }
}
```

**ç›¸å…³æ–‡ä»¶**ï¼š
- `RoleEditorData.cs`
- `RoleEditorWindow.cs`

---

## CSVæ•°æ®é—®é¢˜

### âŒ CSVè¯»å–å¤±è´¥ï¼šç±»å‹è½¬æ¢é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
CsvHelper.TypeConversion.TypeConverterException: The conversion cannot be performed.
Text: 'some_string'
MemberType: System.Int32
```

**åŸå› **ï¼š
`TableField` å­—æ®µæ˜ å°„ä¸å®é™…CSVåˆ—ä¸åŒ¹é…ã€‚

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥CSVåˆ—ç»“æ„**ï¼š
   ```bash
   # æŸ¥çœ‹CSVå‰å‡ è¡Œ
   head -n 5 "#ActionTable.csv"
   ```

2. **æ£€æŸ¥å­—æ®µæ˜ å°„**ï¼š
   ```csharp
   public class ActionTableData
   {
       // TableFieldç´¢å¼• = CSVå®é™…åˆ—ç´¢å¼• - 1ï¼ˆå› ä¸ºHasEmptyFirstColumn = trueï¼‰
       [TableField(0, "actionId")]    // CSVç¬¬1åˆ—
       [TableField(1, "actionName")]  // CSVç¬¬2åˆ—
       // ...å¿…é¡»æ˜ å°„æ‰€æœ‰ä¼šè¯»å–çš„åˆ—
   }
   ```

3. **éªŒè¯ç´¢å¼•è®¡ç®—**ï¼š
   ```
   CSVåˆ—:        0(ç©º) | 1      | 2      | 3
   TableField:         | [0]    | [1]    | [2]
   è‡ªåŠ¨+1:             | 1      | 2      | 3
   ```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç¡®ä¿æ‰€æœ‰CSVåˆ—éƒ½æœ‰å¯¹åº”çš„å­—æ®µæ˜ å°„
- ç´¢å¼•ä»0å¼€å§‹ï¼Œä¸è¦è·³è¿‡åˆ—
- å­—æ®µç±»å‹å¿…é¡»ä¸CSVæ•°æ®ç±»å‹åŒ¹é…

---

### âŒ åŠ¨ç”»è·¯å¾„ä¸ºç©ºè­¦å‘Š

**ç—‡çŠ¶**ï¼š
```
[ConfigTableHelper] Animation path is empty for actionId 1001
```

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥CSVæ–‡ä»¶**ï¼š
   ```bash
   # æœç´¢actionId
   grep "1001" "#ActionTable.csv"
   ```

2. **å¯ç”¨è°ƒè¯•æ—¥å¿—**ï¼š
   ```csharp
   // ConfigTableHelper.cs
   Debug.Log($"Loaded {_actionTableCache.Count} action records from CSV");
   for (int i = 0; i < Mathf.Min(3, _actionTableCache.Count); i++)
   {
       var record = _actionTableCache[i];
       Debug.Log($"Record {i}: Id={record.Id}, AnimationPath={record.AnimationPath}");
   }
   ```

3. **éªŒè¯å­—æ®µæ˜ å°„**ï¼š
   - ç¡®è®¤ `AnimationPath` å­—æ®µæ˜ å°„åˆ°æ­£ç¡®çš„CSVåˆ—
   - ç¡®è®¤è¯¥åˆ—ä¸æ˜¯ç©ºå€¼

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä¿®æ­£å­—æ®µæ˜ å°„ç´¢å¼•
- æ·»åŠ ç¼ºå¤±çš„å­—æ®µæ˜ å°„
- æ£€æŸ¥CSVæ•°æ®å®Œæ•´æ€§

---

## åŠ¨ç”»æ’­æ”¾é—®é¢˜

### âŒ åŠ¨ç”»åˆ‡æ¢å¤±æ•ˆ

**ç—‡çŠ¶**ï¼š
- ä¸‹æ‹‰èœå•é€‰æ‹©å…¶ä»–åŠ¨ç”»åæ²¡ååº”
- ä¸‹æ‹‰èœå•æ€»æ˜¯æ˜¾ç¤ºç¬¬ä¸€é¡¹

**åŸå› **ï¼š
`EditorGUILayout.Popup` çš„ `selectedIndex` å‚æ•°å›ºå®šä¸º0ï¼Œæ— æ³•è®°ä½ç”¨æˆ·é€‰æ‹©ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```csharp
// 1. æ·»åŠ çŠ¶æ€å­—æ®µ
private int _selectedAnimationIndex = 0;

// 2. ä¿®å¤ä¸‹æ‹‰èœå•é€»è¾‘
var actions = ConfigTableHelper.GetAvailableActions(_selectedRole);
string[] actionNames = actions.Select(a => $"{a.ActionName} (ID:{a.ActionId})").ToArray();

// ä½¿ç”¨çŠ¶æ€å­—æ®µï¼Œè€Œä¸æ˜¯å›ºå®šå€¼0
int newIndex = EditorGUILayout.Popup(_selectedAnimationIndex, actionNames);

// æ£€æµ‹æ”¹å˜ï¼Œè‡ªåŠ¨æ’­æ”¾
if (newIndex != _selectedAnimationIndex)
{
    _selectedAnimationIndex = newIndex;
    _previewModule?.PlayAction(actions[_selectedAnimationIndex].ActionId);
}

// 3. è§’è‰²åˆ‡æ¢æ—¶é‡ç½®ç´¢å¼•
private void OnRoleSelected(RoleEditorData role)
{
    _selectedAnimationIndex = 0;  // é‡ç½®
    _previewModule?.SetRole(role);
}
```

**è§„åˆ™**ï¼š
æ‰€æœ‰ `EditorGUILayout` æ§ä»¶çš„çŠ¶æ€éƒ½éœ€è¦ç”¨å­—æ®µä¿å­˜ï¼ŒåŒ…æ‹¬ï¼š
- `Popup` çš„ `selectedIndex`
- `Slider` çš„ `value`
- `Toggle` çš„ `value`
- `Foldout` çš„ `foldout`

---

### âŒ åŠ¨ç”»æ’­æ”¾æ—¶è§’è‰²äº§ç”Ÿä½ç§»

**ç—‡çŠ¶**ï¼š
- æ’­æ”¾è¡Œèµ°/è·‘æ­¥åŠ¨ç”»æ—¶ï¼Œè§’è‰²åœ¨é¢„è§ˆçª—å£ä¸­ç§»åŠ¨
- å¤šæ¬¡æ’­æ”¾åè§’è‰²ç§»å‡ºè§†é‡

**åŸå› **ï¼š
Animator çš„ `applyRootMotion` é»˜è®¤ä¸º `true`ï¼ŒåŠ¨ç”»ä¸­çš„æ ¹è¿åŠ¨è¢«åº”ç”¨åˆ°Transformã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```csharp
// 1. å…³é—­Root Motion
private void ReloadModel()
{
    _animancer = AnimationHelper.GetOrAddAnimancer(_previewInstance);
    
    // å…³é—­Root Motion
    if (_animancer != null && _animancer.Animator != null)
    {
        _animancer.Animator.applyRootMotion = false;
    }
}

// 2. æ’­æ”¾æ—¶é‡ç½®ä½ç½®
public void PlayAction(int actionId)
{
    // é‡ç½®ä½ç½®å’Œæ—‹è½¬
    if (_previewInstance != null)
    {
        _previewInstance.transform.position = -_modelCenter;
        _previewInstance.transform.rotation = Quaternion.identity;
    }
    
    _currentAnimState = AnimationHelper.PlayAnimationByActionId(_animancer, actionId);
}
```

**ç›¸å…³è®¾ç½®**ï¼š
- `applyRootMotion = false` - å¿½ç•¥åŠ¨ç”»çš„æ ¹è¿åŠ¨
- æ¯æ¬¡æ’­æ”¾å‰é‡ç½®Transform - é˜²æ­¢ç´¯ç§¯ä½ç§»

---

## é¢„è§ˆæ¸²æŸ“é—®é¢˜

### âŒ RenderTextureåˆ›å»ºå¤±è´¥

**ç—‡çŠ¶**ï¼š
```
RenderTexture.Create failed: Texture must have height greater than 0
```

**åŸå› **ï¼š
é¢„è§ˆåŒºåŸŸé«˜åº¦è®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´RenderTextureé«˜åº¦ä¸º0æˆ–è´Ÿæ•°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

```csharp
private void RenderPreview(Rect rect)
{
    // ç¡®ä¿æœ€å°é«˜åº¦
    float previewHeight = Mathf.Max(rect.height - 120, 100f);  // å‡å»æ§åˆ¶é¢æ¿é«˜åº¦
    Rect previewRect = new Rect(rect.x, rect.y, rect.width, previewHeight);
    
    _previewRenderUtility.BeginPreview(previewRect, GUIStyle.none);
    // ...
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- é¢„è§ˆåŒºåŸŸé«˜åº¦å¿…é¡» > 0
- è€ƒè™‘UIå¸ƒå±€ä¸­å…¶ä»–å…ƒç´ çš„é«˜åº¦
- ä½¿ç”¨ `Mathf.Max` ç¡®ä¿æœ€å°å€¼

---

### âŒ æ¨¡å‹æ˜¾ç¤ºä¸å…¨/ç›¸æœºè§†è§’é—®é¢˜

**ç—‡çŠ¶**ï¼š
- æ¨¡å‹è¢«è£å‰ª
- æ¨¡å‹ä½ç½®åä¸Š/åä¸‹
- æ—‹è½¬æ—¶æ¨¡å‹åç§»ä¸­å¿ƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š

```csharp
// 1. è®¡ç®—æ¨¡å‹è¾¹ç•Œæ¡†
private void CalculateModelBounds()
{
    var renderers = _previewInstance.GetComponentsInChildren<Renderer>();
    Bounds bounds = renderers[0].bounds;
    foreach (var renderer in renderers)
    {
        bounds.Encapsulate(renderer.bounds);
    }
    
    _modelCenter = bounds.center;
    _orbitRadius = Mathf.Max(bounds.size.x, bounds.size.y, bounds.size.z) * 1.5f;
    
    // å°†æ¨¡å‹ç§»åˆ°åŸç‚¹
    _previewInstance.transform.position = -_modelCenter;
    _modelCenter = Vector3.zero;
}

// 2. çƒé¢åæ ‡ç›¸æœºæ§åˆ¶
private void RenderPreview(Rect rect)
{
    float theta = _dragRotation.x * Mathf.Deg2Rad;
    float phi = _dragRotation.y * Mathf.Deg2Rad;
    float radius = _orbitRadius * _zoomLevel;
    
    Vector3 cameraPos = _modelCenter + new Vector3(
        radius * Mathf.Sin(phi) * Mathf.Cos(theta),
        radius * Mathf.Cos(phi),
        radius * Mathf.Sin(phi) * Mathf.Sin(theta)
    );
    
    camera.transform.position = cameraPos;
    camera.transform.LookAt(_modelCenter);
    
    // åŠ¨æ€è°ƒæ•´è£å‰ªå¹³é¢
    float distance = Vector3.Distance(cameraPos, _modelCenter);
    camera.nearClipPlane = Mathf.Max(0.01f, distance * 0.01f);
    camera.farClipPlane = distance * 10f;
}
```

**å…³é”®ç‚¹**ï¼š
- è®¡ç®—å‡†ç¡®çš„æ¨¡å‹è¾¹ç•Œæ¡†
- ç›¸æœºå›´ç»•æ¨¡å‹ä¸­å¿ƒæ—‹è½¬ï¼ˆçƒé¢åæ ‡ï¼‰
- åŠ¨æ€è°ƒæ•´è£å‰ªå¹³é¢

---

## ç¼–è¯‘é”™è¯¯

### âŒ å‘½åç©ºé—´/ç±»å‹æ‰¾ä¸åˆ°

**å¸¸è§é”™è¯¯**ï¼š
```
The type or namespace name 'XXX' could not be found
```

**æ£€æŸ¥æ¸…å•**ï¼š

1. **æ£€æŸ¥usingè¯­å¥**ï¼š
   ```csharp
   using UnityEngine;
   using UnityEditor;
   using Sirenix.OdinInspector.Editor;
   using Animancer;
   using CsvHelper;
   ```

2. **æ£€æŸ¥ç¨‹åºé›†å¼•ç”¨**ï¼ˆå¦‚æœä½¿ç”¨asmdefï¼‰ï¼š
   ```json
   {
     "references": [
       "Sirenix.OdinInspector.Editor",
       "Animancer",
       "CsvHelper"
     ]
   }
   ```

3. **æ£€æŸ¥æ’ä»¶å¯¼å…¥**ï¼š
   - Odin Inspector å·²å¯¼å…¥ï¼Ÿ
   - Animancer å·²å¯¼å…¥ï¼Ÿ
   - CsvHelper DLL å·²å¤åˆ¶åˆ°Pluginsï¼Ÿ

---

### âŒ æ–¹æ³•/å±æ€§ä¸å­˜åœ¨

**å¸¸è§é”™è¯¯**ï¼š
```
'XXX' does not contain a definition for 'YYY'
```

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥ç±»/æ–¹æ³•åæ‹¼å†™**
2. **æ£€æŸ¥æ–¹æ³•ç­¾å**ï¼ˆå‚æ•°ç±»å‹ã€æ•°é‡ï¼‰
3. **æ£€æŸ¥è®¿é—®ä¿®é¥°ç¬¦**ï¼ˆpublic/privateï¼‰
4. **æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„å®ä¾‹**

**ç¤ºä¾‹**ï¼š
```csharp
// âŒ é”™è¯¯
ConfigTableHelper.GetRoleActions(role);  // æ–¹æ³•ä¸å­˜åœ¨

// âœ… æ­£ç¡®
ConfigTableHelper.GetAvailableActions(role);
```

---

## å¿«é€Ÿè¯Šæ–­æµç¨‹

### é—®é¢˜æ’æŸ¥é¡ºåº

1. **æ£€æŸ¥Consoleé”™è¯¯æ—¥å¿—**
   - å®Œæ•´é˜…è¯»é”™è¯¯å †æ ˆ
   - å®šä½å…·ä½“æ–‡ä»¶å’Œè¡Œå·

2. **å¯ç”¨è°ƒè¯•æ—¥å¿—**
   ```csharp
   Debug.Log($"[DEBUG] Variable value: {value}");
   ```

3. **æ£€æŸ¥Unity MCPæ§åˆ¶å°**
   ```
   Tools > Unity MCP > Read Console
   ```

4. **ç¼–è¯‘æµ‹è¯•**
   ```bash
   dotnet build AstrumProj.sln
   ```

5. **æŸ¥çœ‹ç›¸å…³æ–‡æ¡£**
   - [é˜¶æ®µ2 Bugä¿®å¤è®°å½•](./é˜¶æ®µ2-Bugä¿®å¤è®°å½•.md)
   - [CHANGELOG](./CHANGELOG.md)

---

## é¢„é˜²æ€§æ£€æŸ¥

### å¼€å‘æ–°åŠŸèƒ½æ—¶

- [ ] æ•°æ®ç±»ç»§æ‰¿ `ScriptableObject`ï¼ˆå¦‚æœéœ€è¦Odin UIï¼‰
- [ ] EditorGUIæ§ä»¶çŠ¶æ€ç”¨å­—æ®µä¿å­˜
- [ ] CSVå­—æ®µæ˜ å°„å®Œæ•´ä¸”ç´¢å¼•æ­£ç¡®
- [ ] é¢„è§ˆæ¸²æŸ“åŒºåŸŸé«˜åº¦ > 0
- [ ] Animator applyRootMotion è®¾ç½®æ­£ç¡®
- [ ] æ·»åŠ å¿…è¦çš„è°ƒè¯•æ—¥å¿—
- [ ] ç¼–å†™ä»£ç æ³¨é‡Šè¯´æ˜

### æäº¤å‰æ£€æŸ¥

- [ ] ç¼–è¯‘æ— é”™è¯¯
- [ ] Consoleæ— é”™è¯¯æ—¥å¿—
- [ ] åŸºæœ¬åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [ ] æ·»åŠ CHANGELOGæ¡ç›®

---

## è”ç³»ä¸åé¦ˆ

å¦‚æœé‡åˆ°æœ¬æ–‡æ¡£æœªè¦†ç›–çš„é—®é¢˜ï¼š

1. æŸ¥çœ‹ [é˜¶æ®µ2 Bugä¿®å¤è®°å½•](./é˜¶æ®µ2-Bugä¿®å¤è®°å½•.md) è·å–è¯¦ç»†æŠ€æœ¯èƒŒæ™¯
2. æŸ¥çœ‹ [CHANGELOG](./CHANGELOG.md) äº†è§£å†å²ä¿®å¤
3. æ£€æŸ¥Unity Consoleå’ŒMCP Consoleçš„å®Œæ•´æ—¥å¿—
4. è®°å½•é—®é¢˜ç°è±¡ã€å¤ç°æ­¥éª¤å’Œé”™è¯¯ä¿¡æ¯

---

**æœ€åæ›´æ–°**: 2025-10-08  
**ç‰ˆæœ¬**: v0.2.1  
**ç»´æŠ¤**: Astrum Team

