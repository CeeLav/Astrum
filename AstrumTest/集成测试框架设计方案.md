# AstrumLogic é›†æˆæµ‹è¯•æ¡†æ¶è®¾è®¡æ–¹æ¡ˆ

> ğŸ“… åˆ›å»ºæ—¶é—´: 2025-10-11  
> ğŸ¯ ç›®æ ‡: è®¾è®¡é€šç”¨çš„é€»è¾‘å±‚é›†æˆæµ‹è¯•æ¡†æ¶ï¼Œå®Œå…¨è´´è¿‘çœŸå®è¿è¡Œç¯å¢ƒ

---

## ä¸€ã€è®¾è®¡åŸåˆ™

### 1.1 æ ¸å¿ƒåŸåˆ™

**å®Œå…¨çœŸå®ç¯å¢ƒ**
- âœ… ä½¿ç”¨çœŸå®çš„ `Room`, `World`, `Entity`, `LSController`
- âœ… ä½¿ç”¨çœŸå®çš„ `EntityFactory`, `SkillEffectManager`, `HitManager`
- âŒ ä¸åˆ›å»ºä»»ä½•æµ‹è¯•ä¸“ç”¨åŒ…è£…ç±»ï¼ˆå¦‚ `TestEntity`, `TestRoom`ï¼‰
- âŒ ä¸åˆ›å»ºæµ‹è¯•ä¸“ç”¨çš„ç®€åŒ–ç‰ˆæœ¬

**é€šç”¨æ€§**
- âœ… æ ¸å¿ƒæµ‹è¯•å¼•æ“ä¸å…·ä½“åœºæ™¯æ— å…³
- âœ… å¯ä»¥æµ‹è¯•ä»»ä½•é€»è¾‘ï¼šæˆ˜æ–—ã€ç§»åŠ¨ã€AIã€ç‰©ç†äº¤äº’ã€æŠ€èƒ½ç³»ç»Ÿç­‰
- âœ… é€šè¿‡æ•°æ®é©±åŠ¨æ”¯æŒå„ç§æµ‹è¯•åœºæ™¯

**è´´è¿‘å•äººæ¨¡å¼**
- âœ… å®Œå…¨æ¨¡æ‹Ÿå•äººæ¨¡å¼çš„é€»è¾‘éƒ¨åˆ†
- âœ… åŒ…å« Room + World + LSController + Entity
- âŒ ä¸åŒ…å«è¡¨ç°å±‚ï¼ˆStage, EntityView, UIï¼‰

---

## äºŒã€æ¶æ„è®¾è®¡

### 2.1 ä¸‰å±‚æ¶æ„

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚æ¬¡1: æ ¸å¿ƒæµ‹è¯•å¼•æ“ï¼ˆCoreï¼‰                                â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ èŒè´£ï¼š                                                      â”‚
â”‚ - æ­å»ºçœŸå®çš„ Room + World ç¯å¢ƒ                             â”‚
â”‚ - æä¾›é€šç”¨çš„å¸§é©±åŠ¨å’Œè¾“å…¥æ¨¡æ‹Ÿ                               â”‚
â”‚ - æä¾›é€šç”¨çš„æ–­è¨€å’ŒéªŒè¯å·¥å…·                                 â”‚
â”‚ - å¯é€‰ï¼šè®°å½•æµ‹è¯•è¿‡ç¨‹æ•°æ®                                   â”‚
â”‚                                                             â”‚
â”‚ è®¾è®¡è¦æ±‚ï¼š                                                  â”‚
â”‚ âœ… åœºæ™¯æ— å…³ï¼Œå®Œå…¨é€šç”¨                                      â”‚
â”‚ âœ… æœ€å°åŒ–ï¼Œåªæä¾›å¿…è¦çš„å·¥å…·                                â”‚
â”‚ âŒ ä¸åŒ…è£…æˆ–æ›¿æ¢ä»»ä½•ç”Ÿäº§ä»£ç                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚æ¬¡2: æµ‹è¯•ç”¨ä¾‹ï¼ˆCasesï¼‰                                   â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹ï¼š                                                      â”‚
â”‚ - æˆ˜æ–—é€»è¾‘æµ‹è¯•ï¼ˆCombatLogicTests.csï¼‰                      â”‚
â”‚ - ç§»åŠ¨é€»è¾‘æµ‹è¯•ï¼ˆMovementLogicTests.csï¼‰                    â”‚
â”‚ - æŠ€èƒ½ç³»ç»Ÿæµ‹è¯•ï¼ˆSkillSystemFlowTests.csï¼‰                  â”‚
â”‚ - ç‰©ç†äº¤äº’æµ‹è¯•ï¼ˆPhysicsInteractionTests.csï¼‰               â”‚
â”‚ - AIè¡Œä¸ºæµ‹è¯•ï¼ˆAIBehaviorTests.csï¼‰                         â”‚
â”‚                                                             â”‚
â”‚ è®¾è®¡è¦æ±‚ï¼š                                                  â”‚
â”‚ âœ… ç›´æ¥ä½¿ç”¨çœŸå®ç±»ï¼ˆRoom, World, Entityï¼‰                   â”‚
â”‚ âœ… ä½¿ç”¨æ ¸å¿ƒå¼•æ“æä¾›çš„å·¥å…·                                  â”‚
â”‚ âœ… å¯ä»¥ä»æ•°æ®åŠ è½½ï¼Œä¹Ÿå¯ä»¥ç¡¬ç¼–ç                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å±‚æ¬¡3: æµ‹è¯•æ•°æ®ï¼ˆDataï¼‰                                    â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚ ç±»å‹ï¼š                                                      â”‚
â”‚ - åœºæ™¯é…ç½®ï¼ˆScenarios/*.jsonï¼‰                             â”‚
â”‚ - å®ä½“é…ç½®ï¼ˆEntities/*.jsonï¼‰                              â”‚
â”‚ - è¾“å…¥åºåˆ—ï¼ˆInputs/*.jsonï¼‰                                â”‚
â”‚ - é¢„æœŸç»“æœï¼ˆExpected/*.jsonï¼‰                              â”‚
â”‚                                                             â”‚
â”‚ è®¾è®¡è¦æ±‚ï¼š                                                  â”‚
â”‚ âœ… JSON æ ¼å¼ï¼Œæ˜“äºç¼–è¾‘                                     â”‚
â”‚ âœ… å¯é€‰ä½¿ç”¨ï¼ˆä¹Ÿæ”¯æŒä»£ç ç¡¬ç¼–ç ï¼‰                            â”‚
â”‚ âœ… ä¾¿äºå¤ç”¨å’Œç»„åˆ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€è¯¦ç»†è®¾è®¡

### 3.1 å±‚æ¬¡1ï¼šæ ¸å¿ƒæµ‹è¯•å¼•æ“ï¼ˆå›ºå®šæµç¨‹ï¼‰

**è®¾è®¡æ€æƒ³**ï¼š
æ ¸å¿ƒå¼•æ“å°è£…å®Œæ•´çš„æµ‹è¯•æ‰§è¡Œæµç¨‹ï¼Œç”¨æˆ·åªä¼  JSON æ–‡ä»¶åã€‚
ä»è¯»å–ç”¨ä¾‹åˆ°è¾“å‡ºæŠ¥å‘Šï¼Œå…¨è‡ªåŠ¨åŒ–ï¼Œç”¨æˆ·æ— æ³•ç»•è¿‡æ ¸å¿ƒæµç¨‹ã€‚

**æ ¸å¿ƒæµç¨‹**ï¼š
```plaintext
RunTestCase("TwoKnightsFight.json")
  â†“
[1] è¯»å– JSON ç”¨ä¾‹æ–‡ä»¶ + åŠ è½½å®ä½“æ¨¡æ¿
  â†“
[2] åˆå§‹åŒ–æ‰€æœ‰ Manager
  â†“
[3] åˆ›å»º Room + World + LSController
  â†“
[4] é€å¸§æ‰§è¡Œæµ‹è¯•ï¼ˆå®ä½“é€šè¿‡ CreateEntity æŒ‡ä»¤åˆ›å»ºï¼‰
  â†“
    for each frame:
      [4.1] æ‰§è¡Œè¾“å…¥æŒ‡ä»¤ï¼ˆåŒ…æ‹¬ CreateEntityï¼‰
      [4.2] æ›´æ–°æ¸¸æˆé€»è¾‘ä¸€å¸§
      [4.3] æ‰§è¡ŒæŸ¥è¯¢æŒ‡ä»¤
      [4.4] éªŒè¯é¢„æœŸè¾“å‡º
  â†“
è¿”å› TestResultï¼ˆSuccess/Failï¼‰
```

#### ç›®å½•ç»“æ„

```plaintext
Integration/Core/
â”œâ”€â”€ LogicTestExecutor.cs          # æµ‹è¯•æ‰§è¡Œå¼•æ“ï¼ˆæ ¸å¿ƒï¼ï¼‰
â”‚                                  # RunTestCase(jsonFile)
â”‚                                  # â†“
â”‚                                  # è¯»å–JSON â†’ åˆå§‹åŒ– â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ æŠ¥å‘Š
â”‚
â”œâ”€â”€ TestCaseData.cs               # JSON æ•°æ®ç»“æ„å®šä¹‰
â”œâ”€â”€ TestResult.cs                 # æµ‹è¯•ç»“æœæ•°æ®ç»“æ„
â””â”€â”€ Assertions/                   # æ–­è¨€å·¥å…·ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
    â”œâ”€â”€ EntityAssert.cs
    â””â”€â”€ SkillAssert.cs
```

#### æ ¸å¿ƒç±»è®¾è®¡

##### LogicTestExecutor.csï¼ˆæ ¸å¿ƒï¼ï¼‰

```csharp
/// <summary>
/// é€»è¾‘æµ‹è¯•æ‰§è¡Œå¼•æ“ - å›ºå®šæµç¨‹å°è£…
/// 
/// ç”¨æˆ·åªéœ€è°ƒç”¨ï¼šRunTestCase("scenarioName.json")
/// å¼•æ“è‡ªåŠ¨å®Œæˆï¼šè¯»å– â†’ åˆå§‹åŒ– â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ æŠ¥å‘Š
/// </summary>
public class LogicTestExecutor : IDisposable
{
    // çœŸå®çš„æ¸¸æˆé€»è¾‘å¯¹è±¡
    public Room Room { get; private set; }
    public World World => Room?.MainWorld;
    public LSController LSController => Room?.LSController;
    
    private readonly ITestOutputHelper _output;
    private readonly string _dataDirectory;  // æµ‹è¯•æ•°æ®ç›®å½•
    private readonly Dictionary<string, EntityTemplate> _entityTemplates = new();  // å®ä½“æ¨¡æ¿
    private readonly Dictionary<string, Entity> _entities = new();  // å®ä½“æ˜ å°„è¡¨ï¼ˆentityId â†’ Entityï¼‰
    private bool _isInitialized = false;
    
    public LogicTestExecutor(ITestOutputHelper output, ConfigFixture configFixture)
    {
        _output = output;
        
        // æµ‹è¯•æ•°æ®ç›®å½•ï¼šAstrumTest.Shared/Data/Scenarios/
        _dataDirectory = Path.Combine(
            AppContext.BaseDirectory,
            "Data", "Scenarios"
        );
    }
    
    /// <summary>
    /// è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ˆå®Œæ•´å›ºå®šæµç¨‹ï¼‰
    /// ç”¨æˆ·åªä¼ æ–‡ä»¶åï¼Œå¼•æ“è‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤
    /// </summary>
    public TestResult RunTestCase(string jsonFileName)
    {
        _output.WriteLine($"========================================");
        _output.WriteLine($"è¿è¡Œæµ‹è¯•ç”¨ä¾‹: {jsonFileName}");
        _output.WriteLine($"========================================");
        
        try
        {
            // ===== æ­¥éª¤1: è¯»å– JSON ç”¨ä¾‹æ–‡ä»¶ =====
            var testCase = LoadTestCaseFromJson(jsonFileName);
            _output.WriteLine($"[1/7] âœ“ è¯»å–æµ‹è¯•ç”¨ä¾‹: {testCase.Name}");
            
            // ===== æ­¥éª¤2: åˆå§‹åŒ–æ‰€æœ‰ Manager =====
            if (!_isInitialized)
            {
                InitializeManagers();
                _isInitialized = true;
            }
            _output.WriteLine($"[2/7] âœ“ Manager åˆå§‹åŒ–å®Œæˆ");
            
            // ===== æ­¥éª¤3: åˆ›å»º Room + World =====
            CreateRoomAndWorld();
            _output.WriteLine($"[3/7] âœ“ Room + World åˆ›å»ºå®Œæˆ");
            
            // ===== æ­¥éª¤4: é€å¸§æ‰§è¡Œæµ‹è¯•ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰=====
            // æ³¨æ„ï¼šå®ä½“ç°åœ¨é€šè¿‡ CreateEntity è¾“å…¥æŒ‡ä»¤åˆ›å»ºï¼Œä¸å†é¢„å…ˆåˆ›å»º
            var success = ExecuteFrames(testCase.Frames);
            _output.WriteLine($"[4/4] âœ“ æ‰€æœ‰å¸§æ‰§è¡Œå®Œæˆ");
            
            // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
            var result = GenerateReport(testCase, success);
            
            _output.WriteLine($"========================================");
            _output.WriteLine($"{(success ? "âœ… æµ‹è¯•é€šè¿‡" : "âŒ æµ‹è¯•å¤±è´¥")}: {testCase.Name}");
            _output.WriteLine($"========================================");
            
            return result;
        }
        catch (Exception ex)
        {
            _output.WriteLine($"âŒ æµ‹è¯•æ‰§è¡Œå¼‚å¸¸: {ex.Message}");
            _output.WriteLine(ex.StackTrace);
            throw;
        }
    }
    
    // ========== å›ºå®šæµç¨‹å®ç° ==========
    
    /// <summary>
    /// æ­¥éª¤1: è¯»å– JSON ç”¨ä¾‹æ–‡ä»¶
    /// </summary>
    private TestCaseData LoadTestCaseFromJson(string jsonFileName)
    {
        var filePath = Path.Combine(_dataDirectory, jsonFileName);
        
        if (!File.Exists(filePath))
        {
            throw new FileNotFoundException($"æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶ä¸å­˜åœ¨: {filePath}");
        }
        
        var json = File.ReadAllText(filePath);
        var testCase = JsonConvert.DeserializeObject<TestCaseData>(json);
        
        _output.WriteLine($"  æµ‹è¯•ç”¨ä¾‹: {testCase.Name}");
        _output.WriteLine($"  å®ä½“æ¨¡æ¿æ•°é‡: {testCase.EntityTemplates.Count}");
        _output.WriteLine($"  æµ‹è¯•å¸§æ•°: {testCase.Frames.Count}");
        
        // åŠ è½½å®ä½“æ¨¡æ¿åˆ°å­—å…¸
        _entityTemplates.Clear();
        foreach (var template in testCase.EntityTemplates)
        {
            _entityTemplates[template.TemplateId] = template;
            _output.WriteLine($"    æ¨¡æ¿: {template.TemplateId} (RoleId={template.RoleId})");
        }
        
        return testCase;
    }
    
    /// <summary>
    /// æ­¥éª¤2: åˆå§‹åŒ–æ‰€æœ‰ Managerï¼ˆæ¨¡æ‹Ÿæ¸¸æˆå¯åŠ¨ï¼‰
    /// </summary>
    private void InitializeManagers()
    {
        _output.WriteLine("[æµç¨‹1] åˆå§‹åŒ– Managers...");
        
        // åˆå§‹åŒ– ArchetypeManager
        Astrum.LogicCore.Archetypes.ArchetypeManager.Instance.Initialize();
        _output.WriteLine("  âœ“ ArchetypeManager initialized");
        
        // ConfigManager å·²åœ¨ ConfigFixture ä¸­åˆå§‹åŒ–
        _output.WriteLine("  âœ“ ConfigManager already initialized");
        
        // åˆå§‹åŒ– SkillEffectManager
        SkillEffectManager.Instance.ClearQueue();
        SkillEffectManager.Instance.RegisterHandler(1, new DamageEffectHandler());
        SkillEffectManager.Instance.RegisterHandler(2, new HealEffectHandler());
        _output.WriteLine("  âœ“ SkillEffectManager initialized");
        
        // HitManager ä½¿ç”¨å•ä¾‹ï¼Œè‡ªåŠ¨åˆå§‹åŒ–
        _output.WriteLine("  âœ“ HitManager ready");
        
        _output.WriteLine("âœ… æ‰€æœ‰ Manager åˆå§‹åŒ–å®Œæˆ");
    }
    
    /// <summary>
    /// æµç¨‹2: åˆ›å»º Room + Worldï¼ˆæ¨¡æ‹Ÿå•äººæ¨¡å¼åˆ›å»ºï¼‰
    /// </summary>
    private void CreateRoomAndWorld()
    {
        _output.WriteLine("[æµç¨‹2] åˆ›å»º Room + World...");
        
        // åˆ›å»º Roomï¼ˆçœŸå®ç¯å¢ƒï¼‰
        Room = new Room(1, "TestRoom");
        
        // åˆ›å»º Worldï¼ˆçœŸå®ç¯å¢ƒï¼‰
        var world = new World { WorldId = 1, Name = "TestWorld" };
        Room.MainWorld = world;
        
        // åˆå§‹åŒ– Roomï¼ˆä¼šåˆ›å»º LSControllerï¼‰
        Room.Initialize();
        
        _output.WriteLine($"  âœ“ Room created: ID={Room.RoomId}, Name={Room.Name}");
        _output.WriteLine($"  âœ“ World created: ID={world.WorldId}, Name={world.Name}");
        _output.WriteLine($"  âœ“ LSController created");
        _output.WriteLine("âœ… Room + World åˆ›å»ºå®Œæˆ");
    }
    
    /// <summary>
    /// æ­¥éª¤5: é€å¸§æ‰§è¡Œæµ‹è¯•ï¼ˆæ ¸å¿ƒæµç¨‹ï¼‰
    /// æ¯ä¸€å¸§ï¼šæ‰§è¡Œè¾“å…¥ â†’ æ›´æ–°é€»è¾‘ â†’ æ‰§è¡ŒæŸ¥è¯¢ â†’ éªŒè¯é¢„æœŸ
    /// </summary>
    private bool ExecuteFrames(List<FrameData> frames)
    {
        _output.WriteLine("========== å¼€å§‹é€å¸§æ‰§è¡Œ ==========");
        
        // å¯åŠ¨å¸§åŒæ­¥
        LSController.Start();
        _output.WriteLine("  âœ“ LSController å·²å¯åŠ¨\n");
        
        int currentFrame = 0;
        bool allSuccess = true;
        
        foreach (var frameData in frames)
        {
            // æ¨è¿›åˆ°ç›®æ ‡å¸§
            while (currentFrame < frameData.FrameNumber)
            {
                UpdateLogicFrame();
                currentFrame++;
            }
            
            _output.WriteLine($"========== Frame {frameData.FrameNumber} ==========");
            _output.WriteLine($"  {frameData.Comment}");
            
            // [1] æ‰§è¡Œè¾“å…¥æŒ‡ä»¤
            if (frameData.Inputs != null && frameData.Inputs.Count > 0)
            {
                _output.WriteLine($"  [è¾“å…¥] æ‰§è¡Œ {frameData.Inputs.Count} ä¸ªè¾“å…¥æŒ‡ä»¤");
                foreach (var input in frameData.Inputs)
                {
                    ExecuteInput(input);
                }
            }
            
            // [2] æ›´æ–°æ¸¸æˆé€»è¾‘ä¸€å¸§
            UpdateLogicFrame();
            currentFrame++;
            
            // [3] æ‰§è¡ŒæŸ¥è¯¢æŒ‡ä»¤
            var queryResults = new Dictionary<string, object>();
            if (frameData.Queries != null && frameData.Queries.Count > 0)
            {
                _output.WriteLine($"  [æŸ¥è¯¢] æ‰§è¡Œ {frameData.Queries.Count} ä¸ªæŸ¥è¯¢æŒ‡ä»¤");
                foreach (var query in frameData.Queries)
                {
                    var result = ExecuteQuery(query);
                    queryResults[query.ResultKey] = result;
                    _output.WriteLine($"    {query.ResultKey} = {result}");
                }
            }
            
            // [4] éªŒè¯é¢„æœŸè¾“å‡º
            if (frameData.ExpectedOutputs != null && frameData.ExpectedOutputs.Count > 0)
            {
                _output.WriteLine($"  [éªŒè¯] éªŒè¯ {frameData.ExpectedOutputs.Count} ä¸ªé¢„æœŸç»“æœ");
                bool frameSuccess = VerifyExpectedOutputs(queryResults, frameData.ExpectedOutputs);
                
                if (!frameSuccess)
                {
                    _output.WriteLine($"  âŒ Frame {frameData.FrameNumber} éªŒè¯å¤±è´¥");
                    allSuccess = false;
                }
                else
                {
                    _output.WriteLine($"  âœ… Frame {frameData.FrameNumber} éªŒè¯é€šè¿‡");
                }
            }
            
            _output.WriteLine();
        }
        
        _output.WriteLine("========== é€å¸§æ‰§è¡Œå®Œæˆ ==========\n");
        
        return allSuccess;
    }
    
    /// <summary>
    /// æ‰§è¡Œè¾“å…¥æŒ‡ä»¤ï¼ˆåŒ…æ‹¬åˆ›å»ºå®ä½“ã€ç©å®¶æ“ä½œã€AIæŒ‡ä»¤ç­‰ï¼‰
    /// </summary>
    private void ExecuteInput(InputCommand input)
    {
        switch (input.Type)
        {
            case "CreateEntity":
                // åˆ›å»ºæ–°å®ä½“
                if (!_entityTemplates.ContainsKey(input.TemplateId))
                {
                    throw new Exception($"å®ä½“æ¨¡æ¿ä¸å­˜åœ¨: {input.TemplateId}");
                }
                
                var template = _entityTemplates[input.TemplateId];
                var entity = EntityFactory.Instance.CreateEntity(template.RoleId, World);
                
                // è®¾ç½®ä½ç½®
                entity.GetComponent<TransComponent>().Position = input.Position.Value;
                
                // è®¾ç½®è‡ªå®šä¹‰è¡€é‡
                if (template.CustomHealth.HasValue)
                {
                    var health = entity.GetComponent<HealthComponent>();
                    health.MaxHealth = template.CustomHealth.Value;
                    health.CurrentHealth = template.CustomHealth.Value;
                }
                
                // æ·»åŠ åˆ° Room
                Room.Players.Add(entity.UniqueId);
                
                // æ³¨å†Œåˆ°ç‰©ç†ä¸–ç•Œ
                HitManager.Instance.RegisterEntity(entity);
                
                // ä¿å­˜åˆ°æ˜ å°„è¡¨
                _entities[input.EntityId] = entity;
                
                _output.WriteLine($"      åˆ›å»ºå®ä½“: {input.EntityId} (æ¨¡æ¿={input.TemplateId}, Pos={input.Position})");
                break;
                
            case "DestroyEntity":
                if (_entities.ContainsKey(input.EntityId))
                {
                    var entityToDestroy = _entities[input.EntityId];
                    Room.Players.Remove(entityToDestroy.UniqueId);
                    HitManager.Instance.UnregisterEntity(entityToDestroy);
                    _entities.Remove(input.EntityId);
                    _output.WriteLine($"      é”€æ¯å®ä½“: {input.EntityId}");
                }
                break;
                
            case "CastSkill":
                if (!_entities.ContainsKey(input.EntityId))
                {
                    throw new Exception($"å®ä½“ä¸å­˜åœ¨: {input.EntityId}");
                }
                
                var caster = _entities[input.EntityId];
                var actionComp = caster.GetComponent<ActionComponent>();
                actionComp.CurrentAction = SkillConfigManager.Instance
                    .CreateSkillActionInstance(input.SkillId.Value, 1);
                actionComp.CurrentFrame = 0;
                _output.WriteLine($"      {input.EntityId} æ–½æ”¾æŠ€èƒ½ {input.SkillId} â†’ {input.TargetId}");
                break;
                
            case "Move":
                if (!_entities.ContainsKey(input.EntityId))
                {
                    throw new Exception($"å®ä½“ä¸å­˜åœ¨: {input.EntityId}");
                }
                
                var mover = _entities[input.EntityId];
                mover.GetComponent<TransComponent>().Position = input.TargetPosition.Value;
                _output.WriteLine($"      {input.EntityId} ç§»åŠ¨åˆ° {input.TargetPosition}");
                break;
                
            case "Teleport":
                if (!_entities.ContainsKey(input.EntityId))
                {
                    throw new Exception($"å®ä½“ä¸å­˜åœ¨: {input.EntityId}");
                }
                
                var teleporter = _entities[input.EntityId];
                teleporter.GetComponent<TransComponent>().Position = input.TargetPosition.Value;
                _output.WriteLine($"      {input.EntityId} ä¼ é€åˆ° {input.TargetPosition}");
                break;
                
            case "Wait":
                _output.WriteLine($"      ç­‰å¾…");
                break;
        }
    }
    
    /// <summary>
    /// æ‰§è¡ŒæŸ¥è¯¢æŒ‡ä»¤ï¼ˆæŸ¥è¯¢å®ä½“çŠ¶æ€ï¼‰
    /// </summary>
    private object ExecuteQuery(QueryCommand query)
    {
        if (!_entities.ContainsKey(query.EntityId))
        {
            throw new Exception($"æŸ¥è¯¢çš„å®ä½“ä¸å­˜åœ¨: {query.EntityId}");
        }
        
        var entity = _entities[query.EntityId];
        
        switch (query.Type)
        {
            case "EntityHealth":
                return entity.GetComponent<HealthComponent>().CurrentHealth;
                
            case "EntityPosition":
                var pos = entity.GetComponent<TransComponent>().Position;
                return new { x = (float)pos.x, y = (float)pos.y, z = (float)pos.z };
                
            case "EntityIsAlive":
                return entity.GetComponent<HealthComponent>().CurrentHealth > 0;
                
            case "EntityAction":
                var actionComp = entity.GetComponent<ActionComponent>();
                return actionComp.CurrentAction != null ? "CastingSkill" : "Idle";
                
            case "EntityDistance":
                if (!string.IsNullOrEmpty(query.TargetId))
                {
                    if (!_entities.ContainsKey(query.TargetId))
                    {
                        throw new Exception($"ç›®æ ‡å®ä½“ä¸å­˜åœ¨: {query.TargetId}");
                    }
                    
                    var targetEntity = _entities[query.TargetId];
                    var pos1 = entity.GetComponent<TransComponent>().Position;
                    var pos2 = targetEntity.GetComponent<TransComponent>().Position;
                    return (float)TSVector.Distance(pos1, pos2);
                }
                return 0f;
                
            default:
                throw new NotImplementedException($"æŸ¥è¯¢ç±»å‹æœªå®ç°: {query.Type}");
        }
    }
    
    /// <summary>
    /// éªŒè¯é¢„æœŸè¾“å‡º
    /// </summary>
    private bool VerifyExpectedOutputs(Dictionary<string, object> queryResults, Dictionary<string, object> expectedOutputs)
    {
        bool allMatch = true;
        
        foreach (var expected in expectedOutputs)
        {
            var key = expected.Key;
            var expectedValue = expected.Value;
            
            if (!queryResults.ContainsKey(key))
            {
                _output.WriteLine($"      âŒ ç¼ºå°‘æŸ¥è¯¢ç»“æœ: {key}");
                allMatch = false;
                continue;
            }
            
            var actualValue = queryResults[key];
            
            // æ”¯æŒèŒƒå›´éªŒè¯ï¼ˆmin/maxï¼‰
            if (expectedValue is Dictionary<string, object> range && range.ContainsKey("min"))
            {
                int actual = Convert.ToInt32(actualValue);
                int min = Convert.ToInt32(range["min"]);
                int max = range.ContainsKey("max") ? Convert.ToInt32(range["max"]) : int.MaxValue;
                
                if (actual < min || actual > max)
                {
                    _output.WriteLine($"      âŒ {key}: æœŸæœ› [{min}, {max}], å®é™… {actual}");
                    allMatch = false;
                }
                else
                {
                    _output.WriteLine($"      âœ“ {key}: {actual} (åœ¨èŒƒå›´å†…)");
                }
            }
            // ç²¾ç¡®åŒ¹é…
            else
            {
                if (!actualValue.Equals(expectedValue))
                {
                    _output.WriteLine($"      âŒ {key}: æœŸæœ› {expectedValue}, å®é™… {actualValue}");
                    allMatch = false;
                }
                else
                {
                    _output.WriteLine($"      âœ“ {key}: {actualValue}");
                }
            }
        }
        
        return allMatch;
    }
    
    /// <summary>
    /// æ—§æ–¹æ³•ï¼ˆåºŸå¼ƒï¼Œä¿ç•™ç”¨äºå‚è€ƒï¼‰
    /// </summary>
    private void OldExecuteLogicSequence()
    {
        // foreach (var action in sequence)
        // {
            // ç­‰å¾…åˆ°æŒ‡å®šå¸§
            while (LSController.PredictionFrame < action.Frame)
            {
                UpdateLogicFrame();
            }
            
            _output.WriteLine($"  Frame {action.Frame}: {action.Comment}");
            
            // æ‰§è¡ŒåŠ¨ä½œï¼ˆä½¿ç”¨çœŸå®çš„ Entityï¼‰
            var entity = _entities[action.EntityIndex];
            ExecuteAction(entity, action);
            
            // æ›´æ–°å‡ å¸§è®©åŠ¨ä½œç”Ÿæ•ˆ
            UpdateLogicFrames(10);
        }
        
        _output.WriteLine("âœ… é€»è¾‘åºåˆ—æ‰§è¡Œå®Œæˆ");
    }
    
    /// <summary>
    /// æ‰§è¡Œå•ä¸ªåŠ¨ä½œï¼ˆçœŸå®çš„æ¸¸æˆé€»è¾‘ï¼‰
    /// </summary>
    private void ExecuteAction(Entity entity, LogicAction action)
    {
        switch (action.Action)
        {
            case "CastSkill":
                var actionComp = entity.GetComponent<ActionComponent>();
                actionComp.CurrentAction = SkillConfigManager.Instance
                    .CreateSkillActionInstance(action.ActionId, 1);
                actionComp.CurrentFrame = 0;
                
                // è§¦å‘æŠ€èƒ½æ‰§è¡Œå™¨
                for (int frame = 0; frame < 20; frame++)
                {
                    actionComp.CurrentFrame = frame;
                    var executor = entity.Capabilities.Find(c => c is SkillExecutorCapability) as SkillExecutorCapability;
                    executor?.Tick();
                    UpdateLogicFrame();
                }
                break;
                
            case "Move":
                entity.GetComponent<TransComponent>().Position = action.TargetPosition;
                break;
        }
    }
    
    /// <summary>
    /// æµç¨‹6: æ”¶é›†æµ‹è¯•ç»“æœ
    /// </summary>
    private TestResult CollectResult(TestCaseData testCase)
    {
        _output.WriteLine("[æµç¨‹6] æ”¶é›†æµ‹è¯•ç»“æœ...");
        
        var result = new TestResult
        {
            TestCaseName = testCase.Name,
            Entities = _entities,
            FinalFrame = LSController.PredictionFrame
        };
        
        // æ”¶é›†æ‰€æœ‰å®ä½“çš„æœ€ç»ˆçŠ¶æ€
        foreach (var entity in _entities)
        {
            var health = entity.GetComponent<HealthComponent>();
            result.EntityStates.Add(new EntityState
            {
                Entity = entity,
                FinalHealth = health.CurrentHealth,
                Position = entity.GetComponent<TransComponent>().Position
            });
            
            _output.WriteLine($"  Entity {entity.UniqueId}: HP={health.CurrentHealth}, Pos={entity.GetComponent<TransComponent>().Position}");
        }
        
        _output.WriteLine("âœ… ç»“æœæ”¶é›†å®Œæˆ");
        
        return result;
    }
    
    // ========== è¾…åŠ©æ–¹æ³• ==========
    
    /// <summary>
    /// æ›´æ–°å•å¸§é€»è¾‘ï¼ˆæ¨¡æ‹Ÿå•äººæ¨¡å¼ Updateï¼‰
    /// </summary>
    private void UpdateLogicFrame()
    {
        // æ¨¡æ‹Ÿå•äººæ¨¡å¼ï¼šAuthorityFrame = PredictionFrame
        if (LSController != null && LSController.IsRunning)
        {
            LSController.AuthorityFrame = LSController.PredictionFrame;
        }
        
        // Room.Update() â†’ LSController.Tick() â†’ World.Update()
        Room.Update(0.016f);  // 60FPS
    }
    
    /// <summary>
    /// æ›´æ–°å¤šå¸§
    /// </summary>
    private void UpdateLogicFrames(int count)
    {
        for (int i = 0; i < count; i++)
        {
            UpdateLogicFrame();
        }
    }
    
    public void Dispose()
    {
        SkillEffectManager.Instance?.ClearQueue();
        _entities.Clear();
        _output.WriteLine("âœ… æµ‹è¯•æ‰§è¡Œå¼•æ“å·²æ¸…ç†");
    }
}
```

##### LogicTestFixture.csï¼ˆç®€åŒ–ç‰ˆï¼‰

```csharp
/// <summary>
/// é€»è¾‘æµ‹è¯• Fixture - æä¾›çœŸå®çš„æ¸¸æˆé€»è¾‘ç¯å¢ƒ
/// å®Œå…¨æ¨¡æ‹Ÿå•äººæ¨¡å¼çš„ Room + World + LSController
/// </summary>
public class LogicTestFixture : IDisposable
{
    public Room Room { get; private set; }
    public World World => Room.MainWorld;
    public LSController LSController => Room.LSController;
    public ITestOutputHelper Output { get; }
    
    public LogicTestFixture(ITestOutputHelper output, ConfigFixture configFixture)
    {
        Output = output;
        InitializeLogicEnvironment();
    }
    
    /// <summary>
    /// åˆå§‹åŒ–é€»è¾‘ç¯å¢ƒï¼ˆæ¨¡æ‹Ÿå•äººæ¨¡å¼å¯åŠ¨ï¼‰
    /// </summary>
    private void InitializeLogicEnvironment()
    {
        // 1. åˆå§‹åŒ–å¿…è¦çš„ç®¡ç†å™¨
        Astrum.LogicCore.Archetypes.ArchetypeManager.Instance.Initialize();
        
        // 2. åˆ›å»º Roomï¼ˆçœŸå®ç¯å¢ƒï¼‰
        Room = new Room(1, "TestRoom");
        
        // 3. åˆ›å»º Worldï¼ˆçœŸå®ç¯å¢ƒï¼‰
        var world = new World { WorldId = 1, Name = "TestWorld" };
        Room.MainWorld = world;
        
        // 4. åˆå§‹åŒ– Roomï¼ˆåˆ›å»º LSControllerï¼‰
        Room.Initialize();
        
        // 5. åˆå§‹åŒ–æŠ€èƒ½æ•ˆæœç³»ç»Ÿ
        SkillEffectManager.Instance.ClearQueue();
        RegisterSkillHandlers();
        
        Output.WriteLine("âœ… é€»è¾‘æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ");
    }
    
    private void RegisterSkillHandlers()
    {
        SkillEffectManager.Instance.RegisterHandler(1, new DamageEffectHandler());
        SkillEffectManager.Instance.RegisterHandler(2, new HealEffectHandler());
    }
    
    public void Dispose()
    {
        SkillEffectManager.Instance?.ClearQueue();
        Output.WriteLine("âœ… é€»è¾‘æµ‹è¯•ç¯å¢ƒæ¸…ç†å®Œæˆ");
    }
}

/// <summary>
/// é€»è¾‘æµ‹è¯•é›†åˆå®šä¹‰
/// </summary>
[CollectionDefinition("Logic Test Collection")]
public class LogicTestCollection : ICollectionFixture<ConfigFixture>, ICollectionFixture<LogicTestFixture>
{
}
```

##### LogicFrameDriver.cs

```csharp
/// <summary>
/// é€»è¾‘å¸§é©±åŠ¨å™¨ - æ¨¡æ‹ŸçœŸå®çš„æ¸¸æˆå¸§å¾ªç¯
/// å®Œå…¨å¤åˆ¶å•äººæ¨¡å¼çš„ Update é€»è¾‘
/// </summary>
public static class LogicFrameDriver
{
    /// <summary>
    /// æ›´æ–°é€»è¾‘å¸§ï¼ˆæ¨¡æ‹Ÿ SinglePlayerGameMode.Update + Room.Updateï¼‰
    /// </summary>
    public static void UpdateFrame(Room room, float deltaTime = 0.016f)
    {
        // æ¨¡æ‹Ÿå•äººæ¨¡å¼ï¼šAuthorityFrame = PredictionFrame
        if (room.LSController != null && room.LSController.IsRunning)
        {
            room.LSController.AuthorityFrame = room.LSController.PredictionFrame;
        }
        
        // Room.Update() â†’ LSController.Tick() â†’ World.Update()
        room.Update(deltaTime);
    }
    
    /// <summary>
    /// æ›´æ–°å¤šå¸§
    /// </summary>
    public static void UpdateFrames(Room room, int frameCount)
    {
        for (int i = 0; i < frameCount; i++)
        {
            UpdateFrame(room);
        }
    }
    
    /// <summary>
    /// æ¨¡æ‹Ÿç©å®¶è¾“å…¥ï¼ˆé€šè¿‡ Room.FrameTickï¼‰
    /// </summary>
    public static void SimulateInput(Room room, long playerId, LSInput input)
    {
        var frameInputs = new OneFrameInputs
        {
            Frame = room.LSController.PredictionFrame,
            Inputs = new Dictionary<long, LSInput>
            {
                { playerId, input }
            }
        };
        
        room.FrameTick(frameInputs);
    }
}
```

##### DataLoader.cs

```csharp
/// <summary>
/// æµ‹è¯•æ•°æ®åŠ è½½å™¨ - ä» JSON åŠ è½½æµ‹è¯•åœºæ™¯
/// </summary>
public static class DataLoader
{
    /// <summary>
    /// åŠ è½½æµ‹è¯•åœºæ™¯é…ç½®
    /// </summary>
    public static ScenarioData LoadScenario(string scenarioName)
    {
        var path = Path.Combine(
            AppContext.BaseDirectory,
            "Data", "Scenarios", $"{scenarioName}.json"
        );
        
        var json = File.ReadAllText(path);
        return JsonConvert.DeserializeObject<ScenarioData>(json);
    }
    
    /// <summary>
    /// ä»åœºæ™¯æ•°æ®åˆ›å»ºå®ä½“ï¼ˆä½¿ç”¨çœŸå®çš„ EntityFactoryï¼‰
    /// </summary>
    public static List<Entity> CreateEntitiesFromScenario(
        ScenarioData scenario, 
        World world,
        ITestOutputHelper output)
    {
        var entities = new List<Entity>();
        
        foreach (var entityConfig in scenario.Entities)
        {
            // ä½¿ç”¨çœŸå®çš„ EntityFactory
            var entity = EntityFactory.Instance.CreateEntity(entityConfig.RoleId, world);
            
            // è®¾ç½®çœŸå®çš„ç»„ä»¶
            entity.GetComponent<TransComponent>().Position = entityConfig.Position;
            
            // å¦‚æœæœ‰è‡ªå®šä¹‰è¡€é‡
            if (entityConfig.CustomHealth.HasValue)
            {
                var health = entity.GetComponent<HealthComponent>();
                health.MaxHealth = entityConfig.CustomHealth.Value;
                health.CurrentHealth = entityConfig.CustomHealth.Value;
            }
            
            // æ³¨å†Œåˆ°çœŸå®çš„ç‰©ç†ç®¡ç†å™¨
            HitManager.Instance.RegisterEntity(entity);
            
            entities.Add(entity);
            
            output.WriteLine($"åˆ›å»ºå®ä½“: RoleId={entityConfig.RoleId}, Pos={entityConfig.Position}");
        }
        
        return entities;
    }
}
```

##### Assertions/EntityAssert.cs

```csharp
/// <summary>
/// å®ä½“æ–­è¨€å·¥å…· - æ¥å—çœŸå®çš„ Entity å¯¹è±¡
/// </summary>
public static class EntityAssert
{
    /// <summary>
    /// æ–­è¨€å®ä½“è¡€é‡å‡å°‘
    /// </summary>
    public static void HealthDecreased(Entity entity, int initialHealth, int minDamage = 1)
    {
        var currentHealth = entity.GetComponent<HealthComponent>().CurrentHealth;
        var damageTaken = initialHealth - currentHealth;
        
        Assert.True(
            damageTaken >= minDamage,
            $"å®ä½“ {entity.UniqueId} åº”è¯¥å—åˆ°è‡³å°‘ {minDamage} ç‚¹ä¼¤å®³ï¼Œå®é™…: {damageTaken}"
        );
    }
    
    /// <summary>
    /// æ–­è¨€å®ä½“æ­»äº¡
    /// </summary>
    public static void IsDead(Entity entity)
    {
        var health = entity.GetComponent<HealthComponent>().CurrentHealth;
        Assert.True(health <= 0, $"å®ä½“ {entity.UniqueId} åº”è¯¥å·²æ­»äº¡ï¼Œå½“å‰è¡€é‡: {health}");
    }
    
    /// <summary>
    /// æ–­è¨€å®ä½“å­˜æ´»
    /// </summary>
    public static void IsAlive(Entity entity)
    {
        var health = entity.GetComponent<HealthComponent>().CurrentHealth;
        Assert.True(health > 0, $"å®ä½“ {entity.UniqueId} åº”è¯¥å­˜æ´»ï¼Œå½“å‰è¡€é‡: {health}");
    }
    
    /// <summary>
    /// æ–­è¨€å®ä½“åœ¨èŒƒå›´å†…
    /// </summary>
    public static void InRange(Entity entity, TSVector center, FP radius)
    {
        var pos = entity.GetComponent<TransComponent>().Position;
        var distance = TSVector.Distance(pos, center);
        
        Assert.True(
            distance <= radius,
            $"å®ä½“ {entity.UniqueId} åº”è¯¥åœ¨ {center} çš„ {radius} èŒƒå›´å†…ï¼Œå®é™…è·ç¦»: {distance}"
        );
    }
}
```

---

## å››ã€ç›®å½•ç»“æ„

### 4.1 å®Œæ•´ç›®å½•ç»“æ„

```plaintext
AstrumTest.Shared/
â”‚
â”œâ”€â”€ Unit/                          # å•å…ƒæµ‹è¯• + ç»„ä»¶æµ‹è¯•
â”‚   â”œâ”€â”€ Physics/
â”‚   â”‚   â”œâ”€â”€ TypeConverterTests.cs         [TestLevel=Unit]
â”‚   â”‚   â””â”€â”€ HitManagerTests.cs            [TestLevel=Component]
â”‚   â”œâ”€â”€ Serialization/
â”‚   â”‚   â””â”€â”€ ProtocolSerializationTests.cs [TestLevel=Unit]
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ Integration/                   # é›†æˆæµ‹è¯•
â”‚   â”‚
â”‚   â”œâ”€â”€ Core/                     # å±‚æ¬¡1: æ ¸å¿ƒæµ‹è¯•å¼•æ“ï¼ˆé€šç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ LogicTestFixture.cs           # é€»è¾‘æµ‹è¯• Fixture
â”‚   â”‚   â”œâ”€â”€ LogicFrameDriver.cs           # å¸§é©±åŠ¨å™¨ï¼ˆé€šç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ DataLoader.cs                 # æ•°æ®åŠ è½½å™¨ï¼ˆé€šç”¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ LogicRecorder.cs              # é€»è¾‘è®°å½•å™¨ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â””â”€â”€ Assertions/                   # æ–­è¨€å·¥å…·ï¼ˆé€šç”¨ï¼‰
â”‚   â”‚       â”œâ”€â”€ EntityAssert.cs
â”‚   â”‚       â”œâ”€â”€ ComponentAssert.cs
â”‚   â”‚       â”œâ”€â”€ SkillAssert.cs
â”‚   â”‚       â”œâ”€â”€ PhysicsAssert.cs
â”‚   â”‚       â””â”€â”€ WorldAssert.cs
â”‚   â”‚
â”‚   â”œâ”€â”€ Cases/                    # å±‚æ¬¡2: æµ‹è¯•ç”¨ä¾‹ï¼ˆå…·ä½“åœºæ™¯ï¼‰
â”‚   â”‚   â”œâ”€â”€ CombatLogicTests.cs           # æˆ˜æ–—é€»è¾‘æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ MovementLogicTests.cs         # ç§»åŠ¨é€»è¾‘æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ SkillSystemFlowTests.cs       # æŠ€èƒ½ç³»ç»Ÿæµç¨‹æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ PhysicsInteractionTests.cs    # ç‰©ç†äº¤äº’æµ‹è¯•
â”‚   â”‚   â””â”€â”€ MultiEntityTests.cs           # å¤šå®ä½“äº¤äº’æµ‹è¯•
â”‚   â”‚
â”‚   â””â”€â”€ Data/                     # å±‚æ¬¡3: æµ‹è¯•æ•°æ®
â”‚       â”œâ”€â”€ Scenarios/            # åœºæ™¯é…ç½®
â”‚       â”‚   â”œâ”€â”€ TwoKnightsFight.json
â”‚       â”‚   â”œâ”€â”€ MageVsArcher.json
â”‚       â”‚   â””â”€â”€ MultiPlayerBattle.json
â”‚       â”œâ”€â”€ Inputs/               # è¾“å…¥åºåˆ—
â”‚       â”‚   â”œâ”€â”€ BasicAttackSequence.json
â”‚       â”‚   â””â”€â”€ SkillComboSequence.json
â”‚       â””â”€â”€ Expected/             # é¢„æœŸç»“æœ
â”‚           â”œâ”€â”€ TwoKnightsFight_Expected.json
â”‚           â””â”€â”€ SkillCombo_Expected.json
â”‚
â””â”€â”€ Fixtures/
    â”œâ”€â”€ ConfigFixture.cs          # é…ç½® Fixture
    â””â”€â”€ SharedTestScenario.cs     # å…±äº«æµ‹è¯•åœºæ™¯ï¼ˆå•å…ƒ/ç»„ä»¶æµ‹è¯•ç”¨ï¼‰
```

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 ä½¿ç”¨æµ‹è¯•æ‰§è¡Œå¼•æ“ï¼ˆæ•°æ®é©±åŠ¨ï¼‰

**æ ¸å¿ƒä¼˜åŠ¿ï¼šç”¨æˆ·åªä¼  JSON æ–‡ä»¶åï¼Œå®Œå…¨ä¸å†™åˆå§‹åŒ–ä»£ç **

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
[Trait("Module", "Combat")]
public class CombatLogicTests
{
    private readonly ITestOutputHelper _output;
    private readonly ConfigFixture _configFixture;
    
    public CombatLogicTests(ITestOutputHelper output, ConfigFixture configFixture)
    {
        _output = output;
        _configFixture = configFixture;
    }
    
    [Theory]
    [InlineData("TwoKnightsFight.json")]
    [InlineData("KnightVsMage.json")]
    [InlineData("MultiTargetSkill.json")]
    public void RunCombatScenario(string scenarioFile)
    {
        // åˆ›å»ºæ‰§è¡Œå¼•æ“
        using var executor = new LogicTestExecutor(_output, _configFixture);
        
        // æ ¸å¿ƒæµç¨‹è‡ªåŠ¨å®Œæˆï¼šè¯»å– â†’ åˆå§‹åŒ– â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ æŠ¥å‘Š
        var result = executor.RunTestCase(scenarioFile);
        
        // ç»“æœå·²è‡ªåŠ¨éªŒè¯ï¼ˆæ ¹æ® JSON ä¸­çš„ ExpectedResultsï¼‰
        Assert.True(result.Success, result.FailureMessage);
    }
    
    [Fact]
    public void TwoKnights_BasicAttack()
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        
        // åªéœ€è¦ä¼ æ–‡ä»¶åï¼
        var result = executor.RunTestCase("TwoKnights_BasicAttack.json");
        
        Assert.True(result.Success);
    }
}
```

**æ‰§è¡Œæµç¨‹è‡ªåŠ¨åŒ–ï¼ˆå®Œå…¨æ•°æ®é©±åŠ¨ï¼‰ï¼š**
```plaintext
executor.RunTestCase("TwoKnightsFight.json") è‡ªåŠ¨æ‰§è¡Œï¼š

========================================
è¿è¡Œæµ‹è¯•ç”¨ä¾‹: TwoKnightsFight.json
========================================
[1/7] âœ“ è¯»å–æµ‹è¯•ç”¨ä¾‹: ä¸¤ä¸ªéª‘å£«æˆ˜æ–—
  æµ‹è¯•ç”¨ä¾‹: ä¸¤ä¸ªéª‘å£«æˆ˜æ–—
  å®ä½“æ•°é‡: 2
  é€»è¾‘æ­¥éª¤: 3
  
[2/7] âœ“ Manager åˆå§‹åŒ–å®Œæˆ
  âœ“ ArchetypeManager initialized
  âœ“ SkillEffectManager initialized
  âœ“ HitManager ready
  
[3/7] âœ“ Room + World åˆ›å»ºå®Œæˆ
  âœ“ Room created: ID=1
  âœ“ World created: ID=1
  âœ“ LSController created
  
[4/7] âœ“ åˆ›å»ºäº† 2 ä¸ªå®ä½“
  âœ“ Entity 0: RoleId=1001, HP=500
  âœ“ Entity 1: RoleId=1001, HP=500
  
[5/7] âœ“ é€»è¾‘åºåˆ—æ‰§è¡Œå®Œæˆ
  Frame 10: éª‘å£«1 æ–½æ”¾æŠ€èƒ½ 3001
  Frame 50: ç­‰å¾…æŠ€èƒ½ç»“æŸ
  Frame 60: éªŒè¯ä¼¤å®³
  
[6/7] âœ“ ç»“æœéªŒè¯å®Œæˆ
  âœ“ Entity 1 è¡€é‡å‡å°‘: 500 â†’ 450
  âœ“ Entity 1 å­˜æ´»: true
  
[7/7] âœ“ æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ
========================================
âœ… æµ‹è¯•é€šè¿‡: ä¸¤ä¸ªéª‘å£«æˆ˜æ–—
========================================
```

### 5.2 æ‰¹é‡æµ‹è¯•åœºæ™¯

**ä¸€ä¸ªæµ‹è¯•æ–¹æ³•è¿è¡Œå¤šä¸ªåœºæ™¯**

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
public class IntegrationTests
{
    private readonly ITestOutputHelper _output;
    private readonly ConfigFixture _configFixture;
    
    public IntegrationTests(ITestOutputHelper output, ConfigFixture configFixture)
    {
        _output = output;
        _configFixture = configFixture;
    }
    
    /// <summary>
    /// æˆ˜æ–—åœºæ™¯æµ‹è¯•
    /// </summary>
    [Theory]
    [InlineData("Combat_TwoKnights.json")]
    [InlineData("Combat_MageVsArcher.json")]
    [InlineData("Combat_MultiTarget.json")]
    [InlineData("Combat_AoESkill.json")]
    public void Combat_Scenarios(string scenarioFile)
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        var result = executor.RunTestCase(scenarioFile);
        Assert.True(result.Success, result.FailureMessage);
    }
    
    /// <summary>
    /// ç§»åŠ¨åœºæ™¯æµ‹è¯•
    /// </summary>
    [Theory]
    [InlineData("Movement_BasicMove.json")]
    [InlineData("Movement_Teleport.json")]
    [InlineData("Movement_Dash.json")]
    public void Movement_Scenarios(string scenarioFile)
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        var result = executor.RunTestCase(scenarioFile);
        Assert.True(result.Success);
    }
    
    /// <summary>
    /// ç‰©ç†äº¤äº’æµ‹è¯•
    /// </summary>
    [Theory]
    [InlineData("Physics_Collision.json")]
    [InlineData("Physics_Knockback.json")]
    public void Physics_Scenarios(string scenarioFile)
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        var result = executor.RunTestCase(scenarioFile);
        Assert.True(result.Success);
    }
}
```

**å¯¹æ¯”ï¼šæ ¸å¿ƒæµç¨‹å°è£… vs æ‰‹åŠ¨ç¼–å†™**

```csharp
// âŒ æ—§æ–¹å¼ï¼šç”¨æˆ·å¯ä»¥ç»•è¿‡æ ¸å¿ƒæµç¨‹ï¼Œæ¯æ¬¡éƒ½é‡å†™åˆå§‹åŒ–
[Fact]
public void Test1()
{
    // ç”¨æˆ·è‡ªå·±åˆå§‹åŒ–ï¼ˆ50+ è¡Œé‡å¤ä»£ç ï¼‰
    ArchetypeManager.Instance.Initialize();
    SkillEffectManager.Instance.ClearQueue();
    
    Room room = new Room(1, "Test");
    World world = new World();
    room.MainWorld = world;
    room.Initialize();
    
    var e1 = EntityFactory.Instance.CreateEntity(1001, world);
    e1.GetComponent<TransComponent>().Position = TSVector.zero;
    room.Players.Add(e1.UniqueId);
    HitManager.Instance.RegisterEntity(e1);
    
    room.LSController.Start();
    
    // æ‰§è¡Œæµ‹è¯•é€»è¾‘...
    // éªŒè¯ç»“æœ...
}

[Fact]
public void Test2()
{
    // åˆè¦å†™ä¸€éæ‰€æœ‰åˆå§‹åŒ–ä»£ç ï¼ˆ50+ è¡Œï¼‰ï¼
    ArchetypeManager.Instance.Initialize();
    // ...
}

// âœ… æ–°æ–¹å¼ï¼šæ ¸å¿ƒæµç¨‹å®Œå…¨å°è£…ï¼Œç”¨æˆ·åªä¼ æ–‡ä»¶å
[Fact]
public void Test1()
{
    using var executor = new LogicTestExecutor(_output, _configFixture);
    
    // åªä¼ æ–‡ä»¶åï¼Œæ ¸å¿ƒæµç¨‹è‡ªåŠ¨å®Œæˆï¼š
    // è¯»å–JSON â†’ åˆå§‹åŒ– â†’ åˆ›å»ºå®ä½“ â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ æŠ¥å‘Š
    var result = executor.RunTestCase("Scenario1.json");
    
    Assert.True(result.Success);  // â† 1 è¡Œ
}

[Fact]
public void Test2()
{
    using var executor = new LogicTestExecutor(_output, _configFixture);
    var result = executor.RunTestCase("Scenario2.json");  // â† 1 è¡Œ
    Assert.True(result.Success);  // â† 1 è¡Œ
}

// å¯¹æ¯”ï¼š
// æ—§æ–¹å¼ï¼šæ¯ä¸ªæµ‹è¯• 50+ è¡Œï¼ˆé‡å¤åˆå§‹åŒ–ï¼‰
// æ–°æ–¹å¼ï¼šæ¯ä¸ªæµ‹è¯• 3 è¡Œï¼ˆåªä¼ æ–‡ä»¶åï¼‰
// èŠ‚çœï¼š~95% ä»£ç é‡ï¼Œç”¨æˆ·æ— æ³•ç»•è¿‡æ ¸å¿ƒæµç¨‹
```

---

## å…­ã€æ•°æ®æ ¼å¼å®šä¹‰ï¼ˆä»¥å¸§ä¸ºå•ä½ï¼‰

### 6.1 æ ¸å¿ƒè®¾è®¡æ€æƒ³

**ä»¥å¸§ä¸ºæ ¸å¿ƒå•ä½ç»„ç»‡æµ‹è¯•**
```plaintext
æ¯ä¸€å¸§çš„æ‰§è¡Œæµç¨‹ï¼š
  1. æ‰§è¡Œè¾“å…¥æŒ‡ä»¤ï¼ˆinputsï¼‰      â† ç©å®¶æ“ä½œã€AIæŒ‡ä»¤ç­‰
  2. æ›´æ–°æ¸¸æˆé€»è¾‘ä¸€å¸§            â† Room.Update() / LSController.Tick()
  3. æ‰§è¡ŒæŸ¥è¯¢æŒ‡ä»¤ï¼ˆqueriesï¼‰     â† æŸ¥è¯¢å®ä½“çŠ¶æ€
  4. éªŒè¯é¢„æœŸè¾“å‡ºï¼ˆexpectedOutputsï¼‰â† æ–­è¨€éªŒè¯

ä¼˜åŠ¿ï¼š
  âœ“ é€å¸§éªŒè¯ï¼Œç²¾ç¡®å®šä½é—®é¢˜
  âœ“ å¯ä»¥åœ¨ä»»æ„å¸§è¿›è¡Œæ–­è¨€
  âœ“ è´´è¿‘çœŸå®æ¸¸æˆå¾ªç¯
  âœ“ æ›´ç»†ç²’åº¦çš„æµ‹è¯•æ§åˆ¶
```

### 6.2 åœºæ™¯é…ç½®æ ¼å¼ï¼ˆFrame-Basedï¼‰

```json
// Data/Scenarios/TwoKnightsFight.json
{
  "name": "ä¸¤ä¸ªéª‘å£«å¯¹æˆ˜",
  "description": "æµ‹è¯•åŸºç¡€æˆ˜æ–—é€»è¾‘ - é€å¸§éªŒè¯",
  
  "entityTemplates": [
    {
      "templateId": "knight1",
      "roleId": 1001,
      "team": 1,
      "customHealth": 500
    },
    {
      "templateId": "knight2",
      "roleId": 1001,
      "team": 2,
      "customHealth": 500
    }
  ],
  
  "frames": [
    {
      "frameNumber": 0,
      "comment": "åˆ›å»ºä¸¤ä¸ªéª‘å£«",
      "inputs": [
        {
          "type": "CreateEntity",
          "templateId": "knight1",
          "position": {"x": 0, "y": 0, "z": 0},
          "entityId": "entity_0"
        },
        {
          "type": "CreateEntity",
          "templateId": "knight2",
          "position": {"x": 1.2, "y": 0, "z": 0},
          "entityId": "entity_1"
        }
      ],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "entity_0",
          "resultKey": "knight1_hp"
        },
        {
          "type": "EntityHealth",
          "entityId": "entity_1",
          "resultKey": "knight2_hp"
        }
      ],
      "expectedOutputs": {
        "knight1_hp": 500,
        "knight2_hp": 500
      }
    },
    {
      "frameNumber": 10,
      "comment": "éª‘å£«1å¼€å§‹æ”»å‡»",
      "inputs": [
        {
          "type": "CastSkill",
          "entityId": "entity_0",
          "skillId": 3001,
          "targetId": "entity_1"
        }
      ],
      "queries": [
        {
          "type": "EntityAction",
          "entityId": "entity_0",
          "resultKey": "knight1_action"
        }
      ],
      "expectedOutputs": {
        "knight1_action": "CastingSkill"
      }
    },
    {
      "frameNumber": 30,
      "comment": "æŠ€èƒ½å‘½ä¸­ï¼ŒéªŒè¯ä¼¤å®³",
      "inputs": [],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "entity_1",
          "resultKey": "knight2_hp"
        },
        {
          "type": "EntityIsAlive",
          "entityId": "entity_1",
          "resultKey": "knight2_alive"
        }
      ],
      "expectedOutputs": {
        "knight2_hp": {"min": 400, "max": 470},
        "knight2_alive": true
      }
    },
    {
      "frameNumber": 60,
      "comment": "éª‘å£«2åå‡»",
      "inputs": [
        {
          "type": "CastSkill",
          "entityId": "entity_1",
          "skillId": 3001,
          "targetId": "entity_0"
        }
      ],
      "queries": [
        {
          "type": "EntityAction",
          "entityId": "entity_1",
          "resultKey": "knight2_action"
        }
      ],
      "expectedOutputs": {
        "knight2_action": "CastingSkill"
      }
    },
    {
      "frameNumber": 80,
      "comment": "åå‡»å‘½ä¸­ï¼ŒéªŒè¯åŒæ–¹è¡€é‡",
      "inputs": [],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "entity_0",
          "resultKey": "knight1_hp"
        },
        {
          "type": "EntityHealth",
          "entityId": "entity_1",
          "resultKey": "knight2_hp"
        },
        {
          "type": "EntityIsAlive",
          "entityId": "entity_0",
          "resultKey": "knight1_alive"
        },
        {
          "type": "EntityIsAlive",
          "entityId": "entity_1",
          "resultKey": "knight2_alive"
        }
      ],
      "expectedOutputs": {
        "knight1_hp": {"min": 400, "max": 470},
        "knight2_hp": {"min": 400, "max": 470},
        "knight1_alive": true,
        "knight2_alive": true
      }
    },
    {
      "frameNumber": 100,
      "comment": "è¿è¡Œæ—¶åŠ¨æ€å¬å”¤æ€ªç‰©ï¼ˆæ¼”ç¤ºï¼‰",
      "inputs": [
        {
          "type": "CreateEntity",
          "templateId": "knight1",
          "position": {"x": 5, "y": 0, "z": 0},
          "entityId": "summoned_1"
        }
      ],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "summoned_1",
          "resultKey": "summoned_hp"
        }
      ],
      "expectedOutputs": {
        "summoned_hp": 500
      }
    }
  ]
}
```

### 6.3 æ”¯æŒçš„æŸ¥è¯¢ç±»å‹ï¼ˆQueriesï¼‰

```csharp
// æŸ¥è¯¢ç±»å‹æšä¸¾
public enum QueryType
{
    EntityHealth,       // æŸ¥è¯¢å®ä½“è¡€é‡
    EntityPosition,     // æŸ¥è¯¢å®ä½“ä½ç½®
    EntityIsAlive,      // æŸ¥è¯¢å®ä½“æ˜¯å¦å­˜æ´»
    EntityAction,       // æŸ¥è¯¢å®ä½“å½“å‰åŠ¨ä½œ
    EntityVelocity,     // æŸ¥è¯¢å®ä½“é€Ÿåº¦
    EntityBuffCount,    // æŸ¥è¯¢å®ä½“Buffæ•°é‡
    EntityDistance,     // æŸ¥è¯¢ä¸¤ä¸ªå®ä½“è·ç¦»
    // å¯æ‰©å±•...
}
```

### 6.4 æ”¯æŒçš„è¾“å…¥ç±»å‹ï¼ˆInputsï¼‰

```csharp
// è¾“å…¥ç±»å‹æšä¸¾
public enum InputType
{
    CreateEntity,       // åˆ›å»ºå®ä½“ï¼ˆæ–°å¢ï¼ï¼‰
    DestroyEntity,      // é”€æ¯å®ä½“
    CastSkill,          // é‡Šæ”¾æŠ€èƒ½
    Move,               // ç§»åŠ¨
    Teleport,           // ä¼ é€
    UseItem,            // ä½¿ç”¨ç‰©å“
    Wait,               // ç­‰å¾…ï¼ˆæ— æ“ä½œï¼‰
    // å¯æ‰©å±•...
}
```

**æ ¸å¿ƒæ”¹åŠ¨ï¼šå®ä½“åˆ›å»ºä¹Ÿæ˜¯è¾“å…¥æŒ‡ä»¤**
- ä¸å†åœ¨æµ‹è¯•å¼€å§‹æ—¶é¢„åˆ›å»ºæ‰€æœ‰å®ä½“
- å®ä½“é€šè¿‡ `CreateEntity` è¾“å…¥æŒ‡ä»¤åœ¨æŒ‡å®šå¸§åˆ›å»º
- æ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åˆ›å»ºï¼ˆå¬å”¤ç‰©ã€æ€ªç‰©åˆ·æ–°ç­‰ï¼‰
- æ¯ä¸ªå®ä½“æœ‰å”¯ä¸€çš„ `entityId`ï¼ˆå­—ç¬¦ä¸²æ ‡è¯†ç¬¦ï¼‰

### 6.5 æ•°æ®ç±»å®šä¹‰

```csharp
// Core/TestCaseData.cs
public class TestCaseData
{
    public string Name { get; set; }
    public string Description { get; set; }
    public List<EntityTemplate> EntityTemplates { get; set; }  // â† å®ä½“æ¨¡æ¿å®šä¹‰
    public List<FrameData> Frames { get; set; }                // â† æ ¸å¿ƒï¼šä»¥å¸§ä¸ºå•ä½
}

/// <summary>
/// å®ä½“æ¨¡æ¿ - å®šä¹‰å®ä½“çš„é…ç½®æ¨¡æ¿
/// é€šè¿‡ CreateEntity è¾“å…¥æŒ‡ä»¤åˆ›å»ºå®ä¾‹
/// </summary>
public class EntityTemplate
{
    public string TemplateId { get; set; }  // æ¨¡æ¿IDï¼ˆå¦‚ "knight1", "boss1"ï¼‰
    public int RoleId { get; set; }
    public int Team { get; set; }
    public int? CustomHealth { get; set; }
    // å¯æ‰©å±•å…¶ä»–å±æ€§...
}

/// <summary>
/// å¸§æ•°æ® - æµ‹è¯•çš„æ ¸å¿ƒå•ä½
/// æ¯ä¸€å¸§åŒ…å«ï¼šè¾“å…¥ â†’ æŸ¥è¯¢ â†’ é¢„æœŸè¾“å‡º
/// </summary>
public class FrameData
{
    public int FrameNumber { get; set; }             // å¸§å·
    public string Comment { get; set; }              // æ³¨é‡Šï¼ˆç”¨äºè¯´æ˜è¿™ä¸€å¸§åšä»€ä¹ˆï¼‰
    public List<InputCommand> Inputs { get; set; }   // è¾“å…¥æŒ‡ä»¤ï¼ˆè¿™ä¸€å¸§è¦æ‰§è¡Œçš„æ“ä½œï¼‰
    public List<QueryCommand> Queries { get; set; }  // æŸ¥è¯¢æŒ‡ä»¤ï¼ˆå¸§æ‰§è¡Œå®ŒåæŸ¥è¯¢æ•°æ®ï¼‰
    public Dictionary<string, object> ExpectedOutputs { get; set; }  // é¢„æœŸè¾“å‡ºï¼ˆéªŒè¯ï¼‰
}

/// <summary>
/// è¾“å…¥æŒ‡ä»¤ï¼ˆç©å®¶æ“ä½œã€AIæŒ‡ä»¤ã€å®ä½“åˆ›å»ºç­‰ï¼‰
/// </summary>
public class InputCommand
{
    public string Type { get; set; }  // "CreateEntity", "CastSkill", "Move", etc.
    
    // å®ä½“æ ‡è¯†ï¼ˆå­—ç¬¦ä¸²IDï¼Œå¦‚ "entity_0", "boss_1"ï¼‰
    public string EntityId { get; set; }
    
    // åˆ›å»ºå®ä½“ç›¸å…³
    public string TemplateId { get; set; }  // å¼•ç”¨ EntityTemplate çš„ TemplateId
    public TSVector? Position { get; set; }
    
    // æŠ€èƒ½ç›¸å…³
    public int? SkillId { get; set; }
    public string TargetId { get; set; }  // ç›®æ ‡å®ä½“ID
    
    // ç§»åŠ¨ç›¸å…³
    public TSVector? TargetPosition { get; set; }
    public TSVector? Direction { get; set; }
    
    // ç‰©å“ç›¸å…³
    public int? ItemId { get; set; }
}

/// <summary>
/// æŸ¥è¯¢æŒ‡ä»¤ï¼ˆæŸ¥è¯¢å®ä½“çŠ¶æ€ï¼‰
/// </summary>
public class QueryCommand
{
    public string Type { get; set; }       // "EntityHealth", "EntityPosition", "EntityIsAlive", etc.
    public string EntityId { get; set; }   // æŸ¥è¯¢å“ªä¸ªå®ä½“ï¼ˆå­—ç¬¦ä¸²IDï¼‰
    public string TargetId { get; set; }   // å¯é€‰ï¼šç¬¬äºŒä¸ªå®ä½“ï¼ˆç”¨äºè·ç¦»æŸ¥è¯¢ç­‰ï¼‰
    public string ResultKey { get; set; }  // ç»“æœé”®ï¼ˆç”¨äºåŒ¹é… ExpectedOutputsï¼‰
}
```

---

## ä¸ƒã€æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹

### 7.1 æˆ˜æ–—é€»è¾‘æµ‹è¯•

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
public class CombatLogicTests
{
    private readonly LogicTestFixture _fixture;
    
    [Fact]
    public void Combat_TwoKnights_FullFlow()
    {
        // å®Œå…¨ä½¿ç”¨çœŸå®ç¯å¢ƒ
        Room room = _fixture.Room;
        World world = _fixture.World;
        
        // åˆ›å»ºå®ä½“
        Entity k1 = EntityFactory.Instance.CreateEntity(1001, world);
        Entity k2 = EntityFactory.Instance.CreateEntity(1001, world);
        
        // ... æµ‹è¯•é€»è¾‘
    }
}
```

### 7.2 ç§»åŠ¨é€»è¾‘æµ‹è¯•

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
public class MovementLogicTests
{
    [Fact]
    public void Movement_PathFollowing()
    {
        // æµ‹è¯•ç§»åŠ¨ç³»ç»Ÿ
    }
}
```

### 7.3 æŠ€èƒ½ç³»ç»Ÿæµ‹è¯•

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
public class SkillSystemFlowTests
{
    [Fact]
    public void SkillChain_Execution()
    {
        // æµ‹è¯•æŠ€èƒ½é“¾æ‰§è¡Œ
    }
}
```

---

## å…«ã€æ ¸å¿ƒè®¾è®¡è¦ç‚¹

### 8.1 å›ºå®šæµç¨‹å¼•æ“è®¾è®¡ï¼ˆæ•°æ®é©±åŠ¨ï¼‰

**æ ¸å¿ƒï¼šRunTestCase(jsonFile) - ç”¨æˆ·æ— æ³•ç»•è¿‡**

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LogicTestExecutor.RunTestCase(jsonFile)      â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [1] è¯»å– JSON ç”¨ä¾‹æ–‡ä»¶               â”‚ â”‚ â† å›ºå®šæµç¨‹
â”‚  â”‚  - LoadTestCaseFromJson()            â”‚ â”‚   ç”¨æˆ·åªä¼ æ–‡ä»¶å
â”‚  â”‚  - è§£æ TestCaseData                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [2] åˆå§‹åŒ–æ‰€æœ‰ Manager               â”‚ â”‚ â† å›ºå®šæµç¨‹
â”‚  â”‚  - ArchetypeManager                  â”‚ â”‚   åªæ‰§è¡Œä¸€æ¬¡
â”‚  â”‚  - SkillEffectManager                â”‚ â”‚
â”‚  â”‚  - HitManager                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [3] åˆ›å»º Room + World                â”‚ â”‚ â† å›ºå®šæµç¨‹
â”‚  â”‚  - new Room()                        â”‚ â”‚   æ¯æ¬¡æµ‹è¯•éƒ½æ‰§è¡Œ
â”‚  â”‚  - new World()                       â”‚ â”‚
â”‚  â”‚  - room.Initialize()                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [4] æ ¹æ® JSON åˆ›å»ºå®ä½“               â”‚ â”‚ â† JSON æ•°æ®é©±åŠ¨
â”‚  â”‚  - CreateEntitiesFromJson()          â”‚ â”‚
â”‚  â”‚  - EntityFactory.CreateEntity()      â”‚ â”‚
â”‚  â”‚  - è®¾ç½®ç»„ä»¶ã€æ³¨å†Œç‰©ç†                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [5] æ ¹æ® JSON æ‰§è¡Œé€»è¾‘åºåˆ—           â”‚ â”‚ â† JSON æ•°æ®é©±åŠ¨
â”‚  â”‚  - ExecuteLogicSequenceFromJson()    â”‚ â”‚
â”‚  â”‚  - CastSkill / Move / Wait           â”‚ â”‚
â”‚  â”‚  - å¸§æ›´æ–°                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [6] æ ¹æ® JSON éªŒè¯ç»“æœ               â”‚ â”‚ â† JSON æ•°æ®é©±åŠ¨
â”‚  â”‚  - VerifyResultsFromJson()           â”‚ â”‚
â”‚  â”‚  - è‡ªåŠ¨æ–­è¨€ï¼ˆè¡€é‡ã€ä½ç½®ç­‰ï¼‰          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [7] ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š                     â”‚ â”‚ â† å›ºå®šæµç¨‹
â”‚  â”‚  - GenerateReport()                  â”‚ â”‚
â”‚  â”‚  - Success / Failure                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â†“                                 â”‚
â”‚       è¿”å› TestResult                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·ä»£ç ï¼š
  executor.RunTestCase("Scenario.json");  // â† åªéœ€ 1 è¡Œ
  
å¼•æ“è‡ªåŠ¨å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼Œç”¨æˆ·æ— æ³•è·³è¿‡æˆ–ç»•è¿‡æ ¸å¿ƒæµç¨‹
```

### 8.2 é€šç”¨æ€§ä¿è¯

**æ ¸å¿ƒå¼•æ“åœºæ™¯æ— å…³**
- âœ… `LogicTestExecutor` - å¯æµ‹è¯•ä»»ä½•é€»è¾‘åœºæ™¯
  - æˆ˜æ–—æµ‹è¯• - æä¾›æˆ˜æ–—æ•°æ®
  - ç§»åŠ¨æµ‹è¯• - æä¾›ç§»åŠ¨æ•°æ®
  - AIæµ‹è¯• - æä¾›AIè¡Œä¸ºæ•°æ®
  - ç‰©ç†æµ‹è¯• - æä¾›ç‰©ç†äº¤äº’æ•°æ®

**æµ‹è¯•ç”¨ä¾‹åªæä¾›æ•°æ®**
- å®ä½“é…ç½®ï¼ˆEntityConfigsï¼‰
- é€»è¾‘åºåˆ—ï¼ˆLogicSequenceï¼‰
- é¢„æœŸç»“æœï¼ˆExpectedResultsï¼‰

### 8.3 æ ¸å¿ƒä»·å€¼ï¼šå®Œå…¨æ•°æ®é©±åŠ¨

**ç”¨æˆ·ç»´æŠ¤ JSONï¼Œä¸ç»´æŠ¤æµ‹è¯•ä»£ç **

```plaintext
âŒ ä¼ ç»Ÿæ–¹å¼ï¼ˆç”¨æˆ·å¯ä»¥ç»•è¿‡æ ¸å¿ƒæµç¨‹ï¼‰ï¼š
   æ¯ä¸ªæµ‹è¯•æ–¹æ³•éƒ½è¦å†™ï¼š
   1. åˆå§‹åŒ– 4-5 ä¸ª Manager     (~10è¡Œ)
   2. åˆ›å»º Room + World          (~8è¡Œ)
   3. åˆ›å»º Entity                (~10è¡Œ/å®ä½“)
   4. æ³¨å†Œç‰©ç†ã€è®¾ç½®ç»„ä»¶         (~5è¡Œ/å®ä½“)
   5. å¯åŠ¨ LSController          (~2è¡Œ)
   6. å¸§æ›´æ–°å¾ªç¯                 (~10è¡Œ)
   7. éªŒè¯ç»“æœ                   (~5è¡Œ)
   
   æ€»è®¡ï¼šæ¯ä¸ªæµ‹è¯• 50+ è¡Œä»£ç 
   é—®é¢˜ï¼šç”¨æˆ·å®¹æ˜“è·³è¿‡æŸäº›æ­¥éª¤ï¼Œå¯¼è‡´ä¸ä¸€è‡´
   
âœ… æ•°æ®é©±åŠ¨æ–¹å¼ï¼ˆç”¨æˆ·æ— æ³•ç»•è¿‡æ ¸å¿ƒæµç¨‹ï¼‰ï¼š
   æ¯ä¸ªæµ‹è¯•æ–¹æ³•åªè¦å†™ï¼š
   1. executor.RunTestCase("File.json")   (1è¡Œ)
   2. Assert.True(result.Success)         (1è¡Œ)
   
   æ€»è®¡ï¼šæ¯ä¸ªæµ‹è¯• 2 è¡Œä»£ç 
   
   æµ‹è¯•æ•°æ®åœ¨ JSON æ–‡ä»¶ä¸­ï¼š
   {
     "name": "ä¸¤ä¸ªéª‘å£«æˆ˜æ–—",
     "entities": [...],
     "logicSequence": [...],
     "expectedResults": [...]
   }
   
ä¼˜åŠ¿ï¼š
  - èŠ‚çœ ~96% ä»£ç é‡ï¼ˆ50+ è¡Œ â†’ 2 è¡Œï¼‰
  - ç”¨æˆ·æ— æ³•è·³è¿‡æ ¸å¿ƒæµç¨‹
  - æµ‹è¯•ç”¨ä¾‹ç”± JSON ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤å’Œå¤ç”¨
  - éç¨‹åºå‘˜ä¹Ÿèƒ½ç¼–å†™æµ‹è¯•ç”¨ä¾‹
```

### 8.4 çœŸå®æ€§ä¿è¯

**LogicTestExecutor å†…éƒ¨ 100% ä½¿ç”¨ç”Ÿäº§ä»£ç **

```csharp
// LogicTestExecutor å†…éƒ¨å®ç°ï¼š
Room room = new Room(1, "TestRoom");              // â† çœŸå® Room
World world = new World();                        // â† çœŸå® World
room.MainWorld = world;
room.Initialize();                                // â† çœŸå®åˆå§‹åŒ–

Entity entity = EntityFactory.Instance            // â† çœŸå® EntityFactory
    .CreateEntity(roleId, world);
    
entity.GetComponent<HealthComponent>()            // â† çœŸå® Component

room.Update(0.016f);                              // â† çœŸå®æ¸¸æˆå¾ªç¯
```

### 8.5 å¯æ‰©å±•æ€§

**è½»æ¾æ·»åŠ æ–°æµ‹è¯•åœºæ™¯**

```csharp
// æˆ˜æ–—æµ‹è¯•
[Fact]
public void Combat_Test()
{
    using var executor = new LogicTestExecutor(_output, _configFixture);
    var testCase = new TestCaseData { /* æˆ˜æ–—æ•°æ® */ };
    var result = executor.Execute(testCase);
}

// ç§»åŠ¨æµ‹è¯•ï¼ˆå¤ç”¨åŒä¸€ä¸ªå¼•æ“ï¼‰
[Fact]
public void Movement_Test()
{
    using var executor = new LogicTestExecutor(_output, _configFixture);
    var testCase = new TestCaseData { /* ç§»åŠ¨æ•°æ® */ };
    var result = executor.Execute(testCase);
}

// AIæµ‹è¯•ï¼ˆå¤ç”¨åŒä¸€ä¸ªå¼•æ“ï¼‰
[Fact]
public void AI_Test()
{
    using var executor = new LogicTestExecutor(_output, _configFixture);
    var testCase = new TestCaseData { /* AIæ•°æ® */ };
    var result = executor.Execute(testCase);
}
```

---

## ä¹ã€å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒå¼•æ“ï¼ˆä¼˜å…ˆï¼‰

1. âœ… åˆ›å»º `Integration/Core/LogicTestFixture.cs`
2. âœ… åˆ›å»º `Integration/Core/LogicFrameDriver.cs`
3. âœ… åˆ›å»º `Integration/Core/Assertions/EntityAssert.cs`

### ç¬¬äºŒé˜¶æ®µï¼šç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹

4. âœ… åˆ›å»º `Integration/Cases/CombatLogicTests.cs`
5. âœ… ç¼–å†™ç¬¬ä¸€ä¸ªçœŸå®ç¯å¢ƒæµ‹è¯•

### ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®é©±åŠ¨

6. â­• åˆ›å»º `Integration/Core/DataLoader.cs`
7. â­• å®šä¹‰æ•°æ®æ ¼å¼
8. â­• åˆ›å»ºç¤ºä¾‹æ•°æ®æ–‡ä»¶

### ç¬¬å››é˜¶æ®µï¼šæ‰©å±•

9. â­• æ·»åŠ æ›´å¤šæ–­è¨€å·¥å…·
10. â­• æ·»åŠ  LogicRecorderï¼ˆå¯é€‰ï¼‰
11. â­• æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹

---

## åã€å…³é”®ä¼˜åŠ¿

### 10.1 ä¸å•äººæ¨¡å¼çš„å¯¹åº”å…³ç³»

| å•äººæ¨¡å¼ | é›†æˆæµ‹è¯• | è¯´æ˜ |
|---------|---------|------|
| `SinglePlayerGameMode.CreateRoom()` | `LogicTestFixture.Initialize()` | åˆ›å»º Room + World |
| `Room.Update(deltaTime)` | `LogicFrameDriver.UpdateFrame(room)` | é€»è¾‘æ›´æ–° |
| `Room.AddPlayer()` | `room.Players.Add(entity.UniqueId)` | æ·»åŠ ç©å®¶ |
| `EntityFactory.CreateEntity()` | `EntityFactory.CreateEntity()` | å®Œå…¨ç›¸åŒ |
| `LSController.Start()` | `fixture.LSController.Start()` | å®Œå…¨ç›¸åŒ |

### 10.2 é€šç”¨æ€§

**æ ¸å¿ƒå¼•æ“å¯ä»¥æµ‹è¯•ä»»ä½•é€»è¾‘åœºæ™¯ï¼š**
- âœ… æˆ˜æ–—ç³»ç»Ÿ
- âœ… ç§»åŠ¨ç³»ç»Ÿ
- âœ… AIç³»ç»Ÿ
- âœ… æŠ€èƒ½ç³»ç»Ÿ
- âœ… ç‰©ç†äº¤äº’
- âœ… å¤šç©å®¶ååŒ
- âœ… å¸§åŒæ­¥é€»è¾‘

**åªéœ€è¦ï¼š**
- ä½¿ç”¨ `LogicTestFixture` åˆå§‹åŒ–ç¯å¢ƒ
- ä½¿ç”¨ `LogicFrameDriver` é©±åŠ¨å¸§æ›´æ–°
- ä½¿ç”¨ `Assertions/*` éªŒè¯ç»“æœ

---

## åä¸€ã€ä¸å•å…ƒæµ‹è¯•çš„åŒºåˆ«

| ç»´åº¦ | å•å…ƒ/ç»„ä»¶æµ‹è¯• | é›†æˆæµ‹è¯• |
|------|--------------|----------|
| **èŒƒå›´** | å•ä¸ªç±»/æ¨¡å— | Room + World + æ‰€æœ‰ç³»ç»Ÿ |
| **ç¯å¢ƒ** | æœ€å°åŒ–ä¾èµ– | å®Œæ•´çš„æ¸¸æˆé€»è¾‘ç¯å¢ƒ |
| **ç¤ºä¾‹** | `HitManagerTests` | `CombatLogicTests` |
| **é€Ÿåº¦** | å¿«ï¼ˆ<100msï¼‰ | æ…¢ï¼ˆ>100msï¼‰ |
| **ç›®çš„** | éªŒè¯å•ä¸ªåŠŸèƒ½ | éªŒè¯å®Œæ•´æµç¨‹ |

---

**è®¾è®¡å®Œæˆï¼Œç­‰å¾…å®¡æ‰¹å’Œå®æ–½ï¼** ğŸ“‹

