# 测试隔离解决方案 - 实战指南

## 🔴 核心问题

你遇到的问题非常典型：

```
❌ 问题：测试 A 过时了 → 整个测试项目编译失败 → 无法运行测试 B
```

**为什么会这样？**
- 所有测试文件都在同一个 csproj 中
- 编译时会编译所有 `.cs` 文件
- 一个文件有错误，整个项目就编译失败
- **即使你只想运行一个测试，也必须所有测试都能编译通过**

---

## ✅ 解决方案

我提供 **3 种方案**，从简单到彻底：

---

## 方案 1: 条件编译 + 跳过（最简单）⭐

### 实施方式

对于过时的测试，使用 `#if` 条件编译：

```csharp
#if ENABLE_LEGACY_TESTS  // 默认不编译过时的测试

namespace AstrumTest
{
    [Trait("Category", "Legacy")]
    public class SkillSystemTests_Legacy
    {
        [Fact]
        public void OldTest_WithOutdatedAPI()
        {
            // 使用过时的 API
            var skillActions = skillInfo.SkillActions;  // 这个 API 不存在了
        }
    }
}

#endif
```

### 使用方式

```bash
# 默认情况：过时的测试不会被编译，不影响其他测试
dotnet test

# 需要时启用过时的测试
dotnet build -p:DefineConstants=ENABLE_LEGACY_TESTS
dotnet test -p:DefineConstants=ENABLE_LEGACY_TESTS
```

### 优点
- ✅ 最简单，改动最小
- ✅ 过时测试不影响正常测试
- ✅ 需要时可以重新启用

### 缺点
- ⚠️ 过时测试默认不运行
- ⚠️ 需要记得清理过时代码

---

## 方案 2: 多项目拆分（推荐）⭐⭐⭐

### 项目结构

```
AstrumTest/
├── AstrumTest.Core/              # 核心测试（稳定）
│   ├── AstrumTest.Core.csproj
│   ├── PhysicsTests/
│   │   ├── TypeConverterTests.cs
│   │   └── HitManagerTests.cs
│   └── EntityTests/
│       └── EntitySystemTests.cs
│
├── AstrumTest.Skill/             # 技能测试（独立）
│   ├── AstrumTest.Skill.csproj
│   └── SkillSystemTests.cs       # 即使这个过时了，不影响其他项目
│
├── AstrumTest.Network/           # 网络测试（独立）
│   ├── AstrumTest.Network.csproj
│   └── ProtocolSerializationTests.cs
│
└── AstrumTest.Common/            # 公共基础设施
    ├── AstrumTest.Common.csproj
    ├── ConfigFixture.cs
    └── TestBase.cs
```

### 创建独立项目

```bash
# 在 AstrumTest 目录下

# 创建核心测试项目
dotnet new xunit -n AstrumTest.Core
dotnet add AstrumTest.Core reference ../AstrumProj/AstrumLogic.csproj

# 创建技能测试项目
dotnet new xunit -n AstrumTest.Skill
dotnet add AstrumTest.Skill reference ../AstrumProj/AstrumLogic.csproj

# 创建网络测试项目
dotnet new xunit -n AstrumTest.Network
dotnet add AstrumTest.Network reference ../AstrumProj/AstrumLogic.csproj
```

### 运行方式

```bash
# 只运行物理测试（即使技能测试编译失败也不影响）
dotnet test AstrumTest.Core/AstrumTest.Core.csproj --filter "Module=Physics"

# 只运行技能测试
dotnet test AstrumTest.Skill/AstrumTest.Skill.csproj

# 运行所有能编译通过的测试（失败的项目会被跳过）
dotnet test --no-build || true
```

### 优点
- ✅ **完全隔离** - 一个项目编译失败不影响其他项目
- ✅ **并行开发** - 不同模块的测试可以独立演进
- ✅ **清晰组织** - 按功能领域划分
- ✅ **独立部署** - 可以只运行特定模块的测试

### 缺点
- ⚠️ 需要重新组织文件结构
- ⚠️ 维护多个 csproj

---

## 方案 3: 使用 .bak 备份（当前方案的改进）⭐

### 改进当前的 .bak 方式

当前你已经有很多 `.bak` 文件，我们可以系统化这个方法：

#### 创建管理脚本

**disable-test.ps1** (禁用测试)：

```powershell
param([string]$TestFile)

if (Test-Path $TestFile) {
    $bakFile = "$TestFile.bak"
    Move-Item -Path $TestFile -Destination $bakFile -Force
    Write-Host "已禁用测试: $TestFile -> $bakFile" -ForegroundColor Yellow
}
```

**enable-test.ps1** (启用测试)：

```powershell
param([string]$TestFile)

$bakFile = "$TestFile.bak"
if (Test-Path $bakFile) {
    Move-Item -Path $bakFile -Destination $TestFile -Force
    Write-Host "已启用测试: $bakFile -> $TestFile" -ForegroundColor Green
}
```

#### 使用方式

```powershell
# 禁用过时的测试
.\disable-test.ps1 AstrumTest/AstrumTest/SkillSystemTests.cs

# 现在可以运行其他测试了
dotnet test --filter "Module=Physics"

# 需要时重新启用
.\enable-test.ps1 AstrumTest/AstrumTest/SkillSystemTests.cs
```

### 优点
- ✅ 简单直接
- ✅ 不改变项目结构
- ✅ 临时解决方案

### 缺点
- ⚠️ 需要手动管理 .bak 文件
- ⚠️ 容易忘记重新启用
- ⚠️ Git 中可能会提交 .bak 文件

---

## 🎯 推荐实施路径

### 短期方案（今天就能用）

**使用条件编译隔离过时测试**：

1. 修改 `SkillSystemTests.cs`：
```csharp
// 文件开头添加
#if ENABLE_SKILL_TESTS  // 暂时禁用这个测试文件

// 文件末尾添加
#endif
```

2. 运行其他测试：
```bash
# 物理测试可以正常运行了
dotnet test --filter "Module=Physics"
```

3. 需要时启用：
```bash
dotnet test -p:DefineConstants=ENABLE_SKILL_TESTS
```

### 中期方案（1-2 天实施）

**拆分为多个测试项目**：

我已经为你准备好了完整的脚本和文档，只需要：

1. 创建 3-4 个独立测试项目
2. 移动测试文件到对应项目
3. 更新项目引用

### 长期方案

**建立完善的测试基础设施**：

- 使用 Fixture 隔离状态
- 使用 Trait 分类管理
- 使用 CI/CD 自动运行
- 使用覆盖率监控质量

---

## 💡 立即可用的命令

### 运行物理测试（不受技能测试影响）

如果我们把过时的测试隔离后：

```bash
# 只运行物理相关测试
dotnet test --filter "FullyQualifiedName~PhysicsTests"

# 只运行类型转换测试
dotnet test --filter "FullyQualifiedName~TypeConverterTests"

# 运行单个测试方法
dotnet test --filter "Name=Test_FP_To_Fix64_Basic"
```

### 使用便捷脚本

```powershell
# Windows
cd AstrumTest
.\run-test.ps1 -TestName "TypeConverter"  # 只运行类型转换测试
.\run-test.ps1 -Module Physics            # 只运行物理模块
.\run-test.ps1 -List                      # 查看所有可用测试
```

---

## 🔧 现在帮你修复

我现在可以帮你：

### 选项 A: 禁用过时的测试（快速）
```bash
# 重命名为 .bak，暂时不参与编译
mv SkillSystemTests.cs SkillSystemTests.cs.bak
```

### 选项 B: 修复过时的 API（彻底）
- 查找 SkillInfo 的正确 API
- 更新所有引用
- 让测试重新工作

### 选项 C: 拆分项目（最佳）
- 创建独立的测试项目
- 完全隔离不同模块的测试
- 一劳永逸解决问题

你想选择哪个方案？或者让我全部实施？

