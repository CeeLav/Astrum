<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 6746f37e-a211-4212-a22b-b72eeff110f7 (2025-12-13 08:13Z) -->

# 移动方向与预测纠偏 (2025-12-13 08:13Z)

_**User**_

movecapability 运算移动的时候，不仅要记录位置，还要记录当前移动的方向，注意不是角色朝向，而是移动的方向，这两者需要分开来。然后表现层的预测移动方向要以这个移动方向为蓝本。然后纠偏时再按照逻辑位置进行偏移

---

_**Agent (model gpt-5.2, mode Plan)**_

我先快速在工程里定位 `MoveCapability` 相关实现、以及表现层“预测移动/纠偏”的代码入口，确认现在记录了哪些状态（位置、朝向、速度等），再给出需要新增“移动方向”字段、同步/预测/纠偏链路的改造计划。接下来我会先做全文检索和少量文件阅读（只读）。

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "MoveCapability",
  "path": "d:/Develop/Projects/Astrum",
  "outputMode": "files_with_matches",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "MoveCapability",
    "path": "d:/Develop/Projects/Astrum",
    "outputMode": "files_with_matches",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "files": {
          "files": [
            ".\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            ".\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md"
          ],
          "totalFiles": 2
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "files": {
          "files": [
            "..\\Astrum\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            "..\\Astrum\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md"
          ],
          "totalFiles": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "movecapability",
  "path": "d:/Develop/Projects/Astrum",
  "outputMode": "files_with_matches",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "movecapability",
    "path": "d:/Develop/Projects/Astrum",
    "outputMode": "files_with_matches",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "files": {
          "files": [
            ".\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            ".\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md",
            ".\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityBase.cs",
            ".\\Docs\\05-CoreArchitecture 核心架构\\ECC\\Capability-Optimization-Proposal Capability优化重构方案.md"
          ],
          "totalFiles": 4
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "files": {
          "files": [
            "..\\Astrum\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            "..\\Astrum\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityBase.cs",
            "..\\Astrum\\Docs\\05-CoreArchitecture 核心架构\\ECC\\Capability-Optimization-Proposal Capability优化重构方案.md"
          ],
          "totalFiles": 4
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "Predict.*Move|Prediction.*Move|预测.*移动|纠偏|reconcile|reconciliation",
  "path": "d:/Develop/Projects/Astrum",
  "outputMode": "files_with_matches",
  "caseInsensitive": true
}
```
Result:

```json
{
  "success": {
    "pattern": "Predict.*Move|Prediction.*Move|预测.*移动|纠偏|reconcile|reconciliation",
    "path": "d:/Develop/Projects/Astrum",
    "outputMode": "files_with_matches",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "files": {
          "files": [
            ".\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            ".\\.specstory\\history\\2025-12-13_07-39Z-server-time-calculation-update.md",
            ".\\AstrumProj\\Assets\\Script\\AstrumView\\Components\\PredictedMovementViewComponent.cs",
            ".\\技能位移表现_updated.plan.md",
            ".\\.specstory\\history\\2025-12-12_15-51Z-视图更新逻辑拆分.md",
            ".\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            ".\\AstrumProj\\Assets\\Script\\AstrumView\\Archetypes\\Builtins\\ProjectileViewArchetype.cs",
            ".\\AstrumProj\\Assets\\Script\\AstrumView\\Archetypes\\Builtins\\BaseUnitViewArchetype.cs",
            ".\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md",
            ".\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\LSInputSystem.cs",
            ".\\.specstory\\history\\2025-12-03_10-14Z-性能优化.md",
            ".\\.specstory\\history\\2025-11-23_04-19Z-游戏回放.md",
            ".\\.specstory\\history\\2025-11-16_03-20Z-添加日志以排查移动问题.md",
            ".\\Docs\\02-CombatSystem 战斗系统\\技能系统\\Skill-Effect-Runtime 技能效果运行时.md",
            ".\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition.cs",
            ".\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\PlayableAssetTransition.cs",
            ".\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\ControllerTransition.cs",
            ".\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\ClipTransition.cs",
            ".\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Animancer Lite\\Animancer Lite Editor\\Kybernetik.Animancer.Lite.xml",
            ".\\AstrumProj\\Assets\\Resources\\LogManagerConfig.asset"
          ],
          "totalFiles": 20
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "files": {
          "files": [
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            "..\\Astrum\\.specstory\\history\\2025-12-13_07-39Z-server-time-calculation-update.md",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Components\\PredictedMovementViewComponent.cs",
            "..\\Astrum\\技能位移表现_updated.plan.md",
            "..\\Astrum\\.specstory\\history\\2025-12-12_15-51Z-视图更新逻辑拆分.md",
            "..\\Astrum\\.specstory\\history\\2025-12-12_05-20Z-逻辑即时表现平滑纠偏方案.md",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Archetypes\\Builtins\\ProjectileViewArchetype.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Archetypes\\Builtins\\BaseUnitViewArchetype.cs",
            "..\\Astrum\\.specstory\\history\\2025-12-06_14-24Z-单实体预测回滚与模拟实体.md",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\LSInputSystem.cs",
            "..\\Astrum\\.specstory\\history\\2025-12-03_10-14Z-性能优化.md",
            "..\\Astrum\\.specstory\\history\\2025-11-23_04-19Z-游戏回放.md",
            "..\\Astrum\\.specstory\\history\\2025-11-16_03-20Z-添加日志以排查移动问题.md",
            "..\\Astrum\\Docs\\02-CombatSystem 战斗系统\\技能系统\\Skill-Effect-Runtime 技能效果运行时.md",
            "..\\Astrum\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition.cs",
            "..\\Astrum\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\PlayableAssetTransition.cs",
            "..\\Astrum\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\ControllerTransition.cs",
            "..\\Astrum\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Transitions\\Transition Types\\ClipTransition.cs",
            "..\\Astrum\\AstrumProj\\Packages\\com.kybernetik.animancer\\Runtime\\Utilities\\Animancer Lite\\Animancer Lite Editor\\Kybernetik.Animancer.Lite.xml",
            "..\\Astrum\\AstrumProj\\Assets\\Resources\\LogManagerConfig.asset"
          ],
          "totalFiles": 20
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "Capability",
  "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets",
  "outputMode": "files_with_matches",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "Capability",
    "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets",
    "outputMode": "files_with_matches",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "files": {
          "files": [
            "AstrumProj\\Assets\\Script\\AstrumView\\Components\\AnimationViewComponent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Room.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ActionCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MovementCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\LSUpdater.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\MovementComponent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\KnockbackCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillDisplacementCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\ProjectileComponent.cs",
            "AstrumProj\\Assets\\Script\\Editor\\EntityRuntimeInspector\\EntityRuntimeInspectorWindow.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Factories\\EntityFactory.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Entity.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\World.cs",
            "AstrumProj\\Assets\\Script\\AstrumView\\Core\\EntityView.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\MonsterArchetype.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\CombatArchetype.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Systems\\CapabilitySystem.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\SkillEffectData.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillExecutorCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\BattleStateCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityBase.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\DamageCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ICapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MoveStateCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\IdleStateCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\HitReactionCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumView\\Components\\ViewComponent.cs",
            "AstrumProj\\Assets\\Script\\AstrumView\\Core\\ViewComponentEventRegistry.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\DamageEffectHandler.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\KnockbackEffectHandler.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\DeadCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillCapability.cs",
            "AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-URP Unlit.shadergraph",
            "AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-URP Lit.shadergraph",
            "AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-HDRP UNLIT.shadergraph",
            "AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-HDRP LIT.shadergraph",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\ProjectileSpawnRequestEvent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\KnockbackEvent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\IEvent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\HitReactionEvent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\GlobalEventQueue.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\DamageEvent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Entity.EventQueue.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileSpawnCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityTag.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityState.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\AIFSMCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\ProjectileArchetype.cs"
          ],
          "totalFiles": 50
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "files": {
          "files": [
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Components\\AnimationViewComponent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Room.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ActionCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MovementCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\LSUpdater.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\MovementComponent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\KnockbackCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillDisplacementCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\ProjectileComponent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\Editor\\EntityRuntimeInspector\\EntityRuntimeInspectorWindow.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Factories\\EntityFactory.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Entity.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\World.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Core\\EntityView.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\MonsterArchetype.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\CombatArchetype.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Systems\\CapabilitySystem.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\SkillEffectData.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillExecutorCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\BattleStateCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityBase.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\DamageCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ICapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MoveStateCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\IdleStateCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\HitReactionCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Components\\ViewComponent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumView\\Core\\ViewComponentEventRegistry.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\DamageEffectHandler.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\KnockbackEffectHandler.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\DeadCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-URP Unlit.shadergraph",
            "..\\Astrum\\AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-URP Lit.shadergraph",
            "..\\Astrum\\AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-HDRP UNLIT.shadergraph",
            "..\\Astrum\\AstrumProj\\Assets\\TextMesh Pro\\Shaders\\TMP_SDF-HDRP LIT.shadergraph",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\ProjectileSpawnRequestEvent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\KnockbackEvent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\IEvent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\HitReactionEvent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\GlobalEventQueue.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Events\\DamageEvent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\Entity.EventQueue.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileSpawnCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityTag.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\CapabilityState.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\AIFSMCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Archetypes\\Builtins\\ProjectileArchetype.cs"
          ],
          "totalFiles": 50
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

我已经定位到关键文件：逻辑侧的 `MovementCapability.cs / MovementComponent.cs`、输入与本地模拟的 `ClientLSController.cs / LSInputSystem.cs`，以及表现层预测用的 `PredictedMovementViewComponent.cs`。下一步我会只读打开这些文件，确认目前“方向”是从哪来的（朝向/速度/输入向量），以及纠偏是怎么做的位置偏移。

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/MovementCapability.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Components/MovementComponent.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumView/Components/PredictedMovementViewComponent.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Core/ClientLSController.cs</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering movement capabilities**

I'm thinking about how the client processes view and components for consistent states. It's important to mark items as dirty when changes happen, but currently, MovementCapability only does this when the movement type changes. Maybe I should also mark it when direction or speed changes? For performance reasons, it could be beneficial to store direction and update it when input magnitude exceeds a threshold while ensuring non-zero delta. Additionally, I need to adjust SkillDisplacementCapability and inspect those capabilities related to movement.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/SkillDisplacementCapability.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/KnockbackCapability.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/MoveStateCapability.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "Forward",
  "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic",
  "outputMode": "files_with_matches",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "Forward",
    "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic",
    "outputMode": "files_with_matches",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "files": {
          "files": [
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\TransComponent.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ServerLSController.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillExecutorCapability.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\KnockbackEffectHandler.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\FrameSync\\FrameBuffer.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ReplayLSController.cs",
            "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileSpawnCapability.cs"
          ],
          "totalFiles": 8
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "files": {
          "files": [
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ClientLSController.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\TransComponent.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ServerLSController.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\SkillExecutorCapability.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\SkillSystem\\EffectHandlers\\KnockbackEffectHandler.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\FrameSync\\FrameBuffer.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Core\\ReplayLSController.cs",
            "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\ProjectileSpawnCapability.cs"
          ],
          "totalFiles": 8
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Reviewing movement mechanics**

I'm focusing on how SkillDisplacement and Knockback set the movement type but don't record direction. MovementCapability is relying on input direction for rotation and move delta. I think I should record the actual move direction based on the delta applied or use input direction if there's movement. The requirement states I need the movement direction, so I’ll normalize the delta vector for that. I need to check if the TransComponent has a Forward property derived from rotation.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Components/TransComponent.cs</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Decoupling movement direction**

I'm considering how to adjust the MoveCapability operations so they can record direction in addition to position. Currently, the movement direction isn’t separated from the facing direction, but the requirements indicate they need to be distinct. I think that means I shouldn't update the rotation based on movement input anymore, even though that change would break current behavior. Keeping the separation allows for different behaviors later, so I'll maintain the rotation update for now and store the movement direction separately.
**Integrating movement direction**

The user wants the prediction direction to be based on the movement direction blueprint, while correcting offsets during the reconcile based on the logical position. I think I need to set `_cachedDirLogic` from the `MovementComponent.MoveDirection` when the logic frame is advanced. When it’s frozen, I should keep `_dirVisual` and perform lateral correction. 

For movement, I’ll switch the main direction to use `moveDir`, but blending corrections might still be necessary. Also, the correction should adjust the position to align with the logical position, which I believe it currently does. I’ll add `TSVector MoveDir` to `MovementComponent` for view polling.
**Caching movement data**

I need to address that the view watches only the dirty states of the `MovementComponent`, and sync sets just a boolean value. I’ll add caching and update it in `SyncDataFromComponent` or through polling. I should check how the `MovementComponent` syncs for remote clients, as the logic world is read by the view with no network boundary. 

For remote players, it seems there might just be an authority approach. Plus, I’ll also implement the direction recording in the `PositionHistory` struct for logging when moving, which involves updating the `RecordPosition` method to include direction. However, this change will alter the method signature, potentially impacting call sites.
**Updating movement recording**

I’m planning to update the method to `RecordMovement(frame, position, direction)`, which could be used solely in that context. I should double-check to see where else this might be referenced or needed. It’s important to ensure I’m considering all potential usages to avoid breaking anything. I guess I’ll need to search through the codebase and make sure I cover all the bases before implementing these changes. This way, everything will function smoothly!</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="ripgrep_raw_search">
<details>
<summary>Tool use: **ripgrep_raw_search**</summary>


Parameters:

```json
{
  "pattern": "RecordPosition\\(",
  "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets/Script",
  "outputMode": "content",
  "caseInsensitive": false
}
```
Result:

```json
{
  "success": {
    "pattern": "RecordPosition\\(",
    "path": "d:/Develop/Projects/Astrum/AstrumProj/Assets/Script",
    "outputMode": "content",
    "workspaceResults": {
      "d:\\Develop\\Projects\\Astrum": {
        "content": {
          "matches": [
            {
              "file": "AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MovementCapability.cs",
              "matches": [
                {
                  "lineNumber": 207,
                  "content": "                movementComponent.RecordPosition(currentFrame, transComponent.Position);"
                }
              ]
            },
            {
              "file": "AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\MovementComponent.cs",
              "matches": [
                {
                  "lineNumber": 166,
                  "content": "        public void RecordPosition(int frame, TSVector position)"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      },
      "d:\\Develop\\Projects\\MemoryPack": {
        "content": {
          "matches": [
            {
              "file": "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Capabilities\\MovementCapability.cs",
              "matches": [
                {
                  "lineNumber": 207,
                  "content": "                movementComponent.RecordPosition(currentFrame, transComponent.Position);"
                }
              ]
            },
            {
              "file": "..\\Astrum\\AstrumProj\\Assets\\Script\\AstrumLogic\\Components\\MovementComponent.cs",
              "matches": [
                {
                  "lineNumber": 166,
                  "content": "        public void RecordPosition(int frame, TSVector position)"
                }
              ]
            }
          ],
          "totalLines": 2,
          "totalMatchedLines": 2
        }
      }
    }
  }
}
```
Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="ask_question">
<details>
<summary>Tool use: **ask_question**</summary>


Parameters:

```json
{
  "title": "关于“移动方向”与“朝向”分离的两个关键确认",
  "questions": [
    {
      "id": "keep-rotation",
      "prompt": "MovementCapability 里目前会按输入方向更新 TransComponent.Rotation（导致朝向≈移动方向）。你希望这次改造后：",
      "options": [
        {
          "id": "keep",
          "label": "先保持现状：继续更新 Rotation，但另外新增/同步一个独立的 MoveDirection 供表现层预测使用"
        },
        {
          "id": "split",
          "label": "改为彻底分离：MovementCapability 不再改 Rotation（Rotation 由瞄准/动画/其它系统决定），只更新 MoveDirection"
        }
      ]
    },
    {
      "id": "move-dir-source",
      "prompt": "移动方向 MoveDirection 的来源你希望优先使用：",
      "options": [
        {
          "id": "delta",
          "label": "以“本帧实际位移 delta（逻辑位置变化）”归一化作为 MoveDirection（最贴近真实移动）"
        },
        {
          "id": "input",
          "label": "以“输入向量”归一化作为 MoveDirection（即使被碰撞/卡住也保持输入方向）"
        }
      ]
    }
  ]
}
```
Additional data:

```json
{
  "status": "submitted",
  "currentSelections": {
    "keep-rotation": [
      "keep"
    ],
    "move-dir-source": [
      "input"
    ]
  }
}
```
Result:

```json
{
  "answers": [
    {
      "questionId": "keep-rotation",
      "selectedOptionIds": [
        "keep"
      ]
    },
    {
      "questionId": "move-dir-source",
      "selectedOptionIds": [
        "input"
      ]
    }
  ]
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Refining logic framework**

I realize my current logic frame is stuck while using `_dirVisual` inertia. I need to be careful not to mix it with skill displacement. It’s important to reference key code snippets in my plan. I can call the CreatePlan tool since it’s allowed in plan mode, and I’ll provide a markdown plan with file paths in markdown links. I should mention that the compile step will come later during execution, but keep in mind that the plan tool won't actually execute.</details></think>

---

<tool-use data-tool-type="unknown" data-tool-name="create_plan">
<details>
<summary>Tool use: **create_plan**</summary>


Parameters:

```json
{
  "plan": "## 目标\n- **逻辑层**：移动发生时除了记录位置，还要记录“本次移动的移动方向”（不是朝向），并保持与 &#96;TransComponent.Rotation/Forward&#96; 分离。\n- **表现层**：预测移动方向不再从 &#96;posLogic&#96; 差分或 &#96;trans.Forward&#96; 推导，而是以逻辑侧记录的 &#96;MoveDirection&#96; 为蓝本；纠偏仍基于逻辑位置做偏移（保持现有“横向回轨/不后拉”的策略）。\n\n## 现状定位（已确认）\n- 逻辑移动在 [&#96;AstrumProj/Assets/Script/AstrumLogic/Capabilities/MovementCapability.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/MovementCapability.cs) 内按输入计算 &#96;moveX/moveY&#96;，并会更新 &#96;transComponent.Rotation = LookRotation(inputDirection, up)&#96;。\n- 表现层预测在 [&#96;AstrumProj/Assets/Script/AstrumView/Components/PredictedMovementViewComponent.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumView/Components/PredictedMovementViewComponent.cs) 内，普通移动时 &#96;_cachedDirLogic&#96; 目前来自 &#96;posLogic - _lastPosLogicSeen&#96;，位移太小时 fallback 到 &#96;trans.Forward&#96;。\n- 纠偏当前已是“按逻辑位置做位置偏移/拉回，并在逻辑帧停更时只做横向回轨”。\n\n## 设计决定（来自你的选择）\n- **Rotation 先保持现状**：&#96;MovementCapability&#96; 继续更新 &#96;TransComponent.Rotation&#96;（朝向逻辑不改）。\n- **MoveDirection 来源优先输入**：&#96;MoveDirection&#96; 以“输入向量归一化”作为权威移动方向蓝本（而不是用本帧 delta 位移）。\n\n## 改造点\n### 1) MovementComponent：新增可同步的 MoveDirection\n文件：[&#96;AstrumProj/Assets/Script/AstrumLogic/Components/MovementComponent.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Components/MovementComponent.cs)\n- 新增字段/属性：&#96;TSVector MoveDirection&#96;（水平面方向，&#96;y=0&#96;；零向量表示未知/不更新）。\n- 新增方法：&#96;SetMoveDirection(TSVector dir, int frame)&#96; 或简化为 &#96;SetMoveDirection(TSVector dir)&#96;，内部归一化 + 过滤极小向量。\n- 扩展运行时历史：把 &#96;PositionHistory&#96; 扩为同时记录 &#96;MoveDirection&#96;，并把 &#96;RecordPosition(frame, pos)&#96; 改为 &#96;RecordMovement(frame, pos, dir)&#96;（当前唯一调用点在 MovementCapability）。\n\n### 2) MovementCapability：在移动运算时写入 MoveDirection\n文件：[&#96;AstrumProj/Assets/Script/AstrumLogic/Capabilities/MovementCapability.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/MovementCapability.cs)\n- 在 &#96;inputMagnitude &gt; threshold&#96; 时计算 &#96;inputDirection = (moveX,0,moveY)&#96;，归一化后写入 &#96;movementComponent.MoveDirection&#96;。\n- 当本帧发生实际位移（已有 &#96;deltaX/deltaY&#96; 判断）时：\n  - 继续 &#96;MarkMovedThisFrame()&#96; 维护 &#96;CurrentMovementType/LastMoveFrame&#96;\n  - 调用 &#96;movementComponent.RecordMovement(currentFrame, transComponent.Position, movementComponent.MoveDirection)&#96;\n- 保持现有“Rotation 更新”逻辑不变（只是把移动方向独立存一份）。\n\n### 3) 其它位移能力：补齐 MoveDirection（可选但推荐）\n文件：\n- [&#96;AstrumProj/Assets/Script/AstrumLogic/Capabilities/SkillDisplacementCapability.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/SkillDisplacementCapability.cs)\n- [&#96;AstrumProj/Assets/Script/AstrumLogic/Capabilities/KnockbackCapability.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumLogic/Capabilities/KnockbackCapability.cs)\n\n改动：当它们产生位移时，用 &#96;worldDeltaPosition&#96; / &#96;movement&#96; 归一化后写入 &#96;MovementComponent.MoveDirection&#96;，以便表现层在技能位移/击退时也能拿到一个稳定的移动方向参考（即使当前 skill 分支主要靠 RootMotion）。\n\n### 4) PredictedMovementViewComponent：预测方向改用 MoveDirection 蓝本\n文件：[&#96;AstrumProj/Assets/Script/AstrumView/Components/PredictedMovementViewComponent.cs&#96;](d:/Develop/Projects/Astrum/AstrumProj/Assets/Script/AstrumView/Components/PredictedMovementViewComponent.cs)\n- 新增缓存：&#96;_cachedMoveDirLogic&#96;（或直接复用 &#96;_cachedDirLogic&#96;，但其来源改为 &#96;MovementComponent.MoveDirection&#96;）。\n- 初始化/重置：优先从 &#96;MovementComponent.MoveDirection&#96; 取值；无效再 fallback 到 &#96;trans.Forward&#96;。\n- 普通移动（&#96;HandleNormalMovementWhenLogicAdvanced&#96;）：\n  - 删除/弱化“由 pos delta 推导方向”的逻辑，改成直接用缓存的 &#96;MoveDirection&#96; 作为 &#96;dirMove&#96; 的基底。\n  - 纠偏仍使用 &#96;correction = posLogic - _posVisual&#96; 进行位置偏移/横向回轨（保持现有策略）。\n\n## 验证方式（执行阶段）\n- 在 Unity 中让角色做“后退/侧移/技能位移/击退”等场景，确认：\n  - 表现层预测方向跟随 &#96;MoveDirection&#96;，不会再因为 &#96;Forward&#96; 或 &#96;pos&#96; 噪声导致方向抖动。\n  - 纠偏仍按逻辑位置偏移，且逻辑帧停更时不出现“后拉”。\n- 改动完成后按你项目规则编译对应 Unity 的 &#96;.sln&#96; 获取报错并修复。",
  "name": "separate-move-direction",
  "todos": [
    {
      "content": "在 MovementComponent 增加 MoveDirection，并把 PositionHistory/RecordPosition 扩展为同时记录方向。",
      "status": "pending",
      "id": "add-move-direction-to-movement-component"
    },
    {
      "content": "在 MovementCapability 移动运算时写入 MoveDirection（按输入向量归一化），并在记录历史时带上方向。",
      "status": "pending",
      "id": "write-move-direction-in-movement-capability"
    },
    {
      "content": "在 SkillDisplacement/Knockback 等非输入位移中，同步更新 MoveDirection（按位移 delta 归一化）。",
      "status": "pending",
      "id": "propagate-move-direction-in-other-displacements"
    },
    {
      "content": "在 PredictedMovementViewComponent 用 MoveDirection 作为预测移动方向蓝本，纠偏仍按逻辑位置偏移。",
      "status": "pending",
      "id": "use-move-direction-in-view-prediction"
    }
  ],
  "overview": "在逻辑移动运算时记录“移动方向”(MoveDirection)并与角色朝向(Rotation/Forward)解耦；表现层预测移动方向改用该 MoveDirection 作为蓝本，纠偏仍按逻辑位置偏移。"
}
```
Additional data:

```json
{
  "reviewData": {
    "status": "Requested",
    "selectedOption": "none",
    "isShowingInput": false
  },
  "planUri": "c:\\Users\\Lavender\\.cursor\\plans\\separate-move-direction_46bcf4b1.plan.md",
  "hasOpenedEditor": true
}
```
Result:

```json
{
  "rejected": {}
}
```
Status: **completed**


</details>
</tool-use>

---

_**User**_

Implement the plan as specified, it is attached for your reference. Do NOT edit the plan file itself.

To-do's from the plan have already been created. Do not create them again. Mark them as in_progress as you work, starting with the first one. Don't stop until you have completed all the to-dos.

---

