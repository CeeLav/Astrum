<!--
同步影响报告

- 版本更改: N/A → 1.0.0

- 修改的原则:
  - 新增: 原则一: Unity 帧同步与确定性模拟优先
  - 新增: 原则二: 性能预算与无 GC 帧
  - 新增: 原则三: 模块化架构与纯逻辑核心
  - 新增: 原则四: 可测试性与回归防护
  - 新增: 原则五: 可观测性与调试友好

- 添加的部分:
  - 核心原则(面向 Astrum Unity 客户端)
  - 附加约束与性能标准
  - 开发工作流程与质量门禁
  - 治理

- 删除的部分:
  - 无(首次从模板初始化)

- 模板与命令同步状态:
  - 已检查: .specify/templates/plan-template.md(章程检查段落与当前原则保持一致, 无需修改)
  - 已检查: .specify/templates/spec-template.md(无与章程冲突的约束, 无需修改)
  - 已检查: .specify/templates/tasks-template.md(任务阶段与质量门禁原则对齐, 无需修改)
  - 已检查: .specify/templates/checklist-template.md(泛用检查清单, 无需修改)
  - 已检查: .specify/templates/agent-file-template.md(按计划自动汇总, 无需修改)
  - 已检查: .cursor/commands/speckit.constitution.md(流程描述与当前章程一致)
  - 已检查: .cursor/commands/speckit.plan.md(继续从章程提取门控条件)
  - 已检查: .cursor/commands/speckit.specify.md(无直接依赖章程内容)
  - 已检查: .cursor/commands/speckit.tasks.md(质量相关任务放在完善阶段, 与本章程兼容)

- 运行时文档同步状态:
  - 已检查: README.md(描述项目为确定性回滚+ECC 架构, 与本章程一致, 无需修改)
  - 已检查: QUICK_START.md(聚焦使用和流水线, 不涉及治理, 无需修改)
  - 已检查: Docs/README.md(文档规范与本章程强调的“精简、聚焦、实用”一致)

- 延迟 TODO:
  - 无
-->

# Astrum 项目章程

## 核心原则

### 原则一: Unity 帧同步与确定性模拟优先

- Astrum 的战斗与游戏逻辑必须以确定性帧同步模拟为唯一真实数据源, 渲染层仅作为投影和表现, 不得在渲染层修改权威游戏状态。
- 帧同步模拟必须完全脱离 Unity 非确定性系统(如内置物理、随机数、基于系统时间的逻辑); 所有参与回滚的逻辑必须依赖确定性数学库和受控随机源。
- 任何会影响模拟结果的新特性, 必须在设计阶段明确给出“是否参与回滚”“如何保持确定性”的说明, 且在代码中与 UI/特效层清晰分层。
- 在 Debug/Testing 构建中, 应提供开关以复现同一输入流得到完全一致的战斗结果, 用于快速验证确定性和回滚正确性。

### 原则二: 性能预算与无 GC 帧

- 客户端在目标平台上必须在绝大多数战斗场景中稳定达到 60 FPS, 即 95% 帧内总耗时小于 16ms, 99% 帧内小于 22ms; 所有性能敏感改动均须以此为基准。
- 帧同步模拟与主循环中, 在常规游戏过程内必须视为“无 GC 区域”: 热路径(包括 Update/FixedUpdate/Job 回调)在 10 秒连续运行窗口内的托管堆分配总量应接近 0(仅允许初始化阶段和加载阶段有显式分配)。
- 禁止在帧同步和战斗热路径中使用会产生隐式分配或高开销的模式(例如: LINQ、装箱、字符串拼接、反射、频繁的 new 分配); 必须通过对象池、预分配缓冲区和结构体等方式控制分配。
- 所有性能敏感模块(战斗模拟、网络收发、资源加载、日志)在合并前必须至少通过一次 Unity Profiler/分析工具验证, 并在 PR 或设计文档中记录关键指标和结论。

### 原则三: 模块化架构与纯逻辑核心

- 客户端代码必须遵循“纯逻辑核心 + 适配层 + 表现层”的分层结构: 核心战斗与规则逻辑使用与 Unity 解耦的纯 C#/ECC 模块实现, 通过明确的接口与 MonoBehaviour 适配层交互。
- MonoBehaviour 及 Unity 组件脚本中不得直接编写复杂业务规则或决定性游戏逻辑, 其职责应限制为生命周期桥接、输入收集、视图更新和资源管理调用。
- 新增系统必须明确自身所属层次、对上/下游依赖以及与帧同步模拟的关系; 不允许出现“全局工具类 + 静态状态”式的隐形耦合, 需要通过依赖注入或能力组件进行结构化引用。
- 对核心逻辑层的修改应可以在不依赖 Unity 运行时的前提下, 通过纯 C# 测试或模拟环境进行验证, 以降低调试成本和回归风险。

### 原则四: 可测试性与回归防护

- 所有涉及战斗规则、数值运算或帧同步行为的核心模块, 必须具备可自动化测试的最小用例集, 用于验证确定性、一致性和边界行为; 关键修复必须伴随针对性的回归测试。
- 新增或修改逻辑如会影响多人同步、输入预测或回滚流程, 必须至少提供一组“相同输入序列下多客户端对比”的测试用例(可为集成测试或专用测试工具), 防止隐性发散。
- 测试优先级应以稳定性和核心战斗体验为先: 涉及 Match/房间、同步、战斗循环、序列化/反序列化、配置解析等路径的改动, 视为必须具备测试覆盖的范围。
- 允许对 UI、特效等非确定性表现层采用更轻量的测试策略, 但不得以此为由将核心逻辑下沉到无法被测试和回滚验证的区域。

### 原则五: 可观测性与调试友好

- 对帧同步、战斗回放、网络同步等关键路径, 必须提供结构化日志或可视化调试手段(如录制输入流、状态快照、回放工具), 便于现场复现和问题定位。
- 日志和调试信息必须区分开发/测试与线上环境: 在 Release/生产构建中, 默认关闭高频日志和重型调试开关, 但保留必要的关键信息与快速开关机制。
- 性能与确定性相关的问题排查, 应优先依赖可重复的录制数据与自动化对比工具, 而非人工手动复现; 对用于排查的临时脚本和命令行工具应集中维护并可复用。

## 附加约束与性能标准

- 客户端性能目标:
  - 目标平台为 Windows 10/11 上的主流中端开发机; 在标准战斗场景下, 95% 帧内总耗时小于 16ms, 99% 帧内小于 22ms。
  - 帧同步模拟阶段(输入采集、预测、回滚重放)平均耗时不应超过 6ms, 如有必要突破, 必须在计划与评审中显式记录豁免与权衡。
  - 场景切换与战斗加载应通过异步加载与预热机制控制体验: 常规战斗房间的进入时间应控制在 5 秒内, 超出时需提供加载反馈与优化计划。

- 内存与 GC 约束:
  - 热路径中(战斗进行时), GC 分配需要被严格监控, 默认为“0 分配”目标; 若因算法或第三方库导致不可避免的分配, 必须通过池化或预分配降低为可接受水平, 并在文档中说明原因。
  - 禁止在高频循环中创建临时集合、闭包、字符串或使用装箱, 所有此类构造应迁移到初始化阶段或对象池管理。

- 网络与协议约束(客户端视角):
  - 输入上传频率、打包策略和重传机制必须在设计阶段给出明确上限与带宽预算, 避免对服务器与客户端带宽造成不可控压力。
  - 客户端不得在本地擅自“纠正”权威状态, 所有状态修正应来源于服务器或帧同步模拟结果; UI 层允许插值/预测, 但不得向逻辑层写入。

- 平台与构建配置:
  - Debug/Development 构建用于调试与分析, 允许额外检查与日志; Release 构建必须开启所有合理的性能优化选项, 禁止遗留开发用硬编码开关和大量调试输出。
  - 针对性能与确定性相关的关键选项(如浮点模式、Job 系统配置、脚本后端设置), 必须在项目层面统一约定并记录, 不允许在子模块中任意覆写。

## 开发工作流程与质量门禁

- 规划与设计阶段:
  - 所有影响战斗逻辑、帧同步、资源加载或网络交互的功能, 在使用 Speckit 工作流创建 plan.md 时, 必须在“章程检查”小节明确对本章程中相关原则的满足方式或豁免说明。
  - 当设计明显违反某条原则但有合理业务需求时, 必须在设计文档中记录权衡理由、替代方案和未来回收计划, 否则视为不合规设计。

- 实现与代码审查:
  - 所有合并到主分支的改动, 必须通过基本的静态检查、单元/集成测试(如适用)以及至少一次代码评审; 评审应显式关注确定性、性能和架构分层三方面。
  - 对战斗逻辑、帧同步或资源加载路径的改动, 在合并前必须使用 Profiler 或等效工具验证性能影响, 对明显退化的改动必须在评审中给出接受理由或优化计划。
  - 禁止在未说明的情况下引入全局单例状态、隐式线程共享或不可控的异步行为; 新增此类模式须在设计中标注并获得明确认可。

- 回归与维护:
  - 当出现线上或内测中的战斗不同步、掉线重连异常、性能剧烈波动等问题时, 必须通过录制输入流与状态快照等手段进行复现和根因分析, 并为修复创建对应的回归用例。
  - 对核心系统(战斗、网络、资源加载)应定期进行性能与确定性回归, 在大版本前至少执行一次全链路压力验证, 以确保整体表现符合本章程约定。

## 治理

- 优先级与适用范围:
  - 本章程适用于 Astrum 项目中所有 Unity 客户端代码与相关工具链, 优先级高于一般编码风格指南和个人习惯; 如出现冲突, 以本章程为准。
  - 服务器侧或纯工具项目可参考本章程, 但仅对共享部分(如协议、确定性、性能约束)具有强制力。

- 修改与审批流程:
  - 任何对原则本身含义产生变化或新增/删除原则的修改, 被视为 MAJOR 或 MINOR 级别变更, 必须通过独立 PR 提交, 在说明中列出变更原因、影响范围和版本号调整, 并由至少一名项目维护者确认。
  - 仅涉及措辞优化、拼写修复或对已有规则的非语义性澄清, 视为 PATCH 级别变更, 可与其他文档或小修复合并, 但仍须更新版本号和最后修正日期。

- 版本控制策略:
  - 版本号遵循 语义化版本: 主版本.次版本.补丁(例如 1.0.0)。
  - 主版本(MAJOR): 删除或根本性重写既有原则, 需要团队一致认可并可能要求迁移计划。
  - 次版本(MINOR): 新增原则、章节或对指导进行显著扩展, 需要在发布说明中明确指出新增内容。
  - 补丁版本(PATCH): 不改变语义的文字调整、示例补充或格式修复。

- 合规审查与 Speckit 集成:
  - Speckit 生成的 plan.md 中“章程检查”部分必须引用本章程中与该功能相关的关键约束(如帧同步、性能预算、测试要求), 并给出本次实现如何满足或豁免的简要说明。
  - 在 speckit.tasks 生成的 tasks.md 中, 质量与性能相关任务(如性能验证、回归测试、文档更新)应归入“完善与横切关注点”或具体用户故事内, 以保证可追溯性。
  - 当本章程版本发生 MAJOR 或 MINOR 级别升级时, 后续新建的 plan/spec/tasks 必须以最新版本为依据; 对旧特性是否追溯执行由维护者在具体计划中决定。

**版本**: 1.0.0 | **批准日期**: 2025-11-28 | **最后修正**: 2025-11-28

