# 物理碰撞检测策划案（BEPU v2 查询世界）

**版本**: v1.0  
**创建日期**: 2025-10-10  
**最后更新**: 2025-10-10  
**状态**: 规划阶段  

> 📖 **相关文档**：
> - [技能效果运行时策划案](../Combat-System/技能效果运行时策划案.md) - 技能运行时架构
> - [技能系统策划案](../Combat-System/技能系统策划案.md) - 技能系统三层架构设计
> - [战斗系统策划案](../Combat-System/战斗系统策划案.md) - 战斗系统基础

---

## 📋 目录

1. [系统概述](#系统概述)
2. [架构概览](#架构概览)
3. [坐标与单位规范](#坐标与单位规范)
4. [数据来源与结构](#数据来源与结构)
5. [BEPU 查询世界组成](#bepu-查询世界组成)
6. [查询流程](#查询流程)
7. [过滤与去重策略](#过滤与去重策略)
8. [性能与稳定性](#性能与稳定性)
9. [扩展路线](#扩展路线)
10. [测试与可视化](#测试与可视化)
11. [风险与对策](#风险与对策)
12. [验收标准](#验收标准)

---

## 系统概述

### 1.1 设计目标

基于 BEPU v2 构建"查询型"碰撞判定链路，用于技能命中检测系统。起步版本仅支持 Box Overlap 查询，后续可扩展至 Sphere、Capsule、Sweep、Raycast 等更复杂的检测方式。

### 1.2 设计范围

- **仅做查询**：不进行动力学解算、不计算受力、不模拟刚体运动
- **单实例单线程**：维护一个全局 `Simulation` 实例，单线程运行
- **即时计算**：命中盒随施法者位移变化，在每次触发帧即时计算世界位姿

### 1.3 核心优势

- **查询一致性**：BEPU 提供稳定的广相/窄相算法，结果可预测
- **易于扩展**：后续可无缝添加 Sweep/Raycast 等复杂查询
- **性能可控**：利用 BEPU 加速结构（树），规模增大时性能可控

---

## 架构概览

### 2.1 运行时链路

```
SkillActionCapability（技能动作执行）
    ↓
调用 HitManager 即时查询
    ↓
BEPU Simulation 查询世界
    ↓
返回命中列表
    ↓
SkillEffectManager（效果分发）
```

### 2.2 BEPU 使用方式

维护一个全局复用的 `Simulation` 作为"查询世界"：
- **不步进**：不调用 `Simulation.Timestep`
- **不受力**：所有体均为静态或运动体但不积分
- **仅查询**：承载"可命中目标"和"静态场景"的几何体与加速结构

### 2.3 与现有系统集成

- **HitManager**：负责调用 BEPU 查询接口，封装查询逻辑
- **SkillActionCapability**：在触发帧调用 HitManager，获取命中列表
- **SkillEffectManager**：接收命中结果，分发效果到各 Handler

---

## 坐标与单位规范

### 3.1 单位对齐

- **统一规范**：Unity 1u = BEPU 1m
- **导表要求**：所有尺寸数据在导出时必须遵循此规范

### 3.2 尺寸定义

- **Box**：使用"半尺寸"定义（half extents）
  - 例：Box 长宽高为 (2, 4, 6)，则半尺寸为 (1, 2, 3)
  - 导表侧必须统一此规范，避免全尺寸/半尺寸混淆

### 3.3 姿态计算

- **世界位姿**：命中盒的世界位姿 = 施法者世界变换 ⊗ 命中盒局部偏移/旋转
- **旋转表示**：统一使用四元数，避免欧拉角歧义
- **计算流程**：
  1. 获取施法者世界 Transform（位置 + 旋转）
  2. 应用命中盒局部偏移（相对施法者中心）
  3. 应用命中盒局部旋转（相对施法者朝向）
  4. 得到命中盒在世界坐标系下的完整姿态

---

## 数据来源与结构

### 4.1 导出来源

Unity 碰撞盒（Box/Sphere/Capsule）由编辑器工具导出至表格，包含：
- 局部中心偏移（相对施法者）
- 半尺寸/半径/高度
- 局部旋转（四元数或欧拉角，建议四元数）
- 碰撞层/标记等元数据

### 4.2 运行时数据结构

#### 4.2.1 HitBoxData

```csharp
public enum HitBoxShape { Box = 1, Sphere = 2, Capsule = 3 }
public enum HitQueryMode { Overlap = 0, Sweep = 1, Raycast = 2 }

public struct HitBoxData
{
    public HitBoxShape ShapeType;       // Box / Sphere / Capsule
    public Vector3 LocalOffset;         // 本地偏移（相对施法者）
    public Quaternion LocalRotation;    // 本地旋转

    // 几何参数
    public Vector3 HalfSize;            // Box 半尺寸
    public float Radius;                // Sphere/Capsule 半径
    public float Height;                // Capsule 高度（端到端）

    // 查询模式
    public HitQueryMode QueryMode;      // Overlap / Sweep / Raycast
}
```

#### 4.2.2 CollisionFilter

```csharp
public struct CollisionFilter
{
    public int FactionMask;             // 阵营掩码（位域）
    public int LayerMask;               // 层级掩码（位域）
    public bool FriendlyFire;           // 是否友伤
    public string[] CustomTags;         // 自定义标记（如"可被技能X命中"）
}
```

---

## BEPU 查询世界组成

### 5.1 静态场景

- **用途**：关卡网格或简化碰撞体，用于遮挡/地形相关判定
- **注册方式**：作为 BEPU 静态体注册
- **起步版本**：可选，优先实现目标命中判定

### 5.2 可命中目标

- **注册方式**：每个目标注册为可更新姿态的代理
  - 静态体：位姿可手动更新，但不参与动力学
  - 运动体（不积分）：仅用于查询，不调用积分器
- **同步策略**：由逻辑层在每帧写入最新世界位姿到 BEPU
- **生命周期**：目标生成时注册，销毁时移除

### 5.3 命中盒

- **不注册实体**：命中盒不作为持久体注册到 BEPU
- **临时构造**：在触发帧临时构造几何体，用于一次性查询
- **对象池化**：复用临时几何体对象，降低 GC 压力

---

## 查询流程

### 6.1 Box Overlap 查询（起步版本）

```
1. 触发帧到达（TriggerType.Collision）
   ↓
2. 计算命中盒世界姿态
   - 施法者世界 Transform + HitBoxData 局部偏移/旋转
   ↓
3. 计算命中盒世界 AABB
   - 由 Box 半尺寸与世界旋转计算包围盒
   ↓
4. BEPU 广相查询
   - 在 Simulation 中进行 AABB 重叠查询
   - 得到候选体列表（粗筛）
   ↓
5. BEPU 窄相检测
   - 对每个候选体做 Box vs 目标形状精确检测
   - 计算精确重叠/接触点（可选）
   ↓
6. 应用过滤
   - 阵营/层级/可见性/自定义规则（CollisionFilter）
   ↓
7. 命中去重
   - 按"技能实例+目标 EntityId"缓存
   - 支持"同帧/同段防重复"策略
   ↓
8. 输出命中列表
   - 返回 Entity 列表给 SkillEffectManager
```

### 6.2 查询接口设计

```csharp
public class HitManager
{
    private Simulation _simulation;

    /// <summary>
    /// 即时命中查询（Box Overlap）
    /// </summary>
    public IEnumerable<Entity> QueryHits(Entity caster, HitBoxData boxData, CollisionFilter filter)
    {
        // 1. 计算世界姿态
        var worldPose = CalculateWorldPose(caster, boxData);

        // 2. 广相查询（AABB 重叠）
        var candidates = BroadPhaseQuery(worldPose, boxData);

        // 3. 窄相检测 + 过滤
        var hits = new List<Entity>();
        foreach (var candidate in candidates)
        {
            if (NarrowPhaseTest(worldPose, boxData, candidate) && PassFilter(candidate, filter))
            {
                hits.Add(candidate);
            }
        }

        // 4. 去重
        return DeduplicateHits(caster, hits);
    }
}
```

---

## 过滤与去重策略

### 7.1 过滤规则

#### 7.1.1 阵营/派系过滤

- **同阵营**：可选友伤开关
- **敌对阵营**：默认可命中
- **中立阵营**：根据具体规则配置

#### 7.1.2 层级屏蔽

- **技能层**：技能配置的目标层级掩码
- **目标层**：目标所在的碰撞层
- **匹配规则**：位域运算，`(SkillLayerMask & TargetLayer) != 0`

#### 7.1.3 标记过滤

- **自定义标签**：如"可被技能X命中"、"无敌状态"等
- **优先级**：标记过滤优先级高于阵营/层级

### 7.2 去重策略

#### 7.2.1 技能实例级去重（级别一）

- **范围**：同一技能实例的整个生命周期
- **实现**：技能实例持有 `HashSet<EntityId>`
- **清理**：技能结束时清空

#### 7.2.2 多段技能窗口去重（级别二）

- **范围**：多段技能的特定窗口内
- **实现**：配置"冷却帧"，在冷却期内不重复命中同目标
- **示例**：三连斩技能，每段独立计算命中，但同一段内不重复

---

## 性能与稳定性

### 8.1 性能优化

- **复用 Simulation**：单一实例全局复用，避免重复构建加速结构
- **对象池化**：命中盒临时对象池，避免频繁 GC
- **粗筛优先**：先阵营/空间粗筛，再进行窄相精确测试
- **早期返回**：候选列表应用过滤后，尽早返回结果

### 8.2 稳定性保证

- **固定阈值**：使用固定 epsilon 处理边界重叠，避免抖动
- **稳定排序**：命中结果按 `EntityId` 稳定排序
- **确定性支持**：便于回放与测试一致性（帧同步友好）

### 8.3 性能基准

- **目标规模**：支持 1000 个可命中目标
- **查询预算**：单次查询在帧预算内（具体数值由项目确定）
- **内存占用**：合理的内存占用，避免大量临时分配

---

## 扩展路线

### 9.1 形状扩展

- **Sphere Overlap**：球形范围判定（如爆炸、AOE）
- **Capsule Overlap**：胶囊体判定（如冲刺、突进）
- **统一接口**：抽象形状查询接口，支持多种形状

### 9.2 Sweep/Raycast 支持

- **Sweep（位移打击）**：
  - 用途：高速移动技能、冲刺攻击
  - 实现：起止 Pose 扫掠 → 广相包围体 → 窄相 TOI（Time of Impact）
- **Raycast（射线技能）**：
  - 用途：射线武器、视线判定
  - 实现：射线起点/方向 → 广相树遍历 → 窄相交点计算

### 9.3 地形交互

- **视线判定**：技能是否被障碍物遮挡
- **高度差判定**：目标在高处/低处是否可命中
- **地形影响**：地形类型对技能效果的影响（预留）

---

## 测试与可视化

### 10.1 测试用例

#### 10.1.1 基础命中测试

- 静止目标命中
- 移动目标命中
- 斜角边界命中
- 高速靠近命中

#### 10.1.2 多目标测试

- 多目标重叠
- 目标密集区域
- 边界贴边情况

#### 10.1.3 过滤测试

- 友伤开关正确性
- 不同层级过滤
- 阵营过滤规则

### 10.2 可视化工具

#### 10.2.1 Gizmos 绘制

- **命中盒**：绘制世界坐标下的命中盒（红色线框）
- **候选 AABB**：绘制广相查询的包围盒（黄色线框）
- **最终命中体**：高亮显示命中的目标（绿色填充）

#### 10.2.2 日志记录

记录内容：
- 施法者 Pose（位置 + 旋转）
- 命中盒参数（形状、尺寸、偏移）
- 候选体列表
- 过滤结果
- 最终命中目标列表

### 10.3 回归测试

- **固定随机种子**：保证结果可重复
- **固定执行顺序**：保证多次运行结果一致
- **自动化验证**：编写单元测试，验证查询结果正确性

---

## 风险与对策

### 11.1 导表不一致

**风险**：半尺寸/全尺寸混淆，导致命中范围错误

**对策**：
- 在导出工具加入规范校验
- 提供编辑器预览功能，可视化命中盒
- 在运行时增加断言检查，发现异常数据时报错

### 11.2 坐标轴/旋转不一致

**风险**：Unity 与 BEPU 坐标系不一致，导致旋转错误

**对策**：
- 统一四元数流转，避免欧拉角
- 提供编辑器预览验证工具
- 在导出时增加坐标系转换逻辑（如需要）

### 11.3 大规模目标性能退化

**风险**：目标数量过多时，查询性能下降

**对策**：
- 通过阵营/空间分区先行过滤
- 引入空间分区（如八叉树、网格）进一步优化
- 必要时引入 LOD（Level of Detail）策略

---

## 验收标准

### 12.1 功能验收（起步版）

- **Box Overlap 查询**：可稳定命中正确目标
- **过滤支持**：支持阵营/层级过滤
- **去重支持**：支持技能实例级去重
- **结果一致性**：命中结果与期望用例一致

### 12.2 性能验收

- **目标规模**：支持 1000 个目标
- **查询性能**：单次查询在帧预算内
- **内存占用**：无明显内存泄漏或大量临时分配

### 12.3 可视化验收

- **Gizmos 对齐**：Gizmos 绘制与实际命中一致
- **日志完整**：日志可复现实验步骤
- **编辑器预览**：导表工具可预览命中盒

### 12.4 可扩展性验收

- **接口预留**：已预留 Sphere/Capsule/Sweep/Raycast 扩展点
- **代码结构清晰**：模块划分明确，易于扩展
- **文档完善**：有清晰的扩展指南

---

## 附录

### A.1 BEPU v2 相关资源

- 官方仓库：https://github.com/bepu/bepuphysics2
- 官方文档：https://github.com/bepu/bepuphysics2/blob/master/Documentation/

### A.2 后续迭代计划

- **v1.1**：支持 Sphere/Capsule Overlap
- **v1.2**：支持 Sweep（位移打击）
- **v1.3**：支持 Raycast（射线技能）
- **v2.0**：完整的地形交互与视线判定


