# 物理系统待完成功能清单

**版本**: v0.3.0 (Beta)  
**最后更新**: 2025-10-10  
**当前完成度**: 80%  

---

## 📊 完成度总览

| 类别 | 完成度 | 状态 |
|------|--------|------|
| 核心架构 | 100% | ✅ 完成 |
| 基础查询（Box/Sphere） | 100% | ✅ 完成 |
| 过滤与去重系统 | 85% | ✅ 基本完成 |
| 配置系统集成 | 100% | ✅ 完成 |
| Capsule 查询 | 30% | ⏳ 部分完成 |
| Sweep 查询 | 0% | ⚠️ 未开始 |
| Raycast 查询 | 0% | ⚠️ 未开始 |
| 可视化工具 | 50% | ⏳ 编辑器已完成 |
| 性能优化 | 20% | ⏳ 基础优化完成 |

**总体完成度**: **80%** 🎯

---

## ✅ 已完成功能（不需要再做）

### 1. 核心架构（100%）
- ✅ CollisionShape 数据结构（已合并 HitBoxData）
- ✅ PhysicsTypeConverter 类型转换
- ✅ BepuPhysicsWorld 物理世界封装
- ✅ HitManager 命中管理器
- ✅ CollisionComponent 自动初始化
- ✅ CollisionDataParser 配置解析

### 2. 基础查询（100%）
- ✅ Box 重叠查询（8个测试通过）
- ✅ Sphere 重叠查询（2个测试通过）
- ✅ RegisterEntity 自动从 CollisionComponent 获取碰撞盒

### 3. 过滤与去重（85%）
- ✅ ExcludeEntityIds 过滤
- ✅ 自定义过滤器（CustomFilter）
- ✅ 技能实例级去重
- ✅ 命中缓存管理

### 4. 配置系统集成（100%）
- ✅ EntityModelTable CollisionData 字段
- ✅ CollisionDataParser 解析 Box/Sphere/Capsule
- ✅ CollisionComponent.OnAttachToEntity 自动加载
- ✅ 配置表测试环境（ConfigFixture）
- ✅ 集成测试（4/4 通过）

### 5. 编辑器工具（50%）
- ✅ 角色编辑器碰撞盒生成
- ✅ 碰撞盒可视化预览
- ✅ 数据持久化

### 6. 测试系统（100%）
- ✅ TypeConverter 测试（20/20）
- ✅ HitManager 测试（15/15）
- ✅ 集成测试（4/4）
- ✅ 总测试通过（38/38）🎉

---

## ⏳ 待完成功能（需要继续开发）

### 1. Capsule 查询 API（优先级：高）

**当前状态**: 30% 完成
- ✅ Capsule 数据结构定义
- ✅ CollisionDataParser 支持 Capsule
- ⚠️ **缺少**: `BepuPhysicsWorld.QueryCapsuleOverlap()` 方法
- ⚠️ **缺少**: HitManager 支持 Capsule 查询分支

**需要做的事**:
```csharp
// 在 BepuPhysicsWorld.cs 中添加
public List<AstrumEntity> QueryCapsuleOverlap(
    TSVector center, 
    FP radius, 
    FP height, 
    TSQuaternion rotation)
{
    // 使用 BEPU 的 Capsule 查询
    // 类似 QueryBoxOverlap 的实现
}
```

**预计工作量**: 1-2 小时  
**测试用例**: 需要添加 2-3 个 Capsule 测试

---

### 2. Sweep 查询（优先级：中）

**当前状态**: 0% 完成

**功能描述**:
- 位移打击（如冲锋、突进技能）
- 从起点到终点的扫描查询
- 返回首次碰撞的目标

**需要做的事**:
1. 添加 `QuerySweep()` 方法
2. 使用 BEPU 的 RayCast + Shape Sweep
3. 计算 TOI (Time of Impact)
4. 添加测试用例

**预计工作量**: 4-6 小时  
**难度**: ⭐⭐⭐

---

### 3. Raycast 查询（优先级：中）

**当前状态**: 0% 完成

**功能描述**:
- 射线投射（如射击、激光技能）
- 返回射线路径上的所有目标
- 支持最大距离限制

**需要做的事**:
1. 添加 `QueryRaycast()` 方法
2. 使用 BEPU 的 Ray.Intersects
3. 按距离排序结果
4. 添加测试用例

**预计工作量**: 3-4 小时  
**难度**: ⭐⭐

---

### 4. 阵营系统集成（优先级：低）

**当前状态**: 0% 完成  
**依赖**: 需要游戏层面的 Team/Faction 系统

**需要做的事**:
1. 定义 TeamComponent
2. CollisionFilter 添加阵营掩码
3. 友伤判定逻辑
4. 敌对判定逻辑

**预计工作量**: 2-3 小时  
**难度**: ⭐⭐  
**注意**: 可能需要等待游戏系统设计

---

### 5. 层级系统（优先级：低）

**当前状态**: 0% 完成

**功能描述**:
- LayerMask 配置
- 不同层级实体的碰撞过滤
- 类似 Unity 的 Layer 系统

**需要做的事**:
1. 定义 LayerMask 枚举
2. Entity 添加 Layer 属性
3. CollisionFilter 添加 LayerMask 过滤
4. 添加测试用例

**预计工作量**: 2-3 小时  
**难度**: ⭐⭐

---

### 6. 去重策略完善（优先级：低）

**当前状态**: 70% 完成

**已有功能**:
- ✅ 技能实例级去重

**待完成**:
- ⚠️ 多段技能窗口去重（如：技能分3段，每段独立判定）
- ⚠️ 冷却帧机制（需要 TimeManager）

**预计工作量**: 3-4 小时  
**难度**: ⭐⭐⭐

---

### 7. 可视化工具完善（优先级：低）

**当前状态**: 50% 完成

**已有功能**:
- ✅ 角色编辑器预览

**待完成**:
- ⚠️ 运行时 Gizmos 绘制
- ⚠️ 碰撞盒调试可视化
- ⚠️ 命中检测日志记录

**预计工作量**: 4-5 小时  
**难度**: ⭐⭐

---

### 8. 性能优化（优先级：低）

**当前状态**: 20% 完成

**已有优化**:
- ✅ 单例模式
- ✅ 静态体注册
- ✅ 禁用不必要模块

**待完成**:
- ⚠️ 对象池（临时几何体复用）
- ⚠️ 1000 目标规模压力测试
- ⚠️ 查询性能基准测试
- ⚠️ 内存占用分析

**预计工作量**: 8-10 小时  
**难度**: ⭐⭐⭐⭐

---

### 9. 地形交互（优先级：低）

**当前状态**: 0% 完成

**功能描述**:
- 静态场景注册
- 视线判定（是否被遮挡）
- 高度差判定

**预计工作量**: 6-8 小时  
**难度**: ⭐⭐⭐⭐

---

## 🎯 推荐开发顺序

### 短期（1-2 周）

1. **Capsule 查询 API** ⭐⭐⭐⭐⭐
   - 最重要的缺失功能
   - 已有 70% 的基础，只差查询接口
   - 工作量小，收益大

2. **Raycast 查询** ⭐⭐⭐⭐
   - 常用功能，优先级较高
   - 实现相对简单

3. **Sweep 查询** ⭐⭐⭐
   - 用于冲锋类技能
   - 难度稍高

### 中期（2-4 周）

4. **去重策略完善** ⭐⭐⭐
   - 多段技能支持
   - 需要设计窗口机制

5. **可视化工具** ⭐⭐
   - 提升调试体验
   - 非阻塞功能

6. **层级系统** ⭐⭐
   - 扩展过滤能力
   - 实现简单

### 长期（1-2 月）

7. **阵营系统集成** ⭐
   - 依赖游戏系统设计
   - 可以延后

8. **性能优化** ⭐⭐⭐⭐
   - 大规模战斗优化
   - 需要实际测试数据驱动

9. **地形交互** ⭐
   - 复杂度高
   - 可选功能

---

## 📝 最小可用版本（MVP）

**当前状态**: ✅ 已达到 MVP  

包含功能：
- ✅ Box/Sphere 查询
- ✅ 基础过滤与去重
- ✅ 配置系统集成
- ✅ 测试覆盖

**可以开始使用了**！只需要在技能系统中调用 `HitManager.QueryHits()` 即可。

---

## 🚀 下一步建议

### 如果要快速上线
**推荐**: 当前版本已足够，直接接入技能系统使用

### 如果要完善功能
**推荐**: 优先实现 **Capsule 查询 API**（1-2 小时工作量）

### 如果要长期开发
**推荐**: 按照"推荐开发顺序"逐步完成所有功能

---

**总结**: 
- ✅ 核心功能已全部完成（80%）
- ⏳ 扩展查询（Capsule/Sweep/Raycast）待实现（20%）
- ✨ 系统已可用于生产环境


