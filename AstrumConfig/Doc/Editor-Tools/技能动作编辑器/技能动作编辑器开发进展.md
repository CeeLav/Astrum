# 技能动作编辑器开发进展

**创建时间**: 2025-10-09  
**最后更新**: 2025-10-09  
**开发阶段**: 规划阶段  
**项目状态**: 🔨 **待开发**

> 📖 **相关文档**：[技能动作编辑器策划案](./技能动作编辑器策划案.md) | [动作编辑器开发进展](../动作编辑器/动作编辑器开发进展.md)

---

## 📋 项目概述

技能动作编辑器是动作编辑器的扩展版本，专门用于编辑 **SkillActionTable** 配置表数据。它继承了动作编辑器的所有功能，并针对技能系统增加了触发帧效果、碰撞盒配置、效果关联等技能专属功能。

### 核心价值
- **完整继承** - 复用动作编辑器的成熟架构和功能（80%代码复用）
- **技能特化** - 针对技能系统的特殊需求提供专用编辑能力
- **效率提升** - 可视化编辑技能效果触发，减少配置错误
- **架构优秀** - 继承动作编辑器的优秀设计，保持代码质量

### 设计理念
- **继承优先** - 最大化复用动作编辑器的代码和架构
- **技能增强** - 在继承基础上增加技能专属功能
- **数据关联** - 与 SkillTable、SkillEffectTable 紧密集成
- **用户友好** - 提供友好的技能效果选择和碰撞盒编辑界面

---

## ✅ 已完成功能

### 无（规划阶段）

目前处于规划阶段，策划案已完成，开发尚未开始。

---

## 🔜 待开发功能

### Phase 1: 基础继承 (预计 1-2天)

**目标**: 搭建技能动作编辑器的基本框架

#### 1.1 窗口和数据结构
- ⏳ 创建 `SkillActionEditorWindow`（继承 `ActionEditorWindow`）
- ⏳ 创建 `SkillActionEditorData`（继承 `ActionEditorData`）
- ⏳ 添加技能专属字段：
  ```csharp
  public int SkillId;
  public int ActualCost;
  public int ActualCooldown;
  public string AttackBoxInfo;
  public List<TriggerFrameData> TriggerFrames;
  ```

#### 1.2 模块继承
- ⏳ 创建 `SkillActionListModule`（继承 `ActionListModule`）
  - 显示技能ID
  - 显示所属技能名称
- ⏳ 创建 `SkillActionConfigModule`（继承 `ActionConfigModule`）
  - 保留动作编辑器的所有配置面板
  - 准备技能专属区域的扩展点

#### 1.3 窗口菜单和打开方式
- ⏳ 添加菜单项：`Tools/Astrum/技能动作编辑器`
- ⏳ 实现窗口的基本打开和关闭
- ⏳ 加载 SkillActionTable 数据

#### 1.4 验证继承
- ⏳ 验证动作编辑器的所有功能是否正常工作
  - 时间轴系统
  - 取消标签编辑
  - 动画预览
  - 命令绑定

**验收标准**：
- ✅ 窗口可以正常打开
- ✅ 可以加载 SkillActionTable 数据
- ✅ 动作编辑器的所有功能正常工作
- ✅ 代码结构清晰，继承关系正确

---

### Phase 2: 技能专属字段 (预计 2-3天)

**目标**: 实现技能专属数据的编辑和显示

#### 2.1 技能信息面板
- ⏳ 在配置面板添加"技能信息"区域
  ```
  [技能信息] ▼
  ┌───────────────────────────────┐
  │ 所属技能ID: 2001  (只读)      │
  │ 技能名称: 冲刺斩  (只读)      │
  │ [跳转到技能编辑器]            │
  └───────────────────────────────┘
  ```
- ⏳ 从 SkillTable 查询并显示技能名称
- ⏳ 实现"跳转到技能编辑器"按钮
  - 打开技能编辑器窗口
  - 自动定位到对应技能

#### 2.2 技能成本配置
- ⏳ 添加"技能成本"配置区域
  ```
  [技能成本] ▼
  ┌───────────────────────────────┐
  │ 实际法力消耗: [____20____]    │
  │ 实际冷却时间: [____300___] 帧 │
  │ (约 5.0 秒)                    │
  └───────────────────────────────┘
  ```
- ⏳ ActualCost 输入框（带范围限制）
- ⏳ ActualCooldown 输入框（带帧数→秒数换算提示）
- ⏳ 实时计算并显示秒数（60帧 = 1秒）

#### 2.3 攻击碰撞盒配置
- ⏳ 添加"攻击碰撞盒"配置区域
  ```
  [攻击碰撞盒] ▼
  ┌───────────────────────────────┐
  │ 碰撞盒信息:                    │
  │ [Box1:5x2x1,Box2:3x3x1]       │
  │ 格式提示: BoxN:长x宽x高        │
  └───────────────────────────────┘
  ```
- ⏳ 字符串格式的文本框
- ⏳ 格式验证（正则表达式）
- ⏳ 错误提示和格式说明

#### 2.4 数据持久化
- ⏳ 实现 `SkillActionDataReader`
  - 继承 `ActionDataReader`
  - 读取 ActionTable 和 SkillActionTable
  - 合并为 SkillActionEditorData
- ⏳ 实现 `SkillActionDataWriter`
  - 继承 `ActionDataWriter`
  - 写入 ActionTable 和 SkillActionTable
  - 确保数据一致性

**验收标准**：
- ✅ 技能信息正确显示
- ✅ 成本配置可以正常编辑和保存
- ✅ 碰撞盒信息可以编辑，格式验证正常
- ✅ 数据可以正确保存到CSV文件
- ✅ 跳转到技能编辑器功能正常

---

### Phase 3: 技能效果轨道 (预计 3-4天)

**目标**: 在时间轴上可视化技能效果触发

#### 3.1 轨道注册
- ⏳ 注册"技能效果"轨道
  ```csharp
  TimelineTrackRegistry.RegisterTrack(new TimelineTrackConfig
  {
      TrackId = "SkillEffects",
      TrackName = "技能效果",
      TrackColor = new Color(1f, 0.3f, 0.3f),
      EventType = TimelineEventType.Instant,
      CanHaveMultipleEvents = true,
      AllowOverlap = true
  });
  ```
- ⏳ 在时间轴布局中添加新轨道
- ⏳ 验证轨道正确显示

#### 3.2 事件渲染器
- ⏳ 实现 `SkillEffectEventRenderer`
  - 绘制菱形标记 ◆
  - 根据触发类型显示不同图标
    - Collision: 💥
    - Direct: ⚡
    - Condition: 🎯
  - 显示效果ID（如 `E4001`）
  - 根据效果类型显示不同颜色
    - 伤害: 红色
    - 治疗: 绿色
    - 击退: 橙色
    - Buff: 蓝色

#### 3.3 事件交互
- ⏳ **添加技能效果**
  - 右键时间轴 → "添加技能效果"
  - 弹出效果选择器
  - 选择触发类型和效果ID
- ⏳ **编辑技能效果**
  - 双击效果事件
  - 打开效果编辑面板
  - 修改触发类型或效果ID
- ⏳ **删除技能效果**
  - 选中效果事件
  - 按 Delete 键或右键菜单删除
- ⏳ **拖动调整**
  - 拖拽效果事件
  - 实时更新触发帧位置
  - 吸附到整数帧

#### 3.4 技能效果选择器
- ⏳ 创建 `SkillEffectSelectorWindow`
  ```
  ┌─ 选择技能效果 ────────────────┐
  │ 搜索: [_______________] [🔍] │
  │                               │
  │ 效果列表:                     │
  │ ┌─────────────────────────┐  │
  │ │ 4001 - 物理伤害 (150.0) │  │
  │ │ 4002 - 击退效果 (3.0)   │  │
  │ │ 4003 - 物理伤害 (80.0)  │  │
  │ └─────────────────────────┘  │
  │                               │
  │ 详细信息:                     │
  │ ┌─────────────────────────┐  │
  │ │ 效果类型: 伤害           │  │
  │ │ 效果数值: 150.0          │  │
  │ │ 目标类型: 敌人           │  │
  │ │ 效果范围: 2.0            │  │
  │ └─────────────────────────┘  │
  │                               │
  │      [确定]    [取消]         │
  └───────────────────────────────┘
  ```
- ⏳ 实现效果列表展示
  - 从 SkillEffectTable 加载所有效果
  - 按效果ID排序
- ⏳ 实现搜索过滤
  - 按效果ID搜索
  - 按效果类型搜索
  - 按效果数值范围搜索
- ⏳ 实现详细信息预览
  - 显示效果的所有参数
  - 高亮显示关键信息

#### 3.5 tooltip 显示
- ⏳ 悬停在效果事件上显示 tooltip
  ```
  技能效果 4001
  ┌────────────────────┐
  │ 触发类型: Collision │
  │ 效果类型: 伤害      │
  │ 效果数值: 150.0     │
  │ 目标类型: 敌人      │
  │ 效果范围: 2.0       │
  │ 视觉效果: 5001      │
  │ 音效ID: 6001        │
  └────────────────────┘
  ```
- ⏳ 根据效果类型格式化显示
- ⏳ 处理效果数据不存在的情况

#### 3.6 数据同步
- ⏳ 实现 `TriggerFrames` ↔ `TimelineEvents` 双向同步
  ```csharp
  // TriggerFrames → TimelineEvents
  public List<TimelineEvent> ConvertToTimelineEvents()
  
  // TimelineEvents → TriggerFrames
  public void SyncFromTimelineEvents(List<TimelineEvent> events)
  ```
- ⏳ 在加载数据时同步
- ⏳ 在保存数据时同步
- ⏳ 在时间轴事件变化时同步

**验收标准**：
- ✅ 技能效果轨道正确显示
- ✅ 可以添加、编辑、删除技能效果
- ✅ 效果选择器功能完整
- ✅ tooltip 显示正确
- ✅ 数据同步无误
- ✅ 保存后CSV文件正确

---

### Phase 4: 碰撞盒可视化 (预计 2-3天，可选)

**目标**: 提供碰撞盒的可视化编辑和预览

#### 4.1 碰撞盒编辑面板
- ⏳ 创建 `AttackBoxEditorWindow`
  ```
  ┌─ 攻击碰撞盒配置 ──────────────┐
  │                               │
  │ 碰撞盒列表:                   │
  │ ┌─────────────────────────┐  │
  │ │ Box1: 5.0x2.0x1.0 [编辑]│  │
  │ │ Box2: 3.0x3.0x1.0 [删除]│  │
  │ └─────────────────────────┘  │
  │                               │
  │ [+ 添加新碰撞盒]              │
  │                               │
  │ 预览 (3D):                    │
  │ ┌─────────────────────────┐  │
  │ │   [3D碰撞盒可视化]      │  │
  │ └─────────────────────────┘  │
  │                               │
  │      [应用]    [取消]         │
  └───────────────────────────────┘
  ```
- ⏳ 实现碰撞盒列表的增删改
- ⏳ 实现碰撞盒参数编辑（长宽高）
- ⏳ 实现格式验证

#### 4.2 碰撞盒3D预览
- ⏳ 在预览窗口中绘制碰撞盒
  - 使用 `Gizmos` 或 `Handles` 绘制
  - 显示碰撞盒的尺寸和位置
- ⏳ 实现碰撞盒选中和高亮
- ⏳ 实现碰撞盒的颜色区分（不同盒子不同颜色）
- ⏳ 与角色模型对齐

#### 4.3 碰撞盒轨道（可选）
- ⏳ 注册"碰撞盒"轨道
- ⏳ 在时间轴上显示碰撞盒激活的时间段
- ⏳ 支持区间事件（起始帧~结束帧）

**验收标准**：
- ✅ 碰撞盒编辑面板功能完整
- ✅ 3D预览正确显示碰撞盒
- ✅ 碰撞盒数据正确保存
- ✅ 与角色模型对齐准确

---

### Phase 5: 效果关联增强 (预计 1-2天)

**目标**: 增强与 SkillEffectTable 的集成

#### 5.1 效果数据缓存
- ⏳ 实现 SkillEffectTable 数据缓存
  ```csharp
  class SkillEffectCache
  {
      private static Dictionary<int, SkillEffectData> _cache;
      
      public static SkillEffectData Get(int effectId)
      {
          if (!_cache.TryGetValue(effectId, out var effect))
          {
              effect = LoadFromTable(effectId);
              _cache[effectId] = effect;
          }
          return effect;
      }
  }
  ```
- ⏳ 在窗口打开时预加载所有效果数据
- ⏳ 在效果表变化时刷新缓存

#### 5.2 跳转功能
- ⏳ 实现"跳转到效果表"功能
  - 右键技能效果事件 → "跳转到效果表"
  - 打开 CSV 文件并定位到对应行（如果支持）
  - 或显示效果ID和提示信息

#### 5.3 快速创建效果
- ⏳ 在效果选择器中添加"创建新效果"按钮
- ⏳ 弹出简单的效果创建面板
  - 自动生成效果ID
  - 填写基本信息（类型、数值）
  - 保存到 SkillEffectTable

**验收标准**：
- ✅ 效果数据缓存工作正常
- ✅ 跳转功能正常
- ✅ 快速创建效果功能可用
- ✅ 性能优化有效（大量效果时不卡顿）

---

## 📊 当前状态

### 开发进度

```
Phase 1: 基础继承           ⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜ 0%
Phase 2: 技能专属字段       ⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜ 0%
Phase 3: 技能效果轨道       ⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜ 0%
Phase 4: 碰撞盒可视化       ⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜ 0% (可选)
Phase 5: 效果关联增强       ⬜⬜⬜⬜⬜⬜⬜⬜⬜⬜ 0%
```

**总体进度**: 0% （规划阶段）

### 技术栈

- **Unity 6000.2.0b7**
- **.NET 9.0**
- **Odin Inspector 3.3.1.13** - UI 自动生成
- **Luban CSV** - 配置表管理
- **通用时间轴系统** - 复用自动作编辑器

### 依赖项

| 依赖 | 状态 | 说明 |
|------|------|------|
| 动作编辑器 | ✅ 已完成 | 基础架构和时间轴系统 |
| SkillActionTable | ✅ 已创建 | 技能动作配置表 |
| SkillEffectTable | ✅ 已创建 | 技能效果配置表 |
| SkillTable | ✅ 已创建 | 技能基本信息表 |
| 技能编辑器 | ✅ 已完成 | 用于关联和跳转 |

---

## 📈 开发时间线

### 预估时间

| 阶段 | 预估时间 | 优先级 | 备注 |
|------|---------|--------|------|
| Phase 1 | 1-2天 | P0 | 必须完成 |
| Phase 2 | 2-3天 | P0 | 必须完成 |
| Phase 3 | 3-4天 | P0 | 核心功能 |
| Phase 4 | 2-3天 | P1 | 可选功能 |
| Phase 5 | 1-2天 | P1 | 增强功能 |

**总计**: 9-14 天（不含可选功能）

### 里程碑

- **M1 - 基础框架** (Day 2): 窗口和数据结构完成，可以加载数据
- **M2 - 技能配置** (Day 5): 技能专属字段可以编辑和保存
- **M3 - 效果轨道** (Day 9): 技能效果可以在时间轴上编辑
- **M4 - 完整发布** (Day 14): 所有核心功能完成，可投入使用

---

## 🎯 技术难点

### 1. 继承架构设计 (P0)

**问题**: 如何正确继承动作编辑器的类，同时扩展技能专属功能？

**解决方案**:
- 使用 `virtual` 和 `override` 方法
- 在基类中预留扩展点（如 `protected virtual void DrawCustomConfig()`）
- 使用组合而非继承（如 SkillEffectModule 作为独立模块）

### 2. 数据同步 (P0)

**问题**: TriggerFrames 和 TimelineEvents 之间的双向同步

**解决方案**:
- 明确主数据源（TimelineEvents 为主）
- 在保存时从 TimelineEvents 同步到 TriggerFrames
- 在加载时从 TriggerFrames 转换为 TimelineEvents
- 使用统一的转换方法避免不一致

### 3. 效果数据缓存 (P1)

**问题**: SkillEffectTable 数据量大，频繁查询影响性能

**解决方案**:
- 在窗口打开时一次性加载所有效果数据
- 使用 Dictionary 缓存，O(1) 查询
- 监听表格变化，自动刷新缓存

### 4. 碰撞盒3D预览 (P1)

**问题**: 在编辑器中绘制3D碰撞盒

**解决方案**:
- 使用 `SceneView.duringSceneGui` 事件
- 使用 `Handles` API 绘制线框
- 使用 `Gizmos` 绘制填充区域
- 参考 Unity 自带的 Collider 编辑器

---

## 📁 文件清单

### 核心文件（待创建）

```
Assets/Script/Editor/RoleEditor/
├── Windows/
│   └── SkillActionEditorWindow.cs          # 技能动作编辑器窗口
├── Modules/
│   ├── SkillActionListModule.cs            # 技能动作列表模块
│   ├── SkillActionConfigModule.cs          # 技能动作配置模块
│   └── SkillEffectModule.cs                # 技能效果模块（新增）
├── Data/
│   ├── SkillActionEditorData.cs            # 技能动作编辑器数据
│   └── TriggerFrameData.cs                 # 触发帧数据
├── Persistence/
│   ├── SkillActionDataReader.cs            # 技能动作数据读取器
│   └── SkillActionDataWriter.cs            # 技能动作数据写入器
├── Timeline/
│   └── SkillEffectEventRenderer.cs         # 技能效果事件渲染器
└── UI/
    ├── SkillEffectSelectorWindow.cs        # 技能效果选择器
    └── AttackBoxEditorWindow.cs            # 碰撞盒编辑器（可选）
```

### 配置表

```
AstrumConfig/Tables/Datas/Skill/
├── #SkillActionTable.csv                    # 技能动作配置表
├── #SkillEffectTable.csv                    # 技能效果配置表
└── #SkillTable.csv                          # 技能基本信息表
```

---

## 🐛 已知问题

### 无（尚未开始开发）

---

## 📝 待确认事项

### 1. 继承方式

**问题**: 是继承 ActionEditorWindow 还是组合使用？

**建议**: 继承，因为复用率高（80%功能相同），代码更简洁。

### 2. 碰撞盒格式

**问题**: AttackBoxInfo 的字符串格式是否最优？

**当前格式**: `"Box1:5x2x1,Box2:3x3x1"`

**建议**: 保持当前格式，在编辑器中提供可视化编辑，运行时解析即可。

### 3. 触发类型枚举

**问题**: 触发类型是字符串还是枚举？

**当前方案**: 字符串（"Collision"/"Direct"/"Condition"）

**建议**: 字符串，便于扩展新类型，配置表中更直观。

---

## 🚀 后续规划

### Phase 6: 高级功能（未来）

- **技能连招预览** - 连续预览技能包含的所有动作
- **技能树可视化** - 展示技能的分支和变种关系
- **批量编辑** - 批量修改多个技能动作的属性
- **模板系统** - 保存常用配置为模板

### 与其他系统集成

- **技能编辑器联动** - 双向跳转和数据同步
- **战斗编辑器集成** - 实时测试技能效果
- **特效编辑器集成** - 预览技能特效

---

## 📖 参考文档

- [动作编辑器开发进展](../动作编辑器/动作编辑器开发进展.md)
- [技能系统策划案](../../Combat-System/技能系统策划案.md)
- [动作系统策划案](../../Combat-System/ActionSystem/动作系统策划案.md)
- [Luban CSV框架使用指南](../Luban_CSV框架使用指南.md)

---

**文档版本**: v1.0  
**维护者**: Astrum Team  
**创建日期**: 2025-10-09

