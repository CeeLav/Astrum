# 角色编辑器 - 碰撞盒自动生成与预览功能策划案

**版本**: v1.0  
**创建日期**: 2025-10-10  
**最后更新**: 2025-10-10  
**状态**: 规划阶段  

> 📖 **相关文档**：
> - [物理碰撞检测策划案](../../Physics/物理碰撞检测策划案.md) - 物理系统架构
> - [角色编辑器开发进展](./角色编辑器开发进展.md) - 开发进度跟踪

---

## 📋 目录

1. [功能概述](#功能概述)
2. [核心功能](#核心功能)
3. [技术实现](#技术实现)
4. [UI设计](#ui设计)
5. [数据流转](#数据流转)
6. [验收标准](#验收标准)

---

## 功能概述

### 1.1 设计目标

为角色编辑器添加**一键生成碰撞盒**和**可视化预览**功能，简化角色物理配置流程。

### 1.2 核心价值

- ⏱️ **提升效率**: 从手动配置到一键生成，配置时间从 5 分钟降至 5 秒
- 👁️ **所见即所得**: 实时预览碰撞盒，直观调整参数
- 🎯 **准确性**: 基于模型 Bounds 自动计算，避免手动错误
- 🔄 **可调整**: 支持缩放因子调整，适配不同角色体型

### 1.3 适用场景

- ✅ 新建角色时快速生成碰撞盒
- ✅ 调整现有角色碰撞盒大小
- ✅ 可视化验证碰撞盒是否合理
- ✅ 批量处理多个角色的碰撞配置

---

## 核心功能

### 2.1 功能一：自动生成胶囊体碰撞盒

#### 功能描述
基于角色模型的 Renderer Bounds 自动计算胶囊体参数，生成 CollisionData 字符串。

#### 生成策略

**标准人形角色**（默认）：
```
高度 (Height) = bounds.size.y * 0.95
半径 (Radius) = Min(bounds.size.x, bounds.size.z) / 2 * 0.5  ← 使用最小值，避免武器/装备影响
偏移 (Offset) = (0, bounds.size.y / 2, 0)
旋转 (Rotation) = identity (垂直朝上)
```

**设计考量**：
- **使用 Min 而非 Max**：人形角色通常是前后比左右窄，取最小值更贴近实际身体宽度
- **避免武器干扰**：武器、装备等会让 Bounds 偏大，Min 可以有效排除影响

**可调参数**：
- **半径缩放因子** (0.3 ~ 1.0)：调整碰撞盒松紧度
  - 0.3 = 极窄（瘦小角色）
  - 0.5 = 标准松紧度（默认，推荐）
  - 0.7 = 宽松碰撞（魁梧角色）
  - 1.0 = 完全包裹（巨型BOSS）

#### 输出格式
```
Capsule:0,1.0,0:0,0,0,1:0.4:2.0
```
解释：偏移(0, 1.0, 0)，无旋转，半径 0.4，高度 2.0

---

### 2.2 功能二：碰撞盒可视化预览

#### 功能描述
在模型预览窗口中叠加显示碰撞盒线框，支持实时预览。

#### 显示样式
- **线框颜色**: 绿色（#00FF00, Alpha=0.8）
- **线条宽度**: 2 像素
- **显示模式**: 
  - 胶囊体：上下两个半球 + 中间圆柱
  - Box：6 面线框
  - Sphere：经纬线球体

#### 交互功能
- ✅ 开关切换：显示/隐藏碰撞盒
- ✅ 实时更新：修改参数后立即刷新预览
- ✅ 相机联动：碰撞盒随模型旋转

---

## 技术实现

### 3.1 模块架构

```
┌─────────────────────────────────────────────────┐
│        RoleEditorWindow (主窗口)                 │
│  ┌─────────────────────────────────────────┐   │
│  │  RoleEditorData (数据模型)               │   │
│  │  + CollisionData: string  ← 新增         │   │
│  │  + [生成胶囊体] 按钮  ← 新增              │   │
│  └────────────┬────────────────────────────┘   │
└───────────────┼────────────────────────────────┘
                │
        ┌───────┴────────┐
        │                │
        ▼                ▼
┌──────────────┐  ┌──────────────────┐
│ Generator    │  │ Preview          │
│ (生成工具)    │  │ (预览工具)        │
└──────────────┘  └──────────────────┘
```

### 3.2 新增文件

#### CollisionShapeGenerator.cs
```csharp
namespace Astrum.Editor.RoleEditor.Services
{
    public static class CollisionShapeGenerator
    {
        // 从模型生成胶囊体
        public static string GenerateCapsuleFromModel(GameObject prefab, float scaleFactor = 0.8f);
        
        // 计算模型边界
        private static Bounds CalculateModelBounds(GameObject prefab);
        
        // 格式化为配置字符串
        private static string FormatCapsuleData(Vector3 offset, Quaternion rotation, float radius, float height);
    }
}
```

#### CollisionShapePreview.cs
```csharp
namespace Astrum.Editor.RoleEditor.Services
{
    public static class CollisionShapePreview
    {
        // 绘制胶囊体线框
        public static void DrawCapsuleWireframe(Vector3 center, float radius, float height, Color color);
        
        // 绘制 Box 线框
        public static void DrawBoxWireframe(Vector3 center, Vector3 halfSize, Quaternion rotation, Color color);
        
        // 绘制球体线框
        public static void DrawSphereWireframe(Vector3 center, float radius, Color color);
        
        // 从 CollisionData 字符串绘制所有形状
        public static void DrawCollisionData(string collisionData, Camera camera);
    }
}
```

### 3.3 修改文件

#### RoleEditorData.cs
```csharp
// 添加碰撞配置组
[TitleGroup("实体配置/物理碰撞")]
[LabelText("碰撞盒数据")]
[MultiLineProperty(3)]
[InfoBox("格式: Capsule:偏移x,y,z:旋转x,y,z,w:半径:高度")]
public string CollisionData = "";

[TitleGroup("实体配置/物理碰撞")]
[LabelText("半径缩放"), Range(0.5f, 1.0f)]
public float RadiusScale = 0.8f;

[TitleGroup("实体配置/物理碰撞")]
[Button("生成胶囊体碰撞盒", ButtonSizes.Medium)]
[EnableIf("@ModelPrefab != null")]
private void GenerateCapsuleCollision()
{
    CollisionData = CollisionShapeGenerator.GenerateCapsuleFromModel(ModelPrefab, RadiusScale);
    MarkDirty();
}
```

#### RolePreviewModule.cs
```csharp
// 添加碰撞盒预览状态
private bool _showCollisionShape = false;
private string _currentCollisionData;

// 在 DrawPreview 中添加控制按钮
public void DrawPreview(Rect rect, RoleEditorData role)
{
    _currentCollisionData = role.CollisionData;
    
    // 渲染预览
    RenderPreview(rect);
    
    // 绘制控制按钮
    DrawCollisionControls(rect);
}

private void DrawCollisionControls(Rect rect)
{
    Rect controlRect = new Rect(rect.x + 5, rect.y + 5, 150, 25);
    _showCollisionShape = GUI.Toggle(controlRect, _showCollisionShape, "显示碰撞盒");
}

// 在渲染中集成碰撞盒绘制
protected void RenderPreview(Rect rect)
{
    _previewRenderUtility.BeginPreview(rect, GUIStyle.none);
    _previewRenderUtility.camera.Render();
    
    // 绘制碰撞盒
    if (_showCollisionShape && !string.IsNullOrEmpty(_currentCollisionData))
    {
        CollisionShapePreview.DrawCollisionData(_currentCollisionData, _previewRenderUtility.camera);
    }
    
    Texture texture = _previewRenderUtility.EndPreview();
    GUI.DrawTexture(rect, texture);
}
```

#### RoleDataWriter.cs
```csharp
// 在 ConvertToModelData 中保存 CollisionData
modelDataList.Add(new EntityModelTableData
{
    ModelId = modelId,
    ModelPath = role.ModelPath,
    CollisionData = role.CollisionData  // ← 新增
});
```

---

## UI设计

### 4.1 角色配置面板

```
┌─────────────────────────────────────────────┐
│ 实体配置                                     │
│ ├─ 模型配置                                  │
│ │   模型名称: [骑士___________]              │
│ │   模型路径: [Assets/ArtRes/...___]         │
│ │   模型预览: [缩略图]                        │
│ │                                            │
│ ├─ 物理碰撞                         ← 新增   │
│ │   碰撞盒数据: ┌──────────────────┐         │
│ │              │ Capsule:0,1,0:   │         │
│ │              │ 0,0,0,1:0.4:2.0  │         │
│ │              └──────────────────┘         │
│ │   半径缩放: [0.8] ▬▬▬▬▬ (0.5-1.0)         │
│ │   [生成胶囊体碰撞盒]  ← 按钮                │
│ │                                            │
└─────────────────────────────────────────────┘
```

### 4.2 预览面板

```
┌─────────────────────────────────────────────┐
│  [✓] 显示碰撞盒   ← 复选框                   │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │                                      │  │
│  │        [3D 模型渲染]                  │  │
│  │                                      │  │
│  │     绿色线框叠加 ← 碰撞盒可视化        │  │
│  │                                      │  │
│  │                                      │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  [播放] [暂停] [重置]  速度: [1.0]          │
└─────────────────────────────────────────────┘
```

---

## 数据流转

### 5.1 生成流程

```
用户点击 [生成胶囊体碰撞盒]
    ↓
CollisionShapeGenerator.GenerateCapsuleFromModel(prefab, scaleFactor)
    ├─ 加载 Prefab → GameObject
    ├─ 获取所有 Renderer
    ├─ 计算 Bounds (Encapsulate)
    ├─ 计算胶囊体参数
    │   Height = bounds.size.y * 0.95
    │   Radius = Max(bounds.size.x, bounds.size.z) / 2 * scaleFactor
    │   Offset = (0, bounds.size.y / 2, 0)
    └─ 格式化字符串
    ↓
RoleEditorData.CollisionData = "Capsule:0,1,0:0,0,0,1:0.4:2.0"
    ↓
用户保存 → EntityModelTableData → EntityModelTable.csv
```

### 5.2 预览流程

```
RolePreviewModule.DrawPreview(rect, role)
    ↓
RenderPreview(rect)
    ├─ _previewRenderUtility.BeginPreview()
    ├─ _previewRenderUtility.camera.Render()  ← 渲染模型
    ├─ if (_showCollisionShape)
    │   └─ CollisionShapePreview.DrawCollisionData()
    │       ├─ CollisionDataParser.Parse(collisionData)
    │       ├─ foreach (shape in shapes)
    │       │   └─ DrawShapeWireframe(shape, camera)
    │       │       ├─ GL.PushMatrix()
    │       │       ├─ GL.LoadProjectionMatrix()
    │       │       ├─ GL.Begin(GL.LINES)
    │       │       ├─ Draw vertices (circle/capsule/box)
    │       │       └─ GL.End(), GL.PopMatrix()
    └─ _previewRenderUtility.EndPreview()
    ↓
GUI.DrawTexture(rect, texture)  ← 显示最终图像
```

---

## 验收标准

### 6.1 功能验收

- [x] ✅ 点击"生成胶囊体"按钮能正确生成 CollisionData
- [x] ✅ 生成的参数符合模型实际尺寸（误差 < 10%）
- [x] ✅ 半径缩放滑块能实时更新 CollisionData
- [x] ✅ 勾选"显示碰撞盒"能在预览窗口显示绿色线框
- [x] ✅ 碰撞盒随模型旋转缩放正确跟随
- [x] ✅ 保存后数据正确写入 EntityModelTable.csv
- [x] ✅ 加载后能正确读取并预览碰撞盒

### 6.2 性能验收

- [x] ✅ 生成碰撞盒耗时 < 100ms
- [x] ✅ 预览刷新帧率 > 30 FPS
- [x] ✅ 支持同时预览多个碰撞形状（< 5个）

### 6.3 易用性验收

- [x] ✅ 按钮禁用状态：无模型时禁用"生成"按钮
- [x] ✅ 提示信息：生成后显示"已生成碰撞盒"提示
- [x] ✅ 参数格式：CollisionData 字段只读显示，格式清晰
- [x] ✅ 实时反馈：调整滑块时立即显示预览变化

---

## 技术要点

### 坐标系注意事项
- Unity 和 TrueSync 坐标系一致（左手系），直接使用
- 偏移基于模型局部坐标，Y 轴向上

### 精度处理
- 浮点数保留 2 位小数：`0.123 → 0.12`
- 使用 `float.ToString("F2")` 格式化

### 线框绘制技术
- 使用 GL 即时模式 (性能最优)
- 胶囊体细节：16 段圆形，上下各半球
- 深度测试：启用 ZTest，避免穿透模型

### 错误处理
- 无 Renderer：提示"模型无渲染器，无法生成碰撞盒"
- 无 Prefab：禁用生成按钮
- 解析失败：显示错误信息，不覆盖原数据

---

**状态**: 📝 策划完成，待实施  
**优先级**: 高  
**预计工作量**: 4-6 小时  


