@startuml ActionSystemFlow

skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center

title 动作系统每帧工作流程

actor "玩家输入" as Player
participant "ActionCapability" as Capability
participant "ActionComponent" as Component
participant "ActionConfigManager" as ConfigManager
participant "战斗系统" as Combat

== 每帧更新流程 ==

Capability -> Capability: Tick(deltaTime)
activate Capability

group 1. 检查所有动作的取消条件
    Capability -> Component: 获取当前动作
    Component --> Capability: CurrentAction
    
    Capability -> ConfigManager: 获取所有可用动作
    ConfigManager --> Capability: AllActions
    
    loop 遍历所有动作
        Capability -> Capability: CanCancelToAction(action)
        note right
            检查CancelTag是否匹配
            当前动作的BeCancelledTag
        end note
        
        alt 可以取消
            Capability -> Capability: HasValidCommand(action)
            note right
                检查输入命令是否满足
            end note
            
            alt 命令有效
                Capability -> Component: 添加到预订单列表
                Component -> Component: PreorderActions.Add()
            end
        end
    end
end

group 2. 从候选列表选择动作
    Capability -> Component: 获取预订单列表
    Component --> Capability: PreorderActions
    
    alt 有候选动作
        Capability -> Capability: 按优先级排序
        Capability -> Capability: 选择最高优先级动作
        
        Capability -> ConfigManager: 获取动作信息
        ConfigManager --> Capability: ActionInfo
        
        Capability -> Capability: SwitchToAction()
        Capability -> Component: 更新当前动作
        Component -> Component: 设置CurrentAction
        Component -> Component: 设置CurrentActionProgress
        Component -> Component: 设置CurrentFrame
        
        Capability -> Component: 清空预订单列表
    end
end

group 3. 更新当前动作
    Capability -> Component: 获取当前动作
    Component --> Capability: CurrentAction
    
    Capability -> Capability: GetActionDuration()
    Capability -> Component: 更新动作进度
    Component -> Component: CurrentActionProgress += deltaTime / duration
    
    alt 动作已结束 && AutoTerminate
        Capability -> Capability: SwitchToNextAction()
        
        Capability -> Component: 获取AutoNextActionId
        Component --> Capability: NextActionId
        
        Capability -> ConfigManager: 获取下一个动作
        ConfigManager --> Capability: NextActionInfo
        
        Capability -> Capability: SwitchToAction()
        Capability -> Component: 更新为下一个动作
    end
end

deactivate Capability

== 动作切换的触发方式 ==

group 输入指令切换
    Player -> Capability: 输入命令
    Capability -> Component: InputCommands.Add()
    note right: 在下一帧检查时触发
end

group 攻击命中切换
    Combat -> Capability: 攻击命中事件
    Capability -> Component: 临时开启BeCancelledTag
    note right: 通过TempBeCancelledTag触发
end

group 自动切换
    Capability -> Component: 动作播放完成
    Component --> Capability: IsActionFinished = true
    Capability -> Capability: SwitchToNextAction()
    note right: 切换到AutoNextActionId
end

@enduml