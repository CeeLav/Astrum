# 动作编辑器策划案

**版本**: v1.0  
**创建日期**: 2025-10-09  
**最后更新**: 2025-10-09  
**状态**: Phase 2 完成 - 核心功能已实现  

---

## 📋 目录

1. [概述](#概述)
2. [核心设计理念](#核心设计理念)
3. [架构设计](#架构设计)
4. [功能模块](#功能模块)
5. [通用时间轴系统](#通用时间轴系统)
6. [数据流设计](#数据流设计)
7. [UI/UX设计](#uiux设计)
8. [技术实现](#技术实现)
9. [扩展性设计](#扩展性设计)
10. [后续规划](#后续规划)

---

## 概述

### 1.1 项目背景

动作编辑器是 Astrum 项目中用于配置角色动作系统的核心工具，负责管理 ActionTable 配置表数据，提供可视化的动作配置和时间轴事件编辑功能。

### 1.2 核心目标

- **可视化编辑** - 提供直观的时间轴界面，所见即所得
- **数据完整性** - 保证配置数据与CSV表的完全同步
- **高效工作流** - 减少策划配置动作的时间成本
- **可复用架构** - 时间轴模块可复用于技能编辑器等其他工具

### 1.3 关键特性

- 📊 **多轨道时间轴** - 支持被取消标签、特效、音效、相机震动等多种事件
- 🎬 **动画预览** - 实时预览动作动画，与时间轴同步
- 🎯 **精确控制** - 逐帧编辑，支持拖拽、调整区间
- 💾 **数据持久化** - 直接读写 ActionTable.csv，保证数据一致性
- 🔧 **可扩展性** - 轨道类型动态注册，易于添加新功能

---

## 核心设计理念

### 2.1 通用时间轴优先

**设计原则**：时间轴模块完全解耦，不依赖具体业务逻辑

```
通用时间轴模块 (Timeline/)
    ├── 可用于动作编辑器
    ├── 可用于技能编辑器
    ├── 可用于剧情编辑器
    └── 可用于任何需要时间轴的编辑器
```

**优势**：
- 一次开发，多处复用
- 降低维护成本
- 统一用户体验

### 2.2 数据驱动

**核心原则**：所有配置通过数据驱动，避免硬编码

```
轨道类型动态注册
    ↓
TimelineTrackRegistry
    ↓
运行时配置轨道行为
```

**优势**：
- 易于添加新轨道类型
- 无需修改核心代码
- 支持插件化扩展

### 2.3 单一职责

**架构分层**：
```
Windows/     - 窗口管理（UI容器）
Modules/     - 功能模块（列表、配置、预览、时间轴）
Layout/      - 布局计算（区域划分）
Data/        - 数据模型（业务对象）
Persistence/ - 数据持久化（CSV读写）
Timeline/    - 通用时间轴（核心引擎）
```

每个类职责明确，控制在 300 行以内。

### 2.4 事件驱动

**交互模式**：模块间通过事件通信，降低耦合

```csharp
// 发布事件
_listModule.OnActionSelected += OnActionSelected;

// 订阅事件
private void OnActionSelected(ActionEditorData action)
{
    _configModule.SetAction(action);
    _timelineModule.SetEvents(action.TimelineEvents);
}
```

---

## 架构设计

### 3.1 总体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   ActionEditorWindow                         │
│                     (主窗口控制器)                            │
├──────────────┬─────────────────────────────┬────────────────┤
│              │                             │                │
│  列表模块     │      配置模块                │   预览模块      │
│              │                             │                │
│ ┌──────────┐ │ ┌─────────────────────────┐ │ ┌────────────┐ │
│ │ActionList│ │ │  ActionConfigModule     │ │ │ Animation  │ │
│ │Module    │ │ │                         │ │ │ Preview    │ │
│ │          │ │ │  - 基础配置(Odin)        │ │ │ Module     │ │
│ │ - 搜索   │ │ │  - 取消标签统计          │ │ │            │ │
│ │ - 筛选   │ │ │  - 事件统计             │ │ │ - 模型预览  │ │
│ │ - CRUD   │ │ │  - 事件详情编辑          │ │ │ - 播放控制  │ │
│ └──────────┘ │ └─────────────────────────┘ │ └────────────┘ │
│              │                             │                │
├──────────────┴─────────────────────────────┴────────────────┤
│                                                              │
│                   TimelineEditorModule                       │
│                     (通用时间轴模块)                          │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  TimelineRenderer    TimelineInteraction             │  │
│  │  (渲染器)             (交互处理)                      │  │
│  │                                                       │  │
│  │  TimelineLayoutCalculator                            │  │
│  │  (布局计算)                                           │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  TimelineTrackRegistry (轨道注册表)                   │  │
│  │  ├── 🚫 BeCancelTag Track                            │  │
│  │  ├── ✨ VFX Track                                    │  │
│  │  ├── 🔊 SFX Track                                    │  │
│  │  └── 📷 CameraShake Track                            │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────┘
```

### 3.2 模块依赖关系

```
ActionEditorWindow (主窗口)
    │
    ├──> ActionListModule (动作列表)
    │       └──> ActionEditorData (数据模型)
    │
    ├──> ActionConfigModule (配置面板)
    │       ├──> PropertyTree (Odin Inspector)
    │       └──> TimelineTrackRegistry (获取事件编辑器)
    │
    ├──> AnimationPreviewModule (动画预览)
    │       └──> BasePreviewModule (基类)
    │
    ├──> TimelineEditorModule (时间轴)
    │       ├──> TimelineRenderer (渲染)
    │       ├──> TimelineInteraction (交互)
    │       ├──> TimelineLayoutCalculator (布局)
    │       └──> TimelineTrackRegistry (轨道注册表)
    │
    └──> ActionEditorLayout (布局管理)
```

### 3.3 数据模型层次

```
ActionTable.csv (CSV配置文件)
    ↓ ActionDataReader
ActionTableData (CSV映射类)
    ↓ ConvertToEditorData
ActionEditorData (编辑器数据模型)
    ├── 基础字段 (ActionId, ActionName, Duration...)
    ├── CancelTags (主动取消标签 - 只读)
    └── TimelineEvents (时间轴事件列表)
            ├── BeCancelTag 事件
            ├── VFX 事件
            ├── SFX 事件
            └── CameraShake 事件
```

---

## 功能模块

### 4.1 动作列表模块 (ActionListModule)

**职责**：动作的浏览、搜索、筛选和CRUD操作

**功能清单**：
- ✅ 动作列表显示（卡片式）
- ✅ 搜索（按ID或名称）
- ✅ 筛选（按类型：idle/walk/skill等）
- ✅ 选中高亮
- ✅ 创建新动作
- ✅ 复制动作
- ✅ 删除动作（带确认）

**交互事件**：
```csharp
public event Action<ActionEditorData> OnActionSelected;
public event Action OnCreateNew;
public event Action<ActionEditorData> OnDuplicate;
public event Action<ActionEditorData> OnDelete;
```

### 4.2 配置面板模块 (ActionConfigModule)

**职责**：动作基础配置和事件详情编辑

**功能区域**：

#### 4.2.1 实体选择区
- 选择预览用的实体模型
- 自动加载实体的模型和动画

#### 4.2.2 基础配置区（Odin Inspector）
- 动作ID（只读）
- 动作名称
- 动作类型（下拉选择）
- 动画路径（文件选择器）
- 动画/动作总帧数
- 优先级
- 自动下一动作ID
- 保持播放动画
- 自动终止
- 命令

#### 4.2.3 取消标签配置区
- CancelTags（只读，JSON显示）
- BeCancelledTags 统计
- 跳转到时间轴按钮

#### 4.2.4 事件统计区
- 各类型事件计数
- 跳转到时间轴按钮

#### 4.2.5 事件详情编辑区 ⭐
- 显示选中事件信息
- 动态调用对应轨道的编辑器
- 实时更新事件属性

### 4.3 动画预览模块 (AnimationPreviewModule)

**职责**：3D模型和动画的实时预览

**功能清单**：
- ✅ 加载实体模型
- ✅ 播放动作动画
- ✅ 逐帧控制（前进/后退）
- ✅ 播放/暂停/停止
- ✅ 与时间轴双向同步
- ✅ 相机轨道球控制

**帧率配置**：
- 游戏逻辑帧率：20fps
- 每帧时间：50ms (0.05秒)

### 4.4 时间轴模块 (TimelineEditorModule)

详见 [通用时间轴系统](#通用时间轴系统)

---

## 通用时间轴系统

### 5.1 设计目标

**核心原则**：构建一个完全解耦的、可复用的时间轴编辑器引擎

```
任何编辑器只需：
1. 初始化 TimelineEditorModule
2. 注册轨道类型
3. 传入事件数据
4. 监听回调事件
```

### 5.2 核心组件

#### 5.2.1 TimelineEditorModule (主控制器)

**职责**：整合所有子模块，提供统一API

```csharp
public class TimelineEditorModule
{
    // 子模块
    private TimelineLayoutCalculator _layoutCalculator;
    private TimelineRenderer _renderer;
    private TimelineInteraction _interaction;
    
    // 核心数据
    private List<TimelineEvent> _events;
    private List<TimelineTrackConfig> _tracks;
    
    // 对外事件
    public event Action<TimelineEvent> OnEventSelected;
    public event Action<TimelineEvent> OnEventAdded;
    public event Action<TimelineEvent> OnEventRemoved;
    public event Action<TimelineEvent> OnEventModified;
    public event Action<int> OnCurrentFrameChanged;
}
```

**核心方法**：
- `Initialize(totalFrames)` - 初始化
- `DrawTimeline(rect)` - 绘制时间轴
- `SetEvents(events)` - 设置事件列表
- `SetTracks(tracks)` - 设置轨道列表
- `AddEvent(evt)` - 添加事件
- `RemoveEvent(evt)` - 移除事件

#### 5.2.2 TimelineRenderer (渲染器)

**职责**：绘制时间轴的所有可视元素

**绘制内容**：
- 帧刻度（主刻度+次刻度）
- 播放头（红色竖线+三角标记）
- 轨道背景（交替色）
- 轨道标题
- 事件矩形
- 选中/悬停高亮

**颜色配置**：
```csharp
private static readonly Color COLOR_PLAYHEAD = new Color(1f, 0.2f, 0.2f);
private static readonly Color COLOR_TRACK_BG_EVEN = new Color(0.25f, 0.25f, 0.25f);
private static readonly Color COLOR_TRACK_BG_ODD = new Color(0.22f, 0.22f, 0.22f);
```

#### 5.2.3 TimelineInteraction (交互处理器)

**职责**：处理所有用户输入和交互

**支持的交互**：

| 交互类型 | 操作 | 触发条件 |
|---------|------|---------|
| **播放头拖拽** | 左键拖拽刻度尺/播放头 | 点击±5px范围 |
| **事件选中** | 左键点击事件 | 点击事件矩形 |
| **事件移动** | 拖拽事件中心 | 拖动选中事件 |
| **边缘调整** | 拖拽事件边缘 | 点击±4px边缘 |
| **右键菜单** | 右键点击轨道 | 显示上下文菜单 |
| **快捷键** | Delete/方向键 | 删除/切换帧 |

**碰撞检测算法**：

```csharp
HitTestPlayhead(mousePos, rect)
    → 检测鼠标是否在播放头±5px范围

HitTestEvents(mousePos, rect, tracks, events)
    → 遍历所有轨道和事件
    → 计算事件矩形
    → 判断鼠标是否在矩形内
    → 检测是否在边缘±4px

HitTestTrack(mousePos, rect, tracks)
    → 累加轨道高度
    → 判断鼠标Y坐标所在轨道
```

#### 5.2.4 TimelineLayoutCalculator (布局计算器)

**职责**：计算时间轴各区域的位置和大小

**核心参数**：
```csharp
private const float TRACK_HEADER_WIDTH = 120f;    // 轨道标题宽度
private const float FRAME_SCALE_HEIGHT = 30f;     // 帧刻度高度
private const float PLAYHEAD_HEIGHT = 20f;        // 播放头高度
private const float MIN_PIXELS_PER_FRAME = 2f;    // 最小缩放
private const float MAX_PIXELS_PER_FRAME = 20f;   // 最大缩放
private const float DEFAULT_PIXELS_PER_FRAME = 5f; // 默认缩放
```

**坐标转换**：
```csharp
PixelToFrame(pixelX) → frameNumber
FrameToPixel(frameNumber) → pixelX
```

**区域计算**：
- `GetFrameScaleRect()` - 帧刻度区域
- `GetPlayheadRect()` - 播放头区域
- `GetTrackAreaRect()` - 轨道区域
- `GetEventRect(evt, trackRect)` - 事件矩形

### 5.3 时间轴数据结构

#### 5.3.1 TimelineEvent (统一事件数据)

```csharp
[Serializable]
public class TimelineEvent
{
    // 基础信息
    public string EventId;         // 唯一标识符
    public string TrackType;       // 轨道类型
    public int StartFrame;         // 起始帧
    public int EndFrame;           // 结束帧
    public string DisplayName;     // 显示名称
    public string Note;            // 备注
    
    // 事件数据（JSON序列化）
    private string _eventData;
    
    // 泛型访问
    public T GetEventData<T>() where T : class;
    public void SetEventData<T>(T data) where T : class;
}
```

**优势**：
- 统一的事件容器
- 支持任意类型的事件数据
- JSON序列化，易于扩展

#### 5.3.2 TimelineTrackConfig (轨道配置)

```csharp
[Serializable]
public class TimelineTrackConfig
{
    // 基础配置
    public string TrackType;       // 轨道类型（唯一）
    public string TrackName;       // 显示名称
    public string TrackIcon;       // 图标（emoji）
    public Color TrackColor;       // 主题色
    public float TrackHeight;      // 高度
    public bool IsVisible;         // 是否可见
    public bool IsLocked;          // 是否锁定
    public int SortOrder;          // 排序顺序
    public bool AllowOverlap;      // 允许事件重叠
    
    // 委托
    public Action<Rect, TimelineEvent> EventRenderer;  // 渲染器
    public Func<TimelineEvent, bool> EventEditor;      // 编辑器
}
```

**动态注册**：
```csharp
TimelineTrackRegistry.RegisterTrack(new TimelineTrackConfig
{
    TrackType = "BeCancelTag",
    TrackName = "被取消标签",
    TrackIcon = "🚫",
    TrackColor = new Color(0.8f, 0.3f, 0.3f),
    EventRenderer = BeCancelTagTrackRenderer.RenderEvent,
    EventEditor = BeCancelTagTrackRenderer.EditEvent
});
```

### 5.4 轨道类型详解

#### 5.4.1 被取消标签轨道 (BeCancelTag)

**用途**：定义动作可被其他动作取消的时间范围

**数据结构**：
```csharp
public class BeCancelTagEventData
{
    public List<string> Tags;       // 被取消标签列表 ["move", "skill"]
    public int BlendOutFrames;      // 融合时间（帧）
    public int Priority;            // 优先级变化
    public string Note;             // 备注
}
```

**CSV格式**：
```json
[
  {"tags":["move","skill","jump"],"rangeFrames":[0,60],"blendOutFrames":3,"priority":0}
]
```

**可视化**：
- 红色区间条
- 显示标签名称
- 不允许重叠（AllowOverlap = false）

#### 5.4.2 特效轨道 (VFX)

**用途**：在动作过程中播放视觉特效

**数据结构**：
```csharp
public class VFXEventData
{
    public string ResourcePath;     // 特效资源路径
    public Vector3 PositionOffset;  // 位置偏移
    public Vector3 Rotation;        // 旋转
    public float Scale;             // 缩放
    public float PlaybackSpeed;     // 播放速度
    public bool FollowCharacter;    // 是否跟随角色
    public bool Loop;               // 是否循环
    public string Note;
}
```

**可视化**：
- 紫色区间条
- 显示特效文件名
- 允许重叠

#### 5.4.3 音效轨道 (SFX)

**用途**：在动作过程中播放音效

**数据结构**：
```csharp
public class SFXEventData
{
    public string ResourcePath;     // 音效资源路径
    public float Volume;            // 音量 (0-1)
    public float Pitch;             // 音调 (0.5-2)
    public float SpatialBlend;      // 空间混音 (0=2D, 1=3D)
    public bool Loop;               // 是否循环
    public bool FollowCharacter;    // 是否跟随角色
    public float MaxDistance;       // 最大听距
    public string Note;
}
```

**可视化**：
- 橙色区间条
- 显示音效文件名
- 允许重叠

#### 5.4.4 相机震动轨道 (CameraShake)

**用途**：在动作过程中触发相机震动

**数据结构**：
```csharp
public class CameraShakeEventData
{
    public float Intensity;         // 震动强度 (0-1)
    public float Frequency;         // 震动频率 (Hz)
    public Vector3 Direction;       // 震动方向
    public string FalloffCurve;     // 衰减曲线（预留）
    public string Note;
}
```

**可视化**：
- 灰色区间条
- 显示震动强度
- 允许重叠

---

## 数据流设计

### 6.1 读取流程

```
#ActionTable.csv
    ↓ LubanCSVReader.ReadTable<ActionTableData>()
ActionTableData (12个字段)
    ↓ ActionDataReader.ConvertToEditorData()
ActionEditorData
    ├── 基础字段 (直接复制)
    ├── CancelTags (透传)
    └── TimelineEvents
            ↓ ActionCancelTagParser.ParseBeCancelledTags()
        List<TimelineEvent> (带 BeCancelTagEventData)
```

**JSON解析示例**：
```csharp
// CSV中的JSON字符串
string json = "[{\"tags\":[\"move\",\"skill\"],\"rangeFrames\":[0,60],\"blendOutFrames\":3,\"priority\":0}]";

// 解析
var jsonDataList = JsonConvert.DeserializeObject<List<BeCancelledTagJsonData>>(json);

// 转换为 TimelineEvent
foreach (var jsonData in jsonDataList)
{
    var eventData = new BeCancelTagEventData
    {
        Tags = jsonData.Tags,
        BlendOutFrames = jsonData.BlendOutFrames,
        Priority = jsonData.Priority
    };
    
    var evt = new TimelineEvent
    {
        TrackType = "BeCancelTag",
        StartFrame = jsonData.RangeFrames[0],
        EndFrame = jsonData.RangeFrames[1]
    };
    evt.SetEventData(eventData);
}
```

### 6.2 保存流程

```
ActionEditorData
    ↓ ActionDataWriter.ConvertToTableData()
ActionTableData
    ├── 基础字段 (直接复制)
    ├── CancelTags (透传)
    └── BeCancelledTags
            ↓ ActionCancelTagSerializer.SerializeBeCancelledTags()
        JSON字符串 (从 TimelineEvents 提取 BeCancelTag 类型)
    ↓ LubanCSVWriter.WriteTable<ActionTableData>()
#ActionTable.csv (更新)
```

**序列化示例**：
```csharp
// 从 TimelineEvents 筛选 BeCancelTag 事件
var beCancelEvents = events.Where(e => e.TrackType == "BeCancelTag").ToList();

// 序列化为JSON
foreach (var evt in beCancelEvents)
{
    var data = evt.GetEventData<BeCancelTagEventData>();
    
    string jsonObj = $"{{\"tags\":{SerializeArray(data.Tags)}," +
                     $"\"rangeFrames\":[{evt.StartFrame},{evt.EndFrame}]," +
                     $"\"blendOutFrames\":{data.BlendOutFrames}," +
                     $"\"priority\":{data.Priority}}}";
}

// 输出：[{...}, {...}]
```

### 6.3 数据一致性保证

**关键策略**：

1. **读取时**：
   - 使用 `LubanCSVReader` 确保与Luban生成代码一致
   - 解析JSON时捕获异常，避免数据丢失
   - 清除 IsDirty 标记

2. **保存时**：
   - 序列化完整数据（包含所有时间轴事件）
   - 保持 CancelTags 原值（透传）
   - 验证数据格式

3. **修改时**：
   - 任何修改立即标记 `IsDirty = true`
   - 窗口关闭时检测未保存修改
   - 提示用户保存

---

## UI/UX设计

### 7.1 界面布局

#### 7.1.1 整体布局

```
┌────────────────────────────────────────────────────────────────┐
│  工具栏: [保存] [刷新] [验证]     当前动作信息        [帮助]    │
├──────────────┬─────────────────────────────────────────────────┤
│              │  ┌───────────────────┬─────────────────────────┐ │
│              │  │  配置面板 (340px)  │  动画预览 (占满)         │ │
│  动作列表     │  │                   │                         │ │
│  (240px)     │  │  - 实体选择        │  - 3D模型预览           │ │
│              │  │  - 基础配置        │  - 播放控制             │ │
│  - 搜索框     │  │  - 取消标签        │  - 帧信息显示           │ │
│  - 类型筛选   │  │  - 事件统计        │                         │ │
│  - 动作卡片   │  │  - 事件详情编辑    │                         │ │
│              │  └───────────────────┴─────────────────────────┘ │
│              │                                                   │
│              │  ┌─────────────────────────────────────────────┐ │
│              │  │  多轨道时间轴 (280px高)                      │ │
│              │  │                                             │ │
│              │  │  [帧刻度] 0   5   10   15   20 ...           │ │
│              │  │  [播放头]   |                                │ │
│              │  │                                             │ │
│              │  │  🚫 被取消标签  [████区间████]               │ │
│              │  │  ✨ 特效        [██]    [██]                │ │
│              │  │  🔊 音效           [██]                      │ │
│              │  │  📷 相机震动                [██]             │ │
│              │  │                                             │ │
│              │  └─────────────────────────────────────────────┘ │
└──────────────┴───────────────────────────────────────────────────┘
```

#### 7.1.2 尺寸规范

| 区域 | 尺寸 | 可调整 |
|------|------|--------|
| **最小窗口** | 1200x800 | ❌ |
| **动作列表** | 240px宽 | ❌ |
| **配置面板** | 340px宽 | ❌ |
| **动画预览** | 占满剩余 | ✅ |
| **时间轴** | 280px高 | ❌ |
| **工具栏** | 30px高 | ❌ |

### 7.2 交互设计

#### 7.2.1 拖拽操作

**播放头拖拽**：
```
1. 点击帧刻度尺 → 跳转到点击帧
2. 拖拽刻度尺 → 持续更新当前帧
3. 点击播放头线（±5px） → 开始拖拽
4. 释放鼠标 → 结束拖拽
```

**事件拖拽**：
```
1. 点击事件中心 → 选中事件
2. 拖动鼠标 → 移动事件（保持持续时间）
3. 边界约束：StartFrame >= 0
4. 释放鼠标 → 确认位置
```

**边缘调整**：
```
1. 点击事件左边缘（±4px） → 开始调整起始帧
2. 点击事件右边缘（±4px） → 开始调整结束帧
3. 拖动鼠标 → 实时调整
4. 约束：StartFrame <= EndFrame
5. 释放鼠标 → 确认调整
```

#### 7.2.2 右键菜单

**轨道区域右键**：
```
├── 在帧 X 添加事件
├────────────────
├── 复制事件 (选中时启用)
├── 粘贴事件 (剪贴板非空时启用)
├────────────────
└── 删除事件 (选中时启用)
```

**菜单逻辑**：
- 自动检测点击的轨道类型
- 添加事件时创建对应类型的默认数据
- 粘贴时保持剪贴板事件的数据，更新帧位置

#### 7.2.3 快捷键

| 快捷键 | 功能 |
|--------|------|
| Delete | 删除选中事件（带确认对话框） |
| ← | 上一帧 |
| → | 下一帧 |
| Home | 跳转到第0帧 |
| Ctrl+C | 复制选中事件（预留） |
| Ctrl+V | 粘贴事件（预留） |

### 7.3 视觉反馈

#### 7.3.1 高亮系统

**选中高亮**（金色）：
```
┌─────────────┐
│ ██████████ │  ← 2px金色边框
│ █ 事件 ██ │
│ ██████████ │
└─────────────┘
Color: (1f, 0.8f, 0f, 1f)
```

**悬停高亮**（白色）：
```
┌─────────────┐
│ ██████████ │  ← 1px半透明白边框
│ █ 事件 ██ │
│ ██████████ │
└─────────────┘
Color: (1f, 1f, 1f, 0.5f)
```

#### 7.3.2 播放头样式

```
帧刻度区域:
    ↓ 红色三角标记
────|──────────
    | 红色竖线（贯穿所有轨道）
```

---

## 技术实现

### 8.1 核心技术栈

| 技术 | 用途 | 版本 |
|------|------|------|
| **Unity** | 编辑器框架 | 6000.0+ |
| **Odin Inspector** | 属性面板 | 3.3.1.13 |
| **Animancer** | 动画预览 | 8.2.2 |
| **Newtonsoft.Json** | JSON解析 | - |
| **CsvHelper** | CSV读写 | - |
| **Luban** | 配置表生成 | - |

### 8.2 依赖关系

```
动作编辑器
    ├── Odin Inspector (配置面板)
    ├── Animancer (动画预览)
    ├── Newtonsoft.Json (JSON解析)
    ├── CsvHelper (CSV读写)
    └── ConfigTableHelper (配置表辅助类)
```

### 8.3 代码组织

#### 8.3.1 命名空间

```csharp
Astrum.Editor.RoleEditor.Windows      // 窗口
Astrum.Editor.RoleEditor.Modules      // 模块
Astrum.Editor.RoleEditor.Layout       // 布局
Astrum.Editor.RoleEditor.Data         // 数据
Astrum.Editor.RoleEditor.Persistence  // 持久化
Astrum.Editor.RoleEditor.Timeline     // 时间轴
    ├── .EventData                     // 事件数据
    └── .Renderers                     // 渲染器
```

#### 8.3.2 文件大小控制

**设计原则**：单个类控制在 300 行以内

**实际统计**：
```
最大文件: TimelineRenderer.cs (~300行)
最小文件: TimelineTrackConfig.cs (~120行)
平均大小: ~180行
```

所有类都符合规范 ✅

### 8.4 性能优化

#### 8.4.1 布局缓存

```csharp
// 避免每帧重新计算
private Rect _frameScaleRect;
private Rect _playheadRect;
private Rect _trackAreaRect;

// 只在布局变化时重新计算
public void CalculateLayout(Rect totalRect, int totalFrames, int trackCount)
{
    _frameScaleRect = ...;
    _playheadRect = ...;
    _trackAreaRect = ...;
}
```

#### 8.4.2 事件分组

```csharp
// 按轨道类型分组，避免线性查找
private Dictionary<string, List<TimelineEvent>> _eventsByTrack;

// 每次数据变化时重建
private void RebuildEventsByTrack()
{
    _eventsByTrack.Clear();
    foreach (var evt in _events)
    {
        if (!_eventsByTrack.ContainsKey(evt.TrackType))
            _eventsByTrack[evt.TrackType] = new List<TimelineEvent>();
        
        _eventsByTrack[evt.TrackType].Add(evt);
    }
}
```

#### 8.4.3 重绘优化

```csharp
// 只在必要时触发重绘
if (_previewModule.IsPlaying())
{
    Repaint(); // 动画播放时持续重绘
}

// 交互时立即重绘
OnEventSelected?.Invoke(evt);
Repaint();
```

---

## 扩展性设计

### 9.1 添加新轨道类型

**步骤**：

1. **创建事件数据类**：
```csharp
// Timeline/EventData/MyEventData.cs
[Serializable]
public class MyEventData
{
    public string MyProperty;
    
    public static MyEventData CreateDefault() { ... }
    public string GetDisplayName() { ... }
}
```

2. **创建渲染器**：
```csharp
// Timeline/Renderers/MyTrackRenderer.cs
public static class MyTrackRenderer
{
    public static void RenderEvent(Rect rect, TimelineEvent evt) { ... }
    public static bool EditEvent(TimelineEvent evt) { ... }
}
```

3. **注册轨道**：
```csharp
// ActionEditorWindow.RegisterTracks()
TimelineTrackRegistry.RegisterTrack(new TimelineTrackConfig
{
    TrackType = "MyTrack",
    TrackName = "我的轨道",
    TrackIcon = "🎯",
    TrackColor = Color.blue,
    EventRenderer = MyTrackRenderer.RenderEvent,
    EventEditor = MyTrackRenderer.EditEvent
});
```

**无需修改核心代码**！

### 9.2 复用时间轴到其他编辑器

**示例：技能编辑器**

```csharp
public class SkillEditorWindow : EditorWindow
{
    private TimelineEditorModule _timeline;
    
    private void OnEnable()
    {
        _timeline = new TimelineEditorModule();
        _timeline.Initialize(skillDuration);
        
        // 注册技能专用轨道
        TimelineTrackRegistry.RegisterTrack(new TimelineTrackConfig
        {
            TrackType = "AttackBox",
            TrackName = "攻击判定",
            TrackIcon = "⚔️",
            ...
        });
        
        // 监听事件
        _timeline.OnEventModified += OnSkillEventModified;
    }
    
    private void OnGUI()
    {
        _timeline.DrawTimeline(timelineRect);
    }
}
```

**真正的解耦设计**！

### 9.3 扩展配置面板

**使用Odin Inspector特性**：

```csharp
[TitleGroup("我的分组")]
[LabelText("我的字段")]
[InfoBox("提示信息", InfoMessageType.Info)]
[ValueDropdown("GetOptions")]
[ValidateInput("ValidateMethod", "错误提示")]
public string MyField;
```

只需在 `ActionEditorData` 中添加字段，Odin 自动生成UI。

---

## 后续规划

### 10.1 Phase 3 计划（功能优化）

#### 优先级1：数据验证增强
- [ ] 实现完整的验证逻辑
- [ ] 检测重复ID
- [ ] 检测无效引用（AutoNextActionId）
- [ ] 检测缺失动画文件
- [ ] 检测事件冲突

#### 优先级2：用户体验提升
- [ ] 时间轴缩放控制（滚轮）
- [ ] 轨道折叠/展开
- [ ] 事件吸附功能（吸附到整数帧）
- [ ] Undo/Redo 支持
- [ ] 批量编辑功能

#### 优先级3：高级功能
- [ ] 动作继承/引用系统
- [ ] 批量导入动画
- [ ] 预设模板系统
- [ ] 导出/导入功能（JSON）

### 10.2 技能编辑器复用

**基于通用时间轴**，快速开发技能编辑器：

**新增轨道类型**：
- ⚔️ 攻击判定框轨道
- 🛡️ 霸体/无敌轨道
- 💨 位移轨道
- 🎯 瞄准辅助轨道

**预计开发时间**：2-3天（复用时间轴模块）

### 10.3 性能优化

- [ ] 大数据量优化（1000+动作）
- [ ] 虚拟化列表（动作列表）
- [ ] 异步加载动画
- [ ] 延迟渲染优化

---

## 附录

### A. ActionTable 字段说明

| 字段 | 类型 | 说明 | 编辑器支持 |
|------|------|------|-----------|
| actionId | int | 动作ID（唯一） | ✅ 只读 |
| actionName | string | 动作名称 | ✅ 可编辑 |
| actionType | string | 动作类型（idle/walk/skill等） | ✅ 下拉选择 |
| duration | int | 动作总帧数 | ✅ 可编辑 |
| AnimationName | string | 动画路径 | ✅ 文件选择器 |
| autoNextActionId | int | 自动下一动作ID | ✅ 可编辑 |
| keepPlayingAnim | bool | 保持播放动画 | ✅ 复选框 |
| AutoTerminate | bool | 自动终止 | ✅ 复选框 |
| Command | string | 命令 | ✅ 可编辑 |
| Priority | int | 优先级 | ✅ 滑块 |
| CancelTags | string | 主动取消标签（JSON） | ✅ 只读显示 |
| BeCancelledTags | string | 被取消标签（JSON） | ✅ 时间轴编辑 |

### B. 快捷操作指南

#### 创建新动作
1. 点击列表下方"新建"按钮
2. 自动分配唯一ID
3. 配置基础信息
4. 选择动画文件
5. 在时间轴添加事件
6. 点击"保存"

#### 编辑被取消标签
1. 选择动作
2. 在时间轴中右键点击"被取消标签"轨道
3. 选择"在帧X添加事件"
4. 在配置面板"事件详情"中编辑：
   - 标签列表（可添加/删除）
   - 融合时间
   - 优先级
5. 拖拽调整帧范围
6. 点击"保存"

#### 复制事件到另一个动作
1. 选择源动作
2. 在时间轴中选中事件
3. 右键 → "复制事件"
4. 切换到目标动作
5. 在目标帧右键 → "粘贴事件"
6. 点击"保存"

### C. 常见问题

**Q: 为什么没有 TempBeCancelledTags 轨道？**  
A: TempBeCancelledTags 是运行时数据，由技能系统动态触发，不在静态配置表中。

**Q: CancelTags 能编辑吗？**  
A: 当前版本保持只读（从CSV透传），如需编辑请在配置面板直接修改JSON字符串。

**Q: 如何调整时间轴缩放？**  
A: 当前版本默认5px/帧，后续版本将支持滚轮缩放。

**Q: 事件可以跨轨道复制吗？**  
A: 可以，粘贴时会自动转换为目标轨道类型。

---

## 开发团队

**主程**：Claude 4.0  
**架构设计**：Claude 4.0  
**UI/UX**：Claude 4.0  
**测试**：待团队测试  

---

**文档版本**: v1.0  
**最后更新**: 2025-10-09  

© Astrum Action Editor Design Document

