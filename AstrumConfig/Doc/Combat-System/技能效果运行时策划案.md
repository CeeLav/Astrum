# æŠ€èƒ½æ•ˆæœè¿è¡Œæ—¶ç­–åˆ’æ¡ˆ

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-09  
**æœ€åæ›´æ–°**: 2025-10-09  
**çŠ¶æ€**: è§„åˆ’é˜¶æ®µ  

> ğŸ“– **ç›¸å…³æ–‡æ¡£**ï¼š
> - [æŠ€èƒ½ç³»ç»Ÿç­–åˆ’æ¡ˆ](./æŠ€èƒ½ç³»ç»Ÿç­–åˆ’æ¡ˆ.md) - æŠ€èƒ½ç³»ç»Ÿä¸‰å±‚æ¶æ„è®¾è®¡
> - [åŠ¨ä½œç³»ç»Ÿç­–åˆ’æ¡ˆ](./ActionSystem/åŠ¨ä½œç³»ç»Ÿç­–åˆ’æ¡ˆ.md) - åŠ¨ä½œç³»ç»Ÿè®¾è®¡
> - [æŠ€èƒ½åŠ¨ä½œç¼–è¾‘å™¨ç­–åˆ’æ¡ˆ](../Editor-Tools/æŠ€èƒ½åŠ¨ä½œç¼–è¾‘å™¨/æŠ€èƒ½åŠ¨ä½œç¼–è¾‘å™¨ç­–åˆ’æ¡ˆ.md) - ç¼–è¾‘å™¨å·¥å…·

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
2. [è¿è¡Œæ—¶æ¶æ„](#è¿è¡Œæ—¶æ¶æ„)
3. [SkillExecutor - æŠ€èƒ½æ‰§è¡Œå™¨](#skillexecutor---æŠ€èƒ½æ‰§è¡Œå™¨)
4. [HitManager - ç¢°æ’æ£€æµ‹ç®¡ç†å™¨](#hitmanager---ç¢°æ’æ£€æµ‹ç®¡ç†å™¨)
5. [SkillEffectManager - æŠ€èƒ½æ•ˆæœç®¡ç†å™¨](#skilleffectmanager---æŠ€èƒ½æ•ˆæœç®¡ç†å™¨)
6. [DamageCalculator - ä¼¤å®³è®¡ç®—æ¨¡å—](#damagecalculator---ä¼¤å®³è®¡ç®—æ¨¡å—)
7. [æ•ˆæœå¤„ç†å™¨ä½“ç³»](#æ•ˆæœå¤„ç†å™¨ä½“ç³»)
8. [è¿è¡Œæ—¶æµç¨‹](#è¿è¡Œæ—¶æµç¨‹)
9. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)
10. [æŠ€æœ¯å®ç°è¦ç‚¹](#æŠ€æœ¯å®ç°è¦ç‚¹)
11. [é…ç½®ç¤ºä¾‹](#é…ç½®ç¤ºä¾‹)

---

## ç³»ç»Ÿæ¦‚è¿°

### 1.1 è®¾è®¡èƒŒæ™¯

æŠ€èƒ½ç³»ç»Ÿç­–åˆ’æ¡ˆå®šä¹‰äº† **Skill â†’ SkillAction â†’ SkillEffect** ä¸‰å±‚é€»è¾‘ç»“æ„ï¼Œå°†æŠ€èƒ½çš„æ¦‚å¿µã€æ‰§è¡Œå’Œæ•ˆæœå®Œå…¨åˆ†ç¦»ã€‚æœ¬æ–‡æ¡£è¿›ä¸€æ­¥è®¾è®¡ç¬¬å››å±‚ï¼š**æŠ€èƒ½æ‰§è¡Œè¿è¡Œæ—¶ï¼ˆRuntimeï¼‰å±‚**ï¼Œè´Ÿè´£åœ¨æ¸¸æˆå®é™…è¿è¡Œæ—¶å¤„ç†ç¢°æ’æ£€æµ‹ã€ä¼¤å®³è®¡ç®—å’Œç»Ÿä¸€æ•ˆæœè§¦å‘ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

- **ç¢°æ’æ£€æµ‹ç»Ÿä¸€ç®¡ç†** - é€šè¿‡HitManagerç»Ÿä¸€å¤„ç†æ‰€æœ‰æ”»å‡»ç¢°æ’ç›’
- **æ•ˆæœè§¦å‘ç»Ÿä¸€åˆ†å‘** - é€šè¿‡SkillEffectManagerç»Ÿä¸€å¤„ç†æ‰€æœ‰æŠ€èƒ½æ•ˆæœ
- **ä¼¤å®³è®¡ç®—æ¨¡å—åŒ–** - ç‹¬ç«‹çš„ä¼¤å®³è®¡ç®—æ¨¡å—ï¼Œæ˜“äºæ‰©å±•å’Œè°ƒæ•´
- **é«˜æ€§èƒ½å®æ—¶å¤„ç†** - åŒå¸§å®Œæˆæ£€æµ‹å’Œå¤„ç†ï¼Œä¿è¯å³æ—¶åé¦ˆ
- **æ‰©å±•æ€§ä¸çµæ´»æ€§** - æ”¯æŒå„ç§æ•ˆæœç±»å‹çš„æ’ä»¶å¼æ‰©å±•

### 1.3 è®¾è®¡ç†å¿µ

**æ ¸å¿ƒåŸåˆ™**ï¼šSkillActionåªè´Ÿè´£"åœ¨æ—¶é—´è½´ä¸Šè§¦å‘äº‹ä»¶"ï¼Œè¿è¡Œæ—¶å±‚è´Ÿè´£"æ‰§è¡Œäº‹ä»¶äº§ç”Ÿçš„æ•ˆæœ"

```
æ¦‚å¿µå±‚ï¼šSkillï¼ˆæŠ€èƒ½æ¦‚å¿µï¼‰
   â†“
æ‰§è¡Œå±‚ï¼šSkillActionï¼ˆåŠ¨ä½œæ—¶é—´è½´ï¼‰
   â†“
è§¦å‘å±‚ï¼šTriggerFrameï¼ˆè§¦å‘å¸§äº‹ä»¶ï¼‰
   â†“
è¿è¡Œæ—¶å±‚ï¼šSkillExecutor â†’ HitManager/SkillEffectManager â†’ DamageCalculator
   â†“
ç»“æœå±‚ï¼šæ¸¸æˆæ•ˆæœï¼ˆä¼¤å®³ã€æ²»ç–—ã€buffç­‰ï¼‰
```

---

## è¿è¡Œæ—¶æ¶æ„

### 2.1 è¿è¡Œæ—¶å±‚çº§ç»“æ„

```
æŠ€èƒ½è¿è¡Œæ—¶å±‚
â”œâ”€â”€ SkillExecutorï¼ˆæŠ€èƒ½æ‰§è¡Œå™¨ï¼‰
â”‚   â”œâ”€â”€ å¤„ç† TriggerFrame è§¦å‘æ—¶æœº
â”‚   â”œâ”€â”€ è°ƒç”¨ HitManager æ³¨å†Œæ”»å‡»ç›’
â”‚   â”œâ”€â”€ è°ƒç”¨ SkillEffectManager è§¦å‘æ•ˆæœ
â”‚   â””â”€â”€ æ§åˆ¶æ—¶åºä¸å¤šæ®µæ•ˆæœ
â”‚
â”œâ”€â”€ HitManagerï¼ˆç¢°æ’æ£€æµ‹ç®¡ç†å™¨ï¼‰
â”‚   â”œâ”€â”€ ç®¡ç†å½“å‰æ´»åŠ¨æ”»å‡»ç›’ï¼ˆHitBoxï¼‰
â”‚   â”œâ”€â”€ ç¢°æ’æ£€æµ‹ä¸å‘½ä¸­ç¼“å­˜
â”‚   â”œâ”€â”€ é˜²é‡å¤å‘½ä¸­é€»è¾‘
â”‚   â””â”€â”€ è¾“å‡ºå‘½ä¸­äº‹ä»¶
â”‚
â”œâ”€â”€ SkillEffectManagerï¼ˆæŠ€èƒ½æ•ˆæœç®¡ç†å™¨ï¼‰
â”‚   â”œâ”€â”€ ç»Ÿä¸€æ¥æ”¶æ•ˆæœè§¦å‘è¯·æ±‚
â”‚   â”œâ”€â”€ è°ƒç”¨å…·ä½“ EffectHandler
â”‚   â”œâ”€â”€ ç®¡ç†è·¨å¸§/å»¶è¿Ÿæ•ˆæœ
â”‚   â””â”€â”€ é˜Ÿåˆ—åŒ–å¤„ç†æ•ˆæœ
â”‚
â”œâ”€â”€ DamageCalculatorï¼ˆä¼¤å®³è®¡ç®—æ¨¡å—ï¼‰
â”‚   â”œâ”€â”€ è¯»å– SkillEffect é…ç½®
â”‚   â”œâ”€â”€ è¯»å–è§’è‰²å±æ€§
â”‚   â”œâ”€â”€ è®¡ç®—æœ€ç»ˆæ•°å€¼ï¼ˆå«æš´å‡»ã€åŠ æˆã€å‡å…ï¼‰
â”‚   â””â”€â”€ è¾“å‡º DamageResultï¼ˆä¼¤å®³ç»“æœï¼‰
â”‚
â””â”€â”€ EffectHandlersï¼ˆæ•ˆæœå¤„ç†å™¨é›†åˆï¼‰
    â”œâ”€â”€ DamageEffectHandlerï¼ˆä¼¤å®³ï¼‰
    â”œâ”€â”€ HealEffectHandlerï¼ˆæ²»ç–—ï¼‰
    â”œâ”€â”€ KnockbackEffectHandlerï¼ˆå‡»é€€ï¼‰
    â”œâ”€â”€ BuffEffectHandlerï¼ˆå¢ç›Šï¼‰
    â””â”€â”€ DebuffEffectHandlerï¼ˆå‡ç›Šï¼‰
```

### 2.2 æ¨¡å—èŒè´£åˆ†å·¥

| æ¨¡å— | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|-----|------|------|------|
| SkillExecutor | æŠ€èƒ½æ‰§è¡Œè°ƒåº¦ | SkillAction + TriggerFrame | HitBoxæ³¨å†Œ / SkillEffectè¯·æ±‚ |
| HitManager | ç¢°æ’æ£€æµ‹ | HitBoxæ•°æ® + ä¸–ç•ŒçŠ¶æ€ | å‘½ä¸­Entityåˆ—è¡¨ |
| SkillEffectManager | æ•ˆæœåˆ†å‘ | SkillEffectè¯·æ±‚ | è°ƒç”¨EffectHandler |
| DamageCalculator | ä¼¤å®³è®¡ç®— | æ–½æ³•è€…/ç›®æ ‡å±æ€§ + æ•ˆæœé…ç½® | DamageResult |
| EffectHandler | æ•ˆæœæ‰§è¡Œ | SkillEffectData + Entity | ä¿®æ”¹EntityçŠ¶æ€ |

### 2.3 æ•°æ®æµå‘

```
SkillAction æ‰§è¡Œåˆ° TriggerFrame
    â†“
SkillExecutor è§£æè§¦å‘ç±»å‹
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Collisionâ”‚   Direct    â”‚  Condition   â”‚
â”‚ ç¢°æ’è§¦å‘  â”‚  ç›´æ¥è§¦å‘    â”‚  æ¡ä»¶è§¦å‘     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“              â†“             â†“
HitManager    SkillEffect   äº‹ä»¶ç›‘å¬å™¨
    â†“              â†“             â†“
  æ£€æµ‹ç¢°æ’         â†“           ç­‰å¾…æ¡ä»¶
    â†“              â†“             â†“
å‘½ä¸­Entityåˆ—è¡¨ â”€â”€â†’ SkillEffectManager â†â”€â”˜
                   â†“
           æŸ¥è¯¢ EffectType
                   â†“
           è°ƒç”¨å¯¹åº” Handler
                   â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   Damage        Heal        Buff
      â†“            â†“            â†“
DamageCalculator  ä¿®æ”¹HP      æ·»åŠ Buffç»„ä»¶
      â†“
  åº”ç”¨ä¼¤å®³åˆ°ç›®æ ‡
```

---

## SkillExecutor - æŠ€èƒ½æ‰§è¡Œå™¨

### 3.1 æ ¸å¿ƒèŒè´£

SkillExecutor æ˜¯æŠ€èƒ½æ‰§è¡Œçš„ç»Ÿä¸€å…¥å£ï¼Œè´Ÿè´£ï¼š
1. ç›‘å¬ SkillAction çš„å¸§æ›´æ–°
2. æ£€æŸ¥å¹¶å¤„ç†å½“å‰å¸§çš„æ‰€æœ‰ TriggerFrame
3. æ ¹æ®è§¦å‘ç±»å‹è°ƒç”¨å¯¹åº”çš„å¤„ç†æ¨¡å—

### 3.2 æ ¸å¿ƒç»“æ„

```csharp
public class SkillExecutor
{
    private readonly HitManager _hitManager;
    private readonly SkillEffectManager _effectManager;
    
    /// <summary>
    /// å¤„ç†æŠ€èƒ½åŠ¨ä½œçš„å½“å‰å¸§
    /// </summary>
    public void ProcessFrame(Entity caster, SkillActionInfo actionInfo, int currentFrame)
    {
        // è·å–å½“å‰å¸§çš„æ‰€æœ‰è§¦å‘äº‹ä»¶
        var triggers = actionInfo.GetTriggersAtFrame(currentFrame);
        
        foreach (var trigger in triggers)
        {
            switch (trigger.TriggerType)
            {
                case TriggerType.Collision:
                    HandleCollisionTrigger(caster, actionInfo, trigger);
                    break;
                    
                case TriggerType.Direct:
                    HandleDirectTrigger(caster, trigger);
                    break;
                    
                case TriggerType.Condition:
                    RegisterConditionTrigger(caster, trigger);
                    break;
            }
        }
    }
    
    /// <summary>
    /// å¤„ç†ç¢°æ’è§¦å‘
    /// </summary>
    private void HandleCollisionTrigger(Entity caster, SkillActionInfo actionInfo, TriggerFrameInfo trigger)
    {
        // ä»é…ç½®ä¸­è§£ææ”»å‡»ç›’æ•°æ®
        var hitBoxes = ParseAttackBoxInfo(actionInfo.AttackBoxInfo);
        
        foreach (var hitBox in hitBoxes)
        {
            // æ³¨å†Œåˆ° HitManager
            _hitManager.RegisterHitBox(new HitBoxInstance
            {
                Owner = caster,
                BoxData = hitBox,
                StartFrame = trigger.Frame,
                EndFrame = trigger.Frame + hitBox.Duration,
                EffectId = trigger.EffectId,
                OnHit = (target) => TriggerSkillEffect(caster, target, trigger.EffectId)
            });
        }
    }
    
    /// <summary>
    /// å¤„ç†ç›´æ¥è§¦å‘
    /// </summary>
    private void HandleDirectTrigger(Entity caster, TriggerFrameInfo trigger)
    {
        // ç›´æ¥è§¦å‘æ•ˆæœï¼Œæ— éœ€ç¢°æ’æ£€æµ‹
        TriggerSkillEffect(caster, caster, trigger.EffectId);
    }
    
    /// <summary>
    /// è§¦å‘æŠ€èƒ½æ•ˆæœ
    /// </summary>
    private void TriggerSkillEffect(Entity caster, Entity target, int effectId)
    {
        _effectManager.QueueSkillEffect(new SkillEffectData
        {
            CasterEntity = caster,
            TargetEntity = target,
            EffectId = effectId
        });
    }
}
```

### 3.3 è§¦å‘ç±»å‹å¤„ç†

| è§¦å‘ç±»å‹ | å¤„ç†æ–¹å¼ | ä½¿ç”¨åœºæ™¯ |
|---------|---------|---------|
| **Collision** | æ³¨å†ŒHitBoxåˆ°HitManager | è¿‘æˆ˜æ”»å‡»ã€å†²åˆºæŠ€èƒ½ |
| **Direct** | ç›´æ¥è°ƒç”¨SkillEffectManager | è‡ªèº«buffã€è¿œç¨‹ç”Ÿæˆå¼¹é“ |
| **Condition** | æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ | å‘½ä¸­åè§¦å‘ã€è¿å‡»è§¦å‘ |

### 3.4 æ—¶åºæ§åˆ¶

```csharp
// SkillAction æ¯å¸§æ›´æ–°æ—¶è°ƒç”¨
public void Update(int currentFrame)
{
    // 1. SkillExecutor å¤„ç†è§¦å‘å¸§
    SkillExecutor.ProcessFrame(owner, skillActionInfo, currentFrame);
    
    // 2. HitManager æ‰§è¡Œç¢°æ’æ£€æµ‹ï¼ˆåŒå¸§ï¼‰
    HitManager.Update(currentFrame);
    
    // 3. SkillEffectManager å¤„ç†æ•ˆæœé˜Ÿåˆ—ï¼ˆåŒå¸§ï¼‰
    SkillEffectManager.Update();
}
```

**è®¾è®¡è¦ç‚¹**ï¼šæ‰€æœ‰å¤„ç†åœ¨åŒå¸§å†…å®Œæˆï¼Œä¿è¯å³æ—¶åé¦ˆã€‚

---

## HitManager - ç¢°æ’æ£€æµ‹ç®¡ç†å™¨

### 4.1 æ ¸å¿ƒèŒè´£

HitManager æ˜¯æ‰€æœ‰æ”»å‡»ç›’çš„ç»Ÿä¸€è°ƒåº¦ä¸­å¿ƒï¼Œè´Ÿè´£ï¼š
1. ç®¡ç†å½“å‰æ´»åŠ¨çš„æ‰€æœ‰ HitBox å®ä¾‹
2. æ¯å¸§æ‰§è¡Œç¢°æ’æ£€æµ‹
3. é˜²é‡å¤å‘½ä¸­åŒä¸€ç›®æ ‡
4. è¾“å‡ºå‘½ä¸­äº‹ä»¶

### 4.2 æ ¸å¿ƒç»“æ„

```csharp
public class HitManager
{
    private readonly List<HitBoxInstance> _activeHitBoxes = new();
    
    /// <summary>
    /// æ³¨å†Œä¸€ä¸ªæ”»å‡»ç›’
    /// </summary>
    public void RegisterHitBox(HitBoxInstance hitBoxInstance)
    {
        _activeHitBoxes.Add(hitBoxInstance);
    }
    
    /// <summary>
    /// æ¯å¸§æ›´æ–°ï¼šæ‰§è¡Œç¢°æ’æ£€æµ‹
    /// </summary>
    public void Update(int currentFrame)
    {
        for (int i = _activeHitBoxes.Count - 1; i >= 0; i--)
        {
            var hitBox = _activeHitBoxes[i];
            
            // æ£€æŸ¥æ˜¯å¦åœ¨æ¿€æ´»æ—¶é—´å†…
            if (currentFrame < hitBox.StartFrame || currentFrame > hitBox.EndFrame)
            {
                if (currentFrame > hitBox.EndFrame)
                {
                    _activeHitBoxes.RemoveAt(i);
                }
                continue;
            }
            
            // æ‰§è¡Œç¢°æ’æ£€æµ‹
            var hits = DetectCollision(hitBox);
            
            foreach (var target in hits)
            {
                // é˜²é‡å¤å‘½ä¸­
                if (!hitBox.HasHit(target))
                {
                    hitBox.RecordHit(target);
                    
                    // è§¦å‘å‘½ä¸­å›è°ƒ
                    hitBox.OnHit?.Invoke(target);
                }
            }
        }
    }
    
    /// <summary>
    /// ç¢°æ’æ£€æµ‹ï¼ˆæ ¹æ®å‡ ä½•å½¢çŠ¶ï¼‰
    /// </summary>
    private IEnumerable<Entity> DetectCollision(HitBoxInstance hitBox)
    {
        // è®¡ç®—ä¸–ç•Œåæ ‡ä¸‹çš„æ”»å‡»ç›’ä½ç½®
        var worldCenter = hitBox.Owner.Transform.position + hitBox.BoxData.Offset;
        var worldRotation = hitBox.Owner.Transform.rotation;
        
        // æ ¹æ®å½¢çŠ¶ç±»å‹æ‰§è¡Œæ£€æµ‹
        switch (hitBox.BoxData.ShapeType)
        {
            case HitBoxShape.Box:
                return PhysicsWorld.OverlapBox(
                    worldCenter, 
                    hitBox.BoxData.Size, 
                    worldRotation,
                    LayerMask.GetMask("Enemy")
                );
                
            case HitBoxShape.Sphere:
                return PhysicsWorld.OverlapSphere(
                    worldCenter, 
                    hitBox.BoxData.Radius,
                    LayerMask.GetMask("Enemy")
                );
                
            case HitBoxShape.Capsule:
                return PhysicsWorld.OverlapCapsule(
                    worldCenter, 
                    hitBox.BoxData.Height,
                    hitBox.BoxData.Radius,
                    LayerMask.GetMask("Enemy")
                );
                
            default:
                return Enumerable.Empty<Entity>();
        }
    }
}
```

### 4.3 HitBox æ•°æ®ç»“æ„

```csharp
/// <summary>
/// æ”»å‡»ç›’å®ä¾‹ï¼ˆè¿è¡Œæ—¶ï¼‰
/// </summary>
public class HitBoxInstance
{
    public Entity Owner;                    // æ”»å‡»å‘èµ·è€…
    public HitBoxData BoxData;              // æ”»å‡»ç›’é…ç½®æ•°æ®
    public int StartFrame;                  // æ¿€æ´»èµ·å§‹å¸§
    public int EndFrame;                    // æ¿€æ´»ç»“æŸå¸§
    public int EffectId;                    // å…³è”çš„æŠ€èƒ½æ•ˆæœID
    public Action<Entity> OnHit;            // å‘½ä¸­å›è°ƒ
    
    private readonly HashSet<Entity> _hitTargets = new();
    
    public bool HasHit(Entity target) => _hitTargets.Contains(target);
    public void RecordHit(Entity target) => _hitTargets.Add(target);
}

/// <summary>
/// æ”»å‡»ç›’é…ç½®æ•°æ®ï¼ˆæ¥è‡ªè¡¨æ ¼ï¼‰
/// </summary>
public class HitBoxData
{
    public HitBoxShape ShapeType;           // å½¢çŠ¶ç±»å‹ï¼ˆBox/Sphere/Capsuleï¼‰
    public Vector3 Offset;                  // ç›¸å¯¹äºè§’è‰²çš„åç§»
    public Vector3 Size;                    // å°ºå¯¸ï¼ˆBoxï¼‰
    public float Radius;                    // åŠå¾„ï¼ˆSphere/Capsuleï¼‰
    public float Height;                    // é«˜åº¦ï¼ˆCapsuleï¼‰
    public int Duration;                    // æŒç»­å¸§æ•°
}

public enum HitBoxShape
{
    Box = 1,
    Sphere = 2,
    Capsule = 3
}
```

### 4.4 é˜²é‡å¤å‘½ä¸­æœºåˆ¶

**æ ¸å¿ƒåŸç†**ï¼šæ¯ä¸ª HitBoxInstance ç»´æŠ¤ä¸€ä¸ª `_hitTargets` é›†åˆï¼Œè®°å½•å·²å‘½ä¸­çš„Entityã€‚

**ä¼˜åŠ¿**ï¼š
- åŒä¸€æ”»å‡»ç›’ä¸ä¼šé‡å¤å‘½ä¸­åŒä¸€ç›®æ ‡
- æ”¯æŒå¤šæ®µæ”»å‡»ï¼ˆä¸åŒHitBoxå®ä¾‹å¯ä»¥å‘½ä¸­åŒä¸€ç›®æ ‡ï¼‰
- è½»é‡çº§å®ç°ï¼Œæ— æ€§èƒ½è´Ÿæ‹…

### 4.5 æ”»å‡»ç›’è§£æ

ä» `AttackBoxInfo` å­—ç¬¦ä¸²è§£æä¸º `HitBoxData` åˆ—è¡¨ï¼š

```csharp
/// <summary>
/// è§£ææ”»å‡»ç›’ä¿¡æ¯å­—ç¬¦ä¸²
/// æ ¼å¼ï¼š"Box1:5x2x1:10,Sphere1:3:15"
/// </summary>
public static List<HitBoxData> ParseAttackBoxInfo(string attackBoxInfo)
{
    var result = new List<HitBoxData>();
    if (string.IsNullOrEmpty(attackBoxInfo)) return result;
    
    var boxes = attackBoxInfo.Split(',');
    foreach (var boxStr in boxes)
    {
        var parts = boxStr.Split(':');
        if (parts.Length < 3) continue;
        
        var name = parts[0];
        var sizeStr = parts[1];
        var duration = int.Parse(parts[2]);
        
        HitBoxData boxData = null;
        
        // Boxç±»å‹ï¼š5x2x1
        if (sizeStr.Contains('x'))
        {
            var sizes = sizeStr.Split('x').Select(float.Parse).ToArray();
            boxData = new HitBoxData
            {
                ShapeType = HitBoxShape.Box,
                Size = new Vector3(sizes[0], sizes[1], sizes[2]),
                Duration = duration
            };
        }
        // Sphereç±»å‹ï¼š3
        else
        {
            boxData = new HitBoxData
            {
                ShapeType = HitBoxShape.Sphere,
                Radius = float.Parse(sizeStr),
                Duration = duration
            };
        }
        
        if (boxData != null)
        {
            result.Add(boxData);
        }
    }
    
    return result;
}
```

---

## SkillEffectManager - æŠ€èƒ½æ•ˆæœç®¡ç†å™¨

### 5.1 æ ¸å¿ƒèŒè´£

SkillEffectManager æ˜¯æ‰€æœ‰æŠ€èƒ½æ•ˆæœçš„ç»Ÿä¸€å¤„ç†ä¸­å¿ƒï¼Œè´Ÿè´£ï¼š
1. æ¥æ”¶æ¥è‡ªå„å¤„çš„æ•ˆæœè§¦å‘è¯·æ±‚
2. é˜Ÿåˆ—åŒ–ç®¡ç†æ•ˆæœæ‰§è¡Œ
3. æ ¹æ® EffectType è°ƒç”¨å¯¹åº”çš„ Handler
4. æ”¯æŒå³æ—¶å’Œå»¶è¿Ÿæ•ˆæœ

### 5.2 æ ¸å¿ƒç»“æ„

```csharp
public class SkillEffectManager
{
    private static SkillEffectManager _instance;
    public static SkillEffectManager Instance => _instance ??= new SkillEffectManager();
    
    private readonly Queue<SkillEffectData> _effectQueue = new();
    private readonly Dictionary<int, ISkillEffectHandler> _handlers = new();
    
    /// <summary>
    /// æ³¨å†Œæ•ˆæœå¤„ç†å™¨
    /// </summary>
    public void RegisterHandler(int effectType, ISkillEffectHandler handler)
    {
        _handlers[effectType] = handler;
    }
    
    /// <summary>
    /// åŠ å…¥æ•ˆæœé˜Ÿåˆ—
    /// </summary>
    public void QueueSkillEffect(SkillEffectData effectData)
    {
        _effectQueue.Enqueue(effectData);
    }
    
    /// <summary>
    /// æ¯å¸§æ›´æ–°ï¼šå¤„ç†æ•ˆæœé˜Ÿåˆ—
    /// </summary>
    public void Update()
    {
        while (_effectQueue.Count > 0)
        {
            var effectData = _effectQueue.Dequeue();
            ProcessEffect(effectData);
        }
    }
    
    /// <summary>
    /// å¤„ç†å•ä¸ªæ•ˆæœ
    /// </summary>
    private void ProcessEffect(SkillEffectData effectData)
    {
        // ä»é…ç½®è¡¨è¯»å–æ•ˆæœé…ç½®
        var effectConfig = SkillConfigManager.GetSkillEffect(effectData.EffectId);
        if (effectConfig == null)
        {
            Debug.LogError($"æœªæ‰¾åˆ°æŠ€èƒ½æ•ˆæœé…ç½®: {effectData.EffectId}");
            return;
        }
        
        // è·å–å¯¹åº”çš„å¤„ç†å™¨
        if (!_handlers.TryGetValue(effectConfig.EffectType, out var handler))
        {
            Debug.LogError($"æœªæ³¨å†Œæ•ˆæœç±»å‹å¤„ç†å™¨: {effectConfig.EffectType}");
            return;
        }
        
        // æ‰§è¡Œæ•ˆæœ
        handler.Handle(effectData.CasterEntity, effectData.TargetEntity, effectConfig);
    }
}
```

### 5.3 æ•ˆæœæ•°æ®ç»“æ„

```csharp
/// <summary>
/// æŠ€èƒ½æ•ˆæœæ•°æ®ï¼ˆè¿è¡Œæ—¶ï¼‰
/// </summary>
public class SkillEffectData
{
    public Entity CasterEntity;             // æ–½æ³•è€…
    public Entity TargetEntity;             // ç›®æ ‡
    public int EffectId;                    // æŠ€èƒ½æ•ˆæœID
}

/// <summary>
/// æŠ€èƒ½æ•ˆæœé…ç½®ï¼ˆæ¥è‡ªè¡¨æ ¼ï¼‰
/// </summary>
public class SkillEffectConfig
{
    public int SkillEffectId;               // æ•ˆæœID
    public int EffectType;                  // æ•ˆæœç±»å‹
    public float EffectValue;               // æ•ˆæœæ•°å€¼
    public int TargetType;                  // ç›®æ ‡ç±»å‹
    public float EffectDuration;            // æŒç»­æ—¶é—´
    public float EffectRange;               // æ•ˆæœèŒƒå›´
    public string EffectParams;             // æ•ˆæœå‚æ•°ï¼ˆJSONï¼‰
    public int VisualEffectId;              // è§†è§‰æ•ˆæœID
    public int SoundEffectId;               // éŸ³æ•ˆID
}
```

### 5.4 æ•ˆæœç±»å‹å®šä¹‰

| EffectType | åç§° | å¤„ç†å™¨ | è¯´æ˜ |
|-----------|------|--------|------|
| 1 | ä¼¤å®³ | DamageEffectHandler | é€ æˆä¼¤å®³ |
| 2 | æ²»ç–— | HealEffectHandler | æ¢å¤ç”Ÿå‘½å€¼ |
| 3 | å‡»é€€ | KnockbackEffectHandler | å‡»é€€ç›®æ ‡ |
| 4 | Buff | BuffEffectHandler | æ·»åŠ å¢ç›Šæ•ˆæœ |
| 5 | Debuff | DebuffEffectHandler | æ·»åŠ å‡ç›Šæ•ˆæœ |
| 6 | ä½ç§» | DisplacementEffectHandler | ç§»åŠ¨ç›®æ ‡ä½ç½® |
| 7 | å¬å”¤ | SummonEffectHandler | å¬å”¤å•ä½ |

### 5.5 åˆå§‹åŒ–æ³¨å†Œ

```csharp
public void Initialize()
{
    // æ³¨å†Œæ‰€æœ‰æ•ˆæœå¤„ç†å™¨
    RegisterHandler(1, new DamageEffectHandler());
    RegisterHandler(2, new HealEffectHandler());
    RegisterHandler(3, new KnockbackEffectHandler());
    RegisterHandler(4, new BuffEffectHandler());
    RegisterHandler(5, new DebuffEffectHandler());
    RegisterHandler(6, new DisplacementEffectHandler());
    RegisterHandler(7, new SummonEffectHandler());
}
```

---

## DamageCalculator - ä¼¤å®³è®¡ç®—æ¨¡å—

### 6.1 æ ¸å¿ƒèŒè´£

DamageCalculator æ˜¯ç‹¬ç«‹çš„ä¼¤å®³è®¡ç®—æ¨¡å—ï¼Œè´Ÿè´£ï¼š
1. è¯»å–æ–½æ³•è€…å’Œç›®æ ‡çš„å±æ€§
2. è¯»å–æŠ€èƒ½æ•ˆæœé…ç½®
3. è®¡ç®—åŸºç¡€ä¼¤å®³
4. åº”ç”¨æš´å‡»ã€åŠ æˆã€å‡å…ç­‰ä¿®æ­£
5. è¾“å‡ºæœ€ç»ˆä¼¤å®³ç»“æœ

### 6.2 æ ¸å¿ƒç»“æ„

```csharp
public static class DamageCalculator
{
    /// <summary>
    /// è®¡ç®—ä¼¤å®³
    /// </summary>
    public static DamageResult Calculate(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        var casterStats = caster.GetComponent<StatComponent>();
        var targetStats = target.GetComponent<StatComponent>();
        
        // 1. è®¡ç®—åŸºç¡€ä¼¤å®³
        float baseDamage = CalculateBaseDamage(casterStats, effectConfig);
        
        // 2. æš´å‡»åˆ¤å®š
        bool isCritical = CheckCritical(casterStats);
        if (isCritical)
        {
            baseDamage *= casterStats.CritDamageMultiplier;
        }
        
        // 3. åº”ç”¨é˜²å¾¡å‡å…
        float finalDamage = ApplyDefense(baseDamage, targetStats);
        
        // 4. åº”ç”¨å±æ€§å…‹åˆ¶
        finalDamage = ApplyElementalModifier(finalDamage, casterStats, targetStats, effectConfig);
        
        // 5. åº”ç”¨éšæœºæµ®åŠ¨
        finalDamage = ApplyRandomVariance(finalDamage);
        
        // 6. ç¡®ä¿ä¼¤å®³éè´Ÿ
        finalDamage = Mathf.Max(0, finalDamage);
        
        return new DamageResult
        {
            FinalDamage = finalDamage,
            IsCritical = isCritical,
            DamageType = ParseDamageType(effectConfig.EffectParams)
        };
    }
    
    /// <summary>
    /// è®¡ç®—åŸºç¡€ä¼¤å®³
    /// </summary>
    private static float CalculateBaseDamage(StatComponent casterStats, SkillEffectConfig effectConfig)
    {
        // EffectValue é€šå¸¸æ˜¯ç™¾åˆ†æ¯”ï¼ˆå¦‚150è¡¨ç¤º150%æ”»å‡»åŠ›ï¼‰
        float ratio = effectConfig.EffectValue / 100f;
        return casterStats.Attack * ratio;
    }
    
    /// <summary>
    /// æš´å‡»åˆ¤å®š
    /// </summary>
    private static bool CheckCritical(StatComponent casterStats)
    {
        return Random.value < casterStats.CritRate;
    }
    
    /// <summary>
    /// åº”ç”¨é˜²å¾¡å‡å…
    /// </summary>
    private static float ApplyDefense(float baseDamage, StatComponent targetStats)
    {
        // ç®€å•çš„é˜²å¾¡å…¬å¼ï¼šä¼¤å®³ - (é˜²å¾¡ * 0.5)
        // å¯ä»¥æ›¿æ¢ä¸ºæ›´å¤æ‚çš„å…¬å¼
        float reduction = targetStats.Defense * 0.5f;
        return baseDamage - reduction;
    }
    
    /// <summary>
    /// åº”ç”¨å±æ€§å…‹åˆ¶
    /// </summary>
    private static float ApplyElementalModifier(float damage, StatComponent casterStats, StatComponent targetStats, SkillEffectConfig effectConfig)
    {
        // è§£æä¼¤å®³ç±»å‹
        var damageType = ParseDamageType(effectConfig.EffectParams);
        
        // æ ¹æ®å±æ€§å…‹åˆ¶å…³ç³»è°ƒæ•´ä¼¤å®³
        float multiplier = GetElementalMultiplier(casterStats.Element, targetStats.Element);
        return damage * multiplier;
    }
    
    /// <summary>
    /// åº”ç”¨éšæœºæµ®åŠ¨ï¼ˆÂ±5%ï¼‰
    /// </summary>
    private static float ApplyRandomVariance(float damage)
    {
        float variance = Random.Range(0.95f, 1.05f);
        return damage * variance;
    }
}
```

### 6.3 ä¼¤å®³ç»“æœ

```csharp
/// <summary>
/// ä¼¤å®³ç»“æœ
/// </summary>
public class DamageResult
{
    public float FinalDamage;               // æœ€ç»ˆä¼¤å®³
    public bool IsCritical;                 // æ˜¯å¦æš´å‡»
    public DamageType DamageType;           // ä¼¤å®³ç±»å‹
}

public enum DamageType
{
    Physical = 1,                           // ç‰©ç†ä¼¤å®³
    Magical = 2,                            // é­”æ³•ä¼¤å®³
    True = 3                                // çœŸå®ä¼¤å®³ï¼ˆæ— è§†é˜²å¾¡ï¼‰
}
```

### 6.4 ä¼¤å®³å…¬å¼å¯è§†åŒ–

```
åŸºç¡€ä¼¤å®³ = æ”»å‡»åŠ› Ã— æŠ€èƒ½å€ç‡(%)
    â†“
æš´å‡»åˆ¤å®šï¼šè‹¥è§¦å‘ â†’ åŸºç¡€ä¼¤å®³ Ã— æš´å‡»å€ç‡
    â†“
é˜²å¾¡å‡å…ï¼šä¼¤å®³ - (é˜²å¾¡ Ã— 0.5)
    â†“
å±æ€§å…‹åˆ¶ï¼šä¼¤å®³ Ã— å…‹åˆ¶ç³»æ•°(0.5 / 1.0 / 2.0)
    â†“
éšæœºæµ®åŠ¨ï¼šä¼¤å®³ Ã— [0.95, 1.05]
    â†“
æœ€ç»ˆä¼¤å®³ = Max(0, ç»“æœ)
```

---

## æ•ˆæœå¤„ç†å™¨ä½“ç³»

### 7.1 å¤„ç†å™¨æ¥å£

```csharp
/// <summary>
/// æŠ€èƒ½æ•ˆæœå¤„ç†å™¨æ¥å£
/// </summary>
public interface ISkillEffectHandler
{
    void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig);
}
```

### 7.2 ä¼¤å®³å¤„ç†å™¨

```csharp
public class DamageEffectHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        // 1. è®¡ç®—ä¼¤å®³
        var damageResult = DamageCalculator.Calculate(caster, target, effectConfig);
        
        // 2. åº”ç”¨ä¼¤å®³åˆ°ç›®æ ‡
        var healthComponent = target.GetComponent<HealthComponent>();
        healthComponent.CurrentHP -= damageResult.FinalDamage;
        
        // 3. è§¦å‘ä¼¤å®³äº‹ä»¶
        EventSystem.Trigger(new DamageEvent
        {
            Caster = caster,
            Target = target,
            Damage = damageResult.FinalDamage,
            IsCritical = damageResult.IsCritical
        });
        
        // 4. æ’­æ”¾è§†è§‰æ•ˆæœ
        if (effectConfig.VisualEffectId > 0)
        {
            EffectManager.PlayEffect(effectConfig.VisualEffectId, target.Transform.position);
        }
        
        // 5. æ’­æ”¾éŸ³æ•ˆ
        if (effectConfig.SoundEffectId > 0)
        {
            AudioManager.PlaySound(effectConfig.SoundEffectId);
        }
    }
}
```

### 7.3 æ²»ç–—å¤„ç†å™¨

```csharp
public class HealEffectHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        var healthComponent = target.GetComponent<HealthComponent>();
        var healAmount = effectConfig.EffectValue;
        
        healthComponent.CurrentHP = Mathf.Min(
            healthComponent.MaxHP, 
            healthComponent.CurrentHP + healAmount
        );
        
        EventSystem.Trigger(new HealEvent
        {
            Caster = caster,
            Target = target,
            HealAmount = healAmount
        });
    }
}
```

### 7.4 å‡»é€€å¤„ç†å™¨

```csharp
public class KnockbackEffectHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        // è§£æå‡»é€€å‚æ•°
        var knockbackParams = JsonUtility.FromJson<KnockbackParams>(effectConfig.EffectParams);
        
        // è®¡ç®—å‡»é€€æ–¹å‘
        Vector3 direction = (target.Transform.position - caster.Transform.position).normalized;
        
        // åº”ç”¨å‡»é€€åŠ›
        var movementComponent = target.GetComponent<MovementComponent>();
        movementComponent.ApplyForce(direction * knockbackParams.Force, knockbackParams.Duration);
        
        EventSystem.Trigger(new KnockbackEvent
        {
            Caster = caster,
            Target = target,
            Force = knockbackParams.Force
        });
    }
}

public class KnockbackParams
{
    public float Force;                     // å‡»é€€åŠ›åº¦
    public float Duration;                  // æŒç»­æ—¶é—´
}
```

### 7.5 Buffå¤„ç†å™¨

```csharp
public class BuffEffectHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        var buffParams = JsonUtility.FromJson<BuffParams>(effectConfig.EffectParams);
        
        var buffComponent = target.GetComponent<BuffComponent>();
        buffComponent.AddBuff(new BuffInstance
        {
            BuffId = buffParams.BuffId,
            Duration = effectConfig.EffectDuration,
            StackCount = 1,
            Caster = caster
        });
    }
}

public class BuffParams
{
    public int BuffId;                      // Buff ID
    public bool Stackable;                  // æ˜¯å¦å¯å åŠ 
}
```

---

## è¿è¡Œæ—¶æµç¨‹

### 8.1 åŒå¸§æ‰§è¡Œæµç¨‹

```
å½“å‰å¸§å¼€å§‹
    â†“
1. æ‰€æœ‰ SkillCapability æ›´æ–°
    â”œâ”€ æ‰§è¡Œå½“å‰æŠ€èƒ½åŠ¨ä½œé€»è¾‘
    â””â”€ æ›´æ–°åŠ¨ä½œå¸§è®¡æ•°
    â†“
2. SkillExecutor å¤„ç†è§¦å‘å¸§
    â”œâ”€ æ£€æŸ¥å½“å‰å¸§æ˜¯å¦æœ‰è§¦å‘äº‹ä»¶
    â”œâ”€ Collision â†’ HitManager.RegisterHitBox
    â””â”€ Direct â†’ SkillEffectManager.QueueEffect
    â†“
3. HitManager.Update()
    â”œâ”€ éå†æ‰€æœ‰æ´»åŠ¨ HitBox
    â”œâ”€ æ‰§è¡Œç¢°æ’æ£€æµ‹
    â””â”€ å‘½ä¸­ â†’ SkillEffectManager.QueueEffect
    â†“
4. SkillEffectManager.Update()
    â”œâ”€ å¤„ç†æ•ˆæœé˜Ÿåˆ—
    â”œâ”€ è°ƒç”¨å¯¹åº” EffectHandler
    â””â”€ DamageCalculator / BuffSystem / etc.
    â†“
5. åº”ç”¨ç»“æœåˆ°æ¸¸æˆä¸–ç•Œ
    â”œâ”€ ä¿®æ”¹ HP
    â”œâ”€ æ·»åŠ  Buff
    â””â”€ è§¦å‘äº‹ä»¶
    â†“
å½“å‰å¸§ç»“æŸ
```

### 8.2 å¤šæ®µæŠ€èƒ½ç¤ºä¾‹

**åœºæ™¯**ï¼šå‰‘å£«çš„"ä¸‰è¿æ–©"æŠ€èƒ½

**SkillActionTableé…ç½®**ï¼š
```
TriggerFrames: "Frame5:Collision:4001,Frame15:Collision:4002,Frame25:Collision:4003"
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
Frame 5:
    â†’ SkillExecutor è§¦å‘ Collision(4001)
    â†’ HitManager æ³¨å†Œ HitBox1
    â†’ æ£€æµ‹åˆ°æ•ŒäººAã€B
    â†’ å¯¹Aã€Båˆ†åˆ«è§¦å‘ SkillEffect(4001)
    â†’ DamageCalculator è®¡ç®—ä¼¤å®³
    â†’ åº”ç”¨ä¼¤å®³

Frame 15:
    â†’ SkillExecutor è§¦å‘ Collision(4002)
    â†’ HitManager æ³¨å†Œ HitBox2
    â†’ æ£€æµ‹åˆ°æ•ŒäººAã€C
    â†’ å¯¹Aã€Cåˆ†åˆ«è§¦å‘ SkillEffect(4002)
    â†’ åº”ç”¨ä¼¤å®³

Frame 25:
    â†’ SkillExecutor è§¦å‘ Collision(4003)
    â†’ HitManager æ³¨å†Œ HitBox3
    â†’ æ£€æµ‹åˆ°æ•ŒäººB
    â†’ å¯¹Bè§¦å‘ SkillEffect(4003)
    â†’ åº”ç”¨ä¼¤å®³
```

**å…³é”®ç‚¹**ï¼š
- æ¯ä¸ª HitBox ç‹¬ç«‹ç®¡ç†å‘½ä¸­è®°å½•
- åŒä¸€æ•Œäººå¯ä»¥è¢«ä¸åŒé˜¶æ®µçš„æ”»å‡»å‘½ä¸­
- æ‰€æœ‰æ£€æµ‹åœ¨è§¦å‘å¸§å½“å¸§å®Œæˆ

### 8.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

| ä¼˜åŒ–ç‚¹ | ç­–ç•¥ | æ•ˆæœ |
|-------|------|------|
| ç¢°æ’æ£€æµ‹ | ç©ºé—´åˆ†åŒºï¼ˆå¦‚å››å‰æ ‘ï¼‰ | å‡å°‘æ£€æµ‹æ¬¡æ•° |
| æ•ˆæœé˜Ÿåˆ— | å¯¹è±¡æ±  | å‡å°‘GC |
| é…ç½®è¯»å– | ç¼“å­˜é…ç½®æ•°æ® | é¿å…é‡å¤æŸ¥è¯¢ |
| ä¼¤å®³è®¡ç®— | é¢„è®¡ç®—å±æ€§ | å‡å°‘å®æ—¶è®¡ç®— |

---

## æ‰©å±•æ€§è®¾è®¡

### 9.1 æ–°å¢æ•ˆæœç±»å‹

**æ­¥éª¤**ï¼š
1. å®šä¹‰æ•ˆæœç±»å‹IDï¼ˆå¦‚ 8 = çœ©æ™•ï¼‰
2. åˆ›å»º `StunEffectHandler : ISkillEffectHandler`
3. åœ¨ `SkillEffectManager.Initialize()` ä¸­æ³¨å†Œ
4. åœ¨ `SkillEffectTable` ä¸­æ·»åŠ é…ç½®

**ç¤ºä¾‹**ï¼š
```csharp
public class StunEffectHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        var stunComponent = target.GetComponent<StunComponent>();
        stunComponent.ApplyStun(effectConfig.EffectDuration);
    }
}

// æ³¨å†Œ
RegisterHandler(8, new StunEffectHandler());
```

### 9.2 å¤æ‚æ•ˆæœç»„åˆ

é€šè¿‡ `EffectParams` å­—æ®µæ”¯æŒå¤æ‚å‚æ•°ï¼š

**ç¤ºä¾‹**ï¼šè¿é”é—ªç”µ
```json
{
    "SkillEffectId": 5001,
    "EffectType": 1,
    "EffectValue": 100.0,
    "EffectParams": "{\"ChainCount\":3,\"ChainRange\":5.0,\"DamageDecay\":0.7}"
}
```

**å¤„ç†å™¨å®ç°**ï¼š
```csharp
public class ChainLightningHandler : ISkillEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectConfig effectConfig)
    {
        var chainParams = JsonUtility.FromJson<ChainParams>(effectConfig.EffectParams);
        
        var currentTarget = target;
        float currentDamage = effectConfig.EffectValue;
        
        for (int i = 0; i < chainParams.ChainCount; i++)
        {
            // åº”ç”¨ä¼¤å®³åˆ°å½“å‰ç›®æ ‡
            ApplyDamage(currentTarget, currentDamage);
            
            // æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç›®æ ‡
            var nextTarget = FindNearestEnemy(currentTarget, chainParams.ChainRange);
            if (nextTarget == null) break;
            
            // ä¼¤å®³è¡°å‡
            currentDamage *= chainParams.DamageDecay;
            currentTarget = nextTarget;
        }
    }
}
```

### 9.3 æ¡ä»¶è§¦å‘æ‰©å±•

é€šè¿‡äº‹ä»¶ç³»ç»Ÿæ”¯æŒå¤æ‚çš„æ¡ä»¶è§¦å‘ï¼š

**ç¤ºä¾‹**ï¼šå‘½ä¸­åè§¦å‘é¢å¤–æ•ˆæœ
```csharp
// åœ¨ SkillExecutor ä¸­æ³¨å†Œæ¡ä»¶è§¦å‘
private void RegisterConditionTrigger(Entity caster, TriggerFrameInfo trigger)
{
    // ç›‘å¬ä¼¤å®³äº‹ä»¶
    EventSystem.Subscribe<DamageEvent>(evt =>
    {
        if (evt.Caster == caster && CheckCondition(trigger.Condition))
        {
            TriggerSkillEffect(caster, evt.Target, trigger.EffectId);
        }
    });
}
```

---

## æŠ€æœ¯å®ç°è¦ç‚¹

### 10.1 æ¨¡å—ä¾èµ–

```
GameLogicSystem (ä¸»å¾ªç¯)
    â†“
SkillCapability (æŠ€èƒ½èƒ½åŠ›)
    â†“
SkillExecutor (æŠ€èƒ½æ‰§è¡Œå™¨)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ HitManager       â”‚ SkillEffectMgr   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
    DamageCalculator
            â†“
    Entity Components
```

### 10.2 åˆå§‹åŒ–é¡ºåº

```csharp
// æ¸¸æˆå¯åŠ¨æ—¶åˆå§‹åŒ–
public class CombatSystemInitializer
{
    public static void Initialize()
    {
        // 1. åˆå§‹åŒ– HitManagerï¼ˆå•ä¾‹ï¼‰
        HitManager.Instance.Initialize();
        
        // 2. åˆå§‹åŒ– SkillEffectManagerï¼ˆå•ä¾‹ï¼‰
        SkillEffectManager.Instance.Initialize();
        
        // 3. æ³¨å†Œæ‰€æœ‰æ•ˆæœå¤„ç†å™¨
        RegisterEffectHandlers();
        
        // 4. æ³¨å†Œåˆ°ä¸»å¾ªç¯
        GameLoop.RegisterUpdate(HitManager.Instance.Update);
        GameLoop.RegisterUpdate(SkillEffectManager.Instance.Update);
    }
    
    private static void RegisterEffectHandlers()
    {
        var manager = SkillEffectManager.Instance;
        manager.RegisterHandler(1, new DamageEffectHandler());
        manager.RegisterHandler(2, new HealEffectHandler());
        manager.RegisterHandler(3, new KnockbackEffectHandler());
        manager.RegisterHandler(4, new BuffEffectHandler());
        manager.RegisterHandler(5, new DebuffEffectHandler());
    }
}
```

### 10.3 è°ƒè¯•ä¸å¯è§†åŒ–

```csharp
#if UNITY_EDITOR
public class CombatDebugger
{
    [MenuItem("Astrum/Combat/Toggle HitBox Visualization")]
    public static void ToggleHitBoxVisualization()
    {
        HitManager.Instance.EnableDebugDraw = !HitManager.Instance.EnableDebugDraw;
    }
}

// åœ¨ HitManager ä¸­
public void OnDrawGizmos()
{
    if (!EnableDebugDraw) return;
    
    foreach (var hitBox in _activeHitBoxes)
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireCube(hitBox.WorldCenter, hitBox.BoxData.Size);
    }
}
#endif
```

---

## é…ç½®ç¤ºä¾‹

### 11.1 å‰‘å£«å†²åˆºæ–©

**SkillTable**ï¼š
```json
{
    "Id": 2001,
    "Name": "å†²åˆºæ–©",
    "SkillActionIds": [3001],
    "DisplayCooldown": 5.0,
    "DisplayCost": 20
}
```

**SkillActionTable**ï¼š
```json
{
    "ActionId": 3001,
    "SkillId": 2001,
    "AttackBoxInfo": "Box:5x2x1:10",
    "ActualCost": 15,
    "ActualCooldown": 300,
    "TriggerFrames": "Frame8:Collision:4001,Frame12:Direct:4002"
}
```

**SkillEffectTable**ï¼š
```json
[
    {
        "SkillEffectId": 4001,
        "EffectType": 1,
        "EffectValue": 150.0,
        "TargetType": 1,
        "EffectParams": "{\"DamageType\":\"Physical\"}"
    },
    {
        "SkillEffectId": 4002,
        "EffectType": 3,
        "EffectValue": 5.0,
        "TargetType": 1,
        "EffectParams": "{\"Force\":5.0,\"Duration\":0.3}"
    }
]
```

**æ‰§è¡Œæµç¨‹**ï¼š
```
Frame 8:
    â†’ ç¢°æ’æ£€æµ‹ï¼Œå‘½ä¸­æ•ŒäººAã€B
    â†’ å¯¹Aã€Bé€ æˆ 150% æ”»å‡»åŠ›çš„ç‰©ç†ä¼¤å®³

Frame 12:
    â†’ ç›´æ¥è§¦å‘ï¼Œç›®æ ‡ä¸ºè‡ªèº«æˆ–ä¹‹å‰å‘½ä¸­çš„æ•Œäºº
    â†’ å‡»é€€ç›®æ ‡ï¼ˆåŠ›åº¦5.0ï¼ŒæŒç»­0.3ç§’ï¼‰
```

### 11.2 æ³•å¸ˆç«çƒæœ¯

**SkillActionTable**ï¼š
```json
{
    "ActionId": 3101,
    "SkillId": 2101,
    "AttackBoxInfo": "",
    "TriggerFrames": "Frame15:Direct:4101"
}
```

**SkillEffectTable**ï¼š
```json
{
    "SkillEffectId": 4101,
    "EffectType": 1,
    "EffectValue": 200.0,
    "TargetType": 1,
    "EffectRange": 3.0,
    "EffectParams": "{\"DamageType\":\"Magical\",\"AOE\":true,\"AOERadius\":3.0}"
}
```

**å¤„ç†å™¨æ‰©å±•**ï¼š
```csharp
// DamageEffectHandler ä¸­æ”¯æŒ AOE
if (effectParams.AOE)
{
    var targets = PhysicsWorld.OverlapSphere(
        target.Transform.position, 
        effectParams.AOERadius,
        LayerMask.GetMask("Enemy")
    );
    
    foreach (var t in targets)
    {
        ApplyDamage(t, damageResult.FinalDamage);
    }
}
```

---

## é™„å½•

### A. ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

| ç°æœ‰ç³»ç»Ÿ | é›†æˆç‚¹ | è¯´æ˜ |
|---------|-------|------|
| **Actionç³»ç»Ÿ** | SkillExecutor | åœ¨ SkillAction çš„ Update ä¸­è°ƒç”¨ SkillExecutor |
| **ECSç³»ç»Ÿ** | Entityç»„ä»¶ | HitManager å’Œ EffectHandler æ“ä½œ Entity ç»„ä»¶ |
| **äº‹ä»¶ç³»ç»Ÿ** | æ•ˆæœè§¦å‘ | ä¼¤å®³ã€æ²»ç–—ç­‰äº‹ä»¶é€šè¿‡ EventSystem å¹¿æ’­ |
| **Buffç³»ç»Ÿ** | BuffEffectHandler | è°ƒç”¨ BuffComponent æ·»åŠ /ç§»é™¤ Buff |
| **ç‰¹æ•ˆç³»ç»Ÿ** | EffectHandler | æ’­æ”¾è§†è§‰æ•ˆæœå’ŒéŸ³æ•ˆ |

### B. æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|-----|------|------|
| HitBoxæ•°é‡ | <100 | åŒæ—¶æ´»åŠ¨çš„æ”»å‡»ç›’æ•°é‡ |
| ç¢°æ’æ£€æµ‹è€—æ—¶ | <1ms/å¸§ | æ‰€æœ‰HitBoxçš„æ£€æµ‹æ€»è€—æ—¶ |
| æ•ˆæœé˜Ÿåˆ—å¤„ç† | <0.5ms/å¸§ | å¤„ç†æ‰€æœ‰æ•ˆæœçš„æ€»è€—æ—¶ |
| å†…å­˜å ç”¨ | <5MB | è¿è¡Œæ—¶æ•°æ®å ç”¨ |

### C. æœªæ¥æ‰©å±•æ–¹å‘

1. **é¢„æµ‹æ€§ç¢°æ’æ£€æµ‹** - æ”¯æŒé«˜é€Ÿç§»åŠ¨çš„æ”»å‡»åˆ¤å®š
2. **ç¢°æ’å›è°ƒæ‰©å±•** - æ”¯æŒç©¿é€ã€åå¼¹ç­‰ç‰¹æ®Šç¢°æ’è¡Œä¸º
3. **æ•ˆæœé¢„æ¼”ç³»ç»Ÿ** - ç¼–è¾‘å™¨ä¸­å®æ—¶é¢„è§ˆæŠ€èƒ½æ•ˆæœ
4. **å½•åƒå›æ”¾** - è®°å½•å’Œå›æ”¾æŠ€èƒ½æ‰§è¡Œè¿‡ç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤è€…**: Astrum Team  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-09

Â© Astrum Skill Effect Runtime Design Document

