# 房间系统策划案（精简版）

## 1. 系统概述
房间系统是一个多人在线游戏的核心功能，允许玩家创建、加入、离开房间，并在房间内进行游戏。

## 2. 数据结构设计

### 2.1 房间信息 (RoomInfo)
```csharp
public class RoomInfo
{
    public string RoomId { get; set; }           // 房间唯一标识
    public string HostId { get; set; }           // 房主ID
    public int MaxPlayers { get; set; }          // 最大玩家数（固定4人）
    public int CurrentPlayers { get; set; }      // 当前玩家数
    public RoomStatus Status { get; set; }       // 房间状态
    public List<PlayerInfo> Players { get; set; } // 玩家列表
}

public enum RoomStatus
{
    Waiting,    // 等待中
    Playing,    // 游戏中
    Finished    // 已结束
}
```

### 2.2 玩家信息 (PlayerInfo)
```csharp
public class PlayerInfo
{
    public string PlayerId { get; set; }         // 玩家ID
    public bool IsHost { get; set; }             // 是否房主
}
```

## 3. 网络协议设计

### 3.1 客户端请求消息
```protobuf
// 连接请求
message ConnectRequest {
    // 无需额外参数，直接连接
}

// 获取房间列表
message GetRoomListRequest {
    int32 page = 1;
    int32 pageSize = 2;
}

// 创建房间
message CreateRoomRequest {
    // 无需额外参数，直接创建
}

// 加入房间
message JoinRoomRequest {
    string roomId = 1;
}

// 离开房间
message LeaveRoomRequest {
    string roomId = 1;
}

// 开始游戏
message StartGameRequest {
    string roomId = 1;
}
```

### 3.2 服务器响应消息
```protobuf
// 连接响应
message ConnectResponse {
    bool success = 1;
    string message = 2;
    string playerId = 3;
}

// 房间列表响应
message GetRoomListResponse {
    repeated RoomInfo rooms = 1;
    int32 totalCount = 2;
}

// 房间操作响应
message RoomOperationResponse {
    bool success = 1;
    string message = 2;
    RoomInfo roomInfo = 3;
}

// 房间状态更新
message RoomStatusUpdate {
    string roomId = 1;
    RoomInfo roomInfo = 2;
    RoomUpdateType updateType = 3;
}

enum RoomUpdateType {
    PLAYER_JOINED = 0;
    PLAYER_LEFT = 1;
    GAME_STARTED = 2;
    ROOM_DELETED = 3;
}
```

## 4. UI界面设计

### 4.1 登录界面 (LoginUI)
- **功能**：连接服务器
- **组件**：
  - 连接按钮
  - 连接状态显示
  - 错误提示信息

### 4.2 房间列表界面 (RoomListUI)
- **功能**：显示所有可用房间
- **组件**：
  - 房间列表 (ScrollView)
  - 房间项 (RoomItem) - 显示房间ID、房主、当前人数/最大人数
  - 创建房间按钮
  - 刷新按钮
  - 退出登录按钮

### 4.3 房间详情界面 (RoomDetailUI)
- **功能**：显示房间内玩家信息，管理房间
- **组件**：
  - 房间信息面板（房间ID、房主、人数）
  - 玩家列表（显示所有玩家名称）
  - 开始游戏按钮 (仅房主可见)
  - 离开房间按钮

## 5. 客户端功能逻辑

### 5.1 连接管理器功能
- **连接服务器**：建立与服务器的网络连接
- **连接验证**：发送连接请求到服务器进行验证
- **连接状态管理**：维护当前连接状态和玩家ID
- **断开连接**：主动断开与服务器的连接

### 5.2 房间管理器功能
- **获取房间列表**：从服务器获取所有等待中的房间
- **创建房间**：向服务器发送创建房间请求，成功后跳转到房间详情
- **加入房间**：选择房间后发送加入请求，成功后跳转到房间详情
- **离开房间**：发送离开请求，成功后返回房间列表
- **开始游戏**：房主发送开始游戏请求，成功后跳转到游戏界面
- **监听房间更新**：接收服务器推送的房间状态变化通知

### 5.3 UI交互逻辑
- **连接界面**：
  - 点击连接按钮连接服务器
  - 显示连接状态和错误信息
  - 连接成功后跳转到房间列表界面
- **房间列表界面**：
  - 显示所有等待中的房间
  - 点击房间项加入房间
  - 点击创建按钮创建新房间
  - 点击刷新按钮更新房间列表
  - 点击断开连接按钮返回连接界面
- **房间详情界面**：
  - 显示当前房间信息
  - 显示房间内所有玩家ID
  - 房主可以开始游戏
  - 所有玩家可以离开房间

## 6. 服务器功能逻辑

### 6.1 连接管理功能
- **连接验证**：验证客户端连接请求
- **玩家ID生成**：为每个连接的客户端生成唯一ID
- **连接管理**：维护客户端连接状态和玩家ID映射
- **重复连接检查**：防止同一客户端多次连接

### 6.2 房间管理功能
- **创建房间**：生成唯一房间ID，设置房主，初始化房间状态
- **加入房间**：验证房间存在且未满，添加玩家到房间
- **离开房间**：从房间移除玩家，如果房主离开则转移房主权限
- **开始游戏**：验证房主权限，检查房间状态，更新为游戏中状态
- **房间查询**：返回所有等待中的房间列表
- **房间状态广播**：当房间状态变化时通知所有相关玩家

### 6.3 数据管理功能
- **内存存储**：使用字典存储房间信息、玩家信息和连接映射
- **房间清理**：当房间为空时自动删除房间
- **房主转移**：当房主离开时自动选择新房主
- **状态同步**：确保所有玩家看到一致的房间状态
- **连接清理**：当玩家断开连接时清理相关数据

## 7. 系统流程设计

### 7.1 连接流程
1. 玩家点击"连接"按钮
2. 客户端建立与服务器的网络连接
3. 客户端发送ConnectRequest到服务器
4. 服务器验证连接并生成玩家ID
5. 服务器返回ConnectResponse（包含玩家ID）
6. 客户端接收响应，保存玩家ID
7. 连接成功后跳转到房间列表界面

### 7.2 创建房间流程
1. 玩家在房间列表界面点击"创建房间"按钮
2. 客户端发送CreateRoomRequest到服务器
3. 服务器创建房间并返回房间信息
4. 客户端接收响应，跳转到房间详情界面
5. 服务器广播房间创建事件给其他玩家

### 7.3 加入房间流程
1. 玩家在房间列表中点击房间
2. 客户端发送JoinRoomRequest到服务器
3. 服务器验证房间状态并添加玩家
4. 客户端接收响应，跳转到房间详情界面
5. 服务器广播玩家加入事件给房间内其他玩家

### 7.4 离开房间流程
1. 玩家点击"离开房间"按钮
2. 客户端发送LeaveRoomRequest到服务器
3. 服务器从房间移除玩家
4. 客户端接收响应，返回房间列表界面
5. 服务器广播玩家离开事件给房间内其他玩家

### 7.5 开始游戏流程
1. 房主点击"开始游戏"按钮
2. 客户端发送StartGameRequest到服务器
3. 服务器验证房主权限并更新房间状态
4. 服务器广播游戏开始事件给房间内所有玩家
5. 所有客户端跳转到游戏界面

### 7.6 断开连接流程
1. 玩家点击"断开连接"按钮
2. 客户端发送断开连接请求到服务器
3. 服务器清理玩家相关数据
4. 客户端断开网络连接
5. 返回连接界面

## 8. 错误处理

### 8.1 常见错误情况
- **连接相关错误**：
  - 服务器连接失败
  - 连接超时
  - 重复连接（同一客户端已连接）
- **房间相关错误**：
  - 房间已满（当前人数达到最大人数）
  - 房间不存在（房间ID无效或房间已删除）
  - 玩家已在其他房间（一个玩家同时只能在一个房间）
  - 非房主尝试开始游戏
- **网络相关错误**：
  - 网络连接失败
  - 消息发送超时
  - 服务器断开连接

### 8.2 错误处理策略
- 显示友好的错误提示信息
- 自动重试网络请求（连接失败可重试）
- 状态回滚（操作失败时恢复之前状态）
- 连接断开时自动重连
- 日志记录用于调试和监控

## 9. 性能考虑

### 9.1 客户端优化
- 房间列表分页加载，避免一次性加载过多数据
- UI对象池复用，减少内存分配
- 网络请求缓存，避免重复请求

### 9.2 服务器优化
- 房间信息内存缓存，快速响应查询
- 消息广播优化，只通知相关玩家
- 定期清理空房间，释放内存资源

## 10. 版本迭代计划

### 10.1 第一版（当前）
- 服务器连接管理
- 基础房间创建、加入、离开功能
- 简单的房间列表显示
- 房主开始游戏功能
- 断开连接功能

### 10.2 后续版本
- 房间密码功能
- 房间设置（最大人数、游戏模式等）
- 玩家准备状态
- 房间聊天功能
- 房间历史记录
- 房间搜索和筛选功能
- 断线重连功能
- 玩家状态持久化

---

*文档版本：v1.0*  
*创建时间：2025-01-22*  
*最后更新：2025-01-22*
