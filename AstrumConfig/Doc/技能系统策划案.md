# 技能系统策划案

## 1. 系统概述

技能系统是Astrum项目中负责技能管理、执行和效果触发的核心系统。该系统采用三层架构设计，将技能概念、动作执行和效果实现完全分离，实现了高度的模块化和可扩展性。

**设计理念**：
- **概念分离**：技能、动作、效果三层独立设计
- **动作驱动**：所有技能基于Action系统，通过ActionType区分
- **时间轴设计**：Action作为时间轴，承载表现数据
- **模块化扩展**：支持技能变种、等级、组合等复杂需求

## 2. 系统架构

### 2.1 三层架构设计

```
技能系统三层架构
├── Skill (技能概念层)
│   ├── 技能基本信息 (名称、描述、等级等)
│   ├── 包含的SkillAction列表
│   └── 展示用信息 (冷却时间、技能开销等)
├── SkillAction (动作执行层)
│   ├── 关联ActionTable (actionType = "Skill")
│   ├── 技能专用属性 (攻击碰撞盒、实际开销等)
│   ├── 触发帧信息 (帧序号、触发条件、效果ID)
│   └── 表现数据 (特效、音效、动画等)
└── SkillEffect (效果触发层)
    ├── 纯效果数据 (伤害、治疗、buff等)
    ├── 效果参数 (数值、持续时间、范围等)
    └── 目标类型 (敌人、友军、自身等)
```

### 2.2 核心概念

#### 2.2.1 技能 (Skill)
- **定义**：玩家可学习的完整技能概念
- **特点**：包含一个或多个SkillAction的组合
- **职责**：定义技能的整体逻辑和展示信息

#### 2.2.2 技能动作 (SkillAction)
- **定义**：技能的具体执行单元
- **特点**：基于Action系统，包含完整的执行逻辑
- **职责**：处理技能的执行流程和效果触发

#### 2.2.3 技能效果 (SkillEffect)
- **定义**：技能产生的具体游戏效果
- **特点**：纯数据配置，无执行逻辑
- **职责**：定义效果的类型、数值和参数

## 3. 表格架构设计

### 3.1 表格关系图

```
表格关系图
├── SkillTable
│   ├── skillActionIds[] → SkillActionTable.actionId
│   └── displayInfo (冷却、开销等展示数据)
├── SkillActionTable
│   ├── actionId → ActionTable.actionId (actionType = "Skill")
│   ├── triggerFrames (触发帧信息)
│   └── skillSpecificData (技能专用属性)
├── SkillEffectTable
│   └── pureEffectData (纯效果数据)
└── ActionTable (现有扩展)
    └── performanceData (表现数据：特效、音效、动画)
```

### 3.2 详细表格设计

#### 3.2.1 SkillTable (技能表)
**作用**：定义技能概念，描述技能包含哪些动作

**字段设计**：
| 字段名 | 类型 | 描述 | 示例值 |
|--------|------|------|--------|
| Id | int | 技能唯一标识符 | 2001 |
| Name | string | 技能名称 | "冲刺斩" |
| Description | string | 技能描述 | "向前冲刺并造成伤害" |
| SkillType | int | 技能类型（1=攻击,2=控制,3=位移,4=buff） | 3 |
| SkillActionIds | int[] | 包含的技能动作ID数组 | [3001, 3002] |
| DisplayCooldown | float | 展示用冷却时间 | 5.0 |
| DisplayCost | int | 展示用法力消耗 | 20 |
| RequiredLevel | int | 学习所需等级 | 1 |
| MaxLevel | int | 技能最大等级 | 10 |
| IconId | int | 技能图标ID | 4001 |

#### 3.2.2 SkillActionTable (技能动作表)
**作用**：SkillAction的具体实现配置

**字段设计**：
| 字段名 | 类型 | 描述 | 示例值 |
|--------|------|------|--------|
| ActionId | int | 对应ActionTable中的ActionId | 3001 |
| SkillId | int | 所属技能ID | 2001 |
| AttackBoxInfo | string | 攻击碰撞盒信息 | "Box1:5x2,Box2:3x3" |
| ActualCost | int | 实际法力消耗 | 15 |
| ActualCooldown | int | 实际冷却时间（帧） | 270 |
| TriggerFrames | string | 触发帧信息 | "Frame5:Collision:4001,Frame10:Direct:4002" |

#### 3.2.3 SkillEffectTable (技能效果表)
**作用**：定义技能产生的各种效果

**字段设计**：
| 字段名 | 类型 | 描述 | 示例值 |
|--------|------|------|--------|
| SkillEffectId | int | 效果唯一标识符 | 4001 |
| EffectType | int | 效果类型（1=伤害,2=治疗,3=击退,4=buff,5=debuff） | 1 |
| EffectValue | float | 效果数值 | 150.0 |
| TargetType | int | 目标类型（1=敌人,2=友军,3=自身,4=全体） | 1 |
| EffectDuration | float | 效果持续时间 | 0.0 |
| EffectRange | float | 效果范围 | 2.0 |
| CastTime | float | 施法时间 | 0.5 |
| EffectParams | string | 效果参数 | "DamageType:Physical,Knockback:5.0" |
| VisualEffectId | int | 视觉效果ID | 5001 |
| SoundEffectId | int | 音效ID | 6001 |

#### 3.2.4 ActionTable (现有扩展)
**扩展字段**：
- `ActionType` - 动作类型（"Normal", "Skill", "Movement"等）
- 表现数据字段保持不变

## 4. 执行流程

### 4.1 技能释放流程

```
技能释放流程（基于动作切换逻辑）
1. 玩家学习技能 → 技能动作注册到角色的动作系统
2. 玩家输入技能指令 → 触发动作切换条件判断
3. 动作系统切换到技能动作 → 执行SkillAction
4. 执行过程中到达触发帧 → 检查triggerFrames信息
5. 触发SkillEffect → 执行具体游戏效果

技能动作注册流程
1. 角色学习技能 → 查找SkillTable获取SkillActionIds
2. 遍历SkillActionIds → 获取SkillActionTable配置
3. 将技能动作注册到角色的ActionCapability中
4. 通过ActionCommand绑定输入指令
5. 技能动作可通过动作切换逻辑正常执行
```

### 4.2 触发帧信息格式

**triggerFrames字段格式**：
```
"Frame{帧号}:{触发条件}:{SkillEffectId},{Frame{帧号}:{触发条件}:{SkillEffectId}"
```

**触发条件类型**：
- `Collision` - 碰撞盒触发
- `Direct` - 特定帧直接触发
- `Condition` - 条件触发（如命中敌人后）

**示例**：
```
"Frame5:Collision:4001,Frame10:Direct:4002,Frame15:Condition:4003"
```

## 5. 与现有系统集成

### 5.1 与Action系统集成
- **技能动作注册**：学习技能后，SkillAction注册到角色的ActionCapability中
- **动作切换逻辑**：技能释放通过动作系统的切换逻辑实现，无需特殊处理
- **ActionTable关联**：SkillAction通过ActionId关联ActionTable
- **动作类型标识**：ActionTable中actionType="Skill"标识技能动作
- **表现数据**：特效、音效、动画等表现数据在ActionTable中配置
- **指令绑定**：通过ActionCommand绑定输入指令（Q/E键等）

### 5.2 与战斗系统集成
- SkillEffect中的伤害效果与AttackInfo集成
- 击退、buff等效果与战斗系统的相应模块集成
- 碰撞盒信息与战斗判定系统集成

### 5.3 与角色系统集成
- RoleBaseTable通过skill1Id/skill2Id关联SkillTable
- 技能等级与角色等级系统关联
- 技能点消耗与角色成长系统集成

## 6. 配置示例

### 6.1 剑士冲刺斩技能配置

**SkillTable**：
```json
{
  "Id": 2001,
  "Name": "冲刺斩",
  "Description": "向前冲刺并造成伤害",
  "SkillType": 3,
  "SkillActionIds": [3001],
  "DisplayCooldown": 5.0,
  "DisplayCost": 20,
  "RequiredLevel": 1,
  "MaxLevel": 10,
  "IconId": 4001
}
```

**SkillActionTable**：
```json
{
  "ActionId": 3001,
  "SkillId": 2001,
  "AttackBoxInfo": "Box1:5x2x1",
  "ActualCost": 15,
  "ActualCooldown": 270,
  "TriggerFrames": "Frame5:Collision:4001,Frame8:Direct:4002"
}
```

**SkillEffectTable**：
```json
[
  {
    "SkillEffectId": 4001,
    "EffectType": 1,
    "EffectValue": 150.0,
    "TargetType": 1,
    "EffectDuration": 0.0,
    "EffectRange": 2.0,
    "CastTime": 0.0,
    "EffectParams": "DamageType:Physical",
    "VisualEffectId": 5001,
    "SoundEffectId": 6001
  },
  {
    "SkillEffectId": 4002,
    "EffectType": 3,
    "EffectValue": 3.0,
    "TargetType": 1,
    "EffectDuration": 0.0,
    "EffectRange": 2.0,
    "CastTime": 0.0,
    "EffectParams": "Direction:Forward",
    "VisualEffectId": 5002,
    "SoundEffectId": 6002
  }
]
```

## 7. 扩展性设计

### 7.1 技能变种支持
- 通过SkillAction的不同组合实现技能变种
- 支持技能升级时的效果变化
- 支持不同角色对同一技能的不同实现

### 7.2 复合技能支持
- 一个技能可以包含多个SkillAction
- 支持技能链和连招系统
- 支持技能组合和融合

### 7.3 动态效果支持
- SkillEffect支持复杂的参数配置
- 支持基于目标属性的动态计算
- 支持效果叠加和相互作用

## 8. 开发优先级

### 8.1 第一阶段
1. 实现基础的三层架构
2. 完成表格设计和配置生成
3. 实现简单的伤害类技能

### 8.2 第二阶段
1. 支持复杂的触发条件
2. 实现buff/debuff类技能
3. 完善表现系统集成

### 8.3 第三阶段
1. 支持技能变种和升级
2. 实现复合技能系统
3. 优化性能和扩展性

---

© Astrum Skill System Design Document

## 9. 运行时实现要点（阶段3-5合并说明）

- SkillInfo 仅保存基础信息与 `SkillActionIds`；不缓存 `SkillActionInfo` 实例。
- 动作实例来源：在注册阶段，通过 `SkillConfigManager.CreateSkillActionInstance(actionId, level)` 动态构造新的 `SkillActionInfo`，并加入 `ActionComponent.AvailableActions`。
- 触发帧解析：`SkillConfigManager.ParseTriggerFrames()` 基于 BaseEffectId + Level 的直查策略（插值将于后续阶段加入）。
- 组件与能力：
  - `SkillComponent` 只存储 `Dictionary<int, SkillInfo>`（轻逻辑）。
  - `SkillCapability` 负责技能学习、初始技能加载（`LightAttackSkillId`/`HeavyAttackSkillId`/`Skill1Id`/`Skill2Id`）、动作注册/注销。
- 原型集成：`RoleArchetype` 默认包含 `SkillComponent` 与 `SkillCapability`，实例创建后自动完成技能初始化与动作注册。
- 序列化：`BaseComponent.MemoryPack.cs` 注册 `SkillComponent`，`Capability.MemoryPack.cs` 注册 `SkillCapability`。
- 健壮性：`RoleInfoComponent.RoleConfig` 取不到配置会记录错误日志，便于快速定位表配置问题。

### 9.1 效果插值策略（设计）

目标：减少 `SkillEffectTable` 配置量，同时保持数值平滑。

- 基础规则（BaseEffectId + Level）：
  - `baseEffectId` 为整百基数（如 10000、10100），`actualEffectId = baseEffectId + level`（level ∈ [0,99]）。
  - 若 `actualEffectId` 存在，直接取其 `EffectValue`。
- 线性插值：当目标等级缺失时（`actualEffectId` 不存在），在同一 `baseEffectId` 分段内查找两侧已配置等级：
  - 设下界 `(Llo, Vlo)`、上界 `(Lhi, Vhi)`，满足 `Llo < target < Lhi`；
  - 计算 `t = (target - Llo) / (Lhi - Llo)`；
  - 结果 `V = Vlo + (Vhi - Vlo) * t`。
- 边界处理：
  - 若 `target <= Lmin`，取 `Lmin` 对应值；若 `target >= Lmax`，取 `Lmax` 对应值（不外推）。
- 失败兜底：若该分段完全无配置，返回 0 并记录错误日志（表问题）。

推荐 API（示意）：
```
EffectValueResult GetEffectValue(int baseEffectId, int level);
// 内部步骤：优先精确命中；否则按 9.1 进行线性插值。
```