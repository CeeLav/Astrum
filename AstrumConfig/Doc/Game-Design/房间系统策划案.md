# 房间系统策划案（已实现版）

## 1. 系统概述
房间系统是一个多人在线游戏的核心功能，允许玩家登录、创建、加入、离开房间，并在房间内进行游戏。系统采用客户端-服务器架构，使用Protocol Buffers进行网络通信，Unity作为客户端平台。

## 2. 数据结构设计

### 2.1 用户信息 (UserInfo)
```protobuf
message UserInfo
{
    string Id = 1;             // 用户ID
    string DisplayName = 2;    // 显示名称
    int64 LastLoginAt = 3;     // 最后登录时间
    string CurrentRoomId = 4;  // 当前房间ID
}
```

### 2.2 房间信息 (RoomInfo)
```protobuf
message RoomInfo
{
    string Id = 1;             // 房间ID
    string Name = 2;           // 房间名称
    string CreatorName = 3;    // 创建者名称
    int32 CurrentPlayers = 4;  // 当前玩家数量
    int32 MaxPlayers = 5;      // 最大玩家数量
    int64 CreatedAt = 6;       // 创建时间
    repeated string PlayerNames = 7; // 玩家名称列表
}
```

### 2.3 游戏请求/响应 (GameRequest/GameResponse)
```protobuf
message GameRequest
{
    int64 requestId = 1; // 请求ID
    string action = 2; // 动作类型
    PlayerInfo player = 3; // 玩家信息
    repeated string param = 4; // 参数列表
}

message GameResponse
{
    bool success = 1; // 是否成功
    string message = 2; // 响应消息
    int64 requestId = 3; // 对应的请求ID
    PlayerInfo updatedPlayer = 4; // 更新后的玩家信息
}
```

## 3. 网络协议设计

### 3.1 客户端请求消息
```protobuf
// 登录请求
message LoginRequest
{
    string DisplayName = 1;    // 显示名称
}

// 获取房间列表请求
message GetRoomListRequest
{
    int64 Timestamp = 1;       // 时间戳
}

// 创建房间请求
message CreateRoomRequest
{
    string RoomName = 1;       // 房间名称
    int32 MaxPlayers = 2;      // 最大玩家数量
    int64 Timestamp = 3;       // 时间戳
}

// 加入房间请求
message JoinRoomRequest
{
    string RoomId = 1;         // 房间ID
    int64 Timestamp = 2;       // 时间戳
}

// 离开房间请求
message LeaveRoomRequest
{
    string RoomId = 1;         // 房间ID
    int64 Timestamp = 2;       // 时间戳
}

// 游戏请求（开始游戏等）
message GameRequest
{
    int64 requestId = 1;       // 请求ID
    string action = 2;         // 动作类型（如"StartGame"）
    PlayerInfo player = 3;     // 玩家信息
    repeated string param = 4; // 参数列表
}
```

### 3.2 服务器响应消息
```protobuf
// 登录响应
message LoginResponse
{
    bool Success = 1;          // 是否成功
    string Message = 2;        // 响应消息
    UserInfo User = 3;         // 用户信息
    int64 Timestamp = 4;       // 时间戳
}

// 获取房间列表响应
message GetRoomListResponse
{
    bool Success = 1;          // 是否成功
    string Message = 2;        // 响应消息
    repeated RoomInfo Rooms = 3; // 房间列表
    int64 Timestamp = 4;       // 时间戳
}

// 创建房间响应
message CreateRoomResponse
{
    bool Success = 1;          // 是否成功
    string Message = 2;        // 响应消息
    RoomInfo Room = 3;         // 房间信息
    int64 Timestamp = 4;       // 时间戳
}

// 加入房间响应
message JoinRoomResponse
{
    bool Success = 1;          // 是否成功
    string Message = 2;        // 响应消息
    RoomInfo Room = 3;         // 房间信息
    int64 Timestamp = 4;       // 时间戳
}

// 离开房间响应
message LeaveRoomResponse
{
    bool Success = 1;          // 是否成功
    string Message = 2;        // 响应消息
    string RoomId = 3;         // 房间ID
    int64 Timestamp = 4;       // 时间戳
}

// 游戏响应
message GameResponse
{
    bool success = 1;          // 是否成功
    string message = 2;        // 响应消息
    int64 requestId = 3;       // 对应的请求ID
    PlayerInfo updatedPlayer = 4; // 更新后的玩家信息
}

// 房间更新通知
message RoomUpdateNotification
{
    RoomInfo Room = 1;         // 房间信息
    string UpdateType = 2;     // 更新类型
    string RelatedUserId = 3;  // 相关用户ID
    int64 Timestamp = 4;       // 时间戳
}

// 心跳消息
message HeartbeatMessage
{
    string ClientId = 1;       // 客户端ID
    int64 Timestamp = 2;       // 时间戳
}

// 心跳响应
message HeartbeatResponse
{
    int64 Timestamp = 1;       // 响应时间戳
    string Message = 2;        // 响应消息
}
```

## 4. UI界面设计

### 4.1 登录界面 (LoginView)
- **功能**：连接服务器并登录
- **组件**：
  - 连接按钮 - 连接服务器
  - 连接状态显示 - 显示连接状态
  - 错误提示信息 - 显示连接或登录错误
- **实现特性**：
  - 自动连接服务器
  - 连接成功后自动发送登录请求
  - 登录成功后自动跳转到房间列表界面
  - 支持重连机制

### 4.2 房间列表界面 (RoomListView)
- **功能**：显示所有可用房间，管理房间操作
- **组件**：
  - 房间列表 (ScrollView) - 显示所有等待中的房间
  - 房间项 (RoomItem) - 显示房间ID、房主、当前人数/最大人数
  - 创建房间按钮 - 创建新房间
  - 刷新按钮 - 手动刷新房间列表
  - 断开连接按钮 - 断开连接并返回登录界面
- **实现特性**：
  - 自动刷新房间列表（每5秒）
  - 点击房间项加入房间
  - 创建房间时自动生成随机房间名
  - 支持房间列表的实时更新

### 4.3 房间详情界面 (RoomDetailView)
- **功能**：显示房间内玩家信息，管理房间
- **组件**：
  - 房间信息面板 - 显示房间ID、房主、人数
  - 玩家列表 - 显示所有玩家名称和房主标识
  - 开始游戏按钮 - 房主可开始游戏（无人数限制）
  - 离开房间按钮 - 离开当前房间
- **实现特性**：
  - 实时显示房间信息
  - 房主权限控制（开始游戏按钮）
  - 离开房间后自动返回房间列表
  - 支持房间状态同步

## 5. 客户端功能逻辑

### 5.1 网络管理器功能 (NetworkManager)
- **连接服务器**：建立与服务器的TCP网络连接
- **消息发送**：使用MemoryPack序列化发送Protocol Buffer消息
- **消息接收**：接收并反序列化服务器响应
- **连接状态管理**：维护当前连接状态和会话ID
- **断开连接**：主动断开与服务器的连接
- **事件订阅**：支持订阅各种网络事件（连接、登录、房间等）

### 5.2 用户管理器功能 (UserManager)
- **用户信息管理**：维护当前用户的基本信息
- **登录状态管理**：跟踪用户登录状态
- **房间状态管理**：跟踪用户当前所在房间
- **会话管理**：管理用户会话ID

### 5.3 房间系统管理器功能 (RoomSystemManager)
- **获取房间列表**：从服务器获取所有等待中的房间
- **创建房间**：向服务器发送创建房间请求，成功后跳转到房间详情
- **加入房间**：选择房间后发送加入请求，成功后跳转到房间详情
- **离开房间**：发送离开请求，成功后返回房间列表
- **开始游戏**：房主发送开始游戏请求，成功后跳转到游戏界面
- **监听房间更新**：接收服务器推送的房间状态变化通知
- **房间状态同步**：维护当前房间信息并同步到UI

### 5.4 UI管理器功能 (UIManager)
- **UI创建和销毁**：管理UI界面的生命周期
- **UI显示和隐藏**：控制UI界面的显示状态
- **UI引用管理**：通过UIRefs组件管理UI元素引用
- **UI切换**：支持不同界面之间的切换

### 5.5 UI交互逻辑
- **登录界面 (LoginView)**：
  - 自动连接服务器
  - 连接成功后自动发送登录请求
  - 显示连接状态和错误信息
  - 登录成功后自动跳转到房间列表界面
- **房间列表界面 (RoomListView)**：
  - 显示所有等待中的房间
  - 点击房间项加入房间
  - 点击创建按钮创建新房间（自动生成随机房间名）
  - 点击刷新按钮更新房间列表
  - 点击断开连接按钮返回登录界面
  - 自动刷新房间列表（每5秒）
- **房间详情界面 (RoomDetailView)**：
  - 显示当前房间信息（ID、房主、人数）
  - 显示房间内所有玩家名称和房主标识
  - 房主可以开始游戏（无人数限制）
  - 所有玩家可以离开房间
  - 离开房间后自动返回房间列表界面

## 6. 服务器功能逻辑

### 6.1 游戏服务器功能 (GameServer)
- **网络连接管理**：处理客户端TCP连接和断开
- **消息路由**：根据消息类型路由到相应的处理器
- **会话管理**：维护客户端会话ID和用户信息映射
- **消息序列化**：使用MemoryPack处理Protocol Buffer消息
- **事件广播**：向相关客户端广播房间状态变化

### 6.2 用户管理器功能 (UserManager)
- **用户注册**：为新连接的用户生成唯一ID和显示名称
- **用户信息管理**：维护用户基本信息（ID、显示名称、当前房间等）
- **会话管理**：管理用户会话ID和用户信息的映射
- **房间状态更新**：更新用户当前所在房间信息
- **用户清理**：当用户断开连接时清理相关数据

### 6.3 房间管理器功能 (RoomManager)
- **创建房间**：生成唯一房间ID，设置房主，初始化房间状态
- **加入房间**：验证房间存在且未满，添加玩家到房间
- **离开房间**：从房间移除玩家，如果房主离开则转移房主权限
- **房间查询**：返回所有等待中的房间列表
- **房间状态管理**：维护房间的当前状态和玩家列表
- **房间清理**：当房间为空时自动删除房间
- **房主转移**：当房主离开时自动选择新房主

### 6.4 游戏逻辑处理
- **开始游戏**：验证房主权限，检查房间状态，更新为游戏中状态
- **游戏请求处理**：处理各种游戏相关的请求
- **游戏状态广播**：向房间内所有玩家广播游戏状态变化
- **权限验证**：确保只有房主可以开始游戏

### 6.5 数据管理功能
- **内存存储**：使用字典存储房间信息、玩家信息和连接映射
- **状态同步**：确保所有玩家看到一致的房间状态
- **连接清理**：当玩家断开连接时清理相关数据
- **日志记录**：记录重要的操作和错误信息

## 7. 系统流程设计

### 7.1 登录流程
1. 客户端启动，自动显示登录界面
2. 客户端自动建立与服务器的TCP连接
3. 连接成功后，客户端自动发送LoginRequest到服务器
4. 服务器验证连接并生成用户ID和显示名称
5. 服务器返回LoginResponse（包含用户信息）
6. 客户端接收响应，保存用户信息
7. 登录成功后自动跳转到房间列表界面

### 7.2 创建房间流程
1. 玩家在房间列表界面点击"创建房间"按钮
2. 客户端自动生成随机房间名称
3. 客户端发送CreateRoomRequest到服务器
4. 服务器创建房间并返回房间信息
5. 客户端接收响应，跳转到房间详情界面
6. 服务器广播房间创建事件给其他玩家

### 7.3 加入房间流程
1. 玩家在房间列表中点击房间项
2. 客户端发送JoinRoomRequest到服务器
3. 服务器验证房间状态并添加玩家
4. 客户端接收响应，跳转到房间详情界面
5. 服务器广播玩家加入事件给房间内其他玩家

### 7.4 离开房间流程
1. 玩家点击"离开房间"按钮
2. 客户端发送LeaveRoomRequest到服务器
3. 服务器从房间移除玩家
4. 客户端接收响应，自动关闭房间详情界面并返回房间列表界面
5. 服务器广播玩家离开事件给房间内其他玩家

### 7.5 开始游戏流程
1. 房主点击"开始游戏"按钮
2. 客户端发送GameRequest（action="StartGame"）到服务器
3. 服务器验证房主权限并更新房间状态
4. 服务器广播游戏开始事件给房间内所有玩家
5. 所有客户端跳转到游戏界面

### 7.6 断开连接流程
1. 玩家点击"断开连接"按钮
2. 客户端发送断开连接请求到服务器
3. 服务器清理玩家相关数据
4. 客户端断开网络连接
5. 返回登录界面

### 7.7 房间列表自动刷新流程
1. 房间列表界面每5秒自动发送GetRoomListRequest
2. 服务器返回最新的房间列表
3. 客户端更新房间列表显示
4. 支持手动刷新按钮触发相同流程

## 8. 错误处理

### 8.1 常见错误情况
- **连接相关错误**：
  - 服务器连接失败
  - 连接超时
  - 网络连接中断
- **登录相关错误**：
  - 登录请求失败
  - 用户信息获取失败
- **房间相关错误**：
  - 房间已满（当前人数达到最大人数）
  - 房间不存在（房间ID无效或房间已删除）
  - 玩家已在其他房间（一个玩家同时只能在一个房间）
  - 非房主尝试开始游戏
  - 房间创建失败
  - 加入房间失败
  - 离开房间失败
- **网络相关错误**：
  - 网络连接失败
  - 消息发送超时
  - 服务器断开连接
  - 消息序列化/反序列化失败

### 8.2 错误处理策略
- **UI错误提示**：在相应界面显示友好的错误提示信息
- **自动重试**：网络连接失败时支持重连机制
- **状态回滚**：操作失败时恢复之前状态
- **日志记录**：使用ASLogger记录详细错误信息用于调试
- **异常捕获**：所有关键操作都有try-catch异常处理
- **用户反馈**：通过事件系统向UI传递错误信息

## 9. 技术实现细节

### 9.1 客户端技术栈
- **Unity 2022.3 LTS**：游戏引擎和UI框架
- **Protocol Buffers**：网络消息定义和序列化
- **MemoryPack**：高性能消息序列化
- **TCP Socket**：网络通信协议
- **UIRefs系统**：基于Prefab的UI代码生成
- **事件驱动架构**：松耦合的组件通信

### 9.2 服务器技术栈
- **.NET 9.0**：服务器运行环境
- **Protocol Buffers**：网络消息定义和序列化
- **MemoryPack**：高性能消息序列化
- **TCP Socket**：网络通信协议
- **内存存储**：房间和用户信息管理
- **事件广播**：实时状态同步

### 9.3 UI生成系统
- **基于Prefab的代码生成**：从Unity Prefab自动生成C# UI逻辑类
- **UIRefs组件**：自动收集UI元素引用
- **Partial Class**：分离生成代码和手动编辑代码
- **命名空间管理**：清晰的代码组织结构

### 9.4 性能优化
- **客户端优化**：
  - UI对象池复用，减少内存分配
  - 房间列表自动刷新，避免重复请求
  - 事件驱动的状态同步，减少不必要的UI更新
- **服务器优化**：
  - 内存存储，快速响应查询
  - 消息广播优化，只通知相关玩家
  - 定期清理空房间，释放内存资源

## 10. 已实现功能

### 10.1 核心功能（已完成）
- ✅ 用户登录系统
- ✅ 房间创建、加入、离开功能
- ✅ 房间列表显示和自动刷新
- ✅ 房间详情显示和玩家管理
- ✅ 房主开始游戏功能（无人数限制）
- ✅ 完整的UI界面和交互逻辑
- ✅ 客户端-服务器网络通信
- ✅ 错误处理和日志记录
- ✅ UI自动切换和状态同步

### 10.2 技术特性（已完成）
- ✅ 基于Prefab的UI代码生成系统
- ✅ Protocol Buffers消息定义
- ✅ MemoryPack序列化
- ✅ TCP网络通信
- ✅ 事件驱动的架构设计
- ✅ 异常处理和错误恢复
- ✅ 实时状态同步

## 11. 后续扩展计划

### 11.1 功能扩展
- 房间密码功能
- 房间设置（最大人数、游戏模式等）
- 玩家准备状态
- 房间聊天功能
- 房间历史记录
- 房间搜索和筛选功能
- 断线重连功能
- 玩家状态持久化

### 11.2 技术优化
- 数据库持久化存储
- 负载均衡和集群支持
- 更完善的错误恢复机制
- 性能监控和统计
- 安全认证和防作弊

---

*文档版本：v2.0（已实现版）*  
*创建时间：2025-01-22*  
*最后更新：2025-01-22*  
*实现状态：核心功能已完成，可正常使用*
