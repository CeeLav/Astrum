# ğŸŒ ç½‘ç»œç³»ç»Ÿæ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… åŸºç¡€å®Œæˆï¼ŒğŸš§ æŒç»­ä¼˜åŒ–  
**æœ€åæ›´æ–°**: 2025-10-31

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
4. [æ¶ˆæ¯ç³»ç»Ÿ](#æ¶ˆæ¯ç³»ç»Ÿ)
5. [è¿æ¥æµç¨‹](#è¿æ¥æµç¨‹)
6. [åè®®å®šä¹‰](#åè®®å®šä¹‰)
7. [æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿ](#æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿ)
8. [å¸§åŒæ­¥æœºåˆ¶](#å¸§åŒæ­¥æœºåˆ¶)
9. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
10. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)

---

## æ¦‚è¿°

Astrum æ¸¸æˆé‡‡ç”¨**å®¢æˆ·ç«¯-æœåŠ¡å™¨ï¼ˆC/Sï¼‰æ¶æ„**ï¼Œä½¿ç”¨ **TCP/IP** åè®®è¿›è¡Œå¯é é€šä¿¡ã€‚ç½‘ç»œç³»ç»Ÿè®¾è®¡éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

- **å¹³å°æ— å…³æ€§**: å®¢æˆ·ç«¯ç½‘ç»œå±‚ï¼ˆNetworkç¨‹åºé›†ï¼‰ä¸Unityè§£è€¦ï¼Œå¯åœ¨ä»»ä½•.NETç¯å¢ƒè¿è¡Œ
- **æ¶ˆæ¯é©±åŠ¨**: åŸºäºæ¶ˆæ¯çš„ç½‘ç»œé€šä¿¡ï¼Œæ”¯æŒç±»å‹å®‰å…¨çš„æ¶ˆæ¯å¤„ç†
- **å¯æ‰©å±•æ€§**: çµæ´»çš„æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿï¼Œæ˜“äºæ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹å’Œå¤„ç†é€»è¾‘
- **é«˜æ€§èƒ½**: ä½¿ç”¨MemoryPackåºåˆ—åŒ–ï¼Œæ”¯æŒå¤§é‡å¹¶å‘è¿æ¥

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯ (Unity Client)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ LoginView    â”‚  â”‚ GameDirector â”‚  â”‚ GameMode     â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                            â”‚                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚  NetworkManager   â”‚                       â”‚
â”‚                  â”‚  (å®¢æˆ·ç«¯ç®¡ç†å™¨)    â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚ MessageHandler    â”‚                       â”‚
â”‚                  â”‚ Registry          â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ConnectMsg  â”‚  â”‚ LoginMessage   â”‚  â”‚ GameMsg   â”‚        â”‚
â”‚  â”‚ Handler     â”‚  â”‚ Handler         â”‚  â”‚ Handler  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                            â”‚                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚ Session (ä¼šè¯)    â”‚                       â”‚
â”‚                  â”‚ TService (TCP)    â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   TCP/IPç½‘ç»œ    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡å™¨ (.NET Server)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            â”‚                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚ TService (TCP)    â”‚                       â”‚
â”‚                  â”‚ ServerNetworkMgr  â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                                  â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚    GameServer     â”‚                       â”‚
â”‚                  â”‚  (æ¶ˆæ¯åˆ†å‘å™¨)     â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                            â”‚                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                  â”‚                  â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚UserManager  â”‚  â”‚ RoomManager     â”‚  â”‚Matchmakingâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Application Layer)           â”‚
â”‚  - GameDirector, GameMode, UIManager         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¸šåŠ¡å±‚ (Business Layer)            â”‚
â”‚  - UserManager, RoomSystemManager           â”‚
â”‚  - MessageHandlers (æ¶ˆæ¯å¤„ç†å™¨)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç½‘ç»œå±‚ (Network Layer)             â”‚
â”‚  - NetworkManager, Session, TService        â”‚
â”‚  - MessageHandlerRegistry, Dispatcher        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ä¼ è¾“å±‚ (Transport Layer)           â”‚
â”‚  - TCP/IP Socket                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### å®¢æˆ·ç«¯æ ¸å¿ƒç»„ä»¶

#### 1. NetworkManager (å®¢æˆ·ç«¯ç½‘ç»œç®¡ç†å™¨)

**ä½ç½®**: `AstrumProj/Assets/Script/AstrumClient/Managers/NetworkManager.cs`

**èŒè´£**:
- ç®¡ç†TCPè¿æ¥
- æ¶ˆæ¯å‘é€å’Œæ¥æ”¶
- è¿æ¥çŠ¶æ€ç®¡ç†
- é›†æˆæ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿ

**å…³é”®æ–¹æ³•**:
```csharp
public void Initialize()                          // åˆå§‹åŒ–ç½‘ç»œç®¡ç†å™¨
public Task<long> ConnectAsync(string, int)      // è¿æ¥åˆ°æœåŠ¡å™¨
public void Send(MessageObject message)          // å‘é€æ¶ˆæ¯
public bool IsConnected()                        // æ£€æŸ¥è¿æ¥çŠ¶æ€
```

#### 2. Session (ç½‘ç»œä¼šè¯)

**ä½ç½®**: `AstrumProj/Assets/Script/Network/Session.cs`

**èŒè´£**:
- ç®¡ç†å•ä¸ªTCPè¿æ¥
- æ¶ˆæ¯åºåˆ—åŒ–/ååºåˆ—åŒ–
- åº•å±‚ç½‘ç»œIOæ“ä½œ

#### 3. TService (TCPæœåŠ¡)

**ä½ç½®**: `AstrumProj/Assets/Script/Network/TService.cs`

**èŒè´£**:
- TCP Socketå°è£…
- ç½‘ç»œIOäº‹ä»¶å¤„ç†
- ç¼“å†²åŒºç®¡ç†

### æœåŠ¡å™¨æ ¸å¿ƒç»„ä»¶

#### 1. ServerNetworkManager (æœåŠ¡å™¨ç½‘ç»œç®¡ç†å™¨)

**ä½ç½®**: `AstrumServer/AstrumServer/Network/ServerNetworkManager.cs`

**èŒè´£**:
- ç›‘å¬å®¢æˆ·ç«¯è¿æ¥
- ç®¡ç†å¤šä¸ªSession
- æ¶ˆæ¯åˆ†å‘

**å…³é”®æ–¹æ³•**:
```csharp
public Task<bool> InitializeAsync(int port)     // åˆå§‹åŒ–æœåŠ¡å™¨
public void SendMessage(string sessionId, ...)  // å‘é€æ¶ˆæ¯åˆ°æŒ‡å®šå®¢æˆ·ç«¯
public void Update()                            // æ›´æ–°ç½‘ç»œæœåŠ¡
```

#### 2. GameServer (æ¸¸æˆæœåŠ¡å™¨ä¸»ç±»)

**ä½ç½®**: `AstrumServer/AstrumServer/Core/GameServer.cs`

**èŒè´£**:
- å¤„ç†æ‰€æœ‰å®¢æˆ·ç«¯æ¶ˆæ¯
- åè°ƒå„ä¸ªç®¡ç†å™¨ï¼ˆUserManager, RoomManagerç­‰ï¼‰
- æœåŠ¡å™¨ä¸»å¾ªç¯

#### 3. ç®¡ç†å™¨ç³»ç»Ÿ

- **UserManager**: ç”¨æˆ·ç™»å½•ã€ä¼šè¯ç®¡ç†
- **RoomManager**: æˆ¿é—´åˆ›å»ºã€åŠ å…¥ã€ç¦»å¼€
- **MatchmakingManager**: å¿«é€ŸåŒ¹é…é˜Ÿåˆ—ç®¡ç†
- **FrameSyncManager**: å¸§åŒæ­¥ç®¡ç†

---

## æ¶ˆæ¯ç³»ç»Ÿ

### æ¶ˆæ¯å®šä¹‰

æ‰€æœ‰ç½‘ç»œæ¶ˆæ¯éƒ½ç»§æ‰¿è‡ª `MessageObject`ï¼Œé€šè¿‡ Protocol Buffers å®šä¹‰åè®®æ–‡ä»¶ï¼Œä½¿ç”¨å·¥å…·è‡ªåŠ¨ç”ŸæˆC#ä»£ç ã€‚

**åè®®æ–‡ä»¶ä½ç½®**: `AstrumConfig/Proto/`

**ä¸»è¦åè®®æ–‡ä»¶**:
- `networkcommon_C_1000.proto` - ç½‘ç»œé€šç”¨æ¶ˆæ¯ï¼ˆè¿æ¥ã€å¿ƒè·³ç­‰ï¼‰
- `gamemessages_C_2000.proto` - æ¸¸æˆæ¶ˆæ¯ï¼ˆè¾“å…¥ã€å¸§åŒæ­¥ç­‰ï¼‰
- `game_S_3000.proto` - æœåŠ¡å™¨æ¸¸æˆæ¶ˆæ¯
- `connectionstatus_C_4000.proto` - è¿æ¥çŠ¶æ€æ¶ˆæ¯

### æ¶ˆæ¯æ ¼å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯å¤´ (4 bytes)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Length (2 bytes)    | æ¶ˆæ¯ä½“é•¿åº¦        â”‚
â”‚  OpCode (2 bytes)    | æ¶ˆæ¯ç±»å‹ç         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯ä½“ (N bytes)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MemoryPackåºåˆ—åŒ–çš„æ¶ˆæ¯æ•°æ®               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¶ˆæ¯åºåˆ—åŒ–

- **åºåˆ—åŒ–åº“**: MemoryPack (é«˜æ€§èƒ½äºŒè¿›åˆ¶åºåˆ—åŒ–)
- **åè®®å®šä¹‰**: Protocol Buffers (.protoæ–‡ä»¶)
- **ä»£ç ç”Ÿæˆ**: é€šè¿‡Proto2CSå·¥å…·è‡ªåŠ¨ç”Ÿæˆ

### OpCodeç®¡ç†

**ä½ç½®**: `AstrumProj/Assets/Script/Network/OpcodeType.cs`

æ‰€æœ‰æ¶ˆæ¯ç±»å‹éƒ½é€šè¿‡OpCodeæ³¨å†Œï¼Œæ”¯æŒæ¶ˆæ¯ç±»å‹åˆ°OpCodeçš„åŒå‘æ˜ å°„ã€‚

---

## è¿æ¥æµç¨‹

### å®¢æˆ·ç«¯è¿æ¥æµç¨‹

```
1. ç”¨æˆ·ç‚¹å‡»"è¿æ¥"æŒ‰é’®
   â†“
2. LoginView.ConnectToServer()
   â†“
3. NetworkManager.ConnectAsync(serverAddress, port)
   â†“
4. TServiceå»ºç«‹TCPè¿æ¥
   â†“
5. å®¢æˆ·ç«¯å‘é€ ConnectRequest
   â†“
6. æœåŠ¡å™¨å¤„ç† ConnectRequest
   â†“
7. æœåŠ¡å™¨å‘é€ ConnectResponse
   â†“
8. ConnectMessageHandlerå¤„ç†å“åº”
   â†“
9. å‘å¸ƒ ConnectResponseEventData äº‹ä»¶
   â†“
10. LoginViewè®¢é˜…äº‹ä»¶ï¼Œæ›´æ–°UIçŠ¶æ€
   â†“
11. è‡ªåŠ¨å‘é€ LoginRequest
   â†“
12. ç™»å½•æˆåŠŸåè¿›å…¥æ¸¸æˆ
```

### æœåŠ¡å™¨è¿æ¥å¤„ç†æµç¨‹

```
1. TServiceæ¥å—æ–°çš„TCPè¿æ¥
   â†“
2. åˆ›å»ºSessionå¯¹è±¡
   â†“
3. è§¦å‘ OnClientConnected äº‹ä»¶
   â†“
4. GameServer.OnClientConnected()
   â†“
5. å‘é€ ConnectResponse (å¯é€‰ï¼Œæˆ–ç­‰å¾…å®¢æˆ·ç«¯ConnectRequest)
   â†“
6. æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
   â†“
7. GameServer.OnMessageReceived()
   â†“
8. æ ¹æ®æ¶ˆæ¯ç±»å‹è·¯ç”±åˆ°å¯¹åº”å¤„ç†æ–¹æ³•
   â†“
9. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
   â†“
10. å‘é€å“åº”æ¶ˆæ¯
```

---

## æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿ

### è®¾è®¡ç†å¿µ

åŸºäºETæ¡†æ¶çš„æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿï¼Œå®ç°äº†çµæ´»ã€å¯æ‰©å±•çš„æ¶ˆæ¯å¤„ç†æ¶æ„ã€‚

### æ ¸å¿ƒç»„ä»¶

#### 1. MessageHandlerAttribute (å¤„ç†å™¨æ ‡è®°)

```csharp
[MessageHandler(typeof(LoginResponse))]
public class LoginMessageHandler : MessageHandlerBase<LoginResponse>
{
    public override async Task HandleMessageAsync(LoginResponse message)
    {
        // å¤„ç†é€»è¾‘
    }
}
```

#### 2. MessageHandlerBase<T> (å¤„ç†å™¨åŸºç±»)

æä¾›ç»Ÿä¸€çš„å¤„ç†å™¨æ¥å£å’ŒåŸºç¡€åŠŸèƒ½ã€‚

#### 3. MessageHandlerRegistry (å¤„ç†å™¨æ³¨å†Œå™¨)

**ä½ç½®**: `AstrumProj/Assets/Script/AstrumClient/MessageHandlers/MessageHandlerRegistry.cs`

**èŒè´£**:
- è‡ªåŠ¨æ‰«ææ‰€æœ‰å¸¦æœ‰`[MessageHandler]`ç‰¹æ€§çš„ç±»
- åˆ›å»ºå¤„ç†å™¨å®ä¾‹
- æ³¨å†Œåˆ°MessageHandlerDispatcher

#### 4. MessageHandlerDispatcher (æ¶ˆæ¯åˆ†å‘å™¨)

**ä½ç½®**: `AstrumProj/Assets/Script/Network/MessageHandlers/MessageHandlerDispatcher.cs`

**èŒè´£**:
- æ ¹æ®æ¶ˆæ¯ç±»å‹è·¯ç”±åˆ°å¯¹åº”çš„å¤„ç†å™¨
- æ”¯æŒå¤šä¸ªå¤„ç†å™¨å¤„ç†åŒä¸€æ¶ˆæ¯ç±»å‹
- æ”¯æŒå¤„ç†å™¨ä¼˜å…ˆçº§

### å¤„ç†å™¨åˆ—è¡¨

å½“å‰å·²å®ç°çš„å¤„ç†å™¨ï¼š

| å¤„ç†å™¨ | æ¶ˆæ¯ç±»å‹ | è¯´æ˜ |
|--------|---------|------|
| ConnectMessageHandler | ConnectResponse | å¤„ç†è¿æ¥å“åº” |
| LoginMessageHandler | LoginResponse | å¤„ç†ç™»å½•å“åº” |
| RoomMessageHandler | CreateRoomResponse, JoinRoomResponseç­‰ | å¤„ç†æˆ¿é—´ç›¸å…³æ¶ˆæ¯ |
| GameMessageHandler | GameStartNotification, GameEndNotificationç­‰ | å¤„ç†æ¸¸æˆæµç¨‹æ¶ˆæ¯ |
| FrameSyncMessageHandler | FrameSyncStartNotificationç­‰ | å¤„ç†å¸§åŒæ­¥æ¶ˆæ¯ |
| MatchMessageHandler | QuickMatchResponseç­‰ | å¤„ç†åŒ¹é…æ¶ˆæ¯ |
| HeartbeatMessageHandler | HeartbeatResponse | å¤„ç†å¿ƒè·³å“åº” |

### æ¶ˆæ¯å¤„ç†æµç¨‹

```
å®¢æˆ·ç«¯æ¥æ”¶æ¶ˆæ¯:
    â†“
NetworkManager.OnTcpRead()
    â†“
Session.OnRead()
    â†“
ååºåˆ—åŒ–ä¸ºMessageObject
    â†“
MessageHandlerDispatcher.DispatchAsync()
    â†“
æ ¹æ®æ¶ˆæ¯ç±»å‹æŸ¥æ‰¾å¤„ç†å™¨
    â†“
æ‰§è¡Œå¯¹åº”çš„HandleMessageAsync()
    â†“
ä¸šåŠ¡é€»è¾‘å¤„ç†
    â†“
å¯é€‰: å‘å¸ƒäº‹ä»¶åˆ°EventSystem
```

---

## å¸§åŒæ­¥æœºåˆ¶

### å¸§åŒæ­¥æ¦‚è¿°

Astrumä½¿ç”¨**æœåŠ¡å™¨æƒå¨å¸§åŒæ­¥**æœºåˆ¶ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯æ¸¸æˆçŠ¶æ€ä¸€è‡´ã€‚

### å¸§åŒæ­¥æµç¨‹

```
å®¢æˆ·ç«¯:
  1. æ”¶é›†ç©å®¶è¾“å…¥
  2. å‘é€SingleInputåˆ°æœåŠ¡å™¨
  3. æœ¬åœ°é¢„æµ‹æ‰§è¡Œ
  4. æ¥æ”¶æœåŠ¡å™¨å¹¿æ’­çš„OneFrameInputs
  5. éªŒè¯å’Œçº æ­£çŠ¶æ€
  6. æ˜¾ç¤ºç»“æœ

æœåŠ¡å™¨:
  1. æ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯è¾“å…¥
  2. ç­‰å¾…å›ºå®šæ—¶é—´ï¼ˆä¾‹å¦‚20msï¼‰
  3. æ‰§è¡Œç¡®å®šæ€§é€»è¾‘
  4. å¹¿æ’­OneFrameInputsåˆ°æ‰€æœ‰å®¢æˆ·ç«¯
  5. æ¨è¿›æ¸¸æˆå¸§
```

### å¸§åŒæ­¥æ¶ˆæ¯

- **SingleInput** (Câ†’S): å•ä¸ªç©å®¶çš„è¾“å…¥
- **OneFrameInputs** (Sâ†’C): ä¸€å¸§çš„æ‰€æœ‰ç©å®¶è¾“å…¥ï¼ˆå¹¿æ’­ï¼‰
- **FrameSyncStartNotification** (Sâ†’C): å¸§åŒæ­¥å¼€å§‹é€šçŸ¥
- **FrameSyncEndNotification** (Sâ†’C): å¸§åŒæ­¥ç»“æŸé€šçŸ¥

---

## æ€§èƒ½ä¼˜åŒ–

### åºåˆ—åŒ–ä¼˜åŒ–

- ä½¿ç”¨MemoryPackè€ŒéJSONï¼Œæ€§èƒ½æå‡10-100å€
- æ¶ˆæ¯ä½“å‹ç¼©ï¼ˆæœªæ¥è®¡åˆ’ï¼‰

### è¿æ¥ç®¡ç†

- Sessionæ± åŒ–ç®¡ç†
- å¿ƒè·³æœºåˆ¶ä¿æŒè¿æ¥æ´»è·ƒ
- æ–­çº¿é‡è¿ï¼ˆè§„åˆ’ä¸­ï¼‰

### æ¶ˆæ¯æ‰¹å¤„ç†

- æ”¯æŒæ‰¹é‡å‘é€æ¶ˆæ¯
- å‡å°‘ç½‘ç»œå¾€è¿”æ¬¡æ•°

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ¶ˆæ¯ç±»å‹

1. **å®šä¹‰åè®®æ–‡ä»¶** (`.proto`)
   ```protobuf
   message MyNewMessage {
       string data = 1;
   }
   ```

2. **ç”ŸæˆC#ä»£ç **
   ```bash
   # è¿è¡ŒProto2CSå·¥å…·
   cd AstrumTool/Proto2CS
   # ç”Ÿæˆä»£ç 
   ```

3. **åˆ›å»ºæ¶ˆæ¯å¤„ç†å™¨**
   ```csharp
   [MessageHandler(typeof(MyNewMessage))]
   public class MyNewMessageHandler : MessageHandlerBase<MyNewMessage>
   {
       public override async Task HandleMessageAsync(MyNewMessage message)
       {
           // å¤„ç†é€»è¾‘
           await Task.CompletedTask;
       }
   }
   ```

4. **æœåŠ¡å™¨å¤„ç†**
   ```csharp
   // åœ¨GameServer.OnMessageReceivedä¸­æ·»åŠ 
   case MyNewMessage msg:
       HandleMyNewMessage(client, msg);
       break;
   ```

### å‘é€æ¶ˆæ¯

**å®¢æˆ·ç«¯**:
```csharp
var message = MyMessage.Create();
message.data = "Hello";
NetworkManager.Instance.Send(message);
```

**æœåŠ¡å™¨**:
```csharp
var response = MyResponse.Create();
response.success = true;
_serverNetworkManager.SendMessage(sessionId, response);
```

### è°ƒè¯•æŠ€å·§

- å¯ç”¨NetworkManagerçš„Debugæ—¥å¿—
- ä½¿ç”¨Unity ConsoleæŸ¥çœ‹æ¶ˆæ¯æ—¥å¿—
- æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶: `AstrumServer/bin/Debug/net9.0/server.log`

---

## ç›¸å…³æ–‡æ¡£

- [è”æœºæ¨¡å¼è®¾è®¡æ–‡æ¡£](../09-GameModes%20æ¸¸æˆæ¨¡å¼/Network-Multiplayer%20è”æœºæ¨¡å¼.md)
- [æ¶ˆæ¯å¤„ç†å™¨ç³»ç»Ÿå®ç°æ–¹æ¡ˆ](../05-CoreArchitecture%20æ ¸å¿ƒæ¶æ„/åºåˆ—åŒ–/)
- [Protocol Buffersåè®®å®šä¹‰](../../AstrumConfig/Proto/)

---

## å¾…ä¼˜åŒ–é¡¹

- [ ] æ¶ˆæ¯å‹ç¼©
- [ ] æ–­çº¿é‡è¿æœºåˆ¶
- [ ] WebSocketæ”¯æŒï¼ˆç”¨äºWebå®¢æˆ·ç«¯ï¼‰
- [ ] æ¶ˆæ¯åŠ å¯†
- [ ] ç½‘ç»œæµé‡ç›‘æ§å’Œé™æµ

