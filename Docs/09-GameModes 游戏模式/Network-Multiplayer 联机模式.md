# ğŸŒ è”æœºæ¨¡å¼è®¾è®¡æ–‡æ¡£

**ç‰ˆæœ¬**: v1.0.0  
**çŠ¶æ€**: âœ… åŸºç¡€å®Œæˆï¼ŒğŸš§ æŒç»­ä¼˜åŒ–  
**æœ€åæ›´æ–°**: 2025-10-10

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [è®¾è®¡ç›®æ ‡](#è®¾è®¡ç›®æ ‡)
3. [ç½‘ç»œæ¶æ„](#ç½‘ç»œæ¶æ„)
4. [è¿æ¥æµç¨‹](#è¿æ¥æµç¨‹)
5. [æˆ¿é—´ç³»ç»Ÿ](#æˆ¿é—´ç³»ç»Ÿ)
6. [å¸§åŒæ­¥æœºåˆ¶](#å¸§åŒæ­¥æœºåˆ¶)
7. [æ¶ˆæ¯åè®®](#æ¶ˆæ¯åè®®)
8. [çŠ¶æ€åŒæ­¥](#çŠ¶æ€åŒæ­¥)
9. [ä¸å•æœºæ¨¡å¼çš„åŒºåˆ«](#ä¸å•æœºæ¨¡å¼çš„åŒºåˆ«)

---

## æ¦‚è¿°

è”æœºæ¨¡å¼æ˜¯ Astrum æ¸¸æˆçš„åœ¨çº¿å¤šäººå¯¹æˆ˜æ–¹å¼ï¼Œç©å®¶é€šè¿‡è¿æ¥åˆ°æœåŠ¡å™¨ä¸å…¶ä»–ç©å®¶å®æ—¶å¯¹æˆ˜ã€‚è¯¥æ¨¡å¼é‡‡ç”¨**å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„** + **å¸§åŒæ­¥**ï¼Œç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯çš„æ¸¸æˆçŠ¶æ€ä¿æŒä¸€è‡´ã€‚

### æ ¸å¿ƒç‰¹æ€§

- **å®æ—¶å¯¹æˆ˜** - æ”¯æŒå¤šäººåŒæ—¶æ¸¸æˆ
- **å¸§åŒæ­¥** - æœåŠ¡å™¨æƒå¨ï¼Œç¡®ä¿å…¬å¹³æ€§
- **æˆ¿é—´åŒ¹é…** - æˆ¿é—´åˆ›å»ºã€åŠ å…¥ã€ç¦»å¼€
- **ç”¨æˆ·ç®¡ç†** - ç™»å½•ã€çŠ¶æ€ç®¡ç†
- **æ–­çº¿é‡è¿** - æ”¯æŒçŸ­æš‚æ‰çº¿åé‡è¿ï¼ˆè§„åˆ’ä¸­ï¼‰
- **è§‚æˆ˜æ¨¡å¼** - æ”¯æŒè§‚æˆ˜ï¼ˆè§„åˆ’ä¸­ï¼‰

---

## è®¾è®¡ç›®æ ‡

### æ¸¸æˆä½“éªŒç›®æ ‡

1. **ä½å»¶è¿Ÿ** ğŸš€
   - ç›®æ ‡å»¶è¿Ÿ: < 100ms
   - ç½‘ç»œä¼˜åŒ–: æ•°æ®å‹ç¼©ã€å¢é‡æ›´æ–°
   - å®¢æˆ·ç«¯é¢„æµ‹: å‡å°‘æ“ä½œå»¶è¿Ÿæ„Ÿ

2. **ä¸€è‡´æ€§** ğŸ¯
   - æœåŠ¡å™¨æƒå¨
   - ç¡®å®šæ€§é€»è¾‘
   - çŠ¶æ€éªŒè¯å’Œçº æ­£

3. **å…¬å¹³æ€§** âš–ï¸
   - é˜²ä½œå¼Šæœºåˆ¶
   - è¾“å…¥éªŒè¯
   - æœåŠ¡å™¨ä»²è£

4. **ç¨³å®šæ€§** ğŸ›¡ï¸
   - æ–­çº¿é‡è¿
   - å¼‚å¸¸å¤„ç†
   - æˆ¿é—´æ¢å¤

### æŠ€æœ¯ç›®æ ‡

1. **å¯æ‰©å±•æ€§** ğŸ“ˆ
   - æ”¯æŒå¤§é‡å¹¶å‘æˆ¿é—´
   - åŠ¨æ€è´Ÿè½½å‡è¡¡
   - æ°´å¹³æ‰©å±•èƒ½åŠ›

2. **å¯ç»´æŠ¤æ€§** ğŸ”§
   - æ¸…æ™°çš„åè®®å®šä¹‰
   - æ—¥å¿—å’Œç›‘æ§
   - ç‰ˆæœ¬å…¼å®¹æ€§

---

## ç½‘ç»œæ¶æ„

### æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         TCP/IP          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client A  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚   Unity     â”‚                         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚             â”‚
                                        â”‚   Server    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         TCP/IP          â”‚   .NET 9.0  â”‚
â”‚   Client B  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚   Unity     â”‚                         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚             â”‚
                                        â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         TCP/IP          â”‚             â”‚
â”‚   Client C  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚
â”‚   Unity     â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é€šä¿¡åè®®

- **ä¼ è¾“å±‚**: TCP/IP
- **åºåˆ—åŒ–**: Protocol Buffers + MemoryPack
- **æ¶ˆæ¯æ ¼å¼**: 
  ```
  [2 bytes: Length] [2 bytes: OpCode] [N bytes: Payload]
  ```

### æ ¸å¿ƒç»„ä»¶

#### å®¢æˆ·ç«¯ (Unity)

1. **NetworkManager** - ç½‘ç»œç®¡ç†å™¨
   - è¿æ¥ç®¡ç†
   - æ¶ˆæ¯å‘é€/æ¥æ”¶
   - äº‹ä»¶åˆ†å‘

2. **UserManager** - ç”¨æˆ·ç®¡ç†å™¨
   - ç™»å½•/ç™»å‡º
   - ç”¨æˆ·ä¿¡æ¯ç®¡ç†
   - å¿ƒè·³ç»´æŒ

3. **RoomSystemManager** - æˆ¿é—´ç³»ç»Ÿç®¡ç†å™¨
   - æˆ¿é—´åˆ—è¡¨
   - åˆ›å»º/åŠ å…¥/ç¦»å¼€æˆ¿é—´
   - æˆ¿é—´çŠ¶æ€æ›´æ–°

4. **GamePlayManager** - æ¸¸æˆç®¡ç†å™¨
   - æ¸¸æˆç”Ÿå‘½å‘¨æœŸ
   - å¸§åŒæ­¥æ¥æ”¶
   - è¾“å…¥ä¸ŠæŠ¥

#### æœåŠ¡å™¨ (.NET)

1. **GameServer** - æ¸¸æˆæœåŠ¡å™¨ä¸»ä½“
   - ç›‘å¬è¿æ¥
   - ä¼šè¯ç®¡ç†

2. **UserManager** - ç”¨æˆ·ç®¡ç†
   - ç”¨æˆ·æ³¨å†Œ
   - ä¼šè¯æ˜ å°„

3. **RoomManager** - æˆ¿é—´ç®¡ç†
   - æˆ¿é—´åˆ›å»º/é”€æ¯
   - ç©å®¶ç®¡ç†
   - å¸§åŒæ­¥è°ƒåº¦

4. **MessageHandler** - æ¶ˆæ¯å¤„ç†å™¨
   - åè®®è§£æ
   - ä¸šåŠ¡é€»è¾‘
   - å“åº”å‘é€

---

## è¿æ¥æµç¨‹

### å®Œæ•´è¿æ¥æµç¨‹å›¾

```
[1] å®¢æˆ·ç«¯å¯åŠ¨
    â†“
[2] NetworkManager.Initialize()
    â†“
[3] NetworkManager.ConnectAsync(serverIP, port)
    â†“
[4] TCPè¿æ¥å»ºç«‹
    â†“ 
    æœåŠ¡å™¨å“åº”: ConnectResponse
    â†“
[5] å®¢æˆ·ç«¯å‘é€: LoginRequest(displayName)
    â†“
    æœåŠ¡å™¨éªŒè¯ â†’ åˆ›å»ºUser â†’ åˆ†é…UserId
    â†“
    æœåŠ¡å™¨å“åº”: LoginResponse(userInfo)
    â†“
[6] å®¢æˆ·ç«¯ä¿å­˜ UserInfo
    â†“
[7] å®¢æˆ·ç«¯å‘é€: GetRoomListRequest
    â†“
    æœåŠ¡å™¨å“åº”: GetRoomListResponse(roomList)
    â†“
[8] æ˜¾ç¤ºæˆ¿é—´åˆ—è¡¨UI
    â†“
[9] ç©å®¶é€‰æ‹©ï¼šåˆ›å»ºæˆ¿é—´ / åŠ å…¥æˆ¿é—´
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                   â†“                   â†“
[10A] CreateRoomRequest [10B] JoinRoomRequest
    â†“                   â†“
[11A] æœåŠ¡å™¨åˆ›å»ºæˆ¿é—´    [11B] æœåŠ¡å™¨åŠ å…¥æˆ¿é—´
    â†“                   â†“
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
[12] æœåŠ¡å™¨å“åº”: CreateRoomResponse / JoinRoomResponse
    â†“
[13] æœåŠ¡å™¨å¹¿æ’­: RoomUpdateNotification (to all in room)
    â†“
[14] å®¢æˆ·ç«¯æ˜¾ç¤ºæˆ¿é—´å†…UIï¼ˆç©å®¶åˆ—è¡¨ã€å‡†å¤‡çŠ¶æ€ï¼‰
    â†“
[15] æˆ¿ä¸»ç‚¹å‡»"å¼€å§‹æ¸¸æˆ"
    â†“
[16] å®¢æˆ·ç«¯å‘é€: GameRequest(action="StartGame")
    â†“
[17] æœåŠ¡å™¨éªŒè¯æ‰€æœ‰ç©å®¶å‡†å¤‡
    â†“
[18] æœåŠ¡å™¨å¹¿æ’­: GameStartNotification
    â†“
[19] å®¢æˆ·ç«¯åŠ è½½æ¸¸æˆåœºæ™¯
    â†“
[20] å®¢æˆ·ç«¯é€šçŸ¥æœåŠ¡å™¨: GameResponse(ready=true)
    â†“
[21] æœåŠ¡å™¨ç­‰å¾…æ‰€æœ‰å®¢æˆ·ç«¯å‡†å¤‡å®Œæˆ
    â†“
[22] æœåŠ¡å™¨å¹¿æ’­: FrameSyncStartNotification
    â†“
[23] å¼€å§‹å¸§åŒæ­¥å¾ªç¯
    â†“
æ¸¸æˆè¿›è¡Œä¸­...
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### Step 1-4: å»ºç«‹ç½‘ç»œè¿æ¥

```csharp
// å®¢æˆ·ç«¯
await NetworkManager.Instance.ConnectAsync("127.0.0.1", 8080);

// æœåŠ¡å™¨è‡ªåŠ¨å“åº” ConnectResponse
```

#### Step 5-6: ç”¨æˆ·ç™»å½•

```csharp
// å®¢æˆ·ç«¯å‘é€ç™»å½•è¯·æ±‚
var loginRequest = new LoginRequest 
{ 
    DisplayName = "PlayerName"
};
NetworkManager.Instance.Send(loginRequest);

// æœåŠ¡å™¨å“åº”
NetworkManager.Instance.OnLoginResponse += (response) => 
{
    if (response.Success)
    {
        UserManager.Instance.SetCurrentUser(response.UserInfo);
        ASLogger.Instance.Info($"ç™»å½•æˆåŠŸ: {response.UserInfo.DisplayName}");
    }
};
```

**æœåŠ¡å™¨å¤„ç†**:
```csharp
// åˆ›å»ºç”¨æˆ·
var user = new UserInfo
{
    Id = GenerateUserId(),
    DisplayName = request.DisplayName,
    LastLoginAt = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};

userManager.AddUser(user, session);

// å“åº”
var response = new LoginResponse
{
    Success = true,
    UserInfo = user
};
session.Send(response);
```

#### Step 7-8: è·å–æˆ¿é—´åˆ—è¡¨

```csharp
// å®¢æˆ·ç«¯è¯·æ±‚
var getRoomListRequest = new GetRoomListRequest
{
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};
NetworkManager.Instance.Send(getRoomListRequest);

// å®¢æˆ·ç«¯æ¥æ”¶
NetworkManager.Instance.OnGetRoomListResponse += (response) => 
{
    RoomSystemManager.Instance.UpdateRoomList(response.Rooms);
    // åˆ·æ–°UIæ˜¾ç¤ºæˆ¿é—´åˆ—è¡¨
};
```

#### Step 10-14: æˆ¿é—´æ“ä½œ

**åˆ›å»ºæˆ¿é—´**:
```csharp
// å®¢æˆ·ç«¯
var createRoomRequest = new CreateRoomRequest
{
    RoomName = "My Room",
    MaxPlayers = 4,
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};
NetworkManager.Instance.Send(createRoomRequest);

// å“åº”
NetworkManager.Instance.OnCreateRoomResponse += (response) => 
{
    if (response.Success)
    {
        RoomSystemManager.Instance.JoinRoom(response.RoomInfo);
        // è¿›å…¥æˆ¿é—´UI
    }
};
```

**åŠ å…¥æˆ¿é—´**:
```csharp
// å®¢æˆ·ç«¯
var joinRoomRequest = new JoinRoomRequest
{
    RoomId = selectedRoom.Id,
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};
NetworkManager.Instance.Send(joinRoomRequest);
```

**æˆ¿é—´æ›´æ–°é€šçŸ¥** (æœåŠ¡å™¨å¹¿æ’­):
```csharp
// æœåŠ¡å™¨
var notification = new RoomUpdateNotification
{
    RoomInfo = updatedRoomInfo,
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};

// å¹¿æ’­ç»™æˆ¿é—´å†…æ‰€æœ‰ç©å®¶
room.BroadcastToAll(notification);
```

#### Step 15-22: å¼€å§‹æ¸¸æˆ

```csharp
// æˆ¿ä¸»å‘èµ·
var gameRequest = new GameRequest
{
    RequestId = GenerateRequestId(),
    Action = "StartGame"
};
NetworkManager.Instance.Send(gameRequest);

// æœåŠ¡å™¨éªŒè¯å¹¶å¹¿æ’­
var startNotification = new GameStartNotification
{
    RoomId = room.Id,
    Timestamp = DateTimeOffset.UtcNow.ToUnixTimeMilliseconds()
};
room.BroadcastToAll(startNotification);

// å®¢æˆ·ç«¯åŠ è½½åœºæ™¯
NetworkManager.Instance.OnGameStartNotification += (notification) => 
{
    GamePlayManager.Instance.LoadGameScene();
};
```

---

## æˆ¿é—´ç³»ç»Ÿ

### æˆ¿é—´çŠ¶æ€æœº

```
[Idle ç©ºé—²]
    â†“ CreateRoom
[Waiting ç­‰å¾…]
    â†“ AllPlayersReady
[Starting å¯åŠ¨ä¸­]
    â†“ AllClientsLoaded
[Running è¿è¡Œä¸­]
    â†“ GameEnd
[Ending ç»“æŸä¸­]
    â†“ Cleanup
[Idle ç©ºé—²]
```

### æˆ¿é—´æ•°æ®ç»“æ„

```csharp
public class Room
{
    public string RoomId { get; set; }
    public string RoomName { get; set; }
    public int MaxPlayers { get; set; }
    public List<UserInfo> Players { get; set; }
    public RoomState State { get; set; }
    public DateTime CreatedAt { get; set; }
    
    // å¸§åŒæ­¥ç›¸å…³
    public int CurrentFrame { get; set; }
    public FrameSyncManager FrameSyncManager { get; set; }
    
    // æ¸¸æˆé€»è¾‘
    public World MainWorld { get; set; }
}

public enum RoomState
{
    Idle,       // ç©ºé—²
    Waiting,    // ç­‰å¾…ç©å®¶
    Starting,   // å¯åŠ¨ä¸­
    Running,    // è¿è¡Œä¸­
    Ending      // ç»“æŸä¸­
}
```

### æˆ¿é—´ç®¡ç†å™¨

```csharp
public class RoomManager
{
    private Dictionary<string, Room> _rooms = new();
    
    // åˆ›å»ºæˆ¿é—´
    public Room CreateRoom(string roomName, int maxPlayers, UserInfo creator);
    
    // åŠ å…¥æˆ¿é—´
    public bool JoinRoom(string roomId, UserInfo user);
    
    // ç¦»å¼€æˆ¿é—´
    public void LeaveRoom(string roomId, UserInfo user);
    
    // è·å–æˆ¿é—´åˆ—è¡¨
    public List<RoomInfo> GetRoomList();
    
    // é”€æ¯æˆ¿é—´
    public void DestroyRoom(string roomId);
}
```

---

## å¸§åŒæ­¥æœºåˆ¶

### å¸§åŒæ­¥åŸç†

```
æœåŠ¡å™¨ä¸»å¾ªç¯ (æ¯16.67ms, 60 FPS)
    â†“
[1] æ”¶é›†æ‰€æœ‰å®¢æˆ·ç«¯çš„è¾“å…¥
    â†“
[2] ç»„è£…å½“å‰å¸§è¾“å…¥æ•°æ®
    â†“
[3] å¹¿æ’­ç»™æˆ¿é—´å†…æ‰€æœ‰å®¢æˆ·ç«¯
    â†“
[4] å®¢æˆ·ç«¯æ‰§è¡Œç›¸åŒå¸§
    â†“
[5] çŠ¶æ€ä¿æŒåŒæ­¥
```

### è¾“å…¥ä¸ŠæŠ¥æµç¨‹

```
å®¢æˆ·ç«¯æ¯å¸§:
    â†“
[1] InputManager.GetInput()
    - è¯»å–é”®ç›˜/é¼ æ ‡è¾“å…¥
    â†“
[2] æ„é€  SingleInput æ¶ˆæ¯
    SingleInput {
        PlayerId = localPlayerId,
        Input = {
            MoveX, MoveY,
            Attack, Skill, ...
        },
        Frame = currentFrame
    }
    â†“
[3] NetworkManager.Send(SingleInput)
    - å‘é€åˆ°æœåŠ¡å™¨
    â†“
æœåŠ¡å™¨æ”¶åˆ°:
    â†“
[4] FrameSyncManager.AddInput(playerId, input)
    - å­˜å‚¨åˆ°å½“å‰å¸§è¾“å…¥ç¼“å†²åŒº
    â†“
[5] ç­‰å¾…æ‰€æœ‰ç©å®¶è¾“å…¥æˆ–è¶…æ—¶
    â†“
[6] ç»„è£… OneFrameInputs
    OneFrameInputs {
        Frame = currentFrame,
        Inputs = [player1Input, player2Input, ...]
    }
    â†“
[7] Room.BroadcastToAll(OneFrameInputs)
    - å¹¿æ’­ç»™æ‰€æœ‰å®¢æˆ·ç«¯
    â†“
å®¢æˆ·ç«¯æ”¶åˆ°:
    â†“
[8] GamePlayManager.DealNetFrameInputs(inputs)
    â†“
[9] Room.Tick(inputs)
    - æ‰§è¡Œé€»è¾‘å¸§
    â†“
[10] æ‰€æœ‰å®¢æˆ·ç«¯ä¿æŒåŒæ­¥
```

### å¸§åŒæ­¥æ•°æ®ç»“æ„

```protobuf
// å•ä¸ªç©å®¶çš„è¾“å…¥
message SingleInput
{
    int64 PlayerId = 1;
    Input Input = 2;
    int32 Frame = 3;
}

// ä¸€å¸§çš„æ‰€æœ‰è¾“å…¥
message OneFrameInputs
{
    int32 Frame = 1;
    repeated Input Inputs = 2;
}

// å¸§åŒæ­¥æ•°æ® (æœåŠ¡å™¨å¹¿æ’­)
message FrameSyncData
{
    int32 Frame = 1;
    repeated Input PlayerInputs = 2;
    int64 Timestamp = 3;
}
```

### å…³é”®ä»£ç 

**å®¢æˆ·ç«¯è¾“å…¥ä¸ŠæŠ¥**:
```csharp
void Update()
{
    // æ”¶é›†è¾“å…¥
    var input = InputManager.Instance.GetCurrentInput();
    input.PlayerId = GamePlayManager.Instance.PlayerId;
    input.Frame = currentFrame;
    
    // ä¸ŠæŠ¥æœåŠ¡å™¨
    var singleInput = new SingleInput
    {
        PlayerId = input.PlayerId,
        Input = input,
        Frame = currentFrame
    };
    NetworkManager.Instance.Send(singleInput);
}
```

**å®¢æˆ·ç«¯æ¥æ”¶å¸§æ•°æ®**:
```csharp
NetworkManager.Instance.OnFrameInputs += (frameInputs) => 
{
    GamePlayManager.Instance.DealNetFrameInputs(frameInputs);
};

public void DealNetFrameInputs(OneFrameInputs frameInputs)
{
    if (MainRoom == null) return;
    
    // æ‰§è¡Œé€»è¾‘å¸§
    MainRoom.Tick(frameInputs.Inputs);
    
    // åŒæ­¥åˆ°è¡¨ç°å±‚
    MainStage.Tick();
}
```

**æœåŠ¡å™¨å¸§å¾ªç¯**:
```csharp
// æœåŠ¡å™¨ä¸»å¾ªç¯ (60 FPS)
while (room.State == RoomState.Running)
{
    // 1. æ”¶é›†è¾“å…¥ï¼ˆå¸¦è¶…æ—¶ï¼‰
    var inputs = frameSyncManager.CollectInputs(currentFrame, timeoutMs: 50);
    
    // 2. ç»„è£…å¸§æ•°æ®
    var frameInputs = new OneFrameInputs
    {
        Frame = currentFrame,
        Inputs = inputs
    };
    
    // 3. å¹¿æ’­
    room.BroadcastToAll(frameInputs);
    
    // 4. æ‰§è¡ŒæœåŠ¡å™¨é€»è¾‘å¸§ï¼ˆå¦‚éœ€è¦ï¼‰
    // room.Tick(inputs);
    
    currentFrame++;
    await Task.Delay(16); // 60 FPS â‰ˆ 16.67ms
}
```

---

## æ¶ˆæ¯åè®®

### åè®®åˆ†ç±»

#### 1. è¿æ¥åè®®
| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| ConnectResponse | Sâ†’C | è¿æ¥ç¡®è®¤ |
| HeartbeatRequest | Câ†’S | å¿ƒè·³è¯·æ±‚ |
| HeartbeatResponse | Sâ†’C | å¿ƒè·³å“åº” |
| C2G_Ping | Câ†’S | Pingæµ‹è¯• |
| G2C_Ping | Sâ†’C | Pongå“åº” |

#### 2. ç”¨æˆ·åè®®
| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| LoginRequest | Câ†’S | ç™»å½•è¯·æ±‚ |
| LoginResponse | Sâ†’C | ç™»å½•å“åº” |

#### 3. æˆ¿é—´åè®®
| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| GetRoomListRequest | Câ†’S | è·å–æˆ¿é—´åˆ—è¡¨ |
| GetRoomListResponse | Sâ†’C | æˆ¿é—´åˆ—è¡¨å“åº” |
| CreateRoomRequest | Câ†’S | åˆ›å»ºæˆ¿é—´ |
| CreateRoomResponse | Sâ†’C | åˆ›å»ºæˆ¿é—´å“åº” |
| JoinRoomRequest | Câ†’S | åŠ å…¥æˆ¿é—´ |
| JoinRoomResponse | Sâ†’C | åŠ å…¥æˆ¿é—´å“åº” |
| LeaveRoomRequest | Câ†’S | ç¦»å¼€æˆ¿é—´ |
| LeaveRoomResponse | Sâ†’C | ç¦»å¼€æˆ¿é—´å“åº” |
| RoomUpdateNotification | Sâ†’C | æˆ¿é—´æ›´æ–°é€šçŸ¥ (å¹¿æ’­) |

#### 4. æ¸¸æˆåè®®
| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| GameRequest | Câ†’S | æ¸¸æˆè¯·æ±‚ï¼ˆå¼€å§‹ã€æš‚åœç­‰ï¼‰ |
| GameResponse | Sâ†’C | æ¸¸æˆå“åº” |
| GameStartNotification | Sâ†’C | æ¸¸æˆå¼€å§‹é€šçŸ¥ (å¹¿æ’­) |
| GameEndNotification | Sâ†’C | æ¸¸æˆç»“æŸé€šçŸ¥ (å¹¿æ’­) |
| GameStateUpdate | Sâ†’C | æ¸¸æˆçŠ¶æ€æ›´æ–° |

#### 5. å¸§åŒæ­¥åè®®
| æ¶ˆæ¯ | æ–¹å‘ | è¯´æ˜ |
|------|------|------|
| SingleInput | Câ†’S | å•ä¸ªç©å®¶è¾“å…¥ |
| OneFrameInputs | Sâ†’C | ä¸€å¸§çš„æ‰€æœ‰è¾“å…¥ (å¹¿æ’­) |
| FrameSyncStartNotification | Sâ†’C | å¸§åŒæ­¥å¼€å§‹ |
| FrameSyncEndNotification | Sâ†’C | å¸§åŒæ­¥ç»“æŸ |
| FrameSyncData | Sâ†’C | å¸§åŒæ­¥æ•°æ® (å¤‡ç”¨) |

### æ¶ˆæ¯å¤„ç†æµç¨‹

```
å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯:
    â†“
NetworkManager.Send(message)
    â†“
Session.Send(bytes)
    â†“
TService.Send(bytes)
    â†“
TCPå‘é€
    â†“
=== ç½‘ç»œä¼ è¾“ ===
    â†“
æœåŠ¡å™¨æ¥æ”¶:
    â†“
TService.OnRead(bytes)
    â†“
Session.OnRead(message)
    â†“
MessageHandler.Handle(message)
    â†“
ä¸šåŠ¡é€»è¾‘å¤„ç†
    â†“
æ„é€ å“åº”æ¶ˆæ¯
    â†“
Session.Send(response)
    â†“
=== ç½‘ç»œä¼ è¾“ ===
    â†“
å®¢æˆ·ç«¯æ¥æ”¶:
    â†“
TService.OnRead(bytes)
    â†“
Session.OnRead(message)
    â†“
NetworkManager.OnMessage(message)
    â†“
è§¦å‘å¯¹åº”äº‹ä»¶
    â†“
ä¸šåŠ¡å±‚å¤„ç†
```

---

## çŠ¶æ€åŒæ­¥

### åŒæ­¥å†…å®¹

#### å¿…é¡»åŒæ­¥
- âœ… ç©å®¶è¾“å…¥
- âœ… å®ä½“ä½ç½®ï¼ˆé€šè¿‡å¸§åŒæ­¥ä¿è¯ï¼‰
- âœ… å®ä½“çŠ¶æ€ï¼ˆHPã€æŠ€èƒ½CDç­‰ï¼‰
- âœ… æŠ€èƒ½è§¦å‘
- âœ… ä¼¤å®³äº‹ä»¶

#### ä¸éœ€è¦åŒæ­¥ï¼ˆæœ¬åœ°è¡¨ç°ï¼‰
- âŒ åŠ¨ç”»æ’­æ”¾
- âŒ ç‰¹æ•ˆæ˜¾ç¤º
- âŒ éŸ³æ•ˆæ’­æ”¾
- âŒ UIæ›´æ–°

### ä¸€è‡´æ€§ä¿è¯

1. **ç¡®å®šæ€§é€»è¾‘**
   - ä½¿ç”¨ TrueSync (FP Math)
   - é¿å…æµ®ç‚¹æ•°è¯¯å·®
   - é¿å…éç¡®å®šæ€§éšæœº

2. **æœåŠ¡å™¨æƒå¨**
   - æœåŠ¡å™¨é©±åŠ¨å¸§
   - è¾“å…¥éªŒè¯
   - çŠ¶æ€ä»²è£

3. **å®¢æˆ·ç«¯é¢„æµ‹** (è§„åˆ’ä¸­)
   - æœ¬åœ°é¢„æµ‹æ‰§è¡Œ
   - æœåŠ¡å™¨éªŒè¯
   - çŠ¶æ€å›æ»šçº æ­£

---

## ä¸å•æœºæ¨¡å¼çš„åŒºåˆ«

### æ ¸å¿ƒå·®å¼‚

| ç‰¹æ€§ | å•æœºæ¨¡å¼ | è”æœºæ¨¡å¼ |
|------|----------|----------|
| **æ¶æ„** | æœ¬åœ° | å®¢æˆ·ç«¯-æœåŠ¡å™¨ |
| **Room** | æœ¬åœ°åˆ›å»º | æœåŠ¡å™¨åˆ›å»º |
| **å¸§é©±åŠ¨** | Unity Update() | æœåŠ¡å™¨æ¨é€ |
| **è¾“å…¥** | ç›´æ¥åº”ç”¨ | ä¸ŠæŠ¥â†’å¹¿æ’­ |
| **å»¶è¿Ÿ** | 0ms | 10-100ms |
| **å¯¹æ‰‹** | AI | çœŸå®ç©å®¶ |
| **æš‚åœ** | âœ… | âŒ |
| **ä½œå¼Š** | æ— å½±å“ | éœ€é˜²èŒƒ |
| **è°ƒè¯•** | ç®€å• | å¤æ‚ |

### ä»£ç å¤ç”¨

**100%å¤ç”¨çš„é€»è¾‘å±‚**:
- âœ… Entity-Component-Capability
- âœ… æˆ˜æ–—ç³»ç»Ÿ
- âœ… ç‰©ç†ç³»ç»Ÿ
- âœ… æŠ€èƒ½ç³»ç»Ÿ
- âœ… å¸§åŒæ­¥é€»è¾‘æ ¸å¿ƒ

**ä¸åŒçš„éƒ¨åˆ†**:
- âŒ è¾“å…¥æ¥æº (æœ¬åœ° vs ç½‘ç»œ)
- âŒ å¸§é©±åŠ¨ (Update vs æœåŠ¡å™¨æ¨é€)
- âŒ Roomç®¡ç† (æœ¬åœ° vs æœåŠ¡å™¨)

---

## ä¼˜åŒ–ç­–ç•¥

### ç½‘ç»œä¼˜åŒ–

1. **æ¶ˆæ¯å‹ç¼©**
   - MemoryPackäºŒè¿›åˆ¶åºåˆ—åŒ–
   - å·®é‡ç¼–ç ï¼ˆè§„åˆ’ä¸­ï¼‰
   - æ‰¹é‡æ‰“åŒ…ï¼ˆè§„åˆ’ä¸­ï¼‰

2. **å¸¦å®½ä¼˜åŒ–**
   - è¾“å…¥æ•°æ®å‹ç¼©ï¼ˆä½¿ç”¨byteè€Œéintï¼‰
   - åªåŒæ­¥å˜åŒ–çš„æ•°æ®
   - ä¼˜å…ˆçº§é˜Ÿåˆ—

3. **å»¶è¿Ÿä¼˜åŒ–**
   - å®¢æˆ·ç«¯é¢„æµ‹ï¼ˆè§„åˆ’ä¸­ï¼‰
   - æ’å€¼å¹³æ»‘
   - UDPä¼˜åŒ–ï¼ˆè§„åˆ’ä¸­ï¼‰

### æœåŠ¡å™¨ä¼˜åŒ–

1. **å¹¶å‘ä¼˜åŒ–**
   - å¼‚æ­¥I/O
   - æˆ¿é—´ç‹¬ç«‹tick
   - æ— é”é˜Ÿåˆ—

2. **å†…å­˜ä¼˜åŒ–**
   - å¯¹è±¡æ± 
   - å¢é‡GC
   - å†…å­˜é¢„åˆ†é…

---

## å·²çŸ¥é™åˆ¶

### å½“å‰é™åˆ¶

1. **æˆ¿é—´å®¹é‡** - å•æˆ¿é—´å»ºè®® â‰¤ 4äºº
2. **æ–­çº¿é‡è¿** - æœªå®ç°
3. **è§‚æˆ˜æ¨¡å¼** - æœªå®ç°
4. **å®¢æˆ·ç«¯é¢„æµ‹** - æœªå®ç°
5. **çŠ¶æ€å›æ»š** - æœªå®ç°

### æŠ€æœ¯å€ºåŠ¡

1. **UDPæ”¯æŒ** - å½“å‰ä»…TCP
2. **è´Ÿè½½å‡è¡¡** - æœªå®ç°
3. **æˆ¿é—´æŒä¹…åŒ–** - æœªå®ç°
4. **å½•åƒå›æ”¾** - æœªå®ç°

---

## ç›¸å…³æ–‡æ¡£

- [è”æœºæ¨¡å¼å¼€å‘è¿›å±•](_status%20å¼€å‘è¿›å±•/Network-Multiplayer-Progress%20è”æœºæ¨¡å¼å¼€å‘è¿›å±•.md) - è¯¦ç»†å¼€å‘è®°å½•
- [å•æœºæ¨¡å¼](Single-Player%20å•æœºæ¨¡å¼.md) - å¯¹æ¯”å‚è€ƒ
- [æˆ¿é—´ç³»ç»Ÿ](../01-GameDesign%20æ¸¸æˆè®¾è®¡/Room-System%20æˆ¿é—´ç³»ç»Ÿ.md) - æˆ¿é—´ç³»ç»Ÿè¯¦ç»†è®¾è®¡
- [æœåŠ¡å™¨é…ç½®](../07-Development%20å¼€å‘æŒ‡å—/Server-Setup%20æœåŠ¡å™¨é…ç½®.md) - æœåŠ¡å™¨éƒ¨ç½²

---

**æœ€åæ›´æ–°**: 2025-10-10  
**ç»´æŠ¤è€…**: å¼€å‘å›¢é˜Ÿ



