# æŠ€èƒ½æ•ˆæœç³»ç»Ÿæ¶æ„ä¿®è®¢ - v1.2 Review

**æ—¥æœŸ**: 2025-11-06  
**çŠ¶æ€**: å¾… Review  

---

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**v1.1 è®¾è®¡ä¸­çš„é—®é¢˜**ï¼š
```
SkillExecutorCapability â†’ å‘é€ SkillEffectEvent â†’ HitReactionCapability
                                                      â†“
                                        âŒ èŒè´£è¿‡é‡ï¼šæ•ˆæœé€»è¾‘ + ä¿®æ”¹ç»„ä»¶ + æ’­æ”¾è¡¨ç°
                                        âŒ ç ´åå°è£…ï¼šå¤–éƒ¨ Capability ç›´æ¥ä¿®æ”¹å…¶ä»–å®ä½“ç»„ä»¶
```

---

## âœ… ä¿®è®¢æ–¹æ¡ˆ

### èŒè´£åˆ†ç¦»åŸåˆ™

```
ã€EffectHandlerã€‘          ã€Capabilityã€‘
åªè¯»å¤–éƒ¨ç»„ä»¶              æ¥æ”¶äº‹ä»¶
  â†“                         â†“
è®¡ç®—æ•ˆæœå‚æ•°              ä¿®æ”¹è‡ªèº«ç»„ä»¶
  â†“                         â†“
å‘é€äº‹ä»¶                  åº”ç”¨æ•ˆæœ
```

### å®Œæ•´é“¾è·¯ï¼ˆv1.2.1 ä¿®è®¢ - å®Œå…¨å°è£…ï¼‰

```
ã€1ã€‘SkillExecutorCapability
     â†“ ç¢°æ’æ£€æµ‹
     â†“ è°ƒç”¨ SkillEffectSystem.QueueSkillEffect(SkillEffectData)
     
ã€2ã€‘SkillEffectSystem.Update()
     â†“ ä»é˜Ÿåˆ—å–å‡ºæ•ˆæœ
     â†“ åˆ†å‘åˆ°å¯¹åº”çš„ EffectHandler
     
ã€3ã€‘EffectHandler.Handle() - åªè¯»å¤–éƒ¨ï¼Œåªå‘é€äº‹ä»¶
     
     3a. DamageEffectHandler (type=1 ä¼¤å®³)
         â”œâ”€ è¯»å– Stats ç»„ä»¶ï¼ˆè®¡ç®—ä¼¤å®³ï¼‰
         â”œâ”€ âŒ ä¸ä¿®æ”¹ä»»ä½•ç»„ä»¶
         â”œâ”€ å‘é€ DamageEvent â†’ DamageCapability
         â””â”€ å‘é€ HitReactionEvent â†’ HitReactionCapability
         
     3b. KnockbackEffectHandler (type=3 å‡»é€€)
         â”œâ”€ è¯»å– Trans ç»„ä»¶ï¼ˆè®¡ç®—æ–¹å‘ï¼‰
         â”œâ”€ âŒ ä¸ä¿®æ”¹ä»»ä½•ç»„ä»¶
         â”œâ”€ å‘é€ KnockbackEvent â†’ KnockbackCapability
         â””â”€ å‘é€ HitReactionEvent â†’ HitReactionCapability
         
ã€4ã€‘Capability å“åº”äº‹ä»¶ - åªèƒ½ä¿®æ”¹è‡ªèº«å®ä½“çš„ç»„ä»¶
     
     4a. DamageCapability (æ¥æ”¶ DamageEvent) â† æ–°å¢
         â”œâ”€ ä¿®æ”¹ DynamicStatsï¼ˆæ‰£è¡€ï¼‰
         â”œâ”€ æ£€æŸ¥æ­»äº¡
         â””â”€ å‘å¸ƒæ­»äº¡äº‹ä»¶ï¼ˆViewå±‚ï¼‰
     
     4b. HitReactionCapability (æ¥æ”¶ HitReactionEvent)
         â”œâ”€ æ’­æ”¾å—å‡»åŠ¨ä½œï¼ˆæ ¹æ®æ–¹å‘ï¼‰
         â””â”€ æ’­æ”¾å—å‡»ç‰¹æ•ˆ
         
     4c. KnockbackCapability (æ¥æ”¶ KnockbackEvent)
         â”œâ”€ å†™å…¥ KnockbackComponent
         â”œâ”€ ç¦ç”¨ç§»åŠ¨è¾“å…¥
         â””â”€ Tick: åº”ç”¨å‡»é€€ä½ç§»
```

---

## ğŸ“Š å¯¹æ¯”è¡¨

### Handler èŒè´£åˆ’åˆ†ï¼ˆv1.2.1 å®Œå…¨å°è£…ç‰ˆï¼‰

| Handler                  | è¯»å–æ•°æ®      | ä¿®æ”¹æ•°æ® | å‘é€äº‹ä»¶                         |
| ------------------------ | ------------- | -------- | -------------------------------- |
| `DamageEffectHandler`    | Stats ç»„ä»¶    | âŒ ä¸ä¿®æ”¹ | DamageEvent, HitReactionEvent    |
| `KnockbackEffectHandler` | Trans ç»„ä»¶    | âŒ ä¸ä¿®æ”¹ | KnockbackEvent, HitReactionEvent |
| `HealEffectHandler`      | Stats ç»„ä»¶    | âŒ ä¸ä¿®æ”¹ | HealEvent, HitReactionEvent      |

> **æ ¸å¿ƒåŸåˆ™**ï¼š**Handler åªè¯»ä¸å†™ï¼Œæ‰€æœ‰ç»„ä»¶ä¿®æ”¹éƒ½ç”±å®ä½“è‡ªèº«çš„ Capability å®Œæˆ**

### Capability èŒè´£åˆ’åˆ†ï¼ˆv1.2.1 å®Œå…¨å°è£…ç‰ˆï¼‰

| Capability              | æ¥æ”¶äº‹ä»¶         | ä¿®æ”¹ç»„ä»¶            | Tick èŒè´£        |
| ----------------------- | ---------------- | ------------------- | ---------------- |
| `DamageCapability`      | DamageEvent      | DynamicStatsï¼ˆæ‰£è¡€ï¼‰ | æ£€æŸ¥æ­»äº¡çŠ¶æ€     |
| `HealCapability`        | HealEvent        | DynamicStatsï¼ˆåŠ è¡€ï¼‰ | -                |
| `HitReactionCapability` | HitReactionEvent | âŒ ä¸ä¿®æ”¹           | æ’­æ”¾å—å‡»è¡¨ç°     |
| `KnockbackCapability`   | KnockbackEvent   | KnockbackComponent  | åº”ç”¨å‡»é€€ä½ç§»     |

> **æ ¸å¿ƒåŸåˆ™**ï¼š**Capability åªèƒ½ä¿®æ”¹è‡ªèº«å®ä½“çš„ç»„ä»¶ï¼Œä¸èƒ½ä¿®æ”¹å…¶ä»–å®ä½“**

---

## ğŸ†• æ–°å¢äº‹ä»¶å®šä¹‰ï¼ˆv1.2.1 å®Œå…¨å°è£…ç‰ˆï¼‰

### DamageEventï¼ˆæ–°å¢ï¼‰

```csharp
public struct DamageEvent
{
    public long CasterId;        // æ–½æ³•è€…ID
    public int EffectId;         // æ•ˆæœID
    public FP Damage;            // è®¡ç®—åçš„æœ€ç»ˆä¼¤å®³å€¼
    public bool IsCritical;      // æ˜¯å¦æš´å‡»
    public int DamageType;       // ä¼¤å®³ç±»å‹ï¼ˆ1=ç‰©ç†/2=é­”æ³•/3=çœŸå®ï¼‰
}
```

**å‘é€æ–¹**ï¼š`DamageEffectHandler`  
**æ¥æ”¶æ–¹**ï¼š`DamageCapability`

---

### KnockbackEvent

```csharp
public struct KnockbackEvent
{
    public long CasterId;        // æ–½æ³•è€…ID
    public int EffectId;         // æ•ˆæœID
    public TSVector Direction;   // å‡»é€€æ–¹å‘ï¼ˆå•ä½å‘é‡ï¼‰
    public FP Distance;          // å‡»é€€è·ç¦»ï¼ˆç±³ï¼‰
    public FP Duration;          // å‡»é€€æ—¶é—´ï¼ˆç§’ï¼‰
    public KnockbackType Type;   // å‡»é€€ç±»å‹
}
```

**å‘é€æ–¹**ï¼š`KnockbackEffectHandler`  
**æ¥æ”¶æ–¹**ï¼š`KnockbackCapability`

---

### HitReactionEvent

```csharp
public struct HitReactionEvent
{
    public long CasterId;        // æ–½æ³•è€…ID
    public long TargetId;        // å—å‡»è€…ID
    public int EffectId;         // æ•ˆæœID
    public int EffectType;       // æ•ˆæœç±»å‹ï¼ˆ1=ä¼¤å®³ç­‰ï¼‰
    public TSVector HitDirection;// å—å‡»æ–¹å‘
    public bool CausesStun;      // æ˜¯å¦ç¡¬ç›´
}
```

**å‘é€æ–¹**ï¼šæ‰€æœ‰ `EffectHandler`  
**æ¥æ”¶æ–¹**ï¼š`HitReactionCapability`

---

## ğŸ’¡ è®¾è®¡ä¼˜åŠ¿ï¼ˆv1.2.1 å®Œå…¨å°è£…ç‰ˆï¼‰

### âœ… **ç»Ÿä¸€çš„èŒè´£åˆ†ç¦»**

**æ‰€æœ‰ Handler éƒ½éµå¾ªåŒæ ·çš„åŸåˆ™**ï¼š
- åªè¯»å¤–éƒ¨ç»„ä»¶ï¼ˆç”¨äºè®¡ç®—ï¼‰
- ä¸ä¿®æ”¹ä»»ä½•ç»„ä»¶
- åªå‘é€äº‹ä»¶

**æ‰€æœ‰ Capability éƒ½éµå¾ªåŒæ ·çš„åŸåˆ™**ï¼š
- æ¥æ”¶äº‹ä»¶
- åªä¿®æ”¹è‡ªèº«å®ä½“çš„ç»„ä»¶
- ç®¡ç†ç”Ÿå‘½å‘¨æœŸ

### âœ… **æ¶æ„ä¼˜åŠ¿**

1. **å°è£…æ€§** ğŸ”’
   - ç»„ä»¶æ•°æ®åªèƒ½ç”±å®ä½“è‡ªèº«çš„ Capability ä¿®æ”¹
   - Handler æ— æ³•ç ´åå®ä½“çŠ¶æ€

2. **ä¸€è‡´æ€§** ğŸ“
   - æ‰€æœ‰æ•ˆæœå¤„ç†æµç¨‹ç»Ÿä¸€
   - æ— ç‰¹æ®Šæƒ…å†µï¼Œæ˜“äºç†è§£

3. **å¯æµ‹è¯•æ€§** ğŸ§ª
   - Handler çº¯è®¡ç®—ï¼Œæ˜“äºå•å…ƒæµ‹è¯•
   - Capability èŒè´£å•ä¸€ï¼Œæ˜“äºé›†æˆæµ‹è¯•

4. **å¯æ‰©å±•æ€§** ğŸ“¦
   - æ–°å¢æ•ˆæœï¼šHandlerï¼ˆè®¡ç®—ï¼‰+ Eventï¼ˆæ•°æ®ï¼‰+ Capabilityï¼ˆæ‰§è¡Œï¼‰
   - ä¸‰ä¸ªéƒ¨åˆ†ç‹¬ç«‹ï¼Œäº’ä¸å½±å“

5. **å®‰å…¨æ€§** ğŸ›¡ï¸
   - é˜²æ­¢è·¨å®ä½“çš„éæ³•ç»„ä»¶ä¿®æ”¹
   - é˜²æ­¢å¹¶å‘ä¿®æ”¹å†²çª

---

## ğŸ“‹ å¾…å®ç°æ¸…å•ï¼ˆv1.2.1 å®Œå…¨å°è£…ç‰ˆï¼‰

### æ–°å¢æ–‡ä»¶ï¼š
1. [ ] åˆ›å»º `Events/DamageEvent.cs`
2. [ ] åˆ›å»º `Events/HealEvent.cs`ï¼ˆå¯é€‰ï¼Œä¸ DamageEvent ç±»ä¼¼ï¼‰
3. [ ] åˆ›å»º `Events/KnockbackEvent.cs`
4. [ ] åˆ›å»º `Capabilities/DamageCapability.cs`
5. [ ] åˆ›å»º `Capabilities/HealCapability.cs`ï¼ˆå¯é€‰ï¼‰

### ä¿®æ”¹æ–‡ä»¶ï¼š
6. [ ] ä¿®æ”¹ `DamageEffectHandler.cs`
   - âŒ å»æ‰ `dynamicStats.TakeDamage()` ç›´æ¥ä¿®æ”¹
   - âœ… æ”¹ä¸ºå‘é€ `DamageEvent` å’Œ `HitReactionEvent`
   
7. [ ] ä¿®æ”¹ `KnockbackEffectHandler.cs`
   - âŒ å»æ‰ç›´æ¥ä¿®æ”¹ `KnockbackComponent` çš„ä»£ç 
   - âœ… æ”¹ä¸ºå‘é€ `KnockbackEvent` å’Œ `HitReactionEvent`
   
8. [ ] ä¿®æ”¹ `KnockbackCapability.cs`
   - âœ… æ–°å¢ `RegisterEventHandlers()`
   - âœ… æ–°å¢ `OnKnockback(Entity, KnockbackEvent)` äº‹ä»¶å¤„ç†
   
9. [ ] ç¡®è®¤ `HitReactionCapability.cs` åªå¤„ç†è¡¨ç°
   - âœ… åªæ¥æ”¶ `HitReactionEvent`
   - âœ… åªæ’­æ”¾åŠ¨ä½œå’Œç‰¹æ•ˆ
   
10. [ ] ä¿®æ”¹ `CombatArchetype.cs`
    - âœ… æ·»åŠ  `DamageCapability`
    - âœ… æ·»åŠ  `HealCapability`ï¼ˆå¯é€‰ï¼‰

### æµ‹è¯•éªŒè¯ï¼š
11. [ ] å•å…ƒæµ‹è¯•ï¼šDamageEvent è®¡ç®—å’Œå‘é€
12. [ ] å•å…ƒæµ‹è¯•ï¼šKnockbackEvent è®¡ç®—å’Œå‘é€
13. [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´ä¼¤å®³é“¾è·¯
14. [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´å‡»é€€é“¾è·¯
15. [ ] æ€§èƒ½æµ‹è¯•ï¼šäº‹ä»¶é˜Ÿåˆ—å¼€é”€

---

## ğŸ¨ è®¾è®¡ç¤ºä¾‹

### DamageEffectHandler ç¤ºä¾‹

```csharp
public class DamageEffectHandler : IEffectHandler
{
    public void Handle(Entity caster, Entity target, SkillEffectTable effectConfig)
    {
        // 1. è¯»å–ç»„ä»¶ï¼ˆåªè¯»ï¼‰
        var casterStats = caster.GetComponent<DerivedStatsComponent>();
        var targetStats = target.GetComponent<DynamicStatsComponent>();
        
        // 2. è®¡ç®—ä¼¤å®³ï¼ˆçº¯è®¡ç®—ï¼Œä¸ä¿®æ”¹çŠ¶æ€ï¼‰
        var damageResult = DamageCalculator.Calculate(caster, target, effectConfig, frame);
        
        // 3. å‘é€ä¼¤å®³äº‹ä»¶ç»™ç›®æ ‡
        var damageEvent = new DamageEvent
        {
            CasterId = caster.UniqueId,
            EffectId = effectConfig.SkillEffectId,
            Damage = damageResult.FinalDamage,
            IsCritical = damageResult.IsCritical,
            DamageType = effectConfig.DamageType
        };
        
        target.QueueEvent(damageEvent);  // â† å‘é€ç»™ DamageCapability
        
        // 4. å‘é€å—å‡»åé¦ˆäº‹ä»¶ï¼ˆç”¨äºè¡¨ç°ï¼‰
        var hitReactionEvent = new HitReactionEvent { ... };
        target.QueueEvent(hitReactionEvent);  // â† å‘é€ç»™ HitReactionCapability
    }
}
```

### DamageCapability ç¤ºä¾‹

```csharp
public class DamageCapability : Capability<DamageCapability>
{
    protected override void RegisterEventHandlers()
    {
        RegisterEventHandler<DamageEvent>(OnDamage);
    }
    
    private void OnDamage(Entity entity, DamageEvent evt)
    {
        // 1. è·å–ç»„ä»¶ï¼ˆè‡ªèº«å®ä½“ï¼‰
        var dynamicStats = GetComponent<DynamicStatsComponent>(entity);
        var stateComp = GetComponent<StateComponent>(entity);
        
        // 2. åº”ç”¨ä¼¤å®³ï¼ˆä¿®æ”¹è‡ªèº«ç»„ä»¶ï¼‰
        FP beforeHP = dynamicStats.Get(DynamicResourceType.CURRENT_HP);
        FP actualDamage = dynamicStats.TakeDamage(evt.Damage, derivedStats);
        FP afterHP = dynamicStats.Get(DynamicResourceType.CURRENT_HP);
        
        // 3. æ£€æŸ¥æ­»äº¡
        if (afterHP <= FP.Zero && !stateComp.Get(StateType.DEAD))
        {
            stateComp.Set(StateType.DEAD, true);
            // å‘å¸ƒæ­»äº¡äº‹ä»¶...
        }
    }
}
```

### KnockbackCapability ç¤ºä¾‹

```csharp
public class KnockbackCapability : Capability<KnockbackCapability>
{
    protected override void RegisterEventHandlers()
    {
        RegisterEventHandler<KnockbackEvent>(OnKnockback);
    }
    
    private void OnKnockback(Entity entity, KnockbackEvent evt)
    {
        // è·å–ç»„ä»¶ï¼ˆè‡ªèº«å®ä½“ï¼‰
        var knockback = GetOrAddComponent<KnockbackComponent>(entity);
        
        // å†™å…¥å‡»é€€æ•°æ®ï¼ˆä¿®æ”¹è‡ªèº«ç»„ä»¶ï¼‰
        knockback.IsKnockingBack = true;
        knockback.Direction = evt.Direction;
        knockback.TotalDistance = evt.Distance;
        knockback.RemainingTime = evt.Duration;
        knockback.Speed = evt.Distance / evt.Duration;
        knockback.MovedDistance = FP.Zero;
        knockback.Type = evt.Type;
        knockback.CasterId = evt.CasterId;
    }
    
    public override void Tick(Entity entity)
    {
        // æ¯å¸§åº”ç”¨å‡»é€€ä½ç§»
        var knockback = GetComponent<KnockbackComponent>(entity);
        var position = GetComponent<PositionComponent>(entity);
        
        FP moveDistance = CalculateMoveDistance(knockback, entity.World.DeltaTime);
        position.Position += knockback.Direction * moveDistance;
        knockback.MovedDistance += moveDistance;
        knockback.RemainingTime -= entity.World.DeltaTime;
        
        // æ£€æŸ¥ç»“æŸ
        if (knockback.RemainingTime <= FP.Zero || 
            knockback.MovedDistance >= knockback.TotalDistance)
        {
            knockback.IsKnockingBack = false;
        }
    }
}
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [Hit-Reaction-And-Knockback å—å‡»ä¸å‡»é€€.md](../æŠ€èƒ½æ•ˆæœ/Hit-Reaction-And-Knockback%20å—å‡»ä¸å‡»é€€.md) - è¯¦ç»†æŠ€æœ¯æ–¹æ¡ˆï¼ˆå·²æ›´æ–° v1.2ï¼‰
- [Hit-Reaction-Progress å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•.md](./Hit-Reaction-Progress%20å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•.md) - å¼€å‘è¿›åº¦ï¼ˆå·²æ›´æ–° v1.2ï¼‰

