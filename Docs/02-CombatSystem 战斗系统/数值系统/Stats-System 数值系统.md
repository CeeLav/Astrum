# æ•°å€¼ç³»ç»Ÿç­–åˆ’æ¡ˆ

> ğŸ“Š å®Œæ•´çš„æ•°å€¼ä½“ç³»è®¾è®¡ï¼šå±æ€§ã€æˆ˜æ–—ã€æˆé•¿ã€Buff
>
> **çŠ¶æ€**: ğŸ“ è®¾è®¡é˜¶æ®µ  
> **ç‰ˆæœ¬**: v1.0  
> **æ›´æ–°**: 2025-10-14

---

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 è®¾è®¡ç†å¿µ

æ•°å€¼ç³»ç»Ÿæ˜¯æ¸¸æˆæˆ˜æ–—çš„æ ¸å¿ƒåŸºç¡€ï¼Œè´Ÿè´£ç®¡ç†æ‰€æœ‰å®ä½“çš„å±æ€§ã€çŠ¶æ€å’Œæ•°å€¼è®¡ç®—ã€‚æœ¬ç³»ç»Ÿé‡‡ç”¨**ä¸‰å±‚å±æ€§æ¶æ„**ï¼Œæ¸…æ™°åˆ†ç¦»åŸºç¡€æ•°å€¼ã€è®¡ç®—æ•°å€¼å’ŒåŠ¨æ€æ•°å€¼ï¼Œæ”¯æŒå¤æ‚çš„Buffã€æˆé•¿ã€è£…å¤‡ç­‰ç³»ç»Ÿæ‰©å±•ã€‚

**æ ¸å¿ƒåŸåˆ™**ï¼š
- **æ•°æ®é©±åŠ¨**ï¼šæ‰€æœ‰åŸºç¡€æ•°å€¼æ¥è‡ªé…ç½®è¡¨
- **åˆ†å±‚æ¸…æ™°**ï¼šåŸºç¡€â†’æ´¾ç”Ÿâ†’åŠ¨æ€ï¼Œå„å¸å…¶èŒ
- **æ˜“äºæ‰©å±•**ï¼šæ”¯æŒBuffã€è£…å¤‡ã€æŠ€èƒ½åŠ æˆç­‰ä¿®é¥°å™¨
- **æ€§èƒ½ä¼˜å…ˆ**ï¼šè¿è¡Œæ—¶æ•°æ®ç´§å‡‘ï¼Œè®¡ç®—é«˜æ•ˆ
- **ç¡®å®šæ€§**ï¼šæ”¯æŒå¸§åŒæ­¥ï¼Œé¿å…æµ®ç‚¹è¯¯å·®

### 1.2 ä¸‰å±‚å±æ€§æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°å€¼ç³»ç»Ÿæ¶æ„                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“               â†“               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BaseStats  â”‚  â”‚ DerivedStatsâ”‚  â”‚DynamicStats â”‚
â”‚  åŸºç¡€å±æ€§    â”‚â†’ â”‚  æ´¾ç”Ÿå±æ€§   â”‚â†’ â”‚ åŠ¨æ€å±æ€§    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘                  â†‘                  â†‘
     â”‚                  â”‚                  â”‚
  é…ç½®è¡¨            ä¿®é¥°å™¨è®¡ç®—          æˆ˜æ–—å®æ—¶
  
  Level/Growth      Buff/Equipment      HP/MP/èƒ½é‡
```

---

## äºŒã€è¿è¡Œæ—¶ç»„ä»¶è®¾è®¡

### 2.1 æ ¸å¿ƒæ•°æ®ç»“æ„

#### StatType æšä¸¾ï¼ˆå±æ€§ç±»å‹å®šä¹‰ï¼‰

```csharp
/// <summary>
/// å±æ€§ç±»å‹æšä¸¾ - å®šä¹‰æ¸¸æˆä¸­æ‰€æœ‰æ•°å€¼å±æ€§
/// </summary>
public enum StatType
{
    // ===== åŸºç¡€æˆ˜æ–—å±æ€§ =====
    HP = 1,              // ç”Ÿå‘½å€¼ä¸Šé™
    ATK = 2,             // æ”»å‡»åŠ›
    DEF = 3,             // é˜²å¾¡åŠ›
    SPD = 4,             // ç§»åŠ¨é€Ÿåº¦
    
    // ===== é«˜çº§æˆ˜æ–—å±æ€§ =====
    CRIT_RATE = 10,      // æš´å‡»ç‡
    CRIT_DMG = 11,       // æš´å‡»ä¼¤å®³å€ç‡
    ACCURACY = 12,       // å‘½ä¸­ç‡
    EVASION = 13,        // é—ªé¿ç‡
    BLOCK_RATE = 14,     // æ ¼æŒ¡ç‡
    BLOCK_VALUE = 15,    // æ ¼æŒ¡å€¼
    
    // ===== æŠ—æ€§å±æ€§ =====
    PHYSICAL_RES = 20,   // ç‰©ç†æŠ—æ€§
    MAGICAL_RES = 21,    // é­”æ³•æŠ—æ€§
    
    // ===== å…ƒç´ å±æ€§ï¼ˆå¯æ‰©å±•ï¼‰=====
    ELEMENT_FIRE = 30,   // ç«å…ƒç´ å¼ºåº¦
    ELEMENT_ICE = 31,    // å†°å…ƒç´ å¼ºåº¦
    ELEMENT_LIGHTNING = 32, // é›·å…ƒç´ å¼ºåº¦
    ELEMENT_DARK = 33,   // æš—å…ƒç´ å¼ºåº¦
    
    // ===== èµ„æºå±æ€§ =====
    MAX_MANA = 40,       // æ³•åŠ›å€¼ä¸Šé™
    MANA_REGEN = 41,     // æ³•åŠ›æ¢å¤é€Ÿåº¦
    HEALTH_REGEN = 42,   // ç”Ÿå‘½æ¢å¤é€Ÿåº¦
    
    // ===== å…¶ä»–å¯æ‰©å±•å±æ€§ =====
    ATTACK_SPEED = 50,   // æ”»å‡»é€Ÿåº¦
    CAST_SPEED = 51,     // æ–½æ³•é€Ÿåº¦
    COOLDOWN_REDUCTION = 52, // å†·å´ç¼©å‡
    LIFESTEAL = 53,      // ç”Ÿå‘½å·å–
    EXP_GAIN = 54,       // ç»éªŒè·å–åŠ æˆ
}
```

#### Stats é€šç”¨å±æ€§å®¹å™¨

```csharp
using TrueSync;

/// <summary>
/// é€šç”¨å±æ€§å®¹å™¨ - ä½¿ç”¨å­—å…¸å­˜å‚¨ä»»æ„å±æ€§ï¼ˆå®šç‚¹æ•°ï¼‰
/// </summary>
[MemoryPackable]
public partial class Stats
{
    /// <summary>å±æ€§å€¼å­—å…¸ï¼ˆä½¿ç”¨å®šç‚¹æ•°ç¡®ä¿ç¡®å®šæ€§ï¼‰</summary>
    private Dictionary<StatType, FP> _values = new Dictionary<StatType, FP>();
    
    /// <summary>è·å–å±æ€§å€¼</summary>
    public FP Get(StatType type)
    {
        return _values.TryGetValue(type, out var value) ? value : FP.Zero;
    }
    
    /// <summary>è®¾ç½®å±æ€§å€¼</summary>
    public void Set(StatType type, FP value)
    {
        _values[type] = value;
    }
    
    /// <summary>å¢åŠ å±æ€§å€¼</summary>
    public void Add(StatType type, FP delta)
    {
        if (_values.TryGetValue(type, out var current))
            _values[type] = current + delta;
        else
            _values[type] = delta;
    }
    
    /// <summary>æ¸…ç©ºæ‰€æœ‰å±æ€§</summary>
    public void Clear()
    {
        _values.Clear();
    }
    
    /// <summary>å¤åˆ¶å±æ€§</summary>
    public Stats Clone()
    {
        var clone = new Stats();
        foreach (var kvp in _values)
        {
            clone._values[kvp.Key] = kvp.Value;
        }
        return clone;
    }
    
    /// <summary>è·å–æ‰€æœ‰å±æ€§ï¼ˆè°ƒè¯•ç”¨ï¼‰</summary>
    public Dictionary<StatType, FP> GetAll()
    {
        return new Dictionary<StatType, FP>(_values);
    }
    
}
```

**è®¾è®¡è¯´æ˜**ï¼š
- âœ… ä½¿ç”¨ `TrueSync.FP`ï¼ˆå®šç‚¹æ•°ï¼‰ä¿è¯ç¡®å®šæ€§
- âœ… é…ç½®è¡¨ä½¿ç”¨intå­˜å‚¨ï¼Œå°æ•°å±æ€§æ‰©å¤§1000å€
- âœ… è¯»å–æ—¶ä¸€æ¬¡æ€§è½¬æ¢ä¸ºFP
- âœ… è¿è¡Œæ—¶å…¨éƒ¨ä½¿ç”¨FPè®¡ç®—
- âœ… UIæ˜¾ç¤ºæ—¶è½¬æ¢ï¼š`(float)stats.Get(type)`
- âœ… æ”¯æŒå¸§åŒæ­¥å’ŒçŠ¶æ€å›æ»š

---

### 2.2 BaseStatsComponentï¼ˆåŸºç¡€å±æ€§ç»„ä»¶ï¼‰

**èŒè´£**ï¼šå­˜å‚¨å®ä½“çš„åŸºç¡€åŸå§‹å±æ€§ï¼Œæ¥æºäºé…ç½®è¡¨

**æ•°æ®æ¥æº**ï¼š
- é…ç½®è¡¨çš„åŸºç¡€å€¼ï¼ˆRoleBaseTableï¼‰
- ç­‰çº§æˆé•¿åŠ æˆï¼ˆRoleGrowthTableï¼‰
- **ä¸åŒ…å«**ï¼šBuffã€è£…å¤‡ç­‰ä¸´æ—¶åŠ æˆ

**ç»„ä»¶è®¾è®¡**ï¼š

```csharp
[MemoryPackable]
public partial class BaseStatsComponent : BaseComponent
{
    /// <summary>åŸºç¡€å±æ€§å®¹å™¨</summary>
    public Stats BaseStats { get; set; } = new Stats();
    
    /// <summary>ä»é…ç½®è¡¨åˆå§‹åŒ–</summary>
    public void InitializeFromConfig(int roleId, int level)
    {
        // 1. æ¸…ç©ºç°æœ‰å±æ€§
        BaseStats.Clear();
        
        // 2. ä»é…ç½®è¡¨è¯»å–åŸºç¡€å€¼
        var roleConfig = ConfigManager.Instance.Tables.TbRoleBaseTable.Get(roleId);
        if (roleConfig == null)
        {
            ASLogger.Instance.Error($"[BaseStats] RoleBaseTable not found for roleId={roleId}");
            return;
        }
        
        // 3. è®¾ç½®åŸºç¡€å››ç»´ï¼ˆé…ç½®è¡¨å­˜intï¼Œç›´æ¥è½¬FPï¼‰
        BaseStats.Set(StatType.ATK, (FP)roleConfig.BaseAttack);
        BaseStats.Set(StatType.DEF, (FP)roleConfig.BaseDefense);
        BaseStats.Set(StatType.HP, (FP)roleConfig.BaseHealth);
        
        // é€Ÿåº¦æ˜¯å°æ•°ï¼Œé…ç½®è¡¨å­˜1000å€ï¼ˆå¦‚10.5å­˜ä¸º10500ï¼‰
        BaseStats.Set(StatType.SPD, (FP)roleConfig.BaseSpeed / (FP)1000);
        
        // 4. è®¾ç½®é«˜çº§å±æ€§ï¼ˆç™¾åˆ†æ¯”å±æ€§ï¼Œé…ç½®è¡¨å­˜1000å€ï¼‰
        // å¦‚æš´å‡»ç‡5%ï¼Œé…ç½®è¡¨å­˜50ï¼Œè¿è¡Œæ—¶é™¤ä»¥1000å¾—åˆ°0.05
        BaseStats.Set(StatType.CRIT_RATE, (FP)roleConfig.BaseCritRate / (FP)1000);
        BaseStats.Set(StatType.CRIT_DMG, (FP)roleConfig.BaseCritDamage / (FP)1000);
        BaseStats.Set(StatType.ACCURACY, (FP)roleConfig.BaseAccuracy / (FP)1000);
        BaseStats.Set(StatType.EVASION, (FP)roleConfig.BaseEvasion / (FP)1000);
        BaseStats.Set(StatType.BLOCK_RATE, (FP)roleConfig.BaseBlockRate / (FP)1000);
        BaseStats.Set(StatType.BLOCK_VALUE, (FP)roleConfig.BaseBlockValue);
        
        // 5. è®¾ç½®æŠ—æ€§ï¼ˆç™¾åˆ†æ¯”ï¼Œé…ç½®è¡¨å­˜1000å€ï¼‰
        BaseStats.Set(StatType.PHYSICAL_RES, (FP)roleConfig.PhysicalRes / (FP)1000);
        BaseStats.Set(StatType.MAGICAL_RES, (FP)roleConfig.MagicalRes / (FP)1000);
        
        // 6. è®¾ç½®èµ„æºå±æ€§
        BaseStats.Set(StatType.MAX_MANA, (FP)roleConfig.BaseMaxMana);
        BaseStats.Set(StatType.MANA_REGEN, (FP)roleConfig.ManaRegen / (FP)1000);
        BaseStats.Set(StatType.HEALTH_REGEN, (FP)roleConfig.HealthRegen / (FP)1000);
        
        // 7. åº”ç”¨ç­‰çº§æˆé•¿
        if (level > 1)
        {
            ApplyLevelGrowth(roleId, level);
        }
    }
    
    /// <summary>åº”ç”¨ç­‰çº§æˆé•¿</summary>
    private void ApplyLevelGrowth(int roleId, int level)
    {
        var growthConfig = ConfigManager.Instance.Tables.TbRoleGrowthTable.GetByLevel(roleId, level);
        if (growthConfig == null) return;
        
        FP levelDelta = (FP)(level - 1);
        
        // é…ç½®è¡¨å­˜intï¼Œéœ€è¦è½¬æ¢
        BaseStats.Add(StatType.ATK, (FP)growthConfig.AttackBonus * levelDelta);
        BaseStats.Add(StatType.DEF, (FP)growthConfig.DefenseBonus * levelDelta);
        BaseStats.Add(StatType.HP, (FP)growthConfig.HealthBonus * levelDelta);
        
        // å°æ•°å±æ€§ï¼ˆé…ç½®è¡¨å­˜1000å€ï¼‰
        BaseStats.Add(StatType.SPD, (FP)growthConfig.SpeedBonus / (FP)1000 * levelDelta);
        BaseStats.Add(StatType.CRIT_RATE, (FP)growthConfig.CritRateBonus / (FP)1000 * levelDelta);
        BaseStats.Add(StatType.CRIT_DMG, (FP)growthConfig.CritDamageBonus / (FP)1000 * levelDelta);
    }
    
    /// <summary>åº”ç”¨è‡ªç”±åŠ ç‚¹</summary>
    public void ApplyAllocatedPoints(GrowthComponent growthComp)
    {
        // æ¯ç‚¹åŠ æˆï¼ˆä½¿ç”¨å®šç‚¹æ•°ï¼‰
        FP ATTACK_PER_POINT = (FP)2;
        FP DEFENSE_PER_POINT = (FP)2;
        FP HEALTH_PER_POINT = (FP)20;
        FP SPEED_PER_POINT = (FP)0.1;
        
        BaseStats.Add(StatType.ATK, (FP)growthComp.AllocatedAttackPoints * ATTACK_PER_POINT);
        BaseStats.Add(StatType.DEF, (FP)growthComp.AllocatedDefensePoints * DEFENSE_PER_POINT);
        BaseStats.Add(StatType.HP, (FP)growthComp.AllocatedHealthPoints * HEALTH_PER_POINT);
        BaseStats.Add(StatType.SPD, (FP)growthComp.AllocatedSpeedPoints * SPEED_PER_POINT);
    }
}
```

---

### 2.3 DerivedStatsComponentï¼ˆæ´¾ç”Ÿå±æ€§ç»„ä»¶ï¼‰

**èŒè´£**ï¼šå­˜å‚¨ç»è¿‡ä¿®é¥°å™¨è®¡ç®—åçš„æœ€ç»ˆå±æ€§å€¼

**æ•°æ®æ¥æº**ï¼š
- BaseStatsï¼ˆåŸºç¡€ï¼‰
- BuffåŠ æˆï¼ˆä¸´æ—¶ï¼‰
- è£…å¤‡åŠ æˆï¼ˆè£…å¤‡ï¼‰
- æŠ€èƒ½è¢«åŠ¨ï¼ˆæ°¸ä¹…ï¼‰

**ç»„ä»¶è®¾è®¡**ï¼š

```csharp
[MemoryPackable]
public partial class DerivedStatsComponent : BaseComponent
{
    /// <summary>æœ€ç»ˆå±æ€§å®¹å™¨</summary>
    public Stats FinalStats { get; set; } = new Stats();
    
    /// <summary>ä¿®é¥°å™¨å­—å…¸ï¼ˆå±æ€§ç±»å‹ â†’ ä¿®é¥°å™¨åˆ—è¡¨ï¼‰</summary>
    [MemoryPackIgnore]
    private Dictionary<StatType, List<StatModifier>> _modifiers = new Dictionary<StatType, List<StatModifier>>();
    
    /// <summary>æ·»åŠ ä¿®é¥°å™¨</summary>
    public void AddModifier(StatType statType, StatModifier modifier)
    {
        if (!_modifiers.ContainsKey(statType))
        {
            _modifiers[statType] = new List<StatModifier>();
        }
        
        _modifiers[statType].Add(modifier);
        _modifiers[statType].Sort((a, b) => a.Priority.CompareTo(b.Priority));
    }
    
    /// <summary>ç§»é™¤ä¿®é¥°å™¨ï¼ˆæŒ‰æ¥æºIDï¼‰</summary>
    public void RemoveModifier(int sourceId)
    {
        foreach (var modList in _modifiers.Values)
        {
            modList.RemoveAll(m => m.SourceId == sourceId);
        }
    }
    
    /// <summary>æ¸…ç©ºæ‰€æœ‰ä¿®é¥°å™¨</summary>
    public void ClearModifiers()
    {
        _modifiers.Clear();
    }
    
    /// <summary>é‡æ–°è®¡ç®—æ‰€æœ‰æ´¾ç”Ÿå±æ€§</summary>
    public void RecalculateAll(BaseStatsComponent baseStats)
    {
        FinalStats.Clear();
        
        // éå†æ‰€æœ‰å¯èƒ½çš„å±æ€§ç±»å‹
        foreach (StatType statType in System.Enum.GetValues(typeof(StatType)))
        {
            float baseValue = baseStats.BaseStats.Get(statType);
            float finalValue = CalculateFinalStat(baseValue, statType);
            FinalStats.Set(statType, finalValue);
        }
    }
    
    /// <summary>è®¡ç®—å•ä¸ªå±æ€§çš„æœ€ç»ˆå€¼</summary>
    private FP CalculateFinalStat(FP baseValue, StatType statType)
    {
        if (!_modifiers.TryGetValue(statType, out var modifiers) || modifiers.Count == 0)
        {
            return baseValue;
        }
        
        FP flatBonus = FP.Zero;        // å›ºå®šåŠ æˆ
        FP percentBonus = FP.Zero;     // ç™¾åˆ†æ¯”åŠ æˆ
        FP finalMultiplier = FP.One;   // æœ€ç»ˆä¹˜æ•°
        
        // æŒ‰ä¼˜å…ˆçº§åº”ç”¨ä¿®é¥°å™¨
        foreach (var mod in modifiers)
        {
            switch (mod.Type)
            {
                case ModifierType.Flat:
                    flatBonus += mod.Value;
                    break;
                case ModifierType.Percent:
                    percentBonus += mod.Value;
                    break;
                case ModifierType.FinalMultiplier:
                    finalMultiplier *= (FP.One + mod.Value);
                    break;
            }
        }
        
        // è®¡ç®—é¡ºåºï¼š(åŸºç¡€ + å›ºå®š) Ã— (1 + ç™¾åˆ†æ¯”) Ã— æœ€ç»ˆä¹˜æ•°
        return (baseValue + flatBonus) * (FP.One + percentBonus) * finalMultiplier;
    }
    
    /// <summary>è·å–æŒ‡å®šå±æ€§çš„æœ€ç»ˆå€¼ï¼ˆå¿«æ·æ–¹æ³•ï¼‰</summary>
    public FP Get(StatType type) => FinalStats.Get(type);
    
    /// <summary>è·å–æŒ‡å®šå±æ€§çš„æœ€ç»ˆå€¼ï¼ˆè½¬ä¸ºfloatï¼‰</summary>
    public float GetFloat(StatType type) => (float)FinalStats.Get(type);
}

/// <summary>å±æ€§ä¿®é¥°å™¨</summary>
[MemoryPackable]
public partial class StatModifier
{
    /// <summary>æ¥æºIDï¼ˆBuff IDã€è£…å¤‡IDç­‰ï¼‰</summary>
    public int SourceId { get; set; }
    
    /// <summary>ä¿®é¥°å™¨ç±»å‹</summary>
    public ModifierType Type { get; set; }
    
    /// <summary>æ•°å€¼ï¼ˆå®šç‚¹æ•°ï¼‰</summary>
    public FP Value { get; set; }
    
    /// <summary>ä¼˜å…ˆçº§ï¼ˆç”¨äºæ’åºï¼‰</summary>
    public int Priority { get; set; }
}

/// <summary>ä¿®é¥°å™¨ç±»å‹</summary>
public enum ModifierType
{
    Flat = 1,           // å›ºå®šå€¼åŠ æˆï¼ˆ+50æ”»å‡»ï¼‰
    Percent = 2,        // ç™¾åˆ†æ¯”åŠ æˆï¼ˆ+20%æ”»å‡»ï¼‰
    FinalMultiplier = 3 // æœ€ç»ˆä¹˜æ•°ï¼ˆÃ—1.5ä¼¤å®³ï¼‰
}
```

---

### 2.4 DynamicStatsComponentï¼ˆåŠ¨æ€å±æ€§ç»„ä»¶ï¼‰

**èŒè´£**ï¼šå­˜å‚¨æˆ˜æ–—ä¸­å®æ—¶å˜åŒ–çš„æ•°å€¼ï¼ˆå½“å‰å€¼ã€ä¸´æ—¶èµ„æºç­‰ï¼‰

**ç‰¹ç‚¹**ï¼š
- æ¯å¸§å¯èƒ½å˜åŒ–
- å—ä¼¤å®³ã€æ²»ç–—ã€æ¶ˆè€—å½±å“
- æœ‰ä¸Šé™çº¦æŸï¼ˆæ¥è‡ªDerivedStatsï¼‰

**åŠ¨æ€èµ„æºç±»å‹æšä¸¾**ï¼š

```csharp
/// <summary>
/// åŠ¨æ€èµ„æºç±»å‹
/// </summary>
public enum DynamicResourceType
{
    // ===== æ ¸å¿ƒèµ„æº =====
    CURRENT_HP = 1,      // å½“å‰ç”Ÿå‘½å€¼
    CURRENT_MANA = 2,    // å½“å‰æ³•åŠ›å€¼
    
    // ===== æˆ˜æ–—èµ„æº =====
    ENERGY = 10,         // èƒ½é‡ï¼ˆ0-100ï¼‰
    RAGE = 11,           // æ€’æ°”ï¼ˆ0-100ï¼‰
    COMBO = 12,          // è¿å‡»æ•°
    
    // ===== ä¸´æ—¶é˜²æŠ¤ =====
    SHIELD = 20,         // æŠ¤ç›¾å€¼
    INVINCIBLE_FRAMES = 21, // æ— æ•Œå¸§æ•°
    
    // ===== æ§åˆ¶çŠ¶æ€è®¡æ—¶ =====
    STUN_FRAMES = 30,    // ç¡¬ç›´å‰©ä½™å¸§æ•°
    FREEZE_FRAMES = 31,  // å†°å†»å‰©ä½™å¸§æ•°
    KNOCKBACK_FRAMES = 32, // å‡»é£å‰©ä½™å¸§æ•°
}
```

**ç»„ä»¶è®¾è®¡**ï¼š

```csharp
using TrueSync;

[MemoryPackable]
public partial class DynamicStatsComponent : BaseComponent
{
    /// <summary>åŠ¨æ€èµ„æºå®¹å™¨ï¼ˆä½¿ç”¨å®šç‚¹æ•°ï¼‰</summary>
    private Dictionary<DynamicResourceType, FP> _resources = new Dictionary<DynamicResourceType, FP>();
    
    /// <summary>è·å–èµ„æºå€¼</summary>
    public FP Get(DynamicResourceType type)
    {
        return _resources.TryGetValue(type, out var value) ? value : FP.Zero;
    }
    
    /// <summary>è®¾ç½®èµ„æºå€¼</summary>
    public void Set(DynamicResourceType type, FP value)
    {
        _resources[type] = value;
    }
    
    /// <summary>å¢åŠ èµ„æºå€¼</summary>
    public void Add(DynamicResourceType type, FP delta)
    {
        if (_resources.TryGetValue(type, out var current))
            _resources[type] = current + delta;
        else
            _resources[type] = delta;
    }
    
    // ===== ä¾¿æ·è®¿é—®å™¨ =====
    
    public FP CurrentHealth
    {
        get => Get(DynamicResourceType.CURRENT_HP);
        set => Set(DynamicResourceType.CURRENT_HP, value);
    }
    
    public FP CurrentMana
    {
        get => Get(DynamicResourceType.CURRENT_MANA);
        set => Set(DynamicResourceType.CURRENT_MANA, value);
    }
    
    public FP Energy
    {
        get => Get(DynamicResourceType.ENERGY);
        set => Set(DynamicResourceType.ENERGY, FPMath.Clamp(value, FP.Zero, (FP)100));
    }
    
    public FP Rage
    {
        get => Get(DynamicResourceType.RAGE);
        set => Set(DynamicResourceType.RAGE, FPMath.Clamp(value, FP.Zero, (FP)100));
    }
    
    public FP Shield
    {
        get => Get(DynamicResourceType.SHIELD);
        set => Set(DynamicResourceType.SHIELD, FPMath.Max(FP.Zero, value));
    }
    
    public int ComboCount
    {
        get => (int)Get(DynamicResourceType.COMBO);
        set => Set(DynamicResourceType.COMBO, (FP)value);
    }
    
    // ===== è¾…åŠ©æ–¹æ³• =====
    
    /// <summary>æ‰£é™¤ç”Ÿå‘½å€¼ï¼ˆè€ƒè™‘æŠ¤ç›¾ï¼‰</summary>
    public FP TakeDamage(FP damage, DerivedStatsComponent derivedStats)
    {
        FP remainingDamage = damage;
        
        // 1. å…ˆæ‰£é™¤æŠ¤ç›¾
        FP currentShield = Shield;
        if (currentShield > FP.Zero)
        {
            FP shieldDamage = FPMath.Min(currentShield, remainingDamage);
            Shield = currentShield - shieldDamage;
            remainingDamage -= shieldDamage;
        }
        
        // 2. æ‰£é™¤ç”Ÿå‘½å€¼
        if (remainingDamage > FP.Zero)
        {
            FP currentHP = CurrentHealth;
            FP actualDamage = FPMath.Min(currentHP, remainingDamage);
            CurrentHealth = currentHP - actualDamage;
            return actualDamage; // è¿”å›å®é™…å—åˆ°çš„ç”Ÿå‘½ä¼¤å®³
        }
        
        return FP.Zero;
    }
    
    /// <summary>æ¢å¤ç”Ÿå‘½å€¼ï¼ˆä¸è¶…è¿‡ä¸Šé™ï¼‰</summary>
    public FP Heal(FP amount, DerivedStatsComponent derivedStats)
    {
        FP maxHP = derivedStats.Get(StatType.HP);
        FP currentHP = CurrentHealth;
        FP maxHeal = maxHP - currentHP;
        FP actualHeal = FPMath.Min(amount, maxHeal);
        CurrentHealth = currentHP + actualHeal;
        return actualHeal;
    }
    
    /// <summary>æ¶ˆè€—æ³•åŠ›</summary>
    public bool ConsumeMana(FP amount)
    {
        FP currentMP = CurrentMana;
        if (currentMP < amount)
            return false;
        
        CurrentMana = currentMP - amount;
        return true;
    }
    
    /// <summary>å¢åŠ èƒ½é‡</summary>
    public void AddEnergy(FP amount)
    {
        Energy = FPMath.Min((FP)100, Energy + amount);
    }
    
    /// <summary>å¢åŠ æ€’æ°”</summary>
    public void AddRage(FP amount)
    {
        Rage = FPMath.Min((FP)100, Rage + amount);
    }
    
    /// <summary>åˆå§‹åŒ–åŠ¨æ€èµ„æºï¼ˆæ»¡è¡€æ»¡è“ï¼‰</summary>
    public void InitializeResources(DerivedStatsComponent derivedStats)
    {
        CurrentHealth = derivedStats.Get(StatType.HP);
        CurrentMana = derivedStats.Get(StatType.MAX_MANA);
        Energy = FP.Zero;
        Rage = FP.Zero;
        Shield = FP.Zero;
        ComboCount = 0;
    }
}
```

**ç¡®å®šæ€§è¯´æ˜**ï¼š
- âœ… æ‰€æœ‰æ•°å€¼ä½¿ç”¨ `FP`ï¼ˆå®šç‚¹æ•°ï¼‰å­˜å‚¨
- âœ… æ•°å­¦è¿ç®—ä½¿ç”¨ `FPMath` å·¥å…·ç±»
- âœ… ä¿è¯å¸§åŒæ­¥æ—¶æ¯ä¸ªå®¢æˆ·ç«¯è®¡ç®—ç»“æœå®Œå…¨ä¸€è‡´
- âœ… é¿å…floatçš„ç²¾åº¦è¯¯å·®å’Œä¸ç¡®å®šæ€§
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- âœ… çµæ´»æ‰©å±•ï¼šæ·»åŠ æ–°èµ„æºç±»å‹åªéœ€æ‰©å±•æšä¸¾
- âœ… ç´§å‡‘å­˜å‚¨ï¼šåªå­˜å‚¨éé›¶å€¼
- âœ… ç±»å‹å®‰å…¨ï¼šé€šè¿‡æšä¸¾è®¿é—®
- âœ… è°ƒè¯•å‹å¥½ï¼šå¯éå†æ‰€æœ‰èµ„æº

---

### 2.5 BuffComponentï¼ˆBuffç»„ä»¶ï¼‰

**èŒè´£**ï¼šç®¡ç†å®ä½“èº«ä¸Šçš„æ‰€æœ‰Buff/Debuffå®ä¾‹

**åŠŸèƒ½**ï¼š
- Buffæ·»åŠ ã€ç§»é™¤ã€å åŠ 
- BuffæŒç»­æ—¶é—´ç®¡ç†
- Buffæ•ˆæœè®¡ç®—å’Œåº”ç”¨

**æ•°æ®ç»“æ„**ï¼š

```csharp
[MemoryPackable]
public partial class BuffComponent : BaseComponent
{
    /// <summary>å½“å‰æ‰€æœ‰Buffå®ä¾‹</summary>
    public List<BuffInstance> Buffs { get; set; } = new List<BuffInstance>();
    
    /// <summary>æ·»åŠ Buff</summary>
    public void AddBuff(BuffInstance buff)
    {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒç±»å‹Buff
        var existing = Buffs.Find(b => b.BuffId == buff.BuffId);
        
        if (existing != null)
        {
            // 2. å¤„ç†å åŠ é€»è¾‘
            if (buff.Stackable)
            {
                existing.StackCount = Math.Min(existing.StackCount + 1, buff.MaxStack);
                existing.RemainingFrames = buff.Duration; // åˆ·æ–°æŒç»­æ—¶é—´
            }
            else
            {
                // ä¸å¯å åŠ ï¼Œåˆ·æ–°æŒç»­æ—¶é—´
                existing.RemainingFrames = buff.Duration;
            }
        }
        else
        {
            // 3. æ·»åŠ æ–°Buff
            Buffs.Add(buff);
        }
    }
    
    /// <summary>ç§»é™¤Buff</summary>
    public void RemoveBuff(int buffId)
    {
        Buffs.RemoveAll(b => b.BuffId == buffId);
    }
    
    /// <summary>æ›´æ–°æ‰€æœ‰Buffï¼ˆæ¯å¸§è°ƒç”¨ï¼‰</summary>
    public void UpdateBuffs()
    {
        for (int i = Buffs.Count - 1; i >= 0; i--)
        {
            var buff = Buffs[i];
            buff.RemainingFrames--;
            
            // æŒç»­æ—¶é—´ç»“æŸï¼Œç§»é™¤Buff
            if (buff.RemainingFrames <= 0)
            {
                Buffs.RemoveAt(i);
            }
        }
    }
    
    /// <summary>è·å–æ‰€æœ‰å±æ€§ä¿®é¥°å™¨ï¼ˆä¾›DerivedStatsè®¡ç®—ä½¿ç”¨ï¼‰</summary>
    public Dictionary<StatType, List<StatModifier>> GetAllModifiers()
    {
        var modifiersByType = new Dictionary<StatType, List<StatModifier>>();
        
        foreach (var buff in Buffs)
        {
            // ä»Buffé…ç½®è¡¨è¯»å–ä¿®é¥°å™¨
            var buffConfig = ConfigManager.Instance.Tables.TbBuffTable.Get(buff.BuffId);
            if (buffConfig == null) continue;
            
            // è§£æBuffçš„ä¿®é¥°å™¨å­—ç¬¦ä¸²
            // æ ¼å¼ï¼š"ATK:Percent:0.2;SPD:Flat:1.0"
            var modifiers = ParseBuffModifiers(buffConfig.Modifiers, buff);
            
            foreach (var mod in modifiers)
            {
                if (!modifiersByType.ContainsKey(mod.StatType))
                {
                    modifiersByType[mod.StatType] = new List<StatModifier>();
                }
                modifiersByType[mod.StatType].Add(mod);
            }
        }
        
        return modifiersByType;
    }
    
    /// <summary>è§£æBuffä¿®é¥°å™¨å­—ç¬¦ä¸²</summary>
    private List<(StatType StatType, StatModifier Modifier)> ParseBuffModifiers(string modifierStr, BuffInstance buff)
    {
        var result = new List<(StatType, StatModifier)>();
        if (string.IsNullOrEmpty(modifierStr)) return result;
        
        // æ ¼å¼ï¼š"ATK:Percent:200;SPD:Flat:1000;CRIT_RATE:Flat:50"
        // æ•°å€¼å…¨éƒ¨æ˜¯intï¼ŒPercentå’Œå°æ•°éœ€è¦é™¤ä»¥1000
        var parts = modifierStr.Split(';');
        
        foreach (var part in parts)
        {
            var tokens = part.Split(':');
            if (tokens.Length != 3) continue;
            
            // è§£æå±æ€§ç±»å‹
            if (!System.Enum.TryParse<StatType>(tokens[0], out var statType))
                continue;
            
            // è§£æä¿®é¥°å™¨ç±»å‹
            if (!System.Enum.TryParse<ModifierType>(tokens[1], out var modType))
                continue;
            
            // è§£ææ•°å€¼ï¼ˆé…ç½®è¡¨å­˜intï¼‰
            if (!int.TryParse(tokens[2], out var intValue))
                continue;
            
            // è½¬æ¢ä¸ºFP
            FP value;
            if (modType == ModifierType.Percent || NeedsDivide1000(statType))
            {
                // Percentå’Œå°æ•°å±æ€§ï¼šé™¤ä»¥1000
                value = (FP)intValue / (FP)1000;
            }
            else
            {
                // Flatæ•´æ•°å±æ€§ï¼šç›´æ¥è½¬æ¢
                value = (FP)intValue;
            }
            
            // åº”ç”¨å åŠ å±‚æ•°
            value *= (FP)buff.StackCount;
            
            result.Add((statType, new StatModifier
            {
                SourceId = buff.BuffId,
                Type = modType,
                Value = value,
                Priority = GetModifierPriority(modType)
            }));
        }
        
        return result;
    }
    
    /// <summary>åˆ¤æ–­å±æ€§æ˜¯å¦éœ€è¦é™¤ä»¥1000</summary>
    private bool NeedsDivide1000(StatType type)
    {
        return type switch
        {
            StatType.SPD => true,
            StatType.CRIT_RATE => true,
            StatType.CRIT_DMG => true,
            StatType.ACCURACY => true,
            StatType.EVASION => true,
            StatType.BLOCK_RATE => true,
            StatType.PHYSICAL_RES => true,
            StatType.MAGICAL_RES => true,
            StatType.MANA_REGEN => true,
            StatType.HEALTH_REGEN => true,
            _ => false // å…¶ä»–å±æ€§ä¸éœ€è¦
        };
    }
    
    /// <summary>è·å–ä¿®é¥°å™¨ä¼˜å…ˆçº§</summary>
    private int GetModifierPriority(ModifierType type)
    {
        return type switch
        {
            ModifierType.Flat => 100,
            ModifierType.Percent => 200,
            ModifierType.FinalMultiplier => 300,
            _ => 0
        };
    }
}
```

**ä¿®é¥°å™¨å­—ç¬¦ä¸²æ ¼å¼**ï¼š
```
æ ¼å¼ï¼šå±æ€§:ç±»å‹:æ•°å€¼;å±æ€§:ç±»å‹:æ•°å€¼;...
æ³¨æ„ï¼šæ•°å€¼å…¨éƒ¨ä¸ºint

ç¤ºä¾‹ï¼š
"ATK:Percent:200;SPD:Flat:1000;CRIT_RATE:Flat:50"
è§£æä¸ºï¼š
  - ATK +20% (Percent, 200/1000=0.2)
  - SPD +1.0 (Flat, 1000/1000=1.0)
  - CRIT_RATE +5% (Flat, 50/1000=0.05)

è§„åˆ™ï¼š
  - Percentç±»å‹ï¼šæ€»æ˜¯é™¤ä»¥1000
  - Flatç±»å‹ï¼šæ ¹æ®å±æ€§ç±»å‹åˆ¤æ–­
    - æ•´æ•°å±æ€§ï¼ˆATK/DEF/HPç­‰ï¼‰ï¼šç›´æ¥ä½¿ç”¨
    - å°æ•°å±æ€§ï¼ˆSPD/CRIT_RATEç­‰ï¼‰ï¼šé™¤ä»¥1000
```

**Buffå®ä¾‹æ•°æ®ç»“æ„**ï¼š

```csharp
/// <summary>Buffå®ä¾‹</summary>
[MemoryPackable]
public partial class BuffInstance
{
    /// <summary>Buffé…ç½®ID</summary>
    public int BuffId { get; set; }
    
    /// <summary>å‰©ä½™æŒç»­å¸§æ•°</summary>
    public int RemainingFrames { get; set; }
    
    /// <summary>æŒç»­æ—¶é—´ï¼ˆæ€»å¸§æ•°ï¼‰</summary>
    public int Duration { get; set; }
    
    /// <summary>å åŠ å±‚æ•°</summary>
    public int StackCount { get; set; } = 1;
    
    /// <summary>æ˜¯å¦å¯å åŠ </summary>
    public bool Stackable { get; set; } = false;
    
    /// <summary>æœ€å¤§å åŠ å±‚æ•°</summary>
    public int MaxStack { get; set; } = 1;
    
    /// <summary>æ–½æ³•è€…IDï¼ˆç”¨äºè¿½è¸ªæ¥æºï¼‰</summary>
    public long CasterId { get; set; }
    
    /// <summary>Buffç±»å‹ï¼ˆ1=Buff, 2=Debuffï¼‰</summary>
    public int BuffType { get; set; } = 1;
}
```

---

### 2.6 StateComponentï¼ˆçŠ¶æ€ç»„ä»¶ï¼‰

**èŒè´£**ï¼šå­˜å‚¨å®ä½“çš„å„ç§çŠ¶æ€æ ‡å¿—

**çŠ¶æ€åˆ—è¡¨**ï¼š

```csharp
[MemoryPackable]
public partial class StateComponent : BaseComponent
{
    // ===== æ§åˆ¶çŠ¶æ€ =====
    
    /// <summary>æ˜¯å¦è¢«æ™•çœ©</summary>
    public bool IsStunned { get; set; } = false;
    
    /// <summary>æ˜¯å¦è¢«å†°å†»</summary>
    public bool IsFrozen { get; set; } = false;
    
    /// <summary>æ˜¯å¦è¢«å‡»é£</summary>
    public bool IsKnockedBack { get; set; } = false;
    
    /// <summary>æ˜¯å¦è¢«æ²‰é»˜ï¼ˆæ— æ³•é‡Šæ”¾æŠ€èƒ½ï¼‰</summary>
    public bool IsSilenced { get; set; } = false;
    
    /// <summary>æ˜¯å¦è¢«ç¼´æ¢°ï¼ˆæ— æ³•æ™®é€šæ”»å‡»ï¼‰</summary>
    public bool IsDisarmed { get; set; } = false;
    
    // ===== ç‰¹æ®ŠçŠ¶æ€ =====
    
    /// <summary>æ˜¯å¦æ— æ•Œ</summary>
    public bool IsInvincible { get; set; } = false;
    
    /// <summary>æ˜¯å¦éšèº«</summary>
    public bool IsInvisible { get; set; } = false;
    
    /// <summary>æ˜¯å¦åœ¨æ ¼æŒ¡çŠ¶æ€</summary>
    public bool IsBlocking { get; set; } = false;
    
    /// <summary>æ˜¯å¦åœ¨å†²åˆºçŠ¶æ€</summary>
    public bool IsDashing { get; set; } = false;
    
    /// <summary>æ˜¯å¦åœ¨æ–½æ³•çŠ¶æ€</summary>
    public bool IsCasting { get; set; } = false;
    
    // ===== æ­»äº¡çŠ¶æ€ =====
    
    /// <summary>æ˜¯å¦å·²æ­»äº¡</summary>
    public bool IsDead { get; set; } = false;
    
    // ===== è¾…åŠ©æ–¹æ³• =====
    
    /// <summary>æ˜¯å¦å¯ä»¥ç§»åŠ¨</summary>
    public bool CanMove()
    {
        return !IsStunned && !IsFrozen && !IsKnockedBack && !IsDead;
    }
    
    /// <summary>æ˜¯å¦å¯ä»¥æ”»å‡»</summary>
    public bool CanAttack()
    {
        return !IsStunned && !IsFrozen && !IsDisarmed && !IsDead;
    }
    
    /// <summary>æ˜¯å¦å¯ä»¥é‡Šæ”¾æŠ€èƒ½</summary>
    public bool CanCastSkill()
    {
        return !IsStunned && !IsFrozen && !IsSilenced && !IsDead;
    }
    
    /// <summary>æ˜¯å¦å¯ä»¥å—åˆ°ä¼¤å®³</summary>
    public bool CanTakeDamage()
    {
        return !IsInvincible && !IsDead;
    }
}
```

---

### 2.7 LevelComponentï¼ˆç­‰çº§ç»„ä»¶ï¼‰

**èŒè´£**ï¼šç®¡ç†å®ä½“çš„ç­‰çº§å’Œç»éªŒ

```csharp
[MemoryPackable]
public partial class LevelComponent : BaseComponent
{
    /// <summary>å½“å‰ç­‰çº§</summary>
    public int CurrentLevel { get; set; } = 1;
    
    /// <summary>å½“å‰ç»éªŒå€¼</summary>
    public int CurrentExp { get; set; } = 0;
    
    /// <summary>å‡åˆ°ä¸‹ä¸€çº§æ‰€éœ€ç»éªŒ</summary>
    public int ExpToNextLevel { get; set; } = 1000;
    
    /// <summary>æœ€å¤§ç­‰çº§</summary>
    public int MaxLevel { get; set; } = 100;
    
    /// <summary>è·å¾—ç»éªŒ</summary>
    public bool GainExp(int amount, Entity owner)
    {
        if (CurrentLevel >= MaxLevel)
            return false;
        
        CurrentExp += amount;
        
        // æ£€æŸ¥æ˜¯å¦å‡çº§
        if (CurrentExp >= ExpToNextLevel)
        {
            LevelUp(owner);
            return true;
        }
        
        return false;
    }
    
    /// <summary>å‡çº§</summary>
    private void LevelUp(Entity owner)
    {
        CurrentLevel++;
        CurrentExp -= ExpToNextLevel;
        
        // 1. æ›´æ–°ä¸‹ä¸€çº§ç»éªŒéœ€æ±‚
        var roleInfo = owner.GetComponent<RoleInfoComponent>();
        var growthConfig = ConfigManager.Instance.Tables.TbRoleGrowthTable.GetByLevel(roleInfo.RoleId, CurrentLevel + 1);
        ExpToNextLevel = growthConfig?.RequiredExp ?? ExpToNextLevel;
        
        // 2. æ›´æ–°åŸºç¡€å±æ€§
        var baseStats = owner.GetComponent<BaseStatsComponent>();
        baseStats.InitializeFromConfig(roleInfo.RoleId, CurrentLevel);
        
        // 3. é‡æ–°è®¡ç®—æ´¾ç”Ÿå±æ€§
        var derivedStats = owner.GetComponent<DerivedStatsComponent>();
        derivedStats.RecalculateAll(baseStats);
        
        // 4. æ»¡è¡€æ»¡è“
        var dynamicStats = owner.GetComponent<DynamicStatsComponent>();
        dynamicStats.CurrentHealth = derivedStats.FinalMaxHealth;
        dynamicStats.CurrentMana = derivedStats.FinalMaxMana;
        
        ASLogger.Instance.Info($"[Level] Entity {owner.UniqueId} leveled up to {CurrentLevel}!");
    }
}
```

---

### 2.8 GrowthComponentï¼ˆæˆé•¿ç»„ä»¶ï¼‰

**èŒè´£**ï¼šè®°å½•æˆé•¿æ›²çº¿ç›¸å…³æ•°æ®å’ŒåŠ ç‚¹åˆ†é…

```csharp
[MemoryPackable]
public partial class GrowthComponent : BaseComponent
{
    /// <summary>è§’è‰²IDï¼ˆå…³è”æˆé•¿è¡¨ï¼‰</summary>
    public int RoleId { get; set; }
    
    /// <summary>å¯åˆ†é…çš„å±æ€§ç‚¹</summary>
    public int AvailableStatPoints { get; set; } = 0;
    
    /// <summary>å·²åˆ†é…çš„æ”»å‡»ç‚¹</summary>
    public int AllocatedAttackPoints { get; set; } = 0;
    
    /// <summary>å·²åˆ†é…çš„é˜²å¾¡ç‚¹</summary>
    public int AllocatedDefensePoints { get; set; } = 0;
    
    /// <summary>å·²åˆ†é…çš„ç”Ÿå‘½ç‚¹</summary>
    public int AllocatedHealthPoints { get; set; } = 0;
    
    /// <summary>å·²åˆ†é…çš„é€Ÿåº¦ç‚¹</summary>
    public int AllocatedSpeedPoints { get; set; } = 0;
    
    /// <summary>åˆ†é…å±æ€§ç‚¹</summary>
    public bool AllocatePoint(StatType statType, Entity owner)
    {
        if (AvailableStatPoints <= 0)
            return false;
        
        // 1. æ‰£é™¤å¯ç”¨ç‚¹æ•°
        AvailableStatPoints--;
        
        // 2. å¢åŠ å¯¹åº”å±æ€§çš„åˆ†é…ç‚¹å’ŒåŸºç¡€å±æ€§
        var baseStats = owner.GetComponent<BaseStatsComponent>();
        
        switch (statType)
        {
            case StatType.ATK:
                AllocatedAttackPoints++;
                baseStats.BaseStats.Add(StatType.ATK, 2f); // æ¯ç‚¹+2æ”»å‡»
                break;
            case StatType.DEF:
                AllocatedDefensePoints++;
                baseStats.BaseStats.Add(StatType.DEF, 2f);
                break;
            case StatType.HP:
                AllocatedHealthPoints++;
                baseStats.BaseStats.Add(StatType.HP, 20f); // æ¯ç‚¹+20ç”Ÿå‘½
                break;
            case StatType.SPD:
                AllocatedSpeedPoints++;
                baseStats.BaseStats.Add(StatType.SPD, 0.1f);
                break;
            default:
                // ä¸æ”¯æŒçš„å±æ€§ç±»å‹
                AvailableStatPoints++; // è¿”è¿˜ç‚¹æ•°
                return false;
        }
        
        // 3. é‡æ–°è®¡ç®—æ´¾ç”Ÿå±æ€§
        var derivedStats = owner.GetComponent<DerivedStatsComponent>();
        derivedStats.RecalculateAll(baseStats);
        
        return true;
    }
}
```

---

## ä¸‰ã€é™æ€é…ç½®è¡¨è®¾è®¡

### 3.1 ç°æœ‰é…ç½®è¡¨è¯„ä¼°

#### âœ… RoleBaseTableï¼ˆè§’è‰²åŸºç¡€è¡¨ï¼‰
**å½“å‰å­—æ®µ**ï¼š
```csv
id, name, description, roleType,
baseAttack, baseDefense, baseHealth, baseSpeed,
attackGrowth, defenseGrowth, healthGrowth, speedGrowth,
lightAttackSkillId, heavyAttackSkillId, skill1Id, skill2Id
```

**è¯„ä¼°**ï¼š
- âœ… åŸºç¡€å››ç»´è¶³å¤Ÿï¼ˆæ”»é˜²è¡€é€Ÿï¼‰
- âœ… æˆé•¿å€¼å·²å®šä¹‰
- âŒ **ç¼ºå°‘é«˜çº§å±æ€§**ï¼ˆæš´å‡»ç‡ã€æš´å‡»ä¼¤å®³ã€å‘½ä¸­ã€é—ªé¿ç­‰ï¼‰

**å»ºè®®æ‰©å±•**ï¼š
```csv
baseCritRate,      # åŸºç¡€æš´å‡»ç‡ï¼ˆ0.05è¡¨ç¤º5%ï¼‰
baseCritDamage,    # åŸºç¡€æš´å‡»ä¼¤å®³ï¼ˆ2.0è¡¨ç¤º200%ï¼‰
baseAccuracy,      # åŸºç¡€å‘½ä¸­ç‡ï¼ˆ0.95è¡¨ç¤º95%ï¼‰
baseEvasion,       # åŸºç¡€é—ªé¿ç‡ï¼ˆ0.05è¡¨ç¤º5%ï¼‰
baseBlockRate,     # åŸºç¡€æ ¼æŒ¡ç‡ï¼ˆ0.10è¡¨ç¤º10%ï¼‰
baseBlockValue,    # åŸºç¡€æ ¼æŒ¡å€¼ï¼ˆ50ï¼‰
physicalRes,       # ç‰©ç†æŠ—æ€§ï¼ˆ0.1è¡¨ç¤ºå‡å…10%ï¼‰
magicalRes,        # é­”æ³•æŠ—æ€§
baseMaxMana,       # åŸºç¡€æ³•åŠ›ä¸Šé™
manaRegen,         # æ³•åŠ›å›å¤é€Ÿåº¦
healthRegen        # ç”Ÿå‘½å›å¤é€Ÿåº¦
```

#### âœ… RoleGrowthTableï¼ˆè§’è‰²æˆé•¿è¡¨ï¼‰
**å½“å‰å­—æ®µ**ï¼š
```csv
id, roleId, level, requiredExp,
lightAttackBonus, heavyAttackBonus, defenseBonus, healthBonus, speedBonus,
unlockSkillId, skillPoint
```

**è¯„ä¼°**ï¼š
- âœ… åŸºç¡€æˆé•¿å·²å®šä¹‰
- âœ… ç»éªŒéœ€æ±‚å·²å®šä¹‰
- âŒ **lightAttackBonus/heavyAttackBonus è¯­ä¹‰ä¸æ¸…**ï¼Œåº”è¯¥ç»Ÿä¸€ä¸ºæ”»å‡»åŠ›åŠ æˆ

**å»ºè®®ä¼˜åŒ–**ï¼š
```csv
id, roleId, level, requiredExp,
attackBonus,       # æ¯çº§æ”»å‡»åŠ›åŠ æˆï¼ˆç»Ÿä¸€ï¼‰
defenseBonus,      # æ¯çº§é˜²å¾¡åŠ›åŠ æˆ
healthBonus,       # æ¯çº§ç”Ÿå‘½å€¼åŠ æˆ
speedBonus,        # æ¯çº§é€Ÿåº¦åŠ æˆ
critRateBonus,     # æ¯çº§æš´å‡»ç‡åŠ æˆï¼ˆ0.005è¡¨ç¤º0.5%ï¼‰
critDamageBonus,   # æ¯çº§æš´å‡»ä¼¤å®³åŠ æˆ
unlockSkillId,     # è§£é”çš„æŠ€èƒ½ID
skillPoint         # è·å¾—çš„æŠ€èƒ½ç‚¹
```

#### âœ… SkillEffectTableï¼ˆæŠ€èƒ½æ•ˆæœè¡¨ï¼‰
**å½“å‰å­—æ®µ**ï¼š
```csv
skillEffectId, effectType, effectValue, targetType,
effectDuration, effectRange, castTime, effectParams,
visualEffectId, soundEffectId
```

**è¯„ä¼°**ï¼š
- âœ… æ•ˆæœç±»å‹å·²å®šä¹‰ï¼ˆ1=ä¼¤å®³, 2=æ²»ç–—, 3=å‡»é€€ï¼‰
- âœ… effectValueå­—æ®µå¯ç”¨ï¼ˆå½“å‰æ˜¯ç™¾åˆ†æ¯”ï¼Œå¦‚150.0ï¼‰
- âš ï¸ **effectValueè¯­ä¹‰ä¸æ˜ç¡®**ï¼ˆæ˜¯ç™¾åˆ†æ¯”è¿˜æ˜¯å›ºå®šå€¼ï¼Ÿï¼‰

**å»ºè®®æ˜ç¡®**ï¼š
```csv
effectValue,       # æ•ˆæœæ•°å€¼ï¼ˆä¼¤å®³æ•ˆæœæ—¶=æ”»å‡»åŠ›ç™¾åˆ†æ¯”ï¼Œæ²»ç–—æ•ˆæœæ—¶=å›ºå®šå€¼ï¼‰
damageType,        # ä¼¤å®³ç±»å‹ï¼ˆ1=ç‰©ç†, 2=é­”æ³•, 3=çœŸå®ï¼‰ä»…ä¼¤å®³æ•ˆæœæœ‰æ•ˆ
scalingStat,       # ç¼©æ”¾å±æ€§ï¼ˆ1=æ”»å‡»åŠ›, 2=é˜²å¾¡åŠ›, 3=ç”Ÿå‘½ä¸Šé™ï¼‰
scalingRatio       # ç¼©æ”¾æ¯”ä¾‹ï¼ˆ1.5è¡¨ç¤º150%ï¼‰
```

### 3.2 æ–°å¢é…ç½®è¡¨

#### ğŸ“ BuffTableï¼ˆBuffé…ç½®è¡¨ï¼‰

**ç”¨é€”**ï¼šå®šä¹‰æ‰€æœ‰Buff/Debuffçš„æ•ˆæœå’Œæ•°å€¼

```csv
##var,buffId,buffName,buffType,duration,stackable,maxStack,modifiers,tickDamage,tickInterval
##type,int,string,int,int,bool,int,string,int,int
##desc,BuffID,Buffåç§°,ç±»å‹(1=Buff/2=Debuff),æŒç»­å¸§æ•°,å¯å åŠ ,æœ€å¤§å±‚æ•°,å±æ€§ä¿®é¥°å™¨,æŒç»­ä¼¤å®³*1000,è§¦å‘é—´éš”å¸§æ•°

ç¤ºä¾‹æ•°æ®ï¼š
5001,åŠ›é‡ç¥ç¦,1,600,true,3,ATK:Percent:200;SPD:Flat:1000,0,0
5002,ç‡ƒçƒ§,2,300,false,1,PHYSICAL_RES:Percent:-100,10000,30
5003,æŠ¤ç›¾,1,180,false,1,æ— ,0,0
5004,å†°å†»,2,120,false,1,SPD:Percent:-500,0,0

# è§£é‡Šï¼š
# 5001 - åŠ›é‡ç¥ç¦ï¼šATK +20%ï¼ˆ200/1000ï¼‰ï¼ŒSPD +1.0ï¼ˆ1000/1000ï¼‰
# 5002 - ç‡ƒçƒ§ï¼šç‰©ç†æŠ—æ€§-10%ï¼ˆ-100/1000ï¼‰ï¼Œæ¯30å¸§é€ æˆ10.0ä¼¤å®³ï¼ˆ10000/1000ï¼‰
# 5003 - æŠ¤ç›¾ï¼šç‰¹æ®Šå¤„ç†ï¼ŒæŠ¤ç›¾å€¼åœ¨effectParamsä¸­å®šä¹‰
# 5004 - å†°å†»ï¼šé€Ÿåº¦-50%ï¼ˆ-500/1000ï¼‰
```

**å­—æ®µè¯´æ˜**ï¼š
- `buffType`: 1=å¢ç›ŠBuff, 2=å‡ç›ŠDebuff
- `duration`: æŒç»­å¸§æ•°ï¼ˆ300å¸§ = 15ç§’ @ 20FPSï¼‰
- `modifiers`: æ ¼å¼ `å±æ€§:ç±»å‹:æ•°å€¼;å±æ€§:ç±»å‹:æ•°å€¼`ï¼ˆ**æ•°å€¼ä¸ºint**ï¼‰
  - ä¾‹ï¼š`ATK:Percent:200` = æ”»å‡»åŠ›+20%ï¼ˆ200/1000=0.2ï¼‰
  - ä¾‹ï¼š`DEF:Flat:50` = é˜²å¾¡åŠ›+50ï¼ˆç›´æ¥ï¼‰
  - ä¾‹ï¼š`SPD:Flat:1000` = é€Ÿåº¦+1.0ï¼ˆ1000/1000ï¼‰
- `tickDamage`: æŒç»­ä¼¤å®³*1000ï¼ˆå¦‚10.0ä¼¤å®³å­˜ä¸º10000ï¼‰
- `tickInterval`: ä¼¤å®³é—´éš”å¸§æ•°

#### ğŸ“ AttributeTableï¼ˆå±æ€§é…ç½®è¡¨ï¼‰ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦æ›´çµæ´»çš„å±æ€§å®šä¹‰ï¼š

```csv
##var,attrId,attrName,minValue,maxValue,defaultValue,description
##type,int,string,float,float,float,string
##desc,å±æ€§ID,å±æ€§åç§°,æœ€å°å€¼,æœ€å¤§å€¼,é»˜è®¤å€¼,æè¿°

1,Attack,æ”»å‡»åŠ›,0,9999,100,å½±å“ç‰©ç†å’Œé­”æ³•ä¼¤å®³
2,Defense,é˜²å¾¡åŠ›,0,9999,50,å‡å°‘å—åˆ°çš„ç‰©ç†ä¼¤å®³
3,MaxHealth,ç”Ÿå‘½ä¸Šé™,1,99999,1000,è§’è‰²æœ€å¤§ç”Ÿå‘½å€¼
4,Speed,ç§»åŠ¨é€Ÿåº¦,0,20,10,å½±å“ç§»åŠ¨å’Œæ”»å‡»é€Ÿåº¦
5,CritRate,æš´å‡»ç‡,0,1,0.05,æ”»å‡»æš´å‡»æ¦‚ç‡
6,CritDamage,æš´å‡»ä¼¤å®³,1,10,2.0,æš´å‡»æ—¶çš„ä¼¤å®³å€ç‡
7,Accuracy,å‘½ä¸­ç‡,0,1,0.95,æ”»å‡»å‘½ä¸­æ¦‚ç‡
8,Evasion,é—ªé¿ç‡,0,1,0.05,é—ªé¿æ”»å‡»æ¦‚ç‡
```

---

## å››ã€å±æ€§è®¡ç®—æµç¨‹

### 4.1 å®Œæ•´è®¡ç®—æµç¨‹

```
æ¸¸æˆå¯åŠ¨/è§’è‰²åˆ›å»º
    â†“
[1] åˆå§‹åŒ– BaseStatsComponent
    - ä» RoleBaseTable è¯»å–åŸºç¡€å€¼
    - ä» RoleGrowthTable è¯»å–ç­‰çº§åŠ æˆ
    - ä» GrowthComponent è¯»å–åŠ ç‚¹åˆ†é…
    â†“
[2] åˆå§‹åŒ– DerivedStatsComponent
    - æ”¶é›† BuffComponent çš„ä¿®é¥°å™¨
    - æ”¶é›†è£…å¤‡çš„ä¿®é¥°å™¨ï¼ˆå¦‚æœ‰ï¼‰
    - æŒ‰å…¬å¼è®¡ç®—æœ€ç»ˆå±æ€§
    â†“
[3] åˆå§‹åŒ– DynamicStatsComponent
    - CurrentHealth = DerivedStats.FinalMaxHealth
    - CurrentMana = DerivedStats.FinalMaxMana
    - å…¶ä»–èµ„æºåˆå§‹åŒ–ä¸º0æˆ–é»˜è®¤å€¼
    â†“
æ¸¸æˆè¿è¡Œä¸­...
    â†“
[4] Buffå˜åŒ–æ—¶
    - BuffComponent.AddBuff() / RemoveBuff()
    - è§¦å‘ DerivedStats.RecalculateAll()
    - æ›´æ–°æœ€ç»ˆå±æ€§
    â†“
[5] å‡çº§æ—¶
    - LevelComponent.LevelUp()
    - æ›´æ–° BaseStatsï¼ˆè¯»å–æ–°ç­‰çº§çš„é…ç½®ï¼‰
    - è§¦å‘ DerivedStats.RecalculateAll()
    - æ¢å¤ DynamicStatsï¼ˆæ»¡è¡€æ»¡è“ï¼‰
    â†“
[6] å—åˆ°ä¼¤å®³æ—¶
    - DamageCalculator.Calculate() ä½¿ç”¨ DerivedStats
    - DynamicStats.TakeDamage()
    - æ‰£é™¤ CurrentHealth
```

### 4.2 å±æ€§è®¡ç®—å…¬å¼

#### æœ€ç»ˆå±æ€§è®¡ç®—
```
æœ€ç»ˆå±æ€§ = (åŸºç¡€å±æ€§ + å›ºå®šåŠ æˆ) Ã— (1 + ç™¾åˆ†æ¯”åŠ æˆ) Ã— æœ€ç»ˆä¹˜æ•°

ç¤ºä¾‹ï¼š
åŸºç¡€æ”»å‡» = 100
Buff1: +20æ”»å‡»ï¼ˆFlatï¼‰
Buff2: +30%æ”»å‡»ï¼ˆPercentï¼‰
Buff3: Ã—1.5ä¼¤å®³ï¼ˆFinalMultiplierï¼‰

æœ€ç»ˆæ”»å‡» = (100 + 20) Ã— (1 + 0.3) Ã— 1.5 = 234
```

#### ä¿®é¥°å™¨ä¼˜å…ˆçº§
```
1. Flatï¼ˆå›ºå®šåŠ æˆï¼‰     - ä¼˜å…ˆçº§ 100
2. Percentï¼ˆç™¾åˆ†æ¯”åŠ æˆï¼‰ - ä¼˜å…ˆçº§ 200
3. FinalMultiplierï¼ˆæœ€ç»ˆä¹˜æ•°ï¼‰ - ä¼˜å…ˆçº§ 300
```

---

## äº”ã€ä¼¤å®³è®¡ç®—å…¬å¼

### 5.1 å®Œæ•´ä¼¤å®³è®¡ç®—æµç¨‹

```csharp
public static DamageResult Calculate(Entity caster, Entity target, SkillEffectTable effectConfig)
{
    // 1. è·å–æ–½æ³•è€…å’Œç›®æ ‡çš„æ´¾ç”Ÿå±æ€§
    var casterDerived = caster.GetComponent<DerivedStatsComponent>();
    var targetDerived = target.GetComponent<DerivedStatsComponent>();
    var targetState = target.GetComponent<StateComponent>();
    
    // 2. æ£€æŸ¥æ˜¯å¦å¯ä»¥å—ä¼¤
    if (!targetState.CanTakeDamage())
        return new DamageResult { FinalDamage = 0, IsCritical = false };
    
    // 3. è·å–å±æ€§å€¼ï¼ˆå®šç‚¹æ•°ï¼‰
    FP casterAttack = casterDerived.Get(StatType.ATK);
    FP casterAccuracy = casterDerived.Get(StatType.ACCURACY);
    FP casterCritRate = casterDerived.Get(StatType.CRIT_RATE);
    FP casterCritDamage = casterDerived.Get(StatType.CRIT_DMG);
    
    FP targetDefense = targetDerived.Get(StatType.DEF);
    FP targetEvasion = targetDerived.Get(StatType.EVASION);
    FP targetBlockRate = targetDerived.Get(StatType.BLOCK_RATE);
    FP targetBlockValue = targetDerived.Get(StatType.BLOCK_VALUE);
    
    // 4. è®¡ç®—åŸºç¡€ä¼¤å®³
    FP baseDamage = CalculateBaseDamage(casterAttack, effectConfig);
    
    // 5. å‘½ä¸­åˆ¤å®š
    if (!CheckHit(casterAccuracy, targetEvasion))
        return new DamageResult { FinalDamage = FP.Zero, IsCritical = false, IsMiss = true };
    
    // 6. æ ¼æŒ¡åˆ¤å®š
    bool isBlocked = CheckBlock(targetBlockRate);
    if (isBlocked)
    {
        baseDamage = FPMath.Max(FP.Zero, baseDamage - targetBlockValue);
    }
    
    // 7. æš´å‡»åˆ¤å®š
    bool isCritical = CheckCritical(casterCritRate);
    if (isCritical)
    {
        baseDamage *= casterCritDamage;
    }
    
    // 8. åº”ç”¨é˜²å¾¡å‡å…
    FP afterDefense = ApplyDefense(baseDamage, targetDefense, effectConfig.DamageType);
    
    // 9. åº”ç”¨æŠ—æ€§
    FP afterResistance = ApplyResistance(afterDefense, targetDerived, effectConfig.DamageType);
    
    // 10. åº”ç”¨éšæœºæµ®åŠ¨ï¼ˆæ³¨æ„ï¼šä½¿ç”¨ç¡®å®šæ€§éšæœºï¼‰
    FP finalDamage = ApplyDeterministicVariance(afterResistance, randomSeed);
    
    // 11. ç¡®ä¿éè´Ÿ
    finalDamage = FPMath.Max(FP.Zero, finalDamage);
    
    return new DamageResult
    {
        FinalDamage = finalDamage,
        IsCritical = isCritical,
        IsBlocked = isBlocked,
        DamageType = effectConfig.DamageType
    };
}
```

### 5.2 åŸºç¡€ä¼¤å®³è®¡ç®—

```csharp
private static FP CalculateBaseDamage(FP attack, SkillEffectTable effectConfig)
{
    // effectValue é€šå¸¸æ˜¯ç™¾åˆ†æ¯”ï¼ˆå¦‚150è¡¨ç¤º150%æ”»å‡»åŠ›ï¼‰
    FP ratio = (FP)effectConfig.EffectValue / (FP)100;
    return attack * ratio;
}
```

ç¤ºä¾‹ï¼š
```
æ”»å‡»åŠ› = FP(100)
æŠ€èƒ½å€ç‡ = FP(1.5)ï¼ˆé…ç½®è¡¨ä¸­ effectValue = 150ï¼‰
åŸºç¡€ä¼¤å®³ = FP(100) Ã— FP(1.5) = FP(150)
```

### 5.3 é˜²å¾¡å‡å…å…¬å¼

#### ç‰©ç†/é­”æ³•ä¼¤å®³

```csharp
private static FP ApplyDefense(FP baseDamage, FP defense, DamageType damageType)
{
    // çœŸå®ä¼¤å®³æ— è§†é˜²å¾¡
    if (damageType == DamageType.True)
        return baseDamage;
    
    // å‡ä¼¤å…¬å¼ï¼šå‡ä¼¤ç™¾åˆ†æ¯” = é˜²å¾¡ / (é˜²å¾¡ + 100)
    FP damageReduction = defense / (defense + (FP)100);
    return baseDamage * (FP.One - damageReduction);
}
```

ç¤ºä¾‹ï¼š
```
åŸºç¡€ä¼¤å®³ = FP(150)
é˜²å¾¡åŠ› = FP(50)
å‡ä¼¤ = FP(50) / (FP(50) + FP(100)) = FP(0.333) (33.3%)
æœ€ç»ˆä¼¤å®³ = FP(150) Ã— (FP.One - FP(0.333)) = FP(100)
```

**é˜²å¾¡æ”¶ç›Šæ›²çº¿**ï¼š
- é˜²å¾¡ 25 â†’ çº¦20%å‡ä¼¤
- é˜²å¾¡ 50 â†’ çº¦33%å‡ä¼¤
- é˜²å¾¡ 100 â†’ çº¦50%å‡ä¼¤
- é˜²å¾¡ 200 â†’ çº¦67%å‡ä¼¤
- é˜²å¾¡ 400 â†’ çº¦80%å‡ä¼¤

#### çœŸå®ä¼¤å®³
```
çœŸå®ä¼¤å®³ = åŸºç¡€ä¼¤å®³ï¼ˆæ— è§†é˜²å¾¡ï¼‰
```

### 5.4 æŠ—æ€§å‡å…

```csharp
private static FP ApplyResistance(FP damage, DerivedStatsComponent targetDerived, DamageType damageType)
{
    FP resistance = FP.Zero;
    
    switch (damageType)
    {
        case DamageType.Physical:
            resistance = targetDerived.Get(StatType.PHYSICAL_RES);
            break;
        case DamageType.Magical:
            resistance = targetDerived.Get(StatType.MAGICAL_RES);
            break;
        case DamageType.True:
            return damage; // çœŸå®ä¼¤å®³æ— è§†æŠ—æ€§
    }
    
    return damage * (FP.One - resistance);
}
```

ç¤ºä¾‹ï¼š
```
ä¼¤å®³ = FP(100)
ç‰©ç†æŠ—æ€§ = FP(0.2)ï¼ˆ20%ï¼‰
æœ€ç»ˆä¼¤å®³ = FP(100) Ã— (FP.One - FP(0.2)) = FP(80)
```

**æŠ—æ€§æ¥æº**ï¼š
- Buff/Debuff
- è£…å¤‡
- è¢«åŠ¨æŠ€èƒ½
- ç§æ—ç‰¹æ€§

### 5.5 æš´å‡»è®¡ç®—

```csharp
private static bool CheckCritical(FP critRate, int randomSeed)
{
    // ä½¿ç”¨ç¡®å®šæ€§éšæœºï¼ˆåŸºäºç§å­ï¼‰
    TSRandom random = new TSRandom(randomSeed);
    FP roll = random.NextFP(); // è¿”å› [0, 1) çš„å®šç‚¹æ•°
    return roll < critRate;
}
```

ç¤ºä¾‹ï¼š
```
åŸºç¡€ä¼¤å®³ = FP(150)
æš´å‡»ç‡ = FP(0.25)ï¼ˆ25%ï¼‰
æš´å‡»ä¼¤å®³å€ç‡ = FP(2.5)ï¼ˆ250%ï¼‰
éšæœºå€¼ = FP(0.18)ï¼ˆåŸºäºç§å­ç¡®å®šæ€§ç”Ÿæˆï¼‰

â†’ 0.18 < 0.25 â†’ æš´å‡»æˆåŠŸï¼
â†’ æš´å‡»ä¼¤å®³ = FP(150) Ã— FP(2.5) = FP(375)
```

**ç¡®å®šæ€§ä¿è¯**ï¼š
- âœ… ä½¿ç”¨ `TSRandom`ï¼ˆTrueSyncçš„ç¡®å®šæ€§éšæœºï¼‰
- âœ… åŸºäºç»Ÿä¸€çš„ç§å­ï¼ˆå¦‚å¸§å·+å®ä½“IDï¼‰
- âœ… æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæˆç›¸åŒçš„éšæœºæ•°åºåˆ—

### 5.6 å‘½ä¸­/é—ªé¿åˆ¤å®š

```csharp
private static bool CheckHit(FP accuracy, FP evasion, int randomSeed)
{
    // æœ€ç»ˆå‘½ä¸­æ¦‚ç‡ = å‘½ä¸­ç‡ - é—ªé¿ç‡
    FP hitChance = accuracy - evasion;
    
    // æé™çº¦æŸ
    hitChance = FPMath.Clamp(hitChance, (FP)0.1, FP.One); // [10%, 100%]
    
    TSRandom random = new TSRandom(randomSeed);
    FP roll = random.NextFP();
    return roll < hitChance;
}
```

ç¤ºä¾‹ï¼š
```
æ–½æ³•è€…å‘½ä¸­ç‡ = FP(0.95)ï¼ˆ95%ï¼‰
ç›®æ ‡é—ªé¿ç‡ = FP(0.15)ï¼ˆ15%ï¼‰
æœ€ç»ˆå‘½ä¸­ç‡ = FP(0.95) - FP(0.15) = FP(0.80)ï¼ˆ80%ï¼‰
éšæœºå€¼ = FP(0.65)ï¼ˆç¡®å®šæ€§ç”Ÿæˆï¼‰

â†’ 0.65 < 0.80 â†’ å‘½ä¸­æˆåŠŸï¼
```

**æé™çº¦æŸ**ï¼š
- æœ€ä½å‘½ä¸­ç‡ï¼š10%ï¼ˆå³ä½¿ç›®æ ‡é—ªé¿100%ï¼‰
- æœ€é«˜å‘½ä¸­ç‡ï¼š100%ï¼ˆæ— æ³•è¶…è¿‡ï¼‰

### 5.7 æ ¼æŒ¡åˆ¤å®š

```csharp
private static bool CheckBlock(FP blockRate, int randomSeed)
{
    TSRandom random = new TSRandom(randomSeed);
    FP roll = random.NextFP();
    return roll < blockRate;
}
```

ç¤ºä¾‹ï¼š
```
åŸä¼¤å®³ = FP(150)
æ ¼æŒ¡ç‡ = FP(0.30)ï¼ˆ30%ï¼‰
æ ¼æŒ¡å€¼ = FP(80)
éšæœºå€¼ = FP(0.22)

â†’ 0.22 < 0.30 â†’ æ ¼æŒ¡æˆåŠŸï¼
â†’ æ ¼æŒ¡åä¼¤å®³ = FPMath.Max(FP.Zero, FP(150) - FP(80)) = FP(70)
```

---

## å…­ã€å®Œæ•´ä¼¤å®³è®¡ç®—ç¤ºä¾‹

### åœºæ™¯ï¼šéª‘å£«æ”»å‡»æ³•å¸ˆ

**æ–½æ³•è€…ï¼ˆéª‘å£« Lv5ï¼‰**ï¼š
```
BaseStats:
  ATK = 80 + 8Ã—4 = 112ï¼ˆåŸºç¡€80ï¼Œç­‰çº§åŠ æˆ8/çº§ï¼‰
  CRIT_RATE = 0.05
  CRIT_DMG = 2.0
  ACCURACY = 0.95

Buffs:
  [åŠ›é‡ç¥ç¦] ATK +20% (Percent)
  [ç‹‚æˆ˜å£«] CRIT_DMG Ã—1.5 (FinalMultiplier)

DerivedStats:
  FinalStats.Get(StatType.ATK) = 112 Ã— 1.2 = 134.4
  FinalStats.Get(StatType.CRIT_RATE) = 0.05
  FinalStats.Get(StatType.CRIT_DMG) = 2.0 Ã— 1.5 = 3.0
  FinalStats.Get(StatType.ACCURACY) = 0.95
```

**ç›®æ ‡ï¼ˆæ³•å¸ˆ Lv3ï¼‰**ï¼š
```
BaseStats:
  DEF = 40 + 4Ã—2 = 48
  EVASION = 0.10
  BLOCK_RATE = 0.05
  BLOCK_VALUE = 30
  PHYSICAL_RES = 0.0
  MAGICAL_RES = 0.3

DerivedStats:
  FinalStats.Get(StatType.DEF) = 48
  FinalStats.Get(StatType.EVASION) = 0.10
  FinalStats.Get(StatType.BLOCK_RATE) = 0.05
  FinalStats.Get(StatType.BLOCK_VALUE) = 30
```

**æŠ€èƒ½æ•ˆæœé…ç½®**ï¼š
```
SkillEffectId: 4001
EffectType: 1ï¼ˆä¼¤å®³ï¼‰
EffectValue: 150ï¼ˆ150%æ”»å‡»åŠ›ï¼‰
DamageType: 1ï¼ˆç‰©ç†ï¼‰
```

**è®¡ç®—æµç¨‹**ï¼š

```
[1] åŸºç¡€ä¼¤å®³è®¡ç®—
    = FinalAttack Ã— (EffectValue / 100)
    = 134.4 Ã— 1.5
    = 201.6

[2] å‘½ä¸­åˆ¤å®š
    å‘½ä¸­æ¦‚ç‡ = FinalAccuracy - FinalEvasion
             = 0.95 - 0.10 = 0.85ï¼ˆ85%ï¼‰
    éšæœºæ•° = 0.42 â†’ å‘½ä¸­æˆåŠŸï¼

[3] æ ¼æŒ¡åˆ¤å®š
    æ ¼æŒ¡æ¦‚ç‡ = FinalBlockRate = 0.05ï¼ˆ5%ï¼‰
    éšæœºæ•° = 0.82 â†’ æ ¼æŒ¡å¤±è´¥

[4] æš´å‡»åˆ¤å®š
    æš´å‡»æ¦‚ç‡ = FinalCritRate = 0.05ï¼ˆ5%ï¼‰
    éšæœºæ•° = 0.03 â†’ æš´å‡»æˆåŠŸï¼ğŸ’¥
    æš´å‡»ä¼¤å®³ = 201.6 Ã— 3.0 = 604.8

[5] é˜²å¾¡å‡å…
    å‡ä¼¤ç™¾åˆ†æ¯” = Defense / (Defense + 100)
                = 48 / 148 = 0.324ï¼ˆ32.4%ï¼‰
    ä¼¤å®³ = 604.8 Ã— (1 - 0.324) = 408.8

[6] æŠ—æ€§å‡å…ï¼ˆç‰©ç†æŠ—æ€§ï¼‰
    æŠ—æ€§ = FinalPhysicalResistance = 0.0
    ä¼¤å®³ = 408.8 Ã— (1 - 0.0) = 408.8

[7] éšæœºæµ®åŠ¨ï¼ˆÂ±5%ï¼‰
    éšæœºæ•° = 0.62 â†’ æµ®åŠ¨ = 0.97
    æœ€ç»ˆä¼¤å®³ = 408.8 Ã— 0.97 = 396.5

[8] ç»“æœ
    âœ… å‘½ä¸­
    âœ… æš´å‡»
    âŒ æ ¼æŒ¡å¤±è´¥
    æœ€ç»ˆä¼¤å®³ï¼š396.5
```

---

## ä¸ƒã€æˆé•¿ç³»ç»Ÿè®¾è®¡

### 7.1 ç­‰çº§æˆé•¿

**ç»éªŒè·å–**ï¼š
- å‡»æ€æ•Œäºº
- å®Œæˆå…³å¡
- ä½¿ç”¨ç»éªŒé“å…·

**å‡çº§æ”¶ç›Š**ï¼ˆä»¥éª‘å£«ä¸ºä¾‹ï¼‰ï¼š
```
ç­‰çº§1â†’2ï¼š
  éœ€è¦ç»éªŒï¼š1000
  å±æ€§åŠ æˆï¼šæ”»å‡»+8ï¼Œé˜²å¾¡+8ï¼Œç”Ÿå‘½+100ï¼Œé€Ÿåº¦+0.1
  æŠ€èƒ½ç‚¹ï¼š+1

ç­‰çº§2â†’3ï¼š
  éœ€è¦ç»éªŒï¼š2500
  å±æ€§åŠ æˆï¼šæ”»å‡»+8ï¼Œé˜²å¾¡+8ï¼Œç”Ÿå‘½+100ï¼Œé€Ÿåº¦+0.1
  æŠ€èƒ½ç‚¹ï¼š+1
  
ç­‰çº§5ã€10ã€15...ï¼ˆæ¯5çº§ï¼‰ï¼š
  æŠ€èƒ½ç‚¹ï¼š+2ï¼ˆé¢å¤–å¥–åŠ±ï¼‰
  å¯èƒ½è§£é”æ–°æŠ€èƒ½
```

### 7.2 è‡ªç”±åŠ ç‚¹ç³»ç»Ÿ

**åŠ ç‚¹è§„åˆ™**ï¼š
- æ¯çº§è·å¾— 1-2 æŠ€èƒ½ç‚¹
- å¯åˆ†é…åˆ°å››ç»´å±æ€§
- æ¯ç‚¹æ”¶ç›Šï¼š
  - æ”»å‡»ï¼š+2
  - é˜²å¾¡ï¼š+2
  - ç”Ÿå‘½ï¼š+20
  - é€Ÿåº¦ï¼š+0.1

**åŠ ç‚¹ç¤ºä¾‹**ï¼š
```
éª‘å£« Lv10ï¼Œå…±15ç‚¹å¯åˆ†é…
ç©å®¶åˆ†é…ï¼š
  æ”»å‡»ï¼š5ç‚¹ â†’ +10æ”»å‡»
  é˜²å¾¡ï¼š3ç‚¹ â†’ +6é˜²å¾¡
  ç”Ÿå‘½ï¼š7ç‚¹ â†’ +140ç”Ÿå‘½
  é€Ÿåº¦ï¼š0ç‚¹

æœ€ç»ˆå±æ€§ï¼š
  æ”»å‡» = 80ï¼ˆåŸºç¡€ï¼‰+ 72ï¼ˆç­‰çº§ï¼‰+ 10ï¼ˆåŠ ç‚¹ï¼‰= 162
  é˜²å¾¡ = 80ï¼ˆåŸºç¡€ï¼‰+ 72ï¼ˆç­‰çº§ï¼‰+ 6ï¼ˆåŠ ç‚¹ï¼‰= 158
  ç”Ÿå‘½ = 1000ï¼ˆåŸºç¡€ï¼‰+ 900ï¼ˆç­‰çº§ï¼‰+ 140ï¼ˆåŠ ç‚¹ï¼‰= 2040
  é€Ÿåº¦ = 10ï¼ˆåŸºç¡€ï¼‰+ 0.9ï¼ˆç­‰çº§ï¼‰= 10.9
```

---

## å…«ã€Buffç³»ç»Ÿè®¾è®¡

### 8.1 Buffç”Ÿå‘½å‘¨æœŸ

```
Buffè§¦å‘ï¼ˆæŠ€èƒ½æ•ˆæœ/é“å…·/ç¯å¢ƒï¼‰
    â†“
[1] BuffComponent.AddBuff(buffInstance)
    - æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒID Buff
    - å¯å åŠ ï¼šå¢åŠ å±‚æ•°ï¼Œåˆ·æ–°æ—¶é—´
    - ä¸å¯å åŠ ï¼šåˆ·æ–°æ—¶é—´
    â†“
[2] æ·»åŠ å±æ€§ä¿®é¥°å™¨åˆ° DerivedStatsComponent
    - ä» BuffTable è¯»å–ä¿®é¥°å™¨é…ç½®
    - æ·»åŠ åˆ°å¯¹åº”å±æ€§çš„ä¿®é¥°å™¨åˆ—è¡¨
    â†“
[3] DerivedStatsComponent.RecalculateAll()
    - é‡æ–°è®¡ç®—æ‰€æœ‰æœ€ç»ˆå±æ€§
    â†“
æ¯å¸§æ›´æ–°
    â†“
[4] BuffComponent.UpdateBuffs()
    - å‡å°‘æ‰€æœ‰Buffçš„å‰©ä½™å¸§æ•°
    - ç§»é™¤è¿‡æœŸBuff
    - è§¦å‘æŒç»­ä¼¤å®³ï¼ˆå¦‚ç‡ƒçƒ§ï¼‰
    â†“
[5] Buffç§»é™¤æ—¶
    - ä»ä¿®é¥°å™¨åˆ—è¡¨ç§»é™¤
    - é‡æ–°è®¡ç®—å±æ€§
```

### 8.2 Buffå åŠ è§„åˆ™

#### åŒID Buff
```
æƒ…å†µ1ï¼šå¯å åŠ Buffï¼ˆå¦‚"åŠ›é‡ç¥ç¦"ï¼‰
  å·²æœ‰ï¼š[åŠ›é‡ç¥ç¦] 2å±‚ï¼Œå‰©ä½™200å¸§
  æ–°å¢ï¼š[åŠ›é‡ç¥ç¦] 1å±‚ï¼Œ300å¸§
  
  ç»“æœï¼š[åŠ›é‡ç¥ç¦] 3å±‚ï¼ˆMax 3ï¼‰ï¼Œå‰©ä½™300å¸§ï¼ˆåˆ·æ–°ï¼‰
  æ•ˆæœï¼šAttack +20% Ã— 3å±‚ = +60%

æƒ…å†µ2ï¼šä¸å¯å åŠ Buffï¼ˆå¦‚"æŠ¤ç›¾"ï¼‰
  å·²æœ‰ï¼š[æŠ¤ç›¾] å‰©ä½™100å¸§
  æ–°å¢ï¼š[æŠ¤ç›¾] 180å¸§
  
  ç»“æœï¼š[æŠ¤ç›¾] å‰©ä½™180å¸§ï¼ˆåˆ·æ–°æ—¶é—´ï¼‰
  æ•ˆæœï¼šShield +200ï¼ˆä¸å˜ï¼‰
```

#### ä¸åŒID Buff
```
å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œåˆ†åˆ«ç”Ÿæ•ˆ

ç¤ºä¾‹ï¼š
  [åŠ›é‡ç¥ç¦] Attack +20%
  [æˆ˜æ–—ç‹‚çƒ­] Attack +10%
  
  æ€»æ•ˆæœï¼šAttack +30%
```

### 8.3 Buffé…ç½®ç¤ºä¾‹

```csv
# BuffTableï¼ˆæ‰€æœ‰æ•°å€¼éƒ½æ˜¯intï¼‰
buffId,buffName,buffType,duration,stackable,maxStack,modifiers,tickDamage,tickInterval

# å¢ç›ŠBuff
5001,åŠ›é‡ç¥ç¦,1,600,true,3,ATK:Percent:200,0,0
5002,æé€Ÿ,1,300,false,1,SPD:Percent:500,0,0
5003,æŠ¤ç›¾,1,180,false,1,æ— ,0,0
5004,ç‹‚æš´,1,600,true,5,ATK:Percent:100;CRIT_RATE:Flat:50,0,0

# å‡ç›ŠDebuff
6001,ç‡ƒçƒ§,2,300,false,1,PHYSICAL_RES:Percent:-100,10000,30
6002,å†°å†»,2,120,false,1,SPD:Percent:-800,0,0
6003,è™šå¼±,2,600,true,3,ATK:Percent:-150,0,0
6004,ç ´ç”²,2,300,false,1,DEF:Percent:-300,0,0

# è§£é‡Šï¼š
# 5001 - ATK +20%ï¼ˆ200/1000=0.2ï¼‰
# 5002 - SPD +50%ï¼ˆ500/1000=0.5ï¼‰
# 5004 - ATK +10%ï¼ˆ100/1000=0.1ï¼‰ï¼ŒCRIT_RATE +5%ï¼ˆ50/1000=0.05ï¼‰
# 6001 - ç‰©ç†æŠ—æ€§-10%ï¼ˆ-100/1000=-0.1ï¼‰ï¼Œæ¯30å¸§10.0ä¼¤å®³ï¼ˆ10000/1000=10.0ï¼‰
# 6002 - é€Ÿåº¦-80%ï¼ˆ-800/1000=-0.8ï¼‰
```

---

## ä¹ã€çŠ¶æ€ç³»ç»Ÿè®¾è®¡

### 9.1 StateComponentè¯¦ç»†è®¾è®¡

**æ§åˆ¶çŠ¶æ€**ï¼ˆæ— æ³•è¡ŒåŠ¨ï¼‰ï¼š
- `IsStunned` - æ™•çœ©ï¼ˆæ— æ³•ç§»åŠ¨ã€æ”»å‡»ã€é‡Šæ”¾æŠ€èƒ½ï¼‰
- `IsFrozen` - å†°å†»ï¼ˆæ— æ³•ç§»åŠ¨ã€æ”»å‡»ï¼‰
- `IsKnockedBack` - å‡»é£ï¼ˆå¼ºåˆ¶ç§»åŠ¨ï¼‰
- `IsSilenced` - æ²‰é»˜ï¼ˆæ— æ³•é‡Šæ”¾æŠ€èƒ½ï¼‰
- `IsDisarmed` - ç¼´æ¢°ï¼ˆæ— æ³•æ™®é€šæ”»å‡»ï¼‰

**ç‰¹æ®ŠçŠ¶æ€**ï¼š
- `IsInvincible` - æ— æ•Œï¼ˆä¸å—ä¼¤å®³ï¼‰
- `IsInvisible` - éšèº«ï¼ˆä¸è¢«AIæ£€æµ‹ï¼‰
- `IsBlocking` - æ ¼æŒ¡ä¸­ï¼ˆæé«˜æ ¼æŒ¡ç‡ï¼‰
- `IsDashing` - å†²åˆºä¸­ï¼ˆé€šå¸¸å¸¦æ— æ•Œï¼‰
- `IsCasting` - æ–½æ³•ä¸­ï¼ˆå¯èƒ½è¢«æ‰“æ–­ï¼‰

**çŠ¶æ€æ£€æŸ¥**ï¼š
```csharp
// æ˜¯å¦å¯ä»¥ç§»åŠ¨
public bool CanMove()
{
    return !IsStunned && !IsFrozen && !IsKnockedBack && !IsDead;
}

// æ˜¯å¦å¯ä»¥æ”»å‡»
public bool CanAttack()
{
    return !IsStunned && !IsFrozen && !IsDisarmed && !IsDead;
}

// æ˜¯å¦å¯ä»¥é‡Šæ”¾æŠ€èƒ½
public bool CanCastSkill()
{
    return !IsStunned && !IsFrozen && !IsSilenced && !IsDead;
}

// æ˜¯å¦å¯ä»¥å—åˆ°ä¼¤å®³
public bool CanTakeDamage()
{
    return !IsInvincible && !IsDead;
}
```

---

## åã€é…ç½®è¡¨æ‰©å±•æ–¹æ¡ˆ

### 10.1 RoleBaseTableæ‰©å±•

**æ–°å¢å­—æ®µ**ï¼ˆé«˜çº§å±æ€§ï¼‰ï¼š

```csv
##var,id,name,...,baseAttack,baseDefense,baseHealth,baseSpeed,baseCritRate,baseCritDamage,baseAccuracy,baseEvasion,baseBlockRate,baseBlockValue,physicalRes,magicalRes,baseMaxMana,manaRegen,healthRegen
##type,int,string,...,int,int,int,int,int,int,int,int,int,int,int,int,int,int,int
##desc,è§’è‰²ID,è§’è‰²åç§°,...,åŸºç¡€æ”»å‡»åŠ›,åŸºç¡€é˜²å¾¡åŠ›,åŸºç¡€ç”Ÿå‘½å€¼,åŸºç¡€ç§»åŠ¨é€Ÿåº¦*1000,åŸºç¡€æš´å‡»ç‡*1000,åŸºç¡€æš´å‡»ä¼¤å®³*1000,åŸºç¡€å‘½ä¸­ç‡*1000,åŸºç¡€é—ªé¿ç‡*1000,åŸºç¡€æ ¼æŒ¡ç‡*1000,åŸºç¡€æ ¼æŒ¡å€¼,ç‰©ç†æŠ—æ€§*1000,é­”æ³•æŠ—æ€§*1000,åŸºç¡€æ³•åŠ›ä¸Šé™,æ³•åŠ›å›å¤*1000,ç”Ÿå‘½å›å¤*1000

# ç¤ºä¾‹æ•°æ®ï¼ˆéª‘å£«ï¼‰
1001,éª‘å£«,...,80,80,1000,10000,50,2000,950,50,150,60,100,0,100,5000,2000
# è§£é‡Šï¼š
# - æ”»å‡»80ã€é˜²å¾¡80ã€ç”Ÿå‘½1000ï¼ˆæ•´æ•°ï¼‰
# - é€Ÿåº¦10.0ï¼ˆ10000/1000ï¼‰
# - æš´å‡»ç‡5%ï¼ˆ50/1000=0.05ï¼‰
# - æš´å‡»ä¼¤å®³200%ï¼ˆ2000/1000=2.0ï¼‰
# - å‘½ä¸­ç‡95%ï¼ˆ950/1000=0.95ï¼‰
# - é—ªé¿ç‡5%ï¼ˆ50/1000=0.05ï¼‰
# - æ ¼æŒ¡ç‡15%ï¼ˆ150/1000=0.15ï¼‰
# - æ ¼æŒ¡å€¼60ï¼ˆæ•´æ•°ï¼‰
# - ç‰©ç†æŠ—æ€§10%ï¼ˆ100/1000=0.1ï¼‰
# - é­”æ³•æŠ—æ€§0%ï¼ˆ0/1000=0ï¼‰
# - æ³•åŠ›ä¸Šé™100ï¼ˆæ•´æ•°ï¼‰
# - æ³•åŠ›å›å¤5.0/ç§’ï¼ˆ5000/1000ï¼‰
# - ç”Ÿå‘½å›å¤2.0/ç§’ï¼ˆ2000/1000ï¼‰

# ç¤ºä¾‹æ•°æ®ï¼ˆåˆºå®¢ - é«˜æš´å‡»ä½é˜²å¾¡ï¼‰
1005,åˆºå®¢,...,70,50,600,7000,250,2500,980,200,50,30,0,0,80,4000,1000
# - æš´å‡»ç‡25%ï¼ˆ250/1000ï¼‰
# - æš´å‡»ä¼¤å®³250%ï¼ˆ2500/1000ï¼‰
# - é—ªé¿ç‡20%ï¼ˆ200/1000ï¼‰
# - é€Ÿåº¦7.0ï¼ˆ7000/1000ï¼‰

# ç¤ºä¾‹æ•°æ®ï¼ˆæ³•å¸ˆ - é«˜é­”æŠ—ä½ç‰©æŠ—ï¼‰
1003,æ³•å¸ˆ,...,50,40,700,4500,100,2200,900,80,80,40,0,300,200,10000,1500
# - é­”æ³•æŠ—æ€§30%ï¼ˆ300/1000ï¼‰
# - é€Ÿåº¦4.5ï¼ˆ4500/1000ï¼‰
# - æ³•åŠ›ä¸Šé™200
```

**é…ç½®è§„åˆ™æ€»è¡¨**ï¼š

| å±æ€§ç±»å‹ | é…ç½®è¡¨ç±»å‹ | é…ç½®ç¤ºä¾‹ | è¿è¡Œæ—¶å€¼ | è½¬æ¢è§„åˆ™ |
|---------|----------|---------|---------|---------|
| æ”»å‡»/é˜²å¾¡/ç”Ÿå‘½ | int | 80 | FP(80) | ç›´æ¥è½¬æ¢ |
| é€Ÿåº¦ | int | 10500 | FP(10.5) | é™¤ä»¥1000 |
| æš´å‡»ç‡ | int | 50 | FP(0.05) | é™¤ä»¥1000 |
| æš´å‡»ä¼¤å®³ | int | 2000 | FP(2.0) | é™¤ä»¥1000 |
| å‘½ä¸­ç‡/é—ªé¿ç‡ | int | 950/50 | FP(0.95)/FP(0.05) | é™¤ä»¥1000 |
| æŠ—æ€§ | int | 100 | FP(0.1) | é™¤ä»¥1000 |
| å›å¤é€Ÿåº¦ | int | 5000 | FP(5.0) | é™¤ä»¥1000 |

**è®°å¿†æ³•åˆ™**ï¼š
- âœ… **æ•´æ•°å±æ€§**ï¼šç›´æ¥é…ç½®ï¼ˆæ”»å‡»ã€é˜²å¾¡ã€ç”Ÿå‘½ã€æ³•åŠ›ä¸Šé™ç­‰ï¼‰
- âœ… **å°æ•°å±æ€§**ï¼š**æ‰©å¤§1000å€**å­˜å‚¨ï¼ˆé€Ÿåº¦ã€å›å¤é€Ÿåº¦ç­‰ï¼‰
- âœ… **ç™¾åˆ†æ¯”å±æ€§**ï¼š**æ‰©å¤§1000å€**ï¼ˆæš´å‡»ç‡ã€æŠ—æ€§ç­‰ï¼Œ5%å­˜ä¸º50ï¼‰
- âœ… **è¿è¡Œæ—¶è¯»å–**ï¼šéœ€è¦é™¤ä»¥1000çš„å±æ€§ï¼Œä»£ç ä¸­åˆ¤æ–­

### 10.2 RoleGrowthTableä¼˜åŒ–

**ä¼˜åŒ–å­—æ®µ**ï¼š

```csv
##var,id,roleId,level,requiredExp,attackBonus,defenseBonus,healthBonus,speedBonus,critRateBonus,critDamageBonus,unlockSkillId,skillPoint
##type,int,int,int,int,int,int,int,int,int,int,int,int
##desc,ID,è§’è‰²ID,ç­‰çº§,å‡çº§æ‰€éœ€ç»éªŒ,æ”»å‡»åŠ›åŠ æˆ,é˜²å¾¡åŠ›åŠ æˆ,ç”Ÿå‘½å€¼åŠ æˆ,é€Ÿåº¦åŠ æˆ*1000,æš´å‡»ç‡åŠ æˆ*1000,æš´å‡»ä¼¤å®³åŠ æˆ*1000,è§£é”æŠ€èƒ½ID,æŠ€èƒ½ç‚¹

# ç¤ºä¾‹æ•°æ®ï¼ˆéª‘å£« Lv2ï¼‰
2,1001,2,1000,8,8,100,100,2,50,0,1
# è§£é‡Šï¼š
# - æ”»å‡» +8
# - é˜²å¾¡ +8
# - ç”Ÿå‘½ +100
# - é€Ÿåº¦ +0.1ï¼ˆ100/1000ï¼‰
# - æš´å‡»ç‡ +0.2%ï¼ˆ2/1000ï¼‰
# - æš´å‡»ä¼¤å®³ +5%ï¼ˆ50/1000=0.05ï¼‰

# ç¤ºä¾‹æ•°æ®ï¼ˆåˆºå®¢ Lv2 - é«˜é€Ÿåº¦å’Œæš´å‡»æˆé•¿ï¼‰
12,1005,2,1000,7,5,60,200,5,100,0,1
# - æ”»å‡» +7
# - é€Ÿåº¦ +0.2ï¼ˆ200/1000ï¼‰
# - æš´å‡»ç‡ +0.5%ï¼ˆ5/1000ï¼‰
# - æš´å‡»ä¼¤å®³ +10%ï¼ˆ100/1000ï¼‰
```

**é…ç½®è§„åˆ™**ï¼š
- **æ•´æ•°åŠ æˆ**ï¼šç›´æ¥é…ç½®ï¼ˆæ”»å‡»ã€é˜²å¾¡ã€ç”Ÿå‘½ç­‰ï¼‰
- **å°æ•°åŠ æˆ**ï¼š**æ‰©å¤§1000å€**ï¼ˆé€Ÿåº¦ã€æš´å‡»ç‡ã€æš´å‡»ä¼¤å®³ç­‰ï¼‰

### 10.3 æ–°å¢BuffTable

è§ [å…«ã€Buffç³»ç»Ÿè®¾è®¡](#82-buffå åŠ è§„åˆ™) ä¸­çš„é…ç½®ç¤ºä¾‹ã€‚

### 10.4 SkillEffectTableä¼˜åŒ–

**æ–°å¢å­—æ®µ**ï¼š

```csv
##var,skillEffectId,...,damageType,scalingStat,scalingRatio
##type,int,...,int,int,float
##desc,æ•ˆæœID,...,ä¼¤å®³ç±»å‹(1=ç‰©ç†/2=é­”æ³•/3=çœŸå®),ç¼©æ”¾å±æ€§(1=æ”»å‡»/2=é˜²å¾¡/3=ç”Ÿå‘½),ç¼©æ”¾æ¯”ä¾‹

# ç¤ºä¾‹ï¼šç‰©ç†ä¼¤å®³ï¼Œ150%æ”»å‡»åŠ›ç¼©æ”¾
4001,é‡å‡»,1,150.0,1,0.0,0.0,Physical,1,1,1.5

# ç¤ºä¾‹ï¼šé­”æ³•ä¼¤å®³ï¼Œ200%æ”»å‡»åŠ›ç¼©æ”¾
4013,ç«çƒæœ¯,1,200.0,1,0.0,3.0,Magical,1,1,2.0

# ç¤ºä¾‹ï¼šçœŸå®ä¼¤å®³ï¼Œ100%ç”Ÿå‘½ä¸Šé™ç¼©æ”¾ï¼ˆæ–©æ€æŠ€èƒ½ï¼‰
4099,ç»ˆç»“æŠ€,1,0.0,1,0.0,0.0,True,3,3,0.1
```

---

## åä¸€ã€æ•°å€¼å¹³è¡¡å‚è€ƒ

### 11.1 åŸºç¡€æ•°å€¼å»ºè®®

**æˆ˜å£«å‹ï¼ˆéª‘å£«ã€é‡é”¤è€…ï¼‰**ï¼š
```
æ”»å‡»ï¼š80-100
é˜²å¾¡ï¼š80-120
ç”Ÿå‘½ï¼š1000-1200
é€Ÿåº¦ï¼š3.5-10
æš´å‡»ç‡ï¼š5-10%
```

**æ•æ·å‹ï¼ˆåˆºå®¢ã€å¼“æ‰‹ï¼‰**ï¼š
```
æ”»å‡»ï¼š60-80
é˜²å¾¡ï¼š50-60
ç”Ÿå‘½ï¼š600-800
é€Ÿåº¦ï¼š6-10
æš´å‡»ç‡ï¼š20-30%
```

**æ³•å¸ˆå‹ï¼ˆæ³•å¸ˆï¼‰**ï¼š
```
æ”»å‡»ï¼š50-60
é˜²å¾¡ï¼š40-50
ç”Ÿå‘½ï¼š700-800
é€Ÿåº¦ï¼š4.5-6
æš´å‡»ç‡ï¼š10-15%
é­”æ³•æŠ—æ€§ï¼š20-30%
```

### 11.2 æˆé•¿æ›²çº¿å»ºè®®

**æ”»å‡»åŠ›æˆé•¿**ï¼š
```
æˆ˜å£«å‹ï¼šæ¯çº§ +8-10
æ•æ·å‹ï¼šæ¯çº§ +6-8
æ³•å¸ˆå‹ï¼šæ¯çº§ +5-7
```

**ç”Ÿå‘½å€¼æˆé•¿**ï¼š
```
æˆ˜å£«å‹ï¼šæ¯çº§ +100-120
æ•æ·å‹ï¼šæ¯çº§ +60-80
æ³•å¸ˆå‹ï¼šæ¯çº§ +70-90
```

### 11.3 ä¼¤å®³å€ç‡å»ºè®®

**æ™®é€šæ”»å‡»**ï¼š
```
è½»å‡»ï¼š80-120%æ”»å‡»åŠ›
é‡å‡»ï¼š150-200%æ”»å‡»åŠ›
```

**æŠ€èƒ½ä¼¤å®³**ï¼š
```
å°æŠ€èƒ½ï¼š150-250%æ”»å‡»åŠ›
ä¸­æŠ€èƒ½ï¼š300-500%æ”»å‡»åŠ›
å¤§æ‹›ï¼š800-1500%æ”»å‡»åŠ›
```

**BuffåŠ æˆ**ï¼š
```
æ™®é€šBuffï¼š+10-20%å±æ€§
å¼ºåŠ›Buffï¼š+30-50%å±æ€§
ç»ˆæBuffï¼š+100%å±æ€§ï¼ˆçŸ­æ—¶é—´ï¼‰
```

---

## åäºŒã€å®ç°æ¸…å•

### Phase 1ï¼šæ ¸å¿ƒç»„ä»¶å®ç°

1. **åˆ›å»º BaseStatsComponent.cs**
   - å®šä¹‰æ‰€æœ‰åŸºç¡€å±æ€§å­—æ®µ
   - å®ç° InitializeFromConfig() æ–¹æ³•
   - æ”¯æŒç­‰çº§æˆé•¿å’ŒåŠ ç‚¹

2. **åˆ›å»º DerivedStatsComponent.cs**
   - å®šä¹‰æ‰€æœ‰æ´¾ç”Ÿå±æ€§å­—æ®µ
   - å®ç° RecalculateAll() æ–¹æ³•
   - å®ç°ä¿®é¥°å™¨ç®¡ç†

3. **åˆ›å»º DynamicStatsComponent.cs**
   - å®šä¹‰åŠ¨æ€èµ„æºï¼ˆHPã€MPã€èƒ½é‡ç­‰ï¼‰
   - å®ç° TakeDamage()ã€Heal() ç­‰æ–¹æ³•
   - å®ç°èµ„æºæ¶ˆè€—å’Œæ¢å¤

4. **åˆ›å»º BuffComponent.cs**
   - å®ç° Buff æ·»åŠ /ç§»é™¤/æ›´æ–°
   - å®ç° Buff å åŠ é€»è¾‘
   - å®ç°ä¿®é¥°å™¨æå–

5. **åˆ›å»º StateComponent.cs**
   - å®šä¹‰æ‰€æœ‰çŠ¶æ€æ ‡å¿—
   - å®ç°çŠ¶æ€æ£€æŸ¥æ–¹æ³•

6. **åˆ›å»º LevelComponent.cs**
   - å®ç°ç­‰çº§å’Œç»éªŒç®¡ç†
   - å®ç°å‡çº§é€»è¾‘

7. **åˆ›å»º GrowthComponent.cs**
   - å®ç°è‡ªç”±åŠ ç‚¹ç³»ç»Ÿ
   - å®ç°åŠ ç‚¹åˆ†é…é€»è¾‘

### Phase 2ï¼šé…ç½®è¡¨æ‰©å±•

8. **æ‰©å±• RoleBaseTable**
   - æ·»åŠ é«˜çº§å±æ€§å­—æ®µ
   - æ›´æ–°ç°æœ‰è§’è‰²æ•°æ®

9. **ä¼˜åŒ– RoleGrowthTable**
   - ç»Ÿä¸€æˆé•¿å­—æ®µå‘½å
   - æ·»åŠ æš´å‡»æˆé•¿

10. **åˆ›å»º BuffTable**
    - å®šä¹‰Buffé…ç½®ç»“æ„
    - æ·»åŠ ç¤ºä¾‹Buffæ•°æ®

11. **ä¼˜åŒ– SkillEffectTable**
    - æ·»åŠ ä¼¤å®³ç±»å‹ã€ç¼©æ”¾å±æ€§å­—æ®µ
    - æ›´æ–°ç°æœ‰æŠ€èƒ½æ•ˆæœæ•°æ®

### Phase 3ï¼šä¼¤å®³è®¡ç®—é‡æ„

12. **é‡æ„ DamageCalculator.cs**
    - å®ç°å®Œæ•´çš„ä¼¤å®³è®¡ç®—å…¬å¼
    - æ¥å…¥çœŸå®çš„å±æ€§ç³»ç»Ÿ
    - å®ç°å‘½ä¸­/é—ªé¿/æ ¼æŒ¡/æš´å‡»åˆ¤å®š

13. **åˆ›å»º StatModifier.cs**
    - å®šä¹‰ä¿®é¥°å™¨æ•°æ®ç»“æ„
    - å®ç°ä¿®é¥°å™¨è§£æ

14. **åˆ›å»º DamageResult.cs æ‰©å±•**
    - æ·»åŠ æ›´å¤šä¼¤å®³ä¿¡æ¯ï¼ˆæ ¼æŒ¡ã€é—ªé¿ç­‰ï¼‰

### Phase 4ï¼šé›†æˆæµ‹è¯•

15. **å±æ€§ç³»ç»Ÿé›†æˆæµ‹è¯•**
    - æµ‹è¯•ä¸‰å±‚å±æ€§è®¡ç®—æ­£ç¡®æ€§
    - æµ‹è¯•BuffåŠ æˆç”Ÿæ•ˆ
    - æµ‹è¯•ç­‰çº§æˆé•¿

16. **ä¼¤å®³è®¡ç®—é›†æˆæµ‹è¯•**
    - æµ‹è¯•å„ç§ä¼¤å®³ç±»å‹
    - æµ‹è¯•æš´å‡»ã€æ ¼æŒ¡ã€é—ªé¿
    - æµ‹è¯•é˜²å¾¡å’ŒæŠ—æ€§

17. **Buffç³»ç»Ÿé›†æˆæµ‹è¯•**
    - æµ‹è¯•Buffå åŠ 
    - æµ‹è¯•Buffè¿‡æœŸç§»é™¤
    - æµ‹è¯•æŒç»­ä¼¤å®³

---

## åä¸‰ã€æŠ€æœ¯è¦ç‚¹

### 13.1 ç¡®å®šæ€§è®¡ç®—

**é—®é¢˜**ï¼šå¸§åŒæ­¥éœ€è¦ç¡®å®šæ€§ï¼Œä½†æµ®ç‚¹æ•°ä¸ç¡®å®š

**è§£å†³æ–¹æ¡ˆï¼ˆæœ¬ç³»ç»Ÿé‡‡ç”¨ï¼‰**ï¼š

#### âœ… å…¨é¢ä½¿ç”¨å®šç‚¹æ•°ï¼ˆFPï¼‰

```csharp
using TrueSync;

// æ‰€æœ‰å±æ€§å€¼ä½¿ç”¨FP
public class Stats
{
    private Dictionary<StatType, FP> _values;
    public FP Get(StatType type) => _values.TryGetValue(type, out var v) ? v : FP.Zero;
}

// æ‰€æœ‰è®¡ç®—ä½¿ç”¨FP
FP baseDamage = casterAttack * ratio;
FP finalDamage = baseDamage * (FP.One - damageReduction);
```

#### âœ… ç¡®å®šæ€§éšæœºæ•°

```csharp
// ä½¿ç”¨TrueSyncçš„TSRandomï¼ŒåŸºäºç§å­ç”Ÿæˆ
int seed = GenerateSeed(frameNumber, casterId, targetId);
TSRandom random = new TSRandom(seed);
FP randomValue = random.NextFP(); // [0, 1)

// æ‰€æœ‰å®¢æˆ·ç«¯ä½¿ç”¨ç›¸åŒç§å­ï¼Œç”Ÿæˆç›¸åŒéšæœºåºåˆ—
```

#### âœ… ç§å­ç”Ÿæˆç­–ç•¥

```csharp
private static int GenerateSeed(int frame, long casterId, long targetId)
{
    // ç¡®ä¿æ‰€æœ‰å®¢æˆ·ç«¯ç”Ÿæˆç›¸åŒç§å­
    return HashCode.Combine(frame, casterId, targetId);
}

// ç”¨æ³•ï¼š
int seed = GenerateSeed(currentFrame, caster.UniqueId, target.UniqueId);
bool isCrit = CheckCritical(critRate, seed);
```

**ç¡®å®šæ€§ä¿è¯**ï¼š
- âœ… æ•°å€¼å­˜å‚¨ï¼šä½¿ç”¨ `TrueSync.FP`ï¼ˆ64ä½å®šç‚¹æ•°ï¼‰
- âœ… æ•°å­¦è¿ç®—ï¼šä½¿ç”¨ `FPMath` å·¥å…·ç±»
- âœ… éšæœºåˆ¤å®šï¼šä½¿ç”¨ `TSRandom` + ç¡®å®šæ€§ç§å­
- âœ… æ‰€æœ‰å®¢æˆ·ç«¯ï¼šç›¸åŒè¾“å…¥â†’ç›¸åŒè¾“å‡º

**æ³¨æ„äº‹é¡¹**ï¼š
- âŒ ç¦æ­¢ä½¿ç”¨ `float`ã€`double` å­˜å‚¨è¿è¡Œæ—¶æ•°å€¼
- âŒ ç¦æ­¢ä½¿ç”¨ `System.Random`ï¼ˆä¸ç¡®å®šï¼‰
- âŒ ç¦æ­¢ä½¿ç”¨ `UnityEngine.Random`ï¼ˆä¸ç¡®å®šï¼‰
- âŒ ç¦æ­¢ä½¿ç”¨ `DateTime.Now`ï¼ˆä¸åŒæ­¥ï¼‰

### 13.2 æ€§èƒ½ä¼˜åŒ–

**é¿å…é¢‘ç¹é‡ç®—**ï¼š
```csharp
// æ–¹æ¡ˆï¼šè„æ ‡è®°æœºåˆ¶
public class DerivedStatsComponent
{
    private bool _isDirty = false;
    
    public void MarkDirty()
    {
        _isDirty = true;
    }
    
    public void RecalculateIfDirty(BaseStatsComponent baseStats)
    {
        if (!_isDirty) return;
        
        RecalculateAll(baseStats);
        _isDirty = false;
    }
}

// ä½¿ç”¨ï¼š
buffComponent.AddBuff(buff);
derivedStats.MarkDirty();

// å¸§ç»“æŸæ—¶ç»Ÿä¸€é‡ç®—
derivedStats.RecalculateIfDirty(baseStats);
```

### 13.3 é…ç½®è¡¨æ•°å€¼è§„åˆ™

**æ ¸å¿ƒåŸåˆ™**ï¼šé…ç½®è¡¨å…¨éƒ¨ä½¿ç”¨ `int` ç±»å‹ï¼Œé¿å…floatçš„ä¸ç¡®å®šæ€§

**é…ç½®è§„åˆ™**ï¼š

#### æ•´æ•°å±æ€§ï¼ˆç›´æ¥é…ç½®ï¼‰
```csv
baseAttack = 80      # æ”»å‡»åŠ›80 â†’ è¿è¡Œæ—¶ FP(80)
baseDefense = 80     # é˜²å¾¡åŠ›80 â†’ è¿è¡Œæ—¶ FP(80)
baseHealth = 1000    # ç”Ÿå‘½å€¼1000 â†’ è¿è¡Œæ—¶ FP(1000)
```

#### å°æ•°å±æ€§ï¼ˆæ‰©å¤§1000å€ï¼‰
```csv
baseSpeed = 10500    # é€Ÿåº¦10.5 â†’ è¿è¡Œæ—¶ FP(10500)/FP(1000) = FP(10.5)
manaRegen = 5000     # æ³•åŠ›å›å¤5.0/ç§’ â†’ è¿è¡Œæ—¶ FP(5000)/FP(1000) = FP(5.0)
```

#### ç™¾åˆ†æ¯”å±æ€§ï¼ˆæ‰©å¤§1000å€ï¼‰
```csv
baseCritRate = 50    # æš´å‡»ç‡5% â†’ è¿è¡Œæ—¶ FP(50)/FP(1000) = FP(0.05)
baseCritDamage = 2000 # æš´å‡»ä¼¤å®³200% â†’ è¿è¡Œæ—¶ FP(2000)/FP(1000) = FP(2.0)
baseAccuracy = 950   # å‘½ä¸­ç‡95% â†’ è¿è¡Œæ—¶ FP(950)/FP(1000) = FP(0.95)
physicalRes = 100    # ç‰©ç†æŠ—æ€§10% â†’ è¿è¡Œæ—¶ FP(100)/FP(1000) = FP(0.1)
```

**ä»£ç ç¤ºä¾‹**ï¼š
```csharp
// é…ç½®è¡¨å­—æ®µç±»å‹
public class RoleBaseTable
{
    public int BaseAttack;     // æ•´æ•°å±æ€§
    public int BaseSpeed;      // å°æ•°å±æ€§*1000
    public int BaseCritRate;   // ç™¾åˆ†æ¯”*1000
}

// è¿è¡Œæ—¶è½¬æ¢
BaseStats.Set(StatType.ATK, (FP)roleConfig.BaseAttack);                    // ç›´æ¥è½¬æ¢
BaseStats.Set(StatType.SPD, (FP)roleConfig.BaseSpeed / (FP)1000);         // é™¤ä»¥1000
BaseStats.Set(StatType.CRIT_RATE, (FP)roleConfig.BaseCritRate / (FP)1000); // é™¤ä»¥1000
```

**ä¼˜åŠ¿**ï¼š
- âœ… é…ç½®è¡¨å…¨æ˜¯intï¼Œæ˜“äºç¼–è¾‘å’Œæ ¡éªŒ
- âœ… é¿å…floatç²¾åº¦é—®é¢˜
- âœ… CSVæ–‡ä»¶æ›´æ¸…æ™°ï¼ˆ50 vs 0.05ï¼‰
- âœ… è¿è¡Œæ—¶ä¸€æ¬¡æ€§è½¬æ¢ä¸ºFP

### 13.4 åºåˆ—åŒ–æ³¨æ„äº‹é¡¹

**MemoryPackåºåˆ—åŒ–**ï¼š
- âœ… `Dictionary<StatType, FP>`ï¼šæ­£å¸¸åºåˆ—åŒ–
- âœ… `Stats`å¯¹è±¡ï¼šå®Œæ•´åºåˆ—åŒ–
- âŒ ä¿®é¥°å™¨åˆ—è¡¨ï¼šæ ‡è®° `[MemoryPackIgnore]`ï¼ˆè¿è¡Œæ—¶è®¡ç®—ï¼‰
- âŒ `_modifiers` å­—å…¸ï¼šæ ‡è®° `[MemoryPackIgnore]`

```csharp
[MemoryPackable]
public partial class DerivedStatsComponent
{
    public Stats FinalStats { get; set; } // âœ… åºåˆ—åŒ–
    
    [MemoryPackIgnore]
    private Dictionary<StatType, List<StatModifier>> _modifiers; // âŒ ä¸åºåˆ—åŒ–
}
```

**ä¸ºä»€ä¹ˆä¸åºåˆ—åŒ–ä¿®é¥°å™¨**ï¼š
- ä¿®é¥°å™¨æ¥è‡ªBuffï¼ŒBuffæœ¬èº«ä¼šåºåˆ—åŒ–
- å›æ»šæ¢å¤åï¼Œä»Buffé‡æ–°è®¡ç®—ä¿®é¥°å™¨å³å¯
- å‡å°‘åºåˆ—åŒ–æ•°æ®é‡

---

## åå››ã€ä½¿ç”¨ç¤ºä¾‹

### 14.1 åˆ›å»ºè§’è‰²æ—¶åˆå§‹åŒ–

```csharp
// åˆ›å»ºè§’è‰²Entity
var playerEntity = EntityFactory.CreateRole(roleId: 1001, level: 1);

// ç»„ä»¶å·²è‡ªåŠ¨æ·»åŠ å’Œåˆå§‹åŒ–ï¼š
var baseStats = playerEntity.GetComponent<BaseStatsComponent>();
baseStats.InitializeFromConfig(1001, 1);
// â†’ BaseStats.Get(StatType.ATK) = 80
// â†’ BaseStats.Get(StatType.DEF) = 80
// â†’ BaseStats.Get(StatType.HP) = 1000

var derivedStats = playerEntity.GetComponent<DerivedStatsComponent>();
derivedStats.RecalculateAll(baseStats);
// â†’ FinalStats.Get(StatType.ATK) = 80
// â†’ FinalStats.Get(StatType.HP) = 1000

var dynamicStats = playerEntity.GetComponent<DynamicStatsComponent>();
dynamicStats.InitializeResources(derivedStats);
// â†’ CurrentHealth = 1000
// â†’ CurrentMana = 100
```

### 14.2 æ·»åŠ Buff

```csharp
// æ·»åŠ "åŠ›é‡ç¥ç¦"Buff
var buffComp = entity.GetComponent<BuffComponent>();
buffComp.AddBuff(new BuffInstance
{
    BuffId = 5001,              // åŠ›é‡ç¥ç¦
    Duration = 600,             // 30ç§’ï¼ˆ600å¸§ @ 20FPSï¼‰
    RemainingFrames = 600,
    StackCount = 1,
    Stackable = true,
    MaxStack = 3,
    CasterId = casterEntity.UniqueId
});

// é‡æ–°è®¡ç®—å±æ€§
var baseStats = entity.GetComponent<BaseStatsComponent>();
var derivedStats = entity.GetComponent<DerivedStatsComponent>();

// 1. æ¸…ç©ºæ—§çš„ä¿®é¥°å™¨
derivedStats.ClearModifiers();

// 2. ä»Buffæ”¶é›†æ–°çš„ä¿®é¥°å™¨
var buffModifiers = buffComp.GetAllModifiers();
foreach (var kvp in buffModifiers)
{
    foreach (var modifier in kvp.Value)
    {
        derivedStats.AddModifier(kvp.Key, modifier);
    }
}

// 3. é‡ç®—æ‰€æœ‰å±æ€§
derivedStats.RecalculateAll(baseStats);

// ç»“æœï¼š
// BaseStats.Get(StatType.ATK) = 100
// Buffä¿®é¥°å™¨: ATK +20% (Percent)
// FinalStats.Get(StatType.ATK) = 100 Ã— 1.2 = 120
```

### 14.3 ä¼¤å®³ç»“ç®—

```csharp
// æ–½æ”¾æŠ€èƒ½ï¼Œè§¦å‘ä¼¤å®³æ•ˆæœ
var effectConfig = ConfigManager.Instance.Tables.TbSkillEffectTable.Get(4001);

// ç”Ÿæˆç¡®å®šæ€§éšæœºç§å­
int seed = GenerateSeed(currentFrame, attackerEntity.UniqueId, targetEntity.UniqueId);

var damageResult = DamageCalculator.Calculate(
    caster: attackerEntity,
    target: targetEntity,
    effectConfig: effectConfig,
    randomSeed: seed
);

if (damageResult.IsMiss)
{
    // æœªå‘½ä¸­ï¼Œæ˜¾ç¤ºMISS
    return;
}

// åº”ç”¨ä¼¤å®³
var targetDynamic = targetEntity.GetComponent<DynamicStatsComponent>();
var targetDerived = targetEntity.GetComponent<DerivedStatsComponent>();

FP actualDamage = targetDynamic.TakeDamage(damageResult.FinalDamage, targetDerived);

// ä¼¤å®³åé¦ˆï¼ˆè½¬ä¸ºfloatç”¨äºUIæ˜¾ç¤ºï¼‰
float displayDamage = (float)actualDamage;

if (damageResult.IsCritical)
{
    ShowCriticalDamageText(displayDamage); // ğŸ’¥æš´å‡»
}
else if (damageResult.IsBlocked)
{
    ShowBlockedDamageText(displayDamage); // ğŸ›¡ï¸æ ¼æŒ¡
}
else
{
    ShowNormalDamageText(displayDamage);
}

// æ£€æŸ¥æ­»äº¡
if (targetDynamic.CurrentHealth <= FP.Zero)
{
    var stateComp = targetEntity.GetComponent<StateComponent>();
    stateComp.IsDead = true;
    OnEntityDied(targetEntity);
}
```

**DamageResultæ•°æ®ç»“æ„**ï¼š
```csharp
public class DamageResult
{
    public FP FinalDamage { get; set; }      // æœ€ç»ˆä¼¤å®³ï¼ˆå®šç‚¹æ•°ï¼‰
    public bool IsCritical { get; set; }     // æ˜¯å¦æš´å‡»
    public bool IsBlocked { get; set; }      // æ˜¯å¦æ ¼æŒ¡
    public bool IsMiss { get; set; }         // æ˜¯å¦æœªå‘½ä¸­
    public DamageType DamageType { get; set; } // ä¼¤å®³ç±»å‹
}
```

### 14.4 å‡çº§å¤„ç†

```csharp
// è·å¾—ç»éªŒ
var levelComp = entity.GetComponent<LevelComponent>();
bool leveledUp = levelComp.GainExp(1500, entity);

if (leveledUp)
{
    // LevelUp() å†…éƒ¨å·²è‡ªåŠ¨ï¼š
    // 1. æ›´æ–° BaseStats
    // 2. é‡ç®— DerivedStats
    // 3. æ¢å¤ DynamicStats
    // 4. å¢åŠ æŠ€èƒ½ç‚¹
    
    // UIæ˜¾ç¤ºå‡çº§ç‰¹æ•ˆ
    ShowLevelUpEffect(entity);
}
```

---

## åäº”ã€ä¸ç°æœ‰ç³»ç»Ÿçš„é›†æˆ

### 15.1 æ›¿æ¢HealthComponent

**ç°çŠ¶**ï¼š
```csharp
// æ—§çš„HealthComponent
public int CurrentHealth { get; set; }
public int MaxHealth { get; set; }
```

**è¿ç§»æ–¹æ¡ˆ**ï¼š
```csharp
// æ–¹å¼1ï¼šä¿ç•™HealthComponentä½œä¸ºæ¡¥æ¥
public class HealthComponent : BaseComponent
{
    public int CurrentHealth 
    {
        get => (int)Entity.GetComponent<DynamicStatsComponent>().CurrentHealth;
        set => Entity.GetComponent<DynamicStatsComponent>().CurrentHealth = value;
    }
    
    public int MaxHealth
    {
        get => (int)Entity.GetComponent<DerivedStatsComponent>().FinalMaxHealth;
    }
}

// æ–¹å¼2ï¼šç›´æ¥åˆ é™¤HealthComponentï¼Œå…¨é¢ä½¿ç”¨æ–°ç³»ç»Ÿ
```

### 15.2 DamageCalculatoré›†æˆ

**æ›¿æ¢ç°æœ‰çš„å†™æ­»æ•°å€¼**ï¼š
```csharp
// æ—§ä»£ç ï¼ˆå†™æ­»ï¼‰
private static float GetEntityAttack(Entity entity)
{
    return 100f; // TODO
}

// æ–°ä»£ç ï¼ˆä»å±æ€§ç³»ç»Ÿè¯»å–ï¼‰
private static float GetEntityAttack(Entity entity)
{
    var derivedStats = entity.GetComponent<DerivedStatsComponent>();
    return derivedStats?.FinalAttack ?? 0f;
}
```

### 15.3 EntityFactoryé›†æˆ

**åˆ›å»ºEntityæ—¶è‡ªåŠ¨æ·»åŠ ç»„ä»¶**ï¼š
```csharp
public static Entity CreateRole(int roleId, int level = 1)
{
    var entity = new Entity();
    
    // æ·»åŠ æ‰€æœ‰æ•°å€¼ç»„ä»¶
    var baseStats = entity.AddComponent<BaseStatsComponent>();
    baseStats.InitializeFromConfig(roleId, level);
    
    var derivedStats = entity.AddComponent<DerivedStatsComponent>();
    derivedStats.RecalculateAll(baseStats);
    
    var dynamicStats = entity.AddComponent<DynamicStatsComponent>();
    dynamicStats.CurrentHealth = derivedStats.FinalMaxHealth;
    dynamicStats.CurrentMana = derivedStats.FinalMaxMana;
    
    entity.AddComponent<BuffComponent>();
    entity.AddComponent<StateComponent>();
    
    var levelComp = entity.AddComponent<LevelComponent>();
    levelComp.CurrentLevel = level;
    
    var growthComp = entity.AddComponent<GrowthComponent>();
    growthComp.RoleId = roleId;
    
    // ... å…¶ä»–ç»„ä»¶
    
    return entity;
}
```

---

## åå…­ã€å¼€å‘ä¼˜å…ˆçº§

### P0ï¼ˆæ ¸å¿ƒåŸºç¡€ï¼‰
1. âœ… BaseStatsComponent
2. âœ… DerivedStatsComponent
3. âœ… DynamicStatsComponent
4. âœ… é‡æ„ DamageCalculator
5. âœ… æ‰©å±• RoleBaseTable

### P1ï¼ˆé‡è¦åŠŸèƒ½ï¼‰
6. âœ… BuffComponent
7. âœ… StateComponent
8. âœ… åˆ›å»º BuffTable
9. âœ… Buffä¿®é¥°å™¨è®¡ç®—

### P2ï¼ˆå®Œå–„ç³»ç»Ÿï¼‰
10. âœ… LevelComponent
11. âœ… GrowthComponent
12. âœ… å‡çº§é€»è¾‘
13. âœ… è‡ªç”±åŠ ç‚¹

---

## åä¸ƒã€éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] è§’è‰²å±æ€§æ­£ç¡®è¯»å–é…ç½®è¡¨
- [ ] BuffåŠ æˆæ­£ç¡®å½±å“æœ€ç»ˆå±æ€§
- [ ] ä¼¤å®³è®¡ç®—ä½¿ç”¨çœŸå®å±æ€§ï¼ˆä¸å†å†™æ­»ï¼‰
- [ ] æš´å‡»ã€æ ¼æŒ¡ã€é—ªé¿åˆ¤å®šç”Ÿæ•ˆ
- [ ] ç­‰çº§æˆé•¿æ­£ç¡®åº”ç”¨
- [ ] Buffå åŠ å’Œè¿‡æœŸæ­£ç¡®å¤„ç†

### æ€§èƒ½éªŒæ”¶
- [ ] å±æ€§è®¡ç®—è€—æ—¶ < 0.1ms
- [ ] Buffæ›´æ–°è€—æ—¶ < 0.05ms
- [ ] æ”¯æŒ100+ EntityåŒæ—¶è¿è¡Œ

### æµ‹è¯•éªŒæ”¶
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ•°å€¼å¹³è¡¡æµ‹è¯•é€šè¿‡

---

## é™„å½•ï¼šæ•°æ®æµè½¬ç¤ºä¾‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°å€¼ç³»ç»Ÿå®Œæ•´æµè½¬ç¤ºä¾‹                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é…ç½®è¡¨
â”œâ”€ RoleBaseTable(1001) â†’ ATK=80, DEF=80, HP=1000
â”œâ”€ RoleGrowthTable(Lv5) â†’ AttackBonus=8/çº§
â””â”€ BuffTable(5001) â†’ ATK +20%

    â†“ InitializeFromConfig()
    
BaseStatsComponent
â”œâ”€ BaseStats.Get(StatType.ATK) = 80 + 8Ã—4 = 112ï¼ˆåŸºç¡€+æˆé•¿ï¼‰
â”œâ”€ BaseStats.Get(StatType.DEF) = 80 + 8Ã—4 = 112
â””â”€ BaseStats.Get(StatType.HP) = 1000 + 100Ã—4 = 1400

    â†“ AddBuff(5001) â†’ æ”¶é›†ä¿®é¥°å™¨
    
DerivedStatsComponent ä¿®é¥°å™¨
â””â”€ ATK: [Buff 5001: Percent +0.2]

    â†“ RecalculateAll()
    
DerivedStatsComponent
â”œâ”€ FinalStats.Get(StatType.ATK) = 112 Ã— 1.2 = 134.4
â”œâ”€ FinalStats.Get(StatType.DEF) = 112
â””â”€ FinalStats.Get(StatType.HP) = 1400

    â†“ InitializeResources()
    
DynamicStatsComponent
â”œâ”€ CurrentHealth = 1400ï¼ˆæ»¡è¡€ï¼‰
â”œâ”€ CurrentMana = 100
â””â”€ Energy = 0

    â†“ æˆ˜æ–—ä¸­...
    
å—åˆ°150%æ”»å‡»åŠ›çš„æŠ€èƒ½ä¼¤å®³
    â†“ DamageCalculator.Calculate()
    
åŸºç¡€ä¼¤å®³ = æ•Œæ–¹ATK(100) Ã— 1.5 = 150
    â†“ é˜²å¾¡å‡å…
    
å‡ä¼¤å = 150 Ã— (1 - 112/212) = 70.8
    â†“ DynamicStats.TakeDamage()
    
CurrentHealth = 1400 - 70.8 = 1329.2
```

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-14  
**ä½œè€…**: Astrumå¼€å‘å›¢é˜Ÿ  
**çŠ¶æ€**: ğŸ“ è®¾è®¡å®Œæˆï¼Œå¾…å®ç°


