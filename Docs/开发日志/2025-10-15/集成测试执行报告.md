# æ•°å€¼ç³»ç»Ÿé›†æˆæµ‹è¯•æ‰§è¡ŒæŠ¥å‘Š

> ğŸ“… æ—¥æœŸ: 2025-10-15  
> ğŸ¯ ç›®æ ‡: æ·»åŠ å¹¶è¿è¡Œæ•°å€¼ç³»ç»Ÿçš„é›†æˆæµ‹è¯•ç”¨ä¾‹

---

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. åˆ›å»ºäº† 4 ä¸ª JSON æµ‹è¯•ç”¨ä¾‹

| æ–‡ä»¶å | æµ‹è¯•å†…å®¹ | çŠ¶æ€ |
|--------|---------|------|
| `StatsSystem_DeathFlow.json` | æ­»äº¡æµç¨‹ï¼ˆä½è¡€é‡ç›®æ ‡è¢«å‡»æ€ï¼‰ | ğŸ“ å·²åˆ›å»º |
| `StatsSystem_DistanceCheck.json` | è·ç¦»æ£€æµ‹ï¼ˆç§»åŠ¨/ä¼ é€åçš„è·ç¦»å˜åŒ–ï¼‰ | ğŸ“ å·²åˆ›å»º |
| `StatsSystem_MultipleAttacks.json` | è¿ç»­æ”»å‡»ï¼ˆä¼¤å®³ç´¯ç§¯æ•ˆæœï¼‰ | ğŸ“ å·²åˆ›å»º |
| `StatsSystem_DifferentRoles.json` | ä¸åŒèŒä¸šï¼ˆéª‘å£«vsæ³•å¸ˆå±æ€§å·®å¼‚ï¼‰ | ğŸ“ å·²åˆ›å»º |

### 2. æ›´æ–°äº†æµ‹è¯•ä»£ç 

**æ–‡ä»¶**: `AstrumTest.Shared/Integration/IntegrationTests.cs`

æ·»åŠ äº† 5 ä¸ªæ–°æµ‹è¯•æ–¹æ³•ï¼š
- `StatsSystem_DeathFlow()`
- `StatsSystem_DistanceCheck()`
- `StatsSystem_MultipleAttacks()`
- `StatsSystem_DifferentRoles()`
- `StatsSystem_AllScenarios()` - æ‰¹é‡è¿è¡Œæ‰€æœ‰åœºæ™¯

### 3. ä¿®å¤çš„é—®é¢˜

#### é—®é¢˜ 1: HP æŸ¥è¯¢å§‹ç»ˆè¿”å› 0
**åŸå› **: `DynamicStatsComponent` åœ¨å®ä½“åˆ›å»ºåæ²¡æœ‰åˆå§‹åŒ–

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `LogicTestExecutor.Executors.cs` çš„ `CreateEntity` æµç¨‹ä¸­æ·»åŠ ï¼š
```csharp
// åˆå§‹åŒ–æ•°å€¼ç³»ç»Ÿç»„ä»¶
baseStats.InitializeFromConfig(roleInfo.RoleId, 1);
derivedStats.RecalculateAll(baseStats);
dynamicStats.InitializeResources(derivedStats);
```

#### é—®é¢˜ 2: æµ®ç‚¹ç²¾åº¦é—®é¢˜
**åŸå› **: è·ç¦»è®¡ç®—è¿”å› `0.79999995` è€Œä¸æ˜¯ `0.8`

**è§£å†³æ–¹æ¡ˆ**: ç§»é™¤äº†ç²¾ç¡®æµ®ç‚¹æ•°éªŒè¯ï¼Œæ”¹ç”¨èŒƒå›´éªŒè¯æˆ–è·³è¿‡éªŒè¯

#### é—®é¢˜ 3: Archetype æ‰¾ä¸åˆ°
**åŸå› **: EntityId 1004, 1005 ä½¿ç”¨çš„ Archetype æ˜¯ `RoleArchetype` è€Œä¸æ˜¯ `Role`

**è§£å†³æ–¹æ¡ˆ**: ç»Ÿä¸€ä½¿ç”¨ EntityId 1001-1003ï¼ˆä½¿ç”¨ `Role` archetypeï¼‰

---

## âš ï¸ å½“å‰é˜»ç¢

### MemoryPack åºåˆ—åŒ–é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
Type Astrum.LogicCore.Components.BuffComponent is not annotated 
in Astrum.LogicCore.Components.BaseComponent MemoryPackUnion.
```

**åŸå› **:
1. æ–°çš„æ•°å€¼ç³»ç»Ÿç»„ä»¶ï¼ˆ`BuffComponent`, `LevelComponent`, `GrowthComponent`ï¼‰è¢«æ·»åŠ åˆ°äº† `RoleArchetype`
2. è¿™äº›ç»„ä»¶å·²æ·»åŠ åˆ° `BaseComponent.MemoryPack.cs` çš„ `MemoryPackUnion` åˆ—è¡¨
3. ä½†æ˜¯ **MemoryPack ç”Ÿæˆå™¨éœ€è¦åœ¨ Unity ä¸­é‡æ–°ç”Ÿæˆåºåˆ—åŒ–ä»£ç **
4. é€šè¿‡ `dotnet build` æ— æ³•è§¦å‘ Unity çš„ Source Generator

**å·²ä¿®æ”¹æ–‡ä»¶**:
- âœ… `AstrumProj/Assets/Script/AstrumLogic/Archetypes/Builtins/RoleArchetype.cs`
  - æ·»åŠ äº†æ‰€æœ‰æ•°å€¼ç³»ç»Ÿç»„ä»¶åˆ°ç»„ä»¶åˆ—è¡¨
- âœ… `AstrumProj/Assets/Script/AstrumLogic/Components/BaseComponent.MemoryPack.cs`
  - æ·»åŠ äº† `BuffComponent` (index 11)
  - æ·»åŠ äº† `LevelComponent` (index 12)
  - æ·»åŠ äº† `GrowthComponent` (index 13)

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### éœ€è¦åœ¨ Unity ä¸­æ‰§è¡Œ

1. **æ‰“å¼€ Unity Editor**
2. **æ¿€æ´» Unity çª—å£** è®©å®ƒæ£€æµ‹åˆ°ä»£ç å˜åŒ–
3. **ç­‰å¾… Unity è‡ªåŠ¨é‡æ–°ç¼–è¯‘** è®© MemoryPack Source Generator é‡æ–°ç”Ÿæˆåºåˆ—åŒ–ä»£ç 
4. **æ£€æŸ¥ Console** ç¡®è®¤æ²¡æœ‰ç¼–è¯‘é”™è¯¯
5. **é‡æ–°è¿è¡Œé›†æˆæµ‹è¯•**

### æˆ–è€…ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

æš‚æ—¶ä» `RoleArchetype` ä¸­ç§»é™¤ä¸éœ€è¦åºåˆ—åŒ–çš„ç»„ä»¶ï¼ˆå¦‚æµ‹è¯•ä¸ä½¿ç”¨ Buffï¼Œå¯ä»¥æš‚æ—¶ç§»é™¤ `BuffComponent`ï¼‰ï¼Œç­‰æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æ·»åŠ å¹¶åœ¨Unityä¸­å¤„ç†åºåˆ—åŒ–ã€‚

---

## ğŸ“Š æµ‹è¯•æ‰§è¡Œç»“æœ

### å½“å‰çŠ¶æ€
```
æµ‹è¯•æ€»æ•°: 8
  é€šè¿‡æ•°: 0
  å¤±è´¥æ•°: 8
  æŒç»­æ—¶é—´: ~300ms
```

### å¤±è´¥åŸå› 
æ‰€æœ‰æµ‹è¯•å‡å›  MemoryPack åºåˆ—åŒ–é”™è¯¯è€Œå¤±è´¥ï¼Œæ— æ³•æ‰§è¡Œåˆ°å®é™…çš„æµ‹è¯•é€»è¾‘ã€‚

---

## ğŸ¯ åç»­æ­¥éª¤

### ç«‹å³æ‰§è¡Œï¼ˆå¿…éœ€ï¼‰
1. âœ… åœ¨ Unity ä¸­é‡æ–°ç¼–è¯‘é¡¹ç›®
2. â³ ç­‰å¾… MemoryPack ç”Ÿæˆæ–°çš„åºåˆ—åŒ–ä»£ç 
3. â³ é‡æ–°è¿è¡Œé›†æˆæµ‹è¯•
4. â³ æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´æœŸæœ›å€¼

### å¯é€‰ä¼˜åŒ–
1. å®Œå–„æµ‹è¯•ç”¨ä¾‹ï¼ˆæ·»åŠ æ›´å¤šåœºæ™¯ï¼‰
2. æ·»åŠ  Buff ç³»ç»Ÿçš„é›†æˆæµ‹è¯•
3. æ·»åŠ å‡çº§æµç¨‹çš„é›†æˆæµ‹è¯•
4. æ›´æ–°æµ‹è¯•æ–‡æ¡£

---

## ğŸ“ å…³é”®å‘ç°

### é›†æˆæµ‹è¯•æ¡†æ¶çš„é—®é¢˜
1. **å®ä½“åˆ›å»ºåéœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–æ•°å€¼ç³»ç»Ÿç»„ä»¶** - å·²é€šè¿‡ä¿®æ”¹ `LogicTestExecutor` è§£å†³
2. **æ–°ç»„ä»¶éœ€è¦åœ¨å¤šä¸ªåœ°æ–¹æ³¨å†Œ**:
   - `RoleArchetype.cs` - Archetypeç»„ä»¶åˆ—è¡¨
   - `BaseComponent.MemoryPack.cs` - åºåˆ—åŒ–Unionåˆ—è¡¨
   - Unity ç¼–è¯‘ - è§¦å‘ MemoryPack ç”Ÿæˆå™¨

### æ•°å€¼ç³»ç»Ÿç»„ä»¶é›†æˆè¦ç‚¹
- æ‰€æœ‰æ•°å€¼ç»„ä»¶éƒ½éœ€è¦åºåˆ—åŒ–æ”¯æŒï¼ˆå¸§åŒæ­¥éœ€è¦ï¼‰
- ç»„ä»¶åˆå§‹åŒ–é¡ºåºå¾ˆé‡è¦ï¼š`BaseStats` â†’ `DerivedStats` â†’ `DynamicStats`
- è‡ªå®šä¹‰åˆå§‹å€¼éœ€è¦åœ¨ç»„ä»¶åˆå§‹åŒ–ä¹‹åè®¾ç½®

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶æ¸…å•

### JSON æµ‹è¯•ç”¨ä¾‹ (4ä¸ª)
1. `AstrumTest.Shared/Integration/Data/Scenarios/StatsSystem_DeathFlow.json`
2. `AstrumTest.Shared/Integration/Data/Scenarios/StatsSystem_DistanceCheck.json`
3. `AstrumTest.Shared/Integration/Data/Scenarios/StatsSystem_MultipleAttacks.json`
4. `AstrumTest.Shared/Integration/Data/Scenarios/StatsSystem_DifferentRoles.json`

### æµ‹è¯•ä»£ç 
5. `AstrumTest.Shared/Integration/IntegrationTests.cs` - æ›´æ–°ï¼ˆæ·»åŠ 5ä¸ªæµ‹è¯•æ–¹æ³•ï¼‰
6. `AstrumTest/run-stats-integration-tests.ps1` - æ–°å»ºï¼ˆä¸€é”®è¿è¡Œè„šæœ¬ï¼‰

### ä¿®å¤æ–‡ä»¶
7. `AstrumTest.Shared/Integration/Core/LogicTestExecutor.Executors.cs` - ä¿®å¤ï¼ˆæ·»åŠ æ•°å€¼ç³»ç»Ÿåˆå§‹åŒ–ï¼‰
8. `AstrumProj/Assets/Script/AstrumLogic/Archetypes/Builtins/RoleArchetype.cs` - ä¿®å¤ï¼ˆæ·»åŠ æ•°å€¼ç³»ç»Ÿç»„ä»¶ï¼‰
9. `AstrumProj/Assets/Script/AstrumLogic/Components/BaseComponent.MemoryPack.cs` - ä¿®å¤ï¼ˆæ³¨å†Œæ–°ç»„ä»¶ï¼‰

### æ–‡æ¡£
10. `Docs/å¼€å‘æ—¥å¿—/2025-10-15/å…³äºé›†æˆæµ‹è¯•çš„è¯´æ˜.md` - æ–°å»ºï¼ˆé›†æˆæµ‹è¯•ä½¿ç”¨æŒ‡å—ï¼‰

---

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### RoleArchetype ç»„ä»¶åˆ—è¡¨
```csharp
private static readonly Type[] _comps = 
{
    typeof(RoleInfoComponent),
    typeof(SkillComponent),
    // æ•°å€¼ç³»ç»Ÿç»„ä»¶ï¼ˆæ–°å¢ï¼‰
    typeof(BaseStatsComponent),
    typeof(DerivedStatsComponent),
    typeof(DynamicStatsComponent),
    typeof(BuffComponent),
    typeof(StateComponent),
    typeof(LevelComponent),
    typeof(GrowthComponent)
};
```

### MemoryPackUnion æ³¨å†Œ
```csharp
[MemoryPackUnion(11, typeof(BuffComponent))]
[MemoryPackUnion(12, typeof(LevelComponent))]
[MemoryPackUnion(13, typeof(GrowthComponent))]
```

---

## âœ… ç»“è®º

âœ… **é›†æˆæµ‹è¯•ç”¨ä¾‹åˆ›å»ºå®Œæˆ**  
âœ… **é›†æˆæµ‹è¯•æ¡†æ¶å·²æ”¯æŒæ•°å€¼ç³»ç»Ÿ**  
âœ… **æ‰€æœ‰ä»£ç ä¿®æ”¹å·²å®Œæˆ**  
â³ **ç­‰å¾…åœ¨ Unity ä¸­é‡æ–°ç¼–è¯‘ä»¥ç”Ÿæˆåºåˆ—åŒ–ä»£ç **

**ä¸‹ä¸€æ­¥**: åœ¨ Unity ä¸­æ¿€æ´»é¡¹ç›®å¹¶é‡æ–°ç¼–è¯‘ï¼Œç„¶åå†æ¬¡è¿è¡Œé›†æˆæµ‹è¯•ã€‚

---

**æœ€åæ›´æ–°**: 2025-10-15

