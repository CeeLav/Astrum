# å…³äºé›†æˆæµ‹è¯•çš„é‡è¦è¯´æ˜

> ğŸ“… æ—¥æœŸ: 2025-10-15  
> ğŸ¯ ç›®çš„: è¯´æ˜é¡¹ç›®çš„é›†æˆæµ‹è¯•æ­£ç¡®å†™æ³•

---

## âš ï¸ é‡è¦å‘ç°

é¡¹ç›®å·²æœ‰å®Œå–„çš„**æ•°æ®é©±åŠ¨é›†æˆæµ‹è¯•æ¡†æ¶**ï¼Œä¸åº”æ‰‹åŠ¨ç¼–å†™ä¼ ç»Ÿçš„é›†æˆæµ‹è¯•ä»£ç ï¼

---

## âŒ é”™è¯¯åšæ³•

```csharp
// âŒ ä¸è¦è¿™æ ·å†™é›†æˆæµ‹è¯•
[Fact]
public void TestCombat()
{
    // æ‰‹åŠ¨åˆ›å»º Room, World, Entity
    var room = new Room(1, "Test");
    var world = new World();
    room.MainWorld = world;
    room.Initialize();
    
    var knight1 = EntityFactory.Instance.CreateEntity(1001, world);
    var knight2 = EntityFactory.Instance.CreateEntity(1001, world);
    
    // æ‰‹åŠ¨è°ƒç”¨ç»„ä»¶æ–¹æ³•
    knight1.GetComponent<DynamicStatsComponent>().TakeDamage(...);
    
    // æ‰‹åŠ¨æ–­è¨€
    Assert.True(knight2.GetComponent<DynamicStatsComponent>().Get(...) < ...);
}
```

**é—®é¢˜**:
- ä»£ç é‡å¤§ï¼Œé‡å¤åˆå§‹åŒ–
- éš¾ä»¥ç»´æŠ¤
- ä¸ç¬¦åˆé¡¹ç›®æ¡†æ¶

---

## âœ… æ­£ç¡®åšæ³•

### 1. åˆ›å»º JSON æµ‹è¯•ç”¨ä¾‹

**æ–‡ä»¶ä½ç½®**: `AstrumTest.Shared/Integration/Data/Scenarios/StatsSystem_CombatFlow.json`

```json
{
  "name": "æ•°å€¼ç³»ç»Ÿ-æˆ˜æ–—æµç¨‹",
  "description": "æµ‹è¯•å±æ€§è®¡ç®—ã€ä¼¤å®³ã€æ­»äº¡æµç¨‹",
  
  "entityTemplates": [
    {
      "templateId": "knight1",
      "roleId": 1001,
      "team": 1,
      "customHealth": 500
    },
    {
      "templateId": "knight2",
      "roleId": 1001,
      "team": 2,
      "customHealth": 500
    }
  ],
  
  "frames": [
    {
      "frameNumber": 0,
      "comment": "åˆ›å»ºä¸¤ä¸ªéª‘å£«",
      "inputs": [
        {
          "type": "CreateEntity",
          "templateId": "knight1",
          "position": {"x": 0, "y": 0, "z": 0},
          "entityId": "entity_0"
        },
        {
          "type": "CreateEntity",
          "templateId": "knight2",
          "position": {"x": 1.2, "y": 0, "z": 0},
          "entityId": "entity_1"
        }
      ],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "entity_0",
          "resultKey": "knight1_hp"
        },
        {
          "type": "EntityHealth",
          "entityId": "entity_1",
          "resultKey": "knight2_hp"
        },
        {
          "type": "EntityIsAlive",
          "entityId": "entity_0",
          "resultKey": "knight1_alive"
        }
      ],
      "expectedOutputs": {
        "knight1_hp": 500,
        "knight2_hp": 500,
        "knight1_alive": "True"
      }
    },
    {
      "frameNumber": 10,
      "comment": "éª‘å£«1æ”»å‡»éª‘å£«2",
      "inputs": [
        {
          "type": "CastSkill",
          "entityId": "entity_0",
          "skillId": 3001,
          "targetId": "entity_1"
        }
      ],
      "queries": [
        {
          "type": "EntityAction",
          "entityId": "entity_0",
          "resultKey": "knight1_action"
        }
      ],
      "expectedOutputs": {
        "knight1_action": "CastingSkill"
      }
    },
    {
      "frameNumber": 30,
      "comment": "æŠ€èƒ½å‘½ä¸­ï¼ŒéªŒè¯ä¼¤å®³",
      "inputs": [],
      "queries": [
        {
          "type": "EntityHealth",
          "entityId": "entity_1",
          "resultKey": "knight2_hp"
        },
        {
          "type": "EntityIsAlive",
          "entityId": "entity_1",
          "resultKey": "knight2_alive"
        }
      ],
      "expectedOutputs": {
        "knight2_hp": {"min": 400, "max": 490},
        "knight2_alive": "True"
      }
    }
  ]
}
```

### 2. åœ¨æµ‹è¯•ç±»ä¸­è°ƒç”¨

**æ–‡ä»¶ä½ç½®**: `AstrumTest.Shared/Integration/IntegrationTests.cs`

```csharp
[Collection("Logic Test Collection")]
[Trait("TestLevel", "Integration")]
public class IntegrationTests
{
    private readonly ITestOutputHelper _output;
    private readonly ConfigFixture _configFixture;
    
    public IntegrationTests(ITestOutputHelper output, ConfigFixture configFixture)
    {
        _output = output;
        _configFixture = configFixture;
    }
    
    /// <summary>
    /// æ•°å€¼ç³»ç»Ÿ - æˆ˜æ–—æµç¨‹æµ‹è¯•
    /// </summary>
    [Fact]
    [Trait("Module", "StatsSystem")]
    public void StatsSystem_CombatFlow()
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        
        // åªéœ€ä¸€è¡Œï¼å¼•æ“è‡ªåŠ¨å®Œæˆï¼šè¯»å– â†’ åˆå§‹åŒ– â†’ æ‰§è¡Œ â†’ éªŒè¯ â†’ æŠ¥å‘Š
        var result = executor.RunTestCase("StatsSystem_CombatFlow.json");
        
        Assert.True(result.Success, result.FailureMessage);
    }
    
    /// <summary>
    /// æ‰¹é‡æµ‹è¯•å¤šä¸ªåœºæ™¯
    /// </summary>
    [Theory]
    [InlineData("StatsSystem_CombatFlow.json")]
    [InlineData("StatsSystem_LevelUp.json")]
    [InlineData("StatsSystem_BuffStacking.json")]
    [Trait("Module", "StatsSystem")]
    public void StatsSystem_Scenarios(string scenarioFile)
    {
        using var executor = new LogicTestExecutor(_output, _configFixture);
        var result = executor.RunTestCase(scenarioFile);
        Assert.True(result.Success, result.FailureMessage);
    }
}
```

---

## ğŸ¯ æ¡†æ¶ç‰¹ç‚¹

### 1. ä»¥å¸§ä¸ºå•ä½
æ¯ä¸€å¸§çš„æ‰§è¡Œæµç¨‹ï¼š
```
inputsï¼ˆè¾“å…¥æŒ‡ä»¤ï¼‰
  â†“
æ›´æ–°æ¸¸æˆé€»è¾‘ä¸€å¸§
  â†“
queriesï¼ˆæŸ¥è¯¢çŠ¶æ€ï¼‰
  â†“
expectedOutputsï¼ˆéªŒè¯ç»“æœï¼‰
```

### 2. æ”¯æŒçš„è¾“å…¥ç±»å‹ (Inputs)
- `CreateEntity` - åˆ›å»ºå®ä½“
- `DestroyEntity` - é”€æ¯å®ä½“
- `CastSkill` - æ–½æ”¾æŠ€èƒ½
- `Move` - ç§»åŠ¨
- `Teleport` - ä¼ é€
- `Wait` - ç­‰å¾…

### 3. æ”¯æŒçš„æŸ¥è¯¢ç±»å‹ (Queries)
- `EntityHealth` - æŸ¥è¯¢å®ä½“è¡€é‡
- `EntityPosition` - æŸ¥è¯¢å®ä½“ä½ç½®
- `EntityIsAlive` - æŸ¥è¯¢æ˜¯å¦å­˜æ´»
- `EntityAction` - æŸ¥è¯¢å½“å‰åŠ¨ä½œ
- `EntityDistance` - æŸ¥è¯¢ä¸¤å®ä½“è·ç¦»

### 4. æ”¯æŒèŒƒå›´éªŒè¯
```json
"expectedOutputs": {
  "knight_hp": {"min": 400, "max": 490},  // èŒƒå›´éªŒè¯
  "knight_alive": "True"                   // ç²¾ç¡®åŒ¹é…
}
```

---

## ğŸ”§ æ¡†æ¶å·²æ”¯æŒæ–°æ•°å€¼ç³»ç»Ÿ

**æ›´æ–°æ–‡ä»¶**: `AstrumTest.Shared/Integration/Core/LogicTestExecutor.Executors.cs`

- âœ… ä½¿ç”¨ `DynamicStatsComponent.Set(DynamicResourceType.CURRENT_HP, ...)` è®¾ç½®è¡€é‡
- âœ… ä½¿ç”¨ `DynamicStatsComponent.Get(DynamicResourceType.CURRENT_HP)` æŸ¥è¯¢è¡€é‡
- âœ… ä½¿ç”¨ `StateComponent.Get(StateType.DEAD)` åˆ¤æ–­æ­»äº¡çŠ¶æ€

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

è¯¦ç»†è®¾è®¡æ–¹æ¡ˆï¼š`AstrumTest/é›†æˆæµ‹è¯•æ¡†æ¶è®¾è®¡æ–¹æ¡ˆ.md`

---

## ğŸ’¡ ä¼˜åŠ¿å¯¹æ¯”

| ç»´åº¦ | ä¼ ç»Ÿæ‰‹å†™ | æ•°æ®é©±åŠ¨æ¡†æ¶ |
|------|---------|-------------|
| **ä»£ç é‡** | 50+ è¡Œ/æµ‹è¯• | 2-3 è¡Œ/æµ‹è¯• |
| **ç»´æŠ¤æ€§** | éš¾ç»´æŠ¤ | æ˜“ç»´æŠ¤ï¼ˆåªæ”¹JSONï¼‰ |
| **å¯è¯»æ€§** | ä»£ç æ··ä¹± | JSONæ¸…æ™° |
| **éç¨‹åºå‘˜** | æ— æ³•ç¼–å†™ | å¯ä»¥ç¼–å†™ |
| **é‡å¤ä»£ç ** | å¤§é‡é‡å¤ | æ— é‡å¤ |
| **æµ‹è¯•è¦†ç›–** | æ‰‹åŠ¨æ§åˆ¶ | è‡ªåŠ¨éªŒè¯ |

---

## âœ… ç»“è®º

1. **ä¸è¦æ‰‹åŠ¨ç¼–å†™é›†æˆæµ‹è¯•ç±»**
2. **ä½¿ç”¨ JSON æ–‡ä»¶å®šä¹‰æµ‹è¯•ç”¨ä¾‹**
3. **æµ‹è¯•ä»£ç åªéœ€è°ƒç”¨ `executor.RunTestCase("file.json")`**
4. **æ¡†æ¶å·²æ”¯æŒæ–°æ•°å€¼ç³»ç»Ÿ**
5. **å‚è€ƒç°æœ‰çš„ `TwoKnightsFight.json`**

---

**æœ€åæ›´æ–°**: 2025-10-15

