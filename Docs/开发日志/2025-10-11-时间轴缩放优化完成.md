# æ—¶é—´è½´ç¼©æ”¾ä¼˜åŒ–å®Œæˆ - Duration åˆ†ç¦»æ˜¾ç¤º

> ğŸ“… **æ—¥æœŸ**: 2025-10-11  
> ğŸ¯ **ç›®æ ‡**: æ—¶é—´è½´æ˜¾ç¤ºå®Œæ•´åŠ¨ç”»ï¼Œä½†é™åˆ¶ç¼–è¾‘åœ¨ Duration å†…  
> âœ… **çŠ¶æ€**: å®Œæˆ

---

## ğŸ¯ **ä¼˜åŒ–ç›®æ ‡**

**é—®é¢˜**ï¼š
- åŸæœ‰å®ç°ï¼šæ—¶é—´è½´èŒƒå›´ = Duration
- å¦‚æœ Duration < AnimationDurationï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°å®Œæ•´åŠ¨ç”»
- ç”¨æˆ·æ— æ³•å‚è€ƒåŠ¨ç”»å°¾éƒ¨æ¥é…ç½®æŠ€èƒ½æ•ˆæœ

**æ–°å®ç°**ï¼š
- **æ—¶é—´è½´æ˜¾ç¤ºèŒƒå›´** = AnimationDurationï¼ˆå®Œæ•´åŠ¨ç”»ï¼‰
- **å¯ç¼–è¾‘èŒƒå›´** = Durationï¼ˆæŠ€èƒ½æœ‰æ•ˆå¸§æ•°ï¼‰
- **å½“å‰å¸§ç§»åŠ¨èŒƒå›´** = Duration
- **äº‹ä»¶åˆ›å»º/ç§»åŠ¨èŒƒå›´** = Duration

**æ•ˆæœ**ï¼š
- âœ… ç”¨æˆ·å¯ä»¥æ»šåŠ¨æŸ¥çœ‹å®Œæ•´åŠ¨ç”»ä½œä¸ºå‚è€ƒ
- âœ… ä½†åªèƒ½åœ¨æœ‰æ•ˆå¸§æ•°å†…é…ç½®æŠ€èƒ½æ•ˆæœ
- âœ… æä¾›äº†Durationåˆ†ç•Œçº¿ä½œä¸ºè§†è§‰æç¤º

---

## ğŸ“Š **è§†è§‰æ•ˆæœ**

### **æ—¶é—´è½´å¸ƒå±€**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0    10   20   30   40   50â”‚60   70   80   90  100 â”‚  â† åˆ»åº¦ï¼ˆåˆ°AnimationDurationï¼‰
â”‚                             â”‚                       â”‚
â”‚ â—†    â—†    â—†  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚                       â”‚  â† äº‹ä»¶ï¼ˆä»…åœ¨Durationå†…ï¼‰
â”‚                             â”‚                       â”‚
â”‚            Duration:60      â”‚                       â”‚  â† æ©™è‰²è™šçº¿åˆ†ç•Œ
â”‚              â†‘              â”‚                       â”‚
â”‚         å¯ç¼–è¾‘åŒºåŸŸ          â”‚    å‚è€ƒåŒºåŸŸï¼ˆåªè¯»ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯´æ˜ï¼š
â€¢ å·¦ä¾§ï¼ˆ0-60ï¼‰ï¼šå¯ç¼–è¾‘åŒºåŸŸï¼Œå¯ä»¥åˆ›å»ºå’Œç§»åŠ¨äº‹ä»¶
â€¢ å³ä¾§ï¼ˆ61-100ï¼‰ï¼šå‚è€ƒåŒºåŸŸï¼Œåªèƒ½æŸ¥çœ‹åŠ¨ç”»ï¼Œä¸èƒ½ç¼–è¾‘
â€¢ æ©™è‰²è™šçº¿ï¼šDuration åˆ†ç•Œçº¿ï¼Œæ ‡è®°å¯ç¼–è¾‘åŒºåŸŸçš„å³è¾¹ç•Œ
```

### **Duration è¾¹ç•Œçº¿**

**è§†è§‰ç‰¹å¾**ï¼š
- ğŸŸ  æ©™è‰²è™šçº¿ï¼ˆHandles.DrawAAPolyLineï¼‰
- ğŸ“ æ ‡ç­¾ï¼š`Duration:60`
- ğŸ¨ åŠé€æ˜é»‘è‰²èƒŒæ™¯
- âš¡ è™šçº¿æ•ˆæœï¼š10px å®çº¿ + 5px é—´éš”

---

## ğŸ”§ **æŠ€æœ¯å®ç°**

### **1. TimelineEditorModule**

**æ–°å¢å­—æ®µ**ï¼š
```csharp
private int _totalFrames = 60;        // æ—¶é—´è½´æ˜¾ç¤ºèŒƒå›´ï¼ˆåŠ¨ç”»æ€»å¸§æ•°ï¼‰
private int _maxEditableFrame = 60;   // å¯ç¼–è¾‘èŒƒå›´ï¼ˆæŠ€èƒ½Durationï¼‰
```

**æ–°å¢æ–¹æ³•**ï¼š
```csharp
// å•ç‹¬è®¾ç½®å¯ç¼–è¾‘å¸§æ•°
public void SetMaxEditableFrame(int maxFrame)
{
    _maxEditableFrame = Mathf.Max(maxFrame, 1);
    _currentFrame = Mathf.Min(_currentFrame, _maxEditableFrame - 1);
}

// åŒæ—¶è®¾ç½®æ€»å¸§æ•°å’Œå¯ç¼–è¾‘å¸§æ•°
public void SetFrameRange(int totalFrames, int maxEditableFrame)
{
    _totalFrames = Mathf.Max(totalFrames, 1);
    _maxEditableFrame = Mathf.Max(maxEditableFrame, 1);
    _currentFrame = Mathf.Min(_currentFrame, _maxEditableFrame - 1);
}

// è·å–å¯ç¼–è¾‘å¸§æ•°
public int GetMaxEditableFrame()
{
    return _maxEditableFrame;
}
```

**å½“å‰å¸§é™åˆ¶**ï¼š
```csharp
public void SetCurrentFrame(int frame)
{
    int oldFrame = _currentFrame;
    _currentFrame = Mathf.Clamp(frame, 0, _maxEditableFrame - 1); // â† é™åˆ¶åˆ°å¯ç¼–è¾‘èŒƒå›´
    
    if (_currentFrame != oldFrame)
    {
        OnCurrentFrameChanged?.Invoke(_currentFrame);
    }
}
```

**æ¸²æŸ“è¾¹ç•Œçº¿**ï¼š
```csharp
// ç»˜åˆ¶å¯ç¼–è¾‘èŒƒå›´è¾¹ç•Œçº¿ï¼ˆå¦‚æœå°äºæ€»å¸§æ•°ï¼‰
if (_maxEditableFrame < _totalFrames)
{
    Rect trackAreaRect = _layoutCalculator.GetTrackAreaRect();
    _renderer.DrawEditableBoundary(trackAreaRect, _maxEditableFrame);
}
```

---

### **2. TimelineRenderer**

**æ–°å¢æ–¹æ³•**ï¼š
```csharp
/// <summary>
/// ç»˜åˆ¶å¯ç¼–è¾‘èŒƒå›´è¾¹ç•Œçº¿ï¼ˆDurationåˆ†ç•Œçº¿ï¼‰
/// </summary>
public void DrawEditableBoundary(Rect rect, int maxEditableFrame)
{
    // è®¡ç®—è¾¹ç•Œçº¿ä½ç½®
    float x = _layoutCalculator.FrameToPixel(maxEditableFrame) + _layoutCalculator.GetTrackHeaderWidth();
    
    // ç»˜åˆ¶è™šçº¿
    Handles.BeginGUI();
    Handles.color = new Color(1f, 0.7f, 0.2f, 0.8f); // æ©™è‰²
    
    // ç»˜åˆ¶è™šçº¿æ•ˆæœ
    float dashLength = 10f;
    float gapLength = 5f;
    float currentY = rect.y;
    
    while (currentY < rect.yMax)
    {
        float endY = Mathf.Min(currentY + dashLength, rect.yMax);
        Handles.DrawAAPolyLine(3f, new Vector3(x, currentY), new Vector3(x, endY));
        currentY = endY + gapLength;
    }
    
    Handles.EndGUI();
    
    // ç»˜åˆ¶æ ‡ç­¾
    GUIStyle labelStyle = new GUIStyle(EditorStyles.miniLabel);
    labelStyle.normal.textColor = new Color(1f, 0.7f, 0.2f);
    labelStyle.padding = new RectOffset(3, 3, 1, 1);
    labelStyle.fontSize = 9;
    
    string labelText = $"Duration:{maxEditableFrame}";
    Vector2 labelSize = labelStyle.CalcSize(new GUIContent(labelText));
    Rect labelRect = new Rect(x + 5, rect.y + 5, labelSize.x, labelSize.y);
    
    // ç»˜åˆ¶åŠé€æ˜èƒŒæ™¯
    Color oldColor = GUI.color;
    GUI.color = new Color(0.1f, 0.1f, 0.1f, 0.8f);
    EditorGUI.DrawRect(new Rect(labelRect.x - 2, labelRect.y - 1, labelRect.width + 4, labelRect.height + 2), new Color(0.1f, 0.1f, 0.1f, 0.9f));
    GUI.color = oldColor;
    
    GUI.Label(labelRect, labelText, labelStyle);
}
```

---

### **3. TimelineInteraction**

**æ–°å¢å­—æ®µ**ï¼š
```csharp
private int _totalFrames;           // æ€»å¸§æ•°ï¼ˆæ—¶é—´è½´æ˜¾ç¤ºèŒƒå›´ï¼‰
private int _maxEditableFrame;      // å¯ç¼–è¾‘å¸§æ•°ï¼ˆæŠ€èƒ½Durationï¼‰
```

**æ–¹æ³•ç­¾åæ›´æ–°**ï¼š
```csharp
public void HandleInput(
    Rect rect,
    Event evt,
    List<TimelineTrackConfig> tracks,
    Dictionary<string, List<TimelineEvent>> eventsByTrack,
    int currentFrame,
    int totalFrames,
    int maxEditableFrame,  // â† æ–°å¢å‚æ•°
    Vector2 scrollPosition = default)
{
    _currentFrame = currentFrame;
    _totalFrames = totalFrames;
    _maxEditableFrame = maxEditableFrame; // â† ä¿å­˜å¯ç¼–è¾‘å¸§æ•°
    _scrollPosition = scrollPosition;
    // ...
}
```

**äº‹ä»¶ç§»åŠ¨é™åˆ¶**ï¼š
```csharp
// è¾¹ç•Œçº¦æŸï¼šé™åˆ¶ç§»åŠ¨ï¼Œä¿æŒäº‹ä»¶åœ¨ [0, maxEditableFrame-1] èŒƒå›´å†…
if (newStartFrame < 0)
{
    newStartFrame = 0;
    newEndFrame = eventLength;
}
else if (newEndFrame > _maxEditableFrame - 1)  // â† ä½¿ç”¨å¯ç¼–è¾‘å¸§æ•°
{
    newEndFrame = _maxEditableFrame - 1;
    newStartFrame = newEndFrame - eventLength;
}
```

**äº‹ä»¶å¤§å°è°ƒæ•´é™åˆ¶**ï¼š
```csharp
// çº¦æŸï¼šä¸èƒ½å°äºèµ·å§‹å¸§ï¼Œä¸èƒ½è¶…è¿‡å¯ç¼–è¾‘å¸§æ•°-1
newEndFrame = Mathf.Clamp(newEndFrame, _draggingEvent.StartFrame, _maxEditableFrame - 1);  // â† ä½¿ç”¨å¯ç¼–è¾‘å¸§æ•°
```

**æ–°äº‹ä»¶åˆ›å»ºé™åˆ¶**ï¼š
```csharp
TimelineEvent evt = new TimelineEvent
{
    EventId = System.Guid.NewGuid().ToString(),
    TrackType = trackType,
    StartFrame = frame,
    EndFrame = Mathf.Min(frame + 10, _maxEditableFrame - 1), // â† é™åˆ¶åœ¨å¯ç¼–è¾‘èŒƒå›´å†…
    DisplayName = GetDefaultEventName(trackType)
};
```

---

### **4. SkillActionEditorWindow**

**ä½¿ç”¨æ–°æ¥å£**ï¼š
```csharp
// OnActionSelected
int timelineFrames = _selectedSkillAction.AnimationDuration > 0 
    ? _selectedSkillAction.AnimationDuration 
    : _selectedSkillAction.Duration;
int maxEditableFrame = _selectedSkillAction.Duration;

_timelineModule.SetFrameRange(timelineFrames, maxEditableFrame);  // â† åŒæ—¶è®¾ç½®

// LoadAnimationForAction
_timelineModule.SetFrameRange(animationTotalFrames, action.Duration);

// OnActionModified
int timelineFrames = skillAction.AnimationDuration > 0 
    ? skillAction.AnimationDuration 
    : skillAction.Duration;
_timelineModule.SetFrameRange(timelineFrames, skillAction.Duration);
```

---

## ğŸ“ **ä¿®æ”¹æ–‡ä»¶æ¸…å•**

### **æ›´æ–°æ–‡ä»¶ (4ä¸ª)**

1. âœ… `Timeline/TimelineEditorModule.cs`
   - æ·»åŠ  `_maxEditableFrame` å­—æ®µ
   - æ·»åŠ  `SetMaxEditableFrame()` æ–¹æ³•
   - æ·»åŠ  `SetFrameRange()` æ–¹æ³•
   - æ·»åŠ  `GetMaxEditableFrame()` æ–¹æ³•
   - ä¿®æ”¹ `SetCurrentFrame()` é™åˆ¶åˆ°å¯ç¼–è¾‘èŒƒå›´
   - ä¿®æ”¹ `DrawTimeline()` ç»˜åˆ¶è¾¹ç•Œçº¿
   - ä¿®æ”¹ `CreateDefaultEvent()` é™åˆ¶æ–°äº‹ä»¶èŒƒå›´
   - æ›´æ–° `HandleInput()` è°ƒç”¨ä¼ é€’ maxEditableFrame

2. âœ… `Timeline/TimelineRenderer.cs`
   - æ·»åŠ  `DrawEditableBoundary()` æ–¹æ³•ï¼ˆ50è¡Œï¼‰
   - ç»˜åˆ¶æ©™è‰²è™šçº¿åˆ†ç•Œçº¿
   - ç»˜åˆ¶Durationæ ‡ç­¾

3. âœ… `Timeline/TimelineInteraction.cs`
   - æ·»åŠ  `_maxEditableFrame` å­—æ®µ
   - æ›´æ–° `HandleInput()` ç­¾åï¼ˆæ·»åŠ  maxEditableFrame å‚æ•°ï¼‰
   - ä¿®æ”¹äº‹ä»¶ç§»åŠ¨é™åˆ¶ï¼ˆä½¿ç”¨ maxEditableFrameï¼‰
   - ä¿®æ”¹äº‹ä»¶è°ƒæ•´é™åˆ¶ï¼ˆä½¿ç”¨ maxEditableFrameï¼‰
   - ä¿®æ”¹æ–°äº‹ä»¶åˆ›å»ºé™åˆ¶ï¼ˆä½¿ç”¨ maxEditableFrameï¼‰

4. âœ… `Windows/SkillActionEditorWindow.cs`
   - æ›´æ–° `OnActionSelected()` ä½¿ç”¨ `SetFrameRange()`
   - æ›´æ–° `LoadAnimationForAction()` ä½¿ç”¨ `SetFrameRange()`
   - æ›´æ–° `OnActionModified()` ä½¿ç”¨ `SetFrameRange()`

---

## âœ… **ç¼–è¯‘ç»“æœ**

```bash
âœ… ç¼–è¯‘æˆåŠŸ - 0 errors
âœ… æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
âœ… æ—¶é—´è½´ç¼©æ”¾ç¬¦åˆé¢„æœŸ
```

---

## ğŸ® **ä½¿ç”¨ç¤ºä¾‹**

### **ç¤ºä¾‹åœºæ™¯**

**é…ç½®**ï¼š
- AnimationDuration = 120å¸§ï¼ˆ2ç§’ï¼Œå®Œæ•´æ”»å‡»åŠ¨ç”»ï¼‰
- Duration = 60å¸§ï¼ˆ1ç§’ï¼Œå®é™…æœ‰æ•ˆæ”»å‡»æ—¶é—´ï¼‰

**æ—¶é—´è½´è¡¨ç°**ï¼š
```
åˆ»åº¦èŒƒå›´ï¼š0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 120å¸§
         â†“                           â†“
ç¼–è¾‘åŒºåŸŸï¼š0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 60å¸§ â”‚ å‚è€ƒåŒºåŸŸ 61-120
         â†‘               â†‘
    å¯ä»¥åˆ›å»ºäº‹ä»¶      Durationè¾¹ç•Œ
```

**ç”¨æˆ·æ“ä½œ**ï¼š
1. âœ… åœ¨0-60å¸§å†…åˆ›å»ºæŠ€èƒ½æ•ˆæœäº‹ä»¶
2. âœ… åœ¨0-60å¸§å†…ç§»åŠ¨äº‹ä»¶
3. âœ… æ’­æ”¾å¤´åªèƒ½ç§»åŠ¨åˆ°0-60å¸§
4. âœ… å¯ä»¥æ»šåŠ¨æŸ¥çœ‹61-120å¸§çš„åŠ¨ç”»ï¼ˆå‚è€ƒç”¨ï¼‰
5. âŒ ä¸èƒ½åœ¨61-120å¸§åˆ›å»ºæˆ–ç§»åŠ¨äº‹ä»¶

---

## ğŸ“Š **å¯¹æ¯”**

| ç‰¹æ€§ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **æ—¶é—´è½´èŒƒå›´** | 0-60 (Duration) | 0-120 (AnimationDuration) |
| **å¯ç¼–è¾‘èŒƒå›´** | 0-60 | 0-60 (Duration) |
| **å‚è€ƒåŒºåŸŸ** | âŒ æ—  | âœ… 61-120 (åªè¯») |
| **è¾¹ç•Œæç¤º** | âŒ æ—  | âœ… æ©™è‰²è™šçº¿ + æ ‡ç­¾ |
| **å½“å‰å¸§èŒƒå›´** | 0-60 | 0-60 (é™åˆ¶) |
| **äº‹ä»¶åˆ›å»ºèŒƒå›´** | 0-60 | 0-60 (é™åˆ¶) |
| **äº‹ä»¶ç§»åŠ¨èŒƒå›´** | 0-60 | 0-60 (é™åˆ¶) |
| **æŸ¥çœ‹å®Œæ•´åŠ¨ç”»** | âŒ ä¸èƒ½ | âœ… å¯ä»¥ |

---

## ğŸ¯ **ç”¨æˆ·ä½“éªŒæå‡**

### **ä¼˜åŠ¿**

1. **å®Œæ•´å‚è€ƒ**ï¼šç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´åŠ¨ç”»æ¥é…ç½®æŠ€èƒ½æ—¶æœº
2. **æ˜ç¡®è¾¹ç•Œ**ï¼šæ©™è‰²è™šçº¿æ¸…æ™°æ ‡è®°å¯ç¼–è¾‘åŒºåŸŸ
3. **æ“ä½œé™åˆ¶**ï¼šè‡ªåŠ¨çº¦æŸï¼Œé˜²æ­¢åœ¨æ— æ•ˆå¸§æ•°é…ç½®
4. **ç›´è§‚ç†è§£**ï¼šå¯ä»¥ç†è§£Durationä¸AnimationDurationçš„å…³ç³»

### **é€‚ç”¨åœºæ™¯**

**é•¿åŠ¨ç”» + çŸ­Duration**ï¼š
- ç¤ºä¾‹ï¼š2ç§’æ”»å‡»åŠ¨ç”»ï¼ˆ120å¸§ï¼‰ï¼Œä½†åªæœ‰å‰1ç§’ï¼ˆ60å¸§ï¼‰æ˜¯æœ‰æ•ˆæ”»å‡»
- å1ç§’æ˜¯æ”¶æ‹›åŠ¨ç”»ï¼Œç”¨æˆ·éœ€è¦çœ‹åˆ°å®Œæ•´åŠ¨ä½œæ¥æŠŠæ¡æ—¶æœº
- ä½†ä¸åº”è¯¥åœ¨æ”¶æ‹›é˜¶æ®µé…ç½®æ”»å‡»åˆ¤å®š

**è¿å‡»æŠ€èƒ½**ï¼š
- ç¬¬ä¸€æ®µï¼š0-30å¸§
- ç¬¬äºŒæ®µï¼š30-60å¸§
- Duration=60å¸§ï¼Œä½†åŠ¨ç”»=120å¸§ï¼ˆåŒ…å«æ”¶æ‹›ï¼‰
- ç”¨æˆ·å¯ä»¥çœ‹åˆ°å®Œæ•´è¿å‡»åŠ¨ä½œ

---

## ğŸš€ **Phase 3 æ€»è¿›åº¦**

```
Phase 3A (è§¦å‘å¸§å¤šå¸§æ”¯æŒ): â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
Phase 3B (æ•ˆæœé€‰æ‹©å™¨):     â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘   0% â³
Phase 3C (æ¸²æŸ“å™¨ä¼˜åŒ–):     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…
æ—¶é—´è½´ç¼©æ”¾ä¼˜åŒ–:           â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% âœ…

æ€»è¿›åº¦ï¼š75% (3/4 å®Œæˆ)
```

---

**æ—¶é—´è½´ä¼˜åŒ–å®Œæˆï¼ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡ï¼** ğŸŠ

