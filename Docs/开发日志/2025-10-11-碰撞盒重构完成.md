# 碰撞盒数据结构重构完成

> 📅 **日期**: 2025-10-11  
> 🎯 **目标**: 将碰撞盒信息内联到触发帧，简化数据结构  
> ✅ **状态**: 完成

---

## 🎯 **重构目标**

将碰撞盒从独立字段 `AttackBoxInfo` 迁移到触发帧 `TriggerFrames` 内联定义，实现：
- ✅ 每个碰撞触发都有独立的碰撞盒配置
- ✅ 数据结构更清晰，一目了然
- ✅ 灵活性提升，不同帧可使用不同碰撞形状
- ✅ 减少数据冗余和不一致

---

## 📊 **数据格式对比**

### **旧格式**
```csv
actionId,skillId,attackBoxInfo,actualCost,actualCooldown,triggerFrames
3001,2001,"Box:1,0,0.5:0,0,0,1:1,1,0.5",20,300,Frame10:Collision:4022
```

**问题**：
- ❌ `attackBoxInfo` 独立存储，不知道哪个触发帧用哪个碰撞盒
- ❌ 所有碰撞触发共用同一组碰撞盒，缺乏灵活性
- ❌ 两个字段维护，容易不一致

### **新格式**
```csv
actionId,skillId,actualCost,actualCooldown,triggerFrames
3001,2001,20,300,"Frame10:Collision(Box:1x1x0.5):4022"
```

**优点**：
- ✅ 碰撞盒信息内联，清晰明了
- ✅ 每个触发帧可以有不同的碰撞盒
- ✅ 只需维护一个字段
- ✅ 数据一致性有保证

---

## 🔧 **触发帧新格式规范**

### **基本格式**
```
Frame{帧号}:{触发类型}({参数}):{效果ID}
```

### **完整示例**
```
Frame5:Collision(Box:5x2x1):4001,
Frame10:Direct:4002,
Frame15:Collision(Sphere:3.0):4003,
Frame20:Collision(Capsule:2x5):4004,
Frame25:Collision(Point):4005,
Frame30:Condition(Energy>50):4006
```

### **碰撞盒类型**

| 类型 | 格式 | 示例 | 说明 |
|------|------|------|------|
| Box | `Box:宽x高x深` | `Collision(Box:5x2x1):4001` | 盒子形状，全尺寸 |
| Sphere | `Sphere:半径` | `Collision(Sphere:3.0):4002` | 球形 |
| Capsule | `Capsule:半径x高` | `Collision(Capsule:2x5):4003` | 胶囊形状 |
| Point | `Point` | `Collision(Point):4004` | 点判定 |

---

## 📝 **修改文件清单**

### **1. 编辑器层 (9个文件)**

#### **数据结构**
- ✅ `SkillActionEditorData.cs`
  - 移除 `AttackBoxInfo` 字段
  - `TriggerFrameData` 添加 `CollisionInfo` 字段
  - 更新解析逻辑：`ParseFromString()`
  - 更新序列化逻辑：`SerializeToString()`

- ✅ `SkillEditorData.cs`
  - `SkillActionData` 移除 `AttackBoxInfo` 字段
  - 更新 `Clone()` 方法
  - 更新 `AddSkillAction()` 方法

#### **CSV映射**
- ✅ `SkillActionTableData.cs`
  - 移除 `AttackBoxInfo` 字段
  - 更新表头配置（5个字段）

#### **数据读写**
- ✅ `SkillActionDataReader.cs` - 移除 `AttackBoxInfo` 读取
- ✅ `SkillActionDataWriter.cs` - 移除 `AttackBoxInfo` 写入
- ✅ `SkillDataReader.cs` - 移除 `AttackBoxInfo` 引用（2处）
- ✅ `SkillDataWriter.cs` - 移除 `AttackBoxInfo` 引用

#### **UI模块**
- ✅ `SkillActionConfigModule.cs`
  - 移除 `DrawAttackBoxes()` 方法（50行）
  - 移除 `_attackBoxFoldout` 状态变量
  - 更新 `DrawTriggerFramesRaw()` 提示信息

---

### **2. 运行时层 (4个文件)**

#### **新增文件**
- ✅ `CollisionInfoParser.cs` ⭐ **(新建，198行)**
  - `Parse(string collisionInfo)` - 解析碰撞盒信息
  - `ParseBox()` - 解析盒子（Box:5x2x1）
  - `ParseSphere()` - 解析球形（Sphere:3.0）
  - `ParseCapsule()` - 解析胶囊（Capsule:2x5）
  - `ParsePoint()` - 解析点判定
  - 完整的错误处理和日志

#### **更新文件**
- ✅ `SkillActionInfo.cs`
  - 移除 `AttackBoxInfo` 字段
  - 更新 MemoryPack 构造函数（移除参数）

- ✅ `ActionConfigManager.cs`
  - `PopulateSkillActionFields()` 移除 `AttackBoxInfo` 赋值

- ✅ `SkillConfigManager.cs` ⭐ **（核心修改）**
  - `ParseTriggerFrames()` 移除 `attackBoxInfo` 参数
  - 实现从触发帧内联信息解析碰撞盒
  - 支持括号语法：`Collision(Box:5x2x1)`
  - 使用 `CollisionInfoParser.Parse()` 解析碰撞形状
  - 支持 Condition 类型的条件解析

---

### **3. 配置表 (2个文件)**

#### **CSV文件**
- ✅ `#SkillActionTable.csv`
  - 移除 `attackBoxInfo` 列
  - 更新表头：5个字段
  - 更新示例数据格式

#### **生成代码**
- ✅ `SkillActionTable.cs` (自动生成)
  - 移除 `AttackBoxInfo` 属性
  - 字段数量：6 → 5

---

### **4. 文档 (2个文件)**

- ✅ `Skill-System 技能系统.md`
  - 更新表结构说明
  - 新增详细格式规范
  - 更新配置示例

- ✅ `SkillEditor_README.md`
  - 更新界面布局说明
  - 新增碰撞盒格式提示

---

## 🔄 **数据流程**

### **编辑器 → CSV**
```
编辑器：
TriggerFrameData {
    Frame = 5,
    TriggerType = "Collision",
    CollisionInfo = "Box:5x2x1",
    EffectId = 4001
}
  ↓ SerializeToString()
CSV：
triggerFrames = "Frame5:Collision(Box:5x2x1):4001"
```

### **CSV → 运行时**
```
CSV：
triggerFrames = "Frame5:Collision(Box:5x2x1):4001"
  ↓ SkillConfigManager.ParseTriggerFrames()
  ↓ 提取 collisionInfo = "Box:5x2x1"
  ↓ CollisionInfoParser.Parse("Box:5x2x1")
  ↓ 构造 CollisionShape { ShapeType=Box, HalfSize=(2.5, 1, 0.5) }
运行时：
TriggerFrameInfo {
    Frame = 5,
    TriggerType = "Collision",
    CollisionShape = { Box形状 },
    EffectId = 4001
}
```

---

## 📊 **代码统计**

**新增**：
- CollisionInfoParser.cs: +198行

**修改**：
- SkillActionEditorData.cs: +50/-10行
- SkillActionTableData.cs: -3字段
- SkillActionConfigModule.cs: -50行（移除DrawAttackBoxes）
- SkillConfigManager.cs: +30行（新解析逻辑）
- SkillActionInfo.cs: -1字段, -1参数
- 其他文件：移除AttackBoxInfo引用

**总计**：
- 新增: ~200行
- 删除: ~130行
- 净增: ~70行

---

## ✅ **验证结果**

### **编译验证**
```bash
✅ dotnet build AstrumProj.sln
✅ 0 errors
⚠️ 26 warnings (nullable注释相关，不影响功能)
```

### **配置表验证**
```bash
✅ Luban配置表生成成功
✅ SkillActionTable.cs 已更新
✅ attackBoxInfo 字段已移除
✅ triggerFrames 描述已更新
```

### **功能验证** (待Unity激活)
- ⏳ 编辑器UI正常显示
- ⏳ 触发帧解析正确
- ⏳ 运行时碰撞盒生成正确

---

## 🎨 **编辑器UI变化**

### **配置面板精简**
```
移除前：7个折叠区域
- 基础信息
- 动画路径
- 技能信息
- 技能成本
- ❌ 攻击碰撞盒 (已移除)
- 触发帧配置
- 取消标签

移除后：6个折叠区域
- 基础信息
- 动画路径
- 技能信息
- 技能成本
- 触发帧配置 (含碰撞盒提示)
- 取消标签
```

### **触发帧编辑提示更新**
```
新增碰撞盒格式说明：
• Box:宽x高x深      例如：Collision(Box:5x2x1):4001
• Sphere:半径        例如：Collision(Sphere:3.0):4002
• Capsule:半径x高    例如：Collision(Capsule:2x5):4003
• Point              例如：Collision(Point):4004
```

---

## 💡 **设计优势**

### **1. 数据一致性**
- 碰撞盒直接绑定到触发帧，不会出现不一致
- 一个字段维护，减少人为错误

### **2. 灵活性提升**
- 每个碰撞触发可以有不同的碰撞盒形状
- 支持同一技能动作中混合使用不同碰撞类型
- 易于扩展新的碰撞盒类型

### **3. 可读性增强**
```
旧：attackBoxInfo: "Box1:复杂格式"
    triggerFrames: "Frame5:Collision:4001"  ← 不知道用哪个盒子

新：triggerFrames: "Frame5:Collision(Box:5x2x1):4001"  ← 一目了然
```

### **4. 维护成本降低**
- 减少一个字段的维护
- 编辑器UI更简洁
- 配置表更易理解

---

## 🚀 **后续工作**

### **Phase 3: 技能效果轨道可视化**
1. 创建 `SkillEffectEventData.cs`
2. 实现效果选择器
3. 可视化渲染碰撞盒
4. 实现触发帧双向同步

### **预期效果**
在时间轴上拖拽创建碰撞触发事件时，可以：
- 可视化选择碰撞盒类型
- 实时预览碰撞盒形状
- 自动生成正确的触发帧字符串

---

## ⚠️ **重要提示**

### **Unity需要识别新文件**
1. 切换到Unity编辑器
2. 等待自动编译完成
3. `CollisionInfoParser.cs` 和 `EventDetailModule.cs` 需要Unity识别

### **数据迁移**
现有的 CSV 数据需要手动迁移：
```
旧：Frame10:Collision:4022  + attackBoxInfo: "复杂格式"
新：Frame10:Collision(Box:1x1x0.5):4022
```

---

## 📚 **相关文档**

- [技能系统策划案](../02-CombatSystem 战斗系统/Skill-System 技能系统.md)
- [技能动作编辑器](../../AstrumProj/Assets/Script/Editor/RoleEditor/SkillEditor_README.md)

---

**重构完成！** 🎊


