# Phase 3A 完成 - 触发帧多帧支持 + 数据结构完善

> 📅 **日期**: 2025-10-11  
> 🎯 **阶段**: Phase 3A - 技能效果事件数据结构  
> ✅ **状态**: 完成

---

## 🎯 **完成目标**

1. ✅ 触发帧支持帧范围（单帧/多帧）
2. ✅ 创建完整的 `SkillEffectEventData` 数据结构
3. ✅ 创建 `SkillEffectDataReader` 配置表读取服务
4. ✅ 更新运行时多帧展开逻辑

---

## 📊 **触发帧格式（最终版）**

### **支持的格式**

**单帧触发**：
```
Frame5:Direct:4001                           // 第5帧直接触发
Frame10:Collision(Box:5x2x1):4002           // 第10帧碰撞触发
Frame15:Condition(Energy>50):4003           // 第15帧条件触发
```

**多帧触发**（新增）：
```
Frame5-10:Collision(Box:5x2x1):4001         // 5-10帧持续碰撞判定
Frame15-20:Direct:4002                       // 15-20帧持续直接触发
Frame25-30:Collision(Sphere:3.0):4003       // 25-30帧球形碰撞
```

**混合使用**：
```
Frame5:Direct:4001,
Frame10-20:Collision(Box:5x2x1):4002,
Frame25:Collision(Sphere:3.0):4003,
Frame30-35:Condition(Energy>30):4004
```

### **完整格式规范**
```
Frame{起始帧}[-{结束帧}]:{触发类型}[({参数})]:{效果ID}
```

**组成部分**：
1. **帧范围**：`Frame5` 或 `Frame5-10`
2. **触发类型**：`Direct` / `Collision(碰撞盒)` / `Condition(条件)`
3. **效果ID**：对应 SkillEffectTable

---

## 🔧 **数据结构更新**

### **TriggerFrameData (编辑器)**

```csharp
// Editor/RoleEditor/Data/SkillActionEditorData.cs
[Serializable]
public class TriggerFrameData
{
    public int StartFrame;       // 起始帧
    public int EndFrame;         // 结束帧（单帧时等于StartFrame）
    public string TriggerType;   // Collision, Direct, Condition
    public string CollisionInfo; // 碰撞盒信息
    public int EffectId;         // 效果ID
    
    // 辅助属性
    public bool IsSingleFrame => StartFrame == EndFrame;
    public int Duration => EndFrame - StartFrame + 1;
    
    // 解析：支持 "Frame5" 和 "Frame5-10"
    public static List<TriggerFrameData> ParseFromString(string str);
    
    // 序列化：自动判断单帧/多帧
    public static string SerializeToString(List<TriggerFrameData> triggers);
}
```

**解析逻辑**：
- `Frame5` → StartFrame=5, EndFrame=5
- `Frame5-10` → StartFrame=5, EndFrame=10
- 验证：StartFrame <= EndFrame

**序列化逻辑**：
- 单帧：`Frame5:...`
- 多帧：`Frame5-10:...`

---

### **SkillEffectEventData (时间轴)**

```csharp
// Timeline/EventData/SkillEffectEventData.cs (新建，297行)
[Serializable]
public class SkillEffectEventData
{
    // 核心数据
    public int EffectId;
    public string TriggerType;
    public string CollisionInfo;
    
    // 效果详情（从配置表读取）
    public string EffectName;
    public int EffectType;
    public float EffectValue;
    public float EffectRange;
    public int TargetType;
    
    // 碰撞盒解析结果
    public string CollisionShapeType; // Box, Sphere, Capsule, Point
    public string CollisionShapeSize; // "5x2x1" 或 "3.0"
    
    // 方法
    public static SkillEffectEventData CreateFromTable(int effectId, ...);
    public void RefreshFromTable();
    public void ParseCollisionInfo();
    public string GetDisplayName();        // "普通攻击 (150)"
    public string GetDetailText();         // 完整信息
    public Color GetEffectTypeColor();     // 效果类型颜色
    public string GetTriggerIcon();        // 触发类型图标
    public bool Validate(out List<string> errors);
}
```

**功能**：
- ✅ 从配置表自动读取效果详情
- ✅ 解析碰撞盒信息
- ✅ 提供显示名称和颜色
- ✅ 数据验证

---

### **SkillEffectDataReader (服务)**

```csharp
// Services/SkillEffectDataReader.cs (新建，159行)
public static class SkillEffectDataReader
{
    // 读取
    public static List<SkillEffectTableData> ReadAllSkillEffects();
    public static SkillEffectTableData GetSkillEffect(int effectId);
    
    // 分组和筛选
    public static Dictionary<int, List<...>> GroupByEffectType();
    public static List<...> FilterByEffectType(int effectType);
    public static List<...> SearchEffects(string keyword);
    
    // 辅助
    public static string GetEffectTypeName(int type);
    public static string GetTargetTypeName(int type);
    public static string GetEffectTypeIcon(int type);
    public static void ClearCache();
}
```

**功能**：
- ✅ 读取所有技能效果配置
- ✅ 按效果类型分组
- ✅ 搜索和筛选
- ✅ 数据缓存机制

---

## 🔄 **运行时处理**

### **多帧展开逻辑**

**输入**（配置表）：
```
Frame10-20:Collision(Box:5x2x1):4002
```

**处理**（SkillConfigManager）：
```csharp
for (int frame = 10; frame <= 20; frame++)
{
    results.Add(new TriggerFrameInfo
    {
        Frame = frame,
        TriggerType = "Collision",
        CollisionShape = ParsedShape,
        EffectId = 4002
    });
}
```

**输出**（运行时）：
```
11个 TriggerFrameInfo 对象
Frame=10, Frame=11, ..., Frame=20
```

**逐帧检查**：
```csharp
// SkillExecutorCapability.ProcessFrame()
var triggersAtFrame = skillAction.TriggerEffects
    .Where(t => t.Frame == currentFrame)  // ✅ 仍然是单帧检查
    .ToList();
```

---

## 📝 **修改文件清单**

### **新建文件 (2个)**
1. ✅ `SkillEffectEventData.cs` (297行)
2. ✅ `SkillEffectDataReader.cs` (159行)

### **更新文件 (3个)**
1. ✅ `SkillActionEditorData.cs`
   - TriggerFrameData 添加 StartFrame/EndFrame
   - 更新 ParseFromString() 支持帧范围
   - 更新 SerializeToString() 自动判断单帧/多帧
   - 更新 Clone() 方法

2. ✅ `SkillConfigManager.cs`
   - ParseTriggerFrames() 支持帧范围解析
   - 多帧展开为单帧列表
   - 更新日志输出

3. ✅ 文档更新（待完成）

---

## 🎨 **时间轴显示效果（预期）**

```
时间轴：
┌─────────────────────────────────────────────┐
│ 💥 技能效果                                 │
│  ◆5  ████████████10-20  ◆25  ████30-35     │
│  ↑   ↑                  ↑    ↑             │
│  单帧 多帧碰撞区间       单帧  多帧区间      │
└─────────────────────────────────────────────┘

图例：
◆ - 单帧事件（菱形标记，宽度固定）
█ - 多帧事件（矩形区间，宽度根据帧数）

颜色：
🔴 红色 - 伤害效果
🟢 绿色 - 治疗效果
🟠 橙色 - 击退效果
🔵 蓝色 - Buff效果
🟣 紫色 - Debuff效果
```

---

## ✅ **编译结果**

```bash
✅ 编译成功 - 0 errors
✅ 所有代码语法正确
✅ 新文件已创建
✅ 数据结构完整
```

---

## 🚀 **下一步：Phase 3B/3C**

### **Phase 3B：技能效果选择器** (2-3小时)
- 创建 `SkillEffectSelectorWindow.cs`
- 效果列表展示（按类型分组）
- 搜索和筛选功能
- 效果详情预览

### **Phase 3C：完整渲染器** (2-3小时)
- 创建 `SkillEffectTrackRenderer.cs`
- 单帧事件渲染（菱形）
- 多帧事件渲染（矩形区间）
- 颜色区分效果类型
- 碰撞盒图标显示
- 悬停信息提示

---

## 📚 **格式示例**

### **单帧示例**
```csv
triggerFrames = "Frame5:Direct:4001,Frame10:Collision(Box:5x2x1):4002"
```
运行时展开为：
- Frame 5 → Direct触发
- Frame 10 → Collision触发（Box碰撞盒）

### **多帧示例**
```csv
triggerFrames = "Frame10-20:Collision(Box:5x2x1):4002"
```
运行时展开为：
- Frame 10-20 → 每帧都进行Collision判定（共11个判定点）

### **混合示例**
```csv
triggerFrames = "Frame5:Direct:4001,Frame10-20:Collision(Box:5x2x1):4002,Frame25:Collision(Sphere:3.0):4003"
```

---

**Phase 3A 完成！数据结构已就绪，可以开始实现可视化编辑！** 🎊

