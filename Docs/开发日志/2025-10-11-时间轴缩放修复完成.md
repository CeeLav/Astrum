# æ—¶é—´è½´ç¼©æ”¾ä¿®å¤å®Œæˆ

> ğŸ“… **æ—¥æœŸ**: 2025-10-11  
> ğŸ¯ **ç›®æ ‡**: ä¿®å¤Durationçº¿ä½ç½® + æ—¶é—´è½´è‡ªåŠ¨å¡«æ»¡åŒºåŸŸ  
> âœ… **çŠ¶æ€**: å®Œæˆ

---

## ğŸ› **ä¿®å¤çš„é—®é¢˜**

### **é—®é¢˜1ï¼šDuration è¾¹ç•Œçº¿åå·¦**

**åŸå› **ï¼š
- Durationçº¿åœ¨ScrollViewå¤–éƒ¨ç»˜åˆ¶
- ä½¿ç”¨çš„æ˜¯å¤–éƒ¨åæ ‡ç³»ï¼Œä½†éœ€è¦åœ¨ScrollViewå†…éƒ¨åæ ‡ç³»ç»˜åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å°† `DrawEditableBoundary` ç§»åˆ° `DrawTracks` å†…éƒ¨
- åœ¨ `BeginScrollView` ä¹‹åç»˜åˆ¶
- ä½¿ç”¨ScrollViewå†…éƒ¨åæ ‡ç³»ï¼ˆä»0,0å¼€å§‹ï¼‰

**ä¿®æ”¹**ï¼š
```csharp
// TimelineRenderer.cs

public void DrawTracks(
    Rect rect,
    List<TimelineTrackConfig> tracks,
    Dictionary<string, List<TimelineEvent>> eventsByTrack,
    int currentFrame,
    TimelineEvent selectedEvent = null,
    TimelineEvent hoverEvent = null,
    bool showBoundary = false,        // â† æ–°å¢å‚æ•°
    int maxEditableFrame = 0)         // â† æ–°å¢å‚æ•°
{
    _scrollPosition = GUI.BeginScrollView(rect, _scrollPosition, viewRect);
    
    // ç»˜åˆ¶å¯ç¼–è¾‘èŒƒå›´è¾¹ç•Œçº¿ï¼ˆåœ¨ScrollViewå†…éƒ¨ç»˜åˆ¶ï¼‰
    if (showBoundary && maxEditableFrame > 0)
    {
        DrawEditableBoundaryInScrollView(viewRect, maxEditableFrame);
    }
    
    // ... ç»˜åˆ¶è½¨é“
}

private void DrawEditableBoundaryInScrollView(Rect viewRect, int maxEditableFrame)
{
    // è®¡ç®—è¾¹ç•Œçº¿ä½ç½®ï¼ˆScrollViewå†…éƒ¨åæ ‡ç³»ï¼‰
    float x = _layoutCalculator.FrameToPixel(maxEditableFrame) + _layoutCalculator.GetTrackHeaderWidth();
    
    // ç»˜åˆ¶è™šçº¿ï¼ˆä» y=0 å¼€å§‹ï¼‰
    float currentY = 0;
    while (currentY < viewRect.height)
    {
        // ... ç»˜åˆ¶è™šçº¿æ®µ
    }
    
    // ç»˜åˆ¶æ ‡ç­¾ï¼ˆç›¸å¯¹äºScrollViewå†…éƒ¨ï¼‰
    Rect labelRect = new Rect(x + 5, 5, labelSize.x, labelSize.y);
    // ...
}
```

---

### **é—®é¢˜2ï¼šæ—¶é—´è½´æœªå¡«æ»¡åŒºåŸŸ**

**åŸå› **ï¼š
- ä½¿ç”¨å›ºå®šçš„ `DEFAULT_PIXELS_PER_FRAME = 5f`
- å¯¹äºé•¿åŠ¨ç”»ï¼ˆå¦‚120å¸§ï¼‰ï¼Œå†…å®¹å®½åº¦ = 120 Ã— 5 = 600px
- å¦‚æœå¯ç”¨å®½åº¦åªæœ‰400pxï¼Œå°±ä¼šå‡ºç°å¤§é‡ç©ºç™½æˆ–æ»šåŠ¨æ¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `FitToWidth()` æ–¹æ³•ï¼Œè‡ªåŠ¨è®¡ç®—åˆé€‚çš„ç¼©æ”¾çº§åˆ«
- åœ¨æ¯æ¬¡ç»˜åˆ¶å‰è‡ªåŠ¨è°ƒç”¨ï¼Œä½¿æ—¶é—´è½´å¡«æ»¡å¯ç”¨å®½åº¦
- é™ä½ `MIN_PIXELS_PER_FRAME` ä» 2f åˆ° 0.5fï¼Œæ”¯æŒæ›´é•¿çš„åŠ¨ç”»

**ä¿®æ”¹**ï¼š
```csharp
// TimelineLayoutCalculator.cs

private const float MIN_PIXELS_PER_FRAME = 0.5f;   // â† ä» 2f æ”¹ä¸º 0.5f

/// <summary>
/// è‡ªåŠ¨é€‚åº”ï¼šè®¡ç®—åˆé€‚çš„ç¼©æ”¾çº§åˆ«ï¼Œä½¿æ—¶é—´è½´å¡«æ»¡å¯ç”¨å®½åº¦
/// </summary>
public void FitToWidth(float availableWidth, int totalFrames)
{
    if (totalFrames <= 0) return;
    
    // è®¡ç®—å†…å®¹åŒºåŸŸå®½åº¦ï¼ˆæ’é™¤è½¨é“æ ‡é¢˜ï¼‰
    float contentWidth = availableWidth - _trackHeaderWidth;
    
    // è®¡ç®—åˆé€‚çš„ç¼©æ”¾çº§åˆ«
    float idealPixelsPerFrame = contentWidth / totalFrames;
    
    // é™åˆ¶åœ¨åˆç†èŒƒå›´å†… [0.5, 20]
    _pixelsPerFrame = Mathf.Clamp(idealPixelsPerFrame, MIN_PIXELS_PER_FRAME, MAX_PIXELS_PER_FRAME);
}
```

```csharp
// TimelineEditorModule.cs

public void DrawTimeline(Rect rect)
{
    // è‡ªåŠ¨è°ƒæ•´ç¼©æ”¾ä»¥å¡«æ»¡å¯ç”¨å®½åº¦
    _layoutCalculator.FitToWidth(rect.width, _totalFrames);
    
    // è®¡ç®—å¸ƒå±€
    _layoutCalculator.CalculateLayout(rect, _totalFrames, _tracks.Count);
    
    // ... ç»˜åˆ¶
}
```

---

## ğŸ“Š **æ•ˆæœå¯¹æ¯”**

### **Durationçº¿ä½ç½®**

**ä¿®å¤å‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Duration:60                 â”‚  â† ååˆ°æœ€å·¦è¾¹
â”‚                             â”‚
â”‚ â—†   â—†   â—†  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¿®å¤å**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 0    10   20   30   40   50â”‚60   70   80   â”‚
â”‚                             â”‚               â”‚
â”‚ â—†    â—†    â—†  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚               â”‚
â”‚                  Duration:60â”‚               â”‚  â† æ­£ç¡®ä½ç½®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### **æ—¶é—´è½´å®½åº¦**

**ä¿®å¤å‰ï¼ˆå›ºå®šç¼©æ”¾ï¼‰**ï¼š
```
AnimationDuration = 120å¸§
pixelsPerFrame = 5 (å›ºå®š)
å†…å®¹å®½åº¦ = 120 Ã— 5 = 600px

å¯ç”¨å®½åº¦ = 400px
ç»“æœï¼šéœ€è¦æ¨ªå‘æ»šåŠ¨ï¼Œæˆ–è€…å¤§é‡ç©ºç™½
```

**ä¿®å¤åï¼ˆè‡ªåŠ¨é€‚åº”ï¼‰**ï¼š
```
AnimationDuration = 120å¸§
å¯ç”¨å®½åº¦ = 400px
å†…å®¹å®½åº¦ = 400px - 120px(header) = 280px

è®¡ç®—ï¼špixelsPerFrame = 280 / 120 = 2.33
é™åˆ¶ï¼šClamp(2.33, 0.5, 20) = 2.33
ç»“æœï¼šæ—¶é—´è½´åˆšå¥½å¡«æ»¡æ•´ä¸ªåŒºåŸŸ âœ…
```

---

## ğŸ¯ **è‡ªåŠ¨ç¼©æ”¾ç¤ºä¾‹**

### **çŸ­åŠ¨ç”»ï¼ˆ60å¸§ï¼‰**
```
å¯ç”¨å®½åº¦ = 800px
å†…å®¹å®½åº¦ = 800 - 120 = 680px
è®¡ç®—ï¼špixelsPerFrame = 680 / 60 = 11.33
é™åˆ¶ï¼šClamp(11.33, 0.5, 20) = 11.33 âœ…

ç»“æœï¼šæ¯å¸§ 11.33pxï¼Œæ—¶é—´è½´å¡«æ»¡ï¼Œåˆ»åº¦æ¸…æ™°
```

### **ä¸­ç­‰åŠ¨ç”»ï¼ˆ120å¸§ï¼‰**
```
å¯ç”¨å®½åº¦ = 800px
å†…å®¹å®½åº¦ = 680px
è®¡ç®—ï¼špixelsPerFrame = 680 / 120 = 5.67
é™åˆ¶ï¼šClamp(5.67, 0.5, 20) = 5.67 âœ…

ç»“æœï¼šæ¯å¸§ 5.67pxï¼Œæ—¶é—´è½´å¡«æ»¡ï¼Œåˆ»åº¦åˆç†
```

### **é•¿åŠ¨ç”»ï¼ˆ300å¸§ï¼‰**
```
å¯ç”¨å®½åº¦ = 800px
å†…å®¹å®½åº¦ = 680px
è®¡ç®—ï¼špixelsPerFrame = 680 / 300 = 2.27
é™åˆ¶ï¼šClamp(2.27, 0.5, 20) = 2.27 âœ…

ç»“æœï¼šæ¯å¸§ 2.27pxï¼Œæ—¶é—´è½´å¡«æ»¡ï¼Œåˆ»åº¦è¾ƒå¯†
```

### **è¶…é•¿åŠ¨ç”»ï¼ˆ1000å¸§ï¼‰**
```
å¯ç”¨å®½åº¦ = 800px
å†…å®¹å®½åº¦ = 680px
è®¡ç®—ï¼špixelsPerFrame = 680 / 1000 = 0.68
é™åˆ¶ï¼šClamp(0.68, 0.5, 20) = 0.68 âœ…

ç»“æœï¼šæ¯å¸§ 0.68pxï¼Œæ—¶é—´è½´å¡«æ»¡ï¼Œåˆ»åº¦å¾ˆå¯†ä½†å¯ç”¨
```

---

## ğŸ“ **ä¿®æ”¹æ–‡ä»¶æ¸…å•**

### **æ›´æ–°æ–‡ä»¶ (3ä¸ª)**

1. âœ… `Timeline/TimelineEditorModule.cs`
   - åœ¨ `DrawTimeline()` å¼€å¤´è°ƒç”¨ `FitToWidth()`
   - æ›´æ–° `DrawTracks()` è°ƒç”¨ï¼Œä¼ é€’è¾¹ç•Œçº¿å‚æ•°

2. âœ… `Timeline/TimelineRenderer.cs`
   - æ›´æ–° `DrawTracks()` ç­¾åï¼Œæ·»åŠ  `showBoundary` å’Œ `maxEditableFrame` å‚æ•°
   - å°† `DrawEditableBoundary()` æ”¹ä¸º `DrawEditableBoundaryInScrollView()`
   - åœ¨ScrollViewå†…éƒ¨ç»˜åˆ¶è¾¹ç•Œçº¿

3. âœ… `Timeline/TimelineLayoutCalculator.cs`
   - æ·»åŠ  `FitToWidth()` æ–¹æ³•
   - å°† `MIN_PIXELS_PER_FRAME` ä» 2f æ”¹ä¸º 0.5f

---

## âœ… **ç¼–è¯‘ç»“æœ**

```bash
âœ… ç¼–è¯‘æˆåŠŸ - 0 errors
âœ… Durationçº¿ä½ç½®æ­£ç¡®
âœ… æ—¶é—´è½´è‡ªåŠ¨å¡«æ»¡åŒºåŸŸ
```

---

## ğŸ® **ä½¿ç”¨æ•ˆæœ**

### **çª—å£å¤§å°å˜åŒ–**

**è‡ªåŠ¨é€‚åº”**ï¼š
- çª—å£å˜å®½ â†’ æ—¶é—´è½´æ‹‰ä¼¸ï¼Œæ¯å¸§æ›´å®½
- çª—å£å˜çª„ â†’ æ—¶é—´è½´å‹ç¼©ï¼Œæ¯å¸§æ›´çª„
- å§‹ç»ˆå¡«æ»¡å¯ç”¨å®½åº¦ï¼Œæ— æ¨ªå‘æ»šåŠ¨æ¡

### **ä¸åŒå¸§æ•°**

**è‡ªåŠ¨è°ƒæ•´**ï¼š
- 60å¸§ â†’ æ¯å¸§è¾ƒå®½ï¼ˆçº¦11pxï¼‰
- 120å¸§ â†’ æ¯å¸§é€‚ä¸­ï¼ˆçº¦5-6pxï¼‰
- 300å¸§ â†’ æ¯å¸§è¾ƒçª„ï¼ˆçº¦2-3pxï¼‰
- 1000å¸§ â†’ æ¯å¸§å¾ˆçª„ï¼ˆçº¦0.5-1pxï¼‰

### **ç¼©æ”¾èŒƒå›´**

**é™åˆ¶**ï¼š
- æœ€å°ï¼š0.5px/å¸§ï¼ˆæ”¯æŒè¶…é•¿åŠ¨ç”»ï¼‰
- æœ€å¤§ï¼š20px/å¸§ï¼ˆé¿å…è¿‡åº¦æ”¾å¤§ï¼‰
- è‡ªåŠ¨ï¼šæ ¹æ®å¯ç”¨å®½åº¦å’Œå¸§æ•°è®¡ç®—

---

## ğŸš€ **ä¼˜åŠ¿**

1. **æ— éœ€æ‰‹åŠ¨è°ƒæ•´**ï¼šè‡ªåŠ¨é€‚åº”çª—å£å¤§å°
2. **å®Œå…¨åˆ©ç”¨ç©ºé—´**ï¼šæ—¶é—´è½´å¡«æ»¡æ•´ä¸ªåŒºåŸŸ
3. **æ— æ¨ªå‘æ»šåŠ¨**ï¼šå†…å®¹åˆšå¥½é€‚é…
4. **æ”¯æŒé•¿åŠ¨ç”»**ï¼šæœ€å°0.5px/å¸§ï¼Œå¯æ˜¾ç¤º1000+å¸§
5. **ä¿æŒæ¸…æ™°**ï¼šåœ¨åˆç†èŒƒå›´å†…è‡ªåŠ¨è°ƒæ•´

---

**ä¿®å¤å®Œæˆï¼æ—¶é—´è½´ç°åœ¨å®Œç¾é€‚é…ï¼** ğŸŠ

