# äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿå¼€å‘è¿›å±•

**ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-01-08  
**çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®ç°  

> ğŸ“– **ç›¸å…³æ–‡æ¡£**ï¼š
> - [äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿè®¾è®¡](Event-Queue-System%20äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿ.md)
> - [å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•](../../02-CombatSystem%20æˆ˜æ–—ç³»ç»Ÿ/æŠ€èƒ½æ•ˆæœ/Hit-Reaction-Progress%20å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•.md)

---

## TL;DR

**ç›®æ ‡**ï¼šä¸º Logic å±‚å®ä½“é—´é€šä¿¡å¼•å…¥æ–°çš„äº‹ä»¶é˜Ÿåˆ—æœºåˆ¶ï¼Œé‡‡ç”¨é™æ€å£°æ˜ + é¢„å¤„ç† + é›†ä¸­è°ƒåº¦æ¶æ„ï¼Œä¸ç°æœ‰ EventSystem å…±å­˜ã€‚

**è¿›å±•**ï¼šâœ… è®¾è®¡å®Œæˆï¼ŒğŸ“‹ å¾…å®ç°

**é¢„ä¼°å·¥æ—¶**ï¼š**12-16 å°æ—¶**

**å…³é”®é£é™©**ï¼š
- âš ï¸ è£…ç®±æ‹†ç®±æ€§èƒ½å¼€é”€ï¼ˆéœ€æµ‹è¯•ï¼‰
- âš ï¸ CapabilitySystem æ³¨å†Œæµç¨‹æ”¹åŠ¨ï¼ˆéœ€ç¡®è®¤ç°æœ‰é€»è¾‘ï¼‰

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| v1.0 | 2025-01-08 | åˆå§‹ç‰ˆæœ¬ï¼Œè®¾è®¡å®Œæˆ | AI Assistant |

---

## ä»»åŠ¡åˆ†è§£

### Phase 0: å‰ç½®å‡†å¤‡ â³

**é¢„ä¼°å·¥æ—¶**: 1-2 å°æ—¶

- [ ] **P0.1**: é˜…è¯»ç°æœ‰ `CapabilitySystem` å’Œ `Capability<T>` ä»£ç 
- [ ] **P0.2**: ç¡®è®¤ `Entity.HasCapability` å’Œ `GetCapability` API
- [ ] **P0.3**: ç¡®è®¤ `World.Update` è°ƒç”¨é¡ºåº
- [ ] **P0.4**: ç¡®è®¤æ˜¯å¦éœ€è¦ MemoryPack åºåˆ—åŒ–æ”¯æŒ

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ¸…æ¥šç†è§£ç°æœ‰ Capability æ¶æ„
- ç¡®è®¤é›†æˆç‚¹å’Œæ”¹åŠ¨èŒƒå›´

---

### Phase 1: æ ¸å¿ƒæ•°æ®ç»“æ„ ğŸ”¨

**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶

#### 1.1 EntityEvent

- [ ] **P1.1.1**: åˆ›å»º `EntityEvent` struct
  - `long TargetEntityId`
  - `Type EventType`
  - `object EventData`
  - `int Frame`

#### 1.2 EntityEventQueue

- [ ] **P1.2.1**: åˆ›å»º `EntityEventQueue` ç±»
  - `Dictionary<long, Queue<EntityEvent>> _entityQueues`
  - `Queue<Queue<EntityEvent>> _queuePool`ï¼ˆå¯¹è±¡æ± ï¼‰
- [ ] **P1.2.2**: å®ç° `QueueEvent<T>(long targetEntityId, T eventData)`
- [ ] **P1.2.3**: å®ç° `GetEvents(long targetEntityId)` (internal)
- [ ] **P1.2.4**: å®ç° `GetEntityIdsWithEvents()` (internal)
- [ ] **P1.2.5**: å®ç° `Clear(long targetEntityId)`
- [ ] **P1.2.6**: å®ç° `ClearAll()`

**éªŒæ”¶æ ‡å‡†**ï¼š
- é˜Ÿåˆ—æ­£ç¡®å­˜å‚¨å’Œæ£€ç´¢äº‹ä»¶
- å¯¹è±¡æ± æ­£å¸¸å·¥ä½œ
- ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š

---

### Phase 2: Capability äº‹ä»¶å¤„ç†æ‰©å±• ğŸ”¨

**é¢„ä¼°å·¥æ—¶**: 3-4 å°æ—¶

#### 2.1 Capability<T> åŸºç±»æ‰©å±•

- [ ] **P2.1.1**: æ·»åŠ  `EntityEventHandler<TEvent>` å§”æ‰˜ç±»å‹
- [ ] **P2.1.2**: æ·»åŠ  `Dictionary<Type, Delegate> _eventHandlers` å­—æ®µ
- [ ] **P2.1.3**: æ·»åŠ  `protected virtual void RegisterEventHandlers()` æ–¹æ³•
- [ ] **P2.1.4**: æ·»åŠ  `protected void RegisterEventHandler<TEvent>(handler)` æ–¹æ³•
- [ ] **P2.1.5**: æ·»åŠ  `internal Dictionary<Type, Delegate> GetEventHandlers()` æ–¹æ³•

#### 2.2 ç¤ºä¾‹å®ç°ï¼ˆæµ‹è¯•ç”¨ï¼‰

- [ ] **P2.2.1**: åˆ›å»ºæµ‹è¯•äº‹ä»¶ `TestEntityEvent`
- [ ] **P2.2.2**: åˆ›å»ºæµ‹è¯• Capability `TestEventCapability`
  - å®ç° `RegisterEventHandlers()`
  - å®ç°äº‹ä»¶å¤„ç†å‡½æ•°

**éªŒæ”¶æ ‡å‡†**ï¼š
- Capability å¯ä»¥æ­£ç¡®å£°æ˜äº‹ä»¶å¤„ç†å™¨
- `GetEventHandlers()` è¿”å›æ­£ç¡®çš„æ˜ å°„
- ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š

---

### Phase 3: CapabilitySystem é¢„å¤„ç†å’Œè°ƒåº¦ ğŸ”¨

**é¢„ä¼°å·¥æ—¶**: 4-5 å°æ—¶

#### 3.1 äº‹ä»¶æ˜ å°„ç¼“å­˜

- [ ] **P3.1.1**: æ·»åŠ  `Dictionary<(Type, Type), Delegate> _eventHandlerCache`
- [ ] **P3.1.2**: æ·»åŠ  `Dictionary<Type, List<(Type, Delegate)>> _eventToHandlers`

#### 3.2 æ³¨å†Œæ—¶é¢„å¤„ç†

- [ ] **P3.2.1**: ä¿®æ”¹ `RegisterCapability<T>()` æ–¹æ³•
  - è°ƒç”¨ `capability.GetEventHandlers()`
  - ç¼“å­˜åˆ° `_eventHandlerCache`
  - å»ºç«‹ `_eventToHandlers` ç´¢å¼•

#### 3.3 äº‹ä»¶å¤„ç†å¾ªç¯

- [ ] **P3.3.1**: å®ç° `ProcessEntityEvents()` æ–¹æ³•
  - éå† `GetEntityIdsWithEvents()`
  - è·å–å®ä½“å’Œäº‹ä»¶é˜Ÿåˆ—
  - è°ƒç”¨ `DispatchEvent()` å¤„ç†æ¯ä¸ªäº‹ä»¶
  - æ¸…ç†å·²å¤„ç†çš„äº‹ä»¶
- [ ] **P3.3.2**: å®ç° `DispatchEvent(Entity entity, EntityEvent evt)` æ–¹æ³•
  - æŸ¥æ‰¾ `_eventToHandlers`
  - æ£€æŸ¥å®ä½“æ˜¯å¦æœ‰è¯¥ Capability ä¸”æ¿€æ´»
  - è°ƒç”¨ `InvokeHandler()`
- [ ] **P3.3.3**: å®ç° `InvokeHandler(Delegate handler, Entity entity, object eventData)` æ–¹æ³•
  - ä½¿ç”¨ `DynamicInvoke` æ‹†ç®±è°ƒç”¨
  - å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—

**éªŒæ”¶æ ‡å‡†**ï¼š
- äº‹ä»¶èƒ½æ­£ç¡®åˆ†å‘åˆ°å¯¹åº”çš„ Capability
- åªæœ‰æ¿€æ´»çš„ Capability ä¼šæ¥æ”¶äº‹ä»¶
- å¼‚å¸¸ä¸ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒ
- ç¼–è¯‘é€šè¿‡ï¼Œæ— è¿è¡Œæ—¶é”™è¯¯

---

### Phase 4: World é›†æˆ ğŸ”§

**é¢„ä¼°å·¥æ—¶**: 1-2 å°æ—¶

- [ ] **P4.1**: åœ¨ `World` ä¸­æ·»åŠ  `EntityEventQueue` å­—æ®µ
- [ ] **P4.2**: åœ¨ `World` æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ– `EntityEventQueue`
- [ ] **P4.3**: ä¿®æ”¹ `World.Update()` è°ƒç”¨ `CapabilitySystem.ProcessEntityEvents()`
- [ ] **P4.4**: åœ¨ `OnEntityDestroyed()` ä¸­è°ƒç”¨ `EntityEventQueue.Clear(entityId)`
- [ ] **P4.5**: åœ¨ `Reset()` ä¸­è°ƒç”¨ `EntityEventQueue.ClearAll()`

**éªŒæ”¶æ ‡å‡†**ï¼š
- World æ­£ç¡®åˆå§‹åŒ–äº‹ä»¶é˜Ÿåˆ—
- å®ä½“é”€æ¯æ—¶äº‹ä»¶è¢«æ¸…ç†
- World é‡ç½®æ—¶äº‹ä»¶è¢«æ¸…ç†
- ç¼–è¯‘é€šè¿‡ï¼Œæ— è¿è¡Œæ—¶é”™è¯¯

---

### Phase 5: æµ‹è¯•å’ŒéªŒè¯ âœ…

**é¢„ä¼°å·¥æ—¶**: 2-3 å°æ—¶

#### 5.1 å•å…ƒæµ‹è¯•

- [ ] **P5.1.1**: æµ‹è¯• `EntityEventQueue` åŸºæœ¬åŠŸèƒ½
  - å…¥é˜Ÿã€å‡ºé˜Ÿã€æ¸…ç†
  - å¯¹è±¡æ± æ­£ç¡®æ€§
- [ ] **P5.1.2**: æµ‹è¯• Capability äº‹ä»¶æ³¨å†Œ
  - `RegisterEventHandlers` è¢«æ­£ç¡®è°ƒç”¨
  - æ˜ å°„æ­£ç¡®å»ºç«‹
- [ ] **P5.1.3**: æµ‹è¯•äº‹ä»¶åˆ†å‘
  - äº‹ä»¶æ­£ç¡®åˆ°è¾¾ç›®æ ‡ Capability
  - éæ¿€æ´» Capability ä¸æ¥æ”¶äº‹ä»¶
  - å¤šä¸ª Capability å¤„ç†åŒä¸€äº‹ä»¶

#### 5.2 é›†æˆæµ‹è¯•

- [ ] **P5.2.1**: åˆ›å»ºå®Œæ•´æµ‹è¯•åœºæ™¯
  - å‘å¸ƒäº‹ä»¶ â†’ é˜Ÿåˆ— â†’ åˆ†å‘ â†’ å¤„ç†
- [ ] **P5.2.2**: æµ‹è¯•å®ä½“é”€æ¯æ—¶çš„æ¸…ç†
- [ ] **P5.2.3**: æµ‹è¯• World é‡ç½®æ—¶çš„æ¸…ç†

#### 5.3 æ€§èƒ½æµ‹è¯•

- [ ] **P5.3.1**: æµ‹è¯•è£…ç®±æ‹†ç®±å¼€é”€ï¼ˆ1000æ¬¡äº‹ä»¶ï¼‰
- [ ] **P5.3.2**: æµ‹è¯•å¤§é‡å®ä½“åœºæ™¯ï¼ˆ100+å®ä½“ï¼‰
- [ ] **P5.3.3**: å¯¹æ¯”æ—§ EventSystem æ€§èƒ½

**éªŒæ”¶æ ‡å‡†**ï¼š
- æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æ€§èƒ½æ»¡è¶³è¦æ±‚ï¼ˆè£…ç®±å¼€é”€å¯æ¥å—ï¼‰
- æ— å†…å­˜æ³„æ¼

---

## ä¾èµ–ç³»ç»ŸçŠ¶æ€

| ç³»ç»Ÿ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| CapabilitySystem | âœ… å·²å­˜åœ¨ | éœ€è¦ä¿®æ”¹æ³¨å†Œæµç¨‹ |
| Capability<T> | âœ… å·²å­˜åœ¨ | éœ€è¦æ‰©å±•äº‹ä»¶å¤„ç†èƒ½åŠ› |
| World | âœ… å·²å­˜åœ¨ | éœ€è¦é›†æˆäº‹ä»¶é˜Ÿåˆ— |
| Entity | âœ… å·²å­˜åœ¨ | å¯èƒ½éœ€è¦æ·»åŠ è¾…åŠ©æ–¹æ³• |

---

## æŠ€æœ¯å€ºåŠ¡

- âš ï¸ **è£…ç®±æ‹†ç®±æ€§èƒ½**: ä½¿ç”¨ `object` å’Œ `DynamicInvoke` æœ‰ä¸€å®šå¼€é”€ï¼Œåç»­å¯è€ƒè™‘ä½¿ç”¨ `SourceGenerator` æˆ– `Expression` ä¼˜åŒ–
- âš ï¸ **åå°„è°ƒç”¨**: `DynamicInvoke` æ€§èƒ½è¾ƒå·®ï¼Œå¦‚æœæˆä¸ºç“¶é¢ˆéœ€è¦ä¼˜åŒ–
- ğŸ“ **æ–‡æ¡£æ›´æ–°**: éœ€è¦æ›´æ–° Capability å¼€å‘æŒ‡å—ï¼Œè¯´æ˜å¦‚ä½•ä½¿ç”¨äº‹ä»¶å¤„ç†

---

## å…³é”®å†³ç­–

| å†³ç­– | ç†ç”± |
|------|------|
| ä½¿ç”¨é™æ€å£°æ˜è€Œé Tick ä¸­æ‹‰å– | å£°æ˜å¼æ›´æ¸…æ™°ï¼Œé¢„å¤„ç†æ€§èƒ½æ›´ä¼˜ |
| ä½¿ç”¨è£…ç®±/æ‹†ç®± | ç®€åŒ–å®ç°ï¼Œæ€§èƒ½å¼€é”€å¯æ¥å— |
| é›†ä¸­è°ƒåº¦è€Œéåˆ†æ•£æ¶ˆè´¹ | ç»Ÿä¸€ç®¡ç†ï¼Œæ›´æ˜“è°ƒè¯•å’Œä¼˜åŒ– |
| ä¸ EventSystem å…±å­˜ï¼ˆåŒè½¨åˆ¶ï¼‰ | å¹³æ»‘è¿ç§»ï¼Œå„å¸å…¶èŒ |

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½å®Œæ•´æ€§
- âœ… äº‹ä»¶å¯ä»¥æ­£ç¡®å…¥é˜Ÿ
- âœ… äº‹ä»¶å¯ä»¥æ ¹æ®ç±»å‹åˆ†å‘åˆ°å¯¹åº” Capability
- âœ… åªæœ‰æ¿€æ´»çš„ Capability æ¥æ”¶äº‹ä»¶
- âœ… Capability é”€æ¯æ—¶è‡ªåŠ¨åœæ­¢æ¥æ”¶äº‹ä»¶
- âœ… å®ä½“é”€æ¯æ—¶æ¸…ç†äº‹ä»¶é˜Ÿåˆ—

### æ€§èƒ½è¦æ±‚
- âœ… 1000 æ¬¡äº‹ä»¶å¤„ç† < 10msï¼ˆå•çº¿ç¨‹ï¼‰
- âœ… 100 ä¸ªå®ä½“åŒæ—¶å¤„ç†äº‹ä»¶æ— æ˜æ˜¾å¡é¡¿
- âœ… æ— å†…å­˜æ³„æ¼

### ä»£ç è´¨é‡
- âœ… ç¼–è¯‘é€šè¿‡ï¼Œæ— è­¦å‘Š
- âœ… å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
- âœ… ä»£ç ç¬¦åˆé¡¹ç›®è§„èŒƒ
- âœ… æœ‰æ¸…æ™°çš„æ³¨é‡Šå’Œæ—¥å¿—

---

## ç›¸å…³æ–‡æ¡£

- [äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿè®¾è®¡](Event-Queue-System%20äº‹ä»¶é˜Ÿåˆ—ç³»ç»Ÿ.md) - æŠ€æœ¯æ–¹æ¡ˆ
- [å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•](../../02-CombatSystem%20æˆ˜æ–—ç³»ç»Ÿ/æŠ€èƒ½æ•ˆæœ/Hit-Reaction-Progress%20å—å‡»ä¸å‡»é€€å¼€å‘è¿›å±•.md) - ç¬¬ä¸€ä¸ªåº”ç”¨åœºæ™¯
- [ECCç³»ç»Ÿ](../ECC/ECC-System%20ECCç»“æ„è¯´æ˜.md) - åŸºç¡€æ¶æ„

