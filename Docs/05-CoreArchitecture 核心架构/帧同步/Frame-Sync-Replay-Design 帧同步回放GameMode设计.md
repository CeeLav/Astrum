@å¸§åŒæ­¥

# å¸§åŒæ­¥å›æ”¾ GameMode è®¾è®¡

> ğŸ“– **ç‰ˆæœ¬**: v1.0 | ğŸ“… **æœ€åæ›´æ–°**: 2025-11-23  
> ğŸ‘¥ **é¢å‘è¯»è€…**: å®¢æˆ·ç«¯å¸§åŒæ­¥å¼€å‘ã€æœåŠ¡å™¨æˆ˜æ–—è®°å½•/çŠ¶æ€å¿«ç…§å¼€å‘  
> ğŸ¯ **ç›®æ ‡**: åŸºäºç°æœ‰å¸§åŒæ­¥ä¸å¿«ç…§æœºåˆ¶ï¼Œå®ç°å¯æ’­æ”¾/æš‚åœ/æ‹–åŠ¨è¿›åº¦çš„æˆ˜æ–—å›æ”¾ GameMode

**TL;DR**
- å›æ”¾åŸºäº**ä¸–ç•Œå¿«ç…§ + å¸§è¾“å…¥å†å²**ï¼Œä¸é‡æ–°å‘æ˜çŠ¶æ€ä¿å­˜æœºåˆ¶ï¼Œç›´æ¥å¤ç”¨ `StateSnapshotManager` äº§ç‰©  
- æœåŠ¡å™¨åœ¨æˆ˜æ–—è¿‡ç¨‹ä¸­ç»Ÿä¸€è®°å½•ï¼šå‘¨æœŸæ€§ä¸–ç•Œå¿«ç…§ `S(n)` + æ¯å¸§è¾“å…¥ `H(n)`ï¼Œæˆ˜æ–—ç»“æŸåæ‰“åŒ…æˆå•ä¸€å›æ”¾æ–‡ä»¶  
- å®¢æˆ·ç«¯å¢åŠ  `ReplayGameMode`ï¼šåŠ è½½æŒ‡å®šå›æ”¾æ–‡ä»¶ï¼Œä½¿ç”¨ä¸“ç”¨ `ReplayLSController` æŒ‰å½•åˆ¶è¾“å…¥æ¨è¿›é€»è¾‘  
- **ReplayLSController**ï¼šä¸“é—¨ç”¨äºå›æ”¾åœºæ™¯ï¼Œæ— éœ€é¢„æµ‹/RTTè¡¥å¿/å›æ»šï¼Œä»…æŒ‰å›ºå®šé€Ÿåº¦æ¨è¿›ï¼Œæ”¯æŒè·³è½¬  
- æ’­æ”¾/æš‚åœï¼šä»…åˆ‡æ¢æ—¶é—´æ¨è¿›ä¸å¦ï¼Œä¸æ”¹å˜é€»è¾‘å¸§åºåˆ—  
- æ‹–åŠ¨/å€’é€€ï¼šæŸ¥æ‰¾ç›®æ ‡å¸§ä¹‹å‰æœ€è¿‘å¿«ç…§ `S(k)`ï¼ŒåŠ è½½å¿«ç…§åä» `k+1` å¿«é€Ÿé‡ç®—åˆ°ç›®æ ‡å¸§  
- å›æ”¾æœŸé—´å…³é—­ç½‘ç»œä¾èµ–ï¼Œæ‰€æœ‰å¸§è¾“å…¥æ¥è‡ªæœ¬åœ°æ–‡ä»¶ï¼Œä¿è¯ä¸å®æˆ˜ç»“æœ**ç¡®å®šæ€§ä¸€è‡´**

---

## 1. æ¦‚è¿°

æˆ˜æ–—å›æ”¾éœ€è¦åœ¨å®¢æˆ·ç«¯ä»¥**ç¦»çº¿æ–¹å¼**é‡æ¼”ä¸€å±€æˆ˜æ–—å…¨è¿‡ç¨‹ï¼Œå¹¶æ”¯æŒï¼š

- **æŒ‡å®šæ–‡ä»¶å›æ”¾**ï¼šä»æœåŠ¡ç«¯ä¸‹è½½æˆ–æœ¬åœ°é€‰æ‹©ä¸€ä»½æˆ˜æ–—è®°å½•æ–‡ä»¶è¿›è¡Œå›æ”¾  
- **åŸºæœ¬æ§åˆ¶**ï¼šæ’­æ”¾ / æš‚åœ / åœæ­¢ / æ‹–åŠ¨è¿›åº¦æ¡ï¼ˆæ”¯æŒå‰åä»»æ„è·³è½¬ï¼‰  
- **ç¡®å®šæ€§ä¸€è‡´**ï¼šåŒä¸€å›æ”¾æ–‡ä»¶åœ¨ä»»æ„å®¢æˆ·ç«¯æ’­æ”¾ï¼Œç»“æœå¸§çŠ¶æ€ä¸æœåŠ¡å™¨æˆ˜æ–—ç»“æŸçŠ¶æ€ä¸€è‡´  

æœ¬æ–¹æ¡ˆåŸºäº `Frame-Sync-State-Sync-Design å¸§åŒæ­¥çŠ¶æ€åŒæ­¥ä¸æ¢å¤æœºåˆ¶è®¾è®¡.md` ä¸­å·²ç»å®šä¹‰çš„ï¼š

- æœåŠ¡å™¨**æƒå¨ä¸–ç•Œå¿«ç…§**ï¼š`World` çš„ MemoryPack å¿«ç…§ï¼Œå‘¨æœŸæ€§ä¿å­˜  
- æ¯å¸§è¾“å…¥å†å² `H(t)`ï¼šç”¨äºæ–­çº¿é‡è¿å’ŒçŠ¶æ€æ¢å¤  

å›æ”¾ä»…åœ¨æ­¤åŸºç¡€ä¸Šå¢åŠ ï¼š

- æˆ˜æ–—æœŸé—´åœ¨æœåŠ¡å™¨ä¾§**æ”¶é›†å¹¶æŒä¹…åŒ–**è¯¥æˆ¿é—´çš„å¿«ç…§ä¸å¸§è¾“å…¥  
- æˆ˜æ–—ç»“æŸæ—¶ç”Ÿæˆ**å•ä¸€å›æ”¾æ–‡ä»¶**ï¼ˆå¯ä¸‹è½½/åˆ†å‘ï¼‰  
- å®¢æˆ·ç«¯å¢åŠ  `ReplayGameMode`ï¼Œä¸ä¾èµ–ç½‘ç»œã€åªæ¶ˆè´¹å›æ”¾æ–‡ä»¶æ•°æ®é©±åŠ¨ä¸“ç”¨ `ReplayLSController`ã€‚

---

## 2. æ•´ä½“æ¶æ„è®¾è®¡

### 2.1 ç»„ä»¶å…³ç³»ï¼ˆå½•åˆ¶ç«¯ + å›æ”¾ç«¯ï¼‰

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Serverï¼ˆæƒå¨ï¼‰                        â”‚
â”‚                                                             â”‚
â”‚  FrameSyncManager      StateSnapshotManager                 â”‚
â”‚        â”‚                         â”‚                          â”‚
â”‚        â””â”€â”€â”€â”€â–º BattleReplayRecorder â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                              â”‚                         â”‚   â”‚
â”‚                              â–¼                         â”‚   â”‚
â”‚                      BattleReplayFileï¼ˆå†…å­˜ç»“æ„ï¼‰       â”‚   â”‚
â”‚                              â”‚                         â”‚   â”‚
â”‚                              â–¼                         â”‚   â”‚
â”‚                        å›æ”¾æ–‡ä»¶ï¼ˆç£ç›˜ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Clientï¼ˆUnityï¼‰                        â”‚
â”‚                                                             â”‚
â”‚  ReplayUIï¼ˆè¿›åº¦æ¡/æŒ‰é’®ï¼‰                                    â”‚
â”‚        â”‚                                                    â”‚
â”‚        â–¼                                                    â”‚
â”‚  ReplayGameMode -----------------------------------------â”  â”‚
â”‚        â”‚                                                 â”‚  â”‚
â”‚        â–¼                                                 â”‚  â”‚
â”‚  ReplayTimelineï¼ˆå›æ”¾æ—¶é—´çº¿/ç´¢å¼•ï¼‰                       â”‚  â”‚
â”‚        â”‚                                                 â”‚  â”‚
â”‚        â–¼                                                 â”‚  â”‚
â”‚  ReplayLSControllerï¼ˆå›æ”¾ä¸“ç”¨å¸§åŒæ­¥æ§åˆ¶å™¨ï¼‰              â”‚  â”‚
â”‚        â”‚                                                 â”‚  â”‚
â”‚        â–¼                                                 â”‚  â”‚
â”‚  World / ViewSyncï¼ˆé€»è¾‘æ‰§è¡Œ + è§†å›¾æ›´æ–°ï¼‰                  â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµï¼ˆé«˜å±‚ï¼‰

```text
ã€å®æˆ˜å½•åˆ¶ã€‘
å®¢æˆ·ç«¯è¾“å…¥ I(t) â”€â–º æœåŠ¡å™¨ FrameSyncManager
                         â”‚
                         â”œâ”€â–º StateSnapshotManagerï¼šæŒ‰å‘¨æœŸ SaveWorldSnapshot(S(t))
                         â””â”€â–º BattleReplayRecorderï¼šè®°å½• S(t) & H(t)

æˆ˜æ–—ç»“æŸ â”€â–º BattleReplayRecorder.Finish(roomId)
         â””â”€â–º ç”Ÿæˆ BattleReplayFileï¼ˆå†…å­˜ï¼‰
             â””â”€â–º åºåˆ—åŒ–åˆ°ç£ç›˜å›æ”¾æ–‡ä»¶

ã€å®¢æˆ·ç«¯å›æ”¾ã€‘
é€‰æ‹©å›æ”¾æ–‡ä»¶ â”€â–º ReplayGameMode.Load(filePath)
             â””â”€â–º ååºåˆ—åŒ– BattleReplayFile â†’ ReplayTimeline
             â””â”€â–º ä»èµ·å§‹å¿«ç…§ S(start) è£…è½½ World åˆ° ReplayLSController
             â””â”€â–º æœ¬åœ° Tick() è¯»å– H(t) é©±åŠ¨é€»è¾‘å¸§ï¼ˆæ— ç½‘ç»œï¼‰
```

---

## 3. æœåŠ¡å™¨å½•åˆ¶è®¾è®¡

### 3.1 å½•åˆ¶å†…å®¹

å½•åˆ¶ç›®æ ‡æ˜¯ï¼Œä½¿å®¢æˆ·ç«¯åœ¨**ä¸ä¾èµ–æœåŠ¡å™¨**çš„æƒ…å†µä¸‹ï¼Œä»…å‡­å›æ”¾æ–‡ä»¶å³å¯æ¢å¤å®Œæ•´æˆ˜æ–—è¿‡ç¨‹ï¼š

- **ä¸–ç•Œå¿«ç…§åºåˆ—**ï¼š`WorldSnapshot` åˆ—è¡¨ï¼Œè‡³å°‘åŒ…å«ï¼š
  - ç¬¬ 0 å¸§å¿«ç…§ï¼ˆæˆ˜æ–—å¼€å§‹ï¼‰  
  - ä¹‹åæŒ‰é…ç½®å‘¨æœŸï¼ˆä¾‹å¦‚æ¯ 10 å¸§ï¼‰ç”Ÿæˆçš„å¿«ç…§ `S(n)`  
- **å¸§è¾“å…¥å†å²**ï¼šæ¯ä¸€é€»è¾‘å¸§çš„ `OneFrameInputs` æˆ–ç­‰ä»·ç»“æ„ `H(n)`  
  - åŒ…å«æ‰€æœ‰ç©å®¶åœ¨è¯¥å¸§çš„è¾“å…¥  
  - å¯¹åº”æœåŠ¡å™¨æƒå¨å¸§æ¨è¿›ä½¿ç”¨çš„çœŸå®æ•°æ®  

### 3.2 BattleReplayRecorderï¼ˆæœåŠ¡å™¨ï¼‰

**èŒè´£**ï¼šç»‘å®šåˆ°å•ä¸ªæˆ¿é—´ï¼Œå¯¹æˆ˜æ–—å…¨ç¨‹è¿›è¡Œå½•åˆ¶ï¼Œå¹¶åœ¨æˆ˜æ–—ç»“æŸæ—¶ç”Ÿæˆä¸€ä¸ª `BattleReplayFile`ã€‚

- **åˆ›å»ºæ—¶æœº**ï¼š
  - `FrameSyncManager.StartRoomFrameSync(roomId)` æ—¶ï¼Œä¸ºè¯¥æˆ¿é—´åˆ›å»º `BattleReplayRecorder` å®ä¾‹  
- **é”€æ¯æ—¶æœº**ï¼š
  - æˆ¿é—´æˆ˜æ–—ç»“æŸï¼ˆç»“ç®—å®Œæˆ/é”€æ¯ `Room`ï¼‰æ—¶è°ƒç”¨ `Finish()`ï¼Œå¹¶é‡Šæ”¾å¼•ç”¨  

**ä¼ªæ¥å£ç¤ºä¾‹ï¼ˆé€»è¾‘ï¼‰ï¼š**

```csharp
public sealed class BattleReplayRecorder
{
    public void OnWorldSnapshot(WorldSnapshot snapshot);   // æ¥è‡ª StateSnapshotManager
    public void OnFrameInputs(int frame, OneFrameInputs inputs); // æ¥è‡ª FrameSyncManager

    public BattleReplayFile Finish();                      // æˆ˜æ–—ç»“æŸæ—¶ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶ç»“æ„
}
```

é›†æˆç‚¹ï¼š

- `StateSnapshotManager.SaveWorldSnapshot(roomId, frame, world)` æˆåŠŸåå›è°ƒ `OnWorldSnapshot`  
- `FrameSyncManager` åœ¨å¹¿æ’­æŸå¸§ `OneFrameInputs` æ—¶ï¼Œè°ƒç”¨ `OnFrameInputs` è¿›è¡Œè®°å½•  

### 3.3 å›æ”¾æ–‡ä»¶ç»“æ„ï¼ˆé€»è¾‘å±‚ï¼‰

å›æ”¾æ–‡ä»¶çš„é€»è¾‘ç»“æ„ä»…åœ¨æ–‡æ¡£ä¸­çº¦å®šï¼Œå…·ä½“å®ç°ä»ä½¿ç”¨ MemoryPack/Proto ç­‰ç°æœ‰åºåˆ—åŒ–æ–¹æ¡ˆã€‚

```csharp
public sealed class BattleReplayFile
{
    public int Version;              // å›æ”¾æ ¼å¼ç‰ˆæœ¬ï¼Œæ”¯æŒåç»­å…¼å®¹
    public string RoomId;
    public int TickRate;             // å¸§ç‡ï¼Œä¿è¯æ’­æ”¾èŠ‚å¥ä¸€è‡´
    public int TotalFrames;          // æˆ˜æ–—ç»“æŸæ—¶çš„æœ€ç»ˆå¸§
    public long StartTimestamp;      // æˆ˜æ–—èµ·å§‹ UTC æ—¶é—´
    public int RandomSeed;           // è¯¥æˆ˜æ–—ä½¿ç”¨çš„éšæœºç§å­ï¼ˆç¡®ä¿ç¡®å®šæ€§ï¼‰

    public List<ReplayPlayerInfo> Players;      // ç©å®¶åˆ—è¡¨ï¼ˆåç§°/èŒä¸šç­‰å±•ç¤ºç”¨ï¼‰
    public List<ReplaySnapshot> Snapshots;      // ä¸–ç•Œå¿«ç…§ S(n)
    public List<ReplayFrameInputs> FrameInputs; // å¸§è¾“å…¥åºåˆ— H(n)
}

public sealed class ReplaySnapshot
{
    public int Frame;                // å¿«ç…§å¯¹åº”çš„é€»è¾‘å¸§å·
    public byte[] WorldData;         // GZip(MemoryPack(World))ï¼Œä¸ StateSnapshotManager ä¿æŒä¸€è‡´
}

public sealed class ReplayFrameInputs
{
    public int Frame;                // å¸§å·
    public byte[] InputsData;        // å¯¹åº” OneFrameInputs çš„åºåˆ—åŒ–ç»“æœï¼ˆProto/MemoryPack å‡å¯ï¼‰
}
```

**çº¦æŸä¸çº¦å®šï¼š**

- `Snapshots` æŒ‰ `Frame` å‡åºå­˜å‚¨ï¼Œç¬¬ä¸€ä¸ªå¿…é¡»æ˜¯ç¬¬ 0 å¸§æˆ–èµ·å§‹å¸§  
- `FrameInputs` è‡³å°‘è¦†ç›– `[startFrame, TotalFrames]` åŒºé—´çš„æ‰€æœ‰å¸§  
- å›æ”¾æ–‡ä»¶ä»…ä½œä¸º**æˆ˜æ–—è®°å½•å¿«ç…§**ï¼Œä¸å‚ä¸åœ¨çº¿é€»è¾‘ï¼Œé¿å…å½±å“ç”Ÿäº§é“¾è·¯  

---

## 4. å®¢æˆ·ç«¯å›æ”¾ GameMode è®¾è®¡

### 4.1 ReplayGameModeï¼ˆæ ¸å¿ƒå…¥å£ï¼‰

**ä½ç½®ï¼ˆè§„åˆ’ï¼‰**ï¼š`AstrumProj/Assets/Script/AstrumClient/Managers/GameModes/ReplayGameMode.cs`

**èŒè´£**ï¼š

- ä»æŒ‡å®šè·¯å¾„åŠ è½½å›æ”¾æ–‡ä»¶å¹¶æ„å»º `ReplayTimeline`  
- åˆ›å»º/åˆå§‹åŒ–æœ¬åœ° `ReplayLSController` ä¸é€»è¾‘ä¸–ç•Œ `World`  
- é©±åŠ¨æœ¬åœ°é€»è¾‘å¸§æ¨è¿›ï¼ˆä¸ä¾èµ–ç½‘ç»œï¼‰ï¼Œæ§åˆ¶æ’­æ”¾/æš‚åœ/è·³è½¬  
- ä¸ `ReplayUI` å¯¹æ¥ï¼šæ›´æ–°è¿›åº¦æ¡ã€å½“å‰æ—¶é—´ã€çŠ¶æ€ï¼ˆæ’­æ”¾/æš‚åœï¼‰  

**å…³é”®çŠ¶æ€ï¼š**

- `BattleReplayFile _replayData`  
- `ReplayTimeline _timeline`  
- `ReplayLSController _lsController`  
- `int _currentFrame`  
- `bool _isPlaying`  

### 4.2 ReplayTimelineï¼ˆæ—¶é—´çº¿ä¸ç´¢å¼•ï¼‰

**èŒè´£**ï¼šå°è£… `BattleReplayFile`ï¼Œæä¾›æŒ‰å¸§å·æŸ¥è¯¢è¾“å…¥ä¸å¿«ç…§çš„èƒ½åŠ›ã€‚

- æ ¹æ® `ReplaySnapshot.Frame` æ„å»ºæœ‰åºåˆ—è¡¨ï¼Œæ”¯æŒäºŒåˆ†æŸ¥æ‰¾æœ€è¿‘å¿«ç…§ï¼š
  - `GetNearestSnapshot(frame)` â†’ è¿”å› `frame0 <= frame` ä¸”è·ç¦»æœ€è¿‘çš„å¿«ç…§  
- ä¸º `FrameInputs` æä¾›å¿«é€Ÿè®¿é—®ï¼š
  - å†…éƒ¨ä½¿ç”¨ `Dictionary<int, ReplayFrameInputs>` æˆ–ç¨€ç–æ•°ç»„  
- æä¾›åŸºç¡€ä¿¡æ¯ï¼š`TotalFrames`ã€`TickRate`ã€èµ·å§‹å¸§ç­‰  

### 4.3 ReplayLSControllerï¼ˆå›æ”¾ä¸“ç”¨å¸§åŒæ­¥æ§åˆ¶å™¨ï¼‰

**ä½ç½®ï¼ˆè§„åˆ’ï¼‰**ï¼š`AstrumProj/Assets/Script/AstrumLogic/Core/ReplayLSController.cs`

**èŒè´£**ï¼šä¸“é—¨ç”¨äºå›æ”¾åœºæ™¯çš„å¸§åŒæ­¥æ§åˆ¶å™¨ï¼Œå®ç° `ILSControllerBase` æ¥å£ã€‚

**ä¸ ClientLSController çš„åŒºåˆ«**ï¼š

| ç‰¹æ€§ | ClientLSController | ReplayLSController |
|------|-------------------|-------------------|
| **é¢„æµ‹å¸§** | âœ… éœ€è¦ï¼ˆRTTè¡¥å¿ï¼‰ | âŒ ä¸éœ€è¦ï¼ˆè¾“å…¥å·²ç¡®å®šï¼‰ |
| **å›æ»šæœºåˆ¶** | âœ… éœ€è¦ï¼ˆæœåŠ¡å™¨çº æ­£ï¼‰ | âŒ ä¸éœ€è¦ï¼ˆè¾“å…¥å·²ç¡®å®šï¼‰ |
| **RTTè¡¥å¿** | âœ… éœ€è¦ï¼ˆç½‘ç»œå»¶è¿Ÿï¼‰ | âŒ ä¸éœ€è¦ï¼ˆç¦»çº¿å›æ”¾ï¼‰ |
| **è¾“å…¥æ¥æº** | ç½‘ç»œ + æœ¬åœ°é¢„æµ‹ | å›æ”¾æ–‡ä»¶ |
| **æ—¶é—´æ¨è¿›** | åŸºäºæœåŠ¡å™¨æ—¶é—´+RTT | åŸºäºå›ºå®šTickRate |
| **è·³è½¬æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… æ”¯æŒï¼ˆåŠ è½½å¿«ç…§åå¿«é€Ÿæ¨è¿›ï¼‰ |

**æ ¸å¿ƒæ–¹æ³•**ï¼š

```csharp
public class ReplayLSController : ILSControllerBase
{
    // åŸºç¡€æ¥å£å®ç°
    public Room Room { get; set; }
    public int AuthorityFrame { get; set; }
    public FrameBuffer FrameBuffer { get; }
    public int TickRate { get; set; }
    public bool IsPaused { get; set; }
    public bool IsRunning { get; }
    
    // å›æ”¾ä¸“ç”¨æ–¹æ³•
    /// <summary>
    /// è®¾ç½®å½“å‰å¸§çš„è¾“å…¥ï¼ˆä»å›æ”¾æ–‡ä»¶è¯»å–ï¼‰
    /// </summary>
    public void SetFrameInputs(int frame, OneFrameInputs inputs);
    
    /// <summary>
    /// æŒ‰å›ºå®šé€Ÿåº¦æ¨è¿›ä¸€å¸§ï¼ˆæ— RTTè¡¥å¿ï¼Œæ— é¢„æµ‹ï¼‰
    /// </summary>
    public void Tick();
    
    /// <summary>
    /// å¿«é€Ÿæ¨è¿›åˆ°æŒ‡å®šå¸§ï¼ˆç”¨äºè·³è½¬ï¼‰
    /// </summary>
    public void FastForwardTo(int targetFrame, ReplayTimeline timeline);
}
```

**Tick() å®ç°é€»è¾‘**ï¼š

```csharp
public void Tick()
{
    if (!IsRunning || IsPaused || Room == null) return;
    
    // å›æ”¾åœºæ™¯ï¼šæŒ‰å›ºå®šæ—¶é—´é—´éš”æ¨è¿›ï¼Œæ— éœ€RTTè¡¥å¿
    long currentTime = TimeInfo.Instance.ServerNow();
    long frameTime = CreationTime + (AuthorityFrame + 1) * LSConstValue.UpdateInterval;
    
    if (currentTime >= frameTime)
    {
        // ä»å›æ”¾æ–‡ä»¶è·å–è¯¥å¸§è¾“å…¥ï¼ˆç”± ReplayGameMode æå‰è®¾ç½®ï¼‰
        OneFrameInputs inputs = FrameBuffer.FrameInputs(AuthorityFrame + 1);
        if (inputs != null)
        {
            AuthorityFrame++;
            Room.FrameTick(inputs);
        }
    }
}
```

**FastForwardTo() å®ç°é€»è¾‘**ï¼ˆç”¨äºæ‹–åŠ¨/è·³è½¬ï¼‰ï¼š

```csharp
public void FastForwardTo(int targetFrame, ReplayTimeline timeline)
{
    // 1. åŠ è½½æœ€è¿‘å¿«ç…§
    var snapshot = timeline.GetNearestSnapshot(targetFrame);
    LoadState(snapshot.Frame); // ä»å¿«ç…§æ¢å¤ä¸–ç•ŒçŠ¶æ€
    AuthorityFrame = snapshot.Frame;
    
    // 2. å¿«é€Ÿæ¨è¿›åˆ°ç›®æ ‡å¸§ï¼ˆå…³é—­ä¸­é—´æ¸²æŸ“ï¼‰
    for (int frame = snapshot.Frame + 1; frame <= targetFrame; frame++)
    {
        var inputs = timeline.GetFrameInputs(frame);
        if (inputs != null)
        {
            SetFrameInputs(frame, inputs);
            AuthorityFrame = frame;
            Room.FrameTick(inputs);
            // å¯é€‰ï¼šè·³è¿‡è§†å›¾æ›´æ–°ï¼Œä»…åœ¨æœ€ååŒæ­¥ä¸€æ¬¡
        }
    }
    
    // 3. å¼ºåˆ¶åŒæ­¥è§†å›¾
    // ForceSyncView();
}
```

**è®¾è®¡è¦ç‚¹**ï¼š

- **ç®€åŒ–é€»è¾‘**ï¼šç§»é™¤æ‰€æœ‰é¢„æµ‹ã€å›æ»šã€RTTè¡¥å¿ç›¸å…³ä»£ç ï¼Œåªä¿ç•™æ ¸å¿ƒå¸§æ¨è¿›é€»è¾‘  
- **ç¡®å®šæ€§ä¿è¯**ï¼šè¾“å…¥å®Œå…¨æ¥è‡ªå›æ”¾æ–‡ä»¶ï¼Œç¡®ä¿ä¸æœåŠ¡å™¨æˆ˜æ–—ç»“æœä¸€è‡´  
- **æ€§èƒ½ä¼˜åŒ–**ï¼šè·³è½¬æ—¶æ”¯æŒå…³é—­ä¸­é—´å¸§æ¸²æŸ“ï¼Œä»…åœ¨ç›®æ ‡å¸§åŒæ­¥è§†å›¾  
- **æ¥å£å…¼å®¹**ï¼šå®ç° `ILSControllerBase`ï¼Œå¯è¢« `Room` ç»Ÿä¸€ç®¡ç†

### 4.4 å›æ”¾æ’­æ”¾å¾ªç¯

**é€»è¾‘å¸§æ¨è¿›**ï¼š

- `ReplayGameMode.Tick(deltaTime)` ä¸­ï¼Œæ ¹æ® `TickRate` å°†çœŸå®æ—¶é—´æ˜ å°„ä¸ºç›®æ ‡é€»è¾‘å¸§ï¼š
  - `targetFrame = startFrame + floor(elapsedTime * TickRate)`  
- å½“ `_isPlaying == true` æ—¶ï¼š
  - é€å¸§ä» `_currentFrame+1` æ¨è¿›åˆ° `targetFrame`ï¼š
    - å¯¹äºæ¯ä¸ª `frame`ï¼š
      - ä» `_timeline` å–å‡º `ReplayFrameInputs`ï¼Œè½¬ä¸º `OneFrameInputs` è°ƒç”¨ `_lsController.SetFrameInputs(frame, inputs)`  
      - è°ƒç”¨ `_lsController.Tick()` æ¨è¿›ä¸€å¸§é€»è¾‘  
  - é€»è¾‘å¸§æ¨è¿›å®Œæ¯•åï¼Œè§¦å‘è§†å›¾åŒæ­¥ï¼ˆæ²¿ç”¨ç°æœ‰é€»è¾‘ï¼Œä¾‹å¦‚ Worldâ†’View çš„åŒæ­¥ç³»ç»Ÿï¼‰  

**æš‚åœ**ï¼š

- å°† `_isPlaying` ç½®ä¸º `false`ï¼Œ`Tick()` ä»æ›´æ–° UI æ—¶é—´æ˜¾ç¤ºä½†ä¸å†æ¨è¿›é€»è¾‘å¸§ã€‚  

---

## 5. æ‹–åŠ¨/å›é€€è®¾è®¡ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

### 5.1 éœ€æ±‚æ‹†è§£

- **æ‹–åŠ¨è¿›åº¦æ¡**ï¼šç”¨æˆ·å¯å°†è¿›åº¦æ¡æ‹–åˆ°ä»»æ„æ—¶é—´ç‚¹/å¸§å·  
- **å›é€€**ï¼šä»è¾ƒå¤§çš„å¸§è·³å›è¾ƒå°çš„å¸§ï¼Œä¸å…è®¸ç›´æ¥â€œå€’ç€è¿ç®—â€  
- æ€§èƒ½è¦æ±‚ï¼šæ‹–åŠ¨å“åº”åº”åœ¨å¯æ¥å—æ—¶é—´å†…å®Œæˆï¼Œä¸å‡ºç°é•¿æ—¶é—´å¡æ­»  

### 5.2 åŸºæœ¬ç­–ç•¥

æ‹–åŠ¨æˆ–å›é€€æ—¶ç»Ÿä¸€é‡‡ç”¨ï¼š**â€œæœ€è¿‘å¿«ç…§ + å‘å‰é‡æ”¾â€** ç­–ç•¥ï¼š

1. è®¡ç®—ç›®æ ‡å¸§ `targetFrame`ï¼ˆç”± UI è½¬æ¢è‡ªè¿›åº¦æ¡ç™¾åˆ†æ¯”ï¼‰  
2. è°ƒç”¨ `_lsController.FastForwardTo(targetFrame, _timeline)`ï¼š
   - å†…éƒ¨è‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘å¿«ç…§å¹¶åŠ è½½
   - å¿«é€Ÿæ¨è¿›åˆ°ç›®æ ‡å¸§ï¼ˆå¯é€‰å…³é—­ä¸­é—´æ¸²æŸ“ï¼‰
   - åœ¨ç›®æ ‡å¸§å¼ºåˆ¶åŒæ­¥è§†å›¾  
3. æ›´æ–° `_currentFrame = targetFrame`  
4. æ›´æ–°è¿›åº¦æ¡å’Œå½“å‰æ—¶é—´æ˜¾ç¤º  

### 5.3 ä¼ªæµç¨‹

```text
OnSeek(float normalizedProgress)
    targetFrame = (int)(normalizedProgress * _timeline.TotalFrames)
    
    // ReplayLSController å†…éƒ¨å¤„ç†å¿«ç…§åŠ è½½å’Œå¿«é€Ÿæ¨è¿›
    _lsController.FastForwardTo(targetFrame, _timeline)
    _currentFrame = targetFrame
    
    // æ›´æ–°UIæ˜¾ç¤º
    UpdateProgressUI()
```

**è¯´æ˜ï¼š**

- å¿«ç…§é—´éš”ï¼ˆä¾‹å¦‚æ¯ 10 å¸§ï¼‰ä¼šç›´æ¥å½±å“ Seek æ€§èƒ½ï¼šé—´éš”è¶Šå°ï¼Œæ‹–åŠ¨æ—¶éœ€è¦é‡ç®—çš„å¸§æ•°è¶Šå°‘ï¼Œä½†æ–‡ä»¶å˜å¤§  
- å¯åœ¨ `Frame-Sync-State-Sync-Design` ä¸­ç»Ÿä¸€é…ç½®å¿«ç…§å‘¨æœŸï¼Œé¿å…ä¸¤å¥—ç­–ç•¥ä¸ä¸€è‡´  

---

## 6. UI äº¤äº’ä¸ GameMode é›†æˆ

### 6.1 ReplayUI ä¸ ReplayGameMode åè®®

UI å±‚åªå…³å¿ƒâ€œæ—¶é—´â€ä¸â€œæ§åˆ¶â€ï¼Œä¸ç›´æ¥æ¥è§¦å…·ä½“å¸§åŒæ­¥ç»†èŠ‚ï¼š

- `Play()` / `Pause()` / `Stop()`  
- `Seek(float normalized)`ï¼š0~1ï¼Œå¯¹åº” 0~TotalFrames  
- `OnLoaded(BattleReplayFileInfo info)`ï¼šæ˜¾ç¤ºå¯¹å±€æ—¶é•¿ã€å¯¹å±€åŒæ–¹ä¿¡æ¯ç­‰  

`ReplayGameMode` å¯¹å¤–æš´éœ²ï¼š

- `float Progress { get; }`ï¼šå½“å‰è¿›åº¦ 0~1  
- `float DurationSeconds { get; }`ï¼šæ€»æ—¶é•¿ï¼ˆåŸºäº `TotalFrames / TickRate`ï¼‰  
- `bool IsPlaying { get; }`  

### 6.2 ä¸ç°æœ‰ GameMode/FrameSyncHandler çš„å…³ç³»

- å›æ”¾ GameMode ä¸‹ï¼š
  - ä¸å†é€šè¿‡ç½‘ç»œæ¥æ”¶ `FrameSyncStartNotification` / `OneFrameInputs`  
  - `FrameSyncHandler` ä¸å‚ä¸å›æ”¾é€»è¾‘ï¼Œé¿å…ä¸çœŸå®åœ¨çº¿å¸§åŒæ­¥æ··ç”¨  
  - ä½¿ç”¨ä¸“ç”¨çš„ `ReplayLSController`ï¼Œè€Œé `ClientLSController`ï¼Œé¿å…é¢„æµ‹/å›æ»šé€»è¾‘å¹²æ‰°  
  - `Room` åˆ›å»ºæ—¶æŒ‡å®šä½¿ç”¨ `ReplayLSController` å®ä¾‹  
- é€šè¿‡ GameModeFactoryï¼ˆè‹¥å­˜åœ¨ï¼‰æ–°å¢ä¸€ç§æ¨¡å¼ï¼š`Replay`ï¼Œä»å›æ”¾å…¥å£åœºæ™¯æˆ–è§‚æˆ˜ç•Œé¢è¿›å…¥ã€‚  

---

## 7. å…³é”®å†³ç­–ä¸å–èˆï¼ˆç®€è¦ï¼‰

- **é—®é¢˜**ï¼šæ‹–åŠ¨/å›é€€å¦‚ä½•ä¿è¯æ€§èƒ½ä¸ä¸€è‡´æ€§ï¼Ÿ  
  - **å¤‡é€‰**ï¼š
    - A. æ¯å¸§éƒ½åšå®Œæ•´å¿«ç…§ â†’ æ‹–åŠ¨æ— é‡ç®—ï¼Œä½†æ–‡ä»¶å·¨å¤§  
    - B. å›ºå®šå‘¨æœŸå¿«ç…§ + ä» 0 å¸§é‡ç®— â†’ æ–‡ä»¶å¯æ§ï¼Œä½†æ‹–åŠ¨è¶Šé åéœ€è¦é‡ç®—è¶Šä¹…  
    - C. å›ºå®šå‘¨æœŸå¿«ç…§ + æœ€è¿‘å¿«ç…§é‡ç®— â†’ åœ¨æ–‡ä»¶å¤§å°ä¸æ‹–åŠ¨æ€§èƒ½ä¹‹é—´æŠ˜ä¸­  
  - **é€‰æ‹©**ï¼šCï¼Œé‡‡ç”¨å‘¨æœŸæ€§å¿«ç…§ + æœ€è¿‘å¿«ç…§é‡ç®—ç­–ç•¥ï¼Œä¸æ–­çº¿é‡è¿è®¾è®¡ä¿æŒä¸€è‡´  
  - **å½±å“**ï¼š
    - æ–‡ä»¶å¤§å°ä¸å·²æœ‰å¿«ç…§ç­–ç•¥ä¸€è‡´ï¼Œæ— é¢å¤–æ•°é‡çº§å¢é•¿  
    - æ‹–åŠ¨æ€§èƒ½å¯é€šè¿‡ç»Ÿä¸€è°ƒæ•´å¿«ç…§å‘¨æœŸä¸å‹ç¼©ç­–ç•¥è¿›è¡Œæ§åˆ¶  

- **é—®é¢˜**ï¼šå›æ”¾é€»è¾‘æ”¾åœ¨å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡å™¨ï¼Ÿ  
  - **é€‰æ‹©**ï¼šå®Œå…¨åœ¨å®¢æˆ·ç«¯æœ¬åœ°å¤æ¼”ï¼ŒæœåŠ¡å™¨åªè´Ÿè´£äº§ç”Ÿå›æ”¾æ–‡ä»¶ï¼Œä¸å‚ä¸å…·ä½“å›æ”¾è¿‡ç¨‹  
  - **å½±å“**ï¼šå‡è½»æœåŠ¡å™¨å‹åŠ›ï¼ŒåŒæ—¶é¿å…åœ¨çº¿é€»è¾‘ä¸å›æ”¾é€»è¾‘è€¦åˆã€‚

- **é—®é¢˜**ï¼šå›æ”¾æ˜¯å¦å¤ç”¨ ClientLSControllerï¼Ÿ  
  - **å¤‡é€‰**ï¼š
    - A. å¤ç”¨ ClientLSControllerï¼Œé€šè¿‡é…ç½®ç¦ç”¨é¢„æµ‹/å›æ»š â†’ ä»£ç è€¦åˆï¼Œé€»è¾‘å¤æ‚  
    - B. åˆ›å»ºä¸“ç”¨ ReplayLSControllerï¼Œç®€åŒ–é€»è¾‘ â†’ èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤  
  - **é€‰æ‹©**ï¼šBï¼Œåˆ›å»º `ReplayLSController` ä¸“é—¨å¤„ç†å›æ”¾åœºæ™¯  
  - **å½±å“**ï¼š
    - ä»£ç æ›´æ¸…æ™°ï¼Œå›æ”¾é€»è¾‘ä¸åœ¨çº¿é€»è¾‘å®Œå…¨éš”ç¦»  
    - æ€§èƒ½æ›´å¥½ï¼Œæ— éœ€æ‰§è¡Œæ— ç”¨çš„é¢„æµ‹/å›æ»šé€»è¾‘  
    - æ˜“äºæ‰©å±•ï¼Œå›æ”¾ä¸“ç”¨åŠŸèƒ½ï¼ˆå¦‚è·³è½¬ï¼‰ä¸ä¼šå½±å“åœ¨çº¿é€»è¾‘  

---

## 8. ç›¸å…³æ–‡æ¡£ä¸è¿½æº¯

- ä¸Šæ¸¸è®¾è®¡ï¼š`Frame-Sync-Mechanism å¸§åŒæ­¥æœºåˆ¶.md`  
- ä¸Šæ¸¸è®¾è®¡ï¼š`Frame-Sync-State-Sync-Design å¸§åŒæ­¥çŠ¶æ€åŒæ­¥ä¸æ¢å¤æœºåˆ¶è®¾è®¡.md`  
- ç›¸å…³é‡æ„ï¼š`LSController-Refactor-Design LSControlleré‡æ„è®¾è®¡.md`  
- è®¡åˆ’è½åœ°ä»£ç ï¼ˆç¤ºä¾‹è·¯å¾„ï¼‰ï¼š
  - å®¢æˆ·ç«¯ï¼š`AstrumProj/Assets/Script/AstrumClient/Managers/GameModes/ReplayGameMode.cs`  
  - å®¢æˆ·ç«¯ï¼š`AstrumProj/Assets/Script/AstrumClient/Managers/GameModes/ReplayTimeline.cs`  
  - å®¢æˆ·ç«¯ï¼š`AstrumProj/Assets/Script/AstrumLogic/Core/ReplayLSController.cs`  
  - æœåŠ¡å™¨ï¼š`AstrumServer/.../FrameSync/BattleReplayRecorder.cs`  

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.1*  
*åˆ›å»ºæ—¶é—´ï¼š2025-11-23*  
*æœ€åæ›´æ–°ï¼š2025-01-27*  
*çŠ¶æ€ï¼šç­–åˆ’æ¡ˆ*  
*Owner*: å¾…å®š  
*å˜æ›´æ‘˜è¦*: æ·»åŠ  ReplayLSController ä¸“ç”¨æ§åˆ¶å™¨è®¾è®¡ï¼Œæ˜ç¡®ä¸ ClientLSController çš„åŒºåˆ«ã€‚


