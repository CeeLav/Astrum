# 实体消息队列预测回滚（阶段二）跨实体预测 · 影子实体哈希对齐

## 背景与目标
- 阶段二在阶段一基础上继续“预测其他实体”（远端/队友/敌人）以获得零延迟交互。
- 目标：为需预测的其他实体创建影子实体在预测帧执行交互，与对应权威实体对齐哈希；不一致回滚影子并重放，一致后收敛销毁。

## 术语
- 权威帧：服务器确认的帧编号。
- 预测帧：客户端本地超前执行的帧编号。
- 影子实体：为交互预测创建的镜像实体，独立状态、与权威实体同配置。

## 关键点
- 为“被预测的其他实体”创建影子实体（建议影子ID：`shadowId = -entityId`，与阶段一自影子规则一致），影子在预测帧消费跨实体交互消息；权威实体按权威帧推进。
- 当权威帧追平预测帧，对同帧状态做关键字段哈希比对。
- 不一致：影子回滚到权威帧，用备份消息/输入重放到该帧；一致：影子减速收敛并销毁。

## 数据结构
- 影子实体：共享配置（组件/静态数据），独立状态快照与预测消息队列。
- 哈希字段建议：位置/朝向、速度、动作/技能状态、可见公共属性（血量、buff 标识）；可按场景扩展。
- 生命周期：创建→预测执行→比对→（回滚重放|收敛销毁）。

## 流程
1) 触发：命中类/强交互事件进入白名单时，为被作用的其他实体创建影子实体并接收预测消息分片。
2) 预测执行：影子按预测帧消费消息，与本地发起者保持时序一致。
3) 对齐：当权威帧=F，计算影子/权威帧 F 哈希：
   - 一致：进入收敛，逐帧插值/减速回到权威状态，完成后销毁影子。
   - 不一致：影子回滚到权威帧快照 → 用备份消息/输入重放到帧 F → 重新比对；若持续不一致，降级为延迟消费模式。

## 策略与参数
- 触发白名单：仅对需体感零延迟的技能/交互开启“预测他人”影子；可按场景开关。
- 影子上限：限制并发影子数，防止 CPU/内存暴涨。
- 比对节奏：默认每权威帧比对一次；必要时可抽样。

## 风险与缓解
- 性能开销：并发上限+生命周期管理；收敛后立即销毁。
- 哈希误判/漏判：调优字段集；对高频动作可增加采样；误报过多时降级。
- 频繁不一致：可降级关闭“预测他人”，退回阶段一（仅自影子）。

## 回滚触发与无输入实体
- 回滚触发以权威帧为批次，不因同一帧多条第三方输入重复回滚。
- 无玩家输入的实体（纯 AI/环境）保持权威驱动，不参与影子创建。

## 与现有模块衔接（建议）
- FrameSyncHandler：帧号分发、权威帧推进、回滚触发点。
- WorldSnapshotStart/Chunk：权威快照输入，用于回滚基准和状态校正。
- 消息定义：对战消息携带帧戳字段；分发侧根据 entityId 路由分片，影子实体消费预测分片。

## 验证与测试
- 单元/组件：哈希比对、影子回滚重放、收敛销毁流程。
- 集成/E2E：跨实体命中影子回滚场景、频繁不一致的降级路径。
- 观测：日志/统计输出影子创建/销毁、比对结果、不一致次数、降级次数、影子数量峰值。

