# AstrumTest é¡¹ç›®æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

### å½“å‰å­˜åœ¨çš„é—®é¢˜
1. **æµ‹è¯•æ¡†æ¶æ··ç”¨** - åŒæ—¶ä½¿ç”¨ Xunit å’Œ NUnit
2. **å•ä¾‹çŠ¶æ€æ±¡æŸ“** - ConfigManagerã€ArchetypeManager ç­‰å•ä¾‹åœ¨æµ‹è¯•é—´å…±äº«
3. **æµ‹è¯•æ–‡ä»¶ç®¡ç†æ··ä¹±** - å¤§é‡ .bak æ–‡ä»¶ï¼Œæµ‹è¯•æ•£è½åœ¨ä¸åŒç›®å½•
4. **ç¼ºå°‘éš”ç¦»æœºåˆ¶** - æµ‹è¯•é—´ç›¸äº’å½±å“ï¼Œä¸€ä¸ªå¤±è´¥å¯¼è‡´è¿é”å¤±è´¥
5. **é¡¹ç›®ç»“æ„é‡å¤** - å­˜åœ¨ä¸¤ä¸ª AstrumTest.csproj

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šæŒ‰é¢†åŸŸæ‹†åˆ† + ç»Ÿä¸€æ¡†æ¶

### æ–¹æ¡ˆæ¶æ„

```
AstrumTest/
â”œâ”€â”€ AstrumTest.Common/              # é€šç”¨æµ‹è¯•åŸºç¡€è®¾æ–½
â”‚   â”œâ”€â”€ TestBase.cs                 # æµ‹è¯•åŸºç±»
â”‚   â”œâ”€â”€ TestFixture.cs              # Fixture æ¨¡å¼
â”‚   â””â”€â”€ Mocks/                      # Mock å¯¹è±¡
â”‚
â”œâ”€â”€ AstrumTest.Logic/               # é€»è¾‘å±‚æµ‹è¯•ï¼ˆç‹¬ç«‹é¡¹ç›®ï¼‰
â”‚   â”œâ”€â”€ SkillSystemTests.cs
â”‚   â”œâ”€â”€ EntitySystemTests.cs
â”‚   â””â”€â”€ PhysicsTests/
â”‚       â”œâ”€â”€ TypeConverterTests.cs
â”‚       â””â”€â”€ HitManagerTests.cs
â”‚
â”œâ”€â”€ AstrumTest.Network/             # ç½‘ç»œå±‚æµ‹è¯•ï¼ˆç‹¬ç«‹é¡¹ç›®ï¼‰
â”‚   â”œâ”€â”€ ProtocolSerializationTests.cs
â”‚   â””â”€â”€ NetworkCommunicationTests.cs
â”‚
â””â”€â”€ AstrumTest.Integration/         # é›†æˆæµ‹è¯•ï¼ˆç‹¬ç«‹é¡¹ç›®ï¼‰
    â”œâ”€â”€ ServerIntegrationTests.cs
    â””â”€â”€ RoomSystemTests.cs
```

### ä¼˜åŠ¿
âœ… **å®Œå…¨éš”ç¦»** - æ¯ä¸ªæµ‹è¯•é¡¹ç›®ç‹¬ç«‹è¿è¡Œï¼Œäº’ä¸å¹²æ‰°  
âœ… **æ¸…æ™°åˆ†ç±»** - æŒ‰åŠŸèƒ½é¢†åŸŸåˆ’åˆ†ï¼Œæ˜“äºç»´æŠ¤  
âœ… **ç‹¬ç«‹ä¾èµ–** - å„é¡¹ç›®åªå¼•ç”¨éœ€è¦çš„ä¾èµ–  
âœ… **å¹¶è¡Œæ‰§è¡Œ** - å¯ä»¥å¹¶è¡Œè¿è¡Œä¸åŒæµ‹è¯•é¡¹ç›®  

---

## ğŸ”§ å®æ–½æ­¥éª¤

### Step 1: ç»Ÿä¸€æµ‹è¯•æ¡†æ¶ï¼ˆé€‰æ‹© Xunitï¼‰

**ç†ç”±**ï¼š
- Xunit æ˜¯ .NET ç°ä»£æµ‹è¯•æ¡†æ¶æ ‡å‡†
- æ›´å¥½çš„å¹¶è¡Œæ”¯æŒ
- æ›´æ¸…æ™°çš„æµ‹è¯•éš”ç¦»æœºåˆ¶

**æ“ä½œ**ï¼š
```bash
# ç§»é™¤ NUnit ä¾èµ–
dotnet remove package NUnit
dotnet remove package NUnit.Analyzers
dotnet remove package NUnit3TestAdapter

# å·²æœ‰ Xunitï¼Œæ— éœ€é¢å¤–å®‰è£…
```

### Step 2: åˆ›å»ºæµ‹è¯•åŸºç±»ï¼ˆè§£å†³å•ä¾‹æ±¡æŸ“ï¼‰

**åˆ›å»º**: `AstrumTest.Common/TestBase.cs`

```csharp
using System;
using System.IO;
using Xunit;
using Astrum.LogicCore.Managers;

namespace AstrumTest.Common
{
    /// <summary>
    /// æµ‹è¯•åŸºç±» - æä¾›éš”ç¦»çš„æµ‹è¯•ç¯å¢ƒ
    /// </summary>
    public abstract class TestBase : IDisposable
    {
        protected string TestConfigPath { get; private set; }
        
        protected TestBase()
        {
            // æ¯ä¸ªæµ‹è¯•åˆ›å»ºç‹¬ç«‹çš„é…ç½®è·¯å¾„
            TestConfigPath = Path.Combine(
                Path.GetTempPath(), 
                $"AstrumTest_{Guid.NewGuid()}"
            );
            
            SetupTestEnvironment();
        }
        
        /// <summary>
        /// è®¾ç½®æµ‹è¯•ç¯å¢ƒï¼ˆå­ç±»å¯è¦†ç›–ï¼‰
        /// </summary>
        protected virtual void SetupTestEnvironment()
        {
            // åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨ï¼ˆä½¿ç”¨ä¸´æ—¶è·¯å¾„ï¼‰
            var configPath = GetConfigPath();
            if (!string.IsNullOrEmpty(configPath))
            {
                ConfigManager.Instance.Initialize(configPath);
            }
        }
        
        /// <summary>
        /// è·å–é…ç½®è·¯å¾„ï¼ˆå­ç±»å¯è¦†ç›–ï¼‰
        /// </summary>
        protected virtual string GetConfigPath()
        {
            var root = Path.GetFullPath(
                Path.Combine(AppContext.BaseDirectory, "..", "..", "..", "..", "..")
            );
            return Path.Combine(root, "AstrumConfig", "Tables", "output", "Client");
        }
        
        /// <summary>
        /// æ¸…ç†æµ‹è¯•ç¯å¢ƒ
        /// </summary>
        public virtual void Dispose()
        {
            CleanupTestEnvironment();
            
            // æ¸…ç†ä¸´æ—¶ç›®å½•
            if (Directory.Exists(TestConfigPath))
            {
                try
                {
                    Directory.Delete(TestConfigPath, true);
                }
                catch
                {
                    // å¿½ç•¥æ¸…ç†å¤±è´¥
                }
            }
        }
        
        /// <summary>
        /// æ¸…ç†æµ‹è¯•ç¯å¢ƒï¼ˆå­ç±»å¯è¦†ç›–ï¼‰
        /// </summary>
        protected virtual void CleanupTestEnvironment()
        {
            // é‡ç½®å•ä¾‹çŠ¶æ€ï¼ˆå¦‚æœå¯èƒ½ï¼‰
            // æ³¨æ„ï¼šæŸäº›å•ä¾‹å¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
        }
    }
}
```

### Step 3: ä½¿ç”¨ Collection Fixture éš”ç¦»æµ‹è¯•

**åˆ›å»º**: `AstrumTest.Common/DatabaseFixture.cs`

```csharp
using System;
using System.IO;
using Astrum.LogicCore.Managers;

namespace AstrumTest.Common
{
    /// <summary>
    /// æ•°æ®åº“/é…ç½® Fixture - åœ¨æµ‹è¯•é›†åˆé—´å…±äº«ï¼Œä½†ä¸è·¨é›†åˆ
    /// </summary>
    public class ConfigFixture : IDisposable
    {
        public string ConfigPath { get; private set; }
        
        public ConfigFixture()
        {
            // ä¸€æ¬¡æ€§åˆå§‹åŒ–é…ç½®
            var root = Path.GetFullPath(
                Path.Combine(AppContext.BaseDirectory, "..", "..", "..", "..", "..")
            );
            ConfigPath = Path.Combine(root, "AstrumConfig", "Tables", "output", "Client");
            
            ConfigManager.Instance.Initialize(ConfigPath);
        }
        
        public void Dispose()
        {
            // æ¸…ç†å…±äº«èµ„æº
        }
    }
    
    /// <summary>
    /// æ ‡è®°æµ‹è¯•é›†åˆ - åŒä¸€é›†åˆçš„æµ‹è¯•å…±äº« Fixtureï¼Œä½†ä¸²è¡Œæ‰§è¡Œ
    /// </summary>
    [CollectionDefinition("Config Collection")]
    public class ConfigCollection : ICollectionFixture<ConfigFixture>
    {
        // è¿™ä¸ªç±»ä»…ç”¨äºæ ‡è®°ï¼Œæ— éœ€å®ç°
    }
}
```

**ä½¿ç”¨**ï¼š

```csharp
using Xunit;
using AstrumTest.Common;

namespace AstrumTest.Logic
{
    /// <summary>
    /// æŠ€èƒ½ç³»ç»Ÿæµ‹è¯• - ä½¿ç”¨å…±äº« ConfigFixture
    /// </summary>
    [Collection("Config Collection")]  // æ ‡è®°ä¸ºé›†åˆæˆå‘˜
    public class SkillSystemTests
    {
        private readonly ConfigFixture _fixture;
        
        public SkillSystemTests(ConfigFixture fixture)
        {
            _fixture = fixture;
        }
        
        [Fact]
        public void GetSkillInfo_Level1_ShouldReturnSkillInfo()
        {
            // ä½¿ç”¨ _fixture.ConfigPath
            // æµ‹è¯•ä»£ç ...
        }
    }
}
```

### Step 4: é‡æ„ç°æœ‰æµ‹è¯•

#### 4.1 ä¿®æ”¹ SkillSystemTests.cs

```csharp
using Xunit;
using AstrumTest.Common;
using Astrum.LogicCore.Managers;

namespace AstrumTest.Logic
{
    [Collection("Config Collection")]
    public class SkillSystemTests
    {
        private readonly ConfigFixture _fixture;
        
        public SkillSystemTests(ConfigFixture fixture)
        {
            _fixture = fixture;
            // ä¸éœ€è¦åœ¨æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ– ConfigManager
            // Fixture å·²ç»åšäº†
        }
        
        // ç§»é™¤ IDisposableï¼Œæ”¹ä¸ºä½¿ç”¨ Fixture
        
        [Fact]
        public void GetSkillInfo_Level1_ShouldReturnSkillInfo()
        {
            // Arrange
            int skillId = 2001;
            int level = 1;
            
            // Act
            var skillInfo = SkillConfigManager.Instance.GetSkillInfo(skillId, level);
            
            // Assert
            Assert.NotNull(skillInfo);
            Assert.Equal(2001, skillInfo.SkillId);
            // ... å…¶ä»–æ–­è¨€
        }
    }
}
```

#### 4.2 ç‰©ç†æµ‹è¯•ï¼ˆæ— éœ€å…±äº«çŠ¶æ€ï¼‰

```csharp
using Xunit;
using TrueSync;
using Astrum.LogicCore.Physics;

namespace AstrumTest.Physics
{
    /// <summary>
    /// ç±»å‹è½¬æ¢æµ‹è¯• - æ— çŠ¶æ€ï¼Œå¯å¹¶è¡Œæ‰§è¡Œ
    /// </summary>
    public class TypeConverterTests
    {
        // æ— éœ€ Fixture æˆ– Collection
        // æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹æ‰§è¡Œï¼Œæ— å‰¯ä½œç”¨
        
        [Fact]
        public void Test_FP_To_Fix64_Basic()
        {
            // Arrange
            var fp = FP.One;

            // Act
            var fix64 = fp.ToFix64();

            // Assert
            Assert.Equal(fp._serializedValue, fix64.RawValue);
        }
        
        // ... å…¶ä»–æµ‹è¯•
    }
}
```

### Step 5: æ¸…ç†é¡¹ç›®ç»“æ„

**åˆ é™¤å†—ä½™æ–‡ä»¶**ï¼š
```bash
# åˆ é™¤ .bak æ–‡ä»¶
rm AstrumTest/AstrumTest/*.bak

# åˆ é™¤é‡å¤çš„ csprojï¼ˆä¿ç•™æ­£ç¡®çš„é‚£ä¸ªï¼‰
# ç¡®è®¤ AstrumTest/AstrumTest/AstrumTest.csproj æ˜¯ä¸»é¡¹ç›®
```

**ç§»é™¤ Skip æ ‡è®°**ï¼š
```csharp
// ä»è¿™æ ·ï¼š
[Fact(Skip = "Temporarily disabled for robustness tests")]

// æ”¹ä¸ºè¿™æ ·ï¼ˆä¿®å¤åé‡æ–°å¯ç”¨ï¼‰ï¼š
[Fact]
```

### Step 6: æ›´æ–° .csproj æ–‡ä»¶

**AstrumTest.csproj** (ç»Ÿä¸€æ¡†æ¶)ï¼š

```xml
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <LangVersion>latest</LangVersion>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <IsPackable>false</IsPackable>
    <IsTestProject>true</IsTestProject>
  </PropertyGroup>

  <ItemGroup>
    <!-- Xunit æµ‹è¯•æ¡†æ¶ -->
    <PackageReference Include="Microsoft.NET.Test.Sdk" Version="17.14.0" />
    <PackageReference Include="xunit" Version="2.9.0" />
    <PackageReference Include="xunit.runner.visualstudio" Version="2.8.2">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="coverlet.collector" Version="6.0.4">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    
    <!-- ç§»é™¤ NUnit -->
    <!-- <PackageReference Include="NUnit" Version="4.3.2" /> -->
    <!-- <PackageReference Include="NUnit3TestAdapter" Version="5.0.0" /> -->
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\AstrumProj\AstrumLogic.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Using Include="Xunit" />
  </ItemGroup>

</Project>
```

---

## ğŸ¨ æœ€ä½³å®è·µ

### 1. **æµ‹è¯•å‘½åè§„èŒƒ**
```csharp
// æ ¼å¼ï¼šMethodName_Scenario_ExpectedBehavior
[Fact]
public void GetSkillInfo_ValidSkillId_ShouldReturnSkillInfo()

[Fact]
public void GetSkillInfo_InvalidSkillId_ShouldReturnNull()

[Theory]
[InlineData(2001, 1)]
[InlineData(2002, 5)]
public void GetSkillInfo_VariousLevels_ShouldReturnCorrectLevel(int skillId, int level)
```

### 2. **æµ‹è¯•åˆ†ç±»**
```csharp
// ä½¿ç”¨ Trait æ ‡è®°æµ‹è¯•ç±»åˆ«
[Trait("Category", "Unit")]
public class TypeConverterTests { }

[Trait("Category", "Integration")]
public class ServerIntegrationTests { }

// è¿è¡Œæ—¶è¿‡æ»¤
// dotnet test --filter "Category=Unit"
```

### 3. **æµ‹è¯•æ•°æ®ç®¡ç†**
```csharp
// ä½¿ç”¨ Theory + InlineData å‡å°‘é‡å¤
[Theory]
[InlineData(0.0)]
[InlineData(1.0)]
[InlineData(-1.0)]
public void Test_FP_Fix64_Values(double value)
{
    var fp = (FP)(decimal)value;
    var fix64 = fp.ToFix64();
    var back = fix64.ToFP();
    Assert.Equal(fp._serializedValue, back._serializedValue);
}

// ä½¿ç”¨ MemberData å¤„ç†å¤æ‚æ•°æ®
public static IEnumerable<object[]> SkillTestData()
{
    yield return new object[] { 2001, 1, "Rush Slash" };
    yield return new object[] { 2002, 1, "Power Strike" };
}

[Theory]
[MemberData(nameof(SkillTestData))]
public void GetSkillInfo_ValidData_ShouldMatch(int skillId, int level, string name)
{
    var skill = SkillConfigManager.Instance.GetSkillInfo(skillId, level);
    Assert.Equal(name, skill.Name);
}
```

### 4. **Mock ä¾èµ–**
```csharp
// å¯¹äºéš¾ä»¥æµ‹è¯•çš„ä¾èµ–ï¼Œä½¿ç”¨ Moq
// dotnet add package Moq

[Fact]
public void ProcessEntity_WithMockedDependency_ShouldWork()
{
    // Arrange
    var mockConfig = new Mock<IConfigManager>();
    mockConfig.Setup(m => m.GetConfig(It.IsAny<int>()))
              .Returns(new SomeConfig());
    
    // Act
    // ...
}
```

---

## ğŸ“Š æ‰§è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
dotnet test
```

### è¿è¡Œç‰¹å®šé¡¹ç›®
```bash
dotnet test AstrumTest/AstrumTest.csproj
dotnet test AstrumTest/PhysicsTests/PhysicsTests.csproj
```

### è¿è¡Œç‰¹å®šç±»åˆ«
```bash
dotnet test --filter "Category=Unit"
dotnet test --filter "Category=Integration"
```

### å¹¶è¡Œæ‰§è¡Œï¼ˆXunit é»˜è®¤æ”¯æŒï¼‰
```bash
# Xunit ä¼šè‡ªåŠ¨å¹¶è¡Œæ‰§è¡Œä¸åŒç±»çš„æµ‹è¯•
# Collection å†…çš„æµ‹è¯•ä¼šä¸²è¡Œæ‰§è¡Œ
dotnet test --parallel
```

### ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
```bash
dotnet test --logger "trx;LogFileName=TestResults.trx"
dotnet test --logger "html;LogFileName=TestResults.html"
```

---

## ğŸ” å¸¸è§é—®é¢˜è§£å†³

### Q1: æµ‹è¯•ä»ç„¶ç›¸äº’å¹²æ‰°æ€ä¹ˆåŠï¼Ÿ
**A**: æ£€æŸ¥æ˜¯å¦æœ‰ä»¥ä¸‹æƒ…å†µï¼š
1. é™æ€å˜é‡/å•ä¾‹æœªé‡ç½®
2. æ–‡ä»¶ç³»ç»Ÿæ“ä½œæœªæ¸…ç†
3. æ•°æ®åº“è¿æ¥æœªå…³é—­
4. äº‹ä»¶è®¢é˜…æœªå–æ¶ˆ

**è§£å†³**ï¼šåœ¨ Dispose ä¸­å½»åº•æ¸…ç†

### Q2: ConfigManager æ— æ³•é‡ç½®æ€ä¹ˆåŠï¼Ÿ
**A**: ä¸ºå•ä¾‹æ·»åŠ é‡ç½®æ–¹æ³•
```csharp
public class ConfigManager
{
    // æ·»åŠ æµ‹è¯•ä¸“ç”¨é‡ç½®æ–¹æ³•
    #if DEBUG
    internal void ResetForTesting()
    {
        _tables = null;
        _initialized = false;
    }
    #endif
}
```

### Q3: æµ‹è¯•è¿è¡Œå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ
**A**: 
1. ä½¿ç”¨ Collection Fixture å‡å°‘é‡å¤åˆå§‹åŒ–
2. å°†æ…¢é€Ÿæµ‹è¯•æ ‡è®°ä¸º Integration
3. ä½¿ç”¨å¹¶è¡Œæ‰§è¡Œ
4. è€ƒè™‘ä½¿ç”¨ in-memory æ•°æ®åº“

---

## ğŸ“ˆ è¿ç§»è®¡åˆ’

### é˜¶æ®µ 1: ç»Ÿä¸€æ¡†æ¶ï¼ˆ1 å¤©ï¼‰
- [ ] ç§»é™¤ NUnit ä¾èµ–
- [ ] è½¬æ¢ NUnit æµ‹è¯•ä¸º Xunit
- [ ] æ›´æ–° csproj æ–‡ä»¶

### é˜¶æ®µ 2: å»ºç«‹åŸºç¡€è®¾æ–½ï¼ˆ1 å¤©ï¼‰
- [ ] åˆ›å»º TestBase åŸºç±»
- [ ] åˆ›å»º Fixture ç±»
- [ ] æ·»åŠ é€šç”¨æµ‹è¯•å·¥å…·

### é˜¶æ®µ 3: é‡æ„ç°æœ‰æµ‹è¯•ï¼ˆ2-3 å¤©ï¼‰
- [ ] é‡æ„ SkillSystemTests
- [ ] é‡æ„ PhysicsTests
- [ ] é‡æ–°å¯ç”¨ .bak æµ‹è¯•

### é˜¶æ®µ 4: æ‹†åˆ†é¡¹ç›®ï¼ˆå¯é€‰ï¼Œ1-2 å¤©ï¼‰
- [ ] åˆ›å»ºç‹¬ç«‹æµ‹è¯•é¡¹ç›®
- [ ] è¿ç§»æµ‹è¯•ä»£ç 
- [ ] éªŒè¯éš”ç¦»æ•ˆæœ

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

å®æ–½ååº”è¯¥è¾¾åˆ°ï¼š
âœ… **é›¶å¹²æ‰°** - æµ‹è¯•å¯ä»¥ä»»æ„é¡ºåºæ‰§è¡Œ  
âœ… **é«˜é€Ÿåº¦** - å¹¶è¡Œæ‰§è¡Œï¼Œå‡å°‘ç­‰å¾…  
âœ… **æ˜“ç»´æŠ¤** - æ¸…æ™°çš„ç»“æ„å’Œå‘½å  
âœ… **é«˜å¯é ** - æµ‹è¯•ç»“æœç¨³å®šå¯é‡å¤  

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-10  
**çŠ¶æ€**: å¾…å®æ–½ ğŸ“‹

