# 集成测试 - 伤害计算分析

## 📊 当前伤害计算公式

### 硬编码属性（临时值）

```csharp
// DamageCalculator.cs (当前简化版本)
GetEntityAttack()    => 100f   // 固定100攻击
GetEntityDefense()   => 20f    // 固定20防御
GetEntityCritRate()  => 0.2f   // 固定20%暴击率
GetEntityCritDamage() => 2.0f   // 固定2倍暴击伤害
```

### 技能效果配置

**技能ID 3001 → SkillEffectID 4022**:
- EffectType: 1 (伤害)
- EffectValue: 10.0 (表示10%攻击力)
- DamageType: Physical (物理伤害)

### 伤害计算流程

```
步骤1: 基础伤害 = 攻击力 × (效果值 / 100)
       = 100 × (10.0 / 100) = 10.0

步骤2: 暴击判定 (20%概率)
       - 不暴击: 10.0
       - 暴击: 10.0 × 2.0 = 20.0

步骤3: 防御减免 = 防御 / (防御 + 100)
       = 20 / (20 + 100) = 0.1667 (16.67%减伤)
       
       应用防御后:
       - 不暴击: 10.0 × (1 - 0.1667) = 8.33
       - 暴击: 20.0 × (1 - 0.1667) = 16.67

步骤4: 随机浮动 [0.95, 1.05]
       - 不暴击: 8.33 × [0.95, 1.05] = [7.91, 8.75]
       - 暴击: 16.67 × [0.95, 1.05] = [15.84, 17.50]

步骤5: 最终伤害 (取整)
       - 不暴击: 8 点伤害 (约90%概率)
       - 暴击: 16 点伤害 (约20%概率)
```

## ✅ 测试验证结果

### Frame 30 测试结果
```
骑士2血量: 500 → 492 (-8点伤害)
```

**验证通过 ✓**
- 伤害值 = 8 点
- 符合不暴击预期范围 [7.91, 8.75]
- 游戏逻辑正确

### 测试用例预期值

```json
{
  "comment": "技能命中验证",
  "expectedOutputs": {
    "knight2_hp": {"min": 482, "max": 493}
  }
}
```

**预期范围说明**:
- 不暴击伤害: 8 点 → 血量 492
- 暴击伤害: 16 点 → 血量 484
- 考虑随机浮动: 482~493

## 🔄 技能命中时机分析

### 技能生效延迟

根据测试结果：
- Frame 10: 骑士1 施放技能
- Frame 30: 骑士2 受到伤害 (**20帧延迟**)

### 反击未命中问题

**观察结果**:
- Frame 60: 骑士2 施放反击技能
- Frame 80: 骑士1 血量仍为 500 (**未受到伤害**)

**可能原因**:
1. ✅ 技能需要更多帧才能命中（>20帧）
2. ⚠️ 技能碰撞判定问题
3. ⚠️ 技能朝向/距离问题

### 解决方案

将 Frame 80 的验证延后到 **Frame 90** 或 **Frame 100**，给技能更多时间生效。

## 🎯 配置表数据参考

### 角色属性 (RoleId: 1001)
```csv
Id: 1001
Name: 骑士
Type: 平衡型近战角色
BaseAttack: 10.0   (配置值，未使用)
BaseDefense: 8.0   (配置值，未使用)
CritRate: 0.10     (配置值，未使用)
```

### 技能动作 (ActionId: 3001)
```csv
Id: 3001
Name: attack_01
Type: skill
Duration: 20 帧
Animation: OneHand_Base_Attack_C_3_InPlace.anim
```

### 技能配置链路
```
SkillId 3001 (普通攻击)
  ↓
SkillTable 2001
  ↓
SkillActionTable 3001 (碰撞检测帧: Frame10)
  ↓
SkillEffectTable 4022 (伤害: 10%攻击力)
```

## 📝 待办事项

### 短期 (测试框架)
- [x] 验证伤害计算公式
- [x] 调整测试用例预期值
- [ ] 修复 Frame 80 反击验证问题
- [ ] 添加暴击测试用例

### 中期 (游戏逻辑)
- [ ] 将硬编码属性值替换为配置系统
- [ ] 实现完整的属性系统 (StatComponent)
- [ ] 验证技能碰撞时机准确性

### 长期 (测试覆盖)
- [ ] 添加防御力变化测试
- [ ] 添加暴击率测试
- [ ] 添加属性克制测试
- [ ] 添加多目标伤害测试

