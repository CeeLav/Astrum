# æˆ¿é—´ç³»ç»Ÿé‡æ„è®¾è®¡

> ğŸ“– **ç‰ˆæœ¬**: v1.0 | **æœ€åæ›´æ–°**: 2025-01-27  
> ğŸ¯ **é€‚ç”¨èŒƒå›´**: æœåŠ¡å™¨ç«¯æˆ¿é—´ç³»ç»Ÿä¸å¸§åŒæ­¥æ¶æ„é‡æ„  
> ğŸ‘¥ **é¢å‘è¯»è€…**: æœåŠ¡å™¨å¼€å‘äººå‘˜  
> âœ… **ç›®æ ‡**: å®Œæˆæˆ¿é—´ç³»ç»Ÿé¢å‘å¯¹è±¡é‡æ„ï¼Œå®ç° RoomManager ç®¡ç†æˆ¿é—´å®ä¾‹ï¼Œæ¯ä¸ªæˆ¿é—´ç‹¬ç«‹ç®¡ç†å¸§åŒæ­¥ä¸æˆ˜æ–—é€»è¾‘

**TL;DR**
- RoomManager ç®¡ç† Room å®ä¾‹ï¼ˆè€Œé RoomInfoï¼‰
- æ¯ä¸ª Room å®ä¾‹ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„å¸§åŒæ­¥é€»è¾‘å’Œæˆ˜æ–—é€»è¾‘
- FrameSyncManager ç®€åŒ–ä¸ºæˆ¿é—´å¸§åŒæ­¥çš„åè°ƒå™¨
- ä½¿ç”¨é¢å‘å¯¹è±¡æ–¹å¼ç»„ç»‡ä»£ç ï¼Œæé«˜å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§

## 1. æ¦‚è¿°

å½“å‰æœåŠ¡å™¨æ¶æ„ä¸­ï¼Œæˆ¿é—´ç®¡ç†å’Œå¸§åŒæ­¥é€»è¾‘è€¦åˆä¸¥é‡ï¼š
- `RoomManager` åªç®¡ç† `RoomInfo` æ•°æ®ï¼Œä¸ç®¡ç†æˆ¿é—´å®ä¾‹
- `FrameSyncManager` æ‰¿æ‹…äº†æ‰€æœ‰æˆ¿é—´çš„å¸§åŒæ­¥é€»è¾‘ï¼ŒèŒè´£è¿‡é‡
- æˆ¿é—´çš„å¸§åŒæ­¥çŠ¶æ€ï¼ˆ`RoomFrameSyncState`ï¼‰ä¸æˆ¿é—´ä¿¡æ¯åˆ†ç¦»
- æˆ˜æ–—é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªåœ°æ–¹ï¼Œéš¾ä»¥ç»´æŠ¤

é‡æ„ç›®æ ‡ï¼š
- **èŒè´£åˆ†ç¦»**ï¼šRoomManager ç®¡ç†æˆ¿é—´å®ä¾‹ï¼Œæ¯ä¸ªæˆ¿é—´ç®¡ç†è‡ªå·±çš„é€»è¾‘
- **é¢å‘å¯¹è±¡**ï¼šä½¿ç”¨ Room ç±»å°è£…æˆ¿é—´çš„æ‰€æœ‰çŠ¶æ€å’Œè¡Œä¸º
- **å¯æ‰©å±•æ€§**ï¼šä¾¿äºåç»­æ·»åŠ æˆ¿é—´ç±»å‹ã€æ¸¸æˆæ¨¡å¼ç­‰åŠŸèƒ½

**è®¾è®¡ç†å¿µ**:
- å•ä¸€èŒè´£ï¼šæ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®çš„èŒè´£
- å°è£…ï¼šæˆ¿é—´ç›¸å…³çš„æ‰€æœ‰é€»è¾‘å°è£…åœ¨ Room ç±»ä¸­
- ä¾èµ–æ³¨å…¥ï¼šRoom é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¶å¿…è¦çš„ä¾èµ–

**ç³»ç»Ÿè¾¹ç•Œ**:
- âœ… è´Ÿè´£ï¼šæˆ¿é—´ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€å¸§åŒæ­¥é€»è¾‘ã€æˆ˜æ–—é€»è¾‘
- âŒ ä¸è´Ÿè´£ï¼šç½‘ç»œæ¶ˆæ¯å¤„ç†ã€ç”¨æˆ·ç®¡ç†ã€åŒ¹é…ç³»ç»Ÿ

## 2. æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GameServer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ RoomManager  â”‚  â”‚ UserManager  â”‚  â”‚ NetworkMgr   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                â”‚
â”‚         â”‚ ç®¡ç† Room å®ä¾‹                                  â”‚
â”‚         â–¼                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Room (æˆ¿é—´å®ä¾‹)                      â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  RoomInfo (æˆ¿é—´ä¿¡æ¯)                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Id, Name, Status                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Players, MaxPlayers                      â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  GameSession (æ¸¸æˆä¼šè¯)                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - AuthorityFrame                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - LogicRoom                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - InputBuffer                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - ProcessFrame()                          â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  LogicRoom (é€»è¾‘æˆ¿é—´)                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - World, LSController                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - FrameTick()                             â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç±»è®¾è®¡

#### RoomManagerï¼ˆæˆ¿é—´ç®¡ç†å™¨ï¼‰

**èŒè´£**: ç®¡ç†æ‰€æœ‰æˆ¿é—´å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸ

**æ ¸å¿ƒåŠŸèƒ½**:
- åˆ›å»ºæˆ¿é—´å®ä¾‹
- æŸ¥æ‰¾æˆ¿é—´å®ä¾‹
- é”€æ¯æˆ¿é—´å®ä¾‹
- è·å–æˆ¿é—´åˆ—è¡¨

**è®¾è®¡è¦ç‚¹**:
- ä½¿ç”¨ `ConcurrentDictionary<string, Room>` å­˜å‚¨æˆ¿é—´å®ä¾‹
- æˆ¿é—´IDä½œä¸ºå”¯ä¸€æ ‡è¯†
- æä¾›çº¿ç¨‹å®‰å…¨çš„æˆ¿é—´æ“ä½œæ¥å£

```csharp
public class RoomManager
{
    private readonly ConcurrentDictionary<string, Room> _rooms = new();
    
    // åˆ›å»ºæˆ¿é—´
    public Room CreateRoom(string creatorId, string roomName, int maxPlayers);
    
    // è·å–æˆ¿é—´
    public Room? GetRoom(string roomId);
    
    // é”€æ¯æˆ¿é—´
    public bool DestroyRoom(string roomId);
    
    // è·å–æ‰€æœ‰æˆ¿é—´
    public IEnumerable<Room> GetAllRooms();
}
```

#### Roomï¼ˆæˆ¿é—´å®ä¾‹ï¼‰

**èŒè´£**: å°è£…æˆ¿é—´çš„æ‰€æœ‰çŠ¶æ€å’Œè¡Œä¸º

**æ ¸å¿ƒåŠŸèƒ½**:
- ç®¡ç†æˆ¿é—´ä¿¡æ¯ï¼ˆRoomInfoï¼‰
- ç®¡ç†ç©å®¶åˆ—è¡¨
- ç®¡ç†å¸§åŒæ­¥é€»è¾‘
- ç®¡ç†æˆ˜æ–—é€»è¾‘ï¼ˆLogicRoomï¼‰
- å¤„ç†æˆ¿é—´çŠ¶æ€è½¬æ¢

**è®¾è®¡è¦ç‚¹**:
- å°è£…æˆ¿é—´çš„æ‰€æœ‰çŠ¶æ€
- æä¾›æˆ¿é—´æ“ä½œçš„ç»Ÿä¸€æ¥å£
- å†…éƒ¨ç®¡ç†å¸§åŒæ­¥å’Œæˆ˜æ–—é€»è¾‘

```csharp
public class Room
{
    // æˆ¿é—´ä¿¡æ¯
    public RoomInfo Info { get; private set; }
    
    // æ¸¸æˆä¼šè¯
    private GameSession? _gameSession;
    
    // ç©å®¶åˆ—è¡¨
    private readonly List<string> _playerIds = new();
    
    // ä¾èµ–æ³¨å…¥
    private readonly ServerNetworkManager _networkManager;
    private readonly UserManager _userManager;
    
    // æ„é€ å‡½æ•°
    public Room(
        RoomInfo roomInfo,
        ServerNetworkManager networkManager,
        UserManager userManager)
    {
        Info = roomInfo;
        _networkManager = networkManager;
        _userManager = userManager;
        _gameSession = new GameSession(this, networkManager, userManager);
    }
    
    // ç©å®¶ç®¡ç†
    public bool AddPlayer(string userId);
    public bool RemovePlayer(string userId);
    
    // æ¸¸æˆæ§åˆ¶
    public void StartGame();
    public void EndGame(string reason);
    
    // æ¸¸æˆä¼šè¯
    public void Update(); // ç”± RoomManager ç»Ÿä¸€è°ƒç”¨
    public void HandleInput(string userId, SingleInput input);
    
    // çŠ¶æ€æŸ¥è¯¢
    public bool IsActive { get; }
    public bool IsPlaying { get; }
}
```

#### GameSessionï¼ˆæ¸¸æˆä¼šè¯ï¼‰

**èŒè´£**: ç®¡ç†å•ä¸ªæˆ¿é—´çš„æ¸¸æˆé€»è¾‘å’Œå¸§åŒæ­¥

**æ ¸å¿ƒåŠŸèƒ½**:
- ç®¡ç†é€»è¾‘æˆ¿é—´ï¼ˆLogicRoomï¼‰
- ç®¡ç†å¸§å·ï¼ˆAuthorityFrameï¼‰
- æ”¶é›†å’Œç¼“å­˜è¾“å…¥æ•°æ®
- æ¨è¿›å¸§é€»è¾‘
- å‘é€å¸§åŒæ­¥æ•°æ®

**è®¾è®¡è¦ç‚¹**:
- ä» FrameSyncManager ä¸­æå–å‡ºæ¥ï¼Œä½œä¸º Room çš„å†…éƒ¨ç»„ä»¶
- å°è£…æ¸¸æˆé€»è¾‘å’Œå¸§åŒæ­¥ç›¸å…³çš„æ‰€æœ‰é€»è¾‘
- æŒæœ‰ LogicRoomï¼Œç®¡ç†æ•´ä¸ªæ¸¸æˆä¼šè¯
- é€šè¿‡ Room è®¿é—®ç½‘ç»œå’Œç”¨æˆ·ç®¡ç†

```csharp
public class GameSession
{
    private readonly ServerRoom _room;
    
    // é€»è¾‘æˆ¿é—´
    public Astrum.LogicCore.Core.Room? LogicRoom { get; private set; }
    
    // å¸§åŒæ­¥çŠ¶æ€
    public int AuthorityFrame { get; private set; }
    public long StartTime { get; private set; }
    public bool IsActive { get; private set; }
    
    // è¾“å…¥ç¼“å†²åŒº
    private readonly Dictionary<int, Dictionary<long, LSInput>> _frameInputs = new();
    
    // ç©å®¶IDæ˜ å°„
    private readonly Dictionary<string, long> _userIdToPlayerId = new();
    
    public GameSession(ServerRoom room, ServerNetworkManager networkManager, UserManager userManager)
    {
        _room = room;
        _networkManager = networkManager;
        _userManager = userManager;
    }
    
    // å¼€å§‹æ¸¸æˆä¼šè¯
    public void Start();
    
    // åœæ­¢æ¸¸æˆä¼šè¯
    public void Stop(string reason);
    
    // æ›´æ–°å¸§ï¼ˆç”± Room.Update è°ƒç”¨ï¼‰
    public void Update();
    
    // å¤„ç†è¾“å…¥
    public void HandleInput(string userId, SingleInput input);
    
    // å¤„ç†å•å¸§
    private void ProcessFrame();
}
```

### 2.3 æ•°æ®æµ

#### æˆ¿é—´åˆ›å»ºæµç¨‹

```
GameServer.HandleCreateRoomRequest()
    â†“
RoomManager.CreateRoom()
    â†“
new Room(roomInfo, networkManager, userManager)
    â†“
Room åˆå§‹åŒ–å®Œæˆï¼Œè¿”å›ç»™ GameServer
```

#### å¸§åŒæ­¥æµç¨‹

```
GameServer.Update()
    â†“
    RoomManager.UpdateAllRooms()
    â†“
foreach Room in _rooms:
    Room.Update()
        â†“
    GameSession.Update()
        â†“
    ProcessFrame()
        â†“
    LogicRoom.FrameTick()
        â†“
    SendFrameSyncData()
```

#### è¾“å…¥å¤„ç†æµç¨‹

```
GameServer.HandleSingleInput()
    â†“
RoomManager.GetRoom(roomId)
    â†“
Room.HandleInput(userId, input)
    â†“
GameSession.HandleInput(userId, input)
    â†“
å­˜å‚¨åˆ°è¾“å…¥ç¼“å†²åŒº
```

## 3. å®ç°ç»†èŠ‚

### 3.1 RoomManager é‡æ„

**å½“å‰å®ç°**:
- ç®¡ç† `RoomInfo` æ•°æ®
- æä¾›æˆ¿é—´ä¿¡æ¯æŸ¥è¯¢æ¥å£

**é‡æ„å**:
- ç®¡ç† `Room` å®ä¾‹
- æä¾›æˆ¿é—´å®ä¾‹çš„åˆ›å»ºã€æŸ¥æ‰¾ã€é”€æ¯æ¥å£
- ç»Ÿä¸€è°ƒç”¨æ‰€æœ‰æˆ¿é—´çš„ `Update()` æ–¹æ³•

**å…³é”®å˜æ›´**:
```csharp
// ä¹‹å‰
private readonly ConcurrentDictionary<string, RoomInfo> _rooms = new();

// ä¹‹å
private readonly ConcurrentDictionary<string, Room> _rooms = new();
```

### 3.2 Room ç±»å®ç°

**æ ¸å¿ƒæ–¹æ³•**:

1. **æ„é€ å‡½æ•°**: åˆå§‹åŒ–æˆ¿é—´ä¿¡æ¯ã€å¸§åŒæ­¥æ§åˆ¶å™¨ã€é€»è¾‘æˆ¿é—´
2. **AddPlayer**: æ·»åŠ ç©å®¶åˆ°æˆ¿é—´
3. **RemovePlayer**: ä»æˆ¿é—´ç§»é™¤ç©å®¶
4. **StartGame**: å¼€å§‹æ¸¸æˆï¼Œåˆå§‹åŒ–å¸§åŒæ­¥
5. **EndGame**: ç»“æŸæ¸¸æˆï¼Œåœæ­¢å¸§åŒæ­¥
6. **Update**: æ›´æ–°æˆ¿é—´çŠ¶æ€ï¼ˆç”± RoomManager è°ƒç”¨ï¼‰
7. **HandleInput**: å¤„ç†ç©å®¶è¾“å…¥

**çŠ¶æ€ç®¡ç†**:
- æˆ¿é—´çŠ¶æ€é€šè¿‡ `RoomInfo.Status` ç®¡ç†
- å¸§åŒæ­¥çŠ¶æ€é€šè¿‡ `GameSession.IsActive` ç®¡ç†
- æ¸¸æˆé€»è¾‘çŠ¶æ€é€šè¿‡ `LogicRoom` ç®¡ç†

### 3.3 GameSession å®ç°

**ä» FrameSyncManager æå–çš„é€»è¾‘**:
- `RoomFrameSyncState` çš„æ‰€æœ‰å­—æ®µå’Œæ–¹æ³•
- LogicRoom çš„åˆ›å»ºå’Œç®¡ç†
- å¸§è¾“å…¥ç¼“å†²å’Œæ”¶é›†é€»è¾‘
- å¸§æ¨è¿›é€»è¾‘
- å¸§æ•°æ®å‘é€é€»è¾‘

**ä¿ç•™åœ¨ FrameSyncManager çš„é€»è¾‘**:
- å…¨å±€å¸§åŒæ­¥é…ç½®ï¼ˆå¸§ç‡ã€é—´éš”ï¼‰
- é€»è¾‘ç¯å¢ƒåˆå§‹åŒ–ï¼ˆå¦‚æœéœ€è¦å…¨å±€å…±äº«ï¼‰

### 3.4 è¿ç§»ç­–ç•¥

**é˜¶æ®µ1: åˆ›å»ºæ–°ç±»**
- åˆ›å»º `ServerRoom` ç±»
- åˆ›å»º `GameSession` ç±»
- ä¿æŒç°æœ‰ä»£ç ä¸å˜

**é˜¶æ®µ2: é€æ­¥è¿ç§»**
- ä¿®æ”¹ `RoomManager` ç®¡ç† `ServerRoom` å®ä¾‹
- å°† `FrameSyncManager` çš„é€»è¾‘è¿ç§»åˆ° `GameSession`
- æ›´æ–° `GameServer` è°ƒç”¨æ–°æ¥å£

**é˜¶æ®µ3: æ¸…ç†æ—§ä»£ç **
- ç§»é™¤ `RoomFrameSyncState` ç±»
- ç®€åŒ– `FrameSyncManager`ï¼ˆå¦‚æœéœ€è¦ä¿ç•™ï¼‰
- æ¸…ç†ä¸å†ä½¿ç”¨çš„ä»£ç 

## 4. å…³é”®å†³ç­–ä¸å–èˆ

### é—®é¢˜ï¼šFrameSyncManager æ˜¯å¦è¿˜éœ€è¦ä¿ç•™ï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
1. **å®Œå…¨ç§»é™¤**: æ‰€æœ‰é€»è¾‘éƒ½åœ¨ Room ä¸­
2. **ä¿ç•™ä¸ºåè°ƒå™¨**: ç®¡ç†å…¨å±€é…ç½®å’Œåˆå§‹åŒ–
3. **ä¿ç•™ä¸ºå·¥å…·ç±»**: æä¾›å¸§åŒæ­¥ç›¸å…³çš„å·¥å…·æ–¹æ³•

**é€‰æ‹©**: æ–¹æ¡ˆ2 - ä¿ç•™ä¸ºåè°ƒå™¨

**ç†ç”±**:
- é€»è¾‘ç¯å¢ƒåˆå§‹åŒ–å¯èƒ½éœ€è¦å…¨å±€å…±äº«
- å¸§åŒæ­¥é…ç½®å¯èƒ½éœ€è¦ç»Ÿä¸€ç®¡ç†
- ä¾¿äºåç»­æ‰©å±•ï¼ˆå¦‚æˆ¿é—´é—´é€šä¿¡ï¼‰

**å½±å“**:
- FrameSyncManager èŒè´£å¤§å¹…ç®€åŒ–
- ä¸»è¦é€»è¾‘éƒ½åœ¨ Room å’Œ GameSession ä¸­

### é—®é¢˜ï¼šRoom å¦‚ä½•è®¿é—®ç½‘ç»œå’Œç”¨æˆ·ç®¡ç†ï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
1. **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥
2. **å•ä¾‹æ¨¡å¼**: Room ç›´æ¥è®¿é—®å•ä¾‹
3. **æœåŠ¡å®šä½å™¨**: é€šè¿‡æœåŠ¡å®šä½å™¨è·å–

**é€‰æ‹©**: æ–¹æ¡ˆ1 - ä¾èµ–æ³¨å…¥

**ç†ç”±**:
- ä¾¿äºæµ‹è¯•ï¼ˆå¯ä»¥æ³¨å…¥ Mock å¯¹è±¡ï¼‰
- ä¾èµ–å…³ç³»æ˜ç¡®
- ç¬¦åˆä¾èµ–å€’ç½®åŸåˆ™

**å½±å“**:
- RoomManager éœ€è¦ä¼ é€’ä¾èµ–
- æ„é€ å‡½æ•°å‚æ•°è¾ƒå¤š

### é—®é¢˜ï¼šLogicRoom å¦‚ä½•ç®¡ç†ï¼Ÿ

**å¤‡é€‰æ–¹æ¡ˆ**:
1. **Room ç›´æ¥ç®¡ç†**: Room åˆ›å»ºå’Œç®¡ç† LogicRoom
2. **å»¶è¿Ÿåˆ›å»º**: æ¸¸æˆå¼€å§‹æ—¶æ‰åˆ›å»º LogicRoom
3. **å¤–éƒ¨ç®¡ç†**: ç”± GameSession ç®¡ç†

**é€‰æ‹©**: æ–¹æ¡ˆ2 - å»¶è¿Ÿåˆ›å»º

**ç†ç”±**:
- LogicRoom åªåœ¨æ¸¸æˆå¼€å§‹æ—¶éœ€è¦
- å‡å°‘ä¸å¿…è¦çš„èµ„æºå ç”¨
- ç¬¦åˆæŒ‰éœ€åˆ›å»ºåŸåˆ™

**å½±å“**:
- StartGame æ—¶ GameSession ä¼šåˆ›å»º LogicRoom
- éœ€è¦å¤„ç†åˆ›å»ºå¤±è´¥çš„æƒ…å†µ

## 5. ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

### 5.1 ä¸ GameServer çš„å…³ç³»

- GameServer é€šè¿‡ RoomManager ç®¡ç†æˆ¿é—´
- GameServer å¤„ç†ç½‘ç»œæ¶ˆæ¯ï¼Œè°ƒç”¨ Room çš„æ–¹æ³•
- GameServer ç»Ÿä¸€è°ƒç”¨ RoomManager.UpdateAllRooms()

### 5.2 ä¸ UserManager çš„å…³ç³»

- Room é€šè¿‡ UserManager æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
- Room é€šè¿‡ UserManager è·å– SessionId å‘é€æ¶ˆæ¯
- UserManager ä¸ç›´æ¥ç®¡ç†æˆ¿é—´ï¼Œåªç®¡ç†ç”¨æˆ·

### 5.3 ä¸ NetworkManager çš„å…³ç³»

- Room é€šè¿‡ NetworkManager å‘é€æ¶ˆæ¯ç»™å®¢æˆ·ç«¯
- NetworkManager ä¸å…³å¿ƒæˆ¿é—´é€»è¾‘ï¼Œåªè´Ÿè´£æ¶ˆæ¯ä¼ è¾“
- Room é€šè¿‡ UserManager è·å– SessionIdï¼Œå†é€šè¿‡ NetworkManager å‘é€

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

- Room çš„ç©å®¶ç®¡ç†åŠŸèƒ½
- GameSession çš„è¾“å…¥å¤„ç†å’Œå¸§æ¨è¿›
- RoomManager çš„æˆ¿é—´ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 6.2 é›†æˆæµ‹è¯•

- æˆ¿é—´åˆ›å»ºåˆ°æ¸¸æˆå¼€å§‹çš„å®Œæ•´æµç¨‹
- å¸§åŒæ­¥æ•°æ®å‘é€å’Œæ¥æ”¶
- ç©å®¶åŠ å…¥å’Œç¦»å¼€æˆ¿é—´

### 6.3 æ€§èƒ½æµ‹è¯•

- å¤šæˆ¿é—´å¹¶å‘æ›´æ–°æ€§èƒ½
- å¸§åŒæ­¥å»¶è¿Ÿæµ‹è¯•
- å†…å­˜å ç”¨æµ‹è¯•

---

**ç›¸å…³æ–‡æ¡£**:
- [Frame-Sync-Mechanism å¸§åŒæ­¥æœºåˆ¶](../05-CoreArchitecture%20æ ¸å¿ƒæ¶æ„/å¸§åŒæ­¥/Frame-Sync-Mechanism%20å¸§åŒæ­¥æœºåˆ¶.md)
- [Network-Multiplayer è”æœºæ¨¡å¼](../09-GameModes%20æ¸¸æˆæ¨¡å¼/Network-Multiplayer%20è”æœºæ¨¡å¼.md)

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*  
*åˆ›å»ºæ—¶é—´ï¼š2025-01-27*  
*æœ€åæ›´æ–°ï¼š2025-01-27*  
*çŠ¶æ€ï¼šè®¾è®¡å®Œæˆï¼Œå¾…Review*  
*Owner*: AI Assistant  
*å˜æ›´æ‘˜è¦*: åˆ›å»ºæˆ¿é—´ç³»ç»Ÿé‡æ„æŠ€æœ¯è®¾è®¡æ–‡æ¡£ï¼Œæå‡ºé¢å‘å¯¹è±¡çš„é‡æ„æ–¹æ¡ˆ

