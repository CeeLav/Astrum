# 存档系统数值持久化方案

## 背景
- 目标：实现角色长期成长相关数值的稳定持久化，支持后续读取恢复。
- 范围：仅限影响长期成长/资源管理的字段，不包含战斗运行时状态。

## 现有数据结构梳理
- `LevelComponent`
  - `CurrentLevel`
  - `CurrentExp`
  - `ExpToNextLevel`
  - `MaxLevel`
- `GrowthComponent`
  - `AvailableStatPoints`
  - `AllocatedAttackPoints`
  - `AllocatedDefensePoints`
  - `AllocatedHealthPoints`
  - `AllocatedSpeedPoints`
- 货币/背包
  - 当前逻辑尚未实现，需要新增组件承载：
    - 建议 `CurrencyComponent`：`Dictionary<CurrencyType, long>`。
    - 建议 `InventoryComponent`：`List<ItemEntry>`，其中 `ItemEntry` 至少包含 `ItemId`、`Count`，预留扩展字段（耐久、随机属性等）。

## 存档结构建议
```
PlayerSaveData
  Level: int
  Exp: int
  ExpToNext: int
  MaxLevel: int
  StatPointsAvailable: int
  StatPointsAllocated:
    Attack: int
    Defense: int
    Health: int
    Speed: int
  Currencies: Dictionary<CurrencyType, long>
  Inventory: List<ItemEntry>
    ItemEntry:
      ItemId: int
      Count: int
      Meta: optional
```
> 以上结构可采用 MemoryPack 或 JSON 序列化，具体实现与现有存档框架保持一致。

## 读取流程
1. 解析存档 `PlayerSaveData`。
2. 创建角色实体并挂载必要组件（`LevelComponent`、`GrowthComponent` 等）。
3. 回填等级数据：
   - 设置 `CurrentLevel`、`CurrentExp`、`ExpToNextLevel`、`MaxLevel`。
4. 回填自由加点数据：
   - 设置 `AvailableStatPoints` 与各项分配点数。
   - 调用 `BaseStatsComponent.InitializeFromConfig` 与 `DerivedStatsComponent.RecalculateAll` 重新计算属性。
5. 初始化货币与背包（组件实现后）：
   - `CurrencyComponent`：写入存档中的货币字典。
   - `InventoryComponent`：遍历 `ItemEntry` 生成背包数据结构。

## 保存流程
1. 从 `LevelComponent` 读取等级/经验字段写入 `PlayerSaveData`。
2. 从 `GrowthComponent` 读取分配点、剩余点数。
3. 若存在货币/背包组件，从组件提取对应字典与物品列表。
4. 将 `PlayerSaveData` 交由存档框架序列化保存。

## 战斗状态排除项
以下字段明确不进入存档：
- `DynamicStatsComponent`（当前生命/法力/护盾/怒气等）。
- `BuffComponent`（Buff 列表及剩余帧）。
- `StateComponent`（控制、无敌等临时标记）。
- 任何技能冷却、动作帧进度等战斗运行时状态。

## 后续待办
1. 设计/落地 `CurrencyComponent` 与 `InventoryComponent`。
2. 与存档框架接口对接，完善读写流程。
3. 编写测试用例验证数据完整性。
